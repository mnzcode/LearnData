<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta property="og:url" content="https://newzone.top/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html"><meta property="og:site_name" content="æŒ¨è¸¢ç‰›é©¬"><meta property="og:title" content="Redis"><meta property="og:description" content="Redis NoSQL æ¦‚è¿° NoSQLï¼ˆNot-Only SQLï¼‰ï¼šæ³›æŒ‡éå…³ç³»å‹çš„æ•°æ®åº“ï¼Œä½œä¸ºå…³ç³»å‹æ•°æ®åº“çš„è¡¥å…… MySQL æ”¯æŒ ACID ç‰¹æ€§ï¼Œä¿è¯å¯é æ€§å’ŒæŒä¹…æ€§ï¼Œè¯»å–æ€§èƒ½ä¸é«˜ï¼Œå› æ­¤éœ€è¦ç¼“å­˜çš„æ¥å‡ç¼“æ•°æ®åº“çš„è®¿é—®å‹åŠ› ä½œç”¨ï¼šåº”å¯¹åŸºäºæµ·é‡ç”¨æˆ·å’Œæµ·é‡æ•°æ®å‰æä¸‹çš„æ•°æ®å¤„ç†é—®é¢˜ ç‰¹å¾ï¼š å¯æ‰©å®¹ï¼Œå¯ä¼¸ç¼©ï¼ŒSQL æ•°æ®å…³ç³»è¿‡äºå¤æ‚ï¼ŒNosql ä¸å­˜å…³ç³»ï¼Œåªå­˜æ•°æ® å¤§æ•°æ®é‡ä¸‹é«˜æ€§èƒ½ï¼Œæ•°æ®ä¸å­˜å–åœ¨ç£ç›˜ IOï¼Œå­˜å–åœ¨å†…å­˜ çµæ´»çš„æ•°æ®æ¨¡å‹ï¼Œè®¾è®¡äº†ä¸€äº›æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œèƒ½ä¿è¯æ•ˆç‡ä¸Šçš„æé«˜ é«˜å¯ç”¨ï¼Œé›†ç¾¤"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-08-16T07:46:55.000Z"><meta property="article:author" content="æŒ¨è¸¢ç‰›é©¬"><meta property="article:modified_time" content="2023-08-16T07:46:55.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Redis","image":[""],"dateModified":"2023-08-16T07:46:55.000Z","author":[{"@type":"Person","name":"æŒ¨è¸¢ç‰›é©¬","url":"https://newzone.top"}]}</script><link rel="alternate" type="application/rss+xml" href="https://newzone.top/rss.xml" title="æŒ¨è¸¢ç‰›é©¬ RSS Feed"><title>Redis | æŒ¨è¸¢ç‰›é©¬</title><meta name="description" content="Redis NoSQL æ¦‚è¿° NoSQLï¼ˆNot-Only SQLï¼‰ï¼šæ³›æŒ‡éå…³ç³»å‹çš„æ•°æ®åº“ï¼Œä½œä¸ºå…³ç³»å‹æ•°æ®åº“çš„è¡¥å…… MySQL æ”¯æŒ ACID ç‰¹æ€§ï¼Œä¿è¯å¯é æ€§å’ŒæŒä¹…æ€§ï¼Œè¯»å–æ€§èƒ½ä¸é«˜ï¼Œå› æ­¤éœ€è¦ç¼“å­˜çš„æ¥å‡ç¼“æ•°æ®åº“çš„è®¿é—®å‹åŠ› ä½œç”¨ï¼šåº”å¯¹åŸºäºæµ·é‡ç”¨æˆ·å’Œæµ·é‡æ•°æ®å‰æä¸‹çš„æ•°æ®å¤„ç†é—®é¢˜ ç‰¹å¾ï¼š å¯æ‰©å®¹ï¼Œå¯ä¼¸ç¼©ï¼ŒSQL æ•°æ®å…³ç³»è¿‡äºå¤æ‚ï¼ŒNosql ä¸å­˜å…³ç³»ï¼Œåªå­˜æ•°æ® å¤§æ•°æ®é‡ä¸‹é«˜æ€§èƒ½ï¼Œæ•°æ®ä¸å­˜å–åœ¨ç£ç›˜ IOï¼Œå­˜å–åœ¨å†…å­˜ çµæ´»çš„æ•°æ®æ¨¡å‹ï¼Œè®¾è®¡äº†ä¸€äº›æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œèƒ½ä¿è¯æ•ˆç‡ä¸Šçš„æé«˜ é«˜å¯ç”¨ï¼Œé›†ç¾¤">
    <meta name="keywords" content="è‡ªæˆ‘æå‡,æ•ˆç‡æå‡,å¼€æºå·¥å…·,å­¦ä¹ ç¬”è®°" />
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #252232;
      }

      html,
      body {
        background: var(--bg-color);
      }
      .wwads-cn * {
        color: var(--text-color) !important;
      }
      @media screen and (max-width: 1300px) {
        .wwads-cn {
          display: none;
        }
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-962fc479.css" as="style"><link rel="stylesheet" href="/assets/style-962fc479.css">
    <link rel="modulepreload" href="/assets/app-3aac6385.js"><link rel="modulepreload" href="/assets/Redis.html-37f941e2.js"><link rel="modulepreload" href="/assets/Redis.html-d4995828.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="prefetch" href="/assets/index.html-3ff342bf.js" as="script"><link rel="prefetch" href="/assets/blog.html-5b492070.js" as="script"><link rel="prefetch" href="/assets/intro.html-3e827329.js" as="script"><link rel="prefetch" href="/assets/JVM.html-38517126.js" as="script"><link rel="prefetch" href="/assets/JavaSE.html-253fd3a5.js" as="script"><link rel="prefetch" href="/assets/ç®—æ³•.html-2706b582.js" as="script"><link rel="prefetch" href="/assets/AJAX.html-cba67190.js" as="script"><link rel="prefetch" href="/assets/CSS.html-ab50b6dd.js" as="script"><link rel="prefetch" href="/assets/HTML.html-9118e91a.js" as="script"><link rel="prefetch" href="/assets/HTTP.html-a472e287.js" as="script"><link rel="prefetch" href="/assets/JS.html-655a3924.js" as="script"><link rel="prefetch" href="/assets/Nginx.html-112d02b1.js" as="script"><link rel="prefetch" href="/assets/Servlet.html-c5fd170b.js" as="script"><link rel="prefetch" href="/assets/VUE.html-17a52af9.js" as="script"><link rel="prefetch" href="/assets/MyBatis.html-cb25e492.js" as="script"><link rel="prefetch" href="/assets/Spring.html-f53fa6cf.js" as="script"><link rel="prefetch" href="/assets/SpringBoot.html-ab37d22b.js" as="script"><link rel="prefetch" href="/assets/SpringCloud.html-873fd3d2.js" as="script"><link rel="prefetch" href="/assets/SpringMVC.html-13a7790a.js" as="script"><link rel="prefetch" href="/assets/AutoHotkey.html-93f77451.js" as="script"><link rel="prefetch" href="/assets/Electron.html-031583fb.js" as="script"><link rel="prefetch" href="/assets/HTML.html-262d2f4d.js" as="script"><link rel="prefetch" href="/assets/Javascript.html-1b3b627b.js" as="script"><link rel="prefetch" href="/assets/Markdown.html-756ae24c.js" as="script"><link rel="prefetch" href="/assets/Python.html-7189afc3.js" as="script"><link rel="prefetch" href="/assets/index.html-1bea80e3.js" as="script"><link rel="prefetch" href="/assets/Regex.html-e40c3d88.js" as="script"><link rel="prefetch" href="/assets/Vue.html-ddbcc429.js" as="script"><link rel="prefetch" href="/assets/Cloudflare.html-cc44ecff.js" as="script"><link rel="prefetch" href="/assets/DNS.html-15883a35.js" as="script"><link rel="prefetch" href="/assets/GitHub.html-2d104d0f.js" as="script"><link rel="prefetch" href="/assets/Static.html-9ecb0930.js" as="script"><link rel="prefetch" href="/assets/VPS.html-00f13f78.js" as="script"><link rel="prefetch" href="/assets/Comments.html-ca88c317.js" as="script"><link rel="prefetch" href="/assets/VuePress.html-f23b8ae5.js" as="script"><link rel="prefetch" href="/assets/docsify.html-d1c77532.js" as="script"><link rel="prefetch" href="/assets/Maven.html-dfae2894.js" as="script"><link rel="prefetch" href="/assets/Netty.html-af5debfd.js" as="script"><link rel="prefetch" href="/assets/RocketMQ.html-3e238d84.js" as="script"><link rel="prefetch" href="/assets/Zookeeper.html-8b4f9abb.js" as="script"><link rel="prefetch" href="/assets/Docker.html-33b7e6ff.js" as="script"><link rel="prefetch" href="/assets/Git.html-61c1908c.js" as="script"><link rel="prefetch" href="/assets/Linux.html-cc52cc1e.js" as="script"><link rel="prefetch" href="/assets/JUC.html-0ad57c4e.js" as="script"><link rel="prefetch" href="/assets/NET.html-06a07968.js" as="script"><link rel="prefetch" href="/assets/Javaæ•°æ®åº“API.html-fc1956d1.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-032d438e.js" as="script"><link rel="prefetch" href="/assets/404.html-d452e021.js" as="script"><link rel="prefetch" href="/assets/index.html-4edb39e6.js" as="script"><link rel="prefetch" href="/assets/index.html-b9799b66.js" as="script"><link rel="prefetch" href="/assets/index.html-86025758.js" as="script"><link rel="prefetch" href="/assets/index.html-85cb61ed.js" as="script"><link rel="prefetch" href="/assets/index.html-6ea8950c.js" as="script"><link rel="prefetch" href="/assets/index.html-49598c38.js" as="script"><link rel="prefetch" href="/assets/index.html-28299f5a.js" as="script"><link rel="prefetch" href="/assets/index.html-4c521a15.js" as="script"><link rel="prefetch" href="/assets/index.html-22803f63.js" as="script"><link rel="prefetch" href="/assets/index.html-b9fff7fd.js" as="script"><link rel="prefetch" href="/assets/index.html-1e5e2781.js" as="script"><link rel="prefetch" href="/assets/index.html-202cc2d9.js" as="script"><link rel="prefetch" href="/assets/index.html-0904d946.js" as="script"><link rel="prefetch" href="/assets/index.html-a063af4b.js" as="script"><link rel="prefetch" href="/assets/index.html-b975f392.js" as="script"><link rel="prefetch" href="/assets/blog.html-bdf0a60b.js" as="script"><link rel="prefetch" href="/assets/intro.html-dbdff8b7.js" as="script"><link rel="prefetch" href="/assets/JVM.html-c170717b.js" as="script"><link rel="prefetch" href="/assets/JavaSE.html-1c00b98c.js" as="script"><link rel="prefetch" href="/assets/ç®—æ³•.html-f97b1b03.js" as="script"><link rel="prefetch" href="/assets/AJAX.html-b97ca552.js" as="script"><link rel="prefetch" href="/assets/CSS.html-c31987b3.js" as="script"><link rel="prefetch" href="/assets/HTML.html-b4b1d9ea.js" as="script"><link rel="prefetch" href="/assets/HTTP.html-2d8336c3.js" as="script"><link rel="prefetch" href="/assets/JS.html-d1aed2e6.js" as="script"><link rel="prefetch" href="/assets/Nginx.html-f688b163.js" as="script"><link rel="prefetch" href="/assets/Servlet.html-b7a4bf62.js" as="script"><link rel="prefetch" href="/assets/VUE.html-5b50a546.js" as="script"><link rel="prefetch" href="/assets/MyBatis.html-d33d8057.js" as="script"><link rel="prefetch" href="/assets/Spring.html-c6ade521.js" as="script"><link rel="prefetch" href="/assets/SpringBoot.html-10d86294.js" as="script"><link rel="prefetch" href="/assets/SpringCloud.html-650c49a8.js" as="script"><link rel="prefetch" href="/assets/SpringMVC.html-813d7cfd.js" as="script"><link rel="prefetch" href="/assets/AutoHotkey.html-355f669e.js" as="script"><link rel="prefetch" href="/assets/Electron.html-61c02c3c.js" as="script"><link rel="prefetch" href="/assets/HTML.html-2c19d067.js" as="script"><link rel="prefetch" href="/assets/Javascript.html-ff9ab74c.js" as="script"><link rel="prefetch" href="/assets/Markdown.html-94c7bbcb.js" as="script"><link rel="prefetch" href="/assets/Python.html-76d6bcc6.js" as="script"><link rel="prefetch" href="/assets/index.html-2202ac76.js" as="script"><link rel="prefetch" href="/assets/Regex.html-8106b7bb.js" as="script"><link rel="prefetch" href="/assets/Vue.html-c022ab82.js" as="script"><link rel="prefetch" href="/assets/Cloudflare.html-5e38f011.js" as="script"><link rel="prefetch" href="/assets/DNS.html-a9288eff.js" as="script"><link rel="prefetch" href="/assets/GitHub.html-bc398c34.js" as="script"><link rel="prefetch" href="/assets/Static.html-8cbb84e6.js" as="script"><link rel="prefetch" href="/assets/VPS.html-a06913f6.js" as="script"><link rel="prefetch" href="/assets/Comments.html-31738cb9.js" as="script"><link rel="prefetch" href="/assets/VuePress.html-ec8deccd.js" as="script"><link rel="prefetch" href="/assets/docsify.html-0160f724.js" as="script"><link rel="prefetch" href="/assets/Maven.html-fdbac5c9.js" as="script"><link rel="prefetch" href="/assets/Netty.html-328d95cd.js" as="script"><link rel="prefetch" href="/assets/RocketMQ.html-cec36ebe.js" as="script"><link rel="prefetch" href="/assets/Zookeeper.html-e9b55c4d.js" as="script"><link rel="prefetch" href="/assets/Docker.html-e54107fd.js" as="script"><link rel="prefetch" href="/assets/Git.html-8adb41f1.js" as="script"><link rel="prefetch" href="/assets/Linux.html-4b846e04.js" as="script"><link rel="prefetch" href="/assets/JUC.html-428f7eb8.js" as="script"><link rel="prefetch" href="/assets/NET.html-06499db9.js" as="script"><link rel="prefetch" href="/assets/Javaæ•°æ®åº“API.html-dd84fd1d.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-92d4238f.js" as="script"><link rel="prefetch" href="/assets/404.html-9c56c223.js" as="script"><link rel="prefetch" href="/assets/index.html-3d541f18.js" as="script"><link rel="prefetch" href="/assets/index.html-98600397.js" as="script"><link rel="prefetch" href="/assets/index.html-a6d2e783.js" as="script"><link rel="prefetch" href="/assets/index.html-4084d10a.js" as="script"><link rel="prefetch" href="/assets/index.html-df25c848.js" as="script"><link rel="prefetch" href="/assets/index.html-ea07f84a.js" as="script"><link rel="prefetch" href="/assets/index.html-91176658.js" as="script"><link rel="prefetch" href="/assets/index.html-efb1a73d.js" as="script"><link rel="prefetch" href="/assets/index.html-a2371e27.js" as="script"><link rel="prefetch" href="/assets/index.html-1cbbbd09.js" as="script"><link rel="prefetch" href="/assets/index.html-76b3d711.js" as="script"><link rel="prefetch" href="/assets/index.html-992507f9.js" as="script"><link rel="prefetch" href="/assets/index.html-c376f763.js" as="script"><link rel="prefetch" href="/assets/index.html-47a07d9c.js" as="script"><link rel="prefetch" href="/assets/plyr.min-d2156373.js" as="script"><link rel="prefetch" href="/assets/waline-meta-56fbc549.js" as="script"><link rel="prefetch" href="/assets/component-9b7941d1.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-5794cde2.js" as="script"><link rel="prefetch" href="/assets/pageview-d8f78d7a.js" as="script"><link rel="prefetch" href="/assets/SearchResult-172f634a.js" as="script">
    <!-- <script type="text/javascript" charset="UTF-8" src="https://cdn.wwads.cn/js/makemoney.js" async></script> -->
	  <!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7585955822109216"
     crossorigin="anonymous"></script> -->
    <!-- Matomo æ­¤åŒºå—ä¸ºç»Ÿè®¡ä»£ç ï¼Œè¯·åˆ é™¤-->
    <script>
      var _paq = window._paq = window._paq || [];
      /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="https://piwik.seoipo.com/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '7']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <!-- End Matomo Code æ­¤åŒºå—ä¸ºç»Ÿè®¡ä»£ç ï¼Œè¯·åˆ é™¤-->
  </head>
  <body>
    <!-- <div class="wwads-cn wwads-vertical wwads-sticky" data-id="255" data-sticky-position="left" style="max-width:180px; background-color:var(--bg-color);"></div> -->
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand" href="/"><img class="vp-nav-logo" src="/æ©˜çŒ«.jpeg" alt="æŒ¨è¸¢ç‰›é©¬"><!----><span class="vp-site-name hide-in-pad">æŒ¨è¸¢ç‰›é©¬</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="Contact"><span class="title"><span class="font-icon icon iconfont icon-advance" style=""></span>Contact</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="https://img.newzone.top/wechat.svg" rel="noopener noreferrer" target="_blank" aria-label="å¾®ä¿¡" class="nav-link"><span class="font-icon icon iconfont icon-wechat" style=""></span>å¾®ä¿¡<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li><li class="dropdown-item"><a href="mailto:learndata@newzone.top" aria-label="Email" class="nav-link"><span class="font-icon icon iconfont icon-alias" style=""></span>Email<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item hide-in-mobile"><button type="button" class="outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!--[--><button type="button" class="search-pro-button" role="search" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">æœç´¢</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">ğŸ§° Java</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><!----><span class="vp-sidebar-title">ğŸŒ æ•°æ®åº“</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Java%E6%95%B0%E6%8D%AE%E5%BA%93API.html"><!---->Javaæ•°æ®åº“API<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL.html"><!---->MySQL<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html"><!---->Redis<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#nosql"><!---->NoSQL<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#æ¦‚è¿°"><!---->æ¦‚è¿°<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#redis-1"><!---->Redis<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#å®‰è£…å¯åŠ¨"><!---->å®‰è£…å¯åŠ¨<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#åŸºæœ¬é…ç½®"><!---->åŸºæœ¬é…ç½®<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#æ•°æ®åº“"><!---->æ•°æ®åº“<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#æœåŠ¡å™¨-1"><!---->æœåŠ¡å™¨<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#é”®ç©ºé—´"><!---->é”®ç©ºé—´<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#è¿‡æœŸåˆ é™¤"><!---->è¿‡æœŸåˆ é™¤<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#æ•°æ®æ·˜æ±°"><!---->æ•°æ®æ·˜æ±°<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#æ’åºæœºåˆ¶"><!---->æ’åºæœºåˆ¶<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#é€šçŸ¥æœºåˆ¶"><!---->é€šçŸ¥æœºåˆ¶<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#ä½“ç³»æ¶æ„"><!---->ä½“ç³»æ¶æ„<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#äº‹ä»¶é©±åŠ¨"><!---->äº‹ä»¶é©±åŠ¨<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#å®¢æˆ·ç«¯-1"><!---->å®¢æˆ·ç«¯<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#æœåŠ¡å™¨-2"><!---->æœåŠ¡å™¨<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#æ…¢æ—¥å¿—"><!---->æ…¢æ—¥å¿—<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#æ•°æ®ç»“æ„-1"><!---->æ•°æ®ç»“æ„<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#å­—ç¬¦ä¸²"><!---->å­—ç¬¦ä¸²<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#é“¾è¡¨"><!---->é“¾è¡¨<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#å­—å…¸"><!---->å­—å…¸<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#è·³è·ƒè¡¨"><!---->è·³è·ƒè¡¨<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#æ•´æ•°é›†åˆ"><!---->æ•´æ•°é›†åˆ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#å‹ç¼©åˆ—è¡¨"><!---->å‹ç¼©åˆ—è¡¨<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#æ•°æ®ç±»å‹"><!---->æ•°æ®ç±»å‹<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#redisobj"><!---->redisObj<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#string"><!---->string<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#hash"><!---->hash<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#list"><!---->list<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#set"><!---->set<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#zset"><!---->zset<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#bitmaps"><!---->Bitmaps<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#hyper"><!---->Hyper<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#geo"><!---->GEO<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#æŒä¹…æœºåˆ¶"><!---->æŒä¹…æœºåˆ¶<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#æ¦‚è¿°-1"><!---->æ¦‚è¿°<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#rdb"><!---->RDB<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#aof"><!---->AOF<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#å¯¹æ¯”-1"><!---->å¯¹æ¯”<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#fork"><!---->fork<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#äº‹åŠ¡æœºåˆ¶"><!---->äº‹åŠ¡æœºåˆ¶<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#äº‹åŠ¡ç‰¹å¾"><!---->äº‹åŠ¡ç‰¹å¾<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#å·¥ä½œæµç¨‹"><!---->å·¥ä½œæµç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#watch"><!---->WATCH<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#acid"><!---->ACID<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#lua-è„šæœ¬"><!---->Lua è„šæœ¬<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#ç¯å¢ƒåˆ›å»º"><!---->ç¯å¢ƒåˆ›å»º<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#åä½œç»„ä»¶"><!---->åä½œç»„ä»¶<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#å‘½ä»¤å®ç°-1"><!---->å‘½ä»¤å®ç°<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#ç®¡ç†å‘½ä»¤"><!---->ç®¡ç†å‘½ä»¤<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#è„šæœ¬å¤åˆ¶"><!---->è„šæœ¬å¤åˆ¶<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#åˆ†å¸ƒå¼é”"><!---->åˆ†å¸ƒå¼é”<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#åŸºæœ¬æ“ä½œ-1"><!---->åŸºæœ¬æ“ä½œ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#é˜²è¯¯åˆ "><!---->é˜²è¯¯åˆ <!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#ä¼˜åŒ–é”"><!---->ä¼˜åŒ–é”<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#ä¸»ä»å¤åˆ¶"><!---->ä¸»ä»å¤åˆ¶<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#åŸºæœ¬æ“ä½œ-2"><!---->åŸºæœ¬æ“ä½œ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#å¤åˆ¶æµç¨‹"><!---->å¤åˆ¶æµç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#éƒ¨åˆ†åŒæ­¥"><!---->éƒ¨åˆ†åŒæ­¥<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#å¤åˆ¶å®ç°"><!---->å¤åˆ¶å®ç°<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#å¿ƒè·³æ£€æµ‹"><!---->å¿ƒè·³æ£€æµ‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#å¸¸è§é—®é¢˜"><!---->å¸¸è§é—®é¢˜<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#å“¨å…µæ¨¡å¼"><!---->å“¨å…µæ¨¡å¼<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#å“¨å…µæ¦‚è¿°"><!---->å“¨å…µæ¦‚è¿°<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#å¯ç”¨å“¨å…µ"><!---->å¯ç”¨å“¨å…µ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#ä¿¡æ¯äº¤äº’"><!---->ä¿¡æ¯äº¤äº’<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#ä¸‹çº¿æ£€æµ‹"><!---->ä¸‹çº¿æ£€æµ‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#é¢†å¤´é€‰ä¸¾"><!---->é¢†å¤´é€‰ä¸¾<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#æ•…éšœè½¬ç§»"><!---->æ•…éšœè½¬ç§»<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#é›†ç¾¤æ¨¡å¼"><!---->é›†ç¾¤æ¨¡å¼<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#é›†ç¾¤èŠ‚ç‚¹"><!---->é›†ç¾¤èŠ‚ç‚¹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#æ§½æŒ‡æ´¾"><!---->æ§½æŒ‡æ´¾<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#é›†ç¾¤å‘½ä»¤"><!---->é›†ç¾¤å‘½ä»¤<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#é‡æ–°åˆ†ç‰‡"><!---->é‡æ–°åˆ†ç‰‡<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#é«˜å¯ç”¨"><!---->é«˜å¯ç”¨<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#æ¶ˆæ¯æœºåˆ¶"><!---->æ¶ˆæ¯æœºåˆ¶<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#è„‘è£‚é—®é¢˜"><!---->è„‘è£‚é—®é¢˜<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#ç»“æ„æ­å»º"><!---->ç»“æ„æ­å»º<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#å…¶ä»–æ“ä½œ"><!---->å…¶ä»–æ“ä½œ<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#å‘å¸ƒè®¢é˜…"><!---->å‘å¸ƒè®¢é˜…<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#acl-æŒ‡ä»¤"><!---->ACL æŒ‡ä»¤<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#ç›‘è§†å™¨"><!---->ç›‘è§†å™¨<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#æ‰¹å¤„ç†"><!---->æ‰¹å¤„ç†<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#è§£å†³æ–¹æ¡ˆ"><!---->è§£å†³æ–¹æ¡ˆ<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#ç¼“å­˜æ–¹æ¡ˆ"><!---->ç¼“å­˜æ–¹æ¡ˆ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#key-è®¾è®¡"><!---->Key è®¾è®¡<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html#æ…¢æŸ¥è¯¢"><!---->æ…¢æŸ¥è¯¢<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">ğŸ—ï¸ ä¸­é—´ä»¶</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">ğŸ‹ Springå…¨å®¶æ¡¶</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">ğŸ‹ å¹¶å‘åŒ…</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">ğŸ‹ å·¥å…·</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">ğŸ‹ JavaWeb</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Redis</h1><div class="page-info"><!----><!----><span class="page-word-info" aria-label="å­—æ•°ğŸ” " data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>çº¦ 69525 å­—</span><meta property="wordCount" content="69525"></span><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 232 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT232M"></span><span class="page-pageview-info" aria-label="è®¿é—®é‡ğŸ”¢" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span id="ArtalkPV" class="waline-pageview-count" data-path="/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis.html">...</span></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#nosql">NoSQL</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#æ¦‚è¿°">æ¦‚è¿°</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#redis-1">Redis</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#å®‰è£…å¯åŠ¨">å®‰è£…å¯åŠ¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#åŸºæœ¬é…ç½®">åŸºæœ¬é…ç½®</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#æ•°æ®åº“">æ•°æ®åº“</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#æœåŠ¡å™¨-1">æœåŠ¡å™¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#é”®ç©ºé—´">é”®ç©ºé—´</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#è¿‡æœŸåˆ é™¤">è¿‡æœŸåˆ é™¤</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#æ•°æ®æ·˜æ±°">æ•°æ®æ·˜æ±°</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#æ’åºæœºåˆ¶">æ’åºæœºåˆ¶</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#é€šçŸ¥æœºåˆ¶">é€šçŸ¥æœºåˆ¶</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#ä½“ç³»æ¶æ„">ä½“ç³»æ¶æ„</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#äº‹ä»¶é©±åŠ¨">äº‹ä»¶é©±åŠ¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#å®¢æˆ·ç«¯-1">å®¢æˆ·ç«¯</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#æœåŠ¡å™¨-2">æœåŠ¡å™¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#æ…¢æ—¥å¿—">æ…¢æ—¥å¿—</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#æ•°æ®ç»“æ„-1">æ•°æ®ç»“æ„</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#å­—ç¬¦ä¸²">å­—ç¬¦ä¸²</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#é“¾è¡¨">é“¾è¡¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#å­—å…¸">å­—å…¸</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#è·³è·ƒè¡¨">è·³è·ƒè¡¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#æ•´æ•°é›†åˆ">æ•´æ•°é›†åˆ</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#å‹ç¼©åˆ—è¡¨">å‹ç¼©åˆ—è¡¨</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#æ•°æ®ç±»å‹">æ•°æ®ç±»å‹</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#redisobj">redisObj</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#string">string</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#hash">hash</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#list">list</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#set">set</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#zset">zset</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#bitmaps">Bitmaps</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#hyper">Hyper</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#geo">GEO</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#æŒä¹…æœºåˆ¶">æŒä¹…æœºåˆ¶</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#æ¦‚è¿°-1">æ¦‚è¿°</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#rdb">RDB</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#aof">AOF</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#å¯¹æ¯”-1">å¯¹æ¯”</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#fork">fork</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#äº‹åŠ¡æœºåˆ¶">äº‹åŠ¡æœºåˆ¶</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#äº‹åŠ¡ç‰¹å¾">äº‹åŠ¡ç‰¹å¾</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#å·¥ä½œæµç¨‹">å·¥ä½œæµç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#watch">WATCH</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#acid">ACID</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#lua-è„šæœ¬">Lua è„šæœ¬</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#ç¯å¢ƒåˆ›å»º">ç¯å¢ƒåˆ›å»º</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#åä½œç»„ä»¶">åä½œç»„ä»¶</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#å‘½ä»¤å®ç°-1">å‘½ä»¤å®ç°</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#ç®¡ç†å‘½ä»¤">ç®¡ç†å‘½ä»¤</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#è„šæœ¬å¤åˆ¶">è„šæœ¬å¤åˆ¶</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#åˆ†å¸ƒå¼é”">åˆ†å¸ƒå¼é”</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#åŸºæœ¬æ“ä½œ-1">åŸºæœ¬æ“ä½œ</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#é˜²è¯¯åˆ ">é˜²è¯¯åˆ </a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#ä¼˜åŒ–é”">ä¼˜åŒ–é”</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#ä¸»ä»å¤åˆ¶">ä¸»ä»å¤åˆ¶</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#åŸºæœ¬æ“ä½œ-2">åŸºæœ¬æ“ä½œ</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#å¤åˆ¶æµç¨‹">å¤åˆ¶æµç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#éƒ¨åˆ†åŒæ­¥">éƒ¨åˆ†åŒæ­¥</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#å¤åˆ¶å®ç°">å¤åˆ¶å®ç°</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#å¿ƒè·³æ£€æµ‹">å¿ƒè·³æ£€æµ‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#å¸¸è§é—®é¢˜">å¸¸è§é—®é¢˜</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#å“¨å…µæ¨¡å¼">å“¨å…µæ¨¡å¼</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#å“¨å…µæ¦‚è¿°">å“¨å…µæ¦‚è¿°</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#å¯ç”¨å“¨å…µ">å¯ç”¨å“¨å…µ</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#ä¿¡æ¯äº¤äº’">ä¿¡æ¯äº¤äº’</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#ä¸‹çº¿æ£€æµ‹">ä¸‹çº¿æ£€æµ‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#é¢†å¤´é€‰ä¸¾">é¢†å¤´é€‰ä¸¾</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#æ•…éšœè½¬ç§»">æ•…éšœè½¬ç§»</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#é›†ç¾¤æ¨¡å¼">é›†ç¾¤æ¨¡å¼</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#é›†ç¾¤èŠ‚ç‚¹">é›†ç¾¤èŠ‚ç‚¹</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#æ§½æŒ‡æ´¾">æ§½æŒ‡æ´¾</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#é›†ç¾¤å‘½ä»¤">é›†ç¾¤å‘½ä»¤</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#é‡æ–°åˆ†ç‰‡">é‡æ–°åˆ†ç‰‡</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#é«˜å¯ç”¨">é«˜å¯ç”¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#æ¶ˆæ¯æœºåˆ¶">æ¶ˆæ¯æœºåˆ¶</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#è„‘è£‚é—®é¢˜">è„‘è£‚é—®é¢˜</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#ç»“æ„æ­å»º">ç»“æ„æ­å»º</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#å…¶ä»–æ“ä½œ">å…¶ä»–æ“ä½œ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#å‘å¸ƒè®¢é˜…">å‘å¸ƒè®¢é˜…</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#acl-æŒ‡ä»¤">ACL æŒ‡ä»¤</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#ç›‘è§†å™¨">ç›‘è§†å™¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#æ‰¹å¤„ç†">æ‰¹å¤„ç†</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/#è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#ç¼“å­˜æ–¹æ¡ˆ">ç¼“å­˜æ–¹æ¡ˆ</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#key-è®¾è®¡">Key è®¾è®¡</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/#æ…¢æŸ¥è¯¢">æ…¢æŸ¥è¯¢</a></li><!----><!--]--></ul></li><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h1 id="redis" tabindex="-1"><a class="header-anchor" href="#redis" aria-hidden="true">#</a> Redis</h1><h2 id="nosql" tabindex="-1"><a class="header-anchor" href="#nosql" aria-hidden="true">#</a> NoSQL</h2><h3 id="æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#æ¦‚è¿°" aria-hidden="true">#</a> æ¦‚è¿°</h3><p>NoSQLï¼ˆNot-Only SQLï¼‰ï¼šæ³›æŒ‡éå…³ç³»å‹çš„æ•°æ®åº“ï¼Œä½œä¸ºå…³ç³»å‹æ•°æ®åº“çš„è¡¥å……</p><p>MySQL æ”¯æŒ ACID ç‰¹æ€§ï¼Œä¿è¯å¯é æ€§å’ŒæŒä¹…æ€§ï¼Œè¯»å–æ€§èƒ½ä¸é«˜ï¼Œå› æ­¤éœ€è¦ç¼“å­˜çš„æ¥å‡ç¼“æ•°æ®åº“çš„è®¿é—®å‹åŠ›</p><p>ä½œç”¨ï¼šåº”å¯¹åŸºäºæµ·é‡ç”¨æˆ·å’Œæµ·é‡æ•°æ®å‰æä¸‹çš„æ•°æ®å¤„ç†é—®é¢˜</p><p>ç‰¹å¾ï¼š</p><ul><li>å¯æ‰©å®¹ï¼Œå¯ä¼¸ç¼©ï¼ŒSQL æ•°æ®å…³ç³»è¿‡äºå¤æ‚ï¼ŒNosql ä¸å­˜å…³ç³»ï¼Œåªå­˜æ•°æ®</li><li>å¤§æ•°æ®é‡ä¸‹é«˜æ€§èƒ½ï¼Œæ•°æ®ä¸å­˜å–åœ¨ç£ç›˜ IOï¼Œå­˜å–åœ¨å†…å­˜</li><li>çµæ´»çš„æ•°æ®æ¨¡å‹ï¼Œè®¾è®¡äº†ä¸€äº›æ•°æ®å­˜å‚¨æ ¼å¼ï¼Œèƒ½ä¿è¯æ•ˆç‡ä¸Šçš„æé«˜</li><li>é«˜å¯ç”¨ï¼Œé›†ç¾¤</li></ul><p>å¸¸è§çš„ NoSQLï¼šRedisã€memcacheã€HBaseã€MongoDB</p><p>å‚è€ƒä¹¦ç±ï¼š<a href="https://book.douban.com/subject/25900156/" target="_blank" rel="noopener noreferrer">https://book.douban.com/subject/25900156/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>å‚è€ƒè§†é¢‘ï¼š<a href="https://www.bilibili.com/video/BV1CJ411m7Gc" target="_blank" rel="noopener noreferrer">https://www.bilibili.com/video/BV1CJ411m7Gc<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><hr><h3 id="redis-1" tabindex="-1"><a class="header-anchor" href="#redis-1" aria-hidden="true">#</a> Redis</h3><p>Redis (REmote DIctionary Server) ï¼šç”¨ C è¯­è¨€å¼€å‘çš„ä¸€ä¸ªå¼€æºçš„é«˜æ€§èƒ½é”®å€¼å¯¹ï¼ˆkey-valueï¼‰æ•°æ®åº“</p><p>ç‰¹å¾ï¼š</p><ul><li>æ•°æ®é—´æ²¡æœ‰å¿…ç„¶çš„å…³è”å…³ç³»ï¼Œ<strong>ä¸å­˜å…³ç³»ï¼Œåªå­˜æ•°æ®</strong></li><li>æ•°æ®<strong>å­˜å‚¨åœ¨å†…å­˜</strong>ï¼Œå­˜å–é€Ÿåº¦å¿«ï¼Œè§£å†³äº†ç£ç›˜ IO é€Ÿåº¦æ…¢çš„é—®é¢˜</li><li>å†…éƒ¨é‡‡ç”¨<strong>å•çº¿ç¨‹</strong>æœºåˆ¶è¿›è¡Œå·¥ä½œ</li><li>é«˜æ€§èƒ½ï¼Œå®˜æ–¹æµ‹è¯•æ•°æ®ï¼Œ50 ä¸ªå¹¶å‘æ‰§è¡Œ 100000 ä¸ªè¯·æ±‚ï¼Œè¯»çš„é€Ÿåº¦æ˜¯ 110000 æ¬¡/sï¼Œå†™çš„é€Ÿåº¦æ˜¯ 81000 æ¬¡/s</li><li>å¤šæ•°æ®ç±»å‹æ”¯æŒ <ul><li>å­—ç¬¦ä¸²ç±»å‹ï¼šstringï¼ˆStringï¼‰</li><li>åˆ—è¡¨ç±»å‹ï¼šlistï¼ˆLinkedListï¼‰</li><li>æ•£åˆ—ç±»å‹ï¼šhashï¼ˆHashMapï¼‰</li><li>é›†åˆç±»å‹ï¼šsetï¼ˆHashSetï¼‰</li><li>æœ‰åºé›†åˆç±»å‹ï¼šzset/sorted_setï¼ˆTreeSetï¼‰</li></ul></li><li>æ”¯æŒæŒä¹…åŒ–ï¼Œå¯ä»¥è¿›è¡Œæ•°æ®ç¾éš¾æ¢å¤</li></ul><hr><h3 id="å®‰è£…å¯åŠ¨" tabindex="-1"><a class="header-anchor" href="#å®‰è£…å¯åŠ¨" aria-hidden="true">#</a> å®‰è£…å¯åŠ¨</h3><p>å®‰è£…ï¼š</p><ul><li><p>Redis 5.0 è¢«åŒ…å«åœ¨é»˜è®¤çš„ Ubuntu 20.04 è½¯ä»¶æºä¸­</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">apt</span> update
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> redis-server
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æ£€æŸ¥ Redis çŠ¶æ€</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> systemctl status redis-server
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><p>å¯åŠ¨ï¼š</p><ul><li><p>å¯åŠ¨æœåŠ¡å™¨â€”â€”å‚æ•°å¯åŠ¨</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-server <span class="token punctuation">[</span>--port port<span class="token punctuation">]</span>
<span class="token comment">#redis-server --port 6379</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>å¯åŠ¨æœåŠ¡å™¨â€”â€”é…ç½®æ–‡ä»¶å¯åŠ¨</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-server config_file_name
<span class="token comment">#redis-server /etc/redis/conf/redis-6397.conf</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>å¯åŠ¨å®¢æˆ·ç«¯ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-cli <span class="token punctuation">[</span>-h host<span class="token punctuation">]</span> <span class="token punctuation">[</span>-p port<span class="token punctuation">]</span>
<span class="token comment">#redis-cli -h 192.168.2.185 -p 6397</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„ï¼šæœåŠ¡å™¨å¯åŠ¨æŒ‡å®šç«¯å£ä½¿ç”¨çš„æ˜¯--portï¼Œå®¢æˆ·ç«¯å¯åŠ¨æŒ‡å®šç«¯å£ä½¿ç”¨çš„æ˜¯-p</p></li></ul><hr><h3 id="åŸºæœ¬é…ç½®" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬é…ç½®" aria-hidden="true">#</a> åŸºæœ¬é…ç½®</h3><h4 id="ç³»ç»Ÿç›®å½•" tabindex="-1"><a class="header-anchor" href="#ç³»ç»Ÿç›®å½•" aria-hidden="true">#</a> ç³»ç»Ÿç›®å½•</h4><ol><li><p>åˆ›å»ºæ–‡ä»¶ç»“æ„</p><p>åˆ›å»ºé…ç½®æ–‡ä»¶å­˜å‚¨ç›®å½•</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mkdir</span> conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>åˆ›å»ºæœåŠ¡å™¨æ–‡ä»¶å­˜å‚¨ç›®å½•ï¼ˆåŒ…å«æ—¥å¿—ã€æ•°æ®ã€ä¸´æ—¶é…ç½®æ–‡ä»¶ç­‰ï¼‰</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">mkdir</span> data
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>åˆ›å»ºé…ç½®æ–‡ä»¶å‰¯æœ¬æ”¾å…¥ conf ç›®å½•ï¼ŒUbuntu ç³»ç»Ÿé…ç½®æ–‡ä»¶ redis.conf åœ¨ç›®å½• <code>/etc/redis</code> ä¸­</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">cat</span> redis.conf <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">&quot;#&quot;</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-v</span> <span class="token string">&quot;^$&quot;</span> -<span class="token operator">&gt;</span> /conf/redis-6379.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å»é™¤é…ç½®æ–‡ä»¶çš„æ³¨é‡Šå’Œç©ºæ ¼ï¼Œè¾“å‡ºåˆ°æ–°çš„æ–‡ä»¶ï¼Œå‘½ä»¤æ–¹å¼é‡‡ç”¨ redis-port.conf</p></li></ol><hr><h4 id="æœåŠ¡å™¨" tabindex="-1"><a class="header-anchor" href="#æœåŠ¡å™¨" aria-hidden="true">#</a> æœåŠ¡å™¨</h4><ul><li><p>è®¾ç½®æœåŠ¡å™¨ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼è¿è¡Œï¼Œå…³é—­åæœåŠ¡å™¨æ§åˆ¶å°ä¸­å°†æ‰“å°æœåŠ¡å™¨è¿è¡Œä¿¡æ¯ï¼ˆåŒæ—¥å¿—å†…å®¹ç›¸åŒï¼‰ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>daemonize <span class="token function">yes</span><span class="token operator">|</span>no
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>ç»‘å®šä¸»æœºåœ°å€ï¼Œç»‘å®šæœ¬åœ°IPåœ°å€ï¼Œå¦åˆ™SSHæ— æ³•è®¿é—®ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">bind</span> <span class="token function">ip</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>è®¾ç½®æœåŠ¡å™¨ç«¯å£ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>port port
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>è®¾ç½®æœåŠ¡å™¨æ–‡ä»¶ä¿å­˜åœ°å€ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">dir</span> path
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>è®¾ç½®æ•°æ®åº“çš„æ•°é‡ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>databases <span class="token number">16</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>å¤šæœåŠ¡å™¨å¿«æ·é…ç½®ï¼š</p><p>å¯¼å…¥å¹¶åŠ è½½æŒ‡å®šé…ç½®æ–‡ä»¶ä¿¡æ¯ï¼Œç”¨äºå¿«é€Ÿåˆ›å»º redis å…¬å…±é…ç½®è¾ƒå¤šçš„ redis å®ä¾‹é…ç½®æ–‡ä»¶ï¼Œä¾¿äºç»´æŠ¤</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>include /path/conf_name.conf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><hr><h4 id="å®¢æˆ·ç«¯" tabindex="-1"><a class="header-anchor" href="#å®¢æˆ·ç«¯" aria-hidden="true">#</a> å®¢æˆ·ç«¯</h4><ul><li><p>æœåŠ¡å™¨å…è®¸å®¢æˆ·ç«¯è¿æ¥æœ€å¤§æ•°é‡ï¼Œé»˜è®¤ 0ï¼Œè¡¨ç¤ºæ— é™åˆ¶ï¼Œå½“å®¢æˆ·ç«¯è¿æ¥åˆ°è¾¾ä¸Šé™åï¼ŒRedis ä¼šæ‹’ç»æ–°çš„è¿æ¥ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>maxclients count
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>å®¢æˆ·ç«¯é—²ç½®ç­‰å¾…æœ€å¤§æ—¶é•¿ï¼Œè¾¾åˆ°æœ€å¤§å€¼åå…³é—­å¯¹åº”è¿æ¥ï¼Œå¦‚éœ€å…³é—­è¯¥åŠŸèƒ½ï¼Œè®¾ç½®ä¸º 0ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">timeout</span> seconds
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><hr><h4 id="æ—¥å¿—é…ç½®" tabindex="-1"><a class="header-anchor" href="#æ—¥å¿—é…ç½®" aria-hidden="true">#</a> æ—¥å¿—é…ç½®</h4><p>è®¾ç½®æ—¥å¿—è®°å½•</p><ul><li><p>è®¾ç½®æœåŠ¡å™¨ä»¥æŒ‡å®šæ—¥å¿—è®°å½•çº§åˆ«</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>loglevel debug<span class="token operator">|</span>verbose<span class="token operator">|</span>notice<span class="token operator">|</span>warning
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>æ—¥å¿—è®°å½•æ–‡ä»¶å</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>logfile filename
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><p>æ³¨æ„ï¼šæ—¥å¿—çº§åˆ«å¼€å‘æœŸè®¾ç½®ä¸º verbose å³å¯ï¼Œç”Ÿäº§ç¯å¢ƒä¸­é…ç½®ä¸º noticeï¼Œç®€åŒ–æ—¥å¿—è¾“å‡ºé‡ï¼Œé™ä½å†™æ—¥å¿— IO çš„é¢‘åº¦</p><p><strong>é…ç½®æ–‡ä»¶ï¼š</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">bind</span> <span class="token number">192.168</span>.2.185
port <span class="token number">6379</span>
<span class="token comment">#timeout 0</span>
daemonize no
logfile /etc/redis/data/redis-6379.log
<span class="token function">dir</span> /etc/redis/data
dbfilename <span class="token string">&quot;dump-6379.rdb&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="åŸºæœ¬æŒ‡ä»¤" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æŒ‡ä»¤" aria-hidden="true">#</a> åŸºæœ¬æŒ‡ä»¤</h4><p>å¸®åŠ©ä¿¡æ¯ï¼š</p><ul><li><p>è·å–å‘½ä»¤å¸®åŠ©æ–‡æ¡£</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">help</span> <span class="token punctuation">[</span>command<span class="token punctuation">]</span>
<span class="token comment">#help set</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>è·å–ç»„ä¸­æ‰€æœ‰å‘½ä»¤ä¿¡æ¯åç§°</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">help</span> <span class="token punctuation">[</span>@group-name<span class="token punctuation">]</span>
<span class="token comment">#help @string</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>é€€å‡ºæœåŠ¡</p><ul><li><p>é€€å‡ºå®¢æˆ·ç«¯ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>quit
<span class="token builtin class-name">exit</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>é€€å‡ºå®¢æˆ·ç«¯æœåŠ¡å™¨å¿«æ·é”®ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>Ctrl+C
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><hr><h2 id="æ•°æ®åº“" tabindex="-1"><a class="header-anchor" href="#æ•°æ®åº“" aria-hidden="true">#</a> æ•°æ®åº“</h2><h3 id="æœåŠ¡å™¨-1" tabindex="-1"><a class="header-anchor" href="#æœåŠ¡å™¨-1" aria-hidden="true">#</a> æœåŠ¡å™¨</h3><p>Redis æœåŠ¡å™¨å°†æ‰€æœ‰æ•°æ®åº“ä¿å­˜åœ¨<strong>æœåŠ¡å™¨çŠ¶æ€ redisServer ç»“æ„</strong>çš„ db æ•°ç»„ä¸­ï¼Œæ•°ç»„çš„æ¯ä¸€é¡¹éƒ½æ˜¯ redisDb ç»“æ„ï¼Œä»£è¡¨ä¸€ä¸ªæ•°æ®åº“ï¼Œæ¯ä¸ªæ•°æ®åº“ä¹‹é—´ç›¸äº’ç‹¬ç«‹ï¼Œ**å…±ç”¨ **Redis å†…å­˜ï¼Œä¸åŒºåˆ†å¤§å°ã€‚åœ¨åˆå§‹åŒ–æœåŠ¡å™¨æ—¶ï¼Œæ ¹æ® dbnum å±æ€§å†³å®šåˆ›å»ºæ•°æ®åº“çš„æ•°é‡ï¼Œè¯¥å±æ€§ç”±æœåŠ¡å™¨é…ç½®çš„ database é€‰é¡¹å†³å®šï¼Œé»˜è®¤ 16</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä¿å­˜æœåŠ¡å™¨æ‰€æœ‰çš„æ•°æ®åº“</span>
    redisDB <span class="token operator">*</span>db<span class="token punctuation">;</span>
    
    <span class="token comment">// æœåŠ¡å™¨æ•°æ®åº“çš„æ•°é‡</span>
    <span class="token keyword">int</span> dbnum<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-æœåŠ¡å™¨æ•°æ®åº“.png" style="zoom:67%;"><p><strong>åœ¨æœåŠ¡å™¨å†…éƒ¨</strong>ï¼Œå®¢æˆ·ç«¯çŠ¶æ€ redisClient ç»“æ„çš„ db å±æ€§è®°å½•äº†ç›®æ ‡æ•°æ®åº“ï¼Œæ˜¯ä¸€ä¸ªæŒ‡å‘ redisDb ç»“æ„çš„æŒ‡é’ˆ</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisClient</span> <span class="token punctuation">{</span>
    <span class="token comment">// è®°å½•å®¢æˆ·ç«¯æ­£åœ¨ä½¿ç”¨çš„æ•°æ®åº“ï¼ŒæŒ‡å‘ redisServer.db æ•°ç»„ä¸­çš„æŸä¸€ä¸ª db</span>
    redisDB <span class="token operator">*</span>db<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯ä¸ª Redis å®¢æˆ·ç«¯éƒ½æœ‰ç›®æ ‡æ•°æ®åº“ï¼Œæ‰§è¡Œæ•°æ®åº“è¯»å†™å‘½ä»¤æ—¶ç›®æ ‡æ•°æ®åº“å°±ä¼šæˆä¸ºè¿™äº›å‘½ä»¤çš„æ“ä½œå¯¹è±¡ï¼Œé»˜è®¤æƒ…å†µä¸‹ Redis å®¢æˆ·ç«¯çš„ç›®æ ‡æ•°æ®åº“ä¸º 0 å·æ•°æ®åº“ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ‰§è¡Œ SELECT å‘½ä»¤åˆ‡æ¢ç›®æ ‡æ•°æ®åº“ï¼ŒåŸç†æ˜¯é€šè¿‡ä¿®æ”¹ redisClient.db æŒ‡é’ˆæŒ‡å‘æœåŠ¡å™¨ä¸­ä¸åŒæ•°æ®åº“</p><p>å‘½ä»¤æ“ä½œï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token keyword">select</span> index	<span class="token comment">#åˆ‡æ¢æ•°æ®åº“ï¼Œindexä»0-15å–å€¼</span>
move key db		<span class="token comment">#æ•°æ®ç§»åŠ¨åˆ°æŒ‡å®šæ•°æ®åº“ï¼Œdbæ˜¯æ•°æ®åº“ç¼–å·</span>
<span class="token function">ping</span>			<span class="token comment">#æµ‹è¯•æ•°æ®åº“æ˜¯å¦è¿æ¥æ­£å¸¸ï¼Œè¿”å›PONG</span>
<span class="token builtin class-name">echo</span> message	<span class="token comment">#æ§åˆ¶å°è¾“å‡ºä¿¡æ¯</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Redis æ²¡æœ‰å¯ä»¥è¿”å›å®¢æˆ·ç«¯ç›®æ ‡æ•°æ®åº“çš„å‘½ä»¤ï¼Œä½†æ˜¯ redis-cli å®¢æˆ·ç«¯æ—è¾¹ä¼šæç¤ºå½“å‰æ‰€ä½¿ç”¨çš„ç›®æ ‡æ•°æ®åº“</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis<span class="token operator">&gt;</span> SELECT <span class="token number">1</span> 
OK 
redis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="é”®ç©ºé—´" tabindex="-1"><a class="header-anchor" href="#é”®ç©ºé—´" aria-hidden="true">#</a> é”®ç©ºé—´</h3><h4 id="key-space" tabindex="-1"><a class="header-anchor" href="#key-space" aria-hidden="true">#</a> key space</h4><p>Redis æ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼ˆkey-value pairï¼‰æ•°æ®åº“æœåŠ¡å™¨ï¼Œæ¯ä¸ªæ•°æ®åº“éƒ½ç”±ä¸€ä¸ª redisDb ç»“æ„è¡¨ç¤ºï¼ŒredisDb.dict <strong>å­—å…¸ä¸­ä¿å­˜äº†æ•°æ®åº“çš„æ‰€æœ‰é”®å€¼å¯¹</strong>ï¼Œå°†è¿™ä¸ªå­—å…¸ç§°ä¸ºé”®ç©ºé—´ï¼ˆkey spaceï¼‰</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisDB</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ•°æ®åº“é”®ç©ºé—´ï¼Œä¿å­˜æ‰€æœ‰é”®å€¼å¯¹</span>
    dict <span class="token operator">*</span>dict
<span class="token punctuation">}</span> redisDB<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é”®ç©ºé—´å’Œç”¨æˆ·æ‰€è§çš„æ•°æ®åº“æ˜¯ç›´æ¥å¯¹åº”çš„ï¼š</p><ul><li>é”®ç©ºé—´çš„é”®å°±æ˜¯æ•°æ®åº“çš„é”®ï¼Œæ¯ä¸ªé”®éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡</li><li>é”®ç©ºé—´çš„å€¼å°±æ˜¯æ•°æ®åº“çš„å€¼ï¼Œæ¯ä¸ªå€¼å¯ä»¥æ˜¯ä»»æ„ä¸€ç§ Redis å¯¹è±¡</li></ul><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-æ•°æ®åº“é”®ç©ºé—´.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å½“ä½¿ç”¨ Redis å‘½ä»¤å¯¹æ•°æ®åº“è¿›è¡Œè¯»å†™æ—¶ï¼ŒæœåŠ¡å™¨ä¸ä»…ä¼šå¯¹é”®ç©ºé—´æ‰§è¡ŒæŒ‡å®šçš„è¯»å†™æ“ä½œï¼Œè¿˜ä¼š<strong>è¿›è¡Œä¸€äº›ç»´æŠ¤æ“ä½œ</strong>ï¼š</p><ul><li>åœ¨è¯»å–ä¸€ä¸ªé”®åï¼ˆè¯»æ“ä½œå’Œå†™æ“ä½œéƒ½è¦å¯¹é”®è¿›è¡Œè¯»å–ï¼‰ï¼ŒæœåŠ¡å™¨ä¼šæ ¹æ®é”®æ˜¯å¦å­˜åœ¨æ¥æ›´æ–°æœåŠ¡å™¨çš„é”®ç©ºé—´å‘½ä¸­ hit æ¬¡æ•°æˆ–é”®ç©ºé—´ä¸å‘½ä¸­ miss æ¬¡æ•°ï¼Œè¿™ä¸¤ä¸ªå€¼å¯ä»¥åœ¨ <code>INFO stats</code> å‘½ä»¤çš„ keyspace_hits å±æ€§å’Œ keyspace_misses å±æ€§ä¸­æŸ¥çœ‹</li><li>æ›´æ–°é”®çš„ LRUï¼ˆæœ€åä½¿ç”¨ï¼‰æ—¶é—´ï¼Œè¯¥å€¼å¯ä»¥ç”¨äºè®¡ç®—é”®çš„é—²ç½®æ—¶é—´ï¼Œä½¿ç”¨ <code>OBJECT idletime key</code> æŸ¥çœ‹é”® key çš„é—²ç½®æ—¶é—´</li><li>å¦‚æœåœ¨è¯»å–ä¸€ä¸ªé”®æ—¶å‘ç°è¯¥é”®å·²ç»è¿‡æœŸï¼ŒæœåŠ¡å™¨ä¼š<strong>å…ˆåˆ é™¤è¿‡æœŸé”®</strong>ï¼Œå†æ‰§è¡Œå…¶ä»–æ“ä½œ</li><li>å¦‚æœå®¢æˆ·ç«¯ä½¿ç”¨ WATCH å‘½ä»¤ç›‘è§†äº†æŸä¸ªé”®ï¼Œé‚£ä¹ˆæœåŠ¡å™¨åœ¨å¯¹è¢«ç›‘è§†çš„é”®è¿›è¡Œä¿®æ”¹ä¹‹åï¼Œä¼šå°†è¿™ä¸ªé”®æ ‡è®°ä¸ºè„ï¼ˆdirtyï¼‰ï¼Œä»è€Œè®©äº‹åŠ¡æ³¨æ„åˆ°è¿™ä¸ªé”®å·²ç»è¢«ä¿®æ”¹è¿‡</li><li>æœåŠ¡å™¨æ¯æ¬¡ä¿®æ”¹ä¸€ä¸ªé”®ä¹‹åï¼Œéƒ½ä¼šå¯¹ dirty é”®è®¡æ•°å™¨çš„å€¼å¢1ï¼Œè¯¥è®¡æ•°å™¨ä¼šè§¦å‘æœåŠ¡å™¨çš„æŒä¹…åŒ–ä»¥åŠå¤åˆ¶æ“ä½œ</li><li>å¦‚æœæœåŠ¡å™¨å¼€å¯äº†æ•°æ®åº“é€šçŸ¥åŠŸèƒ½ï¼Œé‚£ä¹ˆåœ¨å¯¹é”®è¿›è¡Œä¿®æ”¹ä¹‹åï¼ŒæœåŠ¡å™¨å°†æŒ‰é…ç½®å‘é€ç›¸åº”çš„æ•°æ®åº“é€šçŸ¥</li></ul><hr><h4 id="è¯»å†™æŒ‡ä»¤" tabindex="-1"><a class="header-anchor" href="#è¯»å†™æŒ‡ä»¤" aria-hidden="true">#</a> è¯»å†™æŒ‡ä»¤</h4><p>å¸¸è§é”®æ“ä½œæŒ‡ä»¤ï¼š</p><ul><li><p>å¢åŠ æŒ‡ä»¤</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">set</span> key value				<span class="token comment">#æ·»åŠ ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„é”®å€¼å¯¹</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>åˆ é™¤æŒ‡ä»¤</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>del key						<span class="token comment">#åˆ é™¤æŒ‡å®škey</span>
unlink key   				<span class="token comment">#éé˜»å¡åˆ é™¤keyï¼ŒçœŸæ­£çš„åˆ é™¤ä¼šåœ¨åç»­å¼‚æ­¥æ“ä½œ</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æ›´æ–°æŒ‡ä»¤</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">rename</span> key newkey			<span class="token comment">#æ”¹å</span>
renamenx key newkey			<span class="token comment">#æ”¹å</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å€¼å¾—æ›´æ–°éœ€è¦å‚çœ‹å…·ä½“å¾— Redis å¯¹è±¡å¾—æ“ä½œæ–¹å¼ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²å¯¹è±¡æ‰§è¡Œ <code>SET key value</code> å°±å¯ä»¥å®Œæˆä¿®æ”¹</p></li><li><p>æŸ¥è¯¢æŒ‡ä»¤</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>exists key					<span class="token comment">#è·å–keyæ˜¯å¦å­˜åœ¨</span>
randomkey					<span class="token comment">#éšæœºè¿”å›ä¸€ä¸ªé”®</span>
keys pattern				<span class="token comment">#æŸ¥è¯¢key</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>KEYS å‘½ä»¤éœ€è¦<strong>éå†å­˜å‚¨çš„é”®å€¼å¯¹</strong>ï¼Œæ“ä½œå»¶æ—¶é«˜ï¼Œä¸€èˆ¬ä¸è¢«å»ºè®®ç”¨äºç”Ÿäº§ç¯å¢ƒä¸­</p><p>æŸ¥è¯¢æ¨¡å¼è§„åˆ™ï¼š* åŒ¹é…ä»»æ„æ•°é‡çš„ä»»æ„ç¬¦å·ã€? é…åˆä¸€ä¸ªä»»æ„ç¬¦å·ã€[] åŒ¹é…ä¸€ä¸ªæŒ‡å®šç¬¦å·</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>keys *						<span class="token comment">#æŸ¥è¯¢æ‰€æœ‰key</span>
keys aa*					<span class="token comment">#æŸ¥è¯¢æ‰€æœ‰ä»¥aaå¼€å¤´</span>
keys *bb					<span class="token comment">#æŸ¥è¯¢æ‰€æœ‰ä»¥bbç»“å°¾</span>
keys ??cc					<span class="token comment">#æŸ¥è¯¢æ‰€æœ‰å‰é¢ä¸¤ä¸ªå­—ç¬¦ä»»æ„ï¼Œåé¢ä»¥ccç»“å°¾ </span>
keys user:?					<span class="token comment">#æŸ¥è¯¢æ‰€æœ‰ä»¥user:å¼€å¤´ï¼Œæœ€åä¸€ä¸ªå­—ç¬¦ä»»æ„</span>
keys u<span class="token punctuation">[</span>st<span class="token punctuation">]</span>er:1				<span class="token comment">#æŸ¥è¯¢æ‰€æœ‰ä»¥uå¼€å¤´ï¼Œä»¥er:1ç»“å°¾ï¼Œä¸­é—´åŒ…å«ä¸€ä¸ªå­—æ¯ï¼Œsæˆ–t</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>å…¶ä»–æŒ‡ä»¤</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">type</span> key					<span class="token comment">#è·å–keyçš„ç±»å‹</span>
dbsize						<span class="token comment">#è·å–å½“å‰æ•°æ®åº“çš„æ•°æ®æ€»é‡ï¼Œå³keyçš„ä¸ªæ•°</span>
flushdb						<span class="token comment">#æ¸…é™¤å½“å‰æ•°æ®åº“çš„æ‰€æœ‰æ•°æ®(æ…ç”¨)</span>
flushall					<span class="token comment">#æ¸…é™¤æ‰€æœ‰æ•°æ®(æ…ç”¨)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨æ‰§è¡Œ FLUSHDB è¿™æ ·çš„å±é™©å‘½ä»¤ä¹‹å‰ï¼Œæœ€å¥½å…ˆæ‰§è¡Œä¸€ä¸ª SELECT å‘½ä»¤ï¼Œä¿è¯å½“å‰æ‰€æ“ä½œçš„æ•°æ®åº“æ˜¯ç›®æ ‡æ•°æ®åº“</p></li></ul><hr><h4 id="æ—¶æ•ˆè®¾ç½®" tabindex="-1"><a class="header-anchor" href="#æ—¶æ•ˆè®¾ç½®" aria-hidden="true">#</a> æ—¶æ•ˆè®¾ç½®</h4><p>å®¢æˆ·ç«¯å¯ä»¥ä»¥ç§’æˆ–æ¯«ç§’çš„ç²¾åº¦ä¸ºæ•°æ®åº“ä¸­çš„æŸä¸ªé”®è®¾ç½®ç”Ÿå­˜æ—¶é—´ï¼ˆTimeTo Live, TTLï¼‰ï¼Œåœ¨ç»è¿‡æŒ‡å®šæ—¶é—´ä¹‹åï¼ŒæœåŠ¡å™¨å°±ä¼šè‡ªåŠ¨åˆ é™¤ç”Ÿå­˜æ—¶é—´ä¸º 0 çš„é”®ï¼›ä¹Ÿå¯ä»¥ä»¥ UNIX æ—¶é—´æˆ³çš„æ–¹å¼è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆexpire timeï¼‰ï¼Œå½“é”®çš„è¿‡æœŸæ—¶é—´åˆ°è¾¾ï¼ŒæœåŠ¡å™¨ä¼šè‡ªåŠ¨åˆ é™¤è¿™ä¸ªé”®</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>expire key seconds			<span class="token comment">#ä¸ºæŒ‡å®škeyè®¾ç½®ç”Ÿå­˜æ—¶é—´ï¼Œå•ä½ä¸ºç§’</span>
pexpire key milliseconds	<span class="token comment">#ä¸ºæŒ‡å®škeyè®¾ç½®ç”Ÿå­˜æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’</span>
expireat key timestamp		<span class="token comment">#ä¸ºæŒ‡å®škeyè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºæ—¶é—´æˆ³</span>
pexpireat key mil-timestamp	<span class="token comment">#ä¸ºæŒ‡å®škeyè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’æ—¶é—´æˆ³</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å®é™…ä¸Š EXPIREã€EXPIREã€EXPIREAT ä¸‰ä¸ªå‘½ä»¤<strong>åº•å±‚éƒ½æ˜¯è½¬æ¢ä¸º PEXPIREAT å‘½ä»¤</strong>æ¥å®ç°çš„</li><li>SETEX å‘½ä»¤å¯ä»¥åœ¨è®¾ç½®ä¸€ä¸ªå­—ç¬¦ä¸²é”®çš„åŒæ—¶ä¸ºé”®è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä½†æ˜¯è¯¥å‘½ä»¤æ˜¯ä¸€ä¸ªç±»å‹é™å®šå‘½ä»¤</li></ul><p>redisDb ç»“æ„çš„ expires å­—å…¸ä¿å­˜äº†æ•°æ®åº“ä¸­æ‰€æœ‰é”®çš„è¿‡æœŸæ—¶é—´ï¼Œå­—å…¸ç§°ä¸ºè¿‡æœŸå­—å…¸ï¼š</p><ul><li>é”®æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘é”®ç©ºé—´ä¸­çš„æŸä¸ªé”®å¯¹è±¡ï¼ˆå¤ç”¨é”®ç©ºé—´çš„å¯¹è±¡ï¼Œä¸ä¼šäº§ç”Ÿå†…å­˜æµªè´¹ï¼‰</li><li>å€¼æ˜¯ä¸€ä¸ª long long ç±»å‹çš„æ•´æ•°ï¼Œä¿å­˜äº†é”®çš„è¿‡æœŸæ—¶é—´ï¼Œæ˜¯ä¸€ä¸ªæ¯«ç§’ç²¾åº¦çš„ UNIX æ—¶é—´æˆ³</li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisDB</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿‡æœŸå­—å…¸ï¼Œä¿å­˜æ‰€æœ‰é”®çš„è¿‡æœŸæ—¶é—´</span>
    dict <span class="token operator">*</span>expires
<span class="token punctuation">}</span> redisDB<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®¢æˆ·ç«¯æ‰§è¡Œ PEXPIREAT å‘½ä»¤ï¼ŒæœåŠ¡å™¨ä¼šåœ¨æ•°æ®åº“çš„è¿‡æœŸå­—å…¸ä¸­å…³è”ç»™å®šçš„æ•°æ®åº“é”®å’Œè¿‡æœŸæ—¶é—´ï¼š</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">PEXPIREAT</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> expire_time_in_ms<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># å¦‚æœç»™å®šçš„é”®ä¸å­˜åœ¨äºé”®ç©ºé—´ï¼Œé‚£ä¹ˆä¸èƒ½è®¾ç½®è¿‡æœŸæ—¶é—´</span>
	<span class="token keyword">if</span> key <span class="token keyword">not</span> <span class="token keyword">in</span> redisDb<span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token number">0</span>
		
	<span class="token comment"># åœ¨è¿‡æœŸå­—å…¸ä¸­å…³è”é”®å’Œè¿‡æœŸæ—¶é—´</span>
	redisDB<span class="token punctuation">.</span>expires<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> expire_time_in_ms
	
	<span class="token comment"># è¿‡æœŸæ—¶é—´è®¾ç½®æˆåŠŸ</span>
	<span class="token keyword">return</span> <span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="æ—¶æ•ˆçŠ¶æ€" tabindex="-1"><a class="header-anchor" href="#æ—¶æ•ˆçŠ¶æ€" aria-hidden="true">#</a> æ—¶æ•ˆçŠ¶æ€</h4><p>TTL å’Œ PTTL å‘½ä»¤é€šè¿‡è®¡ç®—é”®çš„è¿‡æœŸæ—¶é—´å’Œå½“å‰æ—¶é—´ä¹‹é—´çš„å·®ï¼Œè¿”å›è¿™ä¸ªé”®çš„å‰©ä½™ç”Ÿå­˜æ—¶é—´</p><ul><li>è¿”å›æ­£æ•°ä»£è¡¨è¯¥æ•°æ®åœ¨å†…å­˜ä¸­è¿˜èƒ½å­˜æ´»çš„æ—¶é—´</li><li>è¿”å› -1 ä»£è¡¨æ°¸ä¹…æ€§ï¼Œè¿”å› -2 ä»£è¡¨é”®ä¸å­˜åœ¨</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>ttl key			<span class="token comment">#è·å–keyçš„å‰©ä½™æ—¶é—´ï¼Œæ¯æ¬¡è·å–ä¼šè‡ªåŠ¨å˜åŒ–(å‡å°)ï¼Œç±»ä¼¼äºå€’è®¡æ—¶</span>
pttl key		<span class="token comment">#è·å–keyçš„å‰©ä½™æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œæ¯æ¬¡è·å–ä¼šè‡ªåŠ¨å˜åŒ–(å‡å°)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>PERSIST æ˜¯ PEXPIREAT å‘½ä»¤çš„åæ“ä½œï¼Œåœ¨è¿‡æœŸå­—å…¸ä¸­æŸ¥æ‰¾ç»™å®šçš„é”®ï¼Œå¹¶è§£é™¤é”®å’Œå€¼ï¼ˆè¿‡æœŸæ—¶é—´ï¼‰åœ¨è¿‡æœŸå­—å…¸ä¸­çš„å…³è”</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>persist key		<span class="token comment">#åˆ‡æ¢keyä»æ—¶æ•ˆæ€§è½¬æ¢ä¸ºæ°¸ä¹…æ€§</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Redis é€šè¿‡è¿‡æœŸå­—å…¸å¯ä»¥æ£€æŸ¥ä¸€ä¸ªç»™å®šé”®æ˜¯å¦è¿‡æœŸï¼š</p><ul><li>æ£€æŸ¥ç»™å®šé”®æ˜¯å¦å­˜åœ¨äºè¿‡æœŸå­—å…¸ï¼šå¦‚æœå­˜åœ¨ï¼Œé‚£ä¹ˆå–å¾—é”®çš„è¿‡æœŸæ—¶é—´</li><li>æ£€æŸ¥å½“å‰ UNIX æ—¶é—´æˆ³æ˜¯å¦å¤§äºé”®çš„è¿‡æœŸæ—¶é—´ï¼šå¦‚æœæ˜¯é‚£ä¹ˆé”®å·²ç»è¿‡æœŸï¼Œå¦åˆ™é”®æœªè¿‡æœŸ</li></ul><p>è¡¥å……ï¼šAOFã€RDB å’Œå¤åˆ¶åŠŸèƒ½å¯¹è¿‡æœŸé”®çš„å¤„ç†</p><ul><li>RDB ï¼š <ul><li>ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œç¨‹åºä¼šå¯¹æ•°æ®åº“ä¸­çš„é”®è¿›è¡Œæ£€æŸ¥ï¼Œå·²è¿‡æœŸçš„é”®ä¸ä¼šè¢«ä¿å­˜åˆ°æ–°åˆ›å»ºçš„ RDB æ–‡ä»¶ä¸­</li><li>è½½å…¥ RDB æ–‡ä»¶ï¼Œå¦‚æœæœåŠ¡å™¨ä»¥ä¸»æœåŠ¡å™¨æ¨¡å¼è¿è¡Œï¼Œé‚£ä¹ˆåœ¨è½½å…¥æ—¶ä¼šå¯¹é”®è¿›è¡Œæ£€æŸ¥ï¼Œè¿‡æœŸé”®ä¼šè¢«å¿½ç•¥ï¼›å¦‚æœæœåŠ¡å™¨ä»¥ä»æœåŠ¡å™¨æ¨¡å¼è¿è¡Œï¼Œä¼šè½½å…¥æ‰€æœ‰é”®ï¼ŒåŒ…æ‹¬è¿‡æœŸé”®ï¼Œä½†æ˜¯ä¸»ä»æœåŠ¡å™¨è¿›è¡Œæ•°æ®åŒæ­¥æ—¶å°±ä¼šåˆ é™¤è¿™äº›é”®</li></ul></li><li>AOFï¼š <ul><li>å†™å…¥ AOF æ–‡ä»¶ï¼Œå¦‚æœæ•°æ®åº“ä¸­çš„æŸä¸ªé”®å·²ç»è¿‡æœŸï¼Œä½†è¿˜æ²¡æœ‰è¢«åˆ é™¤ï¼Œé‚£ä¹ˆ AOF æ–‡ä»¶ä¸ä¼šå› ä¸ºè¿™ä¸ªè¿‡æœŸé”®è€Œäº§ç”Ÿä»»ä½•å½±å“ï¼›å½“è¯¥è¿‡æœŸé”®è¢«åˆ é™¤ï¼Œç¨‹åºä¼šå‘ AOF æ–‡ä»¶è¿½åŠ ä¸€æ¡ DEL å‘½ä»¤ï¼Œæ˜¾å¼çš„åˆ é™¤è¯¥é”®</li><li>AOF é‡å†™ï¼Œä¼šå¯¹æ•°æ®åº“ä¸­çš„é”®è¿›è¡Œæ£€æŸ¥ï¼Œå¿½ç•¥å·²ç»è¿‡æœŸçš„é”®</li></ul></li><li>å¤åˆ¶ï¼šå½“æœåŠ¡å™¨è¿è¡Œåœ¨å¤åˆ¶æ¨¡å¼ä¸‹æ—¶ï¼Œä»æœåŠ¡å™¨çš„è¿‡æœŸé”®åˆ é™¤åŠ¨ä½œç”±ä¸»æœåŠ¡å™¨æ§åˆ¶ <ul><li>ä¸»æœåŠ¡å™¨åœ¨åˆ é™¤ä¸€ä¸ªè¿‡æœŸé”®ä¹‹åï¼Œä¼šæ˜¾å¼åœ°å‘æ‰€æœ‰ä»æœåŠ¡å™¨å‘é€ä¸€ä¸ª DEL å‘½ä»¤ï¼Œå‘ŠçŸ¥ä»æœåŠ¡å™¨åˆ é™¤è¿™ä¸ªè¿‡æœŸé”®</li><li>ä»æœåŠ¡å™¨åœ¨æ‰§è¡Œå®¢æˆ·ç«¯å‘é€çš„è¯»å‘½ä»¤æ—¶ï¼Œå³ä½¿ç¢°åˆ°è¿‡æœŸé”®ä¹Ÿä¸ä¼šå°†è¿‡æœŸé”®åˆ é™¤ï¼Œä¼šå½“ä½œæœªè¿‡æœŸé”®å¤„ç†ï¼Œåªæœ‰åœ¨æ¥åˆ°ä¸»æœåŠ¡å™¨å‘æ¥çš„ DEL å‘½ä»¤ä¹‹åï¼Œæ‰ä¼šåˆ é™¤è¿‡æœŸé”®ï¼ˆæ•°æ®ä¸ä¸€è‡´ï¼‰</li></ul></li></ul><hr><h3 id="è¿‡æœŸåˆ é™¤" tabindex="-1"><a class="header-anchor" href="#è¿‡æœŸåˆ é™¤" aria-hidden="true">#</a> è¿‡æœŸåˆ é™¤</h3><h4 id="åˆ é™¤ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#åˆ é™¤ç­–ç•¥" aria-hidden="true">#</a> åˆ é™¤ç­–ç•¥</h4><p>åˆ é™¤ç­–ç•¥å°±æ˜¯<strong>é’ˆå¯¹å·²è¿‡æœŸæ•°æ®çš„å¤„ç†ç­–ç•¥</strong>ï¼Œå·²è¿‡æœŸçš„æ•°æ®ä¸ä¸€å®šè¢«ç«‹å³åˆ é™¤ï¼Œåœ¨ä¸åŒçš„åœºæ™¯ä¸‹ä½¿ç”¨ä¸åŒçš„åˆ é™¤æ–¹å¼ä¼šæœ‰ä¸åŒæ•ˆæœï¼Œåœ¨å†…å­˜å ç”¨ä¸ CPU å ç”¨ä¹‹é—´å¯»æ‰¾ä¸€ç§å¹³è¡¡ï¼Œé¡¾æ­¤å¤±å½¼éƒ½ä¼šé€ æˆæ•´ä½“ Redis æ€§èƒ½çš„ä¸‹é™ï¼Œç”šè‡³å¼•å‘æœåŠ¡å™¨å®•æœºæˆ–å†…å­˜æ³„éœ²</p><p>é’ˆå¯¹è¿‡æœŸæ•°æ®æœ‰ä¸‰ç§åˆ é™¤ç­–ç•¥ï¼š</p><ul><li>å®šæ—¶åˆ é™¤</li><li>æƒ°æ€§åˆ é™¤ï¼ˆè¢«åŠ¨åˆ é™¤ï¼‰</li><li>å®šæœŸåˆ é™¤</li></ul><p>Redis é‡‡ç”¨æƒ°æ€§åˆ é™¤å’Œå®šæœŸåˆ é™¤ç­–ç•¥çš„ç»“åˆä½¿ç”¨</p><hr><h4 id="å®šæ—¶åˆ é™¤" tabindex="-1"><a class="header-anchor" href="#å®šæ—¶åˆ é™¤" aria-hidden="true">#</a> å®šæ—¶åˆ é™¤</h4><p>åœ¨è®¾ç½®é”®çš„è¿‡æœŸæ—¶é—´çš„åŒæ—¶ï¼Œåˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼ˆtimerï¼‰ï¼Œè®©å®šæ—¶å™¨åœ¨é”®çš„è¿‡æœŸæ—¶é—´åˆ°è¾¾æ—¶ï¼Œç«‹å³æ‰§è¡Œå¯¹é”®çš„åˆ é™¤æ“ä½œ</p><ul><li>ä¼˜ç‚¹ï¼šèŠ‚çº¦å†…å­˜ï¼Œåˆ°æ—¶å°±åˆ é™¤ï¼Œå¿«é€Ÿé‡Šæ”¾æ‰ä¸å¿…è¦çš„å†…å­˜å ç”¨</li><li>ç¼ºç‚¹ï¼šå¯¹ CPU ä¸å‹å¥½ï¼Œæ— è®º CPU æ­¤æ—¶è´Ÿè½½å¤šé«˜å‡å ç”¨ CPUï¼Œä¼šå½±å“ Redis æœåŠ¡å™¨å“åº”æ—¶é—´å’ŒæŒ‡ä»¤ååé‡</li><li>æ€»ç»“ï¼šç”¨å¤„ç†å™¨æ€§èƒ½æ¢å–å­˜å‚¨ç©ºé—´ï¼ˆæ‹¿æ—¶é—´æ¢ç©ºé—´ï¼‰</li></ul><p>åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨éœ€è¦ç”¨åˆ° Redis æœåŠ¡å™¨ä¸­çš„æ—¶é—´äº‹ä»¶ï¼Œè€Œæ—¶é—´äº‹ä»¶çš„å®ç°æ–¹å¼æ˜¯æ— åºé“¾è¡¨ï¼ŒæŸ¥æ‰¾ä¸€ä¸ªäº‹ä»¶çš„æ—¶é—´å¤æ‚åº¦ä¸º O(N)ï¼Œå¹¶ä¸èƒ½é«˜æ•ˆåœ°å¤„ç†å¤§é‡æ—¶é—´äº‹ä»¶ï¼Œæ‰€ä»¥é‡‡ç”¨è¿™ç§æ–¹å¼å¹¶ä¸ç°å®</p><hr><h4 id="æƒ°æ€§åˆ é™¤" tabindex="-1"><a class="header-anchor" href="#æƒ°æ€§åˆ é™¤" aria-hidden="true">#</a> æƒ°æ€§åˆ é™¤</h4><p>æ•°æ®åˆ°è¾¾è¿‡æœŸæ—¶é—´ä¸åšå¤„ç†ï¼Œç­‰ä¸‹æ¬¡è®¿é—®åˆ°è¯¥æ•°æ®æ—¶æ‰§è¡Œ <strong>expireIfNeeded()</strong> åˆ¤æ–­ï¼š</p><ul><li>å¦‚æœè¾“å…¥é”®å·²ç»è¿‡æœŸï¼Œé‚£ä¹ˆ expireIfNeeded å‡½æ•°å°†è¾“å…¥é”®ä»æ•°æ®åº“ä¸­åˆ é™¤ï¼Œæ¥ç€è®¿é—®å°±ä¼šè¿”å›ç©º</li><li>å¦‚æœè¾“å…¥é”®æœªè¿‡æœŸï¼Œé‚£ä¹ˆ expireIfNeeded å‡½æ•°ä¸åšåŠ¨ä½œ</li></ul><p>æ‰€æœ‰çš„ Redis è¯»å†™å‘½ä»¤åœ¨æ‰§è¡Œå‰éƒ½ä¼šè°ƒç”¨ expireIfNeeded å‡½æ•°è¿›è¡Œæ£€æŸ¥ï¼Œè¯¥å‡½æ•°å°±åƒä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œåœ¨å‘½ä»¤çœŸæ­£æ‰§è¡Œä¹‹å‰è¿‡æ»¤æ‰è¿‡æœŸé”®</p><p>æƒ°æ€§åˆ é™¤çš„ç‰¹ç‚¹ï¼š</p><ul><li>ä¼˜ç‚¹ï¼šèŠ‚çº¦ CPU æ€§èƒ½ï¼Œåˆ é™¤çš„ç›®æ ‡ä»…é™äºå½“å‰å¤„ç†çš„é”®ï¼Œä¸ä¼šåœ¨åˆ é™¤å…¶ä»–æ— å…³çš„è¿‡æœŸé”®ä¸ŠèŠ±è´¹ä»»ä½• CPU æ—¶é—´</li><li>ç¼ºç‚¹ï¼šå†…å­˜å‹åŠ›å¾ˆå¤§ï¼Œå‡ºç°é•¿æœŸå ç”¨å†…å­˜çš„æ•°æ®ï¼Œå¦‚æœè¿‡æœŸé”®æ°¸è¿œä¸è¢«è®¿é—®ï¼Œè¿™ç§æƒ…å†µç›¸å½“äºå†…å­˜æ³„æ¼</li><li>æ€»ç»“ï¼šç”¨å­˜å‚¨ç©ºé—´æ¢å–å¤„ç†å™¨æ€§èƒ½ï¼ˆæ‹¿ç©ºé—´æ¢æ—¶é—´ï¼‰</li></ul><hr><h4 id="å®šæœŸåˆ é™¤" tabindex="-1"><a class="header-anchor" href="#å®šæœŸåˆ é™¤" aria-hidden="true">#</a> å®šæœŸåˆ é™¤</h4><p>å®šæœŸåˆ é™¤ç­–ç•¥æ˜¯æ¯éš”ä¸€æ®µæ—¶é—´æ‰§è¡Œä¸€æ¬¡åˆ é™¤è¿‡æœŸé”®æ“ä½œï¼Œå¹¶é€šè¿‡é™åˆ¶åˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡æ¥å‡å°‘åˆ é™¤æ“ä½œå¯¹ CPU æ—¶é—´çš„å½±å“</p><ul><li>å¦‚æœåˆ é™¤æ“ä½œæ‰§è¡Œå¾—å¤ªé¢‘ç¹ï¼Œæˆ–è€…æ‰§è¡Œæ—¶é—´å¤ªé•¿ï¼Œå°±ä¼šé€€åŒ–æˆå®šæ—¶åˆ é™¤ç­–ç•¥ï¼Œå°† CPU æ—¶é—´è¿‡å¤šåœ°æ¶ˆè€—åœ¨åˆ é™¤è¿‡æœŸé”®ä¸Š</li><li>å¦‚æœåˆ é™¤æ“ä½œæ‰§è¡Œå¾—å¤ªå°‘ï¼Œæˆ–è€…æ‰§è¡Œæ—¶é—´å¤ªçŸ­ï¼Œå®šæœŸåˆ é™¤ç­–ç•¥åˆä¼šå’Œæƒ°æ€§åˆ é™¤ç­–ç•¥ä¸€æ ·ï¼Œå‡ºç°æµªè´¹å†…å­˜çš„æƒ…å†µ</li></ul><p>å®šæœŸåˆ é™¤æ˜¯<strong>å‘¨æœŸæ€§è½®è¯¢ Redis åº“ä¸­çš„æ—¶æ•ˆæ€§</strong>æ•°æ®ï¼Œä»è¿‡æœŸå­—å…¸ä¸­éšæœºæŠ½å–ä¸€éƒ¨åˆ†é”®æ£€æŸ¥ï¼Œåˆ©ç”¨è¿‡æœŸæ•°æ®å æ¯”çš„æ–¹å¼æ§åˆ¶åˆ é™¤é¢‘åº¦</p><ul><li><p>Redis å¯åŠ¨æœåŠ¡å™¨åˆå§‹åŒ–æ—¶ï¼Œè¯»å–é…ç½® server.hz çš„å€¼ï¼Œé»˜è®¤ä¸º 10ï¼Œæ‰§è¡ŒæŒ‡ä»¤ info server å¯ä»¥æŸ¥çœ‹ï¼Œæ¯ç§’é’Ÿæ‰§è¡Œ server.hz æ¬¡ <code>serverCron() â†’ activeExpireCycle()</code></p></li><li><p>activeExpireCycle() å¯¹æŸä¸ªæ•°æ®åº“ä¸­çš„æ¯ä¸ª expires è¿›è¡Œæ£€æµ‹ï¼Œå·¥ä½œæ¨¡å¼ï¼š</p><ul><li><p>è½®è¯¢æ¯ä¸ªæ•°æ®åº“ï¼Œä»æ•°æ®åº“ä¸­å–å‡ºä¸€å®šæ•°é‡çš„éšæœºé”®è¿›è¡Œæ£€æŸ¥ï¼Œå¹¶åˆ é™¤å…¶ä¸­çš„è¿‡æœŸé”®ï¼Œå¦‚æœè¿‡æœŸ key çš„æ¯”ä¾‹è¶…è¿‡äº† 25%ï¼Œåˆ™ç»§ç»­é‡å¤æ­¤è¿‡ç¨‹ï¼Œç›´åˆ°è¿‡æœŸ key çš„æ¯”ä¾‹ä¸‹é™åˆ° 25% ä»¥ä¸‹ï¼Œæˆ–è€…è¿™æ¬¡ä»»åŠ¡çš„æ‰§è¡Œè€—æ—¶è¶…è¿‡äº† 25 æ¯«ç§’</p></li><li><p>å…¨å±€å˜é‡ current_db ç”¨äºè®°å½• activeExpireCycle() çš„æ£€æŸ¥è¿›åº¦ï¼ˆå“ªä¸€ä¸ªæ•°æ®åº“ï¼‰ï¼Œä¸‹ä¸€æ¬¡è°ƒç”¨æ—¶æ¥ç€è¯¥è¿›åº¦å¤„ç†</p></li><li><p>éšç€å‡½æ•°çš„ä¸æ–­æ‰§è¡Œï¼ŒæœåŠ¡å™¨ä¸­çš„æ‰€æœ‰æ•°æ®åº“éƒ½ä¼šè¢«æ£€æŸ¥ä¸€éï¼Œè¿™æ—¶å°† current_db é‡ç½®ä¸º 0ï¼Œç„¶åå†æ¬¡å¼€å§‹æ–°ä¸€è½®çš„æ£€æŸ¥</p></li></ul></li></ul><p>å®šæœŸåˆ é™¤ç‰¹ç‚¹ï¼š</p><ul><li>CPU æ€§èƒ½å ç”¨è®¾ç½®æœ‰å³°å€¼ï¼Œæ£€æµ‹é¢‘åº¦å¯è‡ªå®šä¹‰è®¾ç½®</li><li>å†…å­˜å‹åŠ›ä¸æ˜¯å¾ˆå¤§ï¼Œé•¿æœŸå ç”¨å†…å­˜çš„<strong>å†·æ•°æ®ä¼šè¢«æŒç»­æ¸…ç†</strong></li><li>å‘¨æœŸæ€§æŠ½æŸ¥å­˜å‚¨ç©ºé—´ï¼ˆéšæœºæŠ½æŸ¥ï¼Œé‡ç‚¹æŠ½æŸ¥ï¼‰</li></ul><hr><h3 id="æ•°æ®æ·˜æ±°" tabindex="-1"><a class="header-anchor" href="#æ•°æ®æ·˜æ±°" aria-hidden="true">#</a> æ•°æ®æ·˜æ±°</h3><h4 id="é€å‡ºç®—æ³•" tabindex="-1"><a class="header-anchor" href="#é€å‡ºç®—æ³•" aria-hidden="true">#</a> é€å‡ºç®—æ³•</h4><p>æ•°æ®æ·˜æ±°ç­–ç•¥ï¼šå½“æ–°æ•°æ®è¿›å…¥ Redis æ—¶ï¼Œåœ¨æ‰§è¡Œæ¯ä¸€ä¸ªå‘½ä»¤å‰ï¼Œä¼šè°ƒç”¨ <strong>freeMemoryIfNeeded()</strong> æ£€æµ‹å†…å­˜æ˜¯å¦å……è¶³ã€‚å¦‚æœå†…å­˜ä¸æ»¡è¶³æ–°åŠ å…¥æ•°æ®çš„æœ€ä½å­˜å‚¨è¦æ±‚ï¼ŒRedis è¦ä¸´æ—¶åˆ é™¤ä¸€äº›æ•°æ®ä¸ºå½“å‰æŒ‡ä»¤æ¸…ç†å­˜å‚¨ç©ºé—´ï¼Œæ¸…ç†æ•°æ®çš„ç­–ç•¥ç§°ä¸º<strong>é€å‡ºç®—æ³•</strong></p><p>é€å‡ºæ•°æ®çš„è¿‡ç¨‹ä¸æ˜¯ 100% èƒ½å¤Ÿæ¸…ç†å‡ºè¶³å¤Ÿçš„å¯ä½¿ç”¨çš„å†…å­˜ç©ºé—´ï¼Œå¦‚æœä¸æˆåŠŸåˆ™åå¤æ‰§è¡Œï¼Œå½“å¯¹æ‰€æœ‰æ•°æ®å°è¯•å®Œæ¯•ï¼Œå¦‚ä¸èƒ½è¾¾åˆ°å†…å­˜æ¸…ç†çš„è¦æ±‚ï¼Œ<strong>å‡ºç° Redis å†…å­˜æ‰“æ»¡å¼‚å¸¸</strong>ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">(</span>error<span class="token punctuation">)</span> OOM <span class="token builtin class-name">command</span> not allowed when used memory <span class="token operator">&gt;</span><span class="token string">&#39;maxmemory&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><hr><h4 id="ç­–ç•¥é…ç½®" tabindex="-1"><a class="header-anchor" href="#ç­–ç•¥é…ç½®" aria-hidden="true">#</a> ç­–ç•¥é…ç½®</h4><p>Redis å¦‚æœä¸è®¾ç½®æœ€å¤§å†…å­˜å¤§å°æˆ–è€…è®¾ç½®æœ€å¤§å†…å­˜å¤§å°ä¸º 0ï¼Œåœ¨ 64 ä½æ“ä½œç³»ç»Ÿä¸‹ä¸é™åˆ¶å†…å­˜å¤§å°ï¼Œåœ¨ 32 ä½æ“ä½œç³»ç»Ÿé»˜è®¤ä¸º 3GB å†…å­˜ï¼Œä¸€èˆ¬æ¨èè®¾ç½® Redis å†…å­˜ä¸ºæœ€å¤§ç‰©ç†å†…å­˜çš„å››åˆ†ä¹‹ä¸‰</p><p>å†…å­˜é…ç½®æ–¹å¼ï¼š</p><ul><li><p>é€šè¿‡ä¿®æ”¹æ–‡ä»¶é…ç½®ï¼ˆæ°¸ä¹…ç”Ÿæ•ˆï¼‰ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶ maxmemory å­—æ®µï¼Œå•ä½ä¸ºå­—èŠ‚</p></li><li><p>é€šè¿‡å‘½ä»¤ä¿®æ”¹ï¼ˆé‡å¯å¤±æ•ˆï¼‰ï¼š</p><ul><li><p><code>config set maxmemory 104857600</code>ï¼šè®¾ç½® Redis æœ€å¤§å ç”¨å†…å­˜ä¸º 100MB</p></li><li><p><code>config get maxmemory</code>ï¼šè·å– Redis æœ€å¤§å ç”¨å†…å­˜</p></li><li><p><code>info</code> ï¼šå¯ä»¥æŸ¥çœ‹ Redis å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œ<code>used_memory_human</code> å­—æ®µè¡¨ç¤ºå®é™…å·²ç»å ç”¨çš„å†…å­˜ï¼Œ<code>maxmemory</code> è¡¨ç¤ºæœ€å¤§å ç”¨å†…å­˜</p></li></ul></li></ul><p>å½±å“æ•°æ®æ·˜æ±°çš„ç›¸å…³é…ç½®å¦‚ä¸‹ï¼Œé…ç½® conf æ–‡ä»¶ï¼š</p><ul><li><p>æ¯æ¬¡é€‰å–å¾…åˆ é™¤æ•°æ®çš„ä¸ªæ•°ï¼Œé‡‡ç”¨éšæœºè·å–æ•°æ®çš„æ–¹å¼ä½œä¸ºå¾…æ£€æµ‹åˆ é™¤æ•°æ®ï¼Œé˜²æ­¢å…¨åº“æ‰«æï¼Œå¯¼è‡´ä¸¥é‡çš„æ€§èƒ½æ¶ˆè€—ï¼Œé™ä½è¯»å†™æ€§èƒ½</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>maxmemory-samples count
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>è¾¾åˆ°æœ€å¤§å†…å­˜åçš„ï¼Œå¯¹è¢«æŒ‘é€‰å‡ºæ¥çš„æ•°æ®è¿›è¡Œåˆ é™¤çš„ç­–ç•¥</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>maxmemory-policy policy
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ•°æ®åˆ é™¤çš„ç­–ç•¥ policyï¼š3 ç±» 8 ç§</p><p>ç¬¬ä¸€ç±»ï¼šæ£€æµ‹æ˜“å¤±æ•°æ®ï¼ˆå¯èƒ½ä¼šè¿‡æœŸçš„æ•°æ®é›† server.db[i].expiresï¼‰ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>volatile-lru	<span class="token comment"># å¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key é€‰æ‹©æœ€è¿‘æœ€ä¹…æœªä½¿ç”¨ä½¿ç”¨çš„æ•°æ®æ·˜æ±°</span>
volatile-lfu	<span class="token comment"># å¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key é€‰æ‹©æœ€è¿‘ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„æ•°æ®æ·˜æ±°</span>
volatile-ttl	<span class="token comment"># å¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key é€‰æ‹©å°†è¦è¿‡æœŸçš„æ•°æ®æ·˜æ±°</span>
volatile-random	<span class="token comment"># å¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key é€‰æ‹©ä»»æ„æ•°æ®æ·˜æ±°</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¬¬äºŒç±»ï¼šæ£€æµ‹å…¨åº“æ•°æ®ï¼ˆæ‰€æœ‰æ•°æ®é›† server.db[i].dict ï¼‰ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>allkeys-lru		<span class="token comment"># å¯¹æ‰€æœ‰ key é€‰æ‹©æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„æ•°æ®æ·˜æ±°</span>
allkeLyRs-lfu	<span class="token comment"># å¯¹æ‰€æœ‰ key é€‰æ‹©æœ€è¿‘ä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„æ•°æ®æ·˜æ±°</span>
allkeys-random	<span class="token comment"># å¯¹æ‰€æœ‰ key é€‰æ‹©ä»»æ„æ•°æ®æ·˜æ±°ï¼Œç›¸å½“äºéšæœº</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç¬¬ä¸‰ç±»ï¼šæ”¾å¼ƒæ•°æ®é©±é€</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>no-enviction	<span class="token comment">#ç¦æ­¢é©±é€æ•°æ®(redis4.0ä¸­é»˜è®¤ç­–ç•¥)ï¼Œä¼šå¼•å‘OOM(Out Of Memory)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><p>æ•°æ®æ·˜æ±°ç­–ç•¥é…ç½®ä¾æ®ï¼šä½¿ç”¨ INFO å‘½ä»¤è¾“å‡ºç›‘æ§ä¿¡æ¯ï¼ŒæŸ¥è¯¢ç¼“å­˜ hit å’Œ miss çš„æ¬¡æ•°ï¼Œæ ¹æ®éœ€æ±‚è°ƒä¼˜ Redis é…ç½®</p><hr><h3 id="æ’åºæœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#æ’åºæœºåˆ¶" aria-hidden="true">#</a> æ’åºæœºåˆ¶</h3><h4 id="åŸºæœ¬ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä»‹ç»" aria-hidden="true">#</a> åŸºæœ¬ä»‹ç»</h4><p>Redis çš„ SORT å‘½ä»¤å¯ä»¥å¯¹åˆ—è¡¨é”®ã€é›†åˆé”®æˆ–è€…æœ‰åºé›†åˆé”®çš„å€¼è¿›è¡Œæ’åºï¼Œå¹¶ä¸æ›´æ”¹é›†åˆä¸­çš„æ•°æ®ä½ç½®ï¼Œåªæ˜¯æŸ¥è¯¢</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>SORT key <span class="token punctuation">[</span>ASC/DESC<span class="token punctuation">]</span>			<span class="token comment">#å¯¹keyä¸­æ•°æ®æ’åºï¼Œé»˜è®¤å¯¹æ•°å­—æ’åºï¼Œå¹¶ä¸æ›´æ”¹é›†åˆä¸­çš„æ•°æ®ä½ç½®ï¼Œåªæ˜¯æŸ¥è¯¢</span>
SORT key ALPHA				<span class="token comment">#å¯¹keyä¸­å­—æ¯æ’åºï¼ŒæŒ‰ç…§å­—å…¸åº</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="sort" tabindex="-1"><a class="header-anchor" href="#sort" aria-hidden="true">#</a> SORT</h4><p><code>SORT &lt;key&gt;</code> å‘½ä»¤å¯ä»¥å¯¹ä¸€ä¸ªåŒ…å«æ•°å­—å€¼çš„é”® key è¿›è¡Œæ’åº</p><p>å‡è®¾ <code>RPUSH numbers 3 1 2</code>ï¼Œæ‰§è¡Œ <code>SORT numbers</code> çš„è¯¦ç»†æ­¥éª¤ï¼š</p><ul><li><p>åˆ›å»ºä¸€ä¸ªå’Œ key åˆ—è¡¨é•¿åº¦ç›¸åŒçš„æ•°ç»„ï¼Œæ•°ç»„æ¯é¡¹éƒ½æ˜¯ redisSortObject ç»“æ„</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisSortObject</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¢«æ’åºé”®çš„å€¼</span>
    robj <span class="token operator">*</span>obj<span class="token punctuation">;</span>
    
    <span class="token comment">// æƒé‡</span>
    <span class="token keyword">union</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ’åºæ•°å­—å€¼æ—¶ä½¿ç”¨</span>
        <span class="token keyword">double</span> score<span class="token punctuation">;</span>
        <span class="token comment">// æ’åºå¸¦æœ‰ BY é€‰é¡¹çš„å­—ç¬¦ä¸²</span>
        robj <span class="token operator">*</span>cmpobj<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> u<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>éå†æ•°ç»„ï¼Œå°†å„ä¸ªæ•°ç»„é¡¹çš„ obj æŒ‡é’ˆåˆ†åˆ«æŒ‡å‘ numbers åˆ—è¡¨çš„å„ä¸ªé¡¹</p></li><li><p>éå†æ•°ç»„ï¼Œå°† obj æŒ‡é’ˆæ‰€æŒ‡å‘çš„åˆ—è¡¨é¡¹è½¬æ¢æˆä¸€ä¸ª double ç±»å‹çš„æµ®ç‚¹æ•°ï¼Œå¹¶å°†æµ®ç‚¹æ•°ä¿å­˜åœ¨å¯¹åº”æ•°ç»„é¡¹çš„ u.score å±æ€§é‡Œ</p></li><li><p>æ ¹æ®æ•°ç»„é¡¹ u.score å±æ€§çš„å€¼ï¼Œå¯¹æ•°ç»„è¿›è¡Œæ•°å­—å€¼æ’åºï¼Œæ’åºåçš„æ•°ç»„é¡¹æŒ‰ u.score å±æ€§çš„å€¼<strong>ä»å°åˆ°å¤§æ’åˆ—</strong></p></li><li><p>éå†æ•°ç»„ï¼Œå°†å„ä¸ªæ•°ç»„é¡¹çš„ obj æŒ‡é’ˆæ‰€æŒ‡å‘çš„å€¼ä½œä¸ºæ’åºç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œç¨‹åºé¦–å…ˆè®¿é—®æ•°ç»„çš„ç´¢å¼• 0ï¼Œä¾æ¬¡å‘åè®¿é—®</p></li></ul><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-sortæ’åº.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å¯¹äº <code>SORT key [ASC/DESC]</code> å‡½æ•°ï¼š</p><ul><li>åœ¨æ‰§è¡Œå‡åºæ’åºæ—¶ï¼Œæ’åºç®—æ³•ä½¿ç”¨çš„å¯¹æ¯”å‡½æ•°äº§ç”Ÿå‡åºå¯¹æ¯”ç»“æœ</li><li>åœ¨æ‰§è¡Œé™åºæ’åºæ—¶ï¼Œæ’åºç®—æ³•ä½¿ç”¨çš„å¯¹æ¯”å‡½æ•°äº§ç”Ÿé™åºå¯¹æ¯”ç»“æœ</li></ul><hr><h4 id="by" tabindex="-1"><a class="header-anchor" href="#by" aria-hidden="true">#</a> BY</h4><p>SORT å‘½ä»¤é»˜è®¤ä½¿ç”¨è¢«æ’åºé”®ä¸­åŒ…å«çš„å…ƒç´ ä½œä¸ºæ’åºçš„æƒé‡ï¼Œå…ƒç´ æœ¬èº«å†³å®šäº†å…ƒç´ åœ¨æ’åºä¹‹åæ‰€å¤„çš„ä½ç½®ï¼Œé€šè¿‡ä½¿ç”¨ BY é€‰é¡¹ï¼ŒSORT å‘½ä»¤å¯ä»¥æŒ‡å®šæŸäº›å­—ç¬¦ä¸²é”®ï¼Œæˆ–è€…æŸä¸ªå“ˆå¸Œé”®æ‰€åŒ…å«çš„æŸäº›åŸŸï¼ˆfieldï¼‰æ¥ä½œä¸ºå…ƒç´ çš„æƒé‡ï¼Œå¯¹ä¸€ä¸ªé”®è¿›è¡Œæ’åº</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>SORT <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> BY <span class="token operator">&lt;</span>pattern<span class="token operator">&gt;</span>			<span class="token comment"># æ•°å€¼</span>
SORT <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> BY <span class="token operator">&lt;</span>pattern<span class="token operator">&gt;</span> ALPHA	<span class="token comment"># å­—ç¬¦</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis<span class="token operator">&gt;</span> SADD fruits <span class="token string">&quot;apple&quot;</span> <span class="token string">&quot;banana&quot;</span> <span class="token string">&quot;cherry&quot;</span> 
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">3</span>
redis<span class="token operator">&gt;</span> SORT fruits ALPHA
<span class="token number">1</span><span class="token punctuation">)</span>	<span class="token string">&quot;apple&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span>	<span class="token string">&quot;banana&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span>	<span class="token string">&quot;cherry&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis<span class="token operator">&gt;</span> MSET apple-price <span class="token number">8</span> banana-price <span class="token number">5.5</span> cherry-price <span class="token number">7</span> 
OK
<span class="token comment"># ä½¿ç”¨æ°´æœçš„ä»·é’±è¿›è¡Œæ’åº</span>
redis<span class="token operator">&gt;</span> SORT fruits BY *-price
<span class="token number">1</span><span class="token punctuation">)</span>	<span class="token string">&quot;banana&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span>	<span class="token string">&quot;cherry&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span>	<span class="token string">&quot;apple&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ç°åŸç†ï¼šæ’åºæ—¶çš„ u.score å±æ€§å°±ä¼šè¢«è®¾ç½®ä¸ºå¯¹åº”çš„æƒé‡</p><hr><h4 id="limit" tabindex="-1"><a class="header-anchor" href="#limit" aria-hidden="true">#</a> LIMIT</h4><p>SORT å‘½ä»¤é»˜è®¤ä¼šå°†æ’åºåçš„æ‰€æœ‰å…ƒç´ éƒ½è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œé€šè¿‡ LIMIT é€‰é¡¹å¯ä»¥è®© SORT å‘½ä»¤åªè¿”å›å…¶ä¸­ä¸€éƒ¨åˆ†å·²æ’åºçš„å…ƒç´ </p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>LIMIT <span class="token operator">&lt;</span>offset<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>count<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>offset å‚æ•°è¡¨ç¤ºè¦è·³è¿‡çš„å·²æ’åºå…ƒç´ æ•°é‡</li><li>count å‚æ•°è¡¨ç¤ºè·³è¿‡ç»™å®šæ•°é‡çš„å…ƒç´ åï¼Œè¦è¿”å›çš„å·²æ’åºå…ƒç´ æ•°é‡</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># å¯¹åº” a b c d e f  g</span>
redis<span class="token operator">&gt;</span> SORT alphabet ALPHA LIMIT <span class="token number">2</span> <span class="token number">3</span>
<span class="token number">1</span><span class="token punctuation">)</span> 	<span class="token string">&quot;c&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> 	<span class="token string">&quot;d&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> 	<span class="token string">&quot;e&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ç°åŸç†ï¼šåœ¨æ’åºåçš„ redisSortObject ç»“æ„æ•°ç»„ä¸­ï¼Œå°†æŒ‡é’ˆç§»åŠ¨åˆ°æ•°ç»„çš„ç´¢å¼• 2 ä¸Šï¼Œä¾æ¬¡è®¿é—® array[2]ã€array[3]ã€array[4] è¿™ 3 ä¸ªæ•°ç»„é¡¹ï¼Œå¹¶å°†æ•°ç»„é¡¹çš„ obj æŒ‡é’ˆæ‰€æŒ‡å‘çš„å…ƒç´ è¿”å›ç»™å®¢æˆ·ç«¯</p><hr><h4 id="get" tabindex="-1"><a class="header-anchor" href="#get" aria-hidden="true">#</a> GET</h4><p>SORT å‘½ä»¤é»˜è®¤åœ¨å¯¹é”®è¿›è¡Œæ’åºåï¼Œè¿”å›è¢«æ’åºé”®æœ¬èº«æ‰€åŒ…å«çš„å…ƒç´ ï¼Œé€šè¿‡ä½¿ç”¨ GET é€‰é¡¹ï¼Œ å¯ä»¥åœ¨å¯¹é”®è¿›è¡Œæ’åºåï¼Œæ ¹æ®è¢«æ’åºçš„å…ƒç´ ä»¥åŠ GET é€‰é¡¹æ‰€æŒ‡å®šçš„æ¨¡å¼ï¼ŒæŸ¥æ‰¾å¹¶è¿”å›æŸäº›é”®çš„å€¼</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>SORT <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> GET <span class="token operator">&lt;</span>pattern<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis<span class="token operator">&gt;</span> SADD students <span class="token string">&quot;tom&quot;</span> <span class="token string">&quot;jack&quot;</span> <span class="token string">&quot;sea&quot;</span>
<span class="token comment">#è®¾ç½®å…¨å</span>
redis<span class="token operator">&gt;</span> SET tom-name <span class="token string">&quot;Tom Li&quot;</span> 
OK 
redis<span class="token operator">&gt;</span> SET jack-name <span class="token string">&quot;Jack Wang&quot;</span> 
OK 
redis<span class="token operator">&gt;</span> SET sea-name <span class="token string">&quot;Sea Zhang&quot;</span>
OK 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis<span class="token operator">&gt;</span> SORT students ALPHA GET *-name
<span class="token number">1</span><span class="token punctuation">)</span>	<span class="token string">&quot;Jack Wang&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span>	<span class="token string">&quot;Sea Zhang&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> 	<span class="token string">&quot;Tom Li&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ç°åŸç†ï¼šå¯¹ students è¿›è¡Œæ’åºåï¼Œå¯¹äº jack å…ƒç´ å’Œ *-name æ¨¡å¼ï¼ŒæŸ¥æ‰¾ç¨‹åºè¿”å›é”® jack-nameï¼Œç„¶åè·å– jack-name é”®å¯¹åº”çš„å€¼</p><hr><h4 id="store" tabindex="-1"><a class="header-anchor" href="#store" aria-hidden="true">#</a> STORE</h4><p>SORT å‘½ä»¤é»˜è®¤åªå‘å®¢æˆ·ç«¯è¿”å›æ’åºç»“æœï¼Œè€Œä¸ä¿å­˜æ’åºç»“æœï¼Œé€šè¿‡ä½¿ç”¨ STORE é€‰é¡¹å¯ä»¥å°†æ’åºç»“æœä¿å­˜åœ¨æŒ‡å®šçš„é”®é‡Œé¢</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>SORT <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> STORE <span class="token operator">&lt;</span>sort_key<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis<span class="token operator">&gt;</span> SADD students <span class="token string">&quot;tom&quot;</span> <span class="token string">&quot;jack&quot;</span> <span class="token string">&quot;sea&quot;</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">3</span> 
redis<span class="token operator">&gt;</span> SORT students ALPHA STORE sorted_students 
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">3</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ç°åŸç†ï¼šæ’åºåï¼Œæ£€æŸ¥ sorted_students é”®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±åˆ é™¤è¯¥é”®ï¼Œè®¾ç½® sorted_students ä¸ºç©ºç™½çš„åˆ—è¡¨é”®ï¼Œéå†æ’åºæ•°ç»„å°†å…ƒç´ ä¾æ¬¡æ”¾å…¥</p><hr><h4 id="æ‰§è¡Œé¡ºåº" tabindex="-1"><a class="header-anchor" href="#æ‰§è¡Œé¡ºåº" aria-hidden="true">#</a> æ‰§è¡Œé¡ºåº</h4><p>è°ƒç”¨ SORT å‘½ä»¤ï¼Œé™¤äº† GET é€‰é¡¹ä¹‹å¤–ï¼Œæ”¹å˜å…¶ä»–é€‰é¡¹çš„æ‘†æ”¾é¡ºåºå¹¶ä¸ä¼šå½±å“å‘½ä»¤æ‰§è¡Œé€‰é¡¹çš„é¡ºåº</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>SORT <span class="token operator">&lt;</span>key<span class="token operator">&gt;</span> ALPHA <span class="token punctuation">[</span>ASC/DESC<span class="token punctuation">]</span> BY <span class="token operator">&lt;</span>by-pattern<span class="token operator">&gt;</span> LIMIT <span class="token operator">&lt;</span>offset<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>count<span class="token operator">&gt;</span> GET <span class="token operator">&lt;</span>get-pattern<span class="token operator">&gt;</span> STORE <span class="token operator">&lt;</span>store_key<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ‰§è¡Œé¡ºåºï¼š</p><ul><li>æ’åºï¼šå‘½ä»¤ä¼šä½¿ç”¨ ALPHA ã€ASC æˆ– DESCã€BY è¿™å‡ ä¸ªé€‰é¡¹ï¼Œå¯¹è¾“å…¥é”®è¿›è¡Œæ’åºï¼Œå¹¶å¾—åˆ°ä¸€ä¸ªæ’åºç»“æœé›†</li><li>é™åˆ¶æ’åºç»“æœé›†çš„é•¿åº¦ï¼šä½¿ç”¨ LIMIT é€‰é¡¹ï¼Œå¯¹æ’åºç»“æœé›†çš„é•¿åº¦è¿›è¡Œé™åˆ¶</li><li>è·å–å¤–éƒ¨é”®ï¼šæ ¹æ®æ’åºç»“æœé›†ä¸­çš„å…ƒç´ ä»¥åŠ GET é€‰é¡¹æŒ‡å®šçš„æ¨¡å¼ï¼ŒæŸ¥æ‰¾å¹¶è·å–æŒ‡å®šé”®çš„å€¼ï¼Œå¹¶ç”¨è¿™äº›å€¼æ¥ä½œä¸ºæ–°çš„æ’åºç»“æœé›†</li><li>ä¿å­˜æ’åºç»“æœé›†ï¼šä½¿ç”¨ STORE é€‰é¡¹ï¼Œå°†æ’åºç»“æœé›†ä¿å­˜åˆ°æŒ‡å®šçš„é”®ä¸Šé¢å»</li><li>å‘å®¢æˆ·ç«¯è¿”å›æ’åºç»“æœé›†ï¼šæœ€åä¸€æ­¥å‘½ä»¤éå†æ’åºç»“æœé›†ï¼Œå¹¶ä¾æ¬¡å‘å®¢æˆ·ç«¯è¿”å›æ’åºç»“æœé›†ä¸­çš„å…ƒç´ </li></ul><hr><h3 id="é€šçŸ¥æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#é€šçŸ¥æœºåˆ¶" aria-hidden="true">#</a> é€šçŸ¥æœºåˆ¶</h3><p>æ•°æ®åº“é€šçŸ¥æ˜¯å¯ä»¥è®©å®¢æˆ·ç«¯é€šè¿‡è®¢é˜…ç»™å®šçš„é¢‘é“æˆ–è€…æ¨¡å¼ï¼Œæ¥è·çŸ¥æ•°æ®åº“ä¸­é”®çš„å˜åŒ–ï¼Œä»¥åŠæ•°æ®åº“ä¸­å‘½ä»¤çš„æ‰§è¡Œæƒ…å†µ</p><ul><li>å…³æ³¨æŸä¸ªé”®æ‰§è¡Œäº†ä»€ä¹ˆå‘½ä»¤çš„é€šçŸ¥ç§°ä¸ºé”®ç©ºé—´é€šçŸ¥ï¼ˆkey-space notificationï¼‰</li><li>å…³æ³¨æŸä¸ªå‘½ä»¤è¢«ä»€ä¹ˆé”®æ‰§è¡Œçš„é€šçŸ¥ç§°ä¸ºé”®äº‹ä»¶é€šçŸ¥ï¼ˆkey-event notificationï¼‰</li></ul><p>å›¾ç¤ºè®¢é˜… 0 å·æ•°æ®åº“ message é”®ï¼š</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-æ•°æ®åº“é€šçŸ¥.png" style="zoom:67%;"><p>æœåŠ¡å™¨é…ç½®çš„ notify-keyspace-events é€‰é¡¹å†³å®šäº†æœåŠ¡å™¨æ‰€å‘é€é€šçŸ¥çš„ç±»å‹</p><ul><li>AKE ä»£è¡¨æœåŠ¡å™¨å‘é€æ‰€æœ‰ç±»å‹çš„é”®ç©ºé—´é€šçŸ¥å’Œé”®äº‹ä»¶é€šçŸ¥</li><li>AK ä»£è¡¨æœåŠ¡å™¨å‘é€æ‰€æœ‰ç±»å‹çš„é”®ç©ºé—´é€šçŸ¥</li><li>AE ä»£è¡¨æœåŠ¡å™¨å‘é€æ‰€æœ‰ç±»å‹çš„é”®äº‹ä»¶é€šçŸ¥</li><li>K$ ä»£è¡¨æœåŠ¡å™¨åªå‘é€å’Œå­—ç¬¦ä¸²é”®æœ‰å…³çš„é”®ç©ºé—´é€šçŸ¥</li><li>EL ä»£è¡¨æœåŠ¡å™¨åªå‘é€å’Œåˆ—è¡¨é”®æœ‰å…³çš„é”®äº‹ä»¶é€šçŸ¥</li><li>.....</li></ul><p>å‘é€æ•°æ®åº“é€šçŸ¥çš„åŠŸèƒ½æ˜¯ç”± notifyKeyspaceEvent å‡½æ•°å®ç°çš„ï¼š</p><ul><li>å¦‚æœç»™å®šçš„é€šçŸ¥ç±»å‹ type ä¸æ˜¯æœåŠ¡å™¨å…è®¸å‘é€çš„é€šçŸ¥ç±»å‹ï¼Œé‚£ä¹ˆå‡½æ•°ä¼šç›´æ¥è¿”å›</li><li>å¦‚æœç»™å®šçš„é€šçŸ¥æ˜¯æœåŠ¡å™¨å…è®¸å‘é€çš„é€šçŸ¥ <ul><li>æ£€æµ‹æœåŠ¡å™¨æ˜¯å¦å…è®¸å‘é€é”®ç©ºé—´é€šçŸ¥ï¼Œå…è®¸å°±ä¼šæ„å»ºå¹¶å‘é€äº‹ä»¶é€šçŸ¥</li><li>æ£€æµ‹æœåŠ¡å™¨æ˜¯å¦å…è®¸å‘é€é”®äº‹ä»¶é€šçŸ¥ï¼Œå…è®¸å°±ä¼šæ„å»ºå¹¶å‘é€äº‹ä»¶é€šçŸ¥</li></ul></li></ul><hr><h2 id="ä½“ç³»æ¶æ„" tabindex="-1"><a class="header-anchor" href="#ä½“ç³»æ¶æ„" aria-hidden="true">#</a> ä½“ç³»æ¶æ„</h2><h3 id="äº‹ä»¶é©±åŠ¨" tabindex="-1"><a class="header-anchor" href="#äº‹ä»¶é©±åŠ¨" aria-hidden="true">#</a> äº‹ä»¶é©±åŠ¨</h3><h4 id="åŸºæœ¬ä»‹ç»-1" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä»‹ç»-1" aria-hidden="true">#</a> åŸºæœ¬ä»‹ç»</h4><p>Redis æœåŠ¡å™¨æ˜¯ä¸€ä¸ªäº‹ä»¶é©±åŠ¨ç¨‹åºï¼ŒæœåŠ¡å™¨éœ€è¦å¤„ç†ä¸¤ç±»äº‹ä»¶</p><ul><li>æ–‡ä»¶äº‹ä»¶ (file event)ï¼šæœåŠ¡å™¨é€šè¿‡å¥—æ¥å­—ä¸å®¢æˆ·ç«¯ï¼ˆæˆ–å…¶ä»– Redis æœåŠ¡å™¨ï¼‰è¿›è¡Œè¿æ¥ï¼Œè€Œæ–‡ä»¶äº‹ä»¶å°±æ˜¯æœåŠ¡å™¨å¯¹å¥—æ¥å­—æ“ä½œçš„æŠ½è±¡ã€‚æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯çš„é€šä¿¡ä¼šäº§ç”Ÿç›¸åº”çš„æ–‡ä»¶äº‹ä»¶ï¼ŒæœåŠ¡å™¨é€šè¿‡ç›‘å¬å¹¶å¤„ç†è¿™äº›äº‹ä»¶å®Œæˆä¸€ç³»åˆ—ç½‘ç»œé€šä¿¡æ“ä½œ</li><li>æ—¶é—´äº‹ä»¶ (time event)ï¼šRedis æœåŠ¡å™¨ä¸­çš„ä¸€äº›æ“ä½œï¼ˆæ¯”å¦‚ serverCron å‡½æ•°ï¼‰éœ€è¦åœ¨æŒ‡å®šæ—¶é—´æ‰§è¡Œï¼Œè€Œæ—¶é—´äº‹ä»¶å°±æ˜¯æœåŠ¡å™¨å¯¹è¿™ç±»å®šæ—¶æ“ä½œçš„æŠ½è±¡</li></ul><hr><h4 id="æ–‡ä»¶äº‹ä»¶" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶äº‹ä»¶" aria-hidden="true">#</a> æ–‡ä»¶äº‹ä»¶</h4><h5 id="åŸºæœ¬ç»„æˆ" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ç»„æˆ" aria-hidden="true">#</a> åŸºæœ¬ç»„æˆ</h5><p>Redis åŸºäº Reactor æ¨¡å¼å¼€å‘äº†ç½‘ç»œäº‹ä»¶å¤„ç†å™¨ï¼Œè¿™ä¸ªå¤„ç†å™¨è¢«ç§°ä¸ºæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ (file event handler)</p><ul><li><p>ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ (multiplexing) ç¨‹åºæ¥åŒæ—¶ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œå¹¶æ ¹æ®å¥—æ¥å­—æ‰§è¡Œçš„ä»»åŠ¡æ¥ä¸ºå¥—æ¥å­—å…³è”ä¸åŒçš„äº‹ä»¶å¤„ç†å™¨</p></li><li><p>å½“è¢«ç›‘å¬çš„å¥—æ¥å­—å‡†å¤‡å¥½æ‰§è¡Œè¿æ¥åº”ç­” (accept)ã€ è¯»å– (read)ã€ å†™å…¥ (write)ã€ å…³é—­ (close) ç­‰æ“ä½œæ—¶ï¼Œä¸æ“ä½œç›¸å¯¹åº”çš„æ–‡ä»¶äº‹ä»¶å°±ä¼šäº§ç”Ÿï¼Œè¿™æ—¶æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ä¼šè°ƒç”¨å¥—æ¥å­—å…³è”å¥½çš„äº‹ä»¶å¤„ç†å™¨æ¥å¤„ç†äº‹ä»¶</p></li></ul><p>æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨<strong>ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œ</strong>ï¼Œä½†é€šè¿‡ä½¿ç”¨ I/O å¤šè·¯å¤ç”¨ç¨‹åºæ¥ç›‘å¬å¤šä¸ªå¥—æ¥å­—ï¼Œ æ—¢å®ç°äº†é«˜æ€§èƒ½çš„ç½‘ç»œé€šä¿¡æ¨¡å‹ï¼Œåˆå¯ä»¥å¾ˆå¥½åœ°ä¸ Redis æœåŠ¡å™¨ä¸­å…¶ä»–åŒæ ·ä»¥å•çº¿ç¨‹æ–¹å¼è¿è¡Œçš„æ¨¡å—è¿›è¡Œå¯¹æ¥ï¼Œä¿æŒäº† Redis å†…éƒ¨å•çº¿ç¨‹è®¾è®¡çš„ç®€å•æ€§</p><p>æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨çš„ç»„æˆç»“æ„ï¼š</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨.png" style="zoom:80%;"><p>I/O å¤šè·¯å¤ç”¨ç¨‹åºå°†æ‰€æœ‰äº§ç”Ÿäº‹ä»¶çš„å¥—æ¥å­—å¤„ç†è¯·æ±‚æ”¾å…¥ä¸€ä¸ª<strong>å•çº¿ç¨‹çš„æ‰§è¡Œé˜Ÿåˆ—</strong>ä¸­ï¼Œé€šè¿‡é˜Ÿåˆ—æœ‰åºã€åŒæ­¥çš„å‘æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ä¼ é€å¥—æ¥å­—ï¼Œä¸Šä¸€ä¸ªå¥—æ¥å­—äº§ç”Ÿçš„äº‹ä»¶å¤„ç†å®Œåï¼Œæ‰ä¼šç»§ç»­å‘åˆ†æ´¾å™¨ä¼ é€ä¸‹ä¸€ä¸ª</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-IOå¤šè·¯å¤ç”¨ç¨‹åº.png" style="zoom:67%;"><p>Redis å•çº¿ç¨‹ä¹Ÿèƒ½é«˜æ•ˆçš„åŸå› ï¼š</p><ul><li>çº¯å†…å­˜æ“ä½œ</li><li>æ ¸å¿ƒæ˜¯åŸºäºéé˜»å¡çš„ IO å¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œå•çº¿ç¨‹å¯ä»¥é«˜æ•ˆå¤„ç†å¤šä¸ªè¯·æ±‚</li><li>åº•å±‚ä½¿ç”¨ C è¯­è¨€å®ç°ï¼ŒC è¯­è¨€å®ç°çš„ç¨‹åºè·ç¦»æ“ä½œç³»ç»Ÿæ›´è¿‘ï¼Œæ‰§è¡Œé€Ÿåº¦ç›¸å¯¹ä¼šæ›´å¿«</li><li>å•çº¿ç¨‹åŒæ—¶ä¹Ÿ<strong>é¿å…äº†å¤šçº¿ç¨‹çš„ä¸Šä¸‹æ–‡é¢‘ç¹åˆ‡æ¢é—®é¢˜</strong>ï¼Œé¢„é˜²äº†å¤šçº¿ç¨‹å¯èƒ½äº§ç”Ÿçš„ç«äº‰é—®é¢˜</li></ul><hr><h5 id="å¤šè·¯å¤ç”¨" tabindex="-1"><a class="header-anchor" href="#å¤šè·¯å¤ç”¨" aria-hidden="true">#</a> å¤šè·¯å¤ç”¨</h5><p>Redis çš„ I/O å¤šè·¯å¤ç”¨ç¨‹åºçš„æ‰€æœ‰åŠŸèƒ½éƒ½æ˜¯é€šè¿‡åŒ…è£…å¸¸è§çš„ select ã€epollã€ evport å’Œ kqueue è¿™äº›å‡½æ•°åº“æ¥å®ç°çš„ï¼ŒRedis åœ¨ I/O å¤šè·¯å¤ç”¨ç¨‹åºçš„å®ç°æºç ä¸­ç”¨ #include å®å®šä¹‰äº†ç›¸åº”çš„è§„åˆ™ï¼Œç¼–è¯‘æ—¶è‡ªåŠ¨é€‰æ‹©ç³»ç»Ÿä¸­<strong>æ€§èƒ½æœ€é«˜çš„å¤šè·¯å¤ç”¨å‡½æ•°</strong>æ¥ä½œä¸ºåº•å±‚å®ç°</p><p>I/O å¤šè·¯å¤ç”¨ç¨‹åºç›‘å¬å¤šä¸ªå¥—æ¥å­—çš„ AE_READABLE äº‹ä»¶å’Œ AE_WRITABLE äº‹ä»¶ï¼Œè¿™ä¸¤ç±»äº‹ä»¶å’Œå¥—æ¥å­—æ“ä½œä¹‹é—´çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p><ul><li>å½“å¥—æ¥å­—å˜å¾—<strong>å¯è¯»</strong>æ—¶ï¼ˆå®¢æˆ·ç«¯å¯¹å¥—æ¥å­—æ‰§è¡Œ write æ“ä½œæˆ–è€… close æ“ä½œï¼‰ï¼Œæˆ–è€…æœ‰æ–°çš„<strong>å¯åº”ç­”</strong>ï¼ˆacceptableï¼‰å¥—æ¥å­—å‡ºç°æ—¶ï¼ˆå®¢æˆ·ç«¯å¯¹æœåŠ¡å™¨çš„ç›‘å¬å¥—æ¥å­—æ‰§è¡Œ connect è¿æ¥æ“ä½œï¼‰ï¼Œå¥—æ¥å­—äº§ç”Ÿ AE_READABLE äº‹ä»¶</li><li>å½“å¥—æ¥å­—å˜å¾—å¯å†™æ—¶ï¼ˆå®¢æˆ·ç«¯å¯¹å¥—æ¥å­—æ‰§è¡Œ read æ“ä½œï¼Œå¯¹äºæœåŠ¡å™¨æ¥è¯´å°±æ˜¯å¯ä»¥å†™äº†ï¼‰ï¼Œå¥—æ¥å­—äº§ç”Ÿ AE_WRITABLE äº‹ä»¶</li></ul><p>I/O å¤šè·¯å¤ç”¨ç¨‹åºå…è®¸æœåŠ¡å™¨åŒæ—¶ç›‘å¬å¥—æ¥å­—çš„ AE_READABLE å’Œ AE_WRITABLE äº‹ä»¶ï¼Œ å¦‚æœä¸€ä¸ªå¥—æ¥å­—åŒæ—¶äº§ç”Ÿäº†è¿™ä¸¤ç§äº‹ä»¶ï¼Œé‚£ä¹ˆæ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ä¼šä¼˜å…ˆå¤„ç† AE_READABLE äº‹ä»¶ï¼Œ ç­‰ AE_READABLE äº‹ä»¶å¤„ç†å®Œä¹‹åæ‰å¤„ç† AE_WRITABLE äº‹ä»¶</p><hr><h5 id="å¤„ç†å™¨" tabindex="-1"><a class="header-anchor" href="#å¤„ç†å™¨" aria-hidden="true">#</a> å¤„ç†å™¨</h5><p>Redis ä¸ºæ–‡ä»¶äº‹ä»¶ç¼–å†™äº†å¤šä¸ªå¤„ç†å™¨ï¼Œè¿™äº›äº‹ä»¶å¤„ç†å™¨åˆ†åˆ«ç”¨äºå®ç°ä¸åŒçš„ç½‘ç»œé€šä¿¡éœ€æ±‚ï¼š</p><ul><li>è¿æ¥åº”ç­”å¤„ç†å™¨ï¼Œç”¨äºå¯¹è¿æ¥æœåŠ¡å™¨çš„å„ä¸ªå®¢æˆ·ç«¯è¿›è¡Œåº”ç­”ï¼ŒRedis æœåŠ¡å™¨åˆå§‹åŒ–æ—¶å°†è¯¥å¤„ç†å™¨ä¸ AE_READABLE äº‹ä»¶å…³è”</li><li>å‘½ä»¤è¯·æ±‚å¤„ç†å™¨ï¼Œç”¨äºæ¥æ”¶å®¢æˆ·ç«¯ä¼ æ¥çš„å‘½ä»¤è¯·æ±‚ï¼Œæ‰§è¡Œå¥—æ¥å­—çš„è¯»å…¥æ“ä½œï¼Œä¸ AE_READABLE äº‹ä»¶å…³è”</li><li>å‘½ä»¤å›å¤å¤„ç†å™¨ï¼Œç”¨äºå‘å®¢æˆ·ç«¯è¿”å›å‘½ä»¤çš„æ‰§è¡Œç»“æœï¼Œæ‰§è¡Œå¥—æ¥å­—çš„å†™å…¥æ“ä½œï¼Œä¸ AE_WRITABLE äº‹ä»¶å…³è”</li><li>å¤åˆ¶å¤„ç†å™¨ï¼Œå½“ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨è¿›è¡Œå¤åˆ¶æ“ä½œæ—¶ï¼Œä¸»ä»æœåŠ¡å™¨éƒ½éœ€è¦å…³è”è¯¥å¤„ç†å™¨</li></ul><p>Redis å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨è¿›è¡Œè¿æ¥å¹¶å‘é€å‘½ä»¤çš„æ•´ä¸ªè¿‡ç¨‹ï¼š</p><ul><li>Redis æœåŠ¡å™¨æ­£åœ¨è¿ä½œç›‘å¬å¥—æ¥å­—çš„ AE_READABLE äº‹ä»¶ï¼Œå…³è”è¿æ¥åº”ç­”å¤„ç†å™¨</li><li>å½“ Redis å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘èµ·è¿æ¥ï¼Œç›‘å¬å¥—æ¥å­—å°†äº§ç”Ÿ AE_READABLE äº‹ä»¶ï¼Œè§¦å‘è¿æ¥åº”ç­”å¤„ç†å™¨æ‰§è¡Œï¼Œå¯¹å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚è¿›è¡Œåº”ç­”ï¼Œåˆ›å»ºå®¢æˆ·ç«¯å¥—æ¥å­—ä»¥åŠå®¢æˆ·ç«¯çŠ¶æ€ï¼Œå¹¶å°†å®¢æˆ·ç«¯å¥—æ¥å­—çš„ <strong>AE_READABLE äº‹ä»¶ä¸å‘½ä»¤è¯·æ±‚å¤„ç†å™¨</strong>è¿›è¡Œå…³è”</li><li>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€å‘½ä»¤è¯·æ±‚ï¼Œå®¢æˆ·ç«¯å¥—æ¥å­—äº§ç”Ÿ AE_READABLE äº‹ä»¶ï¼Œå¼•å‘å‘½ä»¤è¯·æ±‚å¤„ç†å™¨æ‰§è¡Œï¼Œè¯»å–å®¢æˆ·ç«¯çš„å‘½ä»¤å†…å®¹ä¼ ç»™ç›¸å…³ç¨‹åºå»æ‰§è¡Œ</li><li>æ‰§è¡Œå‘½ä»¤ä¼šäº§ç”Ÿç›¸åº”çš„å‘½ä»¤å›å¤ï¼Œä¸ºäº†å°†è¿™äº›å‘½ä»¤å›å¤ä¼ é€å›å®¢æˆ·ç«¯ï¼ŒæœåŠ¡å™¨ä¼šå°†å®¢æˆ·ç«¯å¥—æ¥å­—çš„ <strong>AE_WRITABLE äº‹ä»¶ä¸å‘½ä»¤å›å¤å¤„ç†å™¨</strong>è¿›è¡Œå…³è”</li><li>å½“å®¢æˆ·ç«¯å°è¯•è¯»å–å‘½ä»¤å›å¤æ—¶ï¼Œå®¢æˆ·ç«¯å¥—æ¥å­—äº§ç”Ÿ AE_WRITABLE äº‹ä»¶ï¼Œè§¦å‘å‘½ä»¤å›å¤å¤„ç†å™¨æ‰§è¡Œï¼Œåœ¨å‘½ä»¤å›å¤å…¨éƒ¨å†™å…¥å¥—æ¥å­—åï¼ŒæœåŠ¡å™¨å°±ä¼šè§£é™¤å®¢æˆ·ç«¯å¥—æ¥å­—çš„ AE_WRITABLE äº‹ä»¶ä¸å‘½ä»¤å›å¤å¤„ç†å™¨ä¹‹é—´çš„å…³è”</li></ul><hr><h4 id="æ—¶é—´äº‹ä»¶" tabindex="-1"><a class="header-anchor" href="#æ—¶é—´äº‹ä»¶" aria-hidden="true">#</a> æ—¶é—´äº‹ä»¶</h4><p>Redis çš„æ—¶é—´äº‹ä»¶åˆ†ä¸ºä»¥ä¸‹ä¸¤ç±»ï¼š</p><ul><li>å®šæ—¶äº‹ä»¶ï¼šåœ¨æŒ‡å®šçš„æ—¶é—´ä¹‹åæ‰§è¡Œä¸€æ¬¡ï¼ˆRedis ä¸­æš‚æ—¶æœªä½¿ç”¨ï¼‰</li><li>å‘¨æœŸäº‹ä»¶ï¼šæ¯éš”æŒ‡å®šæ—¶é—´å°±æ‰§è¡Œä¸€æ¬¡</li></ul><p>ä¸€ä¸ªæ—¶é—´äº‹ä»¶ä¸»è¦ç”±ä»¥ä¸‹ä¸‰ä¸ªå±æ€§ç»„æˆï¼š</p><ul><li>idï¼šæœåŠ¡å™¨ä¸ºæ—¶é—´äº‹ä»¶åˆ›å»ºçš„å…¨å±€å”¯ä¸€ IDï¼ˆæ ‡è¯†å·ï¼‰ï¼Œä»å°åˆ°å¤§é¡ºåºé€’å¢ï¼Œæ–°äº‹ä»¶çš„ ID æ¯”æ—§äº‹ä»¶çš„ ID å·è¦å¤§</li><li>whenï¼šæ¯«ç§’ç²¾åº¦çš„ UNIX æ—¶é—´æˆ³ï¼Œè®°å½•äº†æ—¶é—´äº‹ä»¶çš„åˆ°è¾¾ï¼ˆarriveï¼‰æ—¶é—´</li><li>timeProcï¼šæ—¶é—´äº‹ä»¶å¤„ç†å™¨ï¼Œå½“æ—¶é—´äº‹ä»¶åˆ°è¾¾æ—¶ï¼ŒæœåŠ¡å™¨å°±ä¼šè°ƒç”¨ç›¸åº”çš„å¤„ç†å™¨æ¥å¤„ç†äº‹ä»¶</li></ul><p>æ—¶é—´äº‹ä»¶æ˜¯å®šæ—¶äº‹ä»¶è¿˜æ˜¯å‘¨æœŸæ€§äº‹ä»¶å–å†³äºæ—¶é—´äº‹ä»¶å¤„ç†å™¨çš„è¿”å›å€¼ï¼š</p><ul><li>å®šæ—¶äº‹ä»¶ï¼šäº‹ä»¶å¤„ç†å™¨è¿”å› AE_NOMOREï¼Œè¯¥äº‹ä»¶åœ¨åˆ°è¾¾ä¸€æ¬¡åå°±ä¼šè¢«åˆ é™¤</li><li>å‘¨æœŸäº‹ä»¶ï¼šäº‹ä»¶å¤„ç†å™¨è¿”å›é AE_NOMORE çš„æ•´æ•°å€¼ï¼ŒæœåŠ¡å™¨æ ¹æ®è¯¥å€¼å¯¹äº‹ä»¶çš„ when å±æ€§æ›´æ–°ï¼Œè®©è¯¥äº‹ä»¶åœ¨ä¸€æ®µæ—¶é—´åå†æ¬¡äº¤ä»˜</li></ul><p>æœåŠ¡å™¨å°†æ‰€æœ‰æ—¶é—´äº‹ä»¶éƒ½æ”¾åœ¨ä¸€ä¸ª<strong>æ— åºé“¾è¡¨</strong>ä¸­ï¼Œæ–°çš„æ—¶é—´äº‹ä»¶æ’å…¥åˆ°é“¾è¡¨çš„è¡¨å¤´ï¼š</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-æ—¶é—´äº‹ä»¶.png" style="zoom:67%;"><p>æ— åºé“¾è¡¨æŒ‡æ˜¯é“¾è¡¨ä¸æŒ‰ when å±æ€§çš„å¤§å°æ’åºï¼Œæ¯å½“æ—¶é—´äº‹ä»¶æ‰§è¡Œå™¨è¿è¡Œæ—¶å°±å¿…é¡»éå†æ•´ä¸ªé“¾è¡¨ï¼ŒæŸ¥æ‰¾æ‰€æœ‰å·²åˆ°è¾¾çš„æ—¶é—´äº‹ä»¶ï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„äº‹ä»¶å¤„ç†å™¨å¤„ç†</p><p>æ— åºé“¾è¡¨å¹¶ä¸å½±å“æ—¶é—´äº‹ä»¶å¤„ç†å™¨çš„æ€§èƒ½ï¼Œå› ä¸ºæ­£å¸¸æ¨¡å¼ä¸‹çš„ Redis æœåŠ¡å™¨<strong>åªä½¿ç”¨ serverCron ä¸€ä¸ªæ—¶é—´äº‹ä»¶</strong>ï¼Œåœ¨ benchmark æ¨¡å¼ä¸‹æœåŠ¡å™¨ä¹Ÿåªä½¿ç”¨ä¸¤ä¸ªæ—¶é—´äº‹ä»¶ï¼Œæ‰€ä»¥æ— åºé“¾è¡¨ä¸ä¼šå½±å“æœåŠ¡å™¨çš„æ€§èƒ½ï¼Œå‡ ä¹å¯ä»¥æŒ‰ç…§ä¸€ä¸ªæŒ‡é’ˆå¤„ç†</p><hr><h4 id="äº‹ä»¶è°ƒåº¦" tabindex="-1"><a class="header-anchor" href="#äº‹ä»¶è°ƒåº¦" aria-hidden="true">#</a> äº‹ä»¶è°ƒåº¦</h4><p>æœåŠ¡å™¨ä¸­åŒæ—¶å­˜åœ¨æ–‡ä»¶äº‹ä»¶å’Œæ—¶é—´äº‹ä»¶ä¸¤ç§äº‹ä»¶ç±»å‹ï¼Œè°ƒåº¦ä¼ªä»£ç ï¼š</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># äº‹ä»¶è°ƒåº¦ä¼ªä»£ç </span>
<span class="token keyword">def</span> <span class="token function">aeProcessEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token comment"># è·å–åˆ°è¾¾æ—¶é—´ç¦»å½“å‰æ—¶é—´æœ€æ¥è¿‘çš„æ—¶é—´äº‹ä»¶ </span>
    time_event <span class="token operator">=</span> aeSearchNearestTime<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># è®¡ç®—æœ€æ¥è¿‘çš„æ—¶é—´äº‹ä»¶è·ç¦»åˆ°è¾¾è¿˜æœ‰å¤šå°‘äº³ç§’</span>
    remaind_ms <span class="token operator">=</span> time_event<span class="token punctuation">.</span>when <span class="token operator">-</span> unix_ts_now<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># å¦‚æœäº‹ä»¶å·²åˆ°è¾¾ï¼Œé‚£ä¹ˆ remaind_ms çš„å€¼å¯èƒ½ä¸ºè´Ÿæ•°ï¼Œè®¾ç½®ä¸º 0</span>
    <span class="token keyword">if</span> remaind_ms <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        remaind_ms <span class="token operator">=</span> <span class="token number">0</span>
	
    <span class="token comment"># æ ¹æ® remaind_ms çš„å€¼ï¼Œåˆ›å»º timeval ç»“æ„</span>
	timeval <span class="token operator">=</span> create_timeval_with_ms<span class="token punctuation">(</span>remaind_ms<span class="token punctuation">)</span> 
    <span class="token comment"># ã€é˜»å¡å¹¶ç­‰å¾…æ–‡ä»¶äº‹ä»¶ã€‘äº§ç”Ÿï¼Œæœ€å¤§é˜»å¡æ—¶é—´ç”±ä¼ å…¥çš„timevalç»“æ„å†³å®šï¼Œremaind_msçš„å€¼ä¸º0æ—¶è°ƒç”¨åé©¬ä¸Šè¿”å›ï¼Œä¸é˜»å¡</span>
    aeApiPoll<span class="token punctuation">(</span>timeval<span class="token punctuation">)</span>
    
    <span class="token comment"># å¤„ç†æ‰€æœ‰å·²äº§ç”Ÿçš„æ–‡ä»¶äº‹ä»¶</span>
	processFileEvents<span class="token punctuation">(</span><span class="token punctuation">)</span> 
	<span class="token comment"># å¤„ç†æ‰€æœ‰å·²åˆ°è¾¾çš„æ—¶é—´äº‹ä»¶</span>
	processTimeEvents<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>äº‹ä»¶çš„è°ƒåº¦å’Œæ‰§è¡Œè§„åˆ™ï¼š</p><ul><li>aeApiPoll å‡½æ•°çš„æœ€å¤§é˜»å¡æ—¶é—´ç”±åˆ°è¾¾æ—¶é—´æœ€æ¥è¿‘å½“å‰æ—¶é—´çš„æ—¶é—´äº‹ä»¶å†³å®šï¼Œå¯ä»¥é¿å…æœåŠ¡å™¨å¯¹æ—¶é—´äº‹ä»¶è¿›è¡Œé¢‘ç¹çš„è½®è¯¢ï¼ˆå¿™ç­‰å¾…ï¼‰ï¼Œä¹Ÿå¯ä»¥ç¡®ä¿ aeApiPoll å‡½æ•°ä¸ä¼šé˜»å¡è¿‡é•¿æ—¶é—´</li><li>å¯¹æ–‡ä»¶äº‹ä»¶å’Œæ—¶é—´äº‹ä»¶çš„å¤„ç†éƒ½æ˜¯<strong>åŒæ­¥ã€æœ‰åºã€åŸå­åœ°æ‰§è¡Œ</strong>ï¼ŒæœåŠ¡å™¨ä¸ä¼šä¸­é€”ä¸­æ–­äº‹ä»¶å¤„ç†ï¼Œä¹Ÿä¸ä¼šå¯¹äº‹ä»¶è¿›è¡ŒæŠ¢å ï¼Œæ‰€ä»¥ä¸¤ç§å¤„ç†å™¨éƒ½è¦å°½å¯åœ°å‡å°‘ç¨‹åºçš„é˜»å¡æ—¶é—´ï¼Œå¹¶åœ¨æœ‰éœ€è¦æ—¶<strong>ä¸»åŠ¨è®©å‡ºæ‰§è¡Œæƒ</strong>ï¼Œä»è€Œé™ä½äº‹ä»¶é¥¥é¥¿çš„å¯èƒ½æ€§ <ul><li>å‘½ä»¤å›å¤å¤„ç†å™¨åœ¨å†™å…¥å­—èŠ‚æ•°è¶…è¿‡äº†æŸä¸ªé¢„è®¾å¸¸é‡ï¼Œå°±ä¼šä¸»åŠ¨ç”¨ break è·³å‡ºå†™å…¥å¾ªç¯ï¼Œå°†ä½™ä¸‹çš„æ•°æ®ç•™åˆ°ä¸‹æ¬¡å†å†™</li><li>æ—¶é—´äº‹ä»¶ä¹Ÿä¼šå°†éå¸¸è€—æ—¶çš„æŒä¹…åŒ–æ“ä½œæ”¾åˆ°å­çº¿ç¨‹æˆ–è€…å­è¿›ç¨‹æ‰§è¡Œ</li></ul></li><li>æ—¶é—´äº‹ä»¶åœ¨æ–‡ä»¶äº‹ä»¶ä¹‹åæ‰§è¡Œï¼Œå¹¶ä¸”äº‹ä»¶ä¹‹é—´ä¸ä¼šå‡ºç°æŠ¢å ï¼Œæ‰€ä»¥æ—¶é—´äº‹ä»¶çš„å®é™…å¤„ç†æ—¶é—´é€šå¸¸ä¼šæ¯”è®¾å®šçš„åˆ°è¾¾æ—¶é—´ç¨æ™š</li></ul><hr><h4 id="å¤šçº¿ç¨‹" tabindex="-1"><a class="header-anchor" href="#å¤šçº¿ç¨‹" aria-hidden="true">#</a> å¤šçº¿ç¨‹</h4><p>Redis6.0 å¼•å…¥å¤šçº¿ç¨‹ä¸»è¦æ˜¯ä¸ºäº†æé«˜ç½‘ç»œ IO è¯»å†™æ€§èƒ½ï¼Œå› ä¸ºè¿™æ˜¯ Redis çš„ä¸€ä¸ªæ€§èƒ½ç“¶é¢ˆï¼ˆRedis çš„ç“¶é¢ˆä¸»è¦å—é™äºå†…å­˜å’Œç½‘ç»œï¼‰ï¼Œå¤šçº¿ç¨‹åªæ˜¯ç”¨æ¥<strong>å¤„ç†ç½‘ç»œæ•°æ®çš„è¯»å†™å’Œåè®®è§£æ</strong>ï¼Œ æ‰§è¡Œå‘½ä»¤ä»ç„¶æ˜¯å•çº¿ç¨‹é¡ºåºæ‰§è¡Œï¼Œå› æ­¤ä¸éœ€è¦æ‹…å¿ƒçº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p><p>Redis6.0 çš„å¤šçº¿ç¨‹é»˜è®¤æ˜¯ç¦ç”¨çš„ï¼Œåªä½¿ç”¨ä¸»çº¿ç¨‹ã€‚å¦‚éœ€å¼€å¯éœ€è¦ä¿®æ”¹ redis é…ç½®æ–‡ä»¶ <code>redis.conf</code> ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>io-threads-do-reads yesCopy to clipboardErrorCopied
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å¼€å¯å¤šçº¿ç¨‹åï¼Œè¿˜éœ€è¦è®¾ç½®çº¿ç¨‹æ•°ï¼Œå¦åˆ™æ˜¯ä¸ç”Ÿæ•ˆçš„ï¼ŒåŒæ ·éœ€è¦ä¿®æ”¹ redis é…ç½®æ–‡ä»¶ :</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>io-threads <span class="token number">4</span> <span class="token comment">#å®˜ç½‘å»ºè®®4æ ¸çš„æœºå™¨å»ºè®®è®¾ç½®ä¸º2æˆ–3ä¸ªçº¿ç¨‹ï¼Œ8æ ¸çš„å»ºè®®è®¾ç½®ä¸º6ä¸ªçº¿ç¨‹</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å¤šçº¿ç¨‹.png" style="zoom:80%;"><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://mp.weixin.qq.com/s/dqmiR0ECf4lB6Y2OyK-dyA" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/dqmiR0ECf4lB6Y2OyK-dyA<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><hr><h3 id="å®¢æˆ·ç«¯-1" tabindex="-1"><a class="header-anchor" href="#å®¢æˆ·ç«¯-1" aria-hidden="true">#</a> å®¢æˆ·ç«¯</h3><h4 id="åŸºæœ¬ä»‹ç»-2" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä»‹ç»-2" aria-hidden="true">#</a> åŸºæœ¬ä»‹ç»</h4><p>Redis æœåŠ¡å™¨æ˜¯å…¸å‹çš„ä¸€å¯¹å¤šç¨‹åºï¼Œä¸€ä¸ªæœåŠ¡å™¨å¯ä»¥ä¸å¤šä¸ªå®¢æˆ·ç«¯å»ºç«‹ç½‘ç»œè¿æ¥ï¼ŒæœåŠ¡å™¨å¯¹æ¯ä¸ªè¿æ¥çš„å®¢æˆ·ç«¯å»ºç«‹äº†ç›¸åº”çš„ redisClient ç»“æ„ï¼ˆå®¢æˆ·ç«¯çŠ¶æ€ï¼Œ<strong>åœ¨æœåŠ¡å™¨ç«¯çš„å­˜å‚¨ç»“æ„</strong>ï¼‰ï¼Œä¿å­˜äº†å®¢æˆ·ç«¯å½“å‰çš„çŠ¶æ€ä¿¡æ¯ï¼Œä»¥åŠæ‰§è¡Œç›¸å…³åŠŸèƒ½æ—¶éœ€è¦ç”¨åˆ°çš„æ•°æ®ç»“æ„</p><p>Redis æœåŠ¡å™¨çŠ¶æ€ç»“æ„çš„ clients å±æ€§æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨ä¿å­˜äº†æ‰€æœ‰ä¸æœåŠ¡å™¨è¿æ¥çš„å®¢æˆ·ç«¯çš„çŠ¶æ€ç»“æ„ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä¸€ä¸ªé“¾è¡¨ï¼Œä¿å­˜äº†æ‰€æœ‰å®¢æˆ·ç«¯çŠ¶æ€</span>
    list <span class="token operator">*</span>clients<span class="token punctuation">;</span>
    
    <span class="token comment">//...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-æœåŠ¡å™¨clientsé“¾è¡¨.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h4 id="æ•°æ®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#æ•°æ®ç»“æ„" aria-hidden="true">#</a> æ•°æ®ç»“æ„</h4><h5 id="redisclient" tabindex="-1"><a class="header-anchor" href="#redisclient" aria-hidden="true">#</a> redisClient</h5><p>å®¢æˆ·ç«¯çš„æ•°æ®ç»“æ„ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisClient</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    
    <span class="token comment">// å¥—æ¥å­—</span>
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    <span class="token comment">// åå­—</span>
    robj <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token comment">// æ ‡å¿—</span>
    <span class="token keyword">int</span> flags<span class="token punctuation">;</span>
    
    <span class="token comment">// è¾“å…¥ç¼“å†²åŒº</span>
    sds querybuf<span class="token punctuation">;</span>
    <span class="token comment">// è¾“å‡ºç¼“å†²åŒº buf æ•°ç»„</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>REDIS_REPLY_CHUNK_BYTES<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// è®°å½•äº† buf æ•°ç»„ç›®å‰å·²ä½¿ç”¨çš„å­—èŠ‚æ•°é‡</span>
    <span class="token keyword">int</span> bufpos<span class="token punctuation">;</span> 
    <span class="token comment">// å¯å˜å¤§å°çš„è¾“å‡ºç¼“å†²åŒºï¼Œé“¾è¡¨ + å­—ç¬¦ä¸²å¯¹è±¡</span>
    list <span class="token operator">*</span>reply<span class="token punctuation">;</span>
    
    <span class="token comment">// å‘½ä»¤æ•°ç»„</span>
    rboj <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">;</span>
    <span class="token comment">// å‘½ä»¤æ•°ç»„çš„é•¿åº¦</span>
   	<span class="token keyword">int</span> argc<span class="token punctuation">;</span>
    <span class="token comment">// å‘½ä»¤çš„ä¿¡æ¯</span>
    <span class="token keyword">struct</span> <span class="token class-name">redisCommand</span>  <span class="token operator">*</span>cmd<span class="token punctuation">;</span>
    
    <span class="token comment">// æ˜¯å¦é€šè¿‡èº«ä»½éªŒè¯</span>
    <span class="token keyword">int</span> authenticated<span class="token punctuation">;</span>
    
    <span class="token comment">// åˆ›å»ºå®¢æˆ·ç«¯çš„æ—¶é—´</span>
    <span class="token class-name">time_t</span> ctime<span class="token punctuation">;</span>
    <span class="token comment">// å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨æœ€åä¸€æ¬¡è¿›è¡Œäº¤äº’çš„æ—¶é—´</span>
    <span class="token class-name">time_t</span> lastinteraction<span class="token punctuation">;</span>
    <span class="token comment">// è¾“å‡ºç¼“å†²åŒºç¬¬ä¸€æ¬¡åˆ°è¾¾è½¯æ€§é™åˆ¶ (soft limit) çš„æ—¶é—´</span>
    <span class="token class-name">time_t</span> obuf_soft_limit_reached_time<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®¢æˆ·ç«¯çŠ¶æ€åŒ…æ‹¬ä¸¤ç±»å±æ€§</p><ul><li>ä¸€ç±»æ˜¯æ¯”è¾ƒé€šç”¨çš„å±æ€§ï¼Œè¿™äº›å±æ€§å¾ˆå°‘ä¸ç‰¹å®šåŠŸèƒ½ç›¸å…³ï¼Œæ— è®ºå®¢æˆ·ç«¯æ‰§è¡Œçš„æ˜¯ä»€ä¹ˆå·¥ä½œï¼Œéƒ½è¦ç”¨åˆ°è¿™äº›å±æ€§</li><li>å¦ä¸€ç±»æ˜¯å’Œç‰¹å®šåŠŸèƒ½ç›¸å…³çš„å±æ€§ï¼Œæ¯”å¦‚æ“ä½œæ•°æ®åº“æ—¶ç”¨åˆ°çš„ db å±æ€§å’Œ dict id å±æ€§ï¼Œæ‰§è¡Œäº‹åŠ¡æ—¶ç”¨åˆ°çš„ mstate å±æ€§ï¼Œä»¥åŠæ‰§è¡Œ WATCH å‘½ä»¤æ—¶ç”¨åˆ°çš„ watched_keys å±æ€§ç­‰ï¼Œä»£ç ä¸­æ²¡æœ‰åˆ—å‡º</li></ul><hr><h5 id="å¥—æ¥å­—" tabindex="-1"><a class="header-anchor" href="#å¥—æ¥å­—" aria-hidden="true">#</a> å¥—æ¥å­—</h5><p>å®¢æˆ·ç«¯çŠ¶æ€çš„ fd å±æ€§è®°å½•äº†å®¢æˆ·ç«¯æ­£åœ¨ä½¿ç”¨çš„å¥—æ¥å­—æè¿°ç¬¦ï¼Œæ ¹æ®å®¢æˆ·ç«¯ç±»å‹çš„ä¸åŒï¼Œfd å±æ€§çš„å€¼å¯ä»¥æ˜¯ -1 æˆ–è€…å¤§äº -1 çš„æ•´æ•°ï¼š</p><ul><li>ä¼ªå®¢æˆ·ç«¯ (fake client) çš„ fd å±æ€§çš„å€¼ä¸º -1ï¼Œå‘½ä»¤è¯·æ±‚æ¥æºäº AOF æ–‡ä»¶æˆ–è€… Lua è„šæœ¬ï¼Œè€Œä¸æ˜¯ç½‘ç»œï¼Œæ‰€ä»¥ä¸éœ€è¦å¥—æ¥å­—è¿æ¥</li><li>æ™®é€šå®¢æˆ·ç«¯çš„ fd å±æ€§çš„å€¼ä¸ºå¤§äº -1 çš„æ•´æ•°ï¼Œå› ä¸ºåˆæ³•çš„å¥—æ¥å­—æè¿°ç¬¦ä¸èƒ½æ˜¯ -1</li></ul><p>æ‰§è¡Œ <code>CLIENT list</code> å‘½ä»¤å¯ä»¥åˆ—å‡ºç›®å‰æ‰€æœ‰è¿æ¥åˆ°æœåŠ¡å™¨çš„æ™®é€šå®¢æˆ·ç«¯ï¼Œä¸åŒ…æ‹¬ä¼ªå®¢æˆ·ç«¯</p><hr><h5 id="åå­—" tabindex="-1"><a class="header-anchor" href="#åå­—" aria-hidden="true">#</a> åå­—</h5><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªè¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯æ˜¯æ²¡æœ‰åå­—çš„ï¼Œä½¿ç”¨ <code>CLIENT setname</code> å‘½ä»¤å¯ä»¥ä¸ºå®¢æˆ·ç«¯è®¾ç½®ä¸€ä¸ªåå­—</p><hr><h5 id="æ ‡å¿—" tabindex="-1"><a class="header-anchor" href="#æ ‡å¿—" aria-hidden="true">#</a> æ ‡å¿—</h5><p>å®¢æˆ·ç«¯çš„æ ‡å¿—å±æ€§ flags è®°å½•äº†å®¢æˆ·ç«¯çš„è§’è‰²ä»¥åŠå®¢æˆ·ç«¯ç›®å‰æ‰€å¤„çš„çŠ¶æ€ï¼Œæ¯ä¸ªæ ‡å¿—ä½¿ç”¨ä¸€ä¸ªå¸¸é‡è¡¨ç¤º</p><ul><li>flags çš„å€¼å¯ä»¥æ˜¯å•ä¸ªæ ‡å¿—ï¼š<code>flags = &lt;flag&gt; </code></li><li>flags çš„å€¼å¯ä»¥æ˜¯å¤šä¸ªæ ‡å¿—çš„äºŒè¿›åˆ¶ï¼š<code>flags = &lt;flagl&gt; | &lt;flag2&gt; | ... </code></li></ul><p>ä¸€éƒ¨åˆ†æ ‡å¿—è®°å½•<strong>å®¢æˆ·ç«¯çš„è§’è‰²</strong>ï¼š</p><ul><li>REDIS_MASTER è¡¨ç¤ºå®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªä»æœåŠ¡å™¨ï¼ŒREDIS_SLAVE è¡¨ç¤ºå®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªä»æœåŠ¡å™¨ï¼Œåœ¨ä¸»ä»å¤åˆ¶æ—¶ä½¿ç”¨</li><li>REDIS_PRE_PSYNC è¡¨ç¤ºå®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªç‰ˆæœ¬ä½äº Redis2.8 çš„ä»æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨ä¸èƒ½ä½¿ç”¨ PSYNC å‘½ä»¤ä¸è¯¥ä»æœåŠ¡å™¨è¿›è¡ŒåŒæ­¥ï¼Œè¿™ä¸ªæ ‡å¿—åªèƒ½åœ¨ REDIS_ SLAVE æ ‡å¿—å¤„äºæ‰“å¼€çŠ¶æ€æ—¶ä½¿ç”¨</li><li>REDIS_LUA_CLIENT è¡¨ç¤ºå®¢æˆ·ç«¯æ˜¯ä¸“é—¨ç”¨äºå¤„ç† Lua è„šæœ¬é‡Œé¢åŒ…å«çš„ Redis å‘½ä»¤çš„ä¼ªå®¢æˆ·ç«¯</li></ul><p>ä¸€éƒ¨åˆ†æ ‡å¿—è®°å½•ç›®å‰<strong>å®¢æˆ·ç«¯æ‰€å¤„çš„çŠ¶æ€</strong>ï¼š</p><ul><li>REDIS_UNIX_SOCKET è¡¨ç¤ºæœåŠ¡å™¨ä½¿ç”¨ UNIX å¥—æ¥å­—æ¥è¿æ¥å®¢æˆ·ç«¯</li><li>REDIS_BLOCKED è¡¨ç¤ºå®¢æˆ·ç«¯æ­£åœ¨è¢« BRPOPã€BLPOP ç­‰å‘½ä»¤é˜»å¡</li><li>REDIS_UNBLOCKED è¡¨ç¤ºå®¢æˆ·ç«¯å·²ç»ä» REDIS_BLOCKED æ‰€è¡¨ç¤ºçš„é˜»å¡çŠ¶æ€è„±ç¦»ï¼Œåœ¨ REDIS_BLOCKED æ ‡å¿—æ‰“å¼€çš„æƒ…å†µä¸‹ä½¿ç”¨</li><li>REDIS_MULTI æ ‡å¿—è¡¨ç¤ºå®¢æˆ·ç«¯æ­£åœ¨æ‰§è¡Œäº‹åŠ¡</li><li>REDIS_DIRTY_CAS è¡¨ç¤ºäº‹åŠ¡ä½¿ç”¨ WATCH å‘½ä»¤ç›‘è§†çš„æ•°æ®åº“é”®å·²ç»è¢«ä¿®æ”¹</li><li>.....</li></ul><hr><h5 id="ç¼“å†²åŒº" tabindex="-1"><a class="header-anchor" href="#ç¼“å†²åŒº" aria-hidden="true">#</a> ç¼“å†²åŒº</h5><p>å®¢æˆ·ç«¯çŠ¶æ€çš„è¾“å…¥ç¼“å†²åŒºç”¨äºä¿å­˜å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤è¯·æ±‚ï¼Œè¾“å…¥ç¼“å†²åŒºçš„å¤§å°ä¼šæ ¹æ®è¾“å…¥å†…å®¹åŠ¨æ€åœ°ç¼©å°æˆ–è€…æ‰©å¤§ï¼Œä½†æœ€å¤§å¤§å°ä¸èƒ½è¶…è¿‡ 1GBï¼Œå¦åˆ™æœåŠ¡å™¨å°†å…³é—­è¿™ä¸ªå®¢æˆ·ç«¯ï¼Œæ¯”å¦‚æ‰§è¡Œ <code>SET key value </code>ï¼Œé‚£ä¹ˆç¼“å†²åŒº querybuf çš„å†…å®¹ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>*3<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$3</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nSET<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$3</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nkey<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$5</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nvalue<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n <span class="token comment"># </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¾“å‡ºç¼“å†²åŒºæ˜¯æœåŠ¡å™¨ç”¨äºä¿å­˜æ‰§è¡Œå®¢æˆ·ç«¯å‘½ä»¤æ‰€å¾—çš„å‘½ä»¤å›å¤ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯éƒ½æœ‰ä¸¤ä¸ªè¾“å‡ºç¼“å†²åŒºå¯ç”¨ï¼š</p><ul><li>ä¸€ä¸ªæ˜¯å›ºå®šå¤§å°çš„ç¼“å†²åŒºï¼Œä¿å­˜é•¿åº¦æ¯”è¾ƒå°çš„å›å¤ï¼Œæ¯”å¦‚ OKã€ç®€çŸ­çš„å­—ç¬¦ä¸²å€¼ã€æ•´æ•°å€¼ã€é”™è¯¯å›å¤ç­‰</li><li>ä¸€ä¸ªæ˜¯å¯å˜å¤§å°çš„ç¼“å†²åŒºï¼Œä¿å­˜é‚£äº›é•¿åº¦æ¯”è¾ƒå¤§çš„å›å¤ï¼Œ æ¯”å¦‚ä¸€ä¸ªéå¸¸é•¿çš„å­—ç¬¦ä¸²å€¼æˆ–è€…ä¸€ä¸ªåŒ…å«äº†å¾ˆå¤šå…ƒç´ çš„é›†åˆç­‰</li></ul><p>buf æ˜¯ä¸€ä¸ªå¤§å°ä¸º REDIS_REPLY_CHUNK_BYTES (å¸¸é‡é»˜è®¤ 16*1024 = 16KB) å­—èŠ‚çš„å­—èŠ‚æ•°ç»„ï¼Œbufpos å±æ€§è®°å½•äº† buf æ•°ç»„ç›®å‰å·²ä½¿ç”¨çš„å­—èŠ‚æ•°é‡ï¼Œå½“ buf æ•°ç»„çš„ç©ºé—´å·²ç»ç”¨å®Œæˆ–è€…å›å¤æ•°æ®å¤ªå¤§æ— æ³•æ”¾è¿› buf æ•°ç»„é‡Œï¼ŒæœåŠ¡å™¨å°±ä¼šå¼€å§‹ä½¿ç”¨å¯å˜å¤§å°çš„ç¼“å†²åŒº</p><p>é€šè¿‡ä½¿ç”¨ reply é“¾è¡¨è¿æ¥å¤šä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¯ä»¥ä¸ºå®¢æˆ·ç«¯ä¿å­˜ä¸€ä¸ªéå¸¸é•¿çš„å‘½ä»¤å›å¤ï¼Œè€Œä¸å¿…å—åˆ°å›ºå®šå¤§å°ç¼“å†²åŒº 16KB å¤§å°çš„é™åˆ¶</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å¯å˜è¾“å‡ºç¼“å†²åŒº.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h5 id="å‘½ä»¤" tabindex="-1"><a class="header-anchor" href="#å‘½ä»¤" aria-hidden="true">#</a> å‘½ä»¤</h5><p>æœåŠ¡å™¨å¯¹ querybuf ä¸­çš„å‘½ä»¤è¯·æ±‚çš„å†…å®¹è¿›è¡Œåˆ†æï¼Œå¾—å‡ºçš„å‘½ä»¤å‚æ•°ä»¥åŠå‚æ•°çš„æ•°é‡åˆ†åˆ«ä¿å­˜åˆ°å®¢æˆ·ç«¯çŠ¶æ€çš„ argv å’Œ argc å±æ€§</p><ul><li>argv å±æ€§æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯é¡¹éƒ½æ˜¯å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå…¶ä¸­ argv[0] æ˜¯è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œè€Œä¹‹åçš„å…¶ä»–é¡¹åˆ™æ˜¯å‘½ä»¤çš„å‚æ•°</li><li>argc å±æ€§è´Ÿè´£è®°å½• argv æ•°ç»„çš„é•¿åº¦</li></ul><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å‘½ä»¤æ•°ç»„.png" style="zoom:67%;"><p>æœåŠ¡å™¨å°†æ ¹æ®é¡¹ argv[0] çš„å€¼ï¼Œåœ¨å‘½ä»¤è¡¨ä¸­æŸ¥æ‰¾å‘½ä»¤æ‰€å¯¹åº”çš„å‘½ä»¤çš„ redisCommandï¼Œå°†å®¢æˆ·ç«¯çŠ¶æ€çš„ cmd æŒ‡å‘è¯¥ç»“æ„</p><p>å‘½ä»¤è¡¨æ˜¯ä¸€ä¸ªå­—å…¸ç»“æ„ï¼Œé”®æ˜¯ SDS ç»“æ„ä¿å­˜å‘½ä»¤çš„åå­—ï¼›å€¼æ˜¯å‘½ä»¤æ‰€å¯¹åº”çš„ redisCommand ç»“æ„ï¼Œä¿å­˜äº†å‘½ä»¤çš„å®ç°å‡½æ•°ã€å‘½ä»¤æ ‡å¿—ã€ å‘½ä»¤åº”è¯¥ç»™å®šçš„å‚æ•°ä¸ªæ•°ã€å‘½ä»¤çš„æ€»æ‰§è¡Œæ¬¡æ•°å’Œæ€»æ¶ˆè€—æ—¶é•¿ç­‰ç»Ÿè®¡ä¿¡æ¯</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å‘½ä»¤æŸ¥æ‰¾.png" style="zoom:67%;"><hr><h5 id="éªŒè¯" tabindex="-1"><a class="header-anchor" href="#éªŒè¯" aria-hidden="true">#</a> éªŒè¯</h5><p>å®¢æˆ·ç«¯çŠ¶æ€çš„ authenticated å±æ€§ç”¨äºè®°å½•å®¢æˆ·ç«¯æ˜¯å¦é€šè¿‡äº†èº«ä»½éªŒè¯</p><ul><li>authenticated å€¼ä¸º 0ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯æœªé€šè¿‡èº«ä»½éªŒè¯</li><li>authenticated å€¼ä¸º 1ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯å·²é€šè¿‡èº«ä»½éªŒè¯</li></ul><p>å½“å®¢æˆ·ç«¯ authenticated = 0 æ—¶ï¼Œé™¤äº† AUTH å‘½ä»¤ä¹‹å¤–ï¼Œ å®¢æˆ·ç«¯å‘é€çš„æ‰€æœ‰å…¶ä»–å‘½ä»¤éƒ½ä¼šè¢«æœåŠ¡å™¨æ‹’ç»æ‰§è¡Œ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis<span class="token operator">&gt;</span> PING 
<span class="token punctuation">(</span>error<span class="token punctuation">)</span> NOAUTH Authentication required.
redis<span class="token operator">&gt;</span> AUTH <span class="token number">123321</span> 
OK
redis<span class="token operator">&gt;</span> PING 
PONG 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h5 id="æ—¶é—´" tabindex="-1"><a class="header-anchor" href="#æ—¶é—´" aria-hidden="true">#</a> æ—¶é—´</h5><p>ctime å±æ€§è®°å½•äº†åˆ›å»ºå®¢æˆ·ç«¯çš„æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´å¯ä»¥ç”¨æ¥è®¡ç®—å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å·²ç»è¿æ¥äº†å¤šå°‘ç§’ï¼Œ<code>CLIENT list</code> å‘½ä»¤çš„ age åŸŸè®°å½•äº†è¿™ä¸ªç§’æ•°</p><p>lastinteraction å±æ€§è®°å½•äº†å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨æœ€åä¸€æ¬¡è¿›è¡Œäº’åŠ¨ (interaction) çš„æ—¶é—´ï¼Œäº’åŠ¨å¯ä»¥æ˜¯å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€å‘½ä»¤è¯·æ±‚ï¼Œä¹Ÿå¯ä»¥æ˜¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€å‘½ä»¤å›å¤ã€‚è¯¥å±æ€§å¯ä»¥ç”¨æ¥è®¡ç®—å®¢æˆ·ç«¯çš„ç©ºè½¬ (idle) æ—¶é•¿ï¼Œ å°±æ˜¯è·ç¦»å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨æœ€åä¸€æ¬¡è¿›è¡Œäº’åŠ¨å·²ç»è¿‡å»äº†å¤šå°‘ç§’ï¼Œ<code>CLIENT list</code> å‘½ä»¤çš„ idle åŸŸè®°å½•äº†è¿™ä¸ªç§’æ•°</p><p>obuf_soft_limit_reached_time å±æ€§è®°å½•äº†<strong>è¾“å‡ºç¼“å†²åŒºç¬¬ä¸€æ¬¡åˆ°è¾¾è½¯æ€§é™åˆ¶</strong> (soft limit) çš„æ—¶é—´</p><hr><h4 id="ç”Ÿå‘½å‘¨æœŸ" tabindex="-1"><a class="header-anchor" href="#ç”Ÿå‘½å‘¨æœŸ" aria-hidden="true">#</a> ç”Ÿå‘½å‘¨æœŸ</h4><h5 id="åˆ›å»º" tabindex="-1"><a class="header-anchor" href="#åˆ›å»º" aria-hidden="true">#</a> åˆ›å»º</h5><p>æœåŠ¡å™¨ä½¿ç”¨ä¸åŒçš„æ–¹å¼æ¥åˆ›å»ºå’Œå…³é—­ä¸åŒç±»å‹çš„å®¢æˆ·ç«¯</p><p>å¦‚æœå®¢æˆ·ç«¯æ˜¯é€šè¿‡ç½‘ç»œè¿æ¥ä¸æœåŠ¡å™¨è¿›è¡Œè¿æ¥çš„æ™®é€šå®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆåœ¨å®¢æˆ·ç«¯ä½¿ç”¨ connect å‡½æ•°è¿æ¥åˆ°æœåŠ¡å™¨æ—¶ï¼ŒæœåŠ¡å™¨å°±ä¼šè°ƒç”¨è¿æ¥åº”ç­”å¤„ç†å™¨ä¸ºå®¢æˆ·ç«¯åˆ›å»ºç›¸åº”çš„å®¢æˆ·ç«¯çŠ¶æ€ï¼Œå¹¶å°†è¿™ä¸ªæ–°çš„å®¢æˆ·ç«¯çŠ¶æ€æ·»åŠ åˆ°æœåŠ¡å™¨çŠ¶æ€ç»“æ„ clients é“¾è¡¨çš„æœ«å°¾</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-æœåŠ¡å™¨clientsé“¾è¡¨.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>æœåŠ¡å™¨ä¼šåœ¨åˆå§‹åŒ–æ—¶åˆ›å»ºè´Ÿè´£æ‰§è¡Œ Lua è„šæœ¬ä¸­åŒ…å«çš„ Redis å‘½ä»¤çš„ä¼ªå®¢æˆ·ç«¯ï¼Œå¹¶å°†ä¼ªå®¢æˆ·ç«¯å…³è”åœ¨æœåŠ¡å™¨çŠ¶æ€çš„ lua_client å±æ€§</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä¿å­˜ä¼ªå®¢æˆ·ç«¯</span>
    redisClient <span class="token operator">*</span>lua_clientï¼›
    
    <span class="token comment">//...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>lua_client ä¼ªå®¢æˆ·ç«¯åœ¨æœåŠ¡å™¨è¿è¡Œçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¼šä¸€ç›´å­˜åœ¨ï¼Œåªæœ‰æœåŠ¡å™¨è¢«å…³é—­æ—¶ï¼Œè¿™ä¸ªå®¢æˆ·ç«¯æ‰ä¼šè¢«å…³é—­</p><p>è½½å…¥ AOF æ–‡ä»¶æ—¶ï¼Œ æœåŠ¡å™¨ä¼šåˆ›å»ºç”¨äºæ‰§è¡Œ AOF æ–‡ä»¶åŒ…å«çš„ Redis å‘½ä»¤çš„ä¼ªå®¢æˆ·ç«¯ï¼Œå¹¶åœ¨è½½å…¥å®Œæˆä¹‹åï¼Œå…³é—­è¿™ä¸ªä¼ªå®¢æˆ·ç«¯</p><hr><h5 id="å…³é—­" tabindex="-1"><a class="header-anchor" href="#å…³é—­" aria-hidden="true">#</a> å…³é—­</h5><p>ä¸€ä¸ªæ™®é€šå®¢æˆ·ç«¯å¯ä»¥å› ä¸ºå¤šç§åŸå› è€Œè¢«å…³é—­ï¼š</p><ul><li>å®¢æˆ·ç«¯è¿›ç¨‹é€€å‡ºæˆ–è€…è¢«æ€æ­»ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œè¿æ¥å°†è¢«å…³é—­ï¼Œä»è€Œé€ æˆå®¢æˆ·ç«¯è¢«å…³é—­</li><li>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€äº†å¸¦æœ‰ä¸ç¬¦åˆåè®®æ ¼å¼çš„å‘½ä»¤è¯·æ±‚ï¼Œé‚£ä¹ˆè¿™ä¸ªå®¢æˆ·ç«¯ä¼š<strong>è¢«æœåŠ¡å™¨å…³é—­</strong></li><li>å®¢æˆ·ç«¯æ˜¯ <code>CLIENT KILL</code> å‘½ä»¤çš„ç›®æ ‡</li><li>å¦‚æœç”¨æˆ·ä¸ºæœåŠ¡å™¨è®¾ç½®äº† timeout é…ç½®é€‰é¡¹ï¼Œé‚£ä¹ˆå½“å®¢æˆ·ç«¯çš„ç©ºè½¬æ—¶é—´è¶…è¿‡è¯¥å€¼æ—¶å°†è¢«å…³é—­ï¼Œç‰¹æ®Šæƒ…å†µä¸ä¼šè¢«å…³é—­ï¼š <ul><li>å®¢æˆ·ç«¯æ˜¯ä¸»æœåŠ¡å™¨ï¼ˆREDIS_MASTER ï¼‰æˆ–è€…ä»æœåŠ¡å™¨ï¼ˆæ‰“å¼€äº† REDIS_SLAVE æ ‡å¿—ï¼‰</li><li>æ­£åœ¨è¢« BLPOP ç­‰å‘½ä»¤é˜»å¡ï¼ˆREDIS_BLOCKEDï¼‰</li><li>æ­£åœ¨æ‰§è¡Œ SUBSCRIBEã€PSUBSCRIBE ç­‰è®¢é˜…å‘½ä»¤</li></ul></li><li>å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤è¯·æ±‚çš„å¤§å°è¶…è¿‡äº†è¾“å…¥ç¼“å†²åŒºçš„é™åˆ¶å¤§å°ï¼ˆé»˜è®¤ä¸º 1GBï¼‰</li><li>å‘é€ç»™å®¢æˆ·ç«¯çš„å‘½ä»¤å›å¤çš„å¤§å°è¶…è¿‡äº†è¾“å‡ºç¼“å†²åŒºçš„é™åˆ¶å¤§å°</li></ul><p>ç†è®ºä¸Šæ¥è¯´ï¼Œå¯å˜ç¼“å†²åŒºå¯ä»¥ä¿å­˜ä»»æ„é•¿çš„å‘½ä»¤å›å¤ï¼Œä½†æ˜¯ä¸ºäº†å›å¤è¿‡å¤§å ç”¨è¿‡å¤šçš„æœåŠ¡å™¨èµ„æºï¼ŒæœåŠ¡å™¨ä¼šæ—¶åˆ»æ£€æŸ¥å®¢æˆ·ç«¯çš„è¾“å‡ºç¼“å†²åŒºçš„å¤§å°ï¼Œå¹¶åœ¨ç¼“å†²åŒºçš„å¤§å°è¶…å‡ºèŒƒå›´æ—¶ï¼Œæ‰§è¡Œç›¸åº”çš„é™åˆ¶æ“ä½œï¼š</p><ul><li>ç¡¬æ€§é™åˆ¶ (hard limit)ï¼šè¾“å‡ºç¼“å†²åŒºçš„å¤§å°è¶…è¿‡äº†ç¡¬æ€§é™åˆ¶æ‰€è®¾ç½®çš„å¤§å°ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šå…³é—­å®¢æˆ·ç«¯ï¼ˆserverCron å‡½æ•°ä¸­æ‰§è¡Œï¼‰ï¼Œç§¯å­˜åœ¨è¾“å‡ºç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹ä¼šè¢«<strong>ç›´æ¥é‡Šæ”¾</strong>ï¼Œä¸ä¼šè¿”å›ç»™å®¢æˆ·ç«¯</li><li>è½¯æ€§é™åˆ¶ (soft limit)ï¼šè¾“å‡ºç¼“å†²åŒºçš„å¤§å°è¶…è¿‡äº†è½¯æ€§é™åˆ¶æ‰€è®¾ç½®çš„å¤§å°ï¼Œå°äºç¡¬æ€§é™åˆ¶çš„å¤§å°ï¼ŒæœåŠ¡å™¨çš„æ“ä½œï¼š <ul><li>ç”¨å±æ€§ obuf_soft_limit_reached_time è®°å½•ä¸‹å®¢æˆ·ç«¯åˆ°è¾¾è½¯æ€§é™åˆ¶çš„èµ·å§‹æ—¶é—´ï¼Œç»§ç»­ç›‘è§†å®¢æˆ·ç«¯</li><li>å¦‚æœè¾“å‡ºç¼“å†²åŒºçš„å¤§å°ä¸€ç›´è¶…å‡ºè½¯æ€§é™åˆ¶ï¼Œå¹¶ä¸”æŒç»­æ—¶é—´è¶…è¿‡æœåŠ¡å™¨è®¾å®šçš„æ—¶é•¿ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°†å…³é—­å®¢æˆ·ç«¯</li><li>å¦‚æœåœ¨æŒ‡å®šæ—¶é—´å†…ä¸å†è¶…å‡ºè½¯æ€§é™åˆ¶ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å°±ä¸ä¼šè¢«å…³é—­ï¼Œå¹¶ä¸” o_s_l_r_t å±æ€§æ¸…é›¶</li></ul></li></ul><p>ä½¿ç”¨ client-output-buffer-limit é€‰é¡¹å¯ä»¥ä¸ºæ™®é€šå®¢æˆ·ç«¯ã€ä»æœåŠ¡å™¨å®¢æˆ·ç«¯ã€æ‰§è¡Œå‘å¸ƒä¸è®¢é˜…åŠŸèƒ½çš„å®¢æˆ·ç«¯åˆ†åˆ«è®¾ç½®ä¸åŒçš„è½¯æ€§é™åˆ¶å’Œç¡¬æ€§é™åˆ¶ï¼Œæ ¼å¼ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>client-output-buffer-limit <span class="token operator">&lt;</span>class<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>hard limit<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>soft limit<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>soft seconds<span class="token operator">&gt;</span>

client-output-buffer-limit normal <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> 
client-output-buffer-limit slave 256mb 64mb <span class="token number">60</span> 
client-output-buffer-limit pubsub 32mb 8mb <span class="token number">60</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>ç¬¬ä¸€è¡Œï¼šå°†æ™®é€šå®¢æˆ·ç«¯çš„ç¡¬æ€§é™åˆ¶å’Œè½¯æ€§é™åˆ¶éƒ½è®¾ç½®ä¸º 0ï¼Œè¡¨ç¤ºä¸é™åˆ¶å®¢æˆ·ç«¯çš„è¾“å‡ºç¼“å†²åŒºå¤§å°</li><li>ç¬¬äºŒè¡Œï¼šå°†ä»æœåŠ¡å™¨å®¢æˆ·ç«¯çš„ç¡¬æ€§é™åˆ¶è®¾ç½®ä¸º 256MBï¼Œè½¯æ€§é™åˆ¶è®¾ç½®ä¸º 64MBï¼Œè½¯æ€§é™åˆ¶çš„æ—¶é•¿ä¸º 60 ç§’</li><li>ç¬¬ä¸‰è¡Œï¼šå°†æ‰§è¡Œå‘å¸ƒä¸è®¢é˜…åŠŸèƒ½çš„å®¢æˆ·ç«¯çš„ç¡¬æ€§é™åˆ¶è®¾ç½®ä¸º 32MBï¼Œè½¯æ€§é™åˆ¶è®¾ç½®ä¸º 8MBï¼Œè½¯æ€§é™åˆ¶çš„æ—¶é•¿ä¸º 60 ç§’</li></ul><hr><h3 id="æœåŠ¡å™¨-2" tabindex="-1"><a class="header-anchor" href="#æœåŠ¡å™¨-2" aria-hidden="true">#</a> æœåŠ¡å™¨</h3><h4 id="æ‰§è¡Œæµç¨‹" tabindex="-1"><a class="header-anchor" href="#æ‰§è¡Œæµç¨‹" aria-hidden="true">#</a> æ‰§è¡Œæµç¨‹</h4><p>Redis æœåŠ¡å™¨ä¸å¤šä¸ªå®¢æˆ·ç«¯å»ºç«‹ç½‘ç»œè¿æ¥ï¼Œå¤„ç†å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤è¯·æ±‚ï¼Œåœ¨æ•°æ®åº“ä¸­ä¿å­˜å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤æ‰€äº§ç”Ÿçš„æ•°æ®ï¼Œå¹¶é€šè¿‡èµ„æºç®¡ç†æ¥ç»´æŒæœåŠ¡å™¨è‡ªèº«çš„è¿è½¬ï¼Œæ‰€ä»¥ä¸€ä¸ªå‘½ä»¤è¯·æ±‚ä»å‘é€åˆ°è·å¾—å›å¤çš„è¿‡ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éœ€è¦å®Œæˆä¸€ç³»åˆ—æ“ä½œ</p><h5 id="å‘½ä»¤è¯·æ±‚" tabindex="-1"><a class="header-anchor" href="#å‘½ä»¤è¯·æ±‚" aria-hidden="true">#</a> å‘½ä»¤è¯·æ±‚</h5><p>Redis æœåŠ¡å™¨çš„å‘½ä»¤è¯·æ±‚æ¥è‡ª Redis å®¢æˆ·ç«¯ï¼Œå½“ç”¨æˆ·åœ¨å®¢æˆ·ç«¯ä¸­é”®å…¥ä¸€ä¸ªå‘½ä»¤è¯·æ±‚æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šå°†è¿™ä¸ªå‘½ä»¤è¯·æ±‚è½¬æ¢æˆåè®®æ ¼å¼ï¼Œé€šè¿‡è¿æ¥åˆ°æœåŠ¡å™¨çš„å¥—æ¥å­—ï¼Œå°†åè®®æ ¼å¼çš„å‘½ä»¤è¯·æ±‚å‘é€ç»™æœåŠ¡å™¨</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>SET KEY VALUE -<span class="token operator">&gt;</span>	<span class="token comment"># å‘½ä»¤</span>
*3<span class="token punctuation">\</span>r<span class="token punctuation">\</span>nS3<span class="token punctuation">\</span>r<span class="token punctuation">\</span>nSET<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$3</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nKEY<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$5</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nVALUE<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n	<span class="token comment"># åè®®æ ¼å¼</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥å¥—æ¥å­—å› ä¸ºå®¢æˆ·ç«¯çš„å†™å…¥è€Œå˜å¾—å¯è¯»ï¼ŒæœåŠ¡å™¨è°ƒç”¨<strong>å‘½ä»¤è¯·æ±‚å¤„ç†å™¨</strong>æ¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ul><li>è¯»å–å¥—æ¥å­—ä¸­åè®®æ ¼å¼çš„å‘½ä»¤è¯·æ±‚ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°å®¢æˆ·ç«¯çŠ¶æ€çš„è¾“å…¥ç¼“å†²åŒºé‡Œé¢</li><li>å¯¹è¾“å…¥ç¼“å†²åŒºä¸­çš„å‘½ä»¤è¯·æ±‚è¿›è¡Œåˆ†æï¼Œæå–å‡ºå‘½ä»¤è¯·æ±‚ä¸­åŒ…å«çš„å‘½ä»¤å‚æ•°ä»¥åŠå‘½ä»¤å‚æ•°çš„ä¸ªæ•°ï¼Œç„¶ååˆ†åˆ«å°†å‚æ•°å’Œå‚æ•°ä¸ªæ•°ä¿å­˜åˆ°å®¢æˆ·ç«¯çŠ¶æ€çš„ argv å±æ€§å’Œ argc å±æ€§é‡Œ</li><li>è°ƒç”¨å‘½ä»¤æ‰§è¡Œå™¨ï¼Œæ‰§è¡Œå®¢æˆ·ç«¯æŒ‡å®šçš„å‘½ä»¤</li></ul><p>æœ€åå®¢æˆ·ç«¯æ¥æ”¶åˆ°åè®®æ ¼å¼çš„å‘½ä»¤å›å¤ä¹‹åï¼Œä¼šå°†è¿™äº›å›å¤è½¬æ¢æˆç”¨æˆ·å¯è¯»çš„æ ¼å¼æ‰“å°ç»™ç”¨æˆ·è§‚çœ‹ï¼Œè‡³æ­¤æ•´ä½“æµç¨‹ç»“æŸ</p><hr><h5 id="å‘½ä»¤æ‰§è¡Œ" tabindex="-1"><a class="header-anchor" href="#å‘½ä»¤æ‰§è¡Œ" aria-hidden="true">#</a> å‘½ä»¤æ‰§è¡Œ</h5><p>å‘½ä»¤æ‰§è¡Œå™¨å¼€å§‹å¯¹å‘½ä»¤æ“ä½œï¼š</p><ul><li><p>æŸ¥æ‰¾å‘½ä»¤ï¼šé¦–å…ˆæ ¹æ®å®¢æˆ·ç«¯çŠ¶æ€çš„ argv[0] å‚æ•°ï¼Œåœ¨<strong>å‘½ä»¤è¡¨ (command table)</strong> ä¸­æŸ¥æ‰¾å‚æ•°æ‰€æŒ‡å®šçš„å‘½ä»¤ï¼Œå¹¶å°†æ‰¾åˆ°çš„å‘½ä»¤ä¿å­˜åˆ°å®¢æˆ·ç«¯çŠ¶æ€çš„ cmd å±æ€§é‡Œé¢ï¼Œæ˜¯ä¸€ä¸ª redisCommand ç»“æ„</p><p>å‘½ä»¤æŸ¥æ‰¾ç®—æ³•ä¸å­—æ¯çš„å¤§å°å†™æ— å…³ï¼Œæ‰€ä»¥å‘½ä»¤åå­—çš„å¤§å°å†™ä¸å½±å“å‘½ä»¤è¡¨çš„æŸ¥æ‰¾ç»“æœ</p></li><li><p>æ‰§è¡Œé¢„å¤‡æ“ä½œï¼š</p><ul><li>æ£€æŸ¥å®¢æˆ·ç«¯çŠ¶æ€çš„ cmd æŒ‡é’ˆæ˜¯å¦æŒ‡å‘ NULLï¼Œæ ¹æ® redisCommand æ£€æŸ¥è¯·æ±‚å‚æ•°çš„æ•°é‡æ˜¯å¦æ­£ç¡®</li><li>æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦é€šè¿‡èº«ä»½éªŒè¯</li><li>å¦‚æœæœåŠ¡å™¨æ‰“å¼€äº† maxmemory åŠŸèƒ½ï¼Œæ‰§è¡Œå‘½ä»¤ä¹‹å‰è¦å…ˆæ£€æŸ¥æœåŠ¡å™¨çš„å†…å­˜å ç”¨ï¼Œåœ¨æœ‰éœ€è¦æ—¶è¿›è¡Œå†…å­˜å›æ”¶ï¼ˆ<strong>é€å‡ºç®—æ³•</strong>ï¼‰</li><li>å¦‚æœæœåŠ¡å™¨ä¸Šä¸€æ¬¡æ‰§è¡Œ BGSAVE å‘½ä»¤å‡ºé”™ï¼Œå¹¶ä¸”æœåŠ¡å™¨æ‰“å¼€äº† stop-writes-on-bgsave-error åŠŸèƒ½ï¼Œé‚£ä¹ˆå¦‚æœæœ¬æ¬¡æ‰§è¡Œçš„æ˜¯å†™å‘½ä»¤ï¼ŒæœåŠ¡ä¼šæ‹’ç»æ‰§è¡Œï¼Œå¹¶è¿”å›é”™è¯¯</li><li>å¦‚æœå®¢æˆ·ç«¯å½“å‰æ­£åœ¨ç”¨ SUBSCRIBE æˆ– PSUBSCRIBE å‘½ä»¤è®¢é˜…é¢‘é“ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šæ‹’ç»é™¤äº† SUBSCRIBEã€SUBSCRIBEã€ UNSUBSCRIBEã€PUNSUBSCRIBE ä¹‹å¤–çš„å…¶ä»–å‘½ä»¤</li><li>å¦‚æœæœåŠ¡å™¨æ­£åœ¨è¿›è¡Œè½½å…¥æ•°æ®ï¼Œåªæœ‰ sflags å¸¦æœ‰ 1 æ ‡è¯†ï¼ˆæ¯”å¦‚ INFOã€SHUTDOWNã€PUBLISHç­‰ï¼‰çš„å‘½ä»¤æ‰ä¼šè¢«æ‰§è¡Œ</li><li>å¦‚æœæœåŠ¡å™¨æ‰§è¡Œ Lua è„šæœ¬è€Œè¶…æ—¶å¹¶è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œé‚£ä¹ˆåªä¼šæ‰§è¡Œå®¢æˆ·ç«¯å‘æ¥çš„ SHUTDOWN nosave å’Œ SCRIPT KILL å‘½ä»¤</li><li>å¦‚æœå®¢æˆ·ç«¯æ­£åœ¨æ‰§è¡Œäº‹åŠ¡ï¼Œé‚£ä¹ˆæœåŠ¡å™¨åªä¼šæ‰§è¡Œå®¢æˆ·ç«¯å‘æ¥çš„ EXECã€DISCARDã€MULTIã€WATCH å››ä¸ªå‘½ä»¤ï¼Œå…¶ä»–å‘½ä»¤éƒ½ä¼šè¢«<strong>æ”¾è¿›äº‹åŠ¡é˜Ÿåˆ—</strong>ä¸­</li><li>å¦‚æœæœåŠ¡å™¨æ‰“å¼€äº†ç›‘è§†å™¨åŠŸèƒ½ï¼Œé‚£ä¹ˆä¼šå°†è¦æ‰§è¡Œçš„å‘½ä»¤å’Œå‚æ•°ç­‰ä¿¡æ¯å‘é€ç»™ç›‘è§†å™¨</li></ul></li><li><p>è°ƒç”¨å‘½ä»¤çš„å®ç°å‡½æ•°ï¼šè¢«è°ƒç”¨çš„å‡½æ•°ä¼šæ‰§è¡ŒæŒ‡å®šçš„æ“ä½œå¹¶äº§ç”Ÿç›¸åº”çš„å‘½ä»¤å›å¤ï¼Œå›å¤ä¼šè¢«ä¿å­˜åœ¨å®¢æˆ·ç«¯çŠ¶æ€çš„è¾“å‡ºç¼“å†²åŒºé‡Œé¢ï¼ˆbuf å’Œ reply å±æ€§ï¼‰ï¼Œç„¶åå®ç°å‡½æ•°è¿˜ä¼š<strong>ä¸ºå®¢æˆ·ç«¯çš„å¥—æ¥å­—å…³è”å‘½ä»¤å›å¤å¤„ç†å™¨</strong>ï¼Œè¿™ä¸ªå¤„ç†å™¨è´Ÿè´£å°†å‘½ä»¤å›å¤è¿”å›ç»™å®¢æˆ·ç«¯</p></li><li><p>æ‰§è¡Œåç»­å·¥ä½œï¼š</p><ul><li>å¦‚æœæœåŠ¡å™¨å¼€å¯äº†æ…¢æŸ¥è¯¢æ—¥å¿—åŠŸèƒ½ï¼Œé‚£ä¹ˆæ…¢æŸ¥è¯¢æ—¥å¿—æ¨¡å—ä¼šæ£€æŸ¥æ˜¯å¦éœ€è¦ä¸ºåˆšåˆšæ‰§è¡Œå®Œçš„å‘½ä»¤è¯·æ±‚æ·»åŠ ä¸€æ¡æ–°çš„æ…¢æŸ¥è¯¢æ—¥å¿—</li><li>æ ¹æ®æ‰§è¡Œå‘½ä»¤æ‰€è€—è´¹çš„æ—¶é•¿ï¼Œæ›´æ–°å‘½ä»¤çš„ redisCommand ç»“æ„çš„ milliseconds å±æ€§ï¼Œå¹¶å°†å‘½ä»¤ calls è®¡æ•°å™¨çš„å€¼å¢ä¸€</li><li>å¦‚æœæœåŠ¡å™¨å¼€å¯äº† AOF æŒä¹…åŒ–åŠŸèƒ½ï¼Œé‚£ä¹ˆ AOF æŒä¹…åŒ–æ¨¡å—ä¼šå°†æ‰§è¡Œçš„å‘½ä»¤è¯·æ±‚å†™å…¥åˆ° AOF ç¼“å†²åŒºé‡Œé¢</li><li>å¦‚æœæœ‰å…¶ä»–ä»æœåŠ¡å™¨æ­£åœ¨å¤åˆ¶å½“å‰è¿™ä¸ªæœåŠ¡å™¨ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šå°†æ‰§è¡Œçš„å‘½ä»¤ä¼ æ’­ç»™æ‰€æœ‰ä»æœåŠ¡å™¨</li></ul></li><li><p>å°†å‘½ä»¤å›å¤å‘é€ç»™å®¢æˆ·ç«¯ï¼šå®¢æˆ·ç«¯<strong>å¥—æ¥å­—å˜ä¸ºå¯å†™çŠ¶æ€</strong>æ—¶ï¼ŒæœåŠ¡å™¨å°±ä¼šæ‰§è¡Œå‘½ä»¤å›å¤å¤„ç†å™¨ï¼Œå°†å®¢æˆ·ç«¯è¾“å‡ºç¼“å†²åŒºä¸­çš„å‘½ä»¤å›å¤å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå‘é€å®Œæ¯•ä¹‹åå›å¤å¤„ç†å™¨ä¼šæ¸…ç©ºå®¢æˆ·ç«¯çŠ¶æ€çš„è¾“å‡ºç¼“å†²åŒºï¼Œä¸ºå¤„ç†ä¸‹ä¸€ä¸ªå‘½ä»¤è¯·æ±‚åšå¥½å‡†å¤‡</p></li></ul><hr><h5 id="command" tabindex="-1"><a class="header-anchor" href="#command" aria-hidden="true">#</a> Command</h5><p>æ¯ä¸ª redisCommand ç»“æ„è®°å½•äº†ä¸€ä¸ªRedis å‘½ä»¤çš„å®ç°ä¿¡æ¯ï¼Œä¸»è¦å±æ€§</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisCommand</span> <span class="token punctuation">{</span>
    <span class="token comment">// å‘½ä»¤çš„åå­—ï¼Œæ¯”å¦‚&quot;set&quot;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    
    <span class="token comment">// å‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘å‘½ä»¤çš„å®ç°å‡½æ•°ï¼Œæ¯”å¦‚setCommand</span>
    <span class="token comment">// redisCommandProc ç±»å‹çš„å®šä¹‰ä¸º typedef void redisCommandProc(redisClient *c)</span>
    redisCommandProc <span class="token operator">*</span>proc<span class="token punctuation">;</span>
    
    <span class="token comment">// å‘½ä»¤å‚æ•°çš„ä¸ªæ•°ï¼Œç”¨äºæ£€æŸ¥å‘½ä»¤è¯·æ±‚çš„æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚å¦‚æœè¿™ä¸ªå€¼ä¸ºè´Ÿæ•°-N, é‚£ä¹ˆè¡¨ç¤ºå‚æ•°çš„æ•°é‡å¤§äºç­‰äºNã€‚</span>
    <span class="token comment">// æ³¨æ„å‘½ä»¤çš„åå­—æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå‚æ•°ï¼Œæ¯”å¦‚ SET msg &quot;hello&quot;ï¼Œå‘½ä»¤çš„å‚æ•°æ˜¯&quot;SET&quot;ã€&quot;msg&quot;ã€&quot;hello&quot; ä¸‰ä¸ª</span>
	<span class="token keyword">int</span> arity<span class="token punctuation">;</span>
    
    <span class="token comment">// å­—ç¬¦ä¸²å½¢å¼çš„æ ‡è¯†å€¼ï¼Œè¿™ä¸ªå€¼è®°å½•äº†å‘½ä»¤çš„å±æ€§ï¼Œï¼Œ</span>
    <span class="token comment">// æ¯”å¦‚è¿™ä¸ªå‘½ä»¤æ˜¯å†™å‘½ä»¤è¿˜æ˜¯è¯»å‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤æ˜¯å¦å…è®¸åœ¨è½½å…¥æ•°æ®æ—¶ä½¿ç”¨ï¼Œæ˜¯å¦å…è®¸åœ¨Luaè„šæœ¬ä¸­ä½¿ç”¨ç­‰ç­‰</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>sflags<span class="token punctuation">;</span>
    
    <span class="token comment">// å¯¹sflagsæ ‡è¯†è¿›è¡Œåˆ†æå¾—å‡ºçš„äºŒè¿›åˆ¶æ ‡è¯†ï¼Œç”±ç¨‹åºè‡ªåŠ¨ç”Ÿæˆã€‚æœåŠ¡å™¨å¯¹å‘½ä»¤æ ‡è¯†è¿›è¡Œæ£€æŸ¥æ—¶ä½¿ç”¨çš„éƒ½æ˜¯ flags å±æ€§</span>
    <span class="token comment">// è€Œä¸æ˜¯sflagså±æ€§ï¼Œå› ä¸ºå¯¹äºŒè¿›åˆ¶æ ‡è¯†çš„æ£€æŸ¥å¯ä»¥æ–¹ä¾¿åœ°é€šè¿‡&amp; ^ ~ ç­‰æ“ä½œæ¥å®Œæˆ</span>
    <span class="token keyword">int</span> flags<span class="token punctuation">;</span>
    
    <span class="token comment">// æœåŠ¡å™¨æ€»å…±æ‰§è¡Œäº†å¤šå°‘æ¬¡è¿™ä¸ªå‘½ä»¤</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> calls<span class="token punctuation">;</span>
    
    <span class="token comment">// æœåŠ¡å™¨æ‰§è¡Œè¿™ä¸ªå‘½ä»¤æ‰€è€—è´¹çš„æ€»æ—¶é•¿</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> milliseconds<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="servercron" tabindex="-1"><a class="header-anchor" href="#servercron" aria-hidden="true">#</a> serverCron</h4><h5 id="åŸºæœ¬ä»‹ç»-3" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä»‹ç»-3" aria-hidden="true">#</a> åŸºæœ¬ä»‹ç»</h5><p>Redis æœåŠ¡å™¨ä»¥å‘¨æœŸæ€§äº‹ä»¶çš„æ–¹å¼æ¥è¿è¡Œ serverCron å‡½æ•°ï¼ŒæœåŠ¡å™¨åˆå§‹åŒ–æ—¶è¯»å–é…ç½® server.hz çš„å€¼ï¼Œé»˜è®¤ä¸º 10ï¼Œä»£è¡¨æ¯ç§’é’Ÿæ‰§è¡Œ 10 æ¬¡ï¼Œå³<strong>æ¯éš” 100 æ¯«ç§’æ‰§è¡Œä¸€æ¬¡</strong>ï¼Œæ‰§è¡ŒæŒ‡ä»¤ info server å¯ä»¥æŸ¥çœ‹</p><p>serverCron å‡½æ•°è´Ÿè´£å®šæœŸå¯¹è‡ªèº«çš„èµ„æºå’ŒçŠ¶æ€è¿›è¡Œæ£€æŸ¥å’Œè°ƒæ•´ï¼Œä»è€Œç¡®ä¿æœåŠ¡å™¨å¯ä»¥é•¿æœŸã€ç¨³å®šåœ°è¿è¡Œ</p><ul><li>æ›´æ–°æœåŠ¡å™¨çš„å„ç±»ç»Ÿè®¡ä¿¡æ¯ï¼Œæ¯”å¦‚æ—¶é—´ã€å†…å­˜å ç”¨ã€ æ•°æ®åº“å ç”¨æƒ…å†µç­‰</li><li>æ¸…ç†æ•°æ®åº“ä¸­çš„è¿‡æœŸé”®å€¼å¯¹</li><li>å…³é—­å’Œæ¸…ç†è¿æ¥å¤±æ•ˆçš„å®¢æˆ·ç«¯</li><li>è¿›è¡Œ AOF æˆ– RDB æŒä¹…åŒ–æ“ä½œ</li><li>å¦‚æœæœåŠ¡å™¨æ˜¯ä¸»æœåŠ¡å™¨ï¼Œé‚£ä¹ˆå¯¹ä»æœåŠ¡å™¨è¿›è¡Œå®šæœŸåŒæ­¥</li><li>å¦‚æœå¤„äºé›†ç¾¤æ¨¡å¼ï¼Œå¯¹é›†ç¾¤è¿›è¡Œå®šæœŸåŒæ­¥å’Œè¿æ¥æµ‹è¯•</li></ul><hr><h5 id="æ—¶é—´ç¼“å­˜" tabindex="-1"><a class="header-anchor" href="#æ—¶é—´ç¼“å­˜" aria-hidden="true">#</a> æ—¶é—´ç¼“å­˜</h5><p>Redis æœåŠ¡å™¨ä¸­æœ‰å¾ˆå¤šåŠŸèƒ½éœ€è¦è·å–ç³»ç»Ÿçš„å½“å‰æ—¶é—´ï¼Œè€Œæ¯æ¬¡è·å–ç³»ç»Ÿçš„å½“å‰æ—¶é—´éƒ½éœ€è¦æ‰§è¡Œä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œä¸ºäº†å‡å°‘ç³»ç»Ÿè°ƒç”¨çš„æ‰§è¡Œæ¬¡æ•°ï¼ŒæœåŠ¡å™¨çŠ¶æ€ä¸­çš„ unixtime å±æ€§å’Œ mstime å±æ€§è¢«ç”¨ä½œå½“å‰æ—¶é—´çš„ç¼“å­˜</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä¿å­˜äº†ç§’çº§ç²¾åº¦çš„ç³»ç»Ÿå½“å‰UNIXæ—¶é—´æˆ³</span>
    <span class="token class-name">time_t</span> unixtime<span class="token punctuation">;</span>
	<span class="token comment">// ä¿å­˜äº†æ¯«ç§’çº§ç²¾åº¦çš„ç³»ç»Ÿå½“å‰UNIXæ—¶é—´æˆ³ </span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> mstime<span class="token punctuation">;</span>
    
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>serverCron å‡½æ•°é»˜è®¤ä»¥æ¯ 100 æ¯«ç§’ä¸€æ¬¡çš„é¢‘ç‡æ›´æ–°ä¸¤ä¸ªå±æ€§ï¼Œæ‰€ä»¥å±æ€§è®°å½•çš„æ—¶é—´çš„ç²¾ç¡®åº¦å¹¶ä¸é«˜</p><ul><li>æœåŠ¡å™¨åªä¼šåœ¨æ‰“å°æ—¥å¿—ã€æ›´æ–°æœåŠ¡å™¨çš„ LRU æ—¶é’Ÿã€å†³å®šæ˜¯å¦æ‰§è¡ŒæŒä¹…åŒ–ä»»åŠ¡ã€è®¡ç®—æœåŠ¡å™¨ä¸Šçº¿æ—¶é—´ï¼ˆuptimeï¼‰è¿™ç±»å¯¹æ—¶é—´ç²¾ç¡®åº¦è¦æ±‚ä¸é«˜çš„åŠŸèƒ½ä¸Š</li><li>å¯¹äºä¸ºé”®è®¾ç½®è¿‡æœŸæ—¶é—´ã€æ·»åŠ æ…¢æŸ¥è¯¢æ—¥å¿—è¿™ç§éœ€è¦é«˜ç²¾ç¡®åº¦æ—¶é—´çš„åŠŸèƒ½æ¥è¯´ï¼ŒæœåŠ¡å™¨è¿˜æ˜¯ä¼šå†æ¬¡æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œä»è€Œè·å¾—æœ€å‡†ç¡®çš„ç³»ç»Ÿå½“å‰æ—¶é—´</li></ul><hr><h5 id="lru-æ—¶é’Ÿ" tabindex="-1"><a class="header-anchor" href="#lru-æ—¶é’Ÿ" aria-hidden="true">#</a> LRU æ—¶é’Ÿ</h5><p>æœåŠ¡å™¨çŠ¶æ€ä¸­çš„ lruclock å±æ€§ä¿å­˜äº†æœåŠ¡å™¨çš„ LRU æ—¶é’Ÿ</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    <span class="token comment">// é»˜è®¤æ¯10ç§’æ›´æ–°ä¸€æ¬¡çš„æ—¶é’Ÿç¼“å­˜ï¼Œç”¨äºè®¡ç®—é”®çš„ç©ºè½¬(idle)æ—¶é•¿ã€‚ </span>
    <span class="token keyword">unsigned</span> lruclock<span class="token operator">:</span><span class="token number">22</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯ä¸ª Redis å¯¹è±¡éƒ½ä¼šæœ‰ä¸€ä¸ª lru å±æ€§ï¼Œ è¿™ä¸ª lru å±æ€§ä¿å­˜äº†å¯¹è±¡æœ€åä¸€æ¬¡è¢«å‘½ä»¤è®¿é—®çš„æ—¶é—´</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisObiect</span> <span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> lru<span class="token operator">:</span><span class="token number">22</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> robj<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“æœåŠ¡å™¨è¦è®¡ç®—ä¸€ä¸ªæ•°æ®åº“é”®çš„ç©ºè½¬æ—¶é—´ï¼ˆå³æ•°æ®åº“é”®å¯¹åº”çš„å€¼å¯¹è±¡çš„ç©ºè½¬æ—¶é—´ï¼‰ï¼Œç¨‹åºä¼šç”¨æœåŠ¡å™¨çš„ lruclock å±æ€§è®°å½•çš„æ—¶é—´å‡å»å¯¹è±¡çš„ lru å±æ€§è®°å½•çš„æ—¶é—´</p><p>serverCron å‡½æ•°é»˜è®¤ä»¥æ¯ 100 æ¯«ç§’ä¸€æ¬¡çš„é¢‘ç‡æ›´æ–°è¿™ä¸ªå±æ€§ï¼Œæ‰€ä»¥å¾—å‡ºçš„ç©ºè½¬æ—¶é—´ä¹Ÿæ˜¯æ¨¡ç³Šçš„</p><hr><h5 id="å‘½ä»¤æ¬¡æ•°" tabindex="-1"><a class="header-anchor" href="#å‘½ä»¤æ¬¡æ•°" aria-hidden="true">#</a> å‘½ä»¤æ¬¡æ•°</h5><p>serverCron ä¸­çš„ trackOperationsPerSecond å‡½æ•°ä»¥æ¯ 100 æ¯«ç§’ä¸€æ¬¡çš„é¢‘ç‡æ‰§è¡Œï¼Œå‡½æ•°åŠŸèƒ½æ˜¯ä»¥<strong>æŠ½æ ·è®¡ç®—</strong>çš„æ–¹å¼ï¼Œä¼°ç®—å¹¶è®°å½•æœåŠ¡å™¨åœ¨æœ€è¿‘ä¸€ç§’é’Ÿå¤„ç†çš„å‘½ä»¤è¯·æ±‚æ•°é‡ï¼Œè¿™ä¸ªå€¼å¯ä»¥é€šè¿‡ INFO status å‘½ä»¤çš„ instantaneous_ops_per_sec åŸŸæŸ¥çœ‹ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis<span class="token operator">&gt;</span> INFO stats
<span class="token comment"># Stats </span>
instantaneous_ops_per_sec:6
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ ¹æ®ä¸Šä¸€æ¬¡æŠ½æ ·æ—¶é—´ ops_sec_last_sample_time å’Œå½“å‰ç³»ç»Ÿæ—¶é—´ï¼Œä»¥åŠä¸Šä¸€æ¬¡å·²æ‰§è¡Œçš„å‘½ä»¤æ•° ops_sec_last_sample_ops å’ŒæœåŠ¡å™¨å½“å‰å·²ç»æ‰§è¡Œçš„å‘½ä»¤æ•°ï¼Œè®¡ç®—å‡ºä¸¤æ¬¡å‡½æ•°è°ƒç”¨æœŸé—´ï¼ŒæœåŠ¡å™¨å¹³å‡æ¯æ¯«ç§’å¤„ç†äº†å¤šå°‘ä¸ªå‘½ä»¤è¯·æ±‚ï¼Œè¯¥å€¼ä¹˜ä»¥ 1000 å¾—åˆ°æ¯ç§’å†…çš„æ‰§è¡Œå‘½ä»¤çš„ä¼°è®¡å€¼ï¼Œæ”¾å…¥ ops_sec_samples ç¯å½¢æ•°ç»„é‡Œ</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä¸Šä¸€æ¬¡è¿›è¡ŒæŠ½æ ·çš„æ—¶é—´</span>
	<span class="token keyword">long</span> <span class="token keyword">long</span> ops_sec_last_sample_time<span class="token punctuation">;</span>
    <span class="token comment">// ä¸Šä¸€æ¬¡æŠ½æ ·æ—¶ï¼ŒæœåŠ¡å™¨å·²æ‰§è¡Œå‘½ä»¤çš„æ•°é‡ </span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> ops_sec_last_sample_ops<span class="token punctuation">;</span>
    <span class="token comment">// REDIS_OPS_SEC_SAMPLES å¤§å°ï¼ˆé»˜è®¤å€¼ä¸º16)çš„ç¯å½¢æ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸€é¡¹è®°å½•ä¸€æ¬¡çš„æŠ½æ ·ç»“æœ</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> ops_sec_samples<span class="token punctuation">[</span>REDIS_OPS_SEC_SAMPLES<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// ops_sec_samplesæ•°ç»„çš„ç´¢å¼•å€¼ï¼Œæ¯æ¬¡æŠ½æ ·åå°†å€¼è‡ªå¢ä¸€ï¼Œå€¼ä¸º16æ—¶é‡ç½®ä¸º0ï¼Œè®©æ•°ç»„æˆä¸ºä¸€ä¸ªç¯å½¢æ•°ç»„</span>
    <span class="token keyword">int</span> ops_sec_idx<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h5 id="å†…å­˜å³°å€¼" tabindex="-1"><a class="header-anchor" href="#å†…å­˜å³°å€¼" aria-hidden="true">#</a> å†…å­˜å³°å€¼</h5><p>æœåŠ¡å™¨çŠ¶æ€é‡Œçš„ stat_peak_memory å±æ€§è®°å½•äº†æœåŠ¡å™¨å†…å­˜å³°å€¼å¤§å°ï¼Œå¾ªç¯å‡½æ•°æ¯æ¬¡æ‰§è¡Œæ—¶éƒ½ä¼šæŸ¥çœ‹æœåŠ¡å™¨å½“å‰ä½¿ç”¨çš„å†…å­˜æ•°é‡ï¼Œå¹¶ä¸ stat_peak_memory ä¿å­˜çš„æ•°å€¼è¿›è¡Œæ¯”è¾ƒï¼Œè®¾ç½®ä¸ºè¾ƒå¤§çš„å€¼</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    <span class="token comment">// å·²ä½¿ç”¨å†…å­˜å³°å€¼</span>
    <span class="token class-name">size_t</span> stat_peak_memory<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>INFO memory å‘½ä»¤çš„ used_memory_peak å’Œ used_memory_peak_human ä¸¤ä¸ªåŸŸåˆ†åˆ«ä»¥ä¸¤ç§æ ¼å¼è®°å½•äº†æœåŠ¡å™¨çš„å†…å­˜å³°å€¼ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis<span class="token operator">&gt;</span> INFO memory 
<span class="token comment"># Memory </span>
<span class="token punctuation">..</span>.
used_memory_peak:501824 
used_memory_peak_human:490.06K
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h5 id="sigterm" tabindex="-1"><a class="header-anchor" href="#sigterm" aria-hidden="true">#</a> SIGTERM</h5><p>æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼ŒRedis ä¼šä¸ºæœåŠ¡å™¨è¿›ç¨‹çš„ SIGTERM ä¿¡å·å…³è”å¤„ç†å™¨ sigtermHandler å‡½æ•°ï¼Œè¯¥ä¿¡å·å¤„ç†å™¨è´Ÿè´£åœ¨æœåŠ¡å™¨æ¥åˆ° SIGTERM ä¿¡å·æ—¶ï¼Œæ‰“å¼€æœåŠ¡å™¨çŠ¶æ€çš„ shutdown_asap æ ‡è¯†</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    <span class="token comment">// å…³é—­æœåŠ¡å™¨çš„æ ‡è¯†ï¼šå€¼ä¸º1æ—¶å…³é—­æœåŠ¡å™¨ï¼Œå€¼ä¸º0æ—¶ä¸åšæ“ä½œ</span>
    <span class="token keyword">int</span> shutdown_asap<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯æ¬¡ serverCron å‡½æ•°è¿è¡Œæ—¶ï¼Œç¨‹åºéƒ½ä¼šå¯¹æœåŠ¡å™¨çŠ¶æ€çš„ shutdown_asap å±æ€§è¿›è¡Œæ£€æŸ¥ï¼Œå¹¶æ ¹æ®å±æ€§çš„å€¼å†³å®šæ˜¯å¦å…³é—­æœåŠ¡å™¨</p><p>æœåŠ¡å™¨åœ¨æ¥åˆ° SIGTERM ä¿¡å·ä¹‹åï¼Œå…³é—­æœåŠ¡å™¨å¹¶æ‰“å°ç›¸å…³æ—¥å¿—çš„è¿‡ç¨‹ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span><span class="token number">6794</span> <span class="token operator">|</span> signal handler<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">1384435690</span><span class="token punctuation">)</span> Received SIGTERM, scheduling <span class="token function">shutdown</span> <span class="token punctuation">..</span>. 
<span class="token punctuation">[</span><span class="token number">6794</span><span class="token punctuation">]</span> <span class="token number">14</span> Nov <span class="token number">21</span>:28:10.108 <span class="token comment"># User requested shutdown ... </span>
<span class="token punctuation">[</span><span class="token number">6794</span><span class="token punctuation">]</span> <span class="token number">14</span> Nov <span class="token number">21</span>:28:10.108 * Saving the final RDB snapshot before exiting. 
<span class="token punctuation">[</span><span class="token number">6794</span><span class="token punctuation">)</span> <span class="token number">14</span> Nov <span class="token number">21</span>:28:10.161 * DB saved on disk 
<span class="token punctuation">[</span><span class="token number">6794</span><span class="token punctuation">)</span> <span class="token number">14</span> Nov <span class="token number">21</span>:28:10.161 <span class="token comment"># Redisis now ready to exit, bye bye ... </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h5 id="ç®¡ç†èµ„æº" tabindex="-1"><a class="header-anchor" href="#ç®¡ç†èµ„æº" aria-hidden="true">#</a> ç®¡ç†èµ„æº</h5><p>serverCron å‡½æ•°æ¯æ¬¡æ‰§è¡Œéƒ½ä¼šè°ƒç”¨ clientsCron å’Œ databasesCron å‡½æ•°ï¼Œè¿›è¡Œç®¡ç†å®¢æˆ·ç«¯èµ„æºå’Œæ•°æ®åº“èµ„æº</p><p>clientsCron å‡½æ•°å¯¹ä¸€å®šæ•°é‡çš„å®¢æˆ·ç«¯è¿›è¡Œä»¥ä¸‹ä¸¤ä¸ªæ£€æŸ¥ï¼š</p><ul><li>å¦‚æœå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥å·³ç»è¶…æ—¶ï¼ˆå¾ˆé•¿ä¸€æ®µæ—¶é—´å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½æ²¡æœ‰äº’åŠ¨ï¼‰ï¼Œé‚£ä¹ˆç¨‹åºé‡Šæ”¾è¿™ä¸ªå®¢æˆ·ç«¯</li><li>å¦‚æœå®¢æˆ·ç«¯åœ¨ä¸Šä¸€æ¬¡æ‰§è¡Œå‘½ä»¤è¯·æ±‚ä¹‹åï¼Œè¾“å…¥ç¼“å†²åŒºçš„å¤§å°è¶…è¿‡äº†ä¸€å®šçš„é•¿åº¦ï¼Œé‚£ä¹ˆç¨‹åºä¼šé‡Šæ”¾å®¢æˆ·ç«¯å½“å‰çš„è¾“å…¥ç¼“å†²åŒºï¼Œå¹¶é‡æ–°åˆ›å»ºä¸€ä¸ªé»˜è®¤å¤§å°çš„è¾“å…¥ç¼“å†²åŒºï¼Œä»è€Œé˜²æ­¢å®¢æˆ·ç«¯çš„è¾“å…¥ç¼“å†²åŒºè€—è´¹äº†è¿‡å¤šçš„å†…å­˜</li></ul><p>databasesCron å‡½æ•°ä¼šå¯¹æœåŠ¡å™¨ä¸­çš„ä¸€éƒ¨åˆ†æ•°æ®åº“è¿›è¡Œæ£€æŸ¥ï¼Œåˆ é™¤å…¶ä¸­çš„è¿‡æœŸé”®ï¼Œå¹¶åœ¨æœ‰éœ€è¦æ—¶å¯¹å­—å…¸è¿›è¡Œæ”¶ç¼©æ“ä½œ</p><hr><h5 id="æŒä¹…çŠ¶æ€" tabindex="-1"><a class="header-anchor" href="#æŒä¹…çŠ¶æ€" aria-hidden="true">#</a> æŒä¹…çŠ¶æ€</h5><p>æœåŠ¡å™¨çŠ¶æ€ä¸­è®°å½•æ‰§è¡Œ BGSAVE å‘½ä»¤å’Œ BGREWRITEAOF å‘½ä»¤çš„å­è¿›ç¨‹çš„ ID</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    <span class="token comment">// è®°å½•æ‰§è¡ŒBGSAVEå‘½ä»¤çš„å­è¿›ç¨‹çš„IDï¼Œå¦‚æœæœåŠ¡å™¨æ²¡æœ‰åœ¨æ‰§è¡ŒBGSAVEï¼Œé‚£ä¹ˆè¿™ä¸ªå±æ€§çš„å€¼ä¸º-1</span>
    <span class="token class-name">pid_t</span> rdb_child_pid<span class="token punctuation">;</span>
    <span class="token comment">// è®°å½•æ‰§è¡ŒBGREWRITEAOFå‘½ä»¤çš„å­è¿›ç¨‹çš„IDï¼Œå¦‚æœæœåŠ¡å™¨æ²¡æœ‰åœ¨æ‰§è¡Œé‚£ä¹ˆè¿™ä¸ªå±æ€§çš„å€¼ä¸º-1</span>
    <span class="token class-name">pid_t</span> aof_child_pid
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>serverCron å‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¼šæ£€æŸ¥ä¸¤ä¸ªå±æ€§çš„å€¼ï¼Œåªè¦å…¶ä¸­ä¸€ä¸ªå±æ€§çš„å€¼ä¸ä¸º -1ï¼Œç¨‹åºå°±ä¼šæ‰§è¡Œä¸€æ¬¡ wait3 å‡½æ•°ï¼Œæ£€æŸ¥å­è¿›ç¨‹æ˜¯å¦æœ‰ä¿¡å·å‘æ¥æœåŠ¡å™¨è¿›ç¨‹ï¼š</p><ul><li>å¦‚æœæœ‰ä¿¡å·åˆ°è¾¾ï¼Œé‚£ä¹ˆè¡¨ç¤ºæ–°çš„ RDB æ–‡ä»¶å·²ç»ç”Ÿæˆæˆ–è€… AOF é‡å†™å®Œæ¯•ï¼ŒæœåŠ¡å™¨éœ€è¦è¿›è¡Œç›¸åº”å‘½ä»¤çš„åç»­æ“ä½œï¼Œæ¯”å¦‚ç”¨æ–°çš„ RDB æ–‡ä»¶æ›¿æ¢ç°æœ‰çš„ RDB æ–‡ä»¶ï¼Œç”¨é‡å†™åçš„ AOF æ–‡ä»¶æ›¿æ¢ç°æœ‰çš„ AOF æ–‡ä»¶</li><li>å¦‚æœæ²¡æœ‰ä¿¡å·åˆ°è¾¾ï¼Œé‚£ä¹ˆè¡¨ç¤ºæŒä¹…åŒ–æ“ä½œæœªå®Œæˆï¼Œç¨‹åºä¸åšåŠ¨ä½œ</li></ul><p>å¦‚æœä¸¤ä¸ªå±æ€§çš„å€¼éƒ½ä¸º -1ï¼Œè¡¨ç¤ºæœåŠ¡å™¨æ²¡æœ‰è¿›è¡ŒæŒä¹…åŒ–æ“ä½œ</p><ul><li><p>æŸ¥çœ‹æ˜¯å¦æœ‰ BGREWRITEAOF è¢«å»¶è¿Ÿï¼Œç„¶åæ‰§è¡Œ AOF åå°é‡å†™</p></li><li><p>æŸ¥çœ‹æœåŠ¡å™¨çš„è‡ªåŠ¨ä¿å­˜æ¡ä»¶æ˜¯å¦å·²ç»è¢«æ»¡è¶³ï¼Œå¹¶ä¸”æœåŠ¡å™¨æ²¡æœ‰åœ¨è¿›è¡ŒæŒä¹…åŒ–ï¼Œå°±å¼€å§‹ä¸€æ¬¡æ–°çš„ BGSAVE æ“ä½œ</p><p>å› ä¸ºæ¡ä»¶ 1 å¯èƒ½ä¼šå¼•å‘ä¸€æ¬¡ AOFï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªæ£€æŸ¥ä¸­ä¼šå†æ¬¡ç¡®è®¤æœåŠ¡å™¨æ˜¯å¦å·²ç»åœ¨æ‰§è¡ŒæŒä¹…åŒ–æ“ä½œ</p></li><li><p>æ£€æŸ¥æœåŠ¡å™¨è®¾ç½®çš„ AOF é‡å†™æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œæ¡ä»¶æ»¡è¶³å¹¶ä¸”æœåŠ¡å™¨æ²¡æœ‰è¿›è¡ŒæŒä¹…åŒ–ï¼Œå°±è¿›è¡Œä¸€æ¬¡ AOF é‡å†™</p></li></ul><p>å¦‚æœæœåŠ¡å™¨å¼€å¯äº† AOF æŒä¹…åŒ–åŠŸèƒ½ï¼Œå¹¶ä¸” AOF ç¼“å†²åŒºé‡Œè¿˜æœ‰å¾…å†™å…¥çš„æ•°æ®ï¼Œ é‚£ä¹ˆ serverCron å‡½æ•°ä¼šè°ƒç”¨ç›¸åº”çš„ç¨‹åºï¼Œå°† AOF ç¼“å†²åŒºä¸­çš„å†…å®¹å†™å…¥åˆ° AOF æ–‡ä»¶é‡Œ</p><hr><h5 id="å»¶è¿Ÿæ‰§è¡Œ" tabindex="-1"><a class="header-anchor" href="#å»¶è¿Ÿæ‰§è¡Œ" aria-hidden="true">#</a> å»¶è¿Ÿæ‰§è¡Œ</h5><p>åœ¨æœåŠ¡å™¨æ‰§è¡Œ BGSAVE å‘½ä»¤çš„æœŸé—´ï¼Œå¦‚æœå®¢æˆ·ç«¯å‘é€ BGREWRITEAOF å‘½ä»¤ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä¼šå°† BGREWRITEAOF å‘½ä»¤çš„æ‰§è¡Œæ—¶é—´å»¶è¿Ÿåˆ° BGSAVE å‘½ä»¤æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œç”¨æœåŠ¡å™¨çŠ¶æ€çš„ aof_rewrite_scheduled å±æ€§æ ‡è¯†å»¶è¿Ÿä¸å¦</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœå€¼ä¸º1ï¼Œé‚£ä¹ˆè¡¨ç¤ºæœ‰ BGREWRITEAOFå‘½ä»¤è¢«å»¶è¿Ÿäº†</span>
    <span class="token keyword">int</span> aof_rewrite_scheduled<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>serverCron å‡½æ•°ä¼šæ£€æŸ¥ BGSAVE æˆ–è€… BGREWRITEAOF å‘½ä»¤æ˜¯å¦æ­£åœ¨æ‰§è¡Œï¼Œå¦‚æœè¿™ä¸¤ä¸ªå‘½ä»¤éƒ½æ²¡åœ¨æ‰§è¡Œï¼Œå¹¶ä¸” aof_rewrite_scheduled å±æ€§çš„å€¼ä¸º 1ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°±ä¼šæ‰§è¡Œä¹‹å‰è¢«æ¨å»¶çš„ BGREWRITEAOF å‘½ä»¤</p><hr><h5 id="æ‰§è¡Œæ¬¡æ•°" tabindex="-1"><a class="header-anchor" href="#æ‰§è¡Œæ¬¡æ•°" aria-hidden="true">#</a> æ‰§è¡Œæ¬¡æ•°</h5><p>æœåŠ¡å™¨çŠ¶æ€çš„ cronloops å±æ€§è®°å½•äº† serverCron å‡½æ•°æ‰§è¡Œçš„æ¬¡æ•°</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    <span class="token comment">// serverCron å‡½æ•°æ¯æ‰§è¡Œä¸€æ¬¡ï¼Œè¿™ä¸ªå±æ€§çš„å€¼å°±å¢ 1</span>
    <span class="token keyword">int</span> cronloops<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h5 id="ç¼“å†²é™åˆ¶" tabindex="-1"><a class="header-anchor" href="#ç¼“å†²é™åˆ¶" aria-hidden="true">#</a> ç¼“å†²é™åˆ¶</h5><p>æœåŠ¡å™¨ä¼šå…³é—­é‚£äº›è¾“å…¥æˆ–è€…è¾“å‡º<strong>ç¼“å†²åŒºå¤§å°è¶…å‡ºé™åˆ¶</strong>çš„å®¢æˆ·ç«¯</p><hr><h4 id="åˆå§‹åŒ–" tabindex="-1"><a class="header-anchor" href="#åˆå§‹åŒ–" aria-hidden="true">#</a> åˆå§‹åŒ–</h4><h5 id="åˆå§‹ç»“æ„" tabindex="-1"><a class="header-anchor" href="#åˆå§‹ç»“æ„" aria-hidden="true">#</a> åˆå§‹ç»“æ„</h5><p>ä¸€ä¸ª Redis æœåŠ¡å™¨ä»å¯åŠ¨åˆ°èƒ½å¤Ÿæ¥å—å®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚ï¼Œéœ€è¦ç»è¿‡ä¸€ç³»åˆ—çš„åˆå§‹åŒ–å’Œè®¾ç½®è¿‡ç¨‹</p><p>ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºä¸€ä¸ª redisServer ç±»å‹çš„å®ä¾‹å˜é‡ server ä½œä¸ºæœåŠ¡å™¨çš„çŠ¶æ€ï¼Œå¹¶ä¸ºç»“æ„ä¸­çš„å„ä¸ªå±æ€§è®¾ç½®é»˜è®¤å€¼ï¼Œç”± initServerConfig å‡½æ•°è¿›è¡Œåˆå§‹åŒ–ä¸€èˆ¬å±æ€§ï¼š</p><ul><li>è®¾ç½®æœåŠ¡å™¨çš„è¿è¡Œ IDã€é»˜è®¤è¿è¡Œé¢‘ç‡ã€é»˜è®¤é…ç½®æ–‡ä»¶è·¯å¾„ã€é»˜è®¤ç«¯å£å·ã€é»˜è®¤ RDB æŒä¹…åŒ–æ¡ä»¶å’Œ AOF æŒä¹…åŒ–æ¡ä»¶</li><li>åˆå§‹åŒ–æœåŠ¡å™¨çš„ LRU æ—¶é’Ÿï¼Œåˆ›å»ºå‘½ä»¤è¡¨</li></ul><p>ç¬¬äºŒæ­¥ï¼šè½½å…¥é…ç½®é€‰é¡¹ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ç»™å®šé…ç½®å‚æ•°æˆ–è€…æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œå¯¹ server å˜é‡ç›¸å…³å±æ€§çš„é»˜è®¤å€¼è¿›è¡Œä¿®æ”¹</p><p>ç¬¬ä¸‰æ­¥ï¼šåˆå§‹åŒ–æœåŠ¡å™¨æ•°æ®ç»“æ„ï¼ˆé™¤äº†å‘½ä»¤è¡¨ä¹‹å¤–ï¼‰ï¼Œå› ä¸ºæœåŠ¡å™¨<strong>å¿…é¡»å…ˆè½½å…¥ç”¨æˆ·æŒ‡å®šçš„é…ç½®é€‰é¡¹æ‰èƒ½æ­£ç¡®åœ°å¯¹æ•°æ®ç»“æ„è¿›è¡Œåˆå§‹åŒ–</strong>ï¼Œæ‰€ä»¥è½½å…¥é…ç½®å®Œæˆåæ‰è¿›æ€§æ•°æ®ç»“æ„çš„åˆå§‹åŒ–ï¼ŒæœåŠ¡å™¨å°†è°ƒç”¨ initServer å‡½æ•°ï¼š</p><ul><li>server.clients é“¾è¡¨ï¼Œè®°å½•äº†çš„å®¢æˆ·ç«¯çš„çŠ¶æ€ç»“æ„ï¼›server.db æ•°ç»„ï¼ŒåŒ…å«äº†æœåŠ¡å™¨çš„æ‰€æœ‰æ•°æ®åº“</li><li>ç”¨äºä¿å­˜é¢‘é“è®¢é˜…ä¿¡æ¯çš„ server.pubsub_channels å­—å…¸ï¼Œ ä»¥åŠä¿å­˜æ¨¡å¼è®¢é˜…ä¿¡æ¯çš„ server.pubsub_patterns é“¾è¡¨</li><li>ç”¨äºæ‰§è¡Œ Lua è„šæœ¬çš„ Lua ç¯å¢ƒ server.lua</li><li>ä¿å­˜æ…¢æŸ¥è¯¢æ—¥å¿—çš„ server.slowlog å±æ€§</li></ul><p>initServer è¿˜è¿›è¡Œäº†éå¸¸é‡è¦çš„è®¾ç½®æ“ä½œï¼š</p><ul><li>ä¸ºæœåŠ¡å™¨è®¾ç½®è¿›ç¨‹ä¿¡å·å¤„ç†å™¨</li><li>åˆ›å»ºå…±äº«å¯¹è±¡ï¼ŒåŒ…å« OKã€ERRã€<strong>æ•´æ•° 1 åˆ° 10000 çš„å­—ç¬¦ä¸²å¯¹è±¡</strong>ç­‰</li><li><strong>æ‰“å¼€æœåŠ¡å™¨çš„ç›‘å¬ç«¯å£</strong></li><li><strong>ä¸º serverCron å‡½æ•°åˆ›å»ºæ—¶é—´äº‹ä»¶</strong>ï¼Œ ç­‰å¾…æœåŠ¡å™¨æ­£å¼è¿è¡Œæ—¶æ‰§è¡Œ serverCron å‡½æ•°</li><li>å¦‚æœ AOF æŒä¹…åŒ–åŠŸèƒ½å·²ç»æ‰“å¼€ï¼Œé‚£ä¹ˆæ‰“å¼€ç°æœ‰çš„ AOF æ–‡ä»¶ï¼Œå¦‚æœ AOF æ–‡ä»¶ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆåˆ›å»ºå¹¶æ‰“å¼€ä¸€ä¸ªæ–°çš„ AOF æ–‡ä»¶ ï¼Œä¸º AOF å†™å…¥åšå¥½å‡†å¤‡</li><li><strong>åˆå§‹åŒ–æœåŠ¡å™¨çš„åå° I/O æ¨¡å—</strong>ï¼ˆBIOï¼‰, ä¸ºå°†æ¥çš„ I/O æ“ä½œåšå¥½å‡†å¤‡</li></ul><p>å½“ initServer å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œ æœåŠ¡å™¨å°†ç”¨ ASCII å­—ç¬¦åœ¨æ—¥å¿—ä¸­æ‰“å°å‡º Redis çš„å›¾æ ‡ï¼Œ ä»¥åŠ Redis çš„ç‰ˆæœ¬å·ä¿¡æ¯</p><hr><h5 id="è¿˜åŸçŠ¶æ€" tabindex="-1"><a class="header-anchor" href="#è¿˜åŸçŠ¶æ€" aria-hidden="true">#</a> è¿˜åŸçŠ¶æ€</h5><p>åœ¨å®Œæˆäº†å¯¹æœåŠ¡å™¨çŠ¶æ€çš„åˆå§‹åŒ–ä¹‹åï¼ŒæœåŠ¡å™¨éœ€è¦è½½å…¥RDBæ–‡ä»¶æˆ–è€…AOF æ–‡ä»¶ï¼Œ å¹¶æ ¹æ®æ–‡ä»¶è®°å½•çš„å†…å®¹æ¥è¿˜åŸæœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€ï¼š</p><ul><li>å¦‚æœæœåŠ¡å™¨å¯ç”¨äº† AOF æŒä¹…åŒ–åŠŸèƒ½ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä½¿ç”¨ AOF æ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€</li><li>å¦‚æœæœåŠ¡å™¨æ²¡æœ‰å¯ç”¨ AOF æŒä¹…åŒ–åŠŸèƒ½ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ä½¿ç”¨ RDB æ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€</li></ul><p>å½“æœåŠ¡å™¨å®Œæˆæ•°æ®åº“çŠ¶æ€è¿˜åŸå·¥ä½œä¹‹åï¼ŒæœåŠ¡å™¨å°†åœ¨æ—¥å¿—ä¸­æ‰“å°å‡ºè½½å…¥æ–‡ä»¶å¹¶è¿˜åŸæ•°æ®åº“çŠ¶æ€æ‰€è€—è´¹çš„æ—¶é•¿</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span><span class="token number">7171</span><span class="token punctuation">]</span> <span class="token number">22</span> Nov <span class="token number">22</span>:43:49.084 * DB loaded from disk: <span class="token number">0.071</span> seconds 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><hr><h5 id="é©±åŠ¨å¾ªç¯" tabindex="-1"><a class="header-anchor" href="#é©±åŠ¨å¾ªç¯" aria-hidden="true">#</a> é©±åŠ¨å¾ªç¯</h5><p>åœ¨åˆå§‹åŒ–çš„æœ€åä¸€æ­¥ï¼ŒæœåŠ¡å™¨å°†æ‰“å°å‡ºä»¥ä¸‹æ—¥å¿—ï¼Œå¹¶å¼€å§‹<strong>æ‰§è¡ŒæœåŠ¡å™¨çš„äº‹ä»¶å¾ªç¯</strong>ï¼ˆloopï¼‰</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token punctuation">[</span><span class="token number">7171</span><span class="token punctuation">]</span> <span class="token number">22</span> Nov <span class="token number">22</span><span class="token operator">:</span><span class="token number">43</span><span class="token operator">:</span><span class="token number">49.084</span> <span class="token operator">*</span> The server is now ready to accept connections on pert <span class="token number">6379</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æœåŠ¡å™¨ç°åœ¨å¼€å§‹å¯ä»¥æ¥å—å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œå¹¶å¤„ç†å®¢æˆ·ç«¯å‘æ¥çš„å‘½ä»¤è¯·æ±‚äº†</p><hr><h3 id="æ…¢æ—¥å¿—" tabindex="-1"><a class="header-anchor" href="#æ…¢æ—¥å¿—" aria-hidden="true">#</a> æ…¢æ—¥å¿—</h3><h4 id="åŸºæœ¬ä»‹ç»-4" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä»‹ç»-4" aria-hidden="true">#</a> åŸºæœ¬ä»‹ç»</h4><p>Redis çš„æ…¢æŸ¥è¯¢æ—¥å¿—åŠŸèƒ½ç”¨äºè®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡ç»™å®šæ—¶é•¿çš„å‘½ä»¤è¯·æ±‚ï¼Œé€šè¿‡äº§ç”Ÿçš„æ—¥å¿—æ¥ç›‘è§†å’Œä¼˜åŒ–æŸ¥è¯¢é€Ÿåº¦</p><p>æœåŠ¡å™¨é…ç½®æœ‰ä¸¤ä¸ªå’Œæ…¢æŸ¥è¯¢æ—¥å¿—ç›¸å…³çš„é€‰é¡¹ï¼š</p><ul><li>slowlog-log-slower-than é€‰é¡¹æŒ‡å®šæ‰§è¡Œæ—¶é—´è¶…è¿‡å¤šå°‘å¾®ç§’çš„å‘½ä»¤è¯·æ±‚ä¼šè¢«è®°å½•åˆ°æ—¥å¿—ä¸Š</li><li>slowlog-max-len é€‰é¡¹æŒ‡å®šæœåŠ¡å™¨æœ€å¤šä¿å­˜å¤šå°‘æ¡æ…¢æŸ¥è¯¢æ—¥å¿—</li></ul><p>æœåŠ¡å™¨ä½¿ç”¨å…ˆè¿›å…ˆå‡º FIFO çš„æ–¹å¼ä¿å­˜å¤šæ¡æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå½“æœåŠ¡å™¨å­˜å‚¨çš„æ…¢æŸ¥è¯¢æ—¥å¿—æ•°é‡ç­‰äº slowlog-max-len é€‰é¡¹çš„å€¼æ—¶ï¼Œåœ¨æ·»åŠ ä¸€æ¡æ–°çš„æ…¢æŸ¥è¯¢æ—¥å¿—ä¹‹å‰ï¼Œä¼šå…ˆå°†æœ€æ—§çš„ä¸€æ¡æ…¢æŸ¥è¯¢æ—¥å¿—åˆ é™¤</p><p>é…ç½®é€‰é¡¹å¯ä»¥é€šè¿‡ CONFIG SET option value å‘½ä»¤è¿›è¡Œè®¾ç½®</p><p>å¸¸ç”¨å‘½ä»¤ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>SLOWLOG GET <span class="token punctuation">[</span>n<span class="token punctuation">]</span>	<span class="token comment"># æŸ¥çœ‹ n æ¡æœåŠ¡å™¨ä¿å­˜çš„æ…¢æ—¥å¿—</span>
SLOWLOG LEN		<span class="token comment"># æŸ¥çœ‹æ—¥å¿—æ•°é‡</span>
SLOWLOG RESET	<span class="token comment"># æ¸…é™¤æ‰€æœ‰æ…¢æŸ¥è¯¢æ—¥å¿—</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="æ—¥å¿—ä¿å­˜" tabindex="-1"><a class="header-anchor" href="#æ—¥å¿—ä¿å­˜" aria-hidden="true">#</a> æ—¥å¿—ä¿å­˜</h4><p>æœåŠ¡å™¨çŠ¶æ€ä¸­åŒ…å«äº†æ…¢æŸ¥è¯¢æ—¥å¿—åŠŸèƒ½æœ‰å…³çš„å±æ€§ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
	<span class="token comment">// ä¸‹ä¸€æ¡æ…¢æŸ¥è¯¢æ—¥å¿—çš„ID</span>
	<span class="token keyword">long</span> <span class="token keyword">long</span> slowlog_entry_id<span class="token punctuation">;</span>
    
	<span class="token comment">// ä¿å­˜äº†æ‰€æœ‰æ…¢æŸ¥è¯¢æ—¥å¿—çš„é“¾è¡¨</span>
	list <span class="token operator">*</span>slowlog<span class="token punctuation">;</span>
    
	<span class="token comment">// æœåŠ¡å™¨é…ç½®é€‰é¡¹çš„å€¼ </span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> slowlog<span class="token operator">-</span>log<span class="token operator">-</span>slower<span class="token operator">-</span>than<span class="token punctuation">;</span>
	<span class="token comment">// æœåŠ¡å™¨é…ç½®é€‰é¡¹çš„å€¼</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> slowlog_max_len<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>slowlog_entry_id å±æ€§çš„åˆå§‹å€¼ä¸º 0ï¼Œæ¯å½“åˆ›å»ºä¸€æ¡æ–°çš„æ…¢æŸ¥è¯¢æ—¥å¿—æ—¶ï¼Œè¿™ä¸ªå±æ€§å°±ä¼šç”¨ä½œæ–°æ—¥å¿—çš„ id å€¼ï¼Œä¹‹åè¯¥å±æ€§å¢ä¸€</p><p>slowlog é“¾è¡¨ä¿å­˜äº†æœåŠ¡å™¨ä¸­çš„æ‰€æœ‰æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œé“¾è¡¨ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ª slowlogEntry ç»“æ„ï¼Œ ä»£è¡¨ä¸€æ¡æ…¢æŸ¥è¯¢æ—¥å¿—ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">slowlogEntry</span> <span class="token punctuation">{</span>
    <span class="token comment">// å”¯ä¸€æ ‡è¯†ç¬¦</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> id<span class="token punctuation">;</span>
   	<span class="token comment">// å‘½ä»¤æ‰§è¡Œæ—¶çš„æ—¶é—´ï¼Œæ ¼å¼ä¸ºUNIXæ—¶é—´æˆ³</span>
    <span class="token class-name">time_t</span> time<span class="token punctuation">;</span>
	<span class="token comment">// æ‰§è¡Œå‘½ä»¤æ¶ˆè€—çš„æ—¶é—´ï¼Œä»¥å¾®ç§’ä¸ºå•ä½ </span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> duration<span class="token punctuation">;</span>
	<span class="token comment">// å‘½ä»¤ä¸å‘½ä»¤å‚æ•°</span>
	robj <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">;</span>
	<span class="token comment">// å‘½ä»¤ä¸å‘½ä»¤å‚æ•°çš„æ•°é‡</span>
	<span class="token keyword">int</span> argc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="æ·»åŠ æ—¥å¿—" tabindex="-1"><a class="header-anchor" href="#æ·»åŠ æ—¥å¿—" aria-hidden="true">#</a> æ·»åŠ æ—¥å¿—</h4><p>åœ¨æ¯æ¬¡æ‰§è¡Œå‘½ä»¤çš„å‰åï¼Œç¨‹åºéƒ½ä¼šè®°å½•å¾®ç§’æ ¼å¼çš„å½“å‰ UNIX æ—¶é—´æˆ³ï¼Œä¸¤ä¸ªæ—¶é—´ä¹‹å·®å°±æ˜¯æ‰§è¡Œå‘½ä»¤æ‰€è€—è´¹çš„æ—¶é•¿ï¼Œå‡½æ•°ä¼šæ£€æŸ¥å‘½ä»¤çš„æ‰§è¡Œæ—¶é•¿æ˜¯å¦è¶…è¿‡ slowlog-log-slower-than é€‰é¡¹æ‰€è®¾ç½®ï¼š</p><ul><li><p>å¦‚æœæ˜¯çš„è¯ï¼Œå°±ä¸ºå‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„æ—¥å¿—ï¼Œå¹¶å°†æ–°æ—¥å¿—æ·»åŠ åˆ° slowlog é“¾è¡¨çš„è¡¨å¤´</p></li><li><p>æ£€æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—çš„é•¿åº¦æ˜¯å¦è¶…è¿‡ slowlog-max-len é€‰é¡¹æ‰€è®¾ç½®çš„é•¿åº¦ï¼Œå¦‚æœæ˜¯å°†å¤šå‡ºæ¥çš„æ—¥å¿—ä» slowlog é“¾è¡¨ä¸­åˆ é™¤æ‰</p></li><li><p>å°† redisServer. slowlog_entry_id çš„å€¼å¢ 1</p></li></ul><hr><h2 id="æ•°æ®ç»“æ„-1" tabindex="-1"><a class="header-anchor" href="#æ•°æ®ç»“æ„-1" aria-hidden="true">#</a> æ•°æ®ç»“æ„</h2><h3 id="å­—ç¬¦ä¸²" tabindex="-1"><a class="header-anchor" href="#å­—ç¬¦ä¸²" aria-hidden="true">#</a> å­—ç¬¦ä¸²</h3><h4 id="sds" tabindex="-1"><a class="header-anchor" href="#sds" aria-hidden="true">#</a> SDS</h4><p>Redis æ„å»ºäº†ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰çš„æ•°æ®ç±»å‹ï¼Œä½œä¸º Redis çš„é»˜è®¤å­—ç¬¦ä¸²è¡¨ç¤ºï¼ŒåŒ…å«å­—ç¬¦ä¸²çš„é”®å€¼å¯¹åœ¨åº•å±‚éƒ½æ˜¯ç”± SDS å®ç°</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sdshdr</span> <span class="token punctuation">{</span>
    <span class="token comment">// è®°å½•bufæ•°ç»„ä¸­å·²ä½¿ç”¨å­—èŠ‚çš„æ•°é‡ï¼Œç­‰äº SDS æ‰€ä¿å­˜å­—ç¬¦ä¸²çš„é•¿åº¦</span>
    <span class="token keyword">int</span> len<span class="token punctuation">;</span>
    
	<span class="token comment">// è®°å½•bufæ•°ç»„ä¸­æœªä½¿ç”¨å­—èŠ‚çš„æ•°é‡</span>
    <span class="token keyword">int</span> free<span class="token punctuation">;</span>
    
    <span class="token comment">// ã€å­—èŠ‚ã€‘æ•°ç»„ï¼Œç”¨äºä¿å­˜å­—ç¬¦ä¸²ï¼ˆä¸æ˜¯å­—ç¬¦æ•°ç»„ï¼‰</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>SDS éµå¾ª C å­—ç¬¦ä¸²<strong>ä»¥ç©ºå­—ç¬¦ç»“å°¾</strong>çš„æƒ¯ä¾‹ï¼Œä¿å­˜ç©ºå­—ç¬¦çš„ 1 å­—èŠ‚ä¸è®¡ç®—åœ¨ len å±æ€§ï¼ŒSDS ä¼šè‡ªåŠ¨ä¸ºç©ºå­—ç¬¦åˆ†é…é¢å¤–çš„ 1 å­—èŠ‚ç©ºé—´å’Œæ·»åŠ ç©ºå­—ç¬¦åˆ°å­—ç¬¦ä¸²æœ«å°¾ï¼Œæ‰€ä»¥ç©ºå­—ç¬¦å¯¹äº SDS çš„ä½¿ç”¨è€…æ¥è¯´æ˜¯å®Œå…¨é€æ˜çš„</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-SDSåº•å±‚ç»“æ„.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h4 id="å¯¹æ¯”" tabindex="-1"><a class="header-anchor" href="#å¯¹æ¯”" aria-hidden="true">#</a> å¯¹æ¯”</h4><p>å¸¸æ•°å¤æ‚åº¦è·å–å­—ç¬¦ä¸²é•¿åº¦ï¼š</p><ul><li>C å­—ç¬¦ä¸²ä¸è®°å½•è‡ªèº«çš„é•¿åº¦ï¼Œè·å–æ—¶éœ€è¦éå†æ•´ä¸ªå­—ç¬¦ä¸²ï¼Œé‡åˆ°ç©ºå­—ç¬¦ä¸²ä¸ºæ­¢ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(N)</li><li>SDS è·å–å­—ç¬¦ä¸²é•¿åº¦çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œè®¾ç½®å’Œæ›´æ–° SDS é•¿åº¦ç”±å‡½æ•°åº•å±‚è‡ªåŠ¨å®Œæˆ</li></ul><p>æœç»ç¼“å†²åŒºæº¢å‡ºï¼š</p><ul><li><p>C å­—ç¬¦ä¸²è°ƒç”¨ strcat å‡½æ•°æ‹¼æ¥å­—ç¬¦ä¸²æ—¶ï¼Œå¦‚æœå­—ç¬¦ä¸²å†…å­˜ä¸å¤Ÿå®¹çº³ç›®æ ‡å­—ç¬¦ä¸²ï¼Œå°±ä¼šé€ æˆç¼“å†²åŒºæº¢å‡ºï¼ˆBuffer Overflowï¼‰</p><p>s1 å’Œ s2 æ˜¯å†…å­˜ä¸­ç›¸é‚»çš„å­—ç¬¦ä¸²ï¼Œæ‰§è¡Œ <code>strcat(s1, &quot; Cluster&quot;)</code>ï¼ˆæœ‰ç©ºæ ¼ï¼‰ï¼š</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å†…å­˜æº¢å‡ºé—®é¢˜.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></li><li><p>SDS ç©ºé—´åˆ†é…ç­–ç•¥ï¼šå½“å¯¹ SDS è¿›è¡Œä¿®æ”¹æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥ SDS çš„ç©ºé—´æ˜¯å¦æ»¡è¶³ä¿®æ”¹æ‰€éœ€çš„è¦æ±‚ï¼Œ å¦‚æœä¸æ»¡è¶³ä¼šè‡ªåŠ¨å°† SDS çš„ç©ºé—´æ‰©å±•è‡³æ‰§è¡Œä¿®æ”¹æ‰€éœ€çš„å¤§å°ï¼Œç„¶åæ‰§è¡Œå®é™…çš„ä¿®æ”¹æ“ä½œï¼Œ é¿å…äº†ç¼“å†²åŒºæº¢å‡ºçš„é—®é¢˜</p></li></ul><p>äºŒè¿›åˆ¶å®‰å…¨ï¼š</p><ul><li>C å­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦å¿…é¡»ç¬¦åˆæŸç§ç¼–ç ï¼ˆæ¯”å¦‚ ASCIIï¼‰æ–¹å¼ï¼Œé™¤äº†å­—ç¬¦ä¸²æœ«å°¾ä»¥å¤–å…¶ä»–ä½ç½®ä¸èƒ½åŒ…å«ç©ºå­—ç¬¦ï¼Œå¦åˆ™ä¼šè¢«è¯¯è®¤ä¸ºæ˜¯å­—ç¬¦ä¸²çš„ç»“å°¾ï¼Œæ‰€ä»¥åªèƒ½ä¿å­˜æ–‡æœ¬æ•°æ®</li><li>SDS çš„ API éƒ½æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œä½¿ç”¨å­—èŠ‚æ•°ç»„ buf ä¿å­˜ä¸€ç³»åˆ—çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œ<strong>ä½¿ç”¨ len å±æ€§æ¥åˆ¤æ–­æ•°æ®çš„ç»“å°¾</strong>ï¼Œæ‰€ä»¥å¯ä»¥ä¿å­˜å›¾ç‰‡ã€è§†é¢‘ã€å‹ç¼©æ–‡ä»¶ç­‰äºŒè¿›åˆ¶æ•°æ®</li></ul><p>å…¼å®¹ C å­—ç¬¦ä¸²çš„å‡½æ•°ï¼šSDS ä¼šåœ¨ä¸º buf æ•°ç»„åˆ†é…ç©ºé—´æ—¶å¤šåˆ†é…ä¸€ä¸ªå­—èŠ‚æ¥ä¿å­˜ç©ºå­—ç¬¦ï¼Œæ‰€ä»¥å¯ä»¥é‡ç”¨ä¸€éƒ¨åˆ† C å­—ç¬¦ä¸²å‡½æ•°åº“çš„å‡½æ•°</p><hr><h4 id="å†…å­˜" tabindex="-1"><a class="header-anchor" href="#å†…å­˜" aria-hidden="true">#</a> å†…å­˜</h4><p>C å­—ç¬¦ä¸²<strong>æ¯æ¬¡</strong>å¢é•¿æˆ–è€…ç¼©çŸ­éƒ½ä¼šè¿›è¡Œä¸€æ¬¡å†…å­˜é‡åˆ†é…ï¼Œæ‹¼æ¥æ“ä½œé€šè¿‡é‡åˆ†é…æ‰©å±•åº•å±‚æ•°ç»„ç©ºé—´ï¼Œæˆªæ–­æ“ä½œé€šè¿‡é‡åˆ†é…é‡Šæ”¾ä¸ä½¿ç”¨çš„å†…å­˜ç©ºé—´ï¼Œé˜²æ­¢å‡ºç°å†…å­˜æ³„éœ²</p><p>SDS é€šè¿‡æœªä½¿ç”¨ç©ºé—´è§£é™¤äº†å­—ç¬¦ä¸²é•¿åº¦å’Œåº•å±‚æ•°ç»„é•¿åº¦ä¹‹é—´çš„å…³è”ï¼Œåœ¨ SDS ä¸­ buf æ•°ç»„çš„é•¿åº¦ä¸ä¸€å®šå°±æ˜¯å­—ç¬¦æ•°é‡åŠ ä¸€ï¼Œ æ•°ç»„é‡Œé¢å¯ä»¥åŒ…å«æœªä½¿ç”¨çš„å­—èŠ‚ï¼Œå­—èŠ‚çš„æ•°é‡ç”± free å±æ€§è®°å½•</p><p>å†…å­˜é‡åˆ†é…æ¶‰åŠå¤æ‚çš„ç®—æ³•ï¼Œéœ€è¦æ‰§è¡Œ<strong>ç³»ç»Ÿè°ƒç”¨</strong>ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼ŒSDS çš„ä¸¤ç§ä¼˜åŒ–ç­–ç•¥ï¼š</p><ul><li><p>ç©ºé—´é¢„åˆ†é…ï¼šå½“ SDS éœ€è¦è¿›è¡Œç©ºé—´æ‰©å±•æ—¶ï¼Œç¨‹åºä¸ä»…ä¼šä¸º SDS åˆ†é…ä¿®æ”¹æ‰€å¿…éœ€çš„ç©ºé—´ï¼Œ è¿˜ä¼šä¸º SDS åˆ†é…é¢å¤–çš„æœªä½¿ç”¨ç©ºé—´</p><ul><li><p>å¯¹ SDS ä¿®æ”¹ä¹‹åï¼ŒSDS çš„é•¿åº¦ï¼ˆlen å±æ€§ï¼‰å°äº 1MBï¼Œç¨‹åºåˆ†é…å’Œ len å±æ€§åŒæ ·å¤§å°çš„æœªä½¿ç”¨ç©ºé—´ï¼Œæ­¤æ—¶ len å’Œ free ç›¸ç­‰</p><p>s ä¸º Redisï¼Œæ‰§è¡Œ <code>sdscat(s, &quot; Cluster&quot;)</code> åï¼Œlen å˜ä¸º 13 å­—èŠ‚ï¼Œæ‰€ä»¥ä¹Ÿåˆ†é…äº† 13 å­—èŠ‚çš„ free ç©ºé—´ï¼Œæ€»é•¿åº¦å˜ä¸º 27 å­—èŠ‚ï¼ˆé¢å¤–çš„ä¸€å­—èŠ‚ä¿å­˜ç©ºå­—ç¬¦ï¼Œ13 + 13 + 1 = 27ï¼‰</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-SDSå†…å­˜é¢„åˆ†é….png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></li><li><p>å¯¹ SDS ä¿®æ”¹ä¹‹åï¼ŒSDS çš„é•¿åº¦å¤§äºç­‰äº 1MBï¼Œç¨‹åºä¼šåˆ†é… 1MB çš„æœªä½¿ç”¨ç©ºé—´</p></li></ul><p>åœ¨æ‰©å±• SDS ç©ºé—´å‰ï¼ŒAPI ä¼šå…ˆæ£€æŸ¥ free ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœè¶³å¤Ÿå°±æ— éœ€æ‰§è¡Œå†…å­˜é‡åˆ†é…ï¼Œæ‰€ä»¥é€šè¿‡é¢„åˆ†é…ç­–ç•¥ï¼ŒSDS å°†è¿ç»­å¢é•¿ N æ¬¡å­—ç¬¦ä¸²æ‰€éœ€å†…å­˜çš„é‡åˆ†é…æ¬¡æ•°ä»<strong>å¿…å®š N æ¬¡é™ä½ä¸ºæœ€å¤š N æ¬¡</strong></p></li><li><p>æƒ°æ€§ç©ºé—´é‡Šæ”¾ï¼šå½“ SDS ç¼©çŸ­å­—ç¬¦ä¸²æ—¶ï¼Œç¨‹åºå¹¶ä¸ç«‹å³ä½¿ç”¨å†…å­˜é‡åˆ†é…æ¥å›æ”¶ç¼©çŸ­åå¤šå‡ºæ¥çš„å­—èŠ‚ï¼Œè€Œæ˜¯ä½¿ç”¨ free å±æ€§å°†è¿™äº›å­—èŠ‚çš„æ•°é‡è®°å½•èµ·æ¥ï¼Œå¹¶ç­‰å¾…å°†æ¥å¤ç”¨</p><p>SDS æä¾›äº†ç›¸åº”çš„ API æ¥çœŸæ­£é‡Šæ”¾ SDS çš„æœªä½¿ç”¨ç©ºé—´ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒç©ºé—´æƒ°æ€§é‡Šæ”¾ç­–ç•¥é€ æˆçš„å†…å­˜æµªè´¹é—®é¢˜</p></li></ul><hr><h3 id="é“¾è¡¨" tabindex="-1"><a class="header-anchor" href="#é“¾è¡¨" aria-hidden="true">#</a> é“¾è¡¨</h3><p>é“¾è¡¨æä¾›äº†é«˜æ•ˆçš„èŠ‚ç‚¹é‡æ’èƒ½åŠ›ï¼ŒC è¯­è¨€å¹¶æ²¡æœ‰å†…ç½®è¿™ç§æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥ Redis æ„å»ºäº†é“¾è¡¨æ•°æ®ç±»å‹</p><p>é“¾è¡¨èŠ‚ç‚¹ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">listNode</span> <span class="token punctuation">{</span>
    <span class="token comment">// å‰ç½®èŠ‚ç‚¹</span>
    <span class="token keyword">struct</span> <span class="token class-name">listNode</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span>
    
    <span class="token comment">// åç½®èŠ‚ç‚¹</span>
    <span class="token keyword">struct</span> <span class="token class-name">listNode</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
    
    <span class="token comment">// èŠ‚ç‚¹çš„å€¼</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>value
<span class="token punctuation">}</span> listNode<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¤šä¸ª listNode é€šè¿‡ prev å’Œ next æŒ‡é’ˆç»„æˆ<strong>åŒç«¯é“¾è¡¨</strong>ï¼š</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-é“¾è¡¨èŠ‚ç‚¹åº•å±‚ç»“æ„.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>list é“¾è¡¨ç»“æ„ï¼šæä¾›äº†è¡¨å¤´æŒ‡é’ˆ head ã€è¡¨å°¾æŒ‡é’ˆ tail ä»¥åŠé“¾è¡¨é•¿åº¦è®¡æ•°å™¨ len</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">list</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¡¨å¤´èŠ‚ç‚¹</span>
    listNode <span class="token operator">*</span>head<span class="token punctuation">;</span>
    <span class="token comment">// è¡¨å°¾èŠ‚ç‚¹</span>
    listNode <span class="token operator">*</span>tail<span class="token punctuation">;</span>
    
    <span class="token comment">// é“¾è¡¨æ‰€åŒ…å«çš„èŠ‚ç‚¹æ•°é‡</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> len<span class="token punctuation">;</span>
    
    <span class="token comment">// èŠ‚ç‚¹å€¼å¤åˆ¶å‡½æ•°ï¼Œç”¨äºå¤åˆ¶é“¾è¡¨èŠ‚ç‚¹æ‰€ä¿å­˜çš„å€¼</span>
    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>dup<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// èŠ‚ç‚¹å€¼é‡Šæ”¾å‡½æ•°ï¼Œç”¨äºé‡Šæ”¾é“¾è¡¨èŠ‚ç‚¹æ‰€ä¿å­˜çš„å€¼</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>free<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// èŠ‚ç‚¹å€¼å¯¹æ¯”å‡½æ•°ï¼Œç”¨äºå¯¹æ¯”é“¾è¡¨èŠ‚ç‚¹æ‰€ä¿å­˜çš„å€¼å’Œå¦ä¸€ä¸ªè¾“å…¥å€¼æ˜¯å¦ç›¸ç­‰</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>match<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> list<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-é“¾è¡¨åº•å±‚ç»“æ„.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Redis é“¾è¡¨çš„ç‰¹æ€§ï¼š</p><ul><li>åŒç«¯ï¼šé“¾è¡¨èŠ‚ç‚¹å¸¦æœ‰ prev å’Œ next æŒ‡é’ˆï¼Œè·å–æŸä¸ªèŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹å’Œåç½®èŠ‚ç‚¹çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(1)</li><li>æ— ç¯ï¼šè¡¨å¤´èŠ‚ç‚¹çš„ prev æŒ‡é’ˆå’Œè¡¨å°¾èŠ‚ç‚¹çš„ next æŒ‡é’ˆéƒ½æŒ‡å‘ NULLï¼Œå¯¹é“¾è¡¨çš„è®¿é—®ä»¥ NULL ä¸ºç»ˆç‚¹</li><li>å¸¦è¡¨å¤´æŒ‡é’ˆå’Œè¡¨å°¾æŒ‡é’ˆï¼š é€šè¿‡ list ç»“æ„çš„ head æŒ‡é’ˆå’Œ tail æŒ‡é’ˆï¼Œè·å–é“¾è¡¨çš„è¡¨å¤´èŠ‚ç‚¹å’Œè¡¨å°¾èŠ‚ç‚¹çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)</li><li>å¸¦é“¾è¡¨é•¿åº¦è®¡æ•°å™¨ï¼šä½¿ç”¨ len å±æ€§æ¥å¯¹ list æŒæœ‰çš„é“¾è¡¨èŠ‚ç‚¹è¿›è¡Œè®¡æ•°ï¼Œè·å–é“¾è¡¨ä¸­èŠ‚ç‚¹æ•°é‡çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)</li><li>å¤šæ€ï¼šé“¾è¡¨èŠ‚ç‚¹ä½¿ç”¨ void * æŒ‡é’ˆæ¥ä¿å­˜èŠ‚ç‚¹å€¼ï¼Œ å¹¶ä¸”å¯ä»¥é€šè¿‡ dupã€free ã€match ä¸‰ä¸ªå±æ€§ä¸ºèŠ‚ç‚¹å€¼è®¾ç½®ç±»å‹ç‰¹å®šå‡½æ•°ï¼Œæ‰€ä»¥é“¾è¡¨å¯ä»¥ä¿å­˜å„ç§<strong>ä¸åŒç±»å‹çš„å€¼</strong></li></ul><hr><h3 id="å­—å…¸" tabindex="-1"><a class="header-anchor" href="#å­—å…¸" aria-hidden="true">#</a> å­—å…¸</h3><h4 id="å“ˆå¸Œè¡¨" tabindex="-1"><a class="header-anchor" href="#å“ˆå¸Œè¡¨" aria-hidden="true">#</a> å“ˆå¸Œè¡¨</h4><p>Redis å­—å…¸ä½¿ç”¨çš„å“ˆå¸Œè¡¨ç»“æ„ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dictht</span> <span class="token punctuation">{</span>
    <span class="token comment">// å“ˆå¸Œè¡¨æ•°ç»„ï¼Œæ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ æŒ‡å‘ dictEntry ç»“æ„</span>
	dictEntry <span class="token operator">*</span><span class="token operator">*</span>table<span class="token punctuation">;</span>
    
	<span class="token comment">// å“ˆå¸Œè¡¨å¤§å°ï¼Œæ•°ç»„çš„é•¿åº¦</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">;</span>
    
	<span class="token comment">// å“ˆå¸Œè¡¨å¤§å°æ©ç ï¼Œç”¨äºè®¡ç®—ç´¢å¼•å€¼ï¼Œæ€»æ˜¯ç­‰äº ã€size-1ã€‘</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> sizemask<span class="token punctuation">;</span>
    
	<span class="token comment">// è¯¥å“ˆå¸Œè¡¨å·²æœ‰èŠ‚ç‚¹çš„æ•°é‡ </span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> used<span class="token punctuation">;</span>
<span class="token punctuation">}</span> dictht<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å“ˆå¸Œè¡¨èŠ‚ç‚¹ç»“æ„ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dictEntry</span> <span class="token punctuation">{</span>
    <span class="token comment">// é”®</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>
    
	<span class="token comment">// å€¼ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæˆ–è€…æ•´æ•°</span>
	<span class="token keyword">union</span> <span class="token punctuation">{</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>val<span class="token punctuation">;</span>	<span class="token comment">// æŒ‡é’ˆ</span>
        <span class="token class-name">uint64_t</span> u64<span class="token punctuation">;</span>
        <span class="token class-name">int64_t</span> s64<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
	<span class="token comment">// æŒ‡å‘ä¸‹ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œå½¢æˆé“¾è¡¨ï¼Œç”¨æ¥è§£å†³å†²çªé—®é¢˜</span>
    <span class="token keyword">struct</span> <span class="token class-name">dictEntry</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span> dictEntry<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å“ˆå¸Œè¡¨åº•å±‚ç»“æ„.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h4 id="å­—å…¸ç»“æ„" tabindex="-1"><a class="header-anchor" href="#å­—å…¸ç»“æ„" aria-hidden="true">#</a> å­—å…¸ç»“æ„</h4><p>å­—å…¸ï¼Œåˆç§°ä¸ºç¬¦å·è¡¨ã€å…³è”æ•°ç»„ã€æ˜ å°„ï¼ˆMapï¼‰ï¼Œç”¨äºä¿å­˜é”®å€¼å¯¹çš„æ•°æ®ç»“æ„ï¼Œå­—å…¸ä¸­çš„æ¯ä¸ªé”®éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ã€‚åº•å±‚é‡‡ç”¨å“ˆå¸Œè¡¨å®ç°ï¼Œä¸€ä¸ªå“ˆå¸Œè¡¨åŒ…å«å¤šä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¿å­˜ä¸€ä¸ªé”®å€¼å¯¹</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dict</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç±»å‹ç‰¹å®šå‡½æ•°</span>
    dictType <span class="token operator">*</span>type<span class="token punctuation">;</span>
    
    <span class="token comment">// ç§æœ‰æ•°æ®</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">;</span>
    
    <span class="token comment">// å“ˆå¸Œè¡¨ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªé¡¹éƒ½æ˜¯ä¸€ä¸ªdicthtå“ˆå¸Œè¡¨ï¼Œ</span>
    <span class="token comment">// ä¸€èˆ¬æƒ…å†µä¸‹å­—å…¸åªä½¿ç”¨ ht[0] å“ˆå¸Œè¡¨ï¼Œ ht[1] å“ˆå¸Œè¡¨åªä¼šåœ¨å¯¹ ht[0] å“ˆå¸Œè¡¨è¿›è¡Œ rehash æ—¶ä½¿ç”¨</span>
    dictht ht<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">// rehash ç´¢å¼•ï¼Œå½“ rehash ä¸åœ¨è¿›è¡Œæ—¶ï¼Œå€¼ä¸º -1</span>
    <span class="token keyword">int</span> rehashidx<span class="token punctuation">;</span>
<span class="token punctuation">}</span> dict<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>type å±æ€§å’Œ privdata å±æ€§æ˜¯é’ˆå¯¹ä¸åŒç±»å‹çš„é”®å€¼å¯¹ï¼Œ ä¸ºåˆ›å»ºå¤šæ€å­—å…¸è€Œè®¾ç½®çš„ï¼š</p><ul><li>type å±æ€§æ˜¯æŒ‡å‘ dictType ç»“æ„çš„æŒ‡é’ˆï¼Œ æ¯ä¸ª dictType ç»“æ„ä¿å­˜äº†ä¸€ç°‡ç”¨äºæ“ä½œç‰¹å®šç±»å‹é”®å€¼å¯¹çš„å‡½æ•°ï¼Œ Redis ä¼šä¸ºç”¨é€”ä¸åŒçš„å­—å…¸è®¾ç½®ä¸åŒçš„ç±»å‹ç‰¹å®šå‡½æ•°</li><li>privdata å±æ€§ä¿å­˜äº†éœ€è¦ä¼ ç»™é‚£äº›ç±»å‹ç‰¹å®šå‡½æ•°çš„å¯é€‰å‚æ•°</li></ul><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å­—å…¸åº•å±‚ç»“æ„.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h4 id="å“ˆå¸Œå†²çª" tabindex="-1"><a class="header-anchor" href="#å“ˆå¸Œå†²çª" aria-hidden="true">#</a> å“ˆå¸Œå†²çª</h4><p>Redis ä½¿ç”¨ MurmurHash ç®—æ³•æ¥è®¡ç®—é”®çš„å“ˆå¸Œå€¼ï¼Œè¿™ç§ç®—æ³•çš„ä¼˜ç‚¹åœ¨äºï¼Œå³ä½¿è¾“å…¥çš„é”®æ˜¯æœ‰è§„å¾‹çš„ï¼Œç®—æ³•ä»èƒ½ç»™å‡ºä¸€ä¸ªå¾ˆå¥½çš„éšæœºåˆ†å¸ƒæ€§ï¼Œå¹¶ä¸”ç®—æ³•çš„è®¡ç®—é€Ÿåº¦ä¹Ÿéå¸¸å¿«</p><p>å°†ä¸€ä¸ªæ–°çš„é”®å€¼å¯¹æ·»åŠ åˆ°å­—å…¸é‡Œï¼Œéœ€è¦å…ˆæ ¹æ®é”® key è®¡ç®—å‡ºå“ˆå¸Œå€¼ï¼Œç„¶åè¿›è¡Œå–æ¨¡è¿ç®—ï¼ˆå–ä½™ï¼‰ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>index <span class="token operator">=</span> hash <span class="token operator">&amp;</span> dict<span class="token operator">-&gt;</span>ht<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>sizemask
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å½“æœ‰ä¸¤ä¸ªæˆ–ä»¥ä¸Šæ•°é‡çš„é”®è¢«åˆ†é…åˆ°äº†å“ˆå¸Œè¡¨æ•°ç»„çš„åŒä¸€ä¸ªç´¢å¼•ä¸Šæ—¶ï¼Œå°±ç§°è¿™äº›é”®å‘ç”Ÿäº†å“ˆå¸Œå†²çªï¼ˆcollisionï¼‰</p><p>Redis çš„å“ˆå¸Œè¡¨ä½¿ç”¨é“¾åœ°å€æ³•ï¼ˆseparate chainingï¼‰æ¥è§£å†³é”®å“ˆå¸Œå†²çªï¼Œ æ¯ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ª next æŒ‡é’ˆï¼Œå¤šä¸ªèŠ‚ç‚¹é€šè¿‡ next æŒ‡é’ˆæ„æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œè¢«åˆ†é…åˆ°åŒä¸€ä¸ªç´¢å¼•ä¸Šçš„å¤šä¸ªèŠ‚ç‚¹å¯ä»¥ç”¨è¿™ä¸ªå•å‘é“¾è¡¨è¿æ¥èµ·æ¥ï¼Œè¿™å°±è§£å†³äº†é”®å†²çªçš„é—®é¢˜</p><p>dictEntry èŠ‚ç‚¹ç»„æˆçš„é“¾è¡¨æ²¡æœ‰æŒ‡å‘é“¾è¡¨è¡¨å°¾çš„æŒ‡é’ˆï¼Œä¸ºäº†é€Ÿåº¦è€ƒè™‘ï¼Œç¨‹åºæ€»æ˜¯å°†æ–°èŠ‚ç‚¹æ·»åŠ åˆ°é“¾è¡¨çš„è¡¨å¤´ä½ç½®ï¼ˆ<strong>å¤´æ’æ³•</strong>ï¼‰ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å­—å…¸è§£å†³å“ˆå¸Œå†²çª.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h4 id="è´Ÿè½½å› å­" tabindex="-1"><a class="header-anchor" href="#è´Ÿè½½å› å­" aria-hidden="true">#</a> è´Ÿè½½å› å­</h4><p>è´Ÿè½½å› å­çš„è®¡ç®—æ–¹å¼ï¼šå“ˆå¸Œè¡¨ä¸­çš„<strong>èŠ‚ç‚¹æ•°é‡</strong> / å“ˆå¸Œè¡¨çš„å¤§å°ï¼ˆ<strong>é•¿åº¦</strong>ï¼‰</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>load_factor <span class="token operator">=</span> ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>used <span class="token operator">/</span> ht<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä¸ºäº†è®©å“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­ï¼ˆload factorï¼‰ç»´æŒåœ¨ä¸€ä¸ªåˆç†çš„èŒƒå›´ä¹‹å†…ï¼Œå½“å“ˆå¸Œè¡¨ä¿å­˜çš„é”®å€¼å¯¹æ•°é‡å¤ªå¤šæˆ–è€…å¤ªå°‘æ—¶ ï¼Œç¨‹åºä¼šè‡ªåŠ¨å¯¹å“ˆå¸Œè¡¨çš„å¤§å°è¿›è¡Œç›¸åº”çš„æ‰©å±•æˆ–è€…æ”¶ç¼©</p><p>å“ˆå¸Œè¡¨æ‰§è¡Œæ‰©å®¹çš„æ¡ä»¶ï¼š</p><ul><li><p>æœåŠ¡å™¨æ²¡æœ‰æ‰§è¡Œ BGSAVE æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œå“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å¤§äºç­‰äº 1</p></li><li><p>æœåŠ¡å™¨æ­£åœ¨æ‰§è¡Œ BGSAVE æˆ–è€… BGREWRITEAOF å‘½ä»¤ï¼Œå“ˆå¸Œè¡¨çš„è´Ÿè½½å› å­å¤§äºç­‰äº 5</p><p>åŸå› ï¼šæ‰§è¡Œè¯¥å‘½ä»¤çš„è¿‡ç¨‹ä¸­ï¼ŒRedis éœ€è¦åˆ›å»ºå½“å‰æœåŠ¡å™¨è¿›ç¨‹çš„å­è¿›ç¨‹ï¼Œè€Œå¤§å¤šæ•°æ“ä½œç³»ç»Ÿéƒ½é‡‡ç”¨å†™æ—¶å¤åˆ¶ï¼ˆcopy-onÂ­-writeï¼‰æŠ€æœ¯æ¥ä¼˜åŒ–å­è¿›ç¨‹çš„ä½¿ç”¨æ•ˆç‡ï¼Œé€šè¿‡æé«˜æ‰§è¡Œæ‰©å±•æ“ä½œçš„è´Ÿè½½å› å­ï¼Œå°½å¯èƒ½åœ°é¿å…åœ¨å­è¿›ç¨‹å­˜åœ¨æœŸé—´è¿›è¡Œå“ˆå¸Œè¡¨æ‰©å±•æ“ä½œï¼Œå¯ä»¥é¿å…ä¸å¿…è¦çš„å†…å­˜å†™å…¥æ“ä½œï¼Œæœ€å¤§é™åº¦åœ°èŠ‚çº¦å†…å­˜</p></li></ul><p>å“ˆå¸Œè¡¨æ‰§è¡Œæ”¶ç¼©çš„æ¡ä»¶ï¼šè´Ÿè½½å› å­å°äº 0.1ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼ŒservreCron ä¸­æ£€æµ‹ï¼‰</p><hr><h4 id="é‡æ–°æ•£åˆ—" tabindex="-1"><a class="header-anchor" href="#é‡æ–°æ•£åˆ—" aria-hidden="true">#</a> é‡æ–°æ•£åˆ—</h4><p>æ‰©å±•å’Œæ”¶ç¼©å“ˆå¸Œè¡¨çš„æ“ä½œé€šè¿‡ rehashï¼ˆé‡æ–°æ•£åˆ—ï¼‰æ¥å®Œæˆï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>ä¸ºå­—å…¸çš„ ht[1] å“ˆå¸Œè¡¨åˆ†é…ç©ºé—´ï¼Œç©ºé—´å¤§å°çš„åˆ†é…æƒ…å†µï¼š <ul><li>å¦‚æœæ‰§è¡Œçš„æ˜¯æ‰©å±•æ“ä½œï¼Œht[1] çš„å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äº <mjx-container class="MathJax" jax="SVG" style="position:relative;"><svg style="vertical-align:-0.566ex;" xmlns="http://www.w3.org/2000/svg" width="13.369ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 5909.1 1000" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g><g data-mml-node="mi" transform="translate(576,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mo" transform="translate(937,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(1215,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(1715,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(1993,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mi" transform="translate(2437.7,0)"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(3009.7,0)"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mi" transform="translate(3478.7,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mi" transform="translate(3944.7,0)"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mo" transform="translate(4686.9,0)"><path data-c="2217" d="M229 286Q216 420 216 436Q216 454 240 464Q241 464 245 464T251 465Q263 464 273 456T283 436Q283 419 277 356T270 286L328 328Q384 369 389 372T399 375Q412 375 423 365T435 338Q435 325 425 315Q420 312 357 282T289 250L355 219L425 184Q434 175 434 161Q434 146 425 136T401 125Q393 125 383 131T328 171L270 213Q283 79 283 63Q283 53 276 44T250 35Q231 35 224 44T216 63Q216 80 222 143T229 213L171 171Q115 130 110 127Q106 124 100 124Q87 124 76 134T64 161Q64 166 64 169T67 175T72 181T81 188T94 195T113 204T138 215T170 230T210 250L74 315Q65 324 65 338Q65 353 74 363T98 374Q106 374 116 368T171 328L229 286Z"></path></g><g data-mml-node="mn" transform="translate(5409.1,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>h</mi><mi>t</mi><mo stretchy="false">[</mo><mn>0</mn><mo stretchy="false">]</mo><mo>.</mo><mi>u</mi><mi>s</mi><mi>e</mi><mi>d</mi><mo>âˆ—</mo><mn>2</mn></math></mjx-assistive-mml></mjx-container> çš„ <mjx-container class="MathJax" jax="SVG" style="position:relative;"><svg style="vertical-align:0;" xmlns="http://www.w3.org/2000/svg" width="2.279ex" height="1.528ex" role="img" focusable="false" viewBox="0 -675.5 1007.3 675.5" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mi>n</mi></msup></math></mjx-assistive-mml></mjx-container></li><li>å¦‚æœæ‰§è¡Œçš„æ˜¯æ”¶ç¼©æ“ä½œï¼Œht[1] çš„å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äº <mjx-container class="MathJax" jax="SVG" style="position:relative;"><svg style="vertical-align:-0.566ex;" xmlns="http://www.w3.org/2000/svg" width="10.101ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 4464.7 1000" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g><g data-mml-node="mi" transform="translate(576,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mo" transform="translate(937,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(1215,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(1715,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g><g data-mml-node="mo" transform="translate(1993,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mi" transform="translate(2437.7,0)"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(3009.7,0)"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mi" transform="translate(3478.7,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mi" transform="translate(3944.7,0)"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>h</mi><mi>t</mi><mo stretchy="false">[</mo><mn>0</mn><mo stretchy="false">]</mo><mo>.</mo><mi>u</mi><mi>s</mi><mi>e</mi><mi>d</mi></math></mjx-assistive-mml></mjx-container> çš„ <mjx-container class="MathJax" jax="SVG" style="position:relative;"><svg style="vertical-align:0;" xmlns="http://www.w3.org/2000/svg" width="2.279ex" height="1.528ex" role="img" focusable="false" viewBox="0 -675.5 1007.3 675.5" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mi>n</mi></msup></math></mjx-assistive-mml></mjx-container></li></ul></li><li>å°†ä¿å­˜åœ¨ ht[0] ä¸­æ‰€æœ‰çš„é”®å€¼å¯¹é‡æ–°è®¡ç®—å“ˆå¸Œå€¼å’Œç´¢å¼•å€¼ï¼Œè¿ç§»åˆ° ht[1] ä¸Š</li><li>å½“ ht[0] åŒ…å«çš„æ‰€æœ‰é”®å€¼å¯¹éƒ½è¿ç§»åˆ°äº† ht[1] ä¹‹åï¼ˆht[0] å˜ä¸ºç©ºè¡¨ï¼‰ï¼Œé‡Šæ”¾ ht[0]ï¼Œå°† ht[1] è®¾ç½®ä¸º ht[0]ï¼Œå¹¶åœ¨ ht[1] åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºç™½å“ˆå¸Œè¡¨ï¼Œä¸ºä¸‹ä¸€æ¬¡ rehash åšå‡†å¤‡</li></ul><p>å¦‚æœå“ˆå¸Œè¡¨é‡Œä¿å­˜çš„é”®å€¼å¯¹æ•°é‡å¾ˆå°‘ï¼Œrehash å°±å¯ä»¥åœ¨ç¬é—´å®Œæˆï¼Œä½†æ˜¯å¦‚æœå“ˆå¸Œè¡¨é‡Œæ•°æ®å¾ˆå¤šï¼Œé‚£ä¹ˆè¦ä¸€æ¬¡æ€§å°†è¿™äº›é”®å€¼å¯¹å…¨éƒ¨ rehash åˆ° ht[1] éœ€è¦å¤§é‡è®¡ç®—ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å™¨åœ¨ä¸€æ®µæ—¶é—´å†…åœæ­¢æœåŠ¡</p><p>Redis å¯¹ rehash åšäº†ä¼˜åŒ–ï¼Œä½¿ rehash çš„åŠ¨ä½œå¹¶ä¸æ˜¯ä¸€æ¬¡æ€§ã€é›†ä¸­å¼çš„å®Œæˆï¼Œè€Œæ˜¯åˆ†å¤šæ¬¡ï¼Œæ¸è¿›å¼çš„å®Œæˆï¼Œåˆå«<strong>æ¸è¿›å¼ rehash</strong></p><ul><li>ä¸º ht[1] åˆ†é…ç©ºé—´ï¼Œæ­¤æ—¶å­—å…¸åŒæ—¶æŒæœ‰ ht[0] å’Œ ht[1] ä¸¤ä¸ªå“ˆå¸Œè¡¨</li><li>åœ¨å­—å…¸ä¸­ç»´æŠ¤äº†ä¸€ä¸ªç´¢å¼•è®¡æ•°å™¨å˜é‡ rehashidxï¼Œå¹¶å°†å˜é‡çš„å€¼è®¾ä¸º 0ï¼Œè¡¨ç¤º rehash æ­£å¼å¼€å§‹</li><li>åœ¨ rehash è¿›è¡ŒæœŸé—´ï¼Œæ¯æ¬¡å¯¹å­—å…¸æ‰§è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œæ—¶ï¼Œç¨‹åºé™¤äº†æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œä»¥å¤–ï¼Œè¿˜ä¼šé¡ºå¸¦å°† ht[0] å“ˆå¸Œè¡¨åœ¨ rehashidx ç´¢å¼•ä¸Šçš„æ‰€æœ‰é”®å€¼å¯¹ rehash åˆ° ht[1]ï¼Œrehash å®Œæˆä¹‹å<strong>å°† rehashidx å±æ€§çš„å€¼å¢ä¸€</strong></li><li>éšç€å­—å…¸æ“ä½œçš„ä¸æ–­æ‰§è¡Œï¼Œæœ€ç»ˆåœ¨æŸä¸ªæ—¶é—´ç‚¹ ht[0] çš„æ‰€æœ‰é”®å€¼å¯¹éƒ½è¢« rehash è‡³ ht[1]ï¼Œå°† rehashidx å±æ€§çš„å€¼è®¾ä¸º -1</li></ul><p>æ¸è¿›å¼ rehash é‡‡ç”¨<strong>åˆ†è€Œæ²»ä¹‹</strong>çš„æ–¹å¼ï¼Œå°† rehash é”®å€¼å¯¹æ‰€éœ€çš„è®¡ç®—å·¥ä½œå‡æ‘Šåˆ°å¯¹å­—å…¸çš„æ¯ä¸ªæ·»åŠ ã€åˆ é™¤ã€æŸ¥æ‰¾å’Œæ›´æ–°æ“ä½œä¸Šï¼Œä»è€Œé¿å…äº†é›†ä¸­å¼ rehash å¸¦æ¥çš„åºå¤§è®¡ç®—é‡</p><p>æ¸è¿›å¼ rehash æœŸé—´çš„å“ˆå¸Œè¡¨æ“ä½œï¼š</p><ul><li>å­—å…¸çš„æŸ¥æ‰¾ã€åˆ é™¤ã€æ›´æ–°æ“ä½œä¼šåœ¨ä¸¤ä¸ªå“ˆå¸Œè¡¨ä¸Šè¿›è¡Œï¼Œæ¯”å¦‚æŸ¥æ‰¾ä¸€ä¸ªé”®ä¼šå…ˆåœ¨ ht[0] ä¸ŠæŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾ä¸åˆ°å°±å» ht[1] ç»§ç»­æŸ¥æ‰¾</li><li>å­—å…¸çš„æ·»åŠ æ“ä½œä¼šç›´æ¥åœ¨ ht[1] ä¸Šæ·»åŠ ï¼Œä¸åœ¨ ht[0] ä¸Šè¿›è¡Œä»»ä½•æ·»åŠ </li></ul><hr><h3 id="è·³è·ƒè¡¨" tabindex="-1"><a class="header-anchor" href="#è·³è·ƒè¡¨" aria-hidden="true">#</a> è·³è·ƒè¡¨</h3><h4 id="åº•å±‚ç»“æ„" tabindex="-1"><a class="header-anchor" href="#åº•å±‚ç»“æ„" aria-hidden="true">#</a> åº•å±‚ç»“æ„</h4><p>è·³è·ƒè¡¨ï¼ˆskiplistï¼‰æ˜¯ä¸€ç§æœ‰åºï¼ˆ<strong>é»˜è®¤å‡åº</strong>ï¼‰çš„æ•°æ®ç»“æ„ï¼Œåœ¨é“¾è¡¨çš„åŸºç¡€ä¸Š<strong>å¢åŠ äº†å¤šçº§ç´¢å¼•ä»¥æå‡æŸ¥æ‰¾çš„æ•ˆç‡</strong>ï¼Œç´¢å¼•æ˜¯å å†…å­˜çš„ï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ª<strong>ç©ºé—´æ¢æ—¶é—´</strong>çš„æ–¹æ¡ˆï¼Œè·³è¡¨å¹³å‡ O(logN)ã€æœ€å O(N) å¤æ‚åº¦çš„èŠ‚ç‚¹æŸ¥æ‰¾ï¼Œæ•ˆç‡ä¸å¹³è¡¡æ ‘ç›¸å½“ä½†æ˜¯å®ç°æ›´ç®€å•</p><p>åŸå§‹é“¾è¡¨ä¸­å­˜å‚¨çš„æœ‰å¯èƒ½æ˜¯å¾ˆå¤§çš„å¯¹è±¡ï¼Œè€Œç´¢å¼•ç»“ç‚¹åªéœ€è¦å­˜å‚¨å…³é”®å€¼å’Œå‡ ä¸ªæŒ‡é’ˆï¼Œå¹¶ä¸éœ€è¦å­˜å‚¨å¯¹è±¡ï¼Œå› æ­¤å½“èŠ‚ç‚¹æœ¬èº«æ¯”è¾ƒå¤§æˆ–è€…å…ƒç´ æ•°é‡æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œå…¶ä¼˜åŠ¿å¯ä»¥è¢«æ”¾å¤§ï¼Œè€Œç¼ºç‚¹ï¼ˆå å†…å­˜ï¼‰åˆ™å¯ä»¥å¿½ç•¥</p><p>Redis åªåœ¨ä¸¤ä¸ªåœ°æ–¹åº”ç”¨äº†è·³è·ƒè¡¨ï¼Œä¸€ä¸ªæ˜¯å®ç°æœ‰åºé›†åˆé”®ï¼Œå¦ä¸€ä¸ªæ˜¯åœ¨é›†ç¾¤èŠ‚ç‚¹ä¸­ç”¨ä½œå†…éƒ¨æ•°æ®ç»“æ„</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">zskiplist</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¡¨å¤´èŠ‚ç‚¹å’Œè¡¨å°¾èŠ‚ç‚¹ï¼ŒO(1) çš„æ—¶é—´å¤æ‚åº¦å®šä½å¤´å°¾èŠ‚ç‚¹</span>
    <span class="token keyword">struct</span> <span class="token class-name">skiplistNode</span> <span class="token operator">*</span>head<span class="token punctuation">,</span> <span class="token operator">*</span>tail<span class="token punctuation">;</span>
    
    <span class="token comment">// è¡¨çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯è¡¨å†…çš„èŠ‚ç‚¹æ•°é‡ (è¡¨å¤´èŠ‚ç‚¹ä¸è®¡ç®—åœ¨å†…)</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> length<span class="token punctuation">;</span>
    
    <span class="token comment">// è¡¨ä¸­å±‚æ•°æœ€å¤§çš„èŠ‚ç‚¹çš„å±‚æ•° (è¡¨å¤´èŠ‚ç‚¹çš„å±‚é«˜ä¸è®¡ç®—åœ¨å†…)</span>
    <span class="token keyword">int</span> level
<span class="token punctuation">}</span> zskiplist<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">zskiplistNode</span> <span class="token punctuation">{</span>
    <span class="token comment">// å±‚</span>
    <span class="token keyword">struct</span> <span class="token class-name">zskiplistLevel</span> <span class="token punctuation">{</span>
        <span class="token comment">// å‰è¿›æŒ‡é’ˆ</span>
        <span class="token keyword">struct</span> <span class="token class-name">zskiplistNode</span> <span class="token operator">*</span>forward<span class="token punctuation">;</span>
        <span class="token comment">// è·¨åº¦</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> span<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> level<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">// åé€€æŒ‡é’ˆ</span>
    <span class="token keyword">struct</span> <span class="token class-name">zskiplistNode</span> <span class="token operator">*</span>backward<span class="token punctuation">;</span>
    
    <span class="token comment">// åˆ†å€¼</span>
    <span class="token keyword">double</span> score<span class="token punctuation">;</span>
    
    <span class="token comment">// æˆå‘˜å¯¹è±¡</span>
    robj <span class="token operator">*</span>obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span> zskiplistNode<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-è·³è¡¨åº•å±‚ç»“æ„.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h4 id="å±æ€§åˆ†æ" tabindex="-1"><a class="header-anchor" href="#å±æ€§åˆ†æ" aria-hidden="true">#</a> å±æ€§åˆ†æ</h4><p>å±‚ï¼šlevel æ•°ç»„åŒ…å«å¤šä¸ªå…ƒç´ ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«æŒ‡å‘å…¶ä»–èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚æ ¹æ®å¹•æ¬¡å®šå¾‹ï¼ˆpower lawï¼Œè¶Šå¤§çš„æ•°å‡ºç°çš„æ¦‚ç‡è¶Šå°ï¼‰<strong>éšæœº</strong>ç”Ÿæˆä¸€ä¸ªä»‹äº 1 å’Œ 32 ä¹‹é—´çš„å€¼ï¼ˆRedis5 ä¹‹åæœ€å¤§ä¸º 64ï¼‰ä½œä¸º level æ•°ç»„çš„å¤§å°ï¼Œè¿™ä¸ªå¤§å°å°±æ˜¯å±‚çš„é«˜åº¦ï¼ŒèŠ‚ç‚¹çš„ç¬¬ä¸€å±‚æ˜¯ level[0] = L1</p><p>å‰è¿›æŒ‡é’ˆï¼šforward ç”¨äºä»è¡¨å¤´åˆ°è¡¨å°¾æ–¹å‘<strong>æ­£åºï¼ˆå‡åºï¼‰éå†èŠ‚ç‚¹</strong>ï¼Œé‡åˆ° NULL åœæ­¢éå†</p><p>è·¨åº¦ï¼šspan ç”¨äºè®°å½•ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è·ç¦»ï¼Œç”¨æ¥è®¡ç®—æ’ä½ï¼ˆrankï¼‰ï¼š</p><ul><li><p>ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„è·¨åº¦è¶Šå¤§ç›¸è·çš„å°±è¶Šè¿œï¼ŒæŒ‡å‘ NULL çš„æ‰€æœ‰å‰è¿›æŒ‡é’ˆçš„è·¨åº¦éƒ½ä¸º 0</p></li><li><p>åœ¨æŸ¥æ‰¾æŸä¸ªèŠ‚ç‚¹çš„è¿‡ç¨‹ä¸­ï¼Œ<strong>å°†æ²¿é€”è®¿é—®è¿‡çš„æ‰€æœ‰å±‚çš„è·¨åº¦ç´¯è®¡èµ·æ¥ï¼Œç»“æœå°±æ˜¯ç›®æ ‡èŠ‚ç‚¹åœ¨è·³è·ƒè¡¨ä¸­çš„æ’ä½</strong>ï¼ŒæŒ‰ç…§ä¸Šå›¾æ‰€ç¤ºï¼š</p><p>æŸ¥æ‰¾åˆ†å€¼ä¸º 3.0 çš„èŠ‚ç‚¹ï¼Œæ²¿é€”ç»å†çš„å±‚ï¼šæŸ¥æ‰¾çš„è¿‡ç¨‹åªç»è¿‡äº†ä¸€ä¸ªå±‚ï¼Œå¹¶ä¸”å±‚çš„è·¨åº¦ä¸º 3ï¼Œæ‰€ä»¥ç›®æ ‡èŠ‚ç‚¹åœ¨è·³è·ƒè¡¨ä¸­çš„æ’ä½ä¸º 3</p><p>æŸ¥æ‰¾åˆ†å€¼ä¸º 2.0 çš„èŠ‚ç‚¹ï¼Œæ²¿é€”ç»å†çš„å±‚ï¼šç»è¿‡äº†ä¸¤ä¸ªè·¨åº¦ä¸º 1 çš„èŠ‚ç‚¹ï¼Œå› æ­¤å¯ä»¥è®¡ç®—å‡ºç›®æ ‡èŠ‚ç‚¹åœ¨è·³è·ƒè¡¨ä¸­çš„æ’ä½ä¸º 2</p></li></ul><p>åé€€æŒ‡é’ˆï¼šbackward ç”¨äºä»è¡¨å°¾åˆ°è¡¨å¤´æ–¹å‘<strong>é€†åºï¼ˆé™åºï¼‰éå†èŠ‚ç‚¹</strong></p><p>åˆ†å€¼ï¼šscore å±æ€§ä¸€ä¸ª double ç±»å‹çš„æµ®ç‚¹æ•°ï¼Œè·³è·ƒè¡¨ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½æŒ‰åˆ†å€¼ä»å°åˆ°å¤§æ¥æ’åº</p><p>æˆå‘˜å¯¹è±¡ï¼šobj å±æ€§æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª SDS å­—ç¬¦ä¸²å¯¹è±¡ã€‚åŒä¸€ä¸ªè·³è·ƒè¡¨ä¸­ï¼Œå„ä¸ªèŠ‚ç‚¹ä¿å­˜çš„<strong>æˆå‘˜å¯¹è±¡å¿…é¡»æ˜¯å”¯ä¸€çš„</strong>ï¼Œä½†æ˜¯å¤šä¸ªèŠ‚ç‚¹ä¿å­˜çš„åˆ†å€¼å¯ä»¥æ˜¯ç›¸åŒçš„ï¼Œåˆ†å€¼ç›¸åŒçš„èŠ‚ç‚¹å°†æŒ‰ç…§æˆå‘˜å¯¹è±¡åœ¨å­—å…¸åºä¸­çš„å¤§å°æ¥è¿›è¡Œæ’åºï¼ˆä»å°åˆ°å¤§ï¼‰</p><p>ä¸ªäººç¬”è®°ï¼šJUC â†’ å¹¶å‘åŒ… â†’ ConcurrentSkipListMap è¯¦è§£è·³è·ƒè¡¨</p><hr><h3 id="æ•´æ•°é›†åˆ" tabindex="-1"><a class="header-anchor" href="#æ•´æ•°é›†åˆ" aria-hidden="true">#</a> æ•´æ•°é›†åˆ</h3><h4 id="åº•å±‚ç»“æ„-1" tabindex="-1"><a class="header-anchor" href="#åº•å±‚ç»“æ„-1" aria-hidden="true">#</a> åº•å±‚ç»“æ„</h4><p>æ•´æ•°é›†åˆï¼ˆintsetï¼‰æ˜¯ç”¨äºä¿å­˜æ•´æ•°å€¼çš„é›†åˆæ•°æ®ç»“æ„ï¼Œæ˜¯ Redis é›†åˆé”®çš„åº•å±‚å®ç°ä¹‹ä¸€</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">intset</span> <span class="token punctuation">{</span>
	<span class="token comment">// ç¼–ç æ–¹å¼</span>
	<span class="token class-name">uint32_t</span> encoding<span class="token punctuation">;</span>
    
	<span class="token comment">// é›†åˆåŒ…å«çš„å…ƒç´ æ•°é‡ï¼Œä¹Ÿå°±æ˜¯ contents æ•°ç»„çš„é•¿åº¦</span>
	<span class="token class-name">uint32_t</span> length<span class="token punctuation">;</span>
    
	<span class="token comment">// ä¿å­˜å…ƒç´ çš„æ•°ç»„</span>
    <span class="token class-name">int8_t</span> contents<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> intset<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>encoding å–å€¼ä¸ºä¸‰ç§ï¼šINTSET_ENC_INT16ã€INTSET_ENC_INT32ã€INTSET_ENC_INT64</p><p>æ•´æ•°é›†åˆçš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ contents æ•°ç»„çš„ä¸€ä¸ªæ•°ç»„é¡¹ï¼ˆitemï¼‰ï¼Œåœ¨æ•°ç»„ä¸­æŒ‰å€¼çš„å¤§å°ä»å°åˆ°å¤§<strong>æœ‰åºæ’åˆ—</strong>ï¼Œå¹¶ä¸”æ•°ç»„ä¸­<strong>ä¸åŒ…å«ä»»ä½•é‡å¤é¡¹</strong>ã€‚è™½ç„¶ contents å±æ€§å£°æ˜ä¸º int8_t ç±»å‹ï¼Œä½†å®é™…ä¸Šæ•°ç»„å¹¶ä¸ä¿å­˜ä»»ä½• int8_t ç±»å‹çš„å€¼ï¼Œ çœŸæ­£ç±»å‹å–å†³äº encoding å±æ€§</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-æ•´æ•°é›†åˆåº•å±‚ç»“æ„.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>è¯´æ˜ï¼šåº•å±‚å­˜å‚¨ç»“æ„æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥ä¸ºäº†ä¿è¯æœ‰åºæ€§å’Œä¸é‡å¤æ€§ï¼Œæ¯æ¬¡æ·»åŠ ä¸€ä¸ªå…ƒç´ çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(N)</p><hr><h4 id="ç±»å‹å‡çº§" tabindex="-1"><a class="header-anchor" href="#ç±»å‹å‡çº§" aria-hidden="true">#</a> ç±»å‹å‡çº§</h4><p>æ•´æ•°é›†åˆæ·»åŠ çš„æ–°å…ƒç´ çš„ç±»å‹æ¯”é›†åˆç°æœ‰æ‰€æœ‰å…ƒç´ çš„ç±»å‹éƒ½è¦é•¿æ—¶ï¼Œéœ€è¦å…ˆè¿›è¡Œå‡çº§ï¼ˆupgradeï¼‰ï¼Œå‡çº§æµç¨‹ï¼š</p><ul><li><p>æ ¹æ®æ–°å…ƒç´ çš„ç±»å‹é•¿åº¦ä»¥åŠé›†åˆå…ƒç´ çš„æ•°é‡ï¼ˆåŒ…æ‹¬æ–°å…ƒç´ åœ¨å†…ï¼‰ï¼Œæ‰©å±•æ•´æ•°é›†åˆåº•å±‚æ•°ç»„çš„ç©ºé—´å¤§å°</p></li><li><p>å°†åº•å±‚æ•°ç»„ç°æœ‰çš„æ‰€æœ‰å…ƒç´ éƒ½è½¬æ¢æˆä¸æ–°å…ƒç´ ç›¸åŒçš„ç±»å‹ï¼Œå¹¶å°†è½¬æ¢åçš„å…ƒç´ æ”¾å…¥æ­£ç¡®çš„ä½ç½®ï¼Œæ”¾ç½®è¿‡ç¨‹ä¿è¯æ•°ç»„çš„æœ‰åºæ€§</p><p>å›¾ç¤º 32 * 4 = 128 ä½ï¼Œé¦–å…ˆå°† 3 æ”¾å…¥ç´¢å¼• 2ï¼ˆ64 ä½ - 95 ä½ï¼‰ï¼Œç„¶åå°† 2 æ”¾ç½®ç´¢å¼• 1ï¼Œå°† 1 æ”¾ç½®åœ¨ç´¢å¼• 0ï¼Œä»åå‘å‰ä¾æ¬¡æ”¾ç½®åœ¨å¯¹åº”çš„åŒºé—´ï¼Œæœ€åæ”¾ç½® 65535 å…ƒç´ åˆ°ç´¢å¼• 3ï¼ˆ96 ä½- 127 ä½ï¼‰ï¼Œä¿®æ”¹ length å±æ€§ä¸º 4</p></li><li><p>å°†æ–°å…ƒç´ æ·»åŠ åˆ°åº•å±‚æ•°ç»„é‡Œ</p></li></ul><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-æ•´æ•°é›†åˆå‡çº§.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>æ¯æ¬¡å‘æ•´æ•°é›†åˆæ·»åŠ æ–°å…ƒç´ éƒ½å¯èƒ½ä¼šå¼•èµ·å‡çº§ï¼Œè€Œæ¯æ¬¡å‡çº§éƒ½éœ€è¦å¯¹åº•å±‚æ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ è¿›è¡Œç±»å‹è½¬æ¢ï¼Œæ‰€ä»¥å‘æ•´æ•°é›†åˆæ·»åŠ æ–°å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦ä¸º O(N)</p><p>å¼•å‘å‡çº§çš„æ–°å…ƒç´ çš„é•¿åº¦æ€»æ˜¯æ¯”æ•´æ•°é›†åˆç°æœ‰æ‰€æœ‰å…ƒç´ çš„é•¿åº¦éƒ½å¤§ï¼Œæ‰€ä»¥è¿™ä¸ªæ–°å…ƒç´ çš„å€¼è¦ä¹ˆå°±å¤§äºæ‰€æœ‰ç°æœ‰å…ƒç´ ï¼Œè¦ä¹ˆå°±å°äºæ‰€æœ‰ç°æœ‰å…ƒç´ ï¼Œå‡çº§ä¹‹åæ–°å…ƒç´ çš„æ‘†æ”¾ä½ç½®ï¼š</p><ul><li>åœ¨æ–°å…ƒç´ å°äºæ‰€æœ‰ç°æœ‰å…ƒç´ çš„æƒ…å†µä¸‹ï¼Œæ–°å…ƒç´ ä¼šè¢«æ”¾ç½®åœ¨åº•å±‚æ•°ç»„çš„æœ€å¼€å¤´ï¼ˆç´¢å¼• 0ï¼‰</li><li>åœ¨æ–°å…ƒç´ å¤§äºæ‰€æœ‰ç°æœ‰å…ƒç´ çš„æƒ…å†µä¸‹ï¼Œæ–°å…ƒç´ ä¼šè¢«æ”¾ç½®åœ¨åº•å±‚æ•°ç»„çš„æœ€æœ«å°¾ï¼ˆç´¢å¼• length-1ï¼‰</li></ul><p>æ•´æ•°é›†åˆå‡çº§ç­–ç•¥çš„ä¼˜ç‚¹ï¼š</p><ul><li><p>æå‡æ•´æ•°é›†åˆçš„çµæ´»æ€§ï¼šC è¯­è¨€æ˜¯é™æ€ç±»å‹è¯­è¨€ï¼Œä¸ºäº†é¿å…ç±»å‹é”™è¯¯é€šå¸¸ä¸ä¼šå°†ä¸¤ç§ä¸åŒç±»å‹çš„å€¼æ”¾åœ¨åŒä¸€ä¸ªæ•°æ®ç»“æ„é‡Œé¢ï¼Œæ•´æ•°é›†åˆå¯ä»¥è‡ªåŠ¨å‡çº§åº•å±‚æ•°ç»„æ¥é€‚åº”æ–°å…ƒç´ ï¼Œæ‰€ä»¥å¯ä»¥éšæ„çš„æ·»åŠ æ•´æ•°</p></li><li><p>èŠ‚çº¦å†…å­˜ï¼šè¦è®©æ•°ç»„å¯ä»¥åŒæ—¶ä¿å­˜ int16ã€int32ã€int64 ä¸‰ç§ç±»å‹çš„å€¼ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ int64_t ç±»å‹çš„æ•°ç»„ä½œä¸ºæ•´æ•°é›†åˆçš„åº•å±‚å®ç°ï¼Œä½†æ˜¯ä¼šé€ æˆå†…å­˜æµªè´¹ï¼Œæ•´æ•°é›†åˆå¯ä»¥ç¡®ä¿å‡çº§æ“ä½œåªä¼šåœ¨æœ‰éœ€è¦çš„æ—¶å€™è¿›è¡Œï¼Œå°½é‡èŠ‚çœå†…å­˜</p></li></ul><p>æ•´æ•°é›†åˆ<strong>ä¸æ”¯æŒé™çº§æ“ä½œ</strong>ï¼Œä¸€æ—¦å¯¹æ•°ç»„è¿›è¡Œäº†å‡çº§ï¼Œç¼–ç å°±ä¼šä¸€ç›´ä¿æŒå‡çº§åçš„çŠ¶æ€</p><hr><h3 id="å‹ç¼©åˆ—è¡¨" tabindex="-1"><a class="header-anchor" href="#å‹ç¼©åˆ—è¡¨" aria-hidden="true">#</a> å‹ç¼©åˆ—è¡¨</h3><h4 id="åº•å±‚ç»“æ„-2" tabindex="-1"><a class="header-anchor" href="#åº•å±‚ç»“æ„-2" aria-hidden="true">#</a> åº•å±‚ç»“æ„</h4><p>å‹ç¼©åˆ—è¡¨ï¼ˆziplistï¼‰æ˜¯ Redis ä¸ºäº†èŠ‚çº¦å†…å­˜è€Œå¼€å‘çš„ï¼Œæ˜¯åˆ—è¡¨é”®å’Œå“ˆå¸Œé”®çš„åº•å±‚å®ç°ä¹‹ä¸€ã€‚æ˜¯ç”±ä¸€ç³»åˆ—ç‰¹æ®Šç¼–ç çš„è¿ç»­å†…å­˜å—ç»„æˆçš„é¡ºåºå‹ï¼ˆsequentialï¼‰æ•°æ®ç»“æ„ï¼Œä¸€ä¸ªå‹ç¼©åˆ—è¡¨å¯ä»¥åŒ…å«ä»»æ„å¤šä¸ªèŠ‚ç‚¹ï¼ˆentryï¼‰ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥ä¿å­˜ä¸€ä¸ªå­—èŠ‚æ•°ç»„æˆ–è€…ä¸€ä¸ªæ•´æ•°å€¼</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å‹ç¼©åˆ—è¡¨åº•å±‚ç»“æ„.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>zlbytesï¼šuint32_t ç±»å‹ 4 å­—èŠ‚ï¼Œè®°å½•æ•´ä¸ªå‹ç¼©åˆ—è¡¨å ç”¨çš„å†…å­˜å­—èŠ‚æ•°ï¼Œåœ¨å¯¹å‹ç¼©åˆ—è¡¨è¿›è¡Œå†…å­˜é‡åˆ†é…æˆ–è€…è®¡ç®— zlend çš„ä½ç½®æ—¶ä½¿ç”¨</li><li>zltailï¼šuint32_t ç±»å‹ 4 å­—èŠ‚ï¼Œè®°å½•å‹ç¼©åˆ—è¡¨è¡¨å°¾èŠ‚ç‚¹è·ç¦»èµ·å§‹åœ°å€æœ‰å¤šå°‘å­—èŠ‚ï¼Œé€šè¿‡è¿™ä¸ªåç§»é‡ç¨‹åºæ— é¡»éå†æ•´ä¸ªå‹ç¼©åˆ—è¡¨å°±å¯ä»¥ç¡®å®šè¡¨å°¾èŠ‚ç‚¹çš„åœ°å€</li><li>zllenï¼šuint16_t ç±»å‹ 2 å­—èŠ‚ï¼Œè®°å½•äº†å‹ç¼©åˆ—è¡¨åŒ…å«çš„èŠ‚ç‚¹æ•°é‡ï¼Œå½“è¯¥å±æ€§çš„å€¼å°äº UINT16_MAX (65535) æ—¶ï¼Œè¯¥å€¼å°±æ˜¯å‹ç¼©åˆ—è¡¨ä¸­èŠ‚ç‚¹çš„æ•°é‡ï¼›å½“è¿™ä¸ªå€¼ç­‰äº UINT16_MAX æ—¶èŠ‚ç‚¹çš„çœŸå®æ•°é‡éœ€è¦éå†æ•´ä¸ªå‹ç¼©åˆ—è¡¨æ‰èƒ½è®¡ç®—å¾—å‡º</li><li>entryXï¼šåˆ—è¡¨èŠ‚ç‚¹ï¼Œå‹ç¼©åˆ—è¡¨ä¸­çš„å„ä¸ªèŠ‚ç‚¹ï¼Œ<strong>èŠ‚ç‚¹çš„é•¿åº¦ç”±èŠ‚ç‚¹ä¿å­˜çš„å†…å®¹å†³å®š</strong></li><li>zlendï¼šuint8_t ç±»å‹ 1 å­—èŠ‚ï¼Œæ˜¯ä¸€ä¸ªç‰¹æ®Šå€¼ 0xFF (255)ï¼Œç”¨äºæ ‡è®°å‹ç¼©åˆ—è¡¨çš„æœ«ç«¯</li></ul><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å‹ç¼©åˆ—è¡¨ç¤ºä¾‹.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>åˆ—è¡¨ zlbytes å±æ€§çš„å€¼ä¸º 0x50 (åè¿›åˆ¶ 80)ï¼Œè¡¨ç¤ºå‹ç¼©åˆ—è¡¨çš„æ€»é•¿ä¸º 80 å­—èŠ‚ï¼Œåˆ—è¡¨ zltail å±æ€§çš„å€¼ä¸º 0x3c (åè¿›åˆ¶ 60)ï¼Œå‡è®¾è¡¨çš„èµ·å§‹åœ°å€ä¸º pï¼Œè®¡ç®—å¾—å‡ºè¡¨å°¾èŠ‚ç‚¹ entry3 çš„åœ°å€ p + 60</p><hr><h4 id="åˆ—è¡¨èŠ‚ç‚¹" tabindex="-1"><a class="header-anchor" href="#åˆ—è¡¨èŠ‚ç‚¹" aria-hidden="true">#</a> åˆ—è¡¨èŠ‚ç‚¹</h4><p>åˆ—è¡¨èŠ‚ç‚¹ entry çš„æ•°æ®ç»“æ„ï¼š</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å‹ç¼©åˆ—è¡¨èŠ‚ç‚¹.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>previous_entry_lengthï¼šä»¥å­—èŠ‚ä¸ºå•ä½è®°å½•äº†å‹ç¼©åˆ—è¡¨ä¸­å‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦ï¼Œç¨‹åºå¯ä»¥é€šè¿‡æŒ‡é’ˆè¿ç®—ï¼Œæ ¹æ®å½“å‰èŠ‚ç‚¹çš„èµ·å§‹åœ°å€æ¥è®¡ç®—å‡ºå‰ä¸€ä¸ªèŠ‚ç‚¹çš„èµ·å§‹åœ°å€ï¼Œå®Œæˆ<strong>ä»è¡¨å°¾å‘è¡¨å¤´éå†</strong>æ“ä½œ</p><ul><li>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å°äº 254 å­—èŠ‚ï¼Œè¯¥å±æ€§çš„é•¿åº¦ä¸º 1 å­—èŠ‚ï¼Œå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å°±ä¿å­˜åœ¨è¿™ä¸€ä¸ªå­—èŠ‚é‡Œ</li><li>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å¤§äºç­‰äº 254 å­—èŠ‚ï¼Œè¯¥å±æ€§çš„é•¿åº¦ä¸º 5 å­—èŠ‚ï¼Œå…¶ä¸­ç¬¬ä¸€å­—èŠ‚ä¼šè¢«è®¾ç½®ä¸º 0xFEï¼ˆåè¿›åˆ¶ 254ï¼‰ï¼Œä¹‹åçš„å››ä¸ªå­—èŠ‚åˆ™ç”¨äºä¿å­˜å‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦</li></ul><p>encodingï¼šè®°å½•äº†èŠ‚ç‚¹çš„ content å±æ€§æ‰€ä¿å­˜çš„æ•°æ®ç±»å‹å’Œé•¿åº¦</p><ul><li><p><strong>é•¿åº¦ä¸º 1 å­—èŠ‚ã€2 å­—èŠ‚æˆ–è€… 5 å­—èŠ‚</strong>ï¼Œå€¼çš„æœ€é«˜ä½ä¸º 00ã€01 æˆ–è€… 10 çš„æ˜¯å­—èŠ‚æ•°ç»„ç¼–ç ï¼Œæ•°ç»„çš„é•¿åº¦ç”±ç¼–ç é™¤å»æœ€é«˜ä¸¤ä½ä¹‹åçš„å…¶ä»–ä½è®°å½•ï¼Œä¸‹åˆ’çº¿ <code>_</code> è¡¨ç¤ºç•™ç©ºï¼Œè€Œ <code>b</code>ã€<code>x</code> ç­‰å˜é‡åˆ™ä»£è¡¨å®é™…çš„äºŒè¿›åˆ¶æ•°æ®</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å‹ç¼©åˆ—è¡¨å­—èŠ‚æ•°ç»„ç¼–ç .png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></li><li><p>é•¿åº¦ä¸º 1 å­—èŠ‚ï¼Œå€¼çš„æœ€é«˜ä½ä¸º 11 çš„æ˜¯æ•´æ•°ç¼–ç ï¼Œæ•´æ•°å€¼çš„ç±»å‹å’Œé•¿åº¦ç”±ç¼–ç é™¤å»æœ€é«˜ä¸¤ä½ä¹‹åçš„å…¶ä»–ä½è®°å½•</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å‹ç¼©åˆ—è¡¨æ•´æ•°ç¼–ç .png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></li></ul><p>contentï¼šæ¯ä¸ªå‹ç¼©åˆ—è¡¨èŠ‚ç‚¹å¯ä»¥ä¿å­˜ä¸€ä¸ªå­—èŠ‚æ•°ç»„æˆ–è€…ä¸€ä¸ªæ•´æ•°å€¼</p><ul><li><p>å­—èŠ‚æ•°ç»„å¯ä»¥æ˜¯ä»¥ä¸‹ä¸‰ç§é•¿åº¦çš„å…¶ä¸­ä¸€ç§ï¼š</p><ul><li><p>é•¿åº¦å°äºç­‰äº <mjx-container class="MathJax" jax="SVG" style="position:relative;"><svg style="vertical-align:-0.566ex;" xmlns="http://www.w3.org/2000/svg" width="10.038ex" height="2.452ex" role="img" focusable="false" viewBox="0 -833.9 4437 1083.9" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(500,0)"></path></g><g data-mml-node="mo" transform="translate(1000,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msup" transform="translate(1389,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mn" transform="translate(533,363) scale(0.707)"><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path></g></g><g data-mml-node="mo" transform="translate(2547.8,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(3548,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(4048,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>63</mn><mo stretchy="false">(</mo><msup><mn>2</mn><mn>6</mn></msup><mo>âˆ’</mo><mn>1</mn><mo stretchy="false">)</mo></math></mjx-assistive-mml></mjx-container> å­—èŠ‚çš„å­—èŠ‚æ•°ç»„</p></li><li><p>é•¿åº¦å°äºç­‰äº <mjx-container class="MathJax" jax="SVG" style="position:relative;"><svg style="vertical-align:-0.566ex;" xmlns="http://www.w3.org/2000/svg" width="14.232ex" height="2.47ex" role="img" focusable="false" viewBox="0 -841.7 6290.6 1091.7" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(500,0)"></path><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(1000,0)"></path><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z" transform="translate(1500,0)"></path><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(2000,0)"></path></g><g data-mml-node="mo" transform="translate(2500,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msup" transform="translate(2889,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(4401.3,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(5401.6,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(5901.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>16383</mn><mo stretchy="false">(</mo><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mn>14</mn></mrow></msup><mo>âˆ’</mo><mn>1</mn><mo stretchy="false">)</mo></math></mjx-assistive-mml></mjx-container> å­—èŠ‚çš„å­—èŠ‚æ•°ç»„</p></li><li><p>é•¿åº¦å°äºç­‰äº <mjx-container class="MathJax" jax="SVG" style="position:relative;"><svg style="vertical-align:-0.566ex;" xmlns="http://www.w3.org/2000/svg" width="19.888ex" height="2.452ex" role="img" focusable="false" viewBox="0 -833.9 8790.6 1083.9" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500,0)"></path><path data-c="39" d="M352 287Q304 211 232 211Q154 211 104 270T44 396Q42 412 42 436V444Q42 537 111 606Q171 666 243 666Q245 666 249 666T257 665H261Q273 665 286 663T323 651T370 619T413 560Q456 472 456 334Q456 194 396 97Q361 41 312 10T208 -22Q147 -22 108 7T68 93T121 149Q143 149 158 135T173 96Q173 78 164 65T148 49T135 44L131 43Q131 41 138 37T164 27T206 22H212Q272 22 313 86Q352 142 352 280V287ZM244 248Q292 248 321 297T351 430Q351 508 343 542Q341 552 337 562T323 588T293 615T246 625Q208 625 181 598Q160 576 154 546T147 441Q147 358 152 329T172 282Q197 248 244 248Z" transform="translate(1000,0)"></path><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z" transform="translate(1500,0)"></path><path data-c="39" d="M352 287Q304 211 232 211Q154 211 104 270T44 396Q42 412 42 436V444Q42 537 111 606Q171 666 243 666Q245 666 249 666T257 665H261Q273 665 286 663T323 651T370 619T413 560Q456 472 456 334Q456 194 396 97Q361 41 312 10T208 -22Q147 -22 108 7T68 93T121 149Q143 149 158 135T173 96Q173 78 164 65T148 49T135 44L131 43Q131 41 138 37T164 27T206 22H212Q272 22 313 86Q352 142 352 280V287ZM244 248Q292 248 321 297T351 430Q351 508 343 542Q341 552 337 562T323 588T293 615T246 625Q208 625 181 598Q160 576 154 546T147 441Q147 358 152 329T172 282Q197 248 244 248Z" transform="translate(2000,0)"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(2500,0)"></path><path data-c="37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z" transform="translate(3000,0)"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(3500,0)"></path><path data-c="39" d="M352 287Q304 211 232 211Q154 211 104 270T44 396Q42 412 42 436V444Q42 537 111 606Q171 666 243 666Q245 666 249 666T257 665H261Q273 665 286 663T323 651T370 619T413 560Q456 472 456 334Q456 194 396 97Q361 41 312 10T208 -22Q147 -22 108 7T68 93T121 149Q143 149 158 135T173 96Q173 78 164 65T148 49T135 44L131 43Q131 41 138 37T164 27T206 22H212Q272 22 313 86Q352 142 352 280V287ZM244 248Q292 248 321 297T351 430Q351 508 343 542Q341 552 337 562T323 588T293 615T246 625Q208 625 181 598Q160 576 154 546T147 441Q147 358 152 329T172 282Q197 248 244 248Z" transform="translate(4000,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(4500,0)"></path></g><g data-mml-node="mo" transform="translate(5000,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="msup" transform="translate(5389,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(6901.3,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(7901.6,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(8401.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>4294967295</mn><mo stretchy="false">(</mo><msup><mn>2</mn><mrow data-mjx-texclass="ORD"><mn>32</mn></mrow></msup><mo>âˆ’</mo><mn>1</mn><mo stretchy="false">)</mo></math></mjx-assistive-mml></mjx-container> å­—èŠ‚çš„å­—èŠ‚æ•°ç»„</p></li></ul></li><li><p>æ•´æ•°å€¼åˆ™å¯ä»¥æ˜¯ä»¥ä¸‹å…­ç§é•¿åº¦çš„å…¶ä¸­ä¸€ç§ï¼š</p><ul><li><p>4 ä½é•¿ï¼Œä»‹äº 0 è‡³ 12 ä¹‹é—´çš„æ— ç¬¦å·æ•´æ•°</p></li><li><p>1 å­—èŠ‚é•¿çš„æœ‰ç¬¦å·æ•´æ•°</p></li><li><p>3 å­—èŠ‚é•¿çš„æœ‰ç¬¦å·æ•´æ•°</p></li><li><p>int16_t ç±»å‹æ•´æ•°</p></li><li><p>int32_t ç±»å‹æ•´æ•°</p></li><li><p>int64_t ç±»å‹æ•´æ•°</p></li></ul></li></ul><hr><h4 id="è¿é”æ›´æ–°" tabindex="-1"><a class="header-anchor" href="#è¿é”æ›´æ–°" aria-hidden="true">#</a> è¿é”æ›´æ–°</h4><p>Redis å°†åœ¨ç‰¹æ®Šæƒ…å†µä¸‹äº§ç”Ÿçš„è¿ç»­å¤šæ¬¡ç©ºé—´æ‰©å±•æ“ä½œç§°ä¹‹ä¸ºè¿é”æ›´æ–°ï¼ˆcascade updateï¼‰</p><p>å‡è®¾åœ¨ä¸€ä¸ªå‹ç¼©åˆ—è¡¨ä¸­ï¼Œæœ‰å¤šä¸ªè¿ç»­çš„ã€é•¿åº¦ä»‹äº 250 åˆ° 253 å­—èŠ‚ä¹‹é—´çš„èŠ‚ç‚¹ e1 è‡³ eNã€‚å°†ä¸€ä¸ªé•¿åº¦å¤§äºç­‰äº 254 å­—èŠ‚çš„æ–°èŠ‚ç‚¹ new è®¾ç½®ä¸ºå‹ç¼©åˆ—è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œnew å°±æˆä¸º e1 çš„å‰ç½®èŠ‚ç‚¹ã€‚e1 çš„ previous_entry_length å±æ€§ä»…ä¸º 1 å­—èŠ‚ï¼Œæ— æ³•ä¿å­˜æ–°èŠ‚ç‚¹ new çš„é•¿åº¦ï¼Œæ‰€ä»¥è¦å¯¹å‹ç¼©åˆ—è¡¨æ‰§è¡Œç©ºé—´é‡åˆ†é…æ“ä½œï¼Œå¹¶å°† e1 èŠ‚ç‚¹çš„ previous_entry_length å±æ€§ä» 1 å­—èŠ‚é•¿æ‰©å±•ä¸º 5 å­—èŠ‚é•¿ã€‚ç”±äº e1 åŸæœ¬çš„é•¿åº¦ä»‹äº 250 è‡³ 253 å­—èŠ‚ä¹‹é—´ï¼Œæ‰€ä»¥æ‰©å±•å e1 çš„é•¿åº¦å°±å˜æˆäº† 254 è‡³ 257 å­—èŠ‚ä¹‹é—´ï¼Œå¯¼è‡´ e2 çš„ previous_entry_length å±æ€§æ— æ³•ä¿å­˜ e1 çš„é•¿åº¦ï¼Œç¨‹åºéœ€è¦ä¸æ–­åœ°å¯¹å‹ç¼©åˆ—è¡¨æ‰§è¡Œç©ºé—´é‡åˆ†é…æ“ä½œï¼Œç›´åˆ° eN ä¸ºæ­¢</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å‹ç¼©åˆ—è¡¨è¿é”æ›´æ–°1.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>åˆ é™¤èŠ‚ç‚¹ä¹Ÿå¯èƒ½ä¼šå¼•å‘è¿é”æ›´æ–°ï¼Œbig.length &gt;= 254ï¼Œsmall.length &lt; 254ï¼Œåˆ é™¤ small èŠ‚ç‚¹</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å‹ç¼©åˆ—è¡¨è¿é”æ›´æ–°2.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>è¿é”æ›´æ–°åœ¨æœ€åæƒ…å†µä¸‹éœ€è¦å¯¹å‹ç¼©åˆ—è¡¨æ‰§è¡Œ N æ¬¡ç©ºé—´é‡åˆ†é…ï¼Œæ¯æ¬¡é‡åˆ†é…çš„æœ€åå¤æ‚åº¦ä¸º O(N)ï¼Œæ‰€ä»¥è¿é”æ›´æ–°çš„æœ€åå¤æ‚åº¦ä¸º O(N^2)</p><p>è¯´æ˜ï¼šå°½ç®¡è¿é”æ›´æ–°çš„å¤æ‚åº¦è¾ƒé«˜ï¼Œä½†å‡ºç°çš„è®°å½•æ˜¯éå¸¸ä½çš„ï¼Œå³ä½¿å‡ºç°åªè¦è¢«æ›´æ–°çš„èŠ‚ç‚¹æ•°é‡ä¸å¤šï¼Œå°±ä¸ä¼šå¯¹æ€§èƒ½é€ æˆå½±å“</p><hr><h2 id="æ•°æ®ç±»å‹" tabindex="-1"><a class="header-anchor" href="#æ•°æ®ç±»å‹" aria-hidden="true">#</a> æ•°æ®ç±»å‹</h2><h3 id="redisobj" tabindex="-1"><a class="header-anchor" href="#redisobj" aria-hidden="true">#</a> redisObj</h3><h4 id="å¯¹è±¡ç³»ç»Ÿ" tabindex="-1"><a class="header-anchor" href="#å¯¹è±¡ç³»ç»Ÿ" aria-hidden="true">#</a> å¯¹è±¡ç³»ç»Ÿ</h4><p>Redis ä½¿ç”¨å¯¹è±¡æ¥è¡¨ç¤ºæ•°æ®åº“ä¸­çš„é”®å’Œå€¼ï¼Œå½“åœ¨ Redis æ•°æ®åº“ä¸­æ–°åˆ›å»ºä¸€ä¸ªé”®å€¼å¯¹æ—¶è‡³å°‘ä¼šåˆ›å»ºä¸¤ä¸ªå¯¹è±¡ï¼Œä¸€ä¸ªå¯¹è±¡ç”¨ä½œé”®å€¼å¯¹çš„é”®ï¼ˆ<strong>é”®å¯¹è±¡</strong>ï¼‰ï¼Œå¦ä¸€ä¸ªå¯¹è±¡ç”¨ä½œé”®å€¼å¯¹çš„å€¼ï¼ˆ<strong>å€¼å¯¹è±¡</strong>ï¼‰</p><p>Redis ä¸­å¯¹è±¡ç”±ä¸€ä¸ª redisObject ç»“æ„è¡¨ç¤ºï¼Œè¯¥ç»“æ„ä¸­å’Œä¿å­˜æ•°æ®æœ‰å…³çš„ä¸‰ä¸ªå±æ€§åˆ†åˆ«æ˜¯ typeã€ encodingã€ptrï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisObiect</span> <span class="token punctuation">{</span>
	<span class="token comment">// ç±»å‹</span>
	<span class="token keyword">unsigned</span> type<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
	<span class="token comment">// ç¼–ç </span>
	<span class="token keyword">unsigned</span> encoding<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
	<span class="token comment">// æŒ‡å‘åº•å±‚æ•°æ®ç»“æ„çš„æŒ‡é’ˆ</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
    
    <span class="token comment">// ....</span>
<span class="token punctuation">}</span> robj<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Redis å¹¶æ²¡æœ‰ç›´æ¥ä½¿ç”¨æ•°æ®ç»“æ„æ¥å®ç°é”®å€¼å¯¹æ•°æ®åº“ï¼Œè€Œæ˜¯åŸºäºè¿™äº›æ•°æ®ç»“æ„åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ç³»ç»Ÿï¼ŒåŒ…å«å­—ç¬¦ä¸²å¯¹è±¡ã€åˆ—è¡¨å¯¹è±¡ã€å“ˆå¸Œå¯¹è±¡ã€é›†åˆå¯¹è±¡å’Œæœ‰åºé›†åˆå¯¹è±¡è¿™äº”ç§ç±»å‹çš„å¯¹è±¡ï¼Œè€Œæ¯ç§å¯¹è±¡åˆé€šè¿‡ä¸åŒçš„ç¼–ç æ˜ å°„åˆ°ä¸åŒçš„åº•å±‚æ•°æ®ç»“æ„</p><p>Redis æ˜¯ä¸€ä¸ª Map ç±»å‹ï¼Œå…¶ä¸­æ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯é‡‡ç”¨ key : value çš„å½¢å¼å­˜å‚¨ï¼Œ<strong>é”®å¯¹è±¡éƒ½æ˜¯å­—ç¬¦ä¸²å¯¹è±¡</strong>ï¼Œè€Œå€¼å¯¹è±¡æœ‰äº”ç§åŸºæœ¬ç±»å‹å’Œä¸‰ç§é«˜çº§ç±»å‹å¯¹è±¡</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å¯¹è±¡ç¼–ç .png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>å¯¹ä¸€ä¸ªæ•°æ®åº“é”®æ‰§è¡Œ TYPE å‘½ä»¤ï¼Œè¿”å›çš„ç»“æœä¸ºæ•°æ®åº“é”®å¯¹åº”çš„å€¼å¯¹è±¡çš„ç±»å‹ï¼Œè€Œä¸æ˜¯é”®å¯¹è±¡çš„ç±»å‹</li><li>å¯¹ä¸€ä¸ªæ•°æ®åº“é”®æ‰§è¡Œ OBJECT ENCODING å‘½ä»¤ï¼ŒæŸ¥çœ‹æ•°æ®åº“é”®å¯¹åº”çš„å€¼å¯¹è±¡çš„ç¼–ç </li></ul><hr><h4 id="å‘½ä»¤å¤šæ€" tabindex="-1"><a class="header-anchor" href="#å‘½ä»¤å¤šæ€" aria-hidden="true">#</a> å‘½ä»¤å¤šæ€</h4><p>Redis ä¸­ç”¨äºæ“ä½œé”®çš„å‘½ä»¤åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š</p><ul><li>ä¸€ç§å‘½ä»¤å¯ä»¥å¯¹ä»»ä½•ç±»å‹çš„é”®æ‰§è¡Œï¼Œæ¯”å¦‚è¯´ DEL ã€EXPIREã€RENAMEã€ TYPE ç­‰ï¼ˆåŸºäºç±»å‹çš„å¤šæ€ï¼‰</li><li>åªèƒ½å¯¹ç‰¹å®šç±»å‹çš„é”®æ‰§è¡Œï¼Œæ¯”å¦‚ SET åªèƒ½å¯¹å­—ç¬¦ä¸²é”®æ‰§è¡Œã€HSET å¯¹å“ˆå¸Œé”®æ‰§è¡Œã€SADD å¯¹é›†åˆé”®æ‰§è¡Œï¼Œå¦‚æœç±»å‹æ­¥åŒ¹é…ä¼šæŠ¥ç±»å‹é”™è¯¯ï¼š <code>(error) WRONGTYPE Operation against a key holding the wrong kind of value</code></li></ul><p>Redis ä¸ºäº†ç¡®ä¿åªæœ‰æŒ‡å®šç±»å‹çš„é”®å¯ä»¥æ‰§è¡ŒæŸäº›ç‰¹å®šçš„å‘½ä»¤ï¼Œåœ¨æ‰§è¡Œç±»å‹ç‰¹å®šçš„å‘½ä»¤ä¹‹å‰ï¼Œå…ˆé€šè¿‡å€¼å¯¹è±¡ redisObject ç»“æ„ type å±æ€§æ£€æŸ¥æ“ä½œç±»å‹æ˜¯å¦æ­£ç¡®ï¼Œç„¶åå†å†³å®šæ˜¯å¦æ‰§è¡ŒæŒ‡å®šçš„å‘½ä»¤</p><p>å¯¹äºå¤šæ€å‘½ä»¤ï¼Œæ¯”å¦‚åˆ—è¡¨å¯¹è±¡æœ‰ ziplist å’Œ linkedlist ä¸¤ç§å®ç°æ–¹å¼ï¼Œé€šè¿‡ redisObject ç»“æ„ encoding å±æ€§ç¡®å®šå…·ä½“çš„ç¼–ç ç±»å‹ï¼Œåº•å±‚è°ƒç”¨å¯¹åº”çš„ API å®ç°å…·ä½“çš„æ“ä½œï¼ˆåŸºäºç¼–ç çš„å¤šæ€ï¼‰</p><hr><h4 id="å†…å­˜å›æ”¶" tabindex="-1"><a class="header-anchor" href="#å†…å­˜å›æ”¶" aria-hidden="true">#</a> å†…å­˜å›æ”¶</h4><p>å¯¹è±¡çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå¯ä»¥åˆ’åˆ†ä¸ºåˆ›å»ºå¯¹è±¡ã€ æ“ä½œå¯¹è±¡ã€ é‡Šæ”¾å¯¹è±¡ä¸‰ä¸ªé˜¶æ®µ</p><p>C è¯­è¨€æ²¡æœ‰è‡ªåŠ¨å›æ”¶å†…å­˜çš„åŠŸèƒ½ï¼Œæ‰€ä»¥ Redis åœ¨å¯¹è±¡ç³»ç»Ÿä¸­æ„å»ºäº†å¼•ç”¨è®¡æ•°ï¼ˆreference countingï¼‰æŠ€æœ¯å®ç°çš„å†…å­˜å›æ”¶æœºåˆ¶ï¼Œç¨‹åºå¯ä»¥è·Ÿè¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¿¡æ¯ï¼Œåœ¨é€‚å½“çš„æ—¶å€™è‡ªåŠ¨é‡Šæ”¾å¯¹è±¡å¹¶è¿›è¡Œå†…å­˜å›æ”¶</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisObiect</span> <span class="token punctuation">{</span>
	<span class="token comment">// å¼•ç”¨è®¡æ•°</span>
	<span class="token keyword">int</span> refcount<span class="token punctuation">;</span>
<span class="token punctuation">}</span> robj<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¿¡æ¯ä¼šéšç€å¯¹è±¡çš„ä½¿ç”¨çŠ¶æ€è€Œä¸æ–­å˜åŒ–ï¼Œåˆ›å»ºæ—¶å¼•ç”¨è®¡æ•° refcount åˆå§‹åŒ–ä¸º 1ï¼Œæ¯æ¬¡è¢«ä¸€ä¸ªæ–°ç¨‹åºä½¿ç”¨æ—¶å¼•ç”¨è®¡æ•°åŠ  1ï¼Œå½“å¯¹è±¡ä¸å†è¢«ä¸€ä¸ªç¨‹åºä½¿ç”¨æ—¶å¼•ç”¨è®¡æ•°å€¼ä¼šè¢«å‡ 1ï¼Œå½“å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å€¼å˜ä¸º 0 æ—¶ï¼Œå¯¹è±¡æ‰€å ç”¨çš„å†…å­˜ä¼šè¢«é‡Šæ”¾</p><hr><h4 id="å¯¹è±¡å…±äº«" tabindex="-1"><a class="header-anchor" href="#å¯¹è±¡å…±äº«" aria-hidden="true">#</a> å¯¹è±¡å…±äº«</h4><p>å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å±æ€§å¸¦æœ‰å¯¹è±¡å…±äº«çš„ä½œç”¨ï¼Œå…±äº«å¯¹è±¡æœºåˆ¶æ›´èŠ‚çº¦å†…å­˜ï¼Œæ•°æ®åº“ä¸­ä¿å­˜çš„ç›¸åŒå€¼å¯¹è±¡è¶Šå¤šï¼ŒèŠ‚çº¦çš„å†…å­˜å°±è¶Šå¤š</p><p>è®©å¤šä¸ªé”®å…±äº«ä¸€ä¸ªå¯¹è±¡çš„æ­¥éª¤ï¼š</p><ul><li><p>å°†æ•°æ®åº“é”®çš„å€¼æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªç°æœ‰çš„å€¼å¯¹è±¡</p></li><li><p>å°†è¢«å…±äº«çš„å€¼å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å¢ä¸€</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å¯¹è±¡å…±äº«.png" style="zoom:67%;"></li></ul><p>Redis åœ¨åˆå§‹åŒ–æœåŠ¡å™¨æ—¶åˆ›å»ºä¸€ä¸‡ä¸ªï¼ˆé…ç½®æ–‡ä»¶å¯ä»¥ä¿®æ”¹ï¼‰å­—ç¬¦ä¸²å¯¹è±¡ï¼ŒåŒ…å«äº†<strong>ä» 0 åˆ° 9999 çš„æ‰€æœ‰æ•´æ•°å€¼</strong>ï¼Œå½“æœåŠ¡å™¨éœ€è¦ç”¨åˆ°å€¼ä¸º 0 åˆ° 9999 çš„å­—ç¬¦ä¸²å¯¹è±¡æ—¶ï¼ŒæœåŠ¡å™¨å°±ä¼šä½¿ç”¨è¿™äº›å…±äº«å¯¹è±¡ï¼Œè€Œä¸æ˜¯æ–°åˆ›å»ºå¯¹è±¡</p><p>æ¯”å¦‚åˆ›å»ºä¸€ä¸ªå€¼ä¸º 100 çš„é”® Aï¼Œå¹¶ä½¿ç”¨ OBJECT REFCOUNT å‘½ä»¤æŸ¥çœ‹é”® A çš„å€¼å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œä¼šå‘ç°å€¼å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º 2ï¼Œå¼•ç”¨è¿™ä¸ªå€¼å¯¹è±¡çš„ä¸¤ä¸ªç¨‹åºåˆ†åˆ«æ˜¯æŒæœ‰è¿™ä¸ªå€¼å¯¹è±¡çš„æœåŠ¡å™¨ç¨‹åºï¼Œä»¥åŠå…±äº«è¿™ä¸ªå€¼å¯¹è±¡çš„é”® A</p><p>å…±äº«å¯¹è±¡åœ¨åµŒå¥—äº†å­—ç¬¦ä¸²å¯¹è±¡çš„å¯¹è±¡ï¼ˆlinkedlist ç¼–ç çš„åˆ—è¡¨ã€hashtable ç¼–ç çš„å“ˆå¸Œã€zset ç¼–ç çš„æœ‰åºé›†åˆï¼‰ä¸­ä¹Ÿèƒ½ä½¿ç”¨</p><p>Redis ä¸å…±äº«åŒ…å«å­—ç¬¦ä¸²å¯¹è±¡çš„åŸå› ï¼šéªŒè¯å…±äº«å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡æ˜¯å¦ç›¸åŒçš„å¤æ‚åº¦è¶Šé«˜ï¼Œæ¶ˆè€—çš„ CPU æ—¶é—´ä¹Ÿä¼šè¶Šå¤š</p><ul><li>æ•´æ•°å€¼çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œ éªŒè¯æ“ä½œçš„å¤æ‚åº¦ä¸º O(1)</li><li>å­—ç¬¦ä¸²å€¼çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œ éªŒè¯æ“ä½œçš„å¤æ‚åº¦ä¸º O(N)</li><li>å¦‚æœå…±äº«å¯¹è±¡æ˜¯åŒ…å«äº†å¤šä¸ªå€¼ï¼ˆæˆ–è€…å¯¹è±¡çš„ï¼‰å¯¹è±¡ï¼Œæ¯”å¦‚åˆ—è¡¨å¯¹è±¡æˆ–è€…å“ˆå¸Œå¯¹è±¡ï¼ŒéªŒè¯æ“ä½œçš„å¤æ‚åº¦ä¸º O(N^2)</li></ul><hr><h4 id="ç©ºè½¬æ—¶é•¿" tabindex="-1"><a class="header-anchor" href="#ç©ºè½¬æ—¶é•¿" aria-hidden="true">#</a> ç©ºè½¬æ—¶é•¿</h4><p>redisObject ç»“æ„åŒ…å«ä¸€ä¸ª lru å±æ€§ï¼Œè¯¥å±æ€§è®°å½•äº†å¯¹è±¡æœ€åä¸€æ¬¡è¢«å‘½ä»¤ç¨‹åºè®¿é—®çš„æ—¶é—´</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisObiect</span> <span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> lru<span class="token operator">:</span><span class="token number">22</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> robj<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>OBJECT IDLETIME å‘½ä»¤å¯ä»¥æ‰“å°å‡ºç»™å®šé”®çš„ç©ºè½¬æ—¶é•¿ï¼Œè¯¥å€¼å°±æ˜¯é€šè¿‡å°†å½“å‰æ—¶é—´å‡å»é”®çš„å€¼å¯¹è±¡çš„ lru æ—¶é—´è®¡ç®—å¾—å‡ºçš„ï¼Œè¿™ä¸ªå‘½ä»¤åœ¨è®¿é—®é”®çš„å€¼å¯¹è±¡æ—¶ï¼Œä¸ä¼šä¿®æ”¹å€¼å¯¹è±¡çš„ lru å±æ€§</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis<span class="token operator">&gt;</span> OBJECT IDLETIME msg
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">10</span>
<span class="token comment"># ç­‰å¾…ä¸€åˆ†é’Ÿ</span>
redis<span class="token operator">&gt;</span> OBJECT IDLETIME msg
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">70</span>
<span class="token comment"># è®¿é—® msg</span>
redis<span class="token operator">&gt;</span> GET msg
<span class="token string">&quot;hello world&quot;</span>
<span class="token comment"># é”®å¤„äºæ´»è·ƒçŠ¶æ€ï¼Œç©ºè½¬æ—¶é•¿ä¸º 0</span>
redis<span class="token operator">&gt;</span> OBJECT IDLETIME msg
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç©ºè½¬æ—¶é•¿çš„ä½œç”¨ï¼šå¦‚æœæœåŠ¡å™¨å¼€å¯ maxmemory é€‰é¡¹ï¼Œå¹¶ä¸”å›æ”¶å†…å­˜çš„ç®—æ³•ä¸º volatile-lru æˆ–è€… allkeys-lruï¼Œé‚£ä¹ˆå½“æœåŠ¡å™¨å ç”¨çš„å†…å­˜æ•°è¶…è¿‡äº† maxmemory æ‰€è®¾ç½®çš„ä¸Šé™å€¼æ—¶ï¼Œç©ºè½¬æ—¶é•¿è¾ƒé«˜çš„é‚£éƒ¨åˆ†é”®ä¼šä¼˜å…ˆè¢«æœåŠ¡å™¨é‡Šæ”¾ï¼Œä»è€Œå›æ”¶å†…å­˜ï¼ˆLRU ç®—æ³•ï¼‰</p><hr><h3 id="string" tabindex="-1"><a class="header-anchor" href="#string" aria-hidden="true">#</a> string</h3><h4 id="ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#ç®€ä»‹" aria-hidden="true">#</a> ç®€ä»‹</h4><p>å­˜å‚¨çš„æ•°æ®ï¼šå•ä¸ªæ•°æ®ï¼Œæœ€ç®€å•çš„æ•°æ®å­˜å‚¨ç±»å‹ï¼Œä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„æ•°æ®å­˜å‚¨ç±»å‹ï¼Œå®è´¨ä¸Šæ˜¯å­˜ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œstring ç±»å‹æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œå¯ä»¥åŒ…å«ä»»ä½•æ•°æ®ï¼Œæ¯”å¦‚å›¾ç‰‡æˆ–è€…åºåˆ—åŒ–çš„å¯¹è±¡</p><p>å­˜å‚¨æ•°æ®çš„æ ¼å¼ï¼šä¸€ä¸ªå­˜å‚¨ç©ºé—´ä¿å­˜ä¸€ä¸ªæ•°æ®ï¼Œæ¯ä¸€ä¸ªç©ºé—´ä¸­åªèƒ½ä¿å­˜ä¸€ä¸ªå­—ç¬¦ä¸²ä¿¡æ¯</p><p>å­˜å‚¨å†…å®¹ï¼šé€šå¸¸ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œå¦‚æœå­—ç¬¦ä¸²ä»¥æ•´æ•°çš„å½¢å¼å±•ç¤ºï¼Œå¯ä»¥ä½œä¸ºæ•°å­—æ“ä½œä½¿ç”¨</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-stringç»“æ„å›¾.png" style="zoom:50%;"><p>Redis æ‰€æœ‰æ“ä½œéƒ½æ˜¯<strong>åŸå­æ€§</strong>çš„ï¼Œé‡‡ç”¨<strong>å•çº¿ç¨‹</strong>æœºåˆ¶ï¼Œå‘½ä»¤æ˜¯å•ä¸ªé¡ºåºæ‰§è¡Œï¼Œæ— éœ€è€ƒè™‘å¹¶å‘å¸¦æ¥å½±å“ï¼ŒåŸå­æ€§å°±æ˜¯æœ‰ä¸€ä¸ªå¤±è´¥åˆ™éƒ½å¤±è´¥</p><p>å­—ç¬¦ä¸²å¯¹è±¡å¯ä»¥æ˜¯ intã€rawã€embstr ä¸‰ç§å®ç°æ–¹å¼</p><hr><h4 id="æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#æ“ä½œ" aria-hidden="true">#</a> æ“ä½œ</h4><p>æŒ‡ä»¤æ“ä½œï¼š</p><ul><li><p>æ•°æ®æ“ä½œï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">set</span> key value			<span class="token comment">#æ·»åŠ /ä¿®æ”¹æ•°æ®æ·»åŠ /ä¿®æ”¹æ•°æ®</span>
del key					<span class="token comment">#åˆ é™¤æ•°æ®</span>
setnx key value			<span class="token comment">#åˆ¤å®šæ€§æ·»åŠ æ•°æ®ï¼Œé”®å€¼ä¸ºç©ºåˆ™è®¾æ·»åŠ </span>
mset k1 v1 k2 v2<span class="token punctuation">..</span>.		<span class="token comment">#æ·»åŠ /ä¿®æ”¹å¤šä¸ªæ•°æ®ï¼Œmï¼šMultiple</span>
append key value		<span class="token comment">#è¿½åŠ ä¿¡æ¯åˆ°åŸå§‹ä¿¡æ¯åéƒ¨ï¼ˆå¦‚æœåŸå§‹ä¿¡æ¯å­˜åœ¨å°±è¿½åŠ ï¼Œå¦åˆ™æ–°å»ºï¼‰</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æŸ¥è¯¢æ“ä½œ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>get key					<span class="token comment">#è·å–æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œè¿”å›ç©ºï¼ˆnilï¼‰</span>
mget key1 key2<span class="token punctuation">..</span>.		<span class="token comment">#è·å–å¤šä¸ªæ•°æ®</span>
strlen key				<span class="token comment">#è·å–æ•°æ®å­—ç¬¦ä¸ªæ•°ï¼ˆå­—ç¬¦ä¸²é•¿åº¦ï¼‰</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>è®¾ç½®æ•°å€¼æ•°æ®å¢åŠ /å‡å°‘æŒ‡å®šèŒƒå›´çš„å€¼</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>incr key					<span class="token comment">#key++</span>
incrby key increment		<span class="token comment">#key+increment</span>
incrbyfloat key increment	<span class="token comment">#å¯¹å°æ•°æ“ä½œ</span>
decr key					<span class="token comment">#key--</span>
decrby key increment		<span class="token comment">#key-increment</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>è®¾ç½®æ•°æ®å…·æœ‰æŒ‡å®šçš„ç”Ÿå‘½å‘¨æœŸ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>setex key seconds value  		<span class="token comment">#è®¾ç½®key-valueå­˜æ´»æ—¶é—´ï¼Œsecondså•ä½æ˜¯ç§’</span>
psetex key milliseconds value	<span class="token comment">#æ¯«ç§’çº§</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>æ³¨æ„äº‹é¡¹ï¼š</p><ol><li><p>æ•°æ®æ“ä½œä¸æˆåŠŸçš„åé¦ˆä¸æ•°æ®æ­£å¸¸æ“ä½œä¹‹é—´çš„å·®å¼‚</p><ul><li><p>è¡¨ç¤ºè¿è¡Œç»“æœæ˜¯å¦æˆåŠŸ</p><ul><li><p>(integer) 0 â†’ false ï¼Œå¤±è´¥</p></li><li><p>(integer) 1 â†’ trueï¼ŒæˆåŠŸ</p></li></ul></li><li><p>è¡¨ç¤ºè¿è¡Œç»“æœå€¼</p><ul><li><p>(integer) 3 â†’ 3 ä¸ª</p></li><li><p>(integer) 1 â†’ 1 ä¸ª</p></li></ul></li></ul></li><li><p>æ•°æ®æœªè·å–åˆ°æ—¶ï¼Œå¯¹åº”çš„æ•°æ®ä¸ºï¼ˆnilï¼‰ï¼Œç­‰åŒäºnull</p></li><li><p><strong>æ•°æ®æœ€å¤§å­˜å‚¨é‡</strong>ï¼š512MB</p></li><li><p>string åœ¨ Redis å†…éƒ¨å­˜å‚¨é»˜è®¤å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå½“é‡åˆ°å¢å‡ç±»æ“ä½œ incrï¼Œdecr æ—¶<strong>ä¼šè½¬æˆæ•°å€¼å‹</strong>è¿›è¡Œè®¡ç®—</p></li><li><p>æŒ‰æ•°å€¼è¿›è¡Œæ“ä½œçš„æ•°æ®ï¼Œå¦‚æœåŸå§‹æ•°æ®ä¸èƒ½è½¬æˆæ•°å€¼ï¼Œæˆ–è¶…è¶Šäº†Redis æ•°å€¼ä¸Šé™èŒƒå›´ï¼Œå°†æŠ¥é”™<br> 9223372036854775807ï¼ˆjava ä¸­ Long å‹æ•°æ®æœ€å¤§å€¼ï¼ŒLong.MAX_VALUEï¼‰</p></li><li><p>Redis å¯ç”¨äºæ§åˆ¶æ•°æ®åº“è¡¨ä¸»é”® IDï¼Œä¸ºæ•°æ®åº“è¡¨ä¸»é”®æä¾›ç”Ÿæˆç­–ç•¥ï¼Œä¿éšœæ•°æ®åº“è¡¨çš„ä¸»é”®å”¯ä¸€æ€§</p></li></ol><p>å•æ•°æ®å’Œå¤šæ•°æ®çš„é€‰æ‹©ï¼š</p><ul><li>å•æ•°æ®æ‰§è¡Œ 3 æ¡æŒ‡ä»¤çš„è¿‡ç¨‹ï¼š3 æ¬¡å‘é€ + 3 æ¬¡å¤„ç† + 3 æ¬¡è¿”å›</li><li>å¤šæ•°æ®æ‰§è¡Œ 1 æ¡æŒ‡ä»¤çš„è¿‡ç¨‹ï¼š1 æ¬¡å‘é€ + 3 æ¬¡å¤„ç† + 1 æ¬¡è¿”å›ï¼ˆå‘é€å’Œè¿”å›çš„äº‹ä»¶ç•¥é«˜äºå•æ•°æ®ï¼‰</li></ul><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/stringå•æ•°æ®ä¸å¤šæ•°æ®æ“ä½œ.png" style="zoom:33%;"><hr><h4 id="å®ç°" tabindex="-1"><a class="header-anchor" href="#å®ç°" aria-hidden="true">#</a> å®ç°</h4><p>å­—ç¬¦ä¸²å¯¹è±¡çš„ç¼–ç å¯ä»¥æ˜¯ intã€rawã€embstr ä¸‰ç§</p><ul><li><p>intï¼šå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯<strong>æ•´æ•°å€¼</strong>ï¼Œå¹¶ä¸”æ•´æ•°å€¼å¯ä»¥ç”¨ long ç±»å‹æ¥è¡¨ç¤ºï¼Œé‚£ä¹ˆå¯¹è±¡ä¼šå°†æ•´æ•°å€¼ä¿å­˜åœ¨å­—ç¬¦ä¸²å¯¹è±¡ç»“æ„çš„ ptr å±æ€§é¢ï¼ˆå°† void * è½¬æ¢æˆ long)ï¼Œå¹¶å°†å­—ç¬¦ä¸²å¯¹è±¡çš„ç¼–ç è®¾ç½®ä¸º intï¼ˆæµ®ç‚¹æ•°ç”¨å¦å¤–ä¸¤ç§æ–¹å¼ï¼‰</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å­—ç¬¦ä¸²å¯¹è±¡intç¼–ç .png" style="zoom:67%;"></li><li><p>rawï¼šå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œå¹¶ä¸”å€¼çš„é•¿åº¦å¤§äº 39 å­—èŠ‚ï¼Œé‚£ä¹ˆå¯¹è±¡å°†ä½¿ç”¨ç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰æ¥ä¿å­˜è¯¥å€¼ï¼Œå¹¶å°†å¯¹è±¡çš„ç¼–ç è®¾ç½®ä¸º raw</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å­—ç¬¦ä¸²å¯¹è±¡rawç¼–ç .png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></li><li><p>embstrï¼šå­—ç¬¦ä¸²å¯¹è±¡ä¿å­˜çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œå¹¶ä¸”å€¼çš„é•¿åº¦å°äºç­‰äº 39 å­—èŠ‚ï¼Œé‚£ä¹ˆå¯¹è±¡å°†ä½¿ç”¨ embstr ç¼–ç çš„æ–¹å¼æ¥ä¿å­˜è¿™ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œå¹¶å°†å¯¹è±¡çš„ç¼–ç è®¾ç½®ä¸º embstr</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å­—ç¬¦ä¸²å¯¹è±¡embstrç¼–ç .png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ä¸Šå›¾æ‰€ç¤ºï¼Œembstr ä¸ raw éƒ½ä½¿ç”¨äº† redisObject å’Œ sdshdr æ¥è¡¨ç¤ºå­—ç¬¦ä¸²å¯¹è±¡ï¼Œä½†æ˜¯ raw éœ€è¦è°ƒç”¨ä¸¤æ¬¡å†…å­˜åˆ†é…å‡½æ•°åˆ†åˆ«åˆ›å»ºä¸¤ç§ç»“æ„ï¼Œembstr åªéœ€è¦ä¸€æ¬¡å†…å­˜åˆ†é…æ¥åˆ†é…ä¸€å—<strong>è¿ç»­çš„ç©ºé—´</strong></p></li></ul><p>embstr æ˜¯ç”¨äºä¿å­˜çŸ­å­—ç¬¦ä¸²çš„ä¸€ç§ç¼–ç æ–¹å¼ï¼Œå¯¹æ¯” raw çš„ä¼˜ç‚¹ï¼š</p><ul><li>å†…å­˜åˆ†é…æ¬¡æ•°ä»ä¸¤æ¬¡é™ä½ä¸ºä¸€æ¬¡ï¼ŒåŒæ ·é‡Šæ”¾å†…å­˜çš„æ¬¡æ•°ä¹Ÿä»ä¸¤æ¬¡å˜ä¸ºä¸€æ¬¡</li><li>embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡çš„æ•°æ®éƒ½ä¿å­˜åœ¨åŒä¸€å—è¿ç»­å†…å­˜ï¼Œæ‰€ä»¥æ¯” raw ç¼–ç èƒ½å¤Ÿæ›´å¥½åœ°åˆ©ç”¨ç¼“å­˜ä¼˜åŠ¿ï¼ˆå±€éƒ¨æ€§åŸç†ï¼‰</li></ul><p>int å’Œ embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡åœ¨æ¡ä»¶æ»¡è¶³çš„æƒ…å†µä¸‹ï¼Œä¼šè¢«è½¬æ¢ä¸º raw ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼š</p><ul><li>int ç¼–ç çš„æ•´æ•°å€¼ï¼Œæ‰§è¡Œ APPEND å‘½ä»¤è¿½åŠ ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼Œå…ˆå°†æ•´æ•°å€¼è½¬ä¸ºå­—ç¬¦ä¸²ç„¶åè¿½åŠ ï¼Œæœ€åå¾—åˆ°ä¸€ä¸ª raw ç¼–ç çš„å¯¹è±¡</li><li>Redis æ²¡æœ‰ä¸º embstr ç¼–ç çš„å­—ç¬¦ä¸²å¯¹è±¡ç¼–å†™ä»»ä½•ç›¸åº”çš„ä¿®æ”¹ç¨‹åºï¼Œæ‰€ä»¥ embstr å¯¹è±¡å®é™…ä¸Š<strong>æ˜¯åªè¯»çš„</strong>ï¼Œæ‰§è¡Œä¿®æ”¹å‘½ä»¤ä¼šå°†å¯¹è±¡çš„ç¼–ç ä» embstr è½¬æ¢æˆ rawï¼Œæ“ä½œå®Œæˆåå¾—åˆ°ä¸€ä¸ª raw ç¼–ç çš„å¯¹è±¡</li></ul><p>æŸäº›æƒ…å†µä¸‹ï¼Œç¨‹åºä¼šå°†å­—ç¬¦ä¸²å¯¹è±¡é‡Œé¢çš„å­—ç¬¦ä¸²å€¼è½¬æ¢å›æµ®ç‚¹æ•°å€¼ï¼Œæ‰§è¡ŒæŸäº›æ“ä½œåå†å°†æµ®ç‚¹æ•°å€¼è½¬æ¢å›å­—ç¬¦ä¸²å€¼ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis<span class="token operator">&gt;</span> SET pi <span class="token number">3.14</span> 
OK 
redis<span class="token operator">&gt;</span> OBJECT ENCODING pi
<span class="token string">&quot;embstr&quot;</span> 
redis<span class="token operator">&gt;</span> INCRBYFLOAT pi <span class="token number">2.0</span> <span class="token comment"># è½¬ä¸ºæµ®ç‚¹æ•°æ‰§è¡Œå¢åŠ çš„æ“ä½œ</span>
<span class="token string">&quot;5. 14&quot;</span> 
redis<span class="token operator">&gt;</span> OBJECT ENCODING pi 
<span class="token string">&quot;embstr&quot;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="åº”ç”¨" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨" aria-hidden="true">#</a> åº”ç”¨</h4><p>ä¸»é¡µé«˜é¢‘è®¿é—®ä¿¡æ¯æ˜¾ç¤ºæ§åˆ¶ï¼Œä¾‹å¦‚æ–°æµªå¾®åšå¤§ V ä¸»é¡µæ˜¾ç¤ºç²‰ä¸æ•°ä¸å¾®åšæ•°é‡</p><ul><li><p>åœ¨ Redis ä¸­ä¸ºå¤§ V ç”¨æˆ·è®¾å®šç”¨æˆ·ä¿¡æ¯ï¼Œä»¥ç”¨æˆ·ä¸»é”®å’Œå±æ€§å€¼ä½œä¸º keyï¼Œåå°è®¾å®šå®šæ—¶åˆ·æ–°ç­–ç•¥</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">set</span> user:id:3506728370:fans <span class="token number">12210947</span>
<span class="token builtin class-name">set</span> user:id:3506728370:blogs <span class="token number">6164</span>
<span class="token builtin class-name">set</span> user:id:3506728370:focuses <span class="token number">83</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>ä½¿ç”¨ JSON æ ¼å¼ä¿å­˜æ•°æ®</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>user:id:3506728370 â†’ <span class="token punctuation">{</span><span class="token string">&quot;fans&quot;</span>:12210947,<span class="token string">&quot;blogs&quot;</span>:6164,<span class="token string">&quot;focuses&quot;</span>:83<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>keyçš„è®¾ç½®çº¦å®šï¼šè¡¨å : ä¸»é”®å : ä¸»é”®å€¼ : å­—æ®µå</p><table><thead><tr><th>è¡¨å</th><th>ä¸»é”®å</th><th>ä¸»é”®å€¼</th><th>å­—æ®µå</th></tr></thead><tbody><tr><td>order</td><td>id</td><td>29437595</td><td>name</td></tr><tr><td>equip</td><td>id</td><td>390472345</td><td>type</td></tr><tr><td>news</td><td>id</td><td>202004150</td><td>title</td></tr></tbody></table></li></ul><hr><h3 id="hash" tabindex="-1"><a class="header-anchor" href="#hash" aria-hidden="true">#</a> hash</h3><h4 id="ç®€ä»‹-1" tabindex="-1"><a class="header-anchor" href="#ç®€ä»‹-1" aria-hidden="true">#</a> ç®€ä»‹</h4><p>æ•°æ®å­˜å‚¨éœ€æ±‚ï¼šå¯¹ä¸€ç³»åˆ—å­˜å‚¨çš„æ•°æ®è¿›è¡Œç¼–ç»„ï¼Œæ–¹ä¾¿ç®¡ç†ï¼Œå…¸å‹åº”ç”¨å­˜å‚¨å¯¹è±¡ä¿¡æ¯</p><p>æ•°æ®å­˜å‚¨ç»“æ„ï¼šä¸€ä¸ªå­˜å‚¨ç©ºé—´ä¿å­˜å¤šä¸ªé”®å€¼å¯¹æ•°æ®</p><p>hash ç±»å‹ï¼šåº•å±‚ä½¿ç”¨<strong>å“ˆå¸Œè¡¨</strong>ç»“æ„å®ç°æ•°æ®å­˜å‚¨</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/hashç»“æ„å›¾.png" style="zoom:33%;"><p>Redis ä¸­çš„ hash ç±»ä¼¼äº Java ä¸­çš„ <code>Map&lt;String, Map&lt;Object,object&gt;&gt;</code>ï¼Œå·¦è¾¹æ˜¯ keyï¼Œå³è¾¹æ˜¯å€¼ï¼Œä¸­é—´å« field å­—æ®µï¼Œæœ¬è´¨ä¸Š <strong>hash å­˜äº†ä¸€ä¸ª key-value çš„å­˜å‚¨ç©ºé—´</strong></p><p>hash æ˜¯æŒ‡çš„ä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªæ•°æ®</p><ul><li>å¦‚æœ field æ•°é‡è¾ƒå°‘ï¼Œå­˜å‚¨ç»“æ„ä¼˜åŒ–ä¸º<strong>å‹ç¼©åˆ—è¡¨ç»“æ„</strong>ï¼ˆæœ‰åºï¼‰</li><li>å¦‚æœ field æ•°é‡è¾ƒå¤šï¼Œå­˜å‚¨ç»“æ„ä½¿ç”¨ HashMap ç»“æ„ï¼ˆæ— åºï¼‰</li></ul><hr><h4 id="æ“ä½œ-1" tabindex="-1"><a class="header-anchor" href="#æ“ä½œ-1" aria-hidden="true">#</a> æ“ä½œ</h4><p>æŒ‡ä»¤æ“ä½œï¼š</p><ul><li><p>æ•°æ®æ“ä½œ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>hset key field value		<span class="token comment">#æ·»åŠ /ä¿®æ”¹æ•°æ®</span>
hdel key field1 <span class="token punctuation">[</span>field2<span class="token punctuation">]</span>	<span class="token comment">#åˆ é™¤æ•°æ®ï¼Œ[]ä»£è¡¨å¯é€‰</span>
hsetnx key field value		<span class="token comment">#è®¾ç½®fieldçš„å€¼ï¼Œå¦‚æœè¯¥fieldå­˜åœ¨åˆ™ä¸åšä»»ä½•æ“ä½œ</span>
hmset key f1 v1 f2 v2<span class="token punctuation">..</span>.	<span class="token comment">#æ·»åŠ /ä¿®æ”¹å¤šä¸ªæ•°æ®</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æŸ¥è¯¢æ“ä½œ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>hget key field				<span class="token comment">#è·å–æŒ‡å®šfieldå¯¹åº”æ•°æ®</span>
hgetall key					<span class="token comment">#è·å–æŒ‡å®škeyæ‰€æœ‰æ•°æ®</span>
hmget key field1 field2<span class="token punctuation">..</span>.	<span class="token comment">#è·å–å¤šä¸ªæ•°æ®</span>
hexists key field			<span class="token comment">#è·å–å“ˆå¸Œè¡¨ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„å­—æ®µ</span>
hlen key					<span class="token comment">#è·å–å“ˆå¸Œè¡¨ä¸­å­—æ®µçš„æ•°é‡</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>è·å–å“ˆå¸Œè¡¨ä¸­æ‰€æœ‰çš„å­—æ®µåæˆ–å­—æ®µå€¼</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>hkeys key					<span class="token comment">#è·å–æ‰€æœ‰çš„field	</span>
hvals key					<span class="token comment">#è·å–æ‰€æœ‰çš„value</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>è®¾ç½®æŒ‡å®šå­—æ®µçš„æ•°å€¼æ•°æ®å¢åŠ æŒ‡å®šèŒƒå›´çš„å€¼</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>hincrby key field increment		<span class="token comment">#æŒ‡å®šå­—æ®µçš„æ•°å€¼æ•°æ®å¢åŠ æŒ‡å®šçš„å€¼ï¼Œincrementä¸ºè´Ÿæ•°åˆ™å‡å°‘</span>
hincrbyfloat key field increment<span class="token comment">#æ“ä½œå°æ•°</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>æ³¨æ„äº‹é¡¹</p><ol><li>hash ç±»å‹ä¸­ value åªèƒ½å­˜å‚¨å­—ç¬¦ä¸²ï¼Œä¸å…è®¸å­˜å‚¨å…¶ä»–æ•°æ®ç±»å‹ï¼Œä¸å­˜åœ¨åµŒå¥—ç°è±¡ï¼Œå¦‚æœæ•°æ®æœªè·å–åˆ°ï¼Œå¯¹åº”çš„å€¼ä¸ºï¼ˆnilï¼‰</li><li>æ¯ä¸ª hash å¯ä»¥å­˜å‚¨ 2^32 - 1 ä¸ªé”®å€¼å¯¹</li><li>hash ç±»å‹å’Œå¯¹è±¡çš„æ•°æ®å­˜å‚¨å½¢å¼ç›¸ä¼¼ï¼Œå¹¶ä¸”å¯ä»¥çµæ´»æ·»åŠ åˆ é™¤å¯¹è±¡å±æ€§ã€‚ä½† hash è®¾è®¡åˆè¡·ä¸æ˜¯ä¸ºäº†å­˜å‚¨å¤§é‡å¯¹è±¡è€Œè®¾è®¡çš„ï¼Œä¸å¯æ»¥ç”¨ï¼Œä¸å¯å°† hash ä½œä¸ºå¯¹è±¡åˆ—è¡¨ä½¿ç”¨</li><li>hgetall æ“ä½œå¯ä»¥è·å–å…¨éƒ¨å±æ€§ï¼Œå¦‚æœå†…éƒ¨ field è¿‡å¤šï¼Œéå†æ•´ä½“æ•°æ®æ•ˆç‡å°±å¾ˆä¼šä½ï¼Œæœ‰å¯èƒ½æˆä¸ºæ•°æ®è®¿é—®ç“¶é¢ˆ</li></ol><hr><h4 id="å®ç°-1" tabindex="-1"><a class="header-anchor" href="#å®ç°-1" aria-hidden="true">#</a> å®ç°</h4><p>å“ˆå¸Œå¯¹è±¡çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ï¼šziplistï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰ã€hashtableï¼ˆå“ˆå¸Œè¡¨ã€å­—å…¸ï¼‰</p><ul><li><p>å‹ç¼©åˆ—è¡¨å®ç°å“ˆå¸Œå¯¹è±¡ï¼šåŒä¸€é”®å€¼å¯¹çš„èŠ‚ç‚¹æ€»æ˜¯æŒ¨åœ¨ä¸€èµ·ï¼Œä¿å­˜é”®çš„èŠ‚ç‚¹åœ¨å‰ï¼Œä¿å­˜å€¼çš„èŠ‚ç‚¹åœ¨å</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å“ˆå¸Œå¯¹è±¡ziplist.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></li><li><p>å­—å…¸å®ç°å“ˆå¸Œå¯¹è±¡ï¼šå­—å…¸çš„æ¯ä¸€ä¸ªé”®éƒ½æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼Œæ¯ä¸ªå€¼ä¹Ÿæ˜¯</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å“ˆå¸Œå¯¹è±¡dict.png" style="zoom:67%;"></li></ul><p>å½“å­˜å‚¨çš„æ•°æ®é‡æ¯”è¾ƒå°çš„æƒ…å†µä¸‹ï¼ŒRedis æ‰ä½¿ç”¨å‹ç¼©åˆ—è¡¨æ¥å®ç°å­—å…¸ç±»å‹ï¼Œå…·ä½“éœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ul><li>å½“é”®å€¼å¯¹æ•°é‡å°äº hash-max-ziplist-entries é…ç½®ï¼ˆé»˜è®¤ 512 ä¸ªï¼‰</li><li>æ‰€æœ‰é”®å’Œå€¼çš„é•¿åº¦éƒ½å°äº hash-max-ziplist-value é…ç½®ï¼ˆé»˜è®¤ 64 å­—èŠ‚ï¼‰</li></ul><p>ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶çš„ä¸Šé™å€¼æ˜¯å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ä¿®æ”¹çš„ï¼Œå½“ä¸¤ä¸ªæ¡ä»¶çš„ä»»æ„ä¸€ä¸ªä¸èƒ½è¢«æ»¡è¶³æ—¶ï¼Œå¯¹è±¡çš„ç¼–ç è½¬æ¢æ“ä½œå°±ä¼šè¢«æ‰§è¡Œ</p><p>ziplist ä½¿ç”¨æ›´åŠ ç´§å‡‘çš„ç»“æ„å®ç°å¤šä¸ªå…ƒç´ çš„è¿ç»­å­˜å‚¨ï¼Œæ‰€ä»¥åœ¨èŠ‚çœå†…å­˜æ–¹é¢æ¯” hashtable æ›´åŠ ä¼˜ç§€ï¼Œå½“ ziplist æ— æ³•æ»¡è¶³å“ˆå¸Œç±»å‹æ—¶ï¼ŒRedis ä¼šä½¿ç”¨ hashtable ä½œä¸ºå“ˆå¸Œçš„å†…éƒ¨å®ç°ï¼Œå› ä¸ºæ­¤æ—¶ ziplist çš„è¯»å†™æ•ˆç‡ä¼šä¸‹é™ï¼Œè€Œ hashtable çš„è¯»å†™æ—¶é—´å¤æ‚åº¦ä¸º O(1)</p><hr><h4 id="åº”ç”¨-1" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨-1" aria-hidden="true">#</a> åº”ç”¨</h4><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>user:id:3506728370 â†’ <span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;æ˜¥æ™š&quot;</span>,<span class="token string">&quot;fans&quot;</span>:12210862,<span class="token string">&quot;blogs&quot;</span>:83<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å¯¹äºä»¥ä¸Šæ•°æ®ï¼Œä½¿ç”¨å•æ¡å»å­˜çš„è¯ï¼Œå­˜çš„æ¡æ•°ä¼šå¾ˆå¤šã€‚ä½†å¦‚æœç”¨ json æ ¼å¼ï¼Œå­˜ä¸€æ¡æ•°æ®å°±å¤Ÿäº†ã€‚</p><p>å‡å¦‚ç°åœ¨ç²‰ä¸æ•°é‡å‘ç”Ÿäº†å˜åŒ–ï¼Œè¦æŠŠæ•´ä¸ªå€¼éƒ½æ”¹å˜ï¼Œä½†æ˜¯ç”¨å•æ¡å­˜å°±ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œåªéœ€è¦æ”¹å…¶ä¸­ä¸€ä¸ªå°±å¯ä»¥</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/hashåº”ç”¨åœºæ™¯ç»“æ„å›¾.png" style="zoom:33%;"><p>å¯ä»¥å®ç°è´­ç‰©è½¦çš„åŠŸèƒ½ï¼Œkey å¯¹åº”ç€æ¯ä¸ªç”¨æˆ·ï¼Œå­˜å‚¨ç©ºé—´å­˜å‚¨è´­ç‰©è½¦çš„ä¿¡æ¯</p><hr><h3 id="list" tabindex="-1"><a class="header-anchor" href="#list" aria-hidden="true">#</a> list</h3><h4 id="ç®€ä»‹-2" tabindex="-1"><a class="header-anchor" href="#ç®€ä»‹-2" aria-hidden="true">#</a> ç®€ä»‹</h4><p>æ•°æ®å­˜å‚¨éœ€æ±‚ï¼šå­˜å‚¨å¤šä¸ªæ•°æ®ï¼Œå¹¶å¯¹æ•°æ®è¿›å…¥å­˜å‚¨ç©ºé—´çš„é¡ºåºè¿›è¡ŒåŒºåˆ†</p><p>æ•°æ®å­˜å‚¨ç»“æ„ï¼šä¸€ä¸ªå­˜å‚¨ç©ºé—´ä¿å­˜å¤šä¸ªæ•°æ®ï¼Œä¸”é€šè¿‡æ•°æ®å¯ä»¥ä½“ç°è¿›å…¥é¡ºåºï¼Œå…è®¸é‡å¤å…ƒç´ </p><p>list ç±»å‹ï¼šä¿å­˜å¤šä¸ªæ•°æ®ï¼Œåº•å±‚ä½¿ç”¨<strong>åŒå‘é“¾è¡¨</strong>å­˜å‚¨ç»“æ„å®ç°ï¼Œç±»ä¼¼äº LinkedList</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/listç»“æ„å›¾.png" style="zoom:33%;"><p>å¦‚æœä¸¤ç«¯éƒ½èƒ½å­˜å–æ•°æ®çš„è¯ï¼Œè¿™å°±æ˜¯åŒç«¯é˜Ÿåˆ—ï¼Œå¦‚æœåªèƒ½ä»ä¸€ç«¯è¿›ä¸€ç«¯å‡ºï¼Œè¿™ä¸ªæ¨¡å‹å«æ ˆ</p><hr><h4 id="æ“ä½œ-2" tabindex="-1"><a class="header-anchor" href="#æ“ä½œ-2" aria-hidden="true">#</a> æ“ä½œ</h4><p>æŒ‡ä»¤æ“ä½œï¼š</p><ul><li><p>æ•°æ®æ“ä½œ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>lpush key value1 <span class="token punctuation">[</span>value2<span class="token punctuation">]</span><span class="token punctuation">..</span>.<span class="token comment">#ä»å·¦è¾¹æ·»åŠ /ä¿®æ”¹æ•°æ®(è¡¨å¤´)</span>
rpush key value1 <span class="token punctuation">[</span>value2<span class="token punctuation">]</span><span class="token punctuation">..</span>.<span class="token comment">#ä»å³è¾¹æ·»åŠ /ä¿®æ”¹æ•°æ®(è¡¨å°¾)</span>
lpop key					<span class="token comment">#ä»å·¦è¾¹è·å–å¹¶ç§»é™¤ç¬¬ä¸€ä¸ªæ•°æ®ï¼Œç±»ä¼¼äºå‡ºæ ˆ/å‡ºé˜Ÿ</span>
rpop key					<span class="token comment">#ä»å³è¾¹è·å–å¹¶ç§»é™¤ç¬¬ä¸€ä¸ªæ•°æ®</span>
lrem key count value		<span class="token comment">#åˆ é™¤æŒ‡å®šæ•°æ®ï¼Œcount=2åˆ é™¤2ä¸ªï¼Œè¯¥valueå¯èƒ½æœ‰å¤šä¸ª(é‡å¤æ•°æ®)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æŸ¥è¯¢æ“ä½œ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>lrange key start stop		<span class="token comment">#ä»å·¦è¾¹éå†æ•°æ®å¹¶æŒ‡å®šå¼€å§‹å’Œç»“æŸç´¢å¼•ï¼Œ0æ˜¯ç¬¬ä¸€ä¸ªç´¢å¼•ï¼Œ-1æ˜¯ç»ˆç´¢å¼•</span>
lindex key index			<span class="token comment">#è·å–æŒ‡å®šç´¢å¼•æ•°æ®ï¼Œæ²¡æœ‰åˆ™ä¸ºnilï¼Œæ²¡æœ‰ç´¢å¼•è¶Šç•Œ</span>
llen key					<span class="token comment">#listä¸­æ•°æ®é•¿åº¦/ä¸ªæ•°</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>è§„å®šæ—¶é—´å†…è·å–å¹¶ç§»é™¤æ•°æ®</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>b							<span class="token comment">#ä»£è¡¨é˜»å¡</span>
blpop key1 <span class="token punctuation">[</span>key2<span class="token punctuation">]</span> <span class="token function">timeout</span>	<span class="token comment">#åœ¨æŒ‡å®šæ—¶é—´å†…è·å–æŒ‡å®škey(å¯ä»¥å¤šä¸ª)çš„æ•°æ®ï¼Œè¶…æ—¶åˆ™ä¸º(nil)</span>
							<span class="token comment">#å¯ä»¥ä»å…¶ä»–å®¢æˆ·ç«¯å†™æ•°æ®ï¼Œå½“å‰å®¢æˆ·ç«¯é˜»å¡è¯»å–æ•°æ®</span>
brpop key1 <span class="token punctuation">[</span>key2<span class="token punctuation">]</span> <span class="token function">timeout</span>	<span class="token comment">#ä»å³è¾¹æ“ä½œ</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>å¤åˆ¶æ“ä½œ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>brpoplpush <span class="token builtin class-name">source</span> destination <span class="token function">timeout</span>	<span class="token comment">#ä»sourceè·å–æ•°æ®æ”¾å…¥destinationï¼Œå‡å¦‚åœ¨æŒ‡å®šæ—¶é—´å†…æ²¡æœ‰ä»»ä½•å…ƒç´ è¢«å¼¹å‡ºï¼Œåˆ™è¿”å›ä¸€ä¸ªnilå’Œç­‰å¾…æ—¶é•¿ã€‚åä¹‹ï¼Œè¿”å›ä¸€ä¸ªå«æœ‰ä¸¤ä¸ªå…ƒç´ çš„åˆ—è¡¨ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯è¢«å¼¹å‡ºå…ƒç´ çš„å€¼ï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯ç­‰å¾…æ—¶é•¿</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><p>æ³¨æ„äº‹é¡¹</p><ol><li>list ä¸­ä¿å­˜çš„æ•°æ®éƒ½æ˜¯ string ç±»å‹çš„ï¼Œæ•°æ®æ€»å®¹é‡æ˜¯æœ‰é™çš„ï¼Œæœ€å¤š 2^32 - 1 ä¸ªå…ƒç´ ï¼ˆ4294967295ï¼‰</li><li>list å…·æœ‰ç´¢å¼•çš„æ¦‚å¿µï¼Œä½†æ“ä½œæ•°æ®æ—¶é€šå¸¸ä»¥é˜Ÿåˆ—çš„å½¢å¼è¿›è¡Œå…¥é˜Ÿå‡ºé˜Ÿï¼Œæˆ–ä»¥æ ˆçš„å½¢å¼è¿›è¡Œå…¥æ ˆå‡ºæ ˆ</li><li>è·å–å…¨éƒ¨æ•°æ®æ“ä½œç»“æŸç´¢å¼•è®¾ç½®ä¸º -1</li><li>list å¯ä»¥å¯¹æ•°æ®è¿›è¡Œåˆ†é¡µæ“ä½œï¼Œé€šå¸¸ç¬¬ä¸€é¡µçš„ä¿¡æ¯æ¥è‡ªäº listï¼Œç¬¬ 2 é¡µåŠæ›´å¤šçš„ä¿¡æ¯é€šè¿‡æ•°æ®åº“çš„å½¢å¼åŠ è½½</li></ol><hr><h4 id="å®ç°-2" tabindex="-1"><a class="header-anchor" href="#å®ç°-2" aria-hidden="true">#</a> å®ç°</h4><p>åœ¨ Redis3.2 ç‰ˆæœ¬ä»¥å‰åˆ—è¡¨å¯¹è±¡çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ï¼šziplistï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰å’Œ linkedlistï¼ˆé“¾è¡¨ï¼‰</p><ul><li><p>å‹ç¼©åˆ—è¡¨å®ç°çš„åˆ—è¡¨å¯¹è±¡ï¼šPUSH 1ã€threeã€5 ä¸‰ä¸ªå…ƒç´ </p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-åˆ—è¡¨å¯¹è±¡ziplist.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></li><li><p>é“¾è¡¨å®ç°çš„åˆ—è¡¨å¯¹è±¡ï¼šä¸ºäº†ç®€åŒ–å­—ç¬¦ä¸²å¯¹è±¡çš„è¡¨ç¤ºï¼Œä½¿ç”¨äº† StringObject çš„ç»“æ„ï¼Œåº•å±‚å…¶å®æ˜¯ sdshdr ç»“æ„</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-åˆ—è¡¨å¯¹è±¡linkedlist.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></li></ul><p>åˆ—è¡¨ä¸­å­˜å‚¨çš„æ•°æ®é‡æ¯”è¾ƒå°çš„æ—¶å€™ï¼Œåˆ—è¡¨å°±ä¼šä½¿ç”¨ä¸€å—è¿ç»­çš„å†…å­˜å­˜å‚¨ï¼Œé‡‡ç”¨å‹ç¼©åˆ—è¡¨çš„æ–¹å¼å®ç°çš„æ¡ä»¶ï¼š</p><ul><li>åˆ—è¡¨å¯¹è±¡ä¿å­˜çš„æ‰€æœ‰å­—ç¬¦ä¸²å…ƒç´ çš„é•¿åº¦éƒ½å°äº 64 å­—èŠ‚</li><li>åˆ—è¡¨å¯¹è±¡ä¿å­˜çš„å…ƒç´ æ•°é‡å°äº 512 ä¸ª</li></ul><p>ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶çš„ä¸Šé™å€¼æ˜¯å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ä¿®æ”¹çš„ï¼Œå½“ä¸¤ä¸ªæ¡ä»¶çš„ä»»æ„ä¸€ä¸ªä¸èƒ½è¢«æ»¡è¶³æ—¶ï¼Œå¯¹è±¡çš„ç¼–ç è½¬æ¢æ“ä½œå°±ä¼šè¢«æ‰§è¡Œ</p><p>åœ¨ Redis3.2 ç‰ˆæœ¬ ä»¥åå¯¹åˆ—è¡¨æ•°æ®ç»“æ„è¿›è¡Œäº†æ”¹é€ ï¼Œä½¿ç”¨ **quicklistï¼ˆå¿«é€Ÿåˆ—è¡¨ï¼‰**ä»£æ›¿äº† linkedlistï¼Œquicklist å®é™…ä¸Šæ˜¯ ziplist å’Œ linkedlist çš„æ··åˆä½“ï¼Œå°† linkedlist æŒ‰æ®µåˆ‡åˆ†ï¼Œæ¯ä¸€æ®µä½¿ç”¨ ziplist æ¥ç´§å‡‘å­˜å‚¨ï¼Œå¤šä¸ª ziplist ä¹‹é—´ä½¿ç”¨åŒå‘æŒ‡é’ˆä¸²æ¥èµ·æ¥ï¼Œæ—¢æ»¡è¶³äº†å¿«é€Ÿçš„æ’å…¥åˆ é™¤æ€§èƒ½ï¼Œåˆä¸ä¼šå‡ºç°å¤ªå¤§çš„ç©ºé—´å†—ä½™</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å¿«é€Ÿåˆ—è¡¨æ•°æ®ç»“æ„.png" style="zoom:50%;"><hr><h4 id="åº”ç”¨-2" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨-2" aria-hidden="true">#</a> åº”ç”¨</h4><p>ä¼ä¸šè¿è¥è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿå°†äº§ç”Ÿå‡ºå¤§é‡çš„è¿è¥æ•°æ®ï¼Œå¦‚ä½•ä¿éšœå¤šå°æœåŠ¡å™¨æ“ä½œæ—¥å¿—çš„ç»Ÿä¸€é¡ºåºè¾“å‡ºï¼Ÿ</p><ul><li>ä¾èµ– list çš„æ•°æ®å…·æœ‰é¡ºåºçš„ç‰¹å¾å¯¹ä¿¡æ¯è¿›è¡Œç®¡ç†ï¼Œå³è¿›å·¦æŸ¥æˆ–è€…å·¦è¿‘å·¦æŸ¥</li><li>ä½¿ç”¨é˜Ÿåˆ—æ¨¡å‹è§£å†³å¤šè·¯ä¿¡æ¯æ±‡æ€»åˆå¹¶çš„é—®é¢˜</li><li>ä½¿ç”¨æ ˆæ¨¡å‹è§£å†³æœ€æ–°æ¶ˆæ¯çš„é—®é¢˜</li></ul><p>å¾®ä¿¡æ–‡ç« è®¢é˜…å…¬ä¼—å·ï¼š</p><ul><li>æ¯”å¦‚è®¢é˜…äº†ä¸¤ä¸ªå…¬ä¼—å·ï¼Œå®ƒä»¬å‘å¸ƒäº†ä¸¤ç¯‡æ–‡ç« ï¼Œæ–‡ç«  ID åˆ†åˆ«ä¸º 666 å’Œ 888ï¼Œå¯ä»¥é€šè¿‡æ‰§è¡Œ <code>LPUSH key 666 888</code> å‘½ä»¤æ¨é€ç»™æˆ‘</li></ul><hr><h3 id="set" tabindex="-1"><a class="header-anchor" href="#set" aria-hidden="true">#</a> set</h3><h4 id="ç®€ä»‹-3" tabindex="-1"><a class="header-anchor" href="#ç®€ä»‹-3" aria-hidden="true">#</a> ç®€ä»‹</h4><p>æ•°æ®å­˜å‚¨éœ€æ±‚ï¼šå­˜å‚¨å¤§é‡çš„æ•°æ®ï¼Œåœ¨æŸ¥è¯¢æ–¹é¢æä¾›æ›´é«˜çš„æ•ˆç‡</p><p>æ•°æ®å­˜å‚¨ç»“æ„ï¼šèƒ½å¤Ÿä¿å­˜å¤§é‡çš„æ•°æ®ï¼Œé«˜æ•ˆçš„å†…éƒ¨å­˜å‚¨æœºåˆ¶ï¼Œä¾¿äºæŸ¥è¯¢</p><p>set ç±»å‹ï¼šä¸ hash å­˜å‚¨ç»“æ„å“ˆå¸Œè¡¨å®Œå…¨ç›¸åŒï¼Œåªæ˜¯ä»…å­˜å‚¨é”®ä¸å­˜å‚¨å€¼ï¼ˆnilï¼‰ï¼Œæ‰€ä»¥æ·»åŠ ï¼Œåˆ é™¤ï¼ŒæŸ¥æ‰¾çš„å¤æ‚åº¦éƒ½æ˜¯ O(1)ï¼Œå¹¶ä¸”<strong>å€¼æ˜¯ä¸å…è®¸é‡å¤ä¸”æ— åºçš„</strong></p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/setç»“æ„å›¾.png" style="zoom:33%;"><hr><h4 id="æ“ä½œ-3" tabindex="-1"><a class="header-anchor" href="#æ“ä½œ-3" aria-hidden="true">#</a> æ“ä½œ</h4><p>æŒ‡ä»¤æ“ä½œï¼š</p><ul><li><p>æ•°æ®æ“ä½œ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>sadd key member1 <span class="token punctuation">[</span>member2<span class="token punctuation">]</span>	<span class="token comment">#æ·»åŠ æ•°æ®</span>
srem key member1 <span class="token punctuation">[</span>member2<span class="token punctuation">]</span>	<span class="token comment">#åˆ é™¤æ•°æ®</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æŸ¥è¯¢æ“ä½œ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>smembers key				<span class="token comment">#è·å–å…¨éƒ¨æ•°æ®</span>
scard key					<span class="token comment">#è·å–é›†åˆæ•°æ®æ€»é‡</span>
sismember key member		<span class="token comment">#åˆ¤æ–­é›†åˆä¸­æ˜¯å¦åŒ…å«æŒ‡å®šæ•°æ®</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>éšæœºæ“ä½œ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>spop key <span class="token punctuation">[</span>count<span class="token punctuation">]</span>			<span class="token comment">#éšæœºè·å–é›†ä¸­çš„æŸä¸ªæ•°æ®å¹¶å°†è¯¥æ•°æ®ç§»é™¤é›†åˆ</span>
srandmember key <span class="token punctuation">[</span>count<span class="token punctuation">]</span>		<span class="token comment">#éšæœºè·å–é›†åˆä¸­æŒ‡å®š(æ•°é‡)çš„æ•°æ®</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>é›†åˆçš„äº¤ã€å¹¶ã€å·®</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>sinter key1 <span class="token punctuation">[</span>key2<span class="token punctuation">..</span>.<span class="token punctuation">]</span>  					<span class="token comment">#ä¸¤ä¸ªé›†åˆçš„äº¤é›†ï¼Œä¸å­˜åœ¨ä¸º(empty list or set)</span>
sunion key1 <span class="token punctuation">[</span>key2<span class="token punctuation">..</span>.<span class="token punctuation">]</span>  					<span class="token comment">#ä¸¤ä¸ªé›†åˆçš„å¹¶é›†</span>
<span class="token function">sdiff</span> key1 <span class="token punctuation">[</span>key2<span class="token punctuation">..</span>.<span class="token punctuation">]</span>					<span class="token comment">#ä¸¤ä¸ªé›†åˆçš„å·®é›†</span>

sinterstore destination key1 <span class="token punctuation">[</span>key2<span class="token punctuation">..</span>.<span class="token punctuation">]</span>	<span class="token comment">#ä¸¤ä¸ªé›†åˆçš„äº¤é›†å¹¶å­˜å‚¨åˆ°æŒ‡å®šé›†åˆä¸­</span>
sunionstore destination key1 <span class="token punctuation">[</span>key2<span class="token punctuation">..</span>.<span class="token punctuation">]</span>	<span class="token comment">#ä¸¤ä¸ªé›†åˆçš„å¹¶é›†å¹¶å­˜å‚¨åˆ°æŒ‡å®šé›†åˆä¸­</span>
sdiffstore destination key1 <span class="token punctuation">[</span>key2<span class="token punctuation">..</span>.<span class="token punctuation">]</span>	<span class="token comment">#ä¸¤ä¸ªé›†åˆçš„å·®é›†å¹¶å­˜å‚¨åˆ°æŒ‡å®šé›†åˆä¸­</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>å¤åˆ¶</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>smove <span class="token builtin class-name">source</span> destination member			<span class="token comment">#å°†æŒ‡å®šæ•°æ®ä»åŸå§‹é›†åˆä¸­ç§»åŠ¨åˆ°ç›®æ ‡é›†åˆä¸­</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><p>æ³¨æ„äº‹é¡¹</p><ol><li>set ç±»å‹ä¸å…è®¸æ•°æ®é‡å¤ï¼Œå¦‚æœæ·»åŠ çš„æ•°æ®åœ¨ set ä¸­å·²ç»å­˜åœ¨ï¼Œå°†åªä¿ç•™ä¸€ä»½</li><li>set è™½ç„¶ä¸ hash çš„å­˜å‚¨ç»“æ„ç›¸åŒï¼Œä½†æ˜¯æ— æ³•å¯ç”¨ hash ä¸­å­˜å‚¨å€¼çš„ç©ºé—´</li></ol><hr><h4 id="å®ç°-3" tabindex="-1"><a class="header-anchor" href="#å®ç°-3" aria-hidden="true">#</a> å®ç°</h4><p>é›†åˆå¯¹è±¡çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ï¼šintsetï¼ˆæ•´æ•°é›†åˆï¼‰ã€hashtableï¼ˆå“ˆå¸Œè¡¨ã€å­—å…¸ï¼‰</p><ul><li><p>æ•´æ•°é›†åˆå®ç°çš„é›†åˆå¯¹è±¡ï¼š</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-é›†åˆå¯¹è±¡intset.png" style="zoom:67%;"></li><li><p>å­—å…¸å®ç°çš„é›†åˆå¯¹è±¡ï¼šé”®å€¼å¯¹çš„å€¼ä¸º NULL</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-é›†åˆå¯¹è±¡dict.png" style="zoom:80%;"></li></ul><p>å½“é›†åˆå¯¹è±¡å¯ä»¥åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œå¯¹è±¡ä½¿ç”¨ intset ç¼–ç ï¼š</p><ul><li>é›†åˆä¸­çš„å…ƒç´ éƒ½æ˜¯æ•´æ•°å€¼</li><li>é›†åˆä¸­çš„å…ƒç´ æ•°é‡å°äº set-maxintset-entriesé…ç½®ï¼ˆé»˜è®¤ 512 ä¸ªï¼‰</li></ul><p>ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶çš„ä¸Šé™å€¼æ˜¯å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ä¿®æ”¹çš„</p><hr><h4 id="åº”ç”¨-3" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨-3" aria-hidden="true">#</a> åº”ç”¨</h4><p>åº”ç”¨åœºæ™¯ï¼š</p><ol><li><p>é»‘åå•ï¼šèµ„è®¯ç±»ä¿¡æ¯ç±»ç½‘ç«™è¿½æ±‚é«˜è®¿é—®é‡ï¼Œä½†æ˜¯ç”±äºå…¶ä¿¡æ¯çš„ä»·å€¼ï¼Œå¾€å¾€å®¹æ˜“è¢«ä¸æ³•åˆ†å­åˆ©ç”¨ï¼Œé€šè¿‡çˆ¬è™«æŠ€æœ¯ï¼Œå¿«é€Ÿè·å–ä¿¡æ¯ï¼Œä¸ªåˆ«ç‰¹ç§è¡Œä¸šç½‘ç«™ä¿¡æ¯é€šè¿‡çˆ¬è™«è·å–åˆ†æåï¼Œå¯ä»¥è½¬æ¢æˆå•†ä¸šæœºå¯†ã€‚</p><p>æ³¨æ„ï¼šçˆ¬è™«ä¸ä¸€å®šåšæ‘§æ¯æ€§çš„å·¥ä½œï¼Œæœ‰äº›å°å‹ç½‘ç«™éœ€è¦çˆ¬è™«ä¸ºå…¶å¸¦æ¥ä¸€äº›æµé‡ã€‚</p></li><li><p>ç™½åå•ï¼šå¯¹äºå®‰å…¨æ€§æ›´é«˜çš„åº”ç”¨è®¿é—®ï¼Œä»…ä»…é é»‘åå•æ˜¯ä¸èƒ½è§£å†³å®‰å…¨é—®é¢˜çš„ï¼Œæ­¤æ—¶éœ€è¦è®¾å®šå¯è®¿é—®çš„ç”¨æˆ·ç¾¤ä½“ï¼Œ ä¾èµ–ç™½åå•åšæ›´ä¸ºè‹›åˆ»çš„è®¿é—®éªŒè¯</p></li><li><p>éšæœºæ“ä½œå¯ä»¥å®ç°æŠ½å¥–åŠŸèƒ½</p></li><li><p>é›†åˆçš„äº¤å¹¶è¡¥å¯ä»¥å®ç°å¾®åšå…±åŒå…³æ³¨çš„æŸ¥çœ‹ï¼Œå¯ä»¥æ ¹æ®å…±åŒå…³æ³¨æˆ–è€…å…±åŒå–œæ¬¢æ¨èç›¸å…³å†…å®¹</p></li></ol><hr><h3 id="zset" tabindex="-1"><a class="header-anchor" href="#zset" aria-hidden="true">#</a> zset</h3><h4 id="ç®€ä»‹-4" tabindex="-1"><a class="header-anchor" href="#ç®€ä»‹-4" aria-hidden="true">#</a> ç®€ä»‹</h4><p>æ•°æ®å­˜å‚¨éœ€æ±‚ï¼šæ•°æ®æ’åºæœ‰åˆ©äºæ•°æ®çš„æœ‰æ•ˆå±•ç¤ºï¼Œéœ€è¦æä¾›ä¸€ç§å¯ä»¥æ ¹æ®è‡ªèº«ç‰¹å¾è¿›è¡Œæ’åºçš„æ–¹å¼</p><p>æ•°æ®å­˜å‚¨ç»“æ„ï¼šæ–°çš„å­˜å‚¨æ¨¡å‹ï¼Œå¯ä»¥ä¿å­˜å¯æ’åºçš„æ•°æ®</p><hr><h4 id="æ“ä½œ-4" tabindex="-1"><a class="header-anchor" href="#æ“ä½œ-4" aria-hidden="true">#</a> æ“ä½œ</h4><p>æŒ‡ä»¤æ“ä½œï¼š</p><ul><li><p>æ•°æ®æ“ä½œ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>zadd key score1 member1 <span class="token punctuation">[</span>score2 member2<span class="token punctuation">]</span>	<span class="token comment">#æ·»åŠ æ•°æ®</span>
zrem key member <span class="token punctuation">[</span>member <span class="token punctuation">..</span>.<span class="token punctuation">]</span>				<span class="token comment">#åˆ é™¤æ•°æ®</span>
zremrangebyrank key start stop 				<span class="token comment">#åˆ é™¤æŒ‡å®šç´¢å¼•èŒƒå›´çš„æ•°æ®</span>
zremrangebyscore key min max				<span class="token comment">#åˆ é™¤æŒ‡å®šåˆ†æ•°åŒºé—´å†…çš„æ•°æ®</span>
zscore key member							<span class="token comment">#è·å–æŒ‡å®šå€¼çš„åˆ†æ•°</span>
zincrby key increment member				<span class="token comment">#æŒ‡å®šå€¼çš„åˆ†æ•°å¢åŠ increment</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æŸ¥è¯¢æ“ä½œ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>zrange key start stop <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span>		<span class="token comment">#è·å–æŒ‡å®šèŒƒå›´çš„æ•°æ®ï¼Œå‡åºï¼ŒWITHSCORES ä»£è¡¨æ˜¾ç¤ºåˆ†æ•°</span>
zrevrange key start stop <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span>	<span class="token comment">#è·å–æŒ‡å®šèŒƒå›´çš„æ•°æ®ï¼Œé™åº</span>

zrangebyscore key min max <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span> <span class="token punctuation">[</span>LIMIT offset count<span class="token punctuation">]</span>	<span class="token comment">#æŒ‰æ¡ä»¶è·å–æ•°æ®ï¼Œä»å°åˆ°å¤§</span>
zrevrangebyscore key max min <span class="token punctuation">[</span>WITHSCORES<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span>				<span class="token comment">#ä»å¤§åˆ°å°</span>

zcard key										<span class="token comment">#è·å–é›†åˆæ•°æ®çš„æ€»é‡</span>
zcount key min max								<span class="token comment">#è·å–æŒ‡å®šåˆ†æ•°åŒºé—´å†…çš„æ•°æ®æ€»é‡</span>
zrank key member								<span class="token comment">#è·å–æ•°æ®å¯¹åº”çš„ç´¢å¼•ï¼ˆæ’åï¼‰å‡åº</span>
zrevrank key member								<span class="token comment">#è·å–æ•°æ®å¯¹åº”çš„ç´¢å¼•ï¼ˆæ’åï¼‰é™åº</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>min ä¸ max ç”¨äºé™å®šæœç´¢æŸ¥è¯¢çš„æ¡ä»¶</li><li>start ä¸ stop ç”¨äºé™å®šæŸ¥è¯¢èŒƒå›´ï¼Œä½œç”¨äºç´¢å¼•ï¼Œè¡¨ç¤ºå¼€å§‹å’Œç»“æŸç´¢å¼•</li><li>offset ä¸ count ç”¨äºé™å®šæŸ¥è¯¢èŒƒå›´ï¼Œä½œç”¨äºæŸ¥è¯¢ç»“æœï¼Œè¡¨ç¤ºå¼€å§‹ä½ç½®å’Œæ•°æ®æ€»é‡</li></ul></li><li><p>é›†åˆçš„äº¤ã€å¹¶æ“ä½œ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>zinterstore destination numkeys key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span>	<span class="token comment">#ä¸¤ä¸ªé›†åˆçš„äº¤é›†å¹¶å­˜å‚¨åˆ°æŒ‡å®šé›†åˆä¸­</span>
zunionstore destination numkeys key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span>	<span class="token comment">#ä¸¤ä¸ªé›†åˆçš„å¹¶é›†å¹¶å­˜å‚¨åˆ°æŒ‡å®šé›†åˆä¸­</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>æ³¨æ„äº‹é¡¹ï¼š</p><ol><li>score ä¿å­˜çš„æ•°æ®å­˜å‚¨ç©ºé—´æ˜¯ 64 ä½ï¼Œå¦‚æœæ˜¯æ•´æ•°èŒƒå›´æ˜¯ -9007199254740992~9007199254740992</li><li>score ä¿å­˜çš„æ•°æ®ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªåŒç²¾åº¦çš„ double å€¼ï¼ŒåŸºäºåŒç²¾åº¦æµ®ç‚¹æ•°çš„ç‰¹å¾å¯èƒ½ä¼šä¸¢å¤±ç²¾åº¦ï¼Œæ…é‡ä½¿ç”¨</li><li>sorted_set åº•å±‚å­˜å‚¨è¿˜æ˜¯åŸºäº set ç»“æ„çš„ï¼Œå› æ­¤æ•°æ®ä¸èƒ½é‡å¤ï¼Œå¦‚æœé‡å¤æ·»åŠ ç›¸åŒçš„æ•°æ®ï¼Œscore å€¼å°†è¢«åå¤è¦†ç›–ï¼Œä¿ç•™æœ€åä¸€æ¬¡ä¿®æ”¹çš„ç»“æœ</li></ol><hr><h4 id="å®ç°-4" tabindex="-1"><a class="header-anchor" href="#å®ç°-4" aria-hidden="true">#</a> å®ç°</h4><p>æœ‰åºé›†åˆå¯¹è±¡çš„å†…éƒ¨ç¼–ç æœ‰ä¸¤ç§ï¼šziplistï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰å’Œ skiplistï¼ˆè·³è·ƒè¡¨ï¼‰</p><ul><li><p>å‹ç¼©åˆ—è¡¨å®ç°æœ‰åºé›†åˆå¯¹è±¡ï¼šziplist æœ¬èº«æ˜¯æœ‰åºã€ä¸å¯é‡å¤çš„ï¼Œç¬¦åˆæœ‰åºé›†åˆçš„ç‰¹æ€§</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-æœ‰åºé›†åˆå¯¹è±¡ziplist.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></li><li><p>è·³è·ƒè¡¨å®ç°æœ‰åºé›†åˆå¯¹è±¡ï¼š<strong>åº•å±‚æ˜¯ zset ç»“æ„ï¼Œzset åŒæ—¶åŒ…å«å­—å…¸å’Œè·³è·ƒè¡¨çš„ç»“æ„</strong>ï¼Œå›¾ç¤ºå­—å…¸å’Œè·³è·ƒè¡¨ä¸­é‡å¤å±•ç¤ºäº†å„ä¸ªå…ƒç´ çš„æˆå‘˜å’Œåˆ†å€¼ï¼Œä½†å®é™…ä¸Šä¸¤è€…ä¼š<strong>é€šè¿‡æŒ‡é’ˆæ¥å…±äº«ç›¸åŒå…ƒç´ çš„æˆå‘˜å’Œåˆ†å€¼</strong>ï¼Œä¸ä¼šäº§ç”Ÿç©ºé—´æµªè´¹</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">zset</span> <span class="token punctuation">{</span>
    zskiplist <span class="token operator">*</span>zsl<span class="token punctuation">;</span>
    dict <span class="token operator">*</span>dict<span class="token punctuation">;</span>
<span class="token punctuation">}</span> zset<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-æœ‰åºé›†åˆå¯¹è±¡zset.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></li></ul><p>ä½¿ç”¨å­—å…¸åŠ è·³è·ƒè¡¨çš„ä¼˜åŠ¿ï¼š</p><ul><li>å­—å…¸ä¸ºæœ‰åºé›†åˆåˆ›å»ºäº†ä¸€ä¸ª<strong>ä»æˆå‘˜åˆ°åˆ†å€¼çš„æ˜ å°„</strong>ï¼Œç”¨ O(1) å¤æ‚åº¦æŸ¥æ‰¾ç»™å®šæˆå‘˜çš„åˆ†å€¼</li><li><strong>æ’åºæ“ä½œä½¿ç”¨è·³è·ƒè¡¨å®Œæˆ</strong>ï¼ŒèŠ‚çœæ¯æ¬¡é‡æ–°æ’åºå¸¦æ¥çš„æ—¶é—´æˆæœ¬å’Œç©ºé—´æˆæœ¬</li></ul><p>ä½¿ç”¨ ziplist æ ¼å¼å­˜å‚¨éœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ul><li>æœ‰åºé›†åˆä¿å­˜çš„å…ƒç´ ä¸ªæ•°è¦å°äº 128 ä¸ªï¼›</li><li>æœ‰åºé›†åˆä¿å­˜çš„æ‰€æœ‰å…ƒç´ å¤§å°éƒ½å°äº 64 å­—èŠ‚</li></ul><p>å½“å…ƒç´ æ¯”è¾ƒå¤šæ—¶ï¼Œæ­¤æ—¶ ziplist çš„è¯»å†™æ•ˆç‡ä¼šä¸‹é™ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ï¼Œè·³è¡¨çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(logn)</p><p>ä¸ºä»€ä¹ˆç”¨è·³è¡¨è€Œä¸ç”¨å¹³è¡¡æ ‘ï¼Ÿ</p><ul><li>åœ¨åšèŒƒå›´æŸ¥æ‰¾çš„æ—¶å€™ï¼Œè·³è¡¨æ“ä½œç®€å•ï¼ˆå‰è¿›æŒ‡é’ˆæˆ–åé€€æŒ‡é’ˆï¼‰ï¼Œå¹³è¡¡æ ‘éœ€è¦å›æ—‹æŸ¥æ‰¾</li><li>è·³è¡¨æ¯”å¹³è¡¡æ ‘å®ç°ç®€å•ï¼Œå¹³è¡¡æ ‘çš„æ’å…¥å’Œåˆ é™¤æ“ä½œå¯èƒ½å¼•å‘å­æ ‘çš„æ—‹è½¬è°ƒæ•´ï¼Œè€Œè·³è¡¨çš„æ’å…¥å’Œåˆ é™¤åªéœ€è¦ä¿®æ”¹ç›¸é‚»èŠ‚ç‚¹çš„æŒ‡é’ˆ</li></ul><hr><h4 id="åº”ç”¨-4" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨-4" aria-hidden="true">#</a> åº”ç”¨</h4><ul><li>æ’è¡Œæ¦œ</li><li>å¯¹äºåŸºäºæ—¶é—´çº¿é™å®šçš„ä»»åŠ¡å¤„ç†ï¼Œå°†å¤„ç†æ—¶é—´è®°å½•ä¸º score å€¼ï¼Œåˆ©ç”¨æ’åºåŠŸèƒ½åŒºåˆ†å¤„ç†çš„å…ˆåé¡ºåº</li><li>å½“ä»»åŠ¡æˆ–è€…æ¶ˆæ¯å¾…å¤„ç†ï¼Œå½¢æˆäº†ä»»åŠ¡é˜Ÿåˆ—æˆ–æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œå¯¹äºé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡è¦ä¿éšœå¯¹å…¶ä¼˜å…ˆå¤„ç†ï¼Œé‡‡ç”¨ score è®°å½•æƒé‡</li></ul><hr><h3 id="bitmaps" tabindex="-1"><a class="header-anchor" href="#bitmaps" aria-hidden="true">#</a> Bitmaps</h3><h4 id="åŸºæœ¬æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ“ä½œ" aria-hidden="true">#</a> åŸºæœ¬æ“ä½œ</h4><p>Bitmaps æ˜¯äºŒè¿›åˆ¶ä½æ•°ç»„ï¼ˆbit arrayï¼‰ï¼Œåº•å±‚ä½¿ç”¨ SDS å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œå› ä¸º SDS æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-ä½æ•°ç»„ç»“æ„.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>buf æ•°ç»„çš„æ¯ä¸ªå­—èŠ‚ç”¨ä¸€è¡Œè¡¨ç¤ºï¼Œbuf[1] æ˜¯ <code>&#39;\0&#39;</code>ï¼Œä¿å­˜ä½æ•°ç»„çš„é¡ºåºå’Œä¹¦å†™ä½æ•°ç»„çš„é¡ºåºæ˜¯å®Œå…¨ç›¸åçš„ï¼Œå›¾ç¤ºçš„ä½æ•°ç»„ 0100 1101</p><p>æ•°æ®ç»“æ„çš„è¯¦è§£æŸ¥çœ‹ Java â†’ Algorithm â†’ ä½å›¾</p><hr><h4 id="å‘½ä»¤å®ç°" tabindex="-1"><a class="header-anchor" href="#å‘½ä»¤å®ç°" aria-hidden="true">#</a> å‘½ä»¤å®ç°</h4><h5 id="getbit" tabindex="-1"><a class="header-anchor" href="#getbit" aria-hidden="true">#</a> GETBIT</h5><p>GETBIT å‘½ä»¤è·å–ä½æ•°ç»„ bitarray åœ¨ offset åç§»é‡ä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>GETBIT <span class="token operator">&lt;</span>bitarray<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>offset<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ‰§è¡Œè¿‡ç¨‹ï¼š</p><ul><li>è®¡ç®— <code>byte = offset/8</code>ï¼ˆå‘ä¸‹å–æ•´ï¼‰, byte å€¼è®°å½•æ•°æ®ä¿å­˜åœ¨ä½æ•°ç»„ä¸­çš„ç´¢å¼•</li><li>è®¡ç®— <code>bit = (offset mod 8) + 1</code>ï¼Œbit å€¼è®°å½•æ•°æ®åœ¨ä½æ•°ç»„ä¸­çš„ç¬¬å‡ ä¸ªäºŒè¿›åˆ¶ä½</li><li>æ ¹æ® byte å’Œ bit å€¼ï¼Œåœ¨ä½æ•°ç»„ bitarray ä¸­å®šä½ offset åç§»é‡æŒ‡å®šçš„äºŒè¿›åˆ¶ä½ï¼Œå¹¶è¿”å›è¿™ä¸ªä½çš„å€¼</li></ul><p>GETBIT å‘½ä»¤æ‰§è¡Œçš„æ‰€æœ‰æ“ä½œéƒ½å¯ä»¥åœ¨å¸¸æ•°æ—¶é—´å†…å®Œæˆï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦ä¸º O(1)</p><hr><h5 id="setbit" tabindex="-1"><a class="header-anchor" href="#setbit" aria-hidden="true">#</a> SETBIT</h5><p>SETBIT å°†ä½æ•°ç»„ bitarray åœ¨ offset åç§»é‡ä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼è®¾ç½®ä¸º valueï¼Œå¹¶å‘å®¢æˆ·ç«¯è¿”å›äºŒè¿›åˆ¶ä½çš„æ—§å€¼</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>SETBIT <span class="token operator">&lt;</span>bitarray<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>offset<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>value<span class="token operator">&gt;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ‰§è¡Œè¿‡ç¨‹ï¼š</p><ul><li>è®¡ç®— <code>len = offset/8 + 1</code>ï¼Œlen å€¼è®°å½•äº†ä¿å­˜è¯¥æ•°æ®è‡³å°‘éœ€è¦å¤šå°‘ä¸ªå­—èŠ‚</li><li>æ£€æŸ¥ bitarray é”®ä¿å­˜çš„ä½æ•°ç»„çš„é•¿åº¦æ˜¯å¦å°äº lenï¼Œæˆç«‹å°±ä¼šå°† SDS æ‰©å±•ä¸º len å­—èŠ‚ï¼ˆæ³¨æ„ç©ºé—´é¢„åˆ†é…æœºåˆ¶ï¼‰ï¼Œæ‰€æœ‰æ–°æ‰©å±•ç©ºé—´çš„äºŒè¿›åˆ¶ä½çš„å€¼ç½®ä¸º 0</li><li>è®¡ç®— <code>byte = offset/8</code>ï¼ˆå‘ä¸‹å–æ•´ï¼‰, byte å€¼è®°å½•æ•°æ®ä¿å­˜åœ¨ä½æ•°ç»„ä¸­çš„ç´¢å¼•</li><li>è®¡ç®— <code>bit = (offset mod 8) + 1</code>ï¼Œbit å€¼è®°å½•æ•°æ®åœ¨ä½æ•°ç»„ä¸­çš„ç¬¬å‡ ä¸ªäºŒè¿›åˆ¶ä½</li><li>æ ¹æ® byte å’Œ bit å€¼ï¼Œåœ¨ä½æ•°ç»„ bitarray ä¸­å®šä½ offset åç§»é‡æŒ‡å®šçš„äºŒè¿›åˆ¶ä½ï¼Œé¦–å…ˆå°†æŒ‡å®šä½ç°å­˜çš„å€¼ä¿å­˜åœ¨ oldvalue å˜é‡ï¼Œç„¶åå°†æ–°å€¼ value è®¾ç½®ä¸ºè¿™ä¸ªäºŒè¿›åˆ¶ä½çš„å€¼</li><li>å‘å®¢æˆ·ç«¯è¿”å› oldvalue å˜é‡çš„å€¼</li></ul><hr><h5 id="bitcount" tabindex="-1"><a class="header-anchor" href="#bitcount" aria-hidden="true">#</a> BITCOUNT</h5><p>BITCOUNT å‘½ä»¤ç”¨äºç»Ÿè®¡ç»™å®šä½æ•°ç»„ä¸­ï¼Œå€¼ä¸º 1 çš„äºŒè¿›åˆ¶ä½çš„æ•°é‡</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>BITCOUNT <span class="token operator">&lt;</span>bitarray<span class="token operator">&gt;</span> <span class="token punctuation">[</span>start end<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼š</p><ul><li>éå†æ³•ï¼šéå†ä½æ•°ç»„ä¸­çš„æ¯ä¸ªäºŒè¿›åˆ¶ä½</li><li>æŸ¥è¡¨ç®—æ³•ï¼šè¯»å–æ¯ä¸ªå­—èŠ‚ï¼ˆ8 ä½ï¼‰çš„æ•°æ®ï¼ŒæŸ¥è¡¨è·å–æ•°å€¼å¯¹åº”çš„äºŒè¿›åˆ¶ä¸­æœ‰å‡ ä¸ª 1</li><li>variable-precision SWARç®—æ³•ï¼šè®¡ç®—æ±‰æ˜è·ç¦»</li><li>Redis å®ç°ï¼š <ul><li>å¦‚æœäºŒè¿›åˆ¶ä½çš„æ•°é‡å¤§äºç­‰äº 128 ä½ï¼Œ é‚£ä¹ˆä½¿ç”¨ variable-precision SWAR ç®—æ³•æ¥è®¡ç®—äºŒè¿›åˆ¶ä½çš„æ±‰æ˜é‡é‡</li><li>å¦‚æœäºŒè¿›åˆ¶ä½çš„æ•°é‡å°äº 128 ä½ï¼Œé‚£ä¹ˆä½¿ç”¨æŸ¥è¡¨ç®—æ³•æ¥è®¡ç®—äºŒè¿›åˆ¶ä½çš„æ±‰æ˜é‡é‡</li></ul></li></ul><hr><h5 id="bitop" tabindex="-1"><a class="header-anchor" href="#bitop" aria-hidden="true">#</a> BITOP</h5><p>BITOP å‘½ä»¤å¯¹æŒ‡å®š key æŒ‰ä½è¿›è¡Œäº¤ã€å¹¶ã€éã€å¼‚æˆ–æ“ä½œï¼Œå¹¶å°†ç»“æœä¿å­˜åˆ°æŒ‡å®šçš„é”®ä¸­</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>BITOP OPTION destKey key1 <span class="token punctuation">[</span>key2<span class="token punctuation">..</span>.<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>OPTION æœ‰ ANDï¼ˆä¸ï¼‰ã€ORï¼ˆæˆ–ï¼‰ã€ XORï¼ˆå¼‚æˆ–ï¼‰å’Œ NOTï¼ˆéï¼‰å››ä¸ªé€‰é¡¹</p><p>ANDã€ORã€XOR ä¸‰ä¸ªå‘½ä»¤å¯ä»¥æ¥å—å¤šä¸ªä½æ•°ç»„ä½œä¸ºè¾“å…¥ï¼Œéœ€è¦éå†è¾“å…¥çš„æ¯ä¸ªä½æ•°ç»„çš„æ¯ä¸ªå­—èŠ‚æ¥è¿›è¡Œè®¡ç®—ï¼Œæ‰€ä»¥å‘½ä»¤çš„å¤æ‚åº¦ä¸º O(n^2)ï¼›ä¸æ­¤ç›¸åï¼ŒNOT å‘½ä»¤åªæ¥å—ä¸€ä¸ªä½æ•°ç»„è¾“å…¥ï¼Œæ‰€ä»¥æ—¶é—´å¤æ‚åº¦ä¸º O(n)</p><hr><h4 id="åº”ç”¨åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨åœºæ™¯" aria-hidden="true">#</a> åº”ç”¨åœºæ™¯</h4><ul><li><p><strong>è§£å†³ Redis ç¼“å­˜ç©¿é€</strong>ï¼Œåˆ¤æ–­ç»™å®šæ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œ é˜²æ­¢ç¼“å­˜ç©¿é€</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-Bitmapsåº”ç”¨ä¹‹ç¼“å­˜ç©¿é€.png" style="zoom:67%;"></li><li><p>åƒåœ¾é‚®ä»¶è¿‡æ»¤ï¼Œå¯¹æ¯ä¸€ä¸ªå‘é€é‚®ä»¶çš„åœ°å€è¿›è¡Œåˆ¤æ–­æ˜¯å¦åœ¨å¸ƒéš†çš„é»‘åå•ä¸­ï¼Œå¦‚æœåœ¨å°±åˆ¤æ–­ä¸ºåƒåœ¾é‚®ä»¶</p></li><li><p>çˆ¬è™«å»é‡ï¼Œçˆ¬ç»™å®šç½‘å€çš„æ—¶å€™å¯¹å·²ç»çˆ¬å–è¿‡çš„ URL å»é‡</p></li><li><p>ä¿¡æ¯çŠ¶æ€ç»Ÿè®¡</p></li></ul><hr><h3 id="hyper" tabindex="-1"><a class="header-anchor" href="#hyper" aria-hidden="true">#</a> Hyper</h3><p>åŸºæ•°æ˜¯æ•°æ®é›†å»é‡åå…ƒç´ ä¸ªæ•°ï¼ŒHyperLogLog æ˜¯ç”¨æ¥åšåŸºæ•°ç»Ÿè®¡çš„ï¼Œè¿ç”¨äº† LogLog çš„ç®—æ³•</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">}</span> 	åŸºæ•°é›†ï¼š <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">}</span> 	åŸºæ•°ï¼š<span class="token number">5</span>
<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span> 	åŸºæ•°é›†ï¼š <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">}</span> 				åŸºæ•°ï¼š<span class="token number">2</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ç›¸å…³æŒ‡ä»¤ï¼š</p><ul><li><p>æ·»åŠ æ•°æ®</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>pfadd key element <span class="token punctuation">[</span>element <span class="token punctuation">..</span>.<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>ç»Ÿè®¡æ•°æ®</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>pfcount key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>åˆå¹¶æ•°æ®</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>pfmerge destkey sourcekey <span class="token punctuation">[</span>sourcekey<span class="token punctuation">..</span>.<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><p>åº”ç”¨åœºæ™¯ï¼š</p><ul><li>ç”¨äºè¿›è¡ŒåŸºæ•°ç»Ÿè®¡ï¼Œä¸æ˜¯é›†åˆä¸ä¿å­˜æ•°æ®ï¼Œåªè®°å½•æ•°é‡è€Œä¸æ˜¯å…·ä½“æ•°æ®ï¼Œæ¯”å¦‚ç½‘ç«™çš„è®¿é—®é‡</li><li>æ ¸å¿ƒæ˜¯åŸºæ•°ä¼°ç®—ç®—æ³•ï¼Œæœ€ç»ˆæ•°å€¼å­˜åœ¨ä¸€å®šè¯¯å·®</li><li>è¯¯å·®èŒƒå›´ï¼šåŸºæ•°ä¼°è®¡çš„ç»“æœæ˜¯ä¸€ä¸ªå¸¦æœ‰ 0.81% æ ‡å‡†é”™è¯¯çš„è¿‘ä¼¼å€¼</li><li>è€—ç©ºé—´æå°ï¼Œæ¯ä¸ª hyperloglog key å ç”¨äº†12Kçš„å†…å­˜ç”¨äºæ ‡è®°åŸºæ•°</li><li>pfadd å‘½ä»¤ä¸æ˜¯ä¸€æ¬¡æ€§åˆ†é…12Kå†…å­˜ä½¿ç”¨ï¼Œä¼šéšç€åŸºæ•°çš„å¢åŠ å†…å­˜é€æ¸å¢å¤§</li><li>Pfmerge å‘½ä»¤åˆå¹¶åå ç”¨çš„å­˜å‚¨ç©ºé—´ä¸º12Kï¼Œæ— è®ºåˆå¹¶ä¹‹å‰æ•°æ®é‡å¤šå°‘</li></ul><hr><h3 id="geo" tabindex="-1"><a class="header-anchor" href="#geo" aria-hidden="true">#</a> GEO</h3><p>GeoHash æ˜¯ä¸€ç§åœ°å€ç¼–ç æ–¹æ³•ï¼ŒæŠŠäºŒç»´çš„ç©ºé—´ç»çº¬åº¦æ•°æ®ç¼–ç æˆä¸€ä¸ªå­—ç¬¦ä¸²</p><ul><li><p>æ·»åŠ åæ ‡ç‚¹</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>geoadd key longitude latitude member <span class="token punctuation">[</span>longitude latitude member <span class="token punctuation">..</span>.<span class="token punctuation">]</span>
georadius key longitude latitude radius m<span class="token operator">|</span>km<span class="token operator">|</span>ft<span class="token operator">|</span>mi <span class="token punctuation">[</span>withcoord<span class="token punctuation">]</span> <span class="token punctuation">[</span>withdist<span class="token punctuation">]</span> <span class="token punctuation">[</span>withhash<span class="token punctuation">]</span> <span class="token punctuation">[</span>count count<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>è·å–åæ ‡ç‚¹</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>geopos key member <span class="token punctuation">[</span>member <span class="token punctuation">..</span>.<span class="token punctuation">]</span>
georadiusbymember key member radius m<span class="token operator">|</span>km<span class="token operator">|</span>ft<span class="token operator">|</span>mi <span class="token punctuation">[</span>withcoord<span class="token punctuation">]</span> <span class="token punctuation">[</span>withdist<span class="token punctuation">]</span> <span class="token punctuation">[</span>withhash<span class="token punctuation">]</span> <span class="token punctuation">[</span>count count<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>è®¡ç®—è·ç¦»</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>geodist key member1 member2 <span class="token punctuation">[</span>unit<span class="token punctuation">]</span>	<span class="token comment">#è®¡ç®—åæ ‡ç‚¹è·ç¦»</span>
geohash key member <span class="token punctuation">[</span>member <span class="token punctuation">..</span>.<span class="token punctuation">]</span>		<span class="token comment">#è®¡ç®—ç»çº¬åº¦</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>Redis åº”ç”¨äºåœ°ç†ä½ç½®è®¡ç®—</p><hr><h2 id="æŒä¹…æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#æŒä¹…æœºåˆ¶" aria-hidden="true">#</a> æŒä¹…æœºåˆ¶</h2><h3 id="æ¦‚è¿°-1" tabindex="-1"><a class="header-anchor" href="#æ¦‚è¿°-1" aria-hidden="true">#</a> æ¦‚è¿°</h3><p>æŒä¹…åŒ–ï¼šåˆ©ç”¨æ°¸ä¹…æ€§å­˜å‚¨ä»‹è´¨å°†æ•°æ®è¿›è¡Œä¿å­˜ï¼Œåœ¨ç‰¹å®šçš„æ—¶é—´å°†ä¿å­˜çš„æ•°æ®è¿›è¡Œæ¢å¤çš„å·¥ä½œæœºåˆ¶ç§°ä¸ºæŒä¹…åŒ–</p><p>ä½œç”¨ï¼šæŒä¹…åŒ–ç”¨äºé˜²æ­¢æ•°æ®çš„æ„å¤–ä¸¢å¤±ï¼Œç¡®ä¿æ•°æ®å®‰å…¨æ€§ï¼Œå› ä¸º Redis æ˜¯å†…å­˜çº§ï¼Œæ‰€ä»¥éœ€è¦æŒä¹…åŒ–åˆ°ç£ç›˜</p><p>è®¡ç®—æœºä¸­çš„æ•°æ®å…¨éƒ¨éƒ½æ˜¯äºŒè¿›åˆ¶ï¼Œä¿å­˜ä¸€ç»„æ•°æ®æœ‰ä¸¤ç§æ–¹å¼<br><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-æŒä¹…åŒ–çš„ä¸¤ç§æ–¹å¼.png" style="zoom:33%;"></p><p>RDBï¼šå°†å½“å‰æ•°æ®çŠ¶æ€è¿›è¡Œä¿å­˜ï¼Œå¿«ç…§å½¢å¼ï¼Œå­˜å‚¨æ•°æ®ç»“æœï¼Œå­˜å‚¨æ ¼å¼ç®€å•</p><p>AOFï¼šå°†æ•°æ®çš„æ“ä½œè¿‡ç¨‹è¿›è¡Œä¿å­˜ï¼Œæ—¥å¿—å½¢å¼ï¼Œå­˜å‚¨æ“ä½œè¿‡ç¨‹ï¼Œå­˜å‚¨æ ¼å¼å¤æ‚</p><hr><h3 id="rdb" tabindex="-1"><a class="header-anchor" href="#rdb" aria-hidden="true">#</a> RDB</h3><h4 id="æ–‡ä»¶åˆ›å»º" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶åˆ›å»º" aria-hidden="true">#</a> æ–‡ä»¶åˆ›å»º</h4><p>RDB æŒä¹…åŒ–åŠŸèƒ½æ‰€ç”Ÿæˆçš„ RDB æ–‡ä»¶æ˜¯ä¸€ä¸ªç»è¿‡å‹ç¼©çš„ç´§å‡‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œé€šè¿‡è¯¥æ–‡ä»¶å¯ä»¥è¿˜åŸç”Ÿæˆ RDB æ–‡ä»¶æ—¶çš„æ•°æ®åº“çŠ¶æ€ï¼Œæœ‰ä¸¤ä¸ª Redis å‘½ä»¤å¯ä»¥ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯ SAVEï¼Œå¦ä¸€ä¸ªæ˜¯ BGSAVE</p><h5 id="save" tabindex="-1"><a class="header-anchor" href="#save" aria-hidden="true">#</a> SAVE</h5><p>SAVE æŒ‡ä»¤ï¼šæ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡ä¿å­˜æ“ä½œï¼Œè¯¥æŒ‡ä»¤çš„æ‰§è¡Œä¼šé˜»å¡å½“å‰ Redis æœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯å‘é€çš„æ‰€æœ‰å‘½ä»¤è¯·æ±‚éƒ½ä¼šè¢«æ‹’ç»ï¼Œç›´åˆ°å½“å‰ RDB è¿‡ç¨‹å®Œæˆä¸ºæ­¢ï¼Œæœ‰å¯èƒ½ä¼šé€ æˆé•¿æ—¶é—´é˜»å¡ï¼Œçº¿ä¸Šç¯å¢ƒä¸å»ºè®®ä½¿ç”¨</p><p>å·¥ä½œåŸç†ï¼šRedis æ˜¯ä¸ª<strong>å•çº¿ç¨‹çš„å·¥ä½œæ¨¡å¼</strong>ï¼Œä¼šåˆ›å»ºä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œæ‰€æœ‰çš„å‘½ä»¤éƒ½ä¼šè¿›åˆ°è¿™ä¸ªé˜Ÿåˆ—æ’é˜Ÿæ‰§è¡Œã€‚å½“æŸä¸ªæŒ‡ä»¤åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œé˜Ÿåˆ—åé¢çš„æŒ‡ä»¤éƒ½è¦ç­‰å¾…ï¼Œæ‰€ä»¥è¿™ç§æ‰§è¡Œæ–¹å¼ä¼šéå¸¸è€—æ—¶</p><p>é…ç½® redis.confï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">dir</span> path				<span class="token comment">#è®¾ç½®å­˜å‚¨.rdbæ–‡ä»¶çš„è·¯å¾„ï¼Œé€šå¸¸è®¾ç½®æˆå­˜å‚¨ç©ºé—´è¾ƒå¤§çš„ç›®å½•ä¸­ï¼Œç›®å½•åç§°data</span>
dbfilename <span class="token string">&quot;x.rdb&quot;</span>		<span class="token comment">#è®¾ç½®æœ¬åœ°æ•°æ®åº“æ–‡ä»¶åï¼Œé»˜è®¤å€¼ä¸ºdump.rdbï¼Œé€šå¸¸è®¾ç½®ä¸ºdump-ç«¯å£å·.rdb</span>
rdbcompression <span class="token function">yes</span><span class="token operator">|</span>no	<span class="token comment">#è®¾ç½®å­˜å‚¨è‡³æœ¬åœ°æ•°æ®åº“æ—¶æ˜¯å¦å‹ç¼©æ•°æ®ï¼Œé»˜è®¤yesï¼Œè®¾ç½®ä¸ºnoèŠ‚çœCPUè¿è¡Œæ—¶é—´</span>
rdbchecksum <span class="token function">yes</span><span class="token operator">|</span>no		<span class="token comment">#è®¾ç½®è¯»å†™æ–‡ä»¶è¿‡ç¨‹æ˜¯å¦è¿›è¡ŒRDBæ ¼å¼æ ¡éªŒï¼Œé»˜è®¤yes</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h5 id="bgsave" tabindex="-1"><a class="header-anchor" href="#bgsave" aria-hidden="true">#</a> BGSAVE</h5><p>BGSAVEï¼šbg æ˜¯ backgroundï¼Œä»£è¡¨åå°æ‰§è¡Œï¼Œå‘½ä»¤çš„å®Œæˆéœ€è¦ä¸¤ä¸ªè¿›ç¨‹ï¼Œ<strong>è¿›ç¨‹ä¹‹é—´ä¸ç›¸äº’å½±å“</strong>ï¼Œæ‰€ä»¥æŒä¹…åŒ–æœŸé—´ Redis æ­£å¸¸å·¥ä½œ</p><p>å·¥ä½œåŸç†ï¼š</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-bgsaveå·¥ä½œåŸç†.png" style="zoom:67%;"><p>æµç¨‹ï¼šå®¢æˆ·ç«¯å‘å‡º BGSAVE æŒ‡ä»¤ï¼ŒRedis æœåŠ¡å™¨ä½¿ç”¨ fork å‡½æ•°åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œç„¶åå“åº”åå°å·²ç»å¼€å§‹æ‰§è¡Œçš„ä¿¡æ¯ç»™å®¢æˆ·ç«¯ã€‚å­è¿›ç¨‹ä¼šå¼‚æ­¥æ‰§è¡ŒæŒä¹…åŒ–çš„æ“ä½œï¼ŒæŒä¹…åŒ–è¿‡ç¨‹æ˜¯å…ˆå°†æ•°æ®å†™å…¥åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ï¼ŒæŒä¹…åŒ–æ“ä½œç»“æŸå†ç”¨è¿™ä¸ªä¸´æ—¶æ–‡ä»¶<strong>æ›¿æ¢</strong>ä¸Šæ¬¡æŒä¹…åŒ–çš„æ–‡ä»¶</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># åˆ›å»ºå­è¿›ç¨‹</span>
pid <span class="token operator">=</span> fork<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
    <span class="token comment"># å­è¿›ç¨‹è´Ÿè´£åˆ›å»º RDB æ–‡ä»¶</span>
    rdbSave<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># å®Œæˆä¹‹åå‘çˆ¶è¿›ç¨‹å‘é€ä¿¡å·</span>
    signal_parent<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">elif</span> pid <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
    <span class="token comment"># çˆ¶è¿›ç¨‹ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ï¼Œå¹¶é€šè¿‡è½®è¯¢ç­‰å¾…å­è¿›ç¨‹çš„ä¿¡å·</span>
    handle_request_and_wait_signal<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token comment"># å¤„ç†å‡ºé”™æƒå†µ</span>
    handle_fork_error<span class="token punctuation">(</span><span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é…ç½® redis.conf</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>stop-writes-on-bgsave-error <span class="token function">yes</span><span class="token operator">|</span>no	<span class="token comment">#åå°å­˜å‚¨è¿‡ç¨‹ä¸­å¦‚æœå‡ºç°é”™è¯¯ï¼Œæ˜¯å¦åœæ­¢ä¿å­˜æ“ä½œï¼Œé»˜è®¤yes</span>
dbfilename filename  
<span class="token function">dir</span> path  
rdbcompression <span class="token function">yes</span><span class="token operator">|</span>no  
rdbchecksum <span class="token function">yes</span><span class="token operator">|</span>no
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„ï¼šBGSAVE å‘½ä»¤æ˜¯é’ˆå¯¹ SAVE é˜»å¡é—®é¢˜åšçš„ä¼˜åŒ–ï¼ŒRedis å†…éƒ¨æ‰€æœ‰æ¶‰åŠåˆ° RDB æ“ä½œéƒ½é‡‡ç”¨ BGSAVE çš„æ–¹å¼ï¼ŒSAVE å‘½ä»¤æ”¾å¼ƒä½¿ç”¨</p><p>åœ¨ BGSAVE å‘½ä»¤æ‰§è¡ŒæœŸé—´ï¼ŒæœåŠ¡å™¨å¤„ç† SAVEã€BGSAVEã€BGREWRITEAOF ä¸‰ä¸ªå‘½ä»¤çš„æ–¹å¼ä¼šå’Œå¹³æ—¶æœ‰æ‰€ä¸åŒ</p><ul><li>SAVE å‘½ä»¤ä¼šè¢«æœåŠ¡å™¨æ‹’ç»ï¼ŒæœåŠ¡å™¨ç¦æ­¢ SAVE å’Œ BGSAVE å‘½ä»¤åŒæ—¶æ‰§è¡Œæ˜¯ä¸ºäº†é¿å…çˆ¶è¿›ç¨‹ï¼ˆæœåŠ¡å™¨è¿›ç¨‹ï¼‰å’Œå­è¿›ç¨‹åŒæ—¶æ‰§è¡Œä¸¤ä¸ª rdbSave è°ƒç”¨ï¼Œäº§ç”Ÿç«äº‰æ¡ä»¶</li><li>BGSAVE å‘½ä»¤ä¹Ÿä¼šè¢«æœåŠ¡å™¨æ‹’ç»ï¼Œä¹Ÿä¼šäº§ç”Ÿç«äº‰æ¡ä»¶</li><li>BGREWRITEAOF å’Œ BGSAVE ä¸¤ä¸ªå‘½ä»¤ä¸èƒ½åŒæ—¶æ‰§è¡Œ <ul><li>å¦‚æœ BGSAVE å‘½ä»¤æ­£åœ¨æ‰§è¡Œï¼Œé‚£ä¹ˆ BGREWRITEAOF å‘½ä»¤ä¼šè¢«<strong>å»¶è¿Ÿ</strong>åˆ° BGSAVE å‘½ä»¤æ‰§è¡Œå®Œæ¯•ä¹‹åæ‰§è¡Œ</li><li>å¦‚æœ BGREWRITEAOF å‘½ä»¤æ­£åœ¨æ‰§è¡Œï¼Œé‚£ä¹ˆ BGSAVE å‘½ä»¤ä¼šè¢«æœåŠ¡å™¨æ‹’ç»</li></ul></li></ul><hr><h5 id="ç‰¹æ®ŠæŒ‡ä»¤" tabindex="-1"><a class="header-anchor" href="#ç‰¹æ®ŠæŒ‡ä»¤" aria-hidden="true">#</a> ç‰¹æ®ŠæŒ‡ä»¤</h5><p>RDB ç‰¹æ®Šå¯åŠ¨å½¢å¼çš„æŒ‡ä»¤ï¼ˆå®¢æˆ·ç«¯è¾“å…¥ï¼‰</p><ul><li><p>æœåŠ¡å™¨è¿è¡Œè¿‡ç¨‹ä¸­é‡å¯</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>debug reload
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>å…³é—­æœåŠ¡å™¨æ—¶æŒ‡å®šä¿å­˜æ•°æ®</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">shutdown</span> save
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>é»˜è®¤æƒ…å†µä¸‹æ‰§è¡Œ shutdown å‘½ä»¤æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œ bgsaveï¼ˆå¦‚æœæ²¡æœ‰å¼€å¯ AOF æŒä¹…åŒ–åŠŸèƒ½ï¼‰</p></li><li><p>å…¨é‡å¤åˆ¶ï¼šä¸»ä»å¤åˆ¶éƒ¨åˆ†è¯¦è§£</p></li></ul><hr><h4 id="æ–‡ä»¶è½½å…¥" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶è½½å…¥" aria-hidden="true">#</a> æ–‡ä»¶è½½å…¥</h4><p>RDB æ–‡ä»¶çš„è½½å…¥å·¥ä½œæ˜¯åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œï¼ŒæœŸé—´ Redis ä¼šä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œç›´åˆ°è½½å…¥å®Œæˆ</p><p>Redis å¹¶æ²¡æœ‰ä¸“é—¨ç”¨äºè½½å…¥ RDB æ–‡ä»¶çš„å‘½ä»¤ï¼Œåªè¦æœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶æ£€æµ‹åˆ° RDB æ–‡ä»¶å­˜åœ¨ï¼Œå°±ä¼šè‡ªåŠ¨è½½å…¥ RDB æ–‡ä»¶</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span><span class="token number">7379</span><span class="token punctuation">]</span> <span class="token number">30</span> Aug <span class="token number">21</span>:07:01.289 * DB loaded from disk: <span class="token number">0.018</span> seconds  <span class="token comment"># æœåŠ¡å™¨åœ¨æˆåŠŸè½½å…¥ RDB æ–‡ä»¶ä¹‹åæ‰“å°</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>AOF æ–‡ä»¶çš„æ›´æ–°é¢‘ç‡é€šå¸¸æ¯” RDB æ–‡ä»¶çš„æ›´æ–°é¢‘ç‡é«˜ï¼š</p><ul><li>å¦‚æœæœåŠ¡å™¨å¼€å¯äº† AOF æŒä¹…åŒ–åŠŸèƒ½ï¼Œé‚£ä¹ˆä¼šä¼˜å…ˆä½¿ç”¨ AOF æ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€</li><li>åªæœ‰åœ¨ AOF æŒä¹…åŒ–åŠŸèƒ½å¤„äºå…³é—­çŠ¶æ€æ—¶ï¼ŒæœåŠ¡å™¨æ‰ä¼šä½¿ç”¨ RDB æ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çŠ¶æ€</li></ul><hr><h4 id="è‡ªåŠ¨ä¿å­˜" tabindex="-1"><a class="header-anchor" href="#è‡ªåŠ¨ä¿å­˜" aria-hidden="true">#</a> è‡ªåŠ¨ä¿å­˜</h4><h5 id="é…ç½®æ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#é…ç½®æ–‡ä»¶" aria-hidden="true">#</a> é…ç½®æ–‡ä»¶</h5><p>Redis æ”¯æŒé€šè¿‡é…ç½®æœåŠ¡å™¨çš„ save é€‰é¡¹ï¼Œè®©æœåŠ¡å™¨æ¯éš”ä¸€æ®µæ—¶é—´è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡ BGSAVE å‘½ä»¤</p><p>é…ç½® redis.confï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>save second changes <span class="token comment">#è®¾ç½®è‡ªåŠ¨æŒä¹…åŒ–æ¡ä»¶ï¼Œæ»¡è¶³é™å®šæ—¶é—´èŒƒå›´å†…keyçš„å˜åŒ–æ•°é‡å°±è¿›è¡ŒæŒä¹…åŒ–(bgsave)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>secondï¼šç›‘æ§æ—¶é—´èŒƒå›´</li><li>changesï¼šç›‘æ§ key çš„å˜åŒ–é‡</li></ul><p>é»˜è®¤ä¸‰ä¸ªæ¡ä»¶ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>save <span class="token number">900</span> <span class="token number">1</span>		<span class="token comment"># 900så†…1ä¸ªkeyå‘ç”Ÿå˜åŒ–å°±è¿›è¡ŒæŒä¹…åŒ–</span>
save <span class="token number">300</span> <span class="token number">10</span>
save <span class="token number">60</span> <span class="token number">10000</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ¤å®š key å˜åŒ–çš„ä¾æ®ï¼š</p><ul><li>å¯¹æ•°æ®äº§ç”Ÿäº†å½±å“ï¼Œä¸åŒ…æ‹¬æŸ¥è¯¢</li><li>ä¸è¿›è¡Œæ•°æ®æ¯”å¯¹ï¼Œæ¯”å¦‚ name é”®å­˜åœ¨ï¼Œé‡æ–° set name seazean ä¹Ÿç®—ä¸€æ¬¡å˜åŒ–</li></ul><p>save é…ç½®è¦æ ¹æ®å®é™…ä¸šåŠ¡æƒ…å†µè¿›è¡Œè®¾ç½®ï¼Œé¢‘åº¦è¿‡é«˜æˆ–è¿‡ä½éƒ½ä¼šå‡ºç°æ€§èƒ½é—®é¢˜ï¼Œç»“æœå¯èƒ½æ˜¯ç¾éš¾æ€§çš„</p><hr><h5 id="è‡ªåŠ¨åŸç†" tabindex="-1"><a class="header-anchor" href="#è‡ªåŠ¨åŸç†" aria-hidden="true">#</a> è‡ªåŠ¨åŸç†</h5><p>æœåŠ¡å™¨çŠ¶æ€ç›¸å…³çš„å±æ€§ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    <span class="token comment">// è®°å½•äº†ä¿å­˜æ¡ä»¶çš„æ•°ç»„</span>
    <span class="token keyword">struct</span> <span class="token class-name">saveparam</span> <span class="token operator">*</span>saveparams<span class="token punctuation">;</span>
    
    <span class="token comment">// ä¿®æ”¹è®¡æ•°å™¨</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> dirty<span class="token punctuation">;</span>
    
    <span class="token comment">// ä¸Šä¸€æ¬¡æ‰§è¡Œä¿å­˜çš„æ—¶é—´ </span>
    <span class="token class-name">time_t</span> lastsave<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>Redis æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œå¯ä»¥é€šè¿‡æŒ‡å®šé…ç½®æ–‡ä»¶æˆ–è€…ä¼ å…¥å¯åŠ¨å‚æ•°çš„æ–¹å¼è®¾ç½® save é€‰é¡¹ï¼Œ å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰å°±è®¾ç½®ä¸ºä¸‰ä¸ªé»˜è®¤å€¼ï¼ˆä¸ŠèŠ‚æåŠï¼‰ï¼Œè®¾ç½®æœåŠ¡å™¨çŠ¶æ€ redisServe.saveparams å±æ€§ï¼Œè¯¥æ•°ç»„æ¯ä¸€é¡¹ä¸ºä¸€ä¸ª saveparam ç»“æ„ï¼Œä»£è¡¨ save çš„é€‰é¡¹è®¾ç½®</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">saveparam</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç§’æ•°</span>
    <span class="token class-name">time_t</span> seconds
    <span class="token comment">// ä¿®æ”¹æ•°</span>
    <span class="token keyword">int</span> changes<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>dirty è®¡æ•°å™¨è®°å½•è·ç¦»ä¸Šä¸€æ¬¡æˆåŠŸæ‰§è¡Œ SAVE æˆ–è€… BGSAVE å‘½ä»¤ä¹‹åï¼ŒæœåŠ¡å™¨ä¸­çš„æ‰€æœ‰æ•°æ®åº“è¿›è¡Œäº†å¤šå°‘æ¬¡ä¿®æ”¹ï¼ˆåŒ…æ‹¬å†™å…¥ã€åˆ é™¤ã€æ›´æ–°ç­‰æ“ä½œï¼‰ï¼Œå½“æœåŠ¡å™¨æˆåŠŸæ‰§è¡Œä¸€ä¸ªä¿®æ”¹æŒ‡ä»¤ï¼Œè¯¥å‘½ä»¤ä¿®æ”¹äº†å¤šå°‘æ¬¡æ•°æ®åº“ï¼Œ dirty çš„å€¼å°±å¢åŠ å¤šå°‘</p></li><li><p>lastsave å±æ€§æ˜¯ä¸€ä¸ª UNIX æ—¶é—´æˆ³ï¼Œè®°å½•äº†æœåŠ¡å™¨ä¸Šä¸€æ¬¡æˆåŠŸæ‰§è¡Œ SAVE æˆ–è€… BGSAVE å‘½ä»¤çš„æ—¶é—´</p></li></ul><p>Redis çš„æœåŠ¡å™¨å‘¨æœŸæ€§æ“ä½œå‡½æ•° serverCron é»˜è®¤æ¯éš” 100 æ¯«ç§’å°±ä¼šæ‰§è¡Œä¸€æ¬¡ï¼Œè¯¥å‡½æ•°ç”¨äºå¯¹æ­£åœ¨è¿è¡Œçš„æœåŠ¡å™¨è¿›è¡Œç»´æŠ¤</p><p>serverCron å‡½æ•°çš„å…¶ä¸­ä¸€é¡¹å·¥ä½œæ˜¯æ£€æŸ¥ save é€‰é¡¹æ‰€è®¾ç½®çš„ä¿å­˜æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œä¼šéå† saveparams æ•°ç»„ä¸­çš„<strong>æ‰€æœ‰ä¿å­˜æ¡ä»¶</strong>ï¼Œåªè¦æœ‰ä»»æ„ä¸€ä¸ªæ¡ä»¶è¢«æ»¡è¶³æœåŠ¡å™¨å°±ä¼šæ‰§è¡Œ BGSAVE å‘½ä»¤</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-BGSAVEæ‰§è¡ŒåŸç†.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h4 id="æ–‡ä»¶ç»“æ„" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶ç»“æ„" aria-hidden="true">#</a> æ–‡ä»¶ç»“æ„</h4><p>RDB çš„å­˜å‚¨ç»“æ„ï¼šå›¾ç¤ºå…¨å¤§å†™å•è¯æ ‡ç¤ºå¸¸é‡ï¼Œç”¨å…¨å°å†™å•è¯æ ‡ç¤ºå˜é‡å’Œæ•°æ®</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-RDBæ–‡ä»¶ç»“æ„.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>REDISï¼šé•¿åº¦ä¸º 5 å­—èŠ‚ï¼Œä¿å­˜ç€ <code>REDIS</code> äº”ä¸ªå­—ç¬¦ï¼Œæ˜¯ RDB æ–‡ä»¶çš„å¼€å¤´ï¼Œåœ¨è½½å…¥æ–‡ä»¶æ—¶å¯ä»¥å¿«é€Ÿæ£€æŸ¥æ‰€è½½å…¥çš„æ–‡ä»¶æ˜¯å¦ RDB æ–‡ä»¶</li><li>db_versionï¼šé•¿åº¦ä¸º 4 å­—èŠ‚ï¼Œæ˜¯ä¸€ä¸ªç”¨å­—ç¬¦ä¸²è¡¨ç¤ºçš„æ•´æ•°ï¼Œè®°å½• RDB çš„ç‰ˆæœ¬å·</li><li>databaseï¼šåŒ…å«ç€é›¶ä¸ªæˆ–ä»»æ„å¤šä¸ªæ•°æ®åº“ï¼Œä»¥åŠå„ä¸ªæ•°æ®åº“ä¸­çš„é”®å€¼å¯¹æ•°æ®</li><li>EOFï¼šé•¿åº¦ä¸º 1 å­—èŠ‚çš„å¸¸é‡ï¼Œæ ‡å¿—ç€ RDB æ–‡ä»¶æ­£æ–‡å†…å®¹çš„ç»“æŸï¼Œå½“è¯»å…¥é‡åˆ°è¿™ä¸ªå€¼æ—¶ï¼Œä»£è¡¨æ‰€æœ‰æ•°æ®åº“çš„é”®å€¼å¯¹éƒ½å·²ç»è½½å…¥å®Œæ¯•</li><li>check_sumï¼šé•¿åº¦ä¸º 8 å­—èŠ‚çš„æ— ç¬¦å·æ•´æ•°ï¼Œä¿å­˜ç€ä¸€ä¸ªæ ¡éªŒå’Œï¼Œè¯¥å€¼æ˜¯é€šè¿‡ REDISã€db_versionã€databasesã€EOF å››ä¸ªéƒ¨åˆ†çš„å†…å®¹è¿›è¡Œè®¡ç®—å¾—å‡ºã€‚æœåŠ¡å™¨åœ¨è½½å…¥ RDB æ–‡ä»¶æ—¶ï¼Œä¼šå°†è½½å…¥æ•°æ®æ‰€è®¡ç®—å‡ºçš„æ ¡éªŒå’Œä¸ check_sum æ‰€è®°å½•çš„æ ¡éªŒå’Œè¿›è¡Œå¯¹æ¯”ï¼Œæ¥æ£€æŸ¥ RDB æ–‡ä»¶æ˜¯å¦æœ‰å‡ºé”™æˆ–è€…æŸå</li></ul><p>Redis æœ¬èº«å¸¦æœ‰ RDB æ–‡ä»¶æ£€æŸ¥å·¥å…· redis-check-dump</p><hr><h3 id="aof" tabindex="-1"><a class="header-anchor" href="#aof" aria-hidden="true">#</a> AOF</h3><h4 id="åŸºæœ¬æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ¦‚è¿°" aria-hidden="true">#</a> åŸºæœ¬æ¦‚è¿°</h4><p>AOFï¼ˆappend only fileï¼‰æŒä¹…åŒ–ï¼šä»¥ç‹¬ç«‹æ—¥å¿—çš„æ–¹å¼è®°å½•æ¯æ¬¡å†™å‘½ä»¤ï¼ˆä¸è®°å½•è¯»ï¼‰æ¥è®°å½•æ•°æ®åº“çŠ¶æ€ï¼Œ<strong>å¢é‡ä¿å­˜</strong>åªè®¸è¿½åŠ æ–‡ä»¶ä½†ä¸å¯ä»¥æ”¹å†™æ–‡ä»¶ï¼Œ<strong>ä¸ RDB ç›¸æ¯”å¯ä»¥ç†è§£ä¸ºç”±è®°å½•æ•°æ®æ”¹ä¸ºè®°å½•æ•°æ®çš„å˜åŒ–</strong></p><p>AOF ä¸»è¦ä½œç”¨æ˜¯è§£å†³äº†<strong>æ•°æ®æŒä¹…åŒ–çš„å®æ—¶æ€§</strong>ï¼Œç›®å‰å·²ç»æ˜¯ Redis æŒä¹…åŒ–çš„ä¸»æµæ–¹å¼</p><p>AOF å†™æ•°æ®è¿‡ç¨‹ï¼š</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-AOFå·¥ä½œåŸç†.png" style="zoom:67%;"><p>Redis åªä¼šå°†å¯¹æ•°æ®åº“è¿›è¡Œäº†ä¿®æ”¹çš„å‘½ä»¤å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œå¹¶å¤åˆ¶åˆ°å„ä¸ªä»æœåŠ¡å™¨ï¼Œä½†æ˜¯ PUBSUB å’Œ SCRIPT LOAD å‘½ä»¤ä¾‹å¤–ï¼š</p><ul><li>PUBSUB å‘½ä»¤è™½ç„¶æ²¡æœ‰ä¿®æ”¹æ•°æ®åº“ï¼Œä½† PUBSUB å‘½ä»¤å‘é¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…å‘é€æ¶ˆæ¯è¿™ä¸€è¡Œä¸ºå¸¦æœ‰å‰¯ä½œç”¨ï¼Œæ¥æ”¶åˆ°æ¶ˆæ¯çš„æ‰€æœ‰å®¢æˆ·ç«¯çš„çŠ¶æ€éƒ½ä¼šå› ä¸ºè¿™ä¸ªå‘½ä»¤è€Œæ”¹å˜ï¼Œæ‰€ä»¥æœåŠ¡å™¨éœ€è¦ä½¿ç”¨ REDIS_FORCE_AOF æ ‡å¿—å¼ºåˆ¶å°†è¿™ä¸ªå‘½ä»¤å†™å…¥ AOF æ–‡ä»¶ã€‚è¿™æ ·åœ¨å°†æ¥è½½å…¥ AOF æ–‡ä»¶æ—¶ï¼ŒæœåŠ¡å™¨å°±å¯ä»¥å†æ¬¡æ‰§è¡Œç›¸åŒçš„ PUBSUB å‘½ä»¤ï¼Œå¹¶äº§ç”Ÿç›¸åŒçš„å‰¯ä½œç”¨</li><li>SCRIPT LOAD å‘½ä»¤è™½ç„¶æ²¡æœ‰ä¿®æ”¹æ•°æ®åº“ï¼Œä½†å®ƒä¿®æ”¹äº†æœåŠ¡å™¨çŠ¶æ€ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯ä¸€ä¸ªå¸¦æœ‰å‰¯ä½œç”¨çš„å‘½ä»¤ï¼Œéœ€è¦ä½¿ç”¨ REDIS_FORCE_AOF</li></ul><hr><h4 id="æŒä¹…å®ç°" tabindex="-1"><a class="header-anchor" href="#æŒä¹…å®ç°" aria-hidden="true">#</a> æŒä¹…å®ç°</h4><p>AOF æŒä¹…åŒ–åŠŸèƒ½çš„å®ç°å¯ä»¥åˆ†ä¸ºå‘½ä»¤è¿½åŠ ï¼ˆappendï¼‰ã€æ–‡ä»¶å†™å…¥ã€æ–‡ä»¶åŒæ­¥ï¼ˆsyncï¼‰ä¸‰ä¸ªæ­¥éª¤</p><h5 id="å‘½ä»¤è¿½åŠ " tabindex="-1"><a class="header-anchor" href="#å‘½ä»¤è¿½åŠ " aria-hidden="true">#</a> å‘½ä»¤è¿½åŠ </h5><p>å¯åŠ¨ AOF çš„åŸºæœ¬é…ç½®ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>appendonly <span class="token function">yes</span><span class="token operator">|</span>no				<span class="token comment">#å¼€å¯AOFæŒä¹…åŒ–åŠŸèƒ½ï¼Œé»˜è®¤noï¼Œå³ä¸å¼€å¯çŠ¶æ€</span>
appendfilename filename			<span class="token comment">#AOFæŒä¹…åŒ–æ–‡ä»¶åï¼Œé»˜è®¤appendonly.aofï¼Œå»ºè®®è®¾ç½®appendonly-ç«¯å£å·.aof</span>
<span class="token function">dir</span>								<span class="token comment">#AOFæŒä¹…åŒ–æ–‡ä»¶ä¿å­˜è·¯å¾„ï¼Œä¸RDBæŒä¹…åŒ–æ–‡ä»¶è·¯å¾„ä¿æŒä¸€è‡´å³å¯</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“ AOF æŒä¹…åŒ–åŠŸèƒ½å¤„äºæ‰“å¼€çŠ¶æ€æ—¶ï¼ŒæœåŠ¡å™¨åœ¨æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤ä¹‹åï¼Œä¼šä»¥åè®®æ ¼å¼å°†è¢«æ‰§è¡Œçš„å†™å‘½ä»¤<strong>è¿½åŠ </strong>åˆ°æœåŠ¡å™¨çŠ¶æ€çš„ aof_buf ç¼“å†²åŒºçš„æœ«å°¾</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    <span class="token comment">// AOF ç¼“å†²åŒº</span>
    sds aof_buf<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h5 id="æ–‡ä»¶å†™å…¥" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶å†™å…¥" aria-hidden="true">#</a> æ–‡ä»¶å†™å…¥</h5><p>æœåŠ¡å™¨åœ¨å¤„ç†æ–‡ä»¶äº‹ä»¶æ—¶ä¼šæ‰§è¡Œ<strong>å†™å‘½ä»¤ï¼Œè¿½åŠ ä¸€äº›å†…å®¹åˆ° aof_buf ç¼“å†²åŒº</strong>é‡Œï¼Œæ‰€ä»¥æœåŠ¡å™¨æ¯æ¬¡ç»“æŸä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¹‹å‰ï¼Œå°±ä¼šæ‰§è¡Œ flushAppendOnlyFile å‡½æ•°ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦<strong>å°† aof_buf ç¼“å†²åŒºä¸­çš„å†…å®¹å†™å…¥å’Œä¿å­˜åˆ° AOF æ–‡ä»¶</strong>é‡Œ</p><p>flushAppendOnlyFile å‡½æ•°çš„è¡Œä¸ºç”±æœåŠ¡å™¨é…ç½®çš„ appendfsync é€‰é¡¹çš„å€¼æ¥å†³å®š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>appendfsync always<span class="token operator">|</span>everysec<span class="token operator">|</span>no	<span class="token comment">#AOFå†™æ•°æ®ç­–ç•¥ï¼šé»˜è®¤ä¸ºeverysec</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><p>alwaysï¼šæ¯æ¬¡å†™å…¥æ“ä½œéƒ½å°† aof_buf ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹<strong>å†™å…¥å¹¶åŒæ­¥</strong>åˆ° AOF æ–‡ä»¶</p><p>ç‰¹ç‚¹ï¼šå®‰å…¨æ€§æœ€é«˜ï¼Œæ•°æ®é›¶è¯¯å·®ï¼Œä½†æ˜¯æ€§èƒ½è¾ƒä½ï¼Œä¸å»ºè®®ä½¿ç”¨</p></li><li><p>everysecï¼šå…ˆå°† aof_buf ç¼“å†²åŒºä¸­çš„å†…å®¹å†™å…¥åˆ°æ“ä½œç³»ç»Ÿç¼“å­˜ï¼Œåˆ¤æ–­ä¸Šæ¬¡åŒæ­¥ AOF æ–‡ä»¶çš„æ—¶é—´è·ç¦»ç°åœ¨è¶…è¿‡ä¸€ç§’é’Ÿï¼Œå†æ¬¡è¿›è¡ŒåŒæ­¥ fsyncï¼Œè¿™ä¸ªåŒæ­¥æ“ä½œæ˜¯ç”±ä¸€ä¸ªï¼ˆå­ï¼‰çº¿ç¨‹ä¸“é—¨è´Ÿè´£æ‰§è¡Œçš„</p><p>ç‰¹ç‚¹ï¼šåœ¨ç³»ç»Ÿçªç„¶å®•æœºçš„æƒ…å†µä¸‹ä¸¢å¤± 1 ç§’å†…çš„æ•°æ®ï¼Œå‡†ç¡®æ€§è¾ƒé«˜ï¼Œæ€§èƒ½è¾ƒé«˜ï¼Œå»ºè®®ä½¿ç”¨ï¼Œä¹Ÿæ˜¯é»˜è®¤é…ç½®</p></li><li><p>noï¼šå°† aof_buf ç¼“å†²åŒºä¸­çš„å†…å®¹å†™å…¥åˆ°æ“ä½œç³»ç»Ÿç¼“å­˜ï¼Œä½†å¹¶ä¸è¿›è¡ŒåŒæ­¥ï¼Œä½•æ—¶åŒæ­¥ç”±æ“ä½œç³»ç»Ÿæ¥å†³å®š</p><p>ç‰¹ç‚¹ï¼š<strong>æ•´ä½“ä¸å¯æ§</strong>ï¼ŒæœåŠ¡å™¨å®•æœºä¼šä¸¢å¤±ä¸Šæ¬¡åŒæ­¥ AOF åçš„æ‰€æœ‰å†™æŒ‡ä»¤</p></li></ul><hr><h5 id="æ–‡ä»¶åŒæ­¥" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶åŒæ­¥" aria-hidden="true">#</a> æ–‡ä»¶åŒæ­¥</h5><p>åœ¨ç°ä»£æ“ä½œç³»ç»Ÿä¸­ï¼Œå½“ç”¨æˆ·è°ƒç”¨ write å‡½æ•°å°†æ•°æ®å†™å…¥æ–‡ä»¶æ—¶ï¼Œæ“ä½œç³»ç»Ÿé€šå¸¸ä¼šå°†å†™å…¥æ•°æ®æš‚æ—¶ä¿å­˜åœ¨ä¸€ä¸ªå†…å­˜ç¼“å†²åŒºç©ºé—´ï¼Œç­‰åˆ°ç¼“å†²åŒº<strong>å†™æ»¡æˆ–è€…åˆ°è¾¾ç‰¹å®šæ—¶é—´å‘¨æœŸ</strong>ï¼Œæ‰çœŸæ­£åœ°å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°ç£ç›˜é‡Œé¢ï¼ˆåˆ·è„ï¼‰</p><ul><li>ä¼˜ç‚¹ï¼šæé«˜æ–‡ä»¶çš„å†™å…¥æ•ˆç‡</li><li>ç¼ºç‚¹ï¼šä¸ºå†™å…¥æ•°æ®å¸¦æ¥äº†å®‰å…¨é—®é¢˜ï¼Œå¦‚æœè®¡ç®—æœºå‘ç”Ÿåœæœºï¼Œé‚£ä¹ˆä¿å­˜åœ¨å†…å­˜ç¼“å†²åŒºé‡Œé¢çš„å†™å…¥æ•°æ®å°†ä¼šä¸¢å¤±</li></ul><p>ç³»ç»Ÿæä¾›äº† fsync å’Œ fdatasync ä¸¤ä¸ªåŒæ­¥å‡½æ•°åš<strong>å¼ºåˆ¶ç¡¬ç›˜åŒæ­¥</strong>ï¼Œå¯ä»¥è®©æ“ä½œç³»ç»Ÿç«‹å³å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥åˆ°ç¡¬ç›˜é‡Œé¢ï¼Œå‡½æ•°ä¼šé˜»å¡åˆ°å†™å…¥ç¡¬ç›˜å®Œæˆåè¿”å›ï¼Œä¿è¯äº†æ•°æ®æŒä¹…åŒ–</p><p>å¼‚å¸¸æ¢å¤ï¼šAOF æ–‡ä»¶æŸåï¼Œé€šè¿‡ redis-check-aof--fix appendonly.aof è¿›è¡Œæ¢å¤ï¼Œé‡å¯ Redisï¼Œç„¶åé‡æ–°åŠ è½½</p><hr><h4 id="æ–‡ä»¶è½½å…¥-1" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶è½½å…¥-1" aria-hidden="true">#</a> æ–‡ä»¶è½½å…¥</h4><p>AOF æ–‡ä»¶é‡ŒåŒ…å«äº†é‡å»ºæ•°æ®åº“çŠ¶æ€æ‰€éœ€çš„æ‰€æœ‰å†™å‘½ä»¤ï¼Œæ‰€ä»¥æœåŠ¡å™¨åªè¦è¯»å…¥å¹¶é‡æ–°æ‰§è¡Œä¸€é AOF æ–‡ä»¶é‡Œçš„å‘½ä»¤ï¼Œå°±è¿˜åŸæœåŠ¡å™¨å…³é—­ä¹‹å‰çš„æ•°æ®åº“çŠ¶æ€ï¼ŒæœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶ï¼Œè¿˜åŸæ•°æ®åº“çŠ¶æ€æ‰“å°çš„æ—¥å¿—ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span><span class="token number">8321</span><span class="token punctuation">]</span> 05 Sep <span class="token number">11</span>:58:50.449 * DB loaded from append only file: <span class="token number">0.000</span> seconds 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>AOF æ–‡ä»¶é‡Œé¢é™¤äº†ç”¨äºæŒ‡å®šæ•°æ®åº“çš„ SELECT å‘½ä»¤æ˜¯æœåŠ¡å™¨è‡ªåŠ¨æ·»åŠ çš„ï¼Œå…¶ä»–éƒ½æ˜¯é€šè¿‡å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>* <span class="token number">2</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$6</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nSELECT<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$1</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>n0<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n	<span class="token comment"># æœåŠ¡å™¨è‡ªåŠ¨æ·»åŠ </span>
* <span class="token number">3</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$3</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nSET<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$3</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nmsg<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$5</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nhello<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n
* <span class="token number">5</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$4</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nSADD<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$6</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nfruits<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$5</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>napple<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$6</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>nbanana<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n<span class="token variable">$6</span><span class="token punctuation">\</span>r<span class="token punctuation">\</span>ncherry<span class="token punctuation">\</span>r<span class="token punctuation">\</span>n
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Redis è¯»å– AOF æ–‡ä»¶å¹¶è¿˜åŸæ•°æ®åº“çŠ¶æ€çš„æ­¥éª¤ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ª<strong>ä¸å¸¦ç½‘ç»œè¿æ¥çš„ä¼ªå®¢æˆ·ç«¯</strong>ï¼ˆfake clientï¼‰æ‰§è¡Œå‘½ä»¤ï¼Œå› ä¸º Redis çš„å‘½ä»¤åªèƒ½åœ¨å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œ è€Œè½½å…¥ AOF æ–‡ä»¶æ—¶æ‰€ä½¿ç”¨çš„å‘½ä»¤æ¥æºäºæœ¬åœ° AOF æ–‡ä»¶è€Œä¸æ˜¯ç½‘ç»œè¿æ¥</li><li>ä» AOF æ–‡ä»¶åˆ†æå¹¶è¯»å–ä¸€æ¡å†™å‘½ä»¤</li><li>ä½¿ç”¨ä¼ªå®¢æˆ·ç«¯æ‰§è¡Œè¢«è¯»å‡ºçš„å†™å‘½ä»¤ï¼Œç„¶åé‡å¤ä¸Šè¿°æ­¥éª¤</li></ul><hr><h4 id="é‡å†™å®ç°" tabindex="-1"><a class="header-anchor" href="#é‡å†™å®ç°" aria-hidden="true">#</a> é‡å†™å®ç°</h4><h5 id="é‡å†™ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#é‡å†™ç­–ç•¥" aria-hidden="true">#</a> é‡å†™ç­–ç•¥</h5><p>AOF é‡å†™ï¼šè¯»å–æœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€ï¼Œ<strong>ç”Ÿæˆæ–° AOF æ–‡ä»¶æ¥æ›¿æ¢æ—§ AOF æ–‡ä»¶</strong>ï¼Œä¸ä¼šå¯¹ç°æœ‰çš„ AOF æ–‡ä»¶è¿›è¡Œä»»ä½•è¯»å–ã€åˆ†ææˆ–è€…å†™å…¥æ“ä½œï¼Œè€Œæ˜¯ç›´æ¥åŸå­æ›¿æ¢ã€‚æ–° AOF æ–‡ä»¶ä¸ä¼šåŒ…å«ä»»ä½•æµªè´¹ç©ºé—´çš„å†—ä½™å‘½ä»¤ï¼Œæ‰€ä»¥ä½“ç§¯é€šå¸¸ä¼šæ¯”æ—§ AOF æ–‡ä»¶å°å¾—å¤š</p><p>AOF é‡å†™è§„åˆ™ï¼š</p><ul><li><p>è¿›ç¨‹å†…å…·æœ‰æ—¶æ•ˆæ€§çš„æ•°æ®ï¼Œå¹¶ä¸”æ•°æ®å·²è¶…æ—¶å°†ä¸å†å†™å…¥æ–‡ä»¶</p></li><li><p>å¯¹åŒä¸€æ•°æ®çš„å¤šæ¡å†™å‘½ä»¤åˆå¹¶ä¸ºä¸€æ¡å‘½ä»¤ï¼Œå› ä¸ºä¼šè¯»å–å½“å‰çš„çŠ¶æ€ï¼Œæ‰€ä»¥ç›´æ¥å°†å½“å‰çŠ¶æ€è½¬æ¢ä¸ºä¸€æ¡å‘½ä»¤å³å¯ã€‚ä¸ºé˜²æ­¢æ•°æ®é‡è¿‡å¤§é€ æˆå®¢æˆ·ç«¯ç¼“å†²åŒºæº¢å‡ºï¼Œå¯¹ listã€setã€hashã€zset ç­‰é›†åˆç±»å‹ï¼Œ<strong>å•æ¡æŒ‡ä»¤</strong>æœ€å¤šå†™å…¥ 64 ä¸ªå…ƒç´ </p><p>å¦‚ lpushlist1 aã€lpush list1 bã€lpush list1 c å¯ä»¥è½¬åŒ–ä¸ºï¼šlpush list1 a b c</p></li><li><p>éå†™å…¥ç±»çš„æ— æ•ˆæŒ‡ä»¤å°†è¢«å¿½ç•¥ï¼Œåªä¿ç•™æœ€ç»ˆæ•°æ®çš„å†™å…¥å‘½ä»¤ï¼Œä½†æ˜¯ select æŒ‡ä»¤è™½ç„¶ä¸æ›´æ”¹æ•°æ®ï¼Œä½†æ˜¯æ›´æ”¹äº†æ•°æ®çš„å­˜å‚¨ä½ç½®ï¼Œæ­¤ç±»å‘½ä»¤åŒæ ·éœ€è¦è®°å½•</p></li></ul><p>AOF é‡å†™ä½œç”¨ï¼š</p><ul><li>é™ä½ç£ç›˜å ç”¨é‡ï¼Œæé«˜ç£ç›˜åˆ©ç”¨ç‡</li><li>æé«˜æŒä¹…åŒ–æ•ˆç‡ï¼Œé™ä½æŒä¹…åŒ–å†™æ—¶é—´ï¼Œæé«˜ IO æ€§èƒ½</li><li>é™ä½æ•°æ®æ¢å¤çš„ç”¨æ—¶ï¼Œæé«˜æ•°æ®æ¢å¤æ•ˆç‡</li></ul><hr><h5 id="é‡å†™åŸç†" tabindex="-1"><a class="header-anchor" href="#é‡å†™åŸç†" aria-hidden="true">#</a> é‡å†™åŸç†</h5><p>AOF é‡å†™ç¨‹åº aof_rewrite å‡½æ•°å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–° AOF æ–‡ä»¶ï¼Œ ä½†æ˜¯è¯¥å‡½æ•°ä¼šè¿›è¡Œå¤§é‡çš„å†™å…¥æ“ä½œï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°çš„çº¿ç¨‹å°†è¢«é•¿æ—¶é—´é˜»å¡ï¼Œæ‰€ä»¥ Redis å°† AOF é‡å†™ç¨‹åºæ”¾åˆ° fork çš„å­è¿›ç¨‹é‡Œæ‰§è¡Œï¼Œä¸ä¼šé˜»å¡çˆ¶è¿›ç¨‹ï¼Œé‡å†™å‘½ä»¤ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>bgrewriteaof
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><p>å­è¿›ç¨‹è¿›è¡Œ AOF é‡å†™æœŸé—´ï¼ŒæœåŠ¡å™¨è¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰å¯ä»¥ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚</p></li><li><p>å­è¿›ç¨‹å¸¦æœ‰æœåŠ¡å™¨è¿›ç¨‹çš„æ•°æ®å‰¯æœ¬ï¼Œä½¿ç”¨å­è¿›ç¨‹è€Œä¸æ˜¯çº¿ç¨‹ï¼Œå¯ä»¥åœ¨é¿å…ä½¿ç”¨é”çš„æƒ…å†µä¸‹ï¼Œ ä¿è¯æ•°æ®å®‰å…¨æ€§</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-AOFæ‰‹åŠ¨é‡å†™åŸç†.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></li></ul><p>å­è¿›ç¨‹åœ¨è¿›è¡Œ AOF é‡å†™æœŸé—´ï¼ŒæœåŠ¡å™¨è¿›ç¨‹è¿˜éœ€è¦ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ï¼Œè€Œæ–°å‘½ä»¤å¯èƒ½ä¼šå¯¹ç°æœ‰çš„æ•°æ®åº“çŠ¶æ€è¿›è¡Œä¿®æ”¹ï¼Œä»è€Œä½¿å¾—æœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€å’Œé‡å†™åçš„ AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸ä¸€è‡´ï¼Œæ‰€ä»¥ Redis è®¾ç½®äº† AOF é‡å†™ç¼“å†²åŒº</p><p>å·¥ä½œæµç¨‹ï¼š</p><ul><li>Redis æœåŠ¡å™¨æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤ï¼Œä¼šåŒæ—¶å°†è¯¥å‘½ä»¤è¿½åŠ åˆ° AOF ç¼“å†²åŒºå’Œ AOF é‡å†™ç¼“å†²åŒºï¼ˆä»åˆ›å»ºå­è¿›ç¨‹åæ‰å¼€å§‹å†™å…¥ï¼‰</li><li>å½“å­è¿›ç¨‹å®Œæˆ AOF é‡å†™å·¥ä½œä¹‹åï¼Œä¼šå‘çˆ¶è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·ï¼Œçˆ¶è¿›ç¨‹åœ¨æ¥åˆ°è¯¥ä¿¡å·ä¹‹åï¼Œ ä¼šè°ƒç”¨ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°æ‰§è¡Œæ—¶ä¼š<strong>å¯¹æœåŠ¡å™¨è¿›ç¨‹ï¼ˆçˆ¶è¿›ç¨‹ï¼‰é€ æˆé˜»å¡</strong>ï¼ˆå½±å“å¾ˆå°ï¼Œç±»ä¼¼ JVM STWï¼‰ï¼Œä¸»è¦å·¥ä½œï¼š <ul><li>å°† AOF é‡å†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹å†™å…¥åˆ°æ–° AOF æ–‡ä»¶ä¸­ï¼Œ è¿™æ—¶æ–° AOF æ–‡ä»¶æ‰€ä¿å­˜çš„çŠ¶æ€å°†å’ŒæœåŠ¡å™¨å½“å‰çš„æ•°æ®åº“çŠ¶æ€ä¸€è‡´</li><li>å¯¹æ–°çš„ AOF æ–‡ä»¶è¿›è¡Œæ”¹åï¼Œ<strong>åŸå­åœ°ï¼ˆatomicï¼‰è¦†ç›–</strong>ç°æœ‰çš„ AOF æ–‡ä»¶ï¼Œå®Œæˆæ–°æ—§ä¸¤ä¸ª AOF æ–‡ä»¶çš„æ›¿æ¢</li></ul></li></ul><hr><h5 id="è‡ªåŠ¨é‡å†™" tabindex="-1"><a class="header-anchor" href="#è‡ªåŠ¨é‡å†™" aria-hidden="true">#</a> è‡ªåŠ¨é‡å†™</h5><p>è§¦å‘æ—¶æœºï¼šRedis ä¼šè®°å½•ä¸Šæ¬¡é‡å†™æ—¶çš„ AOF å¤§å°ï¼Œé»˜è®¤é…ç½®æ˜¯å½“ AOF æ–‡ä»¶å¤§å°æ˜¯ä¸Šæ¬¡é‡å†™åå¤§å°çš„ä¸€å€ä¸”æ–‡ä»¶å¤§äº 64M æ—¶è§¦å‘</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>auto-aof-rewrite-min-size size		<span class="token comment">#è®¾ç½®é‡å†™çš„åŸºå‡†å€¼ï¼Œæœ€å°æ–‡ä»¶ 64MBï¼Œè¾¾åˆ°è¿™ä¸ªå€¼å¼€å§‹é‡å†™</span>
auto-aof-rewrite-percentage percent	<span class="token comment">#è§¦å‘AOFæ–‡ä»¶æ‰§è¡Œé‡å†™çš„å¢é•¿ç‡ï¼Œå½“å‰AOFæ–‡ä»¶å¤§å°è¶…è¿‡ä¸Šä¸€æ¬¡é‡å†™çš„AOFæ–‡ä»¶å¤§å°çš„ç™¾åˆ†ä¹‹å¤šå°‘æ‰ä¼šé‡å†™ï¼Œæ¯”å¦‚æ–‡ä»¶è¾¾åˆ° 100% æ—¶å¼€å§‹é‡å†™å°±æ˜¯ä¸¤å€æ—¶è§¦å‘</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è‡ªåŠ¨é‡å†™è§¦å‘æ¯”å¯¹å‚æ•°ï¼ˆ è¿è¡ŒæŒ‡ä»¤ <code>info Persistence</code> è·å–å…·ä½“ä¿¡æ¯ ï¼‰ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>aof_current_size					<span class="token comment">#AOFæ–‡ä»¶å½“å‰å°ºå¯¸å¤§å°ï¼ˆå•ä½:å­—èŠ‚ï¼‰</span>
aof_base_size						<span class="token comment">#AOFæ–‡ä»¶ä¸Šæ¬¡å¯åŠ¨å’Œé‡å†™æ—¶çš„å°ºå¯¸å¤§å°ï¼ˆå•ä½:å­—èŠ‚ï¼‰</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è‡ªåŠ¨é‡å†™è§¦å‘æ¡ä»¶å…¬å¼ï¼š</p><ul><li>aof_current_size &gt; auto-aof-rewrite-min-size</li><li>(aof_current_size - aof_base_size) / aof_base_size &gt;= auto-aof-rewrite-percentage</li></ul><hr><h3 id="å¯¹æ¯”-1" tabindex="-1"><a class="header-anchor" href="#å¯¹æ¯”-1" aria-hidden="true">#</a> å¯¹æ¯”</h3><p>RDB çš„ç‰¹ç‚¹</p><ul><li><p>RDB ä¼˜ç‚¹ï¼š</p><ul><li>RDB æ˜¯ä¸€ä¸ªç´§å‡‘å‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå­˜å‚¨æ•ˆç‡è¾ƒé«˜ï¼Œä½†å­˜å‚¨æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œå­˜å‚¨æ•ˆç‡è¾ƒä½</li><li>RDB å†…éƒ¨å­˜å‚¨çš„æ˜¯ Redis åœ¨æŸä¸ªæ—¶é—´ç‚¹çš„æ•°æ®å¿«ç…§ï¼Œéå¸¸<strong>é€‚åˆç”¨äºæ•°æ®å¤‡ä»½ï¼Œå…¨é‡å¤åˆ¶ã€ç¾éš¾æ¢å¤</strong></li><li>RDB æ¢å¤æ•°æ®çš„é€Ÿåº¦è¦æ¯” AOF å¿«å¾ˆå¤šï¼Œå› ä¸ºæ˜¯å¿«ç…§ï¼Œç›´æ¥æ¢å¤</li></ul></li><li><p>RDB ç¼ºç‚¹ï¼š</p><ul><li>BGSAVE æŒ‡ä»¤æ¯æ¬¡è¿è¡Œè¦æ‰§è¡Œ fork æ“ä½œåˆ›å»ºå­è¿›ç¨‹ï¼Œä¼šç‰ºç‰²ä¸€äº›æ€§èƒ½</li><li>RDB æ–¹å¼æ— è®ºæ˜¯æ‰§è¡ŒæŒ‡ä»¤è¿˜æ˜¯åˆ©ç”¨é…ç½®ï¼Œæ— æ³•åšåˆ°å®æ—¶æŒä¹…åŒ–ï¼Œå…·æœ‰ä¸¢å¤±æ•°æ®çš„å¯èƒ½æ€§ï¼Œæœ€åä¸€æ¬¡æŒä¹…åŒ–åçš„æ•°æ®å¯èƒ½ä¸¢å¤±</li><li>Redis çš„ä¼—å¤šç‰ˆæœ¬ä¸­æœªè¿›è¡Œ RDB æ–‡ä»¶æ ¼å¼çš„ç‰ˆæœ¬ç»Ÿä¸€ï¼Œå¯èƒ½å‡ºç°å„ç‰ˆæœ¬ä¹‹é—´æ•°æ®æ ¼å¼æ— æ³•å…¼å®¹</li></ul></li></ul><p>AOF ç‰¹ç‚¹ï¼š</p><ul><li>AOF çš„ä¼˜ç‚¹ï¼šæ•°æ®æŒä¹…åŒ–æœ‰<strong>è¾ƒå¥½çš„å®æ—¶æ€§</strong>ï¼Œé€šè¿‡ AOF é‡å†™å¯ä»¥é™ä½æ–‡ä»¶çš„ä½“ç§¯</li><li>AOF çš„ç¼ºç‚¹ï¼šæ–‡ä»¶è¾ƒå¤§æ—¶æ¢å¤è¾ƒæ…¢</li></ul><p>AOF å’Œ RDB åŒæ—¶å¼€å¯ï¼Œç³»ç»Ÿé»˜è®¤å– AOF çš„æ•°æ®ï¼ˆæ•°æ®ä¸ä¼šå­˜åœ¨ä¸¢å¤±ï¼‰</p><p>åº”ç”¨åœºæ™¯ï¼š</p><ul><li><p>å¯¹æ•°æ®<strong>éå¸¸æ•æ„Ÿ</strong>ï¼Œå»ºè®®ä½¿ç”¨é»˜è®¤çš„ AOF æŒä¹…åŒ–æ–¹æ¡ˆï¼ŒAOF æŒä¹…åŒ–ç­–ç•¥ä½¿ç”¨ everysecondï¼Œæ¯ç§’é’Ÿ fsync ä¸€æ¬¡ï¼Œè¯¥ç­–ç•¥ Redis ä»å¯ä»¥ä¿æŒå¾ˆå¥½çš„å¤„ç†æ€§èƒ½</p><p>æ³¨æ„ï¼šAOF æ–‡ä»¶å­˜å‚¨ä½“ç§¯è¾ƒå¤§ï¼Œæ¢å¤é€Ÿåº¦è¾ƒæ…¢ï¼Œå› ä¸ºè¦æ‰§è¡Œæ¯æ¡æŒ‡ä»¤</p></li><li><p>æ•°æ®å‘ˆç°<strong>é˜¶æ®µæœ‰æ•ˆæ€§</strong>ï¼Œå»ºè®®ä½¿ç”¨ RDB æŒä¹…åŒ–æ–¹æ¡ˆï¼Œå¯ä»¥åšåˆ°é˜¶æ®µå†…æ— ä¸¢å¤±ï¼Œä¸”æ¢å¤é€Ÿåº¦è¾ƒå¿«</p><p>æ³¨æ„ï¼šåˆ©ç”¨ RDB å®ç°ç´§å‡‘çš„æ•°æ®æŒä¹…åŒ–ï¼Œå­˜å‚¨æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œå­˜å‚¨æ•ˆç‡è¾ƒä½</p></li></ul><p>ç»¼åˆå¯¹æ¯”ï¼š</p><ul><li>RDB ä¸ AOF çš„é€‰æ‹©å®é™…ä¸Šæ˜¯åœ¨åšä¸€ç§æƒè¡¡ï¼Œæ¯ç§éƒ½æœ‰åˆ©æœ‰å¼Š</li><li>ç¾éš¾æ¢å¤é€‰ç”¨ RDB</li><li>å¦‚ä¸èƒ½æ‰¿å—æ•°åˆ†é’Ÿä»¥å†…çš„æ•°æ®ä¸¢å¤±ï¼Œå¯¹ä¸šåŠ¡æ•°æ®éå¸¸æ•æ„Ÿï¼Œé€‰ç”¨ AOFï¼›å¦‚èƒ½æ‰¿å—æ•°åˆ†é’Ÿä»¥å†…çš„æ•°æ®ä¸¢å¤±ï¼Œä¸”è¿½æ±‚å¤§æ•°æ®é›†çš„æ¢å¤é€Ÿåº¦ï¼Œé€‰ç”¨ RDB</li><li>åŒä¿é™©ç­–ç•¥ï¼ŒåŒæ—¶å¼€å¯ RDB å’Œ AOFï¼Œé‡å¯å Redis ä¼˜å…ˆä½¿ç”¨ AOF æ¥æ¢å¤æ•°æ®ï¼Œé™ä½ä¸¢å¤±æ•°æ®çš„é‡</li><li>ä¸å»ºè®®å•ç‹¬ç”¨ AOFï¼Œå› ä¸ºå¯èƒ½ä¼šå‡ºç° Bugï¼Œå¦‚æœåªæ˜¯åšçº¯å†…å­˜ç¼“å­˜ï¼Œå¯ä»¥éƒ½ä¸ç”¨</li></ul><hr><h3 id="fork" tabindex="-1"><a class="header-anchor" href="#fork" aria-hidden="true">#</a> fork</h3><h4 id="ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#ä»‹ç»" aria-hidden="true">#</a> ä»‹ç»</h4><p>fork() å‡½æ•°åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹å‡ ä¹æ˜¯å®Œå…¨ç›¸åŒçš„è¿›ç¨‹ï¼Œç³»ç»Ÿå…ˆç»™å­è¿›ç¨‹åˆ†é…èµ„æºï¼Œç„¶åæŠŠçˆ¶è¿›ç¨‹çš„æ‰€æœ‰æ•°æ®éƒ½å¤åˆ¶åˆ°å­è¿›ç¨‹ä¸­ï¼Œåªæœ‰å°‘æ•°å€¼ä¸çˆ¶è¿›ç¨‹çš„å€¼ä¸åŒï¼Œç›¸å½“äºå…‹éš†äº†ä¸€ä¸ªè¿›ç¨‹</p><p>åœ¨å®Œæˆå¯¹å…¶è°ƒç”¨ä¹‹åï¼Œä¼šäº§ç”Ÿ 2 ä¸ªè¿›ç¨‹ï¼Œä¸”æ¯ä¸ªè¿›ç¨‹éƒ½ä¼š<strong>ä» fork() çš„è¿”å›å¤„å¼€å§‹æ‰§è¡Œ</strong>ï¼Œè¿™ä¸¤ä¸ªè¿›ç¨‹å°†æ‰§è¡Œç›¸åŒçš„ç¨‹åºæ®µï¼Œä½†æ˜¯æ‹¥æœ‰å„è‡ªä¸åŒçš„å †æ®µï¼Œæ ˆæ®µï¼Œæ•°æ®æ®µï¼Œæ¯ä¸ªå­è¿›ç¨‹éƒ½å¯ä¿®æ”¹å„è‡ªçš„æ•°æ®æ®µï¼Œå †æ®µï¼Œå’Œæ ˆæ®µ</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token class-name">pid_t</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// çˆ¶è¿›ç¨‹è¿”å›å­è¿›ç¨‹çš„pidï¼Œå­è¿›ç¨‹è¿”å›0ï¼Œé”™è¯¯è¿”å›è´Ÿå€¼ï¼Œæ ¹æ®è¿”å›å€¼çš„ä¸åŒè¿›è¡Œå¯¹åº”çš„é€»è¾‘å¤„ç†</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>fork è°ƒç”¨ä¸€æ¬¡ï¼Œå´èƒ½å¤Ÿ<strong>è¿”å›ä¸¤æ¬¡</strong>ï¼Œå¯èƒ½æœ‰ä¸‰ç§ä¸åŒçš„è¿”å›å€¼ï¼š</p><ul><li>åœ¨çˆ¶è¿›ç¨‹ä¸­ï¼Œfork è¿”å›æ–°åˆ›å»ºå­è¿›ç¨‹çš„è¿›ç¨‹ ID</li><li>åœ¨å­è¿›ç¨‹ä¸­ï¼Œfork è¿”å› 0</li><li>å¦‚æœå‡ºç°é”™è¯¯ï¼Œfork è¿”å›ä¸€ä¸ªè´Ÿå€¼ï¼Œé”™è¯¯åŸå› ï¼š <ul><li>å½“å‰çš„è¿›ç¨‹æ•°å·²ç»è¾¾åˆ°äº†ç³»ç»Ÿè§„å®šçš„ä¸Šé™ï¼Œè¿™æ—¶ errno çš„å€¼è¢«è®¾ç½®ä¸º EAGAIN</li><li>ç³»ç»Ÿå†…å­˜ä¸è¶³ï¼Œè¿™æ—¶ errno çš„å€¼è¢«è®¾ç½®ä¸º ENOMEM</li></ul></li></ul><p>fpid çš„å€¼åœ¨çˆ¶å­è¿›ç¨‹ä¸­ä¸åŒï¼šè¿›ç¨‹å½¢æˆäº†é“¾è¡¨ï¼Œçˆ¶è¿›ç¨‹çš„ fpid æŒ‡å‘å­è¿›ç¨‹çš„è¿›ç¨‹ idï¼Œå› ä¸ºå­è¿›ç¨‹æ²¡æœ‰å­è¿›ç¨‹ï¼Œæ‰€ä»¥å…¶ fpid ä¸º0</p><p>åˆ›å»ºæ–°è¿›ç¨‹æˆåŠŸåï¼Œç³»ç»Ÿä¸­å‡ºç°ä¸¤ä¸ªåŸºæœ¬å®Œå…¨ç›¸åŒçš„è¿›ç¨‹ï¼Œè¿™ä¸¤ä¸ªè¿›ç¨‹æ‰§è¡Œæ²¡æœ‰å›ºå®šçš„å…ˆåé¡ºåºï¼Œå“ªä¸ªè¿›ç¨‹å…ˆæ‰§è¡Œè¦çœ‹ç³»ç»Ÿçš„è°ƒåº¦ç­–ç•¥</p><p>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªç‹¬ç‰¹ï¼ˆäº’ä¸ç›¸åŒï¼‰çš„è¿›ç¨‹æ ‡è¯†ç¬¦ process IDï¼Œå¯ä»¥é€šè¿‡ getpid() å‡½æ•°è·å¾—ï¼›è¿˜æœ‰ä¸€ä¸ªè®°å½•çˆ¶è¿›ç¨‹ pid çš„å˜é‡ï¼Œå¯ä»¥é€šè¿‡ getppid() å‡½æ•°è·å¾—å˜é‡çš„å€¼</p><hr><h4 id="ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨" aria-hidden="true">#</a> ä½¿ç”¨</h4><p>åŸºæœ¬ä½¿ç”¨ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span>   </span>
<span class="token keyword">int</span> <span class="token function">main</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>   
<span class="token punctuation">{</span>   
    <span class="token class-name">pid_t</span> fpid<span class="token punctuation">;</span> <span class="token comment">// fpidè¡¨ç¤ºforkå‡½æ•°è¿”å›çš„å€¼  </span>
    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    fpid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fpid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>   
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;error in fork!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fpid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;i am the child process, my process id is %d/n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
        count<span class="token operator">++</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">else</span> <span class="token punctuation">{</span>  
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;i am the parent process, my process id is %d/n&quot;</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
        count<span class="token operator">++</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;count: %d/n&quot;</span><span class="token punctuation">,</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 1  </span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
<span class="token comment">/* è¾“å‡ºå†…å®¹ï¼š
    i am the child process, my process id is 5574
    count: 1
    i am the parent process, my process id is 5573
    count: 1
*/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿›é˜¶ä½¿ç”¨ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span>  </span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>  
<span class="token punctuation">{</span>  
   <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
   <span class="token comment">// ppid æŒ‡å½“å‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹pid  </span>
   <span class="token comment">// pid æŒ‡å½“å‰è¿›ç¨‹çš„pid,  </span>
   <span class="token comment">// fpid æŒ‡forkè¿”å›ç»™å½“å‰è¿›ç¨‹çš„å€¼ï¼Œåœ¨è¿™å¯ä»¥è¡¨ç¤ºå­è¿›ç¨‹</span>
   <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>  
       <span class="token class-name">pid_t</span> fpid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
       <span class="token keyword">if</span><span class="token punctuation">(</span>fpid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>  
           <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d child  %4d %4d %4d/n&quot;</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fpid<span class="token punctuation">)</span><span class="token punctuation">;</span>  
       <span class="token keyword">else</span>  
           <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%d parent %4d %4d %4d/n&quot;</span><span class="token punctuation">,</span>i<span class="token punctuation">,</span> <span class="token function">getppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>fpid<span class="token punctuation">)</span><span class="token punctuation">;</span>  
   <span class="token punctuation">}</span>  
   <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span> 
<span class="token comment">/*è¾“å‡ºå†…å®¹ï¼š
	i        çˆ¶id  id  å­id
	0 parent 2043 3224 3225
    0 child  3224 3225    0
    1 parent 2043 3224 3226
    1 parent 3224 3225 3227
    1 child     1 3227    0
    1 child     1 3226    0 
*/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-forkå‡½æ•°ä½¿ç”¨æ¼”ç¤º.png" style="zoom:80%;"><p>åœ¨ p3224 å’Œ p3225 æ‰§è¡Œå®Œç¬¬äºŒä¸ªå¾ªç¯åï¼Œmain å‡½æ•°é€€å‡ºï¼Œè¿›ç¨‹æ­»äº¡ã€‚æ‰€ä»¥ p3226ï¼Œp3227 å°±æ²¡æœ‰çˆ¶è¿›ç¨‹äº†ï¼Œæˆä¸ºå­¤å„¿è¿›ç¨‹ï¼Œæ‰€ä»¥ p3226 å’Œ p3227 çš„çˆ¶è¿›ç¨‹å°±è¢«ç½®ä¸º ID ä¸º 1 çš„ init è¿›ç¨‹ï¼ˆç¬”è®° Tool â†’ Linux â†’ è¿›ç¨‹ç®¡ç†è¯¦è§£ï¼‰</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/love_gaohz/article/details/41727415" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/love_gaohz/article/details/41727415<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><hr><h4 id="å†…å­˜-1" tabindex="-1"><a class="header-anchor" href="#å†…å­˜-1" aria-hidden="true">#</a> å†…å­˜</h4><p>fork() è°ƒç”¨ä¹‹åçˆ¶å­è¿›ç¨‹çš„å†…å­˜å…³ç³»</p><p>æ—©æœŸ Linux çš„ fork() å®ç°æ—¶ï¼Œå°±æ˜¯å…¨éƒ¨å¤åˆ¶ï¼Œè¿™ç§æ–¹æ³•æ•ˆç‡å¤ªä½ï¼Œè€Œä¸”é€ æˆäº†å¾ˆå¤§çš„å†…å­˜æµªè´¹ï¼Œç°åœ¨ Linux å®ç°é‡‡ç”¨äº†ä¸¤ç§æ–¹æ³•ï¼š</p><ul><li><p>çˆ¶å­è¿›ç¨‹çš„ä»£ç æ®µæ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥ä»£ç æ®µæ˜¯æ²¡å¿…è¦å¤åˆ¶çš„ï¼Œåªéœ€å†…æ ¸å°†ä»£ç æ®µæ ‡è®°ä¸ºåªè¯»ï¼Œçˆ¶å­è¿›ç¨‹å°±å…±äº«æ­¤ä»£ç æ®µã€‚fork() ä¹‹ååœ¨è¿›ç¨‹åˆ›å»ºä»£ç æ®µæ—¶ï¼Œå­è¿›ç¨‹çš„è¿›ç¨‹çº§é¡µè¡¨é¡¹éƒ½æŒ‡å‘å’Œçˆ¶è¿›ç¨‹ç›¸åŒçš„ç‰©ç†é¡µå¸§</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-forkä»¥åå†…å­˜å…³ç³»1.png" style="zoom:67%;"></li><li><p>å¯¹äºçˆ¶è¿›ç¨‹çš„æ•°æ®æ®µï¼Œå †æ®µï¼Œæ ˆæ®µä¸­çš„å„é¡µï¼Œç”±äºçˆ¶å­è¿›ç¨‹ç›¸äº’ç‹¬ç«‹ï¼Œé‡‡ç”¨<strong>å†™æ—¶å¤åˆ¶ COW</strong> çš„æŠ€æœ¯ï¼Œæ¥æé«˜å†…å­˜ä»¥åŠå†…æ ¸çš„åˆ©ç”¨ç‡</p><p>åœ¨ fork ä¹‹åä¸¤ä¸ªè¿›ç¨‹ç”¨çš„æ˜¯ç›¸åŒçš„ç‰©ç†ç©ºé—´ï¼ˆå†…å­˜åŒºï¼‰ï¼Œå­è¿›ç¨‹çš„ä»£ç æ®µã€æ•°æ®æ®µã€å †æ ˆéƒ½æ˜¯æŒ‡å‘çˆ¶è¿›ç¨‹çš„ç‰©ç†ç©ºé—´ï¼Œ<strong>ä¸¤è€…çš„è™šæ‹Ÿç©ºé—´ä¸åŒï¼Œä½†å…¶å¯¹åº”çš„ç‰©ç†ç©ºé—´æ˜¯åŒä¸€ä¸ª</strong>ï¼Œå½“çˆ¶å­è¿›ç¨‹ä¸­æœ‰æ›´æ”¹ç›¸åº”æ®µçš„è¡Œä¸ºå‘ç”Ÿæ—¶ï¼Œå†ä¸ºå­è¿›ç¨‹ç›¸åº”çš„æ®µåˆ†é…ç‰©ç†ç©ºé—´ã€‚å¦‚æœä¸¤è€…çš„ä»£ç å®Œå…¨ç›¸åŒï¼Œä»£ç æ®µç»§ç»­å…±äº«çˆ¶è¿›ç¨‹çš„ç‰©ç†ç©ºé—´ï¼›è€Œå¦‚æœä¸¤è€…æ‰§è¡Œçš„ä»£ç ä¸åŒï¼Œå­è¿›ç¨‹çš„ä»£ç æ®µä¹Ÿä¼šåˆ†é…å•ç‹¬çš„ç‰©ç†ç©ºé—´ã€‚</p><p>fork ä¹‹åå†…æ ¸ä¼šå°†å­è¿›ç¨‹æ”¾åœ¨é˜Ÿåˆ—çš„å‰é¢ï¼Œè®©å­è¿›ç¨‹å…ˆæ‰§è¡Œï¼Œä»¥å…çˆ¶è¿›ç¨‹æ‰§è¡Œå¯¼è‡´å†™æ—¶å¤åˆ¶ï¼Œè€Œåå­è¿›ç¨‹å†æ‰§è¡Œï¼Œå› æ— æ„ä¹‰çš„å¤åˆ¶è€Œé€ æˆæ•ˆç‡çš„ä¸‹é™</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-forkä»¥åå†…å­˜å…³ç³»2.png" style="zoom:67%;"></li></ul><p>è¡¥å……çŸ¥è¯†ï¼š</p><p>vforkï¼ˆè™šæ‹Ÿå†…å­˜ fork virtual memory forkï¼‰ï¼šè°ƒç”¨ vfork() çˆ¶è¿›ç¨‹è¢«æŒ‚èµ·ï¼Œå­è¿›ç¨‹ä½¿ç”¨çˆ¶è¿›ç¨‹çš„åœ°å€ç©ºé—´ã€‚ä¸é‡‡ç”¨å†™æ—¶å¤åˆ¶ï¼Œå¦‚æœå­è¿›ç¨‹ä¿®æ”¹çˆ¶åœ°å€ç©ºé—´çš„ä»»ä½•é¡µé¢ï¼Œè¿™äº›ä¿®æ”¹è¿‡çš„é¡µé¢å¯¹äºæ¢å¤çš„çˆ¶è¿›ç¨‹æ˜¯å¯è§çš„</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/Shreck66/article/details/47039937" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/Shreck66/article/details/47039937<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><hr><h2 id="äº‹åŠ¡æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#äº‹åŠ¡æœºåˆ¶" aria-hidden="true">#</a> äº‹åŠ¡æœºåˆ¶</h2><h3 id="äº‹åŠ¡ç‰¹å¾" tabindex="-1"><a class="header-anchor" href="#äº‹åŠ¡ç‰¹å¾" aria-hidden="true">#</a> äº‹åŠ¡ç‰¹å¾</h3><p>Redis äº‹åŠ¡å°±æ˜¯å°†å¤šä¸ªå‘½ä»¤è¯·æ±‚æ‰“åŒ…ï¼Œç„¶å<strong>ä¸€æ¬¡æ€§ã€æŒ‰é¡ºåº</strong>åœ°æ‰§è¡Œå¤šä¸ªå‘½ä»¤çš„æœºåˆ¶ï¼Œå¹¶ä¸”åœ¨äº‹åŠ¡æ‰§è¡ŒæœŸé—´ï¼ŒæœåŠ¡å™¨ä¸ä¼šä¸­æ–­äº‹åŠ¡å»æ‰§è¡Œå…¶ä»–çš„å‘½ä»¤è¯·æ±‚ï¼Œä¼šå°†äº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œç„¶åæ‰å»å¤„ç†å…¶ä»–å®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚ï¼ŒRedis äº‹åŠ¡çš„ç‰¹æ€§ï¼š</p><ul><li>Redis äº‹åŠ¡<strong>æ²¡æœ‰éš”ç¦»çº§åˆ«</strong>çš„æ¦‚å¿µï¼Œé˜Ÿåˆ—ä¸­çš„å‘½ä»¤åœ¨äº‹åŠ¡æ²¡æœ‰æäº¤ä¹‹å‰éƒ½ä¸ä¼šå®é™…è¢«æ‰§è¡Œ</li><li>Redis å•æ¡å‘½ä»¤å¼ä¿å­˜åŸå­æ€§çš„ï¼Œä½†æ˜¯äº‹åŠ¡<strong>ä¸ä¿è¯åŸå­æ€§</strong>ï¼Œäº‹åŠ¡ä¸­å¦‚æœæœ‰ä¸€æ¡å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå…¶åçš„å‘½ä»¤ä»ç„¶ä¼šè¢«æ‰§è¡Œï¼Œæ²¡æœ‰å›æ»š</li></ul><hr><h3 id="å·¥ä½œæµç¨‹" tabindex="-1"><a class="header-anchor" href="#å·¥ä½œæµç¨‹" aria-hidden="true">#</a> å·¥ä½œæµç¨‹</h3><p>äº‹åŠ¡çš„æ‰§è¡Œæµç¨‹åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p><ul><li><p>äº‹åŠ¡å¼€å§‹ï¼šMULTI å‘½ä»¤çš„æ‰§è¡Œæ ‡å¿—ç€äº‹åŠ¡çš„å¼€å§‹ï¼Œé€šè¿‡åœ¨å®¢æˆ·ç«¯çŠ¶æ€çš„ flags å±æ€§ä¸­æ‰“å¼€ REDIS_MULTI æ ‡è¯†ï¼Œå°†æ‰§è¡Œè¯¥å‘½ä»¤çš„å®¢æˆ·ç«¯ä»éäº‹åŠ¡çŠ¶æ€åˆ‡æ¢è‡³äº‹åŠ¡çŠ¶æ€</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>MULTI	<span class="token comment"># è®¾å®šäº‹åŠ¡çš„å¼€å¯ä½ç½®ï¼Œæ­¤æŒ‡ä»¤æ‰§è¡Œåï¼Œåç»­çš„æ‰€æœ‰æŒ‡ä»¤å‡åŠ å…¥åˆ°äº‹åŠ¡ä¸­</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>å‘½ä»¤å…¥é˜Ÿï¼šäº‹åŠ¡é˜Ÿåˆ—ä»¥å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„æ–¹å¼ä¿å­˜å…¥é˜Ÿçš„å‘½ä»¤ï¼Œæ¯ä¸ª Redis å®¢æˆ·ç«¯éƒ½æœ‰äº‹åŠ¡çŠ¶æ€ï¼ŒåŒ…å«ç€äº‹åŠ¡é˜Ÿåˆ—ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisClient</span> <span class="token punctuation">{</span>
	<span class="token comment">// äº‹åŠ¡çŠ¶æ€</span>
    multiState mstate<span class="token punctuation">;</span>	<span class="token comment">/* MULTI/EXEC state */</span> 
<span class="token punctuation">}</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">multiState</span> <span class="token punctuation">{</span>
    <span class="token comment">// äº‹åŠ¡é˜Ÿåˆ—ï¼ŒFIFOé¡ºåº</span>
    multiCmd <span class="token operator">*</span>commands<span class="token punctuation">;</span> 
    
   	<span class="token comment">// å·²å…¥é˜Ÿå‘½ä»¤è®¡æ•°</span>
    <span class="token keyword">int</span> countï¼›
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å¦‚æœå‘½ä»¤ä¸º EXECã€DISCARDã€WATCHã€MULTI å››ä¸ªå‘½ä¸­çš„ä¸€ä¸ªï¼Œé‚£ä¹ˆæœåŠ¡å™¨ç«‹å³æ‰§è¡Œè¿™ä¸ªå‘½ä»¤</li><li>å…¶ä»–å‘½ä»¤æœåŠ¡å™¨ä¸æ‰§è¡Œï¼Œè€Œæ˜¯å°†å‘½ä»¤æ”¾å…¥ä¸€ä¸ªäº‹åŠ¡é˜Ÿåˆ—é‡Œé¢ï¼Œç„¶åå‘å®¢æˆ·ç«¯è¿”å› QUEUED å›å¤</li></ul></li><li><p>äº‹åŠ¡æ‰§è¡Œï¼šEXEC æäº¤äº‹åŠ¡ç»™æœåŠ¡å™¨æ‰§è¡Œï¼ŒæœåŠ¡å™¨ä¼šéå†è¿™ä¸ªå®¢æˆ·ç«¯çš„äº‹åŠ¡é˜Ÿåˆ—ï¼Œæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„å‘½ä»¤å¹¶å°†æ‰§è¡Œç»“æœè¿”å›</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>EXEC	<span class="token comment"># Commit æäº¤ï¼Œæ‰§è¡Œäº‹åŠ¡ï¼Œä¸multiæˆå¯¹å‡ºç°ï¼Œæˆå¯¹ä½¿ç”¨</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><p>äº‹åŠ¡å–æ¶ˆçš„æ–¹æ³•ï¼š</p><ul><li><p>å–æ¶ˆäº‹åŠ¡ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>DISCARD	<span class="token comment"># ç»ˆæ­¢å½“å‰äº‹åŠ¡çš„å®šä¹‰ï¼Œå‘ç”Ÿåœ¨multiä¹‹åï¼Œexecä¹‹å‰</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä¸€èˆ¬ç”¨äºäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­è¾“å…¥äº†é”™è¯¯çš„æŒ‡ä»¤ï¼Œç›´æ¥å–æ¶ˆè¿™æ¬¡äº‹åŠ¡ï¼Œç±»ä¼¼äºå›æ»š</p></li></ul><hr><h3 id="watch" tabindex="-1"><a class="header-anchor" href="#watch" aria-hidden="true">#</a> WATCH</h3><h4 id="ç›‘è§†æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#ç›‘è§†æœºåˆ¶" aria-hidden="true">#</a> ç›‘è§†æœºåˆ¶</h4><p>WATCH å‘½ä»¤æ˜¯ä¸€ä¸ªä¹è§‚é”ï¼ˆoptimistic lockingï¼‰ï¼Œå¯ä»¥åœ¨ EXEC å‘½ä»¤æ‰§è¡Œä¹‹å‰ï¼Œç›‘è§†ä»»æ„æ•°é‡çš„æ•°æ®åº“é”®ï¼Œå¹¶åœ¨ EXEC å‘½ä»¤æ‰§è¡Œæ—¶ï¼Œæ£€æŸ¥è¢«ç›‘è§†çš„é”®æ˜¯å¦è‡³å°‘æœ‰ä¸€ä¸ªå·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œå¦‚æœæ˜¯æœåŠ¡å™¨å°†æ‹’ç»æ‰§è¡Œäº‹åŠ¡ï¼Œå¹¶å‘å®¢æˆ·ç«¯è¿”å›ä»£è¡¨äº‹åŠ¡æ‰§è¡Œå¤±è´¥çš„ç©ºå›å¤</p><ul><li><p>æ·»åŠ ç›‘æ§é”</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>WATCH key1 <span class="token punctuation">[</span>key2â€¦â€¦<span class="token punctuation">]</span>	<span class="token comment">#å¯ä»¥ç›‘æ§ä¸€ä¸ªæˆ–è€…å¤šä¸ªkey</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>å–æ¶ˆå¯¹æ‰€æœ‰ key çš„ç›‘è§†</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>UNWATCH
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><hr><h4 id="å®ç°åŸç†" tabindex="-1"><a class="header-anchor" href="#å®ç°åŸç†" aria-hidden="true">#</a> å®ç°åŸç†</h4><p>æ¯ä¸ª Redis æ•°æ®åº“éƒ½ä¿å­˜ç€ä¸€ä¸ª watched_keys å­—å…¸ï¼Œé”®æ˜¯æŸä¸ªè¢« WATCH ç›‘è§†çš„æ•°æ®åº“é”®ï¼Œå€¼åˆ™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œè®°å½•äº†æ‰€æœ‰ç›‘è§†ç›¸åº”æ•°æ®åº“é”®çš„å®¢æˆ·ç«¯ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisDb</span> <span class="token punctuation">{</span>
	<span class="token comment">// æ­£åœ¨è¢« WATCH å‘½ä»¤ç›‘è§†çš„é”®</span>
    dict <span class="token operator">*</span>watched_keys<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰€æœ‰å¯¹æ•°æ®åº“è¿›è¡Œä¿®æ”¹çš„å‘½ä»¤ï¼Œåœ¨æ‰§è¡Œåéƒ½ä¼šè°ƒç”¨ <code>multi.c/touchWatchKey</code> å‡½æ•°å¯¹ watched_keys å­—å…¸è¿›è¡Œæ£€æŸ¥ï¼Œæ˜¯å¦æœ‰å®¢æˆ·ç«¯æ­£åœ¨ç›‘è§†åˆšè¢«å‘½ä»¤ä¿®æ”¹è¿‡çš„æ•°æ®åº“é”®ï¼Œå¦‚æœæœ‰çš„è¯å‡½æ•°ä¼šå°†ç›‘è§†è¢«ä¿®æ”¹é”®çš„å®¢æˆ·ç«¯çš„ REDIS_DIRTY_CAS æ ‡è¯†æ‰“å¼€ï¼Œè¡¨ç¤ºè¯¥å®¢æˆ·ç«¯çš„äº‹åŠ¡å®‰å…¨æ€§å·²ç»è¢«ç ´å</p><p>æœåŠ¡å™¨æ¥æ”¶åˆ°ä¸ªå®¢æˆ·ç«¯ EXEC å‘½ä»¤æ—¶ï¼Œä¼šæ ¹æ®è¿™ä¸ªå®¢æˆ·ç«¯æ˜¯å¦æ‰“å¼€äº† REDIS_DIRTY_CAS æ ‡è¯†ï¼Œå¦‚æœæ‰“å¼€äº†è¯´æ˜å®¢æˆ·ç«¯æäº¤äº‹åŠ¡ä¸å®‰å…¨ï¼ŒæœåŠ¡å™¨ä¼šæ‹’ç»æ‰§è¡Œ</p><hr><h3 id="acid" tabindex="-1"><a class="header-anchor" href="#acid" aria-hidden="true">#</a> ACID</h3><h4 id="åŸå­æ€§" tabindex="-1"><a class="header-anchor" href="#åŸå­æ€§" aria-hidden="true">#</a> åŸå­æ€§</h4><p>äº‹åŠ¡å…·æœ‰åŸå­æ€§ï¼ˆAtomicityï¼‰ã€ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€éš”ç¦»æ€§ï¼ˆIsolationï¼‰ã€æŒä¹…æ€§ï¼ˆDurabilityï¼‰</p><p>åŸå­æ€§æŒ‡äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„å‘½ä»¤è¦ä¹ˆå°±å…¨éƒ¨éƒ½æ‰§è¡Œï¼Œè¦ä¹ˆä¸€ä¸ªéƒ½ä¸æ‰§è¡Œï¼Œä½†æ˜¯åœ¨å‘½ä»¤æ‰§è¡Œå‡ºé”™æ—¶ï¼Œä¸ä¼šä¿è¯åŸå­æ€§ï¼ˆä¸‹ä¸€èŠ‚è¯¦è§£ï¼‰</p><p>Redis ä¸æ”¯æŒäº‹åŠ¡å›æ»šæœºåˆ¶ï¼ˆrollbackï¼‰ï¼Œå³ä½¿äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„æŸä¸ªå‘½ä»¤åœ¨æ‰§è¡ŒæœŸé—´å‡ºç°äº†é”™è¯¯ï¼Œæ•´ä¸ªäº‹åŠ¡ä¹Ÿä¼šç»§ç»­æ‰§è¡Œä¸‹å»ï¼Œç›´åˆ°å°†äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½æ‰§è¡Œå®Œæ¯•ä¸ºæ­¢</p><p>å›æ»šéœ€è¦ç¨‹åºå‘˜åœ¨ä»£ç ä¸­å®ç°ï¼Œåº”è¯¥å°½å¯èƒ½é¿å…ï¼š</p><ul><li><p>äº‹åŠ¡æ“ä½œä¹‹å‰è®°å½•æ•°æ®çš„çŠ¶æ€</p><ul><li><p>å•æ•°æ®ï¼šstring</p></li><li><p>å¤šæ•°æ®ï¼šhashã€listã€setã€zset</p></li></ul></li><li><p>è®¾ç½®æŒ‡ä»¤æ¢å¤æ‰€æœ‰çš„è¢«ä¿®æ”¹çš„é¡¹</p><ul><li><p>å•æ•°æ®ï¼šç›´æ¥ setï¼ˆæ³¨æ„å‘¨è¾¹å±æ€§ï¼Œä¾‹å¦‚æ—¶æ•ˆï¼‰</p></li><li><p>å¤šæ•°æ®ï¼šä¿®æ”¹å¯¹åº”å€¼æˆ–æ•´ä½“å…‹éš†å¤åˆ¶</p></li></ul></li></ul><hr><h4 id="ä¸€è‡´æ€§" tabindex="-1"><a class="header-anchor" href="#ä¸€è‡´æ€§" aria-hidden="true">#</a> ä¸€è‡´æ€§</h4><p>äº‹åŠ¡å…·æœ‰ä¸€è‡´æ€§æŒ‡çš„æ˜¯ï¼Œæ•°æ®åº“åœ¨æ‰§è¡Œäº‹åŠ¡ä¹‹å‰æ˜¯ä¸€è‡´çš„ï¼Œé‚£ä¹ˆåœ¨äº‹åŠ¡æ‰§è¡Œä¹‹åï¼Œæ— è®ºäº‹åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œæ•°æ®åº“ä¹Ÿåº”è¯¥ä»ç„¶æ˜¯ä¸€è‡´çš„</p><p>ä¸€è‡´æ˜¯æ•°æ®ç¬¦åˆæ•°æ®åº“çš„å®šä¹‰å’Œè¦æ±‚ï¼Œæ²¡æœ‰åŒ…å«éæ³•æˆ–è€…æ— æ•ˆçš„é”™è¯¯æ•°æ®ï¼ŒRedis é€šè¿‡é”™è¯¯æ£€æµ‹å’Œç®€å•çš„è®¾è®¡æ¥ä¿è¯äº‹åŠ¡çš„ä¸€è‡´æ€§ï¼š</p><ul><li><p>å…¥é˜Ÿé”™è¯¯ï¼šå‘½ä»¤æ ¼å¼è¾“å…¥é”™è¯¯ï¼Œå‡ºç°è¯­æ³•é”™è¯¯é€ æˆï¼Œ<strong>æ•´ä½“äº‹åŠ¡ä¸­æ‰€æœ‰å‘½ä»¤å‡ä¸ä¼šæ‰§è¡Œ</strong>ï¼ŒåŒ…æ‹¬é‚£äº›è¯­æ³•æ­£ç¡®çš„å‘½ä»¤</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å‘½ä»¤çš„è¯­æ³•é”™è¯¯.png" style="zoom:80%;"></li><li><p>æ‰§è¡Œé”™è¯¯ï¼šå‘½ä»¤æ‰§è¡Œå‡ºç°é”™è¯¯ï¼Œä¾‹å¦‚å¯¹å­—ç¬¦ä¸²è¿›è¡Œ incr æ“ä½œï¼Œäº‹åŠ¡ä¸­æ­£ç¡®çš„å‘½ä»¤ä¼šè¢«æ‰§è¡Œï¼Œè¿è¡Œé”™è¯¯çš„å‘½ä»¤ä¸ä¼šè¢«æ‰§è¡Œ</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-äº‹åŠ¡ä¸­æ‰§è¡Œé”™è¯¯.png" style="zoom:80%;"></li><li><p>æœåŠ¡å™¨åœæœºï¼š</p><ul><li>å¦‚æœæœåŠ¡å™¨è¿è¡Œåœ¨æ— æŒä¹…åŒ–çš„å†…å­˜æ¨¡å¼ä¸‹ï¼Œé‚£ä¹ˆé‡å¯ä¹‹åçš„æ•°æ®åº“å°†æ˜¯ç©ºç™½çš„ï¼Œå› æ­¤æ•°æ®åº“æ˜¯ä¸€è‡´çš„</li><li>å¦‚æœæœåŠ¡å™¨è¿è¡Œåœ¨æŒä¹…åŒ–æ¨¡å¼ä¸‹ï¼Œé‡å¯ä¹‹åå°†æ•°æ®åº“è¿˜åŸåˆ°ä¸€è‡´çš„çŠ¶æ€</li></ul></li></ul><hr><h4 id="éš”ç¦»æ€§" tabindex="-1"><a class="header-anchor" href="#éš”ç¦»æ€§" aria-hidden="true">#</a> éš”ç¦»æ€§</h4><p>Redis æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„æ‰§è¡ŒåŸç†ï¼Œæ‰€ä»¥å¯¹äºéš”ç¦»æ€§ï¼Œåˆ†ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š</p><ul><li>å¹¶å‘æ“ä½œåœ¨ EXEC å‘½ä»¤å‰æ‰§è¡Œï¼Œéš”ç¦»æ€§çš„ä¿è¯è¦ä½¿ç”¨ WATCH æœºåˆ¶æ¥å®ç°ï¼Œå¦åˆ™éš”ç¦»æ€§æ— æ³•ä¿è¯</li><li>å¹¶å‘æ“ä½œåœ¨ EXEC å‘½ä»¤åæ‰§è¡Œï¼Œéš”ç¦»æ€§å¯ä»¥ä¿è¯</li></ul><hr><h4 id="æŒä¹…æ€§" tabindex="-1"><a class="header-anchor" href="#æŒä¹…æ€§" aria-hidden="true">#</a> æŒä¹…æ€§</h4><p>Redis å¹¶æ²¡æœ‰ä¸ºäº‹åŠ¡æä¾›ä»»ä½•é¢å¤–çš„æŒä¹…åŒ–åŠŸèƒ½ï¼Œäº‹åŠ¡çš„æŒä¹…æ€§ç”± Redis æ‰€ä½¿ç”¨çš„æŒä¹…åŒ–æ¨¡å¼å†³å®š</p><p>é…ç½®é€‰é¡¹ <code>no-appendfsync-on-rewrite</code> å¯ä»¥é…åˆ appendfsync é€‰é¡¹åœ¨ AOF æŒä¹…åŒ–æ¨¡å¼ä½¿ç”¨ï¼š</p><ul><li>é€‰é¡¹æ‰“å¼€æ—¶åœ¨æ‰§è¡Œ BGSAVE æˆ–è€… BGREWRITEAOF æœŸé—´ï¼ŒæœåŠ¡å™¨ä¼šæš‚æ—¶åœæ­¢å¯¹ AOF æ–‡ä»¶è¿›è¡ŒåŒæ­¥ï¼Œä»è€Œå°½å¯èƒ½åœ°å‡å°‘ I/O é˜»å¡</li><li>é€‰é¡¹æ‰“å¼€æ—¶è¿è¡Œåœ¨ always æ¨¡å¼çš„ AOF æŒä¹…åŒ–ï¼Œäº‹åŠ¡ä¹Ÿä¸å…·æœ‰æŒä¹…æ€§ï¼Œæ‰€ä»¥è¯¥é€‰é¡¹é»˜è®¤å…³é—­</li></ul><p>åœ¨ä¸€ä¸ªäº‹åŠ¡çš„æœ€ååŠ ä¸Š SAVE å‘½ä»¤æ€»å¯ä»¥ä¿è¯äº‹åŠ¡çš„è€ä¹…æ€§</p><hr><h2 id="lua-è„šæœ¬" tabindex="-1"><a class="header-anchor" href="#lua-è„šæœ¬" aria-hidden="true">#</a> Lua è„šæœ¬</h2><h3 id="ç¯å¢ƒåˆ›å»º" tabindex="-1"><a class="header-anchor" href="#ç¯å¢ƒåˆ›å»º" aria-hidden="true">#</a> ç¯å¢ƒåˆ›å»º</h3><h4 id="åŸºæœ¬ä»‹ç»-5" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ä»‹ç»-5" aria-hidden="true">#</a> åŸºæœ¬ä»‹ç»</h4><p>Redis å¯¹ Lua è„šæœ¬æ”¯æŒï¼Œé€šè¿‡åœ¨æœåŠ¡å™¨ä¸­åµŒå…¥ Lua ç¯å¢ƒï¼Œå®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨ Lua è„šæœ¬ç›´æ¥åœ¨æœåŠ¡å™¨ç«¯<strong>åŸå­åœ°æ‰§è¡Œ</strong>å¤šä¸ªå‘½ä»¤</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>EVAL <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>numkeys<span class="token operator">&gt;</span> <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>arg <span class="token punctuation">..</span>.<span class="token punctuation">]</span>
EVALSHA <span class="token operator">&lt;</span>sha<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token operator">&lt;</span>numkeys<span class="token operator">&gt;</span> <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span> <span class="token punctuation">[</span>arg <span class="token punctuation">..</span>.<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>EVAL å‘½ä»¤å¯ä»¥ç›´æ¥å¯¹è¾“å…¥çš„è„šæœ¬è®¡ç®—ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis<span class="token operator">&gt;</span> EVAL <span class="token string">&quot;return 1 + 1&quot;</span> <span class="token number">0</span>	<span class="token comment"># 0ä»£è¡¨éœ€è¦çš„å‚æ•°</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">2</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>EVALSHA å‘½ä»¤æ ¹æ®è„šæœ¬çš„ SHA1 æ ¡éªŒå’Œæ¥å¯¹è„šæœ¬è®¡ç®—ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis<span class="token operator">&gt;</span> EVALSHA <span class="token string">&quot;2f3lba2bb6d6a0f42ccl59d2e2dad55440778de3&quot;</span> <span class="token number">0</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">2</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>åº”ç”¨åœºæ™¯ï¼šRedis åªä¿è¯å•æ¡å‘½ä»¤çš„åŸå­æ€§ï¼Œæ‰€ä»¥ä¸ºäº†å®ç°åŸå­æ“ä½œï¼Œå°†å¤šæ¡çš„å¯¹ Redis çš„æ“ä½œæ•´åˆåˆ°ä¸€ä¸ªè„šæœ¬é‡Œï¼Œä½†æ˜¯é¿å…æŠŠä¸éœ€è¦åšå¹¶å‘æ§åˆ¶çš„æ“ä½œå†™å…¥è„šæœ¬ä¸­</p><p>Lua è¯­æ³•ç‰¹ç‚¹ï¼š</p><ul><li>å£°æ˜å˜é‡çš„æ—¶å€™æ— éœ€æŒ‡å®šæ•°æ®ç±»å‹ï¼Œè€Œæ˜¯ç”¨ local æ¥å£°æ˜å˜é‡ä¸ºå±€éƒ¨å˜é‡</li><li>æ•°ç»„ä¸‹æ ‡æ˜¯ä» 1 å¼€å§‹</li></ul><hr><h4 id="åˆ›å»ºè¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºè¿‡ç¨‹" aria-hidden="true">#</a> åˆ›å»ºè¿‡ç¨‹</h4><p>Redis æœåŠ¡å™¨åˆ›å»ºå¹¶ä¿®æ”¹ Lua ç¯å¢ƒçš„æ•´ä¸ªè¿‡ç¨‹ï¼š</p><ul><li><p>åˆ›å»ºä¸€ä¸ªåŸºç¡€çš„ Lua ç¯å¢ƒï¼Œè°ƒç”¨ Lua çš„ API å‡½æ•° lua_open</p></li><li><p>è½½å…¥å¤šä¸ªå‡½æ•°åº“åˆ° Lua ç¯å¢ƒé‡Œé¢ï¼Œè®© Lua è„šæœ¬å¯ä»¥ä½¿ç”¨è¿™äº›å‡½æ•°åº“æ¥è¿›è¡Œæ•°æ®æ“ä½œï¼ŒåŒ…æ‹¬åŸºç¡€æ ¸å¿ƒå‡½æ•°</p></li><li><p>åˆ›å»ºå…¨å±€å˜é‡ redis è¡¨æ ¼ï¼Œè¡¨æ ¼åŒ…å«ä»¥ä¸‹å‡½æ•°ï¼š</p><ul><li>æ‰§è¡Œ Redis å‘½ä»¤çš„ redis.call å’Œ redis.pcall å‡½æ•°</li><li>è®°å½• Redis æ—¥å¿—çš„ redis.log å‡½æ•°ï¼Œä»¥åŠç›¸åº”çš„æ—¥å¿—çº§åˆ« (level) å¸¸é‡ redis.LOG_DEBUG ç­‰</li><li>è®¡ç®— SHAl æ ¡éªŒå’Œçš„ redis.shalhex å‡½æ•°</li><li>è¿”å›é”™è¯¯ä¿¡æ¯çš„ redis.error_reply å‡½æ•°å’Œ redis.status_reply å‡½æ•°</li></ul></li><li><p>ä½¿ç”¨ Redis è‡ªåˆ¶çš„éšæœºå‡½æ•°æ¥æ›¿æ¢ Lua åŸæœ‰çš„å¸¦æœ‰å‰¯ä½œç”¨çš„éšæœºå‡½æ•°ï¼Œä»è€Œé¿å…åœ¨è„šæœ¬ä¸­å¼•å…¥å‰¯ä½œç”¨</p><p>Redis è¦æ±‚æ‰€æœ‰ä¼ å…¥æœåŠ¡å™¨çš„ Lua è„šæœ¬ï¼Œä»¥åŠ Lua ç¯å¢ƒä¸­çš„æ‰€æœ‰å‡½æ•°ï¼Œéƒ½å¿…é¡»æ˜¯æ— å‰¯ä½œç”¨ï¼ˆside effectï¼‰çš„çº¯å‡½æ•°ï¼ˆpure functionï¼‰ï¼Œæ‰€ä»¥å¯¹æœ‰å‰¯ä½œç”¨çš„éšæœºå‡½æ•° <code>math.random</code> å’Œ <code>math.randornseed</code> è¿›è¡Œæ›¿æ¢</p></li><li><p>åˆ›å»ºæ’åºè¾…åŠ©å‡½æ•° <code> _redis_compare_helper</code>ï¼Œä½¿ç”¨è¾…åŠ©å‡½æ•°æ¥å¯¹ä¸€éƒ¨åˆ† Redis å‘½ä»¤çš„ç»“æœè¿›è¡Œæ’åºï¼Œä»è€Œæ¶ˆé™¤å‘½ä»¤çš„ä¸ç¡®å®šæ€§</p><p>æ¯”å¦‚é›†åˆå…ƒç´ çš„æ’åˆ—æ˜¯æ— åºçš„ï¼Œ æ‰€ä»¥å³ä½¿ä¸¤ä¸ªé›†åˆçš„å…ƒç´ å®Œå…¨ç›¸åŒï¼Œè¾“å‡ºç»“æœä¹Ÿä¸ä¸€å®šç›¸åŒï¼ŒRedis å°† SMEMBERS è¿™ç±»åœ¨ç›¸åŒæ•°æ®é›†ä¸Šäº§ç”Ÿä¸åŒè¾“å‡ºçš„å‘½ä»¤ç§°ä¸ºå¸¦æœ‰ä¸ç¡®å®šæ€§çš„å‘½ä»¤</p></li><li><p>åˆ›å»º redis.pcall å‡½æ•°çš„é”™è¯¯æŠ¥å‘Šè¾…åŠ©å‡½æ•° <code>_redis_err_handler </code>ï¼Œè¿™ä¸ªå‡½æ•°å¯ä»¥æ‰“å°å‡ºé”™ä»£ç çš„æ¥æºå’Œå‘ç”Ÿé”™è¯¯çš„è¡Œæ•°</p></li><li><p>å¯¹ Lua ç¯å¢ƒä¸­çš„å…¨å±€ç¯å¢ƒè¿›è¡Œä¿æŠ¤ï¼Œç¡®ä¿ä¼ å…¥æœåŠ¡å™¨çš„è„šæœ¬ä¸ä¼šå› å¿˜è®°ä½¿ç”¨ local å…³é”®å­—ï¼Œè€Œå°†é¢å¤–çš„å…¨å±€å˜é‡æ·»åŠ åˆ° Lua ç¯å¢ƒ</p></li><li><p>å°†å®Œæˆä¿®æ”¹çš„ Lua ç¯å¢ƒä¿å­˜åˆ°æœåŠ¡å™¨çŠ¶æ€çš„ lua å±æ€§ä¸­ï¼Œç­‰å¾…æ‰§è¡ŒæœåŠ¡å™¨ä¼ æ¥çš„ Lua è„šæœ¬</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    Lua <span class="token operator">*</span>lua<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>Redis ä½¿ç”¨ä¸²è¡ŒåŒ–çš„æ–¹å¼æ¥æ‰§è¡Œ Redis å‘½ä»¤ï¼Œæ‰€ä»¥åœ¨ä»»ä½•æ—¶é—´é‡Œæœ€å¤šéƒ½åªä¼šæœ‰ä¸€ä¸ªè„šæœ¬èƒ½å¤Ÿè¢«æ”¾è¿› Lua ç¯å¢ƒé‡Œé¢è¿è¡Œï¼Œå› æ­¤æ•´ä¸ª Redis æœåŠ¡å™¨åªéœ€è¦åˆ›å»ºä¸€ä¸ª Lua ç¯å¢ƒå³å¯</p><hr><h3 id="åä½œç»„ä»¶" tabindex="-1"><a class="header-anchor" href="#åä½œç»„ä»¶" aria-hidden="true">#</a> åä½œç»„ä»¶</h3><h4 id="ä¼ªå®¢æˆ·ç«¯" tabindex="-1"><a class="header-anchor" href="#ä¼ªå®¢æˆ·ç«¯" aria-hidden="true">#</a> ä¼ªå®¢æˆ·ç«¯</h4><p>Redis æœåŠ¡å™¨ä¸º Lua ç¯å¢ƒåˆ›å»ºäº†ä¸€ä¸ªä¼ªå®¢æˆ·ç«¯è´Ÿè´£å¤„ç† Lua è„šæœ¬ä¸­åŒ…å«çš„æ‰€æœ‰ Redis å‘½ä»¤ï¼Œå·¥ä½œæµç¨‹ï¼š</p><ul><li>Lua ç¯å¢ƒå°† redis.call æˆ–è€… redis.pcall å‡½æ•°æƒ³è¦æ‰§è¡Œçš„å‘½ä»¤ä¼ ç»™ä¼ªå®¢æˆ·ç«¯</li><li>ä¼ªå®¢æˆ·ç«¯å°†å‘½ä»¤ä¼ ç»™å‘½ä»¤æ‰§è¡Œå™¨</li><li>å‘½ä»¤æ‰§è¡Œå™¨æ‰§è¡Œå‘½ä»¤å¹¶å°†å‘½ä»¤çš„æ‰§è¡Œç»“æœè¿”å›ç»™ä¼ªå®¢æˆ·ç«¯</li><li>ä¼ªå®¢æˆ·ç«¯æ¥æ”¶å‘½ä»¤æ‰§è¡Œå™¨è¿”å›çš„å‘½ä»¤ç»“æœï¼Œå¹¶å°†ç»“æœè¿”å›ç»™ Lua ç¯å¢ƒ</li><li>Lua å°†å‘½ä»¤ç»“æœè¿”å›ç»™ redis.call å‡½æ•°æˆ–è€… redis.pcall å‡½æ•°</li><li>redis.call å‡½æ•°æˆ–è€… redis.pcall å‡½æ•°ä¼šå°†å‘½ä»¤ç»“æœä½œä¸ºè¿”å›å€¼è¿”å›ç»™è„šæœ¬çš„è°ƒç”¨è€…</li></ul><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-Luaä¼ªå®¢æˆ·ç«¯æ‰§è¡Œ.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h4 id="è„šæœ¬å­—å…¸" tabindex="-1"><a class="header-anchor" href="#è„šæœ¬å­—å…¸" aria-hidden="true">#</a> è„šæœ¬å­—å…¸</h4><p>Redis æœåŠ¡å™¨ä¸º Lua ç¯å¢ƒåˆ›å»º lua_scripts å­—å…¸ï¼Œé”®ä¸ºæŸä¸ª Lua è„šæœ¬çš„ SHA1 æ ¡éªŒå’Œï¼ˆchecksumï¼‰ï¼Œå€¼åˆ™æ˜¯æ ¡éªŒå’Œå¯¹åº”çš„ Lua è„šæœ¬</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    dict <span class="token operator">*</span>lua_scripts<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœåŠ¡å™¨ä¼šå°†æ‰€æœ‰è¢« EVAL å‘½ä»¤æ‰§è¡Œè¿‡çš„ Lua è„šæœ¬ï¼Œä»¥åŠæ‰€æœ‰è¢« SCRIPT LOAD å‘½ä»¤è½½å…¥è¿‡çš„ Lua è„šæœ¬éƒ½ä¿å­˜åˆ° lua_scripts å­—å…¸</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis<span class="token operator">&gt;</span> SCRIPT LOAD <span class="token string">&quot;return &#39;hi&#39;&quot;</span>
<span class="token string">&quot;2f3lba2bb6d6a0f42ccl59d2e2dad55440778de3&quot;</span> <span class="token comment"># å­—å…¸çš„é”®ï¼ŒSHA1 æ ¡éªŒå’Œ</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="å‘½ä»¤å®ç°-1" tabindex="-1"><a class="header-anchor" href="#å‘½ä»¤å®ç°-1" aria-hidden="true">#</a> å‘½ä»¤å®ç°</h3><h4 id="è„šæœ¬å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#è„šæœ¬å‡½æ•°" aria-hidden="true">#</a> è„šæœ¬å‡½æ•°</h4><p>EVAL å‘½ä»¤çš„æ‰§è¡Œçš„ç¬¬ä¸€æ­¥æ˜¯ä¸ºä¼ å…¥çš„è„šæœ¬å®šä¹‰ä¸€ä¸ªç›¸å¯¹åº”çš„ Lua å‡½æ•°ï¼ŒLua å‡½æ•°çš„åå­—ç”± f_ å‰ç¼€åŠ ä¸Šè„šæœ¬çš„ SHA1 æ ¡éªŒå’Œï¼ˆå››åä¸ªå­—ç¬¦é•¿ï¼‰ç»„æˆï¼Œè€Œå‡½æ•°çš„ä½“ï¼ˆbodyï¼‰åˆ™æ˜¯è„šæœ¬æœ¬èº«</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>EVAL <span class="token string">&quot;return &#39;hello world&#39;&quot;</span> <span class="token number">0</span> 
<span class="token comment"># å‘½ä»¤å°†ä¼šå®šä¹‰ä»¥ä¸‹çš„å‡½æ•°</span>
<span class="token keyword">function</span> <span class="token function-name function">f_533203lc6b470dc5a0dd9b4bf2030dea6d65de91</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token builtin class-name">return</span> <span class="token string">&#39;hello world&#39;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½¿ç”¨å‡½æ•°æ¥ä¿å­˜å®¢æˆ·ç«¯ä¼ å…¥çš„è„šæœ¬æœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š</p><ul><li>é€šè¿‡å‡½æ•°çš„å±€éƒ¨æ€§æ¥è®© Lua ç¯å¢ƒä¿æŒæ¸…æ´ï¼Œå‡å°‘äº†åƒåœ¾å›æ”¶çš„å·¥ä½œæœ€ï¼Œ å¹¶ä¸”é¿å…äº†ä½¿ç”¨å…¨å±€å˜é‡</li><li>å¦‚æœæŸä¸ªè„šæœ¬åœ¨ Lua ç¯å¢ƒä¸­è¢«å®šä¹‰è¿‡è‡³å°‘ä¸€æ¬¡ï¼Œé‚£ä¹ˆåªéœ€è¦ SHA1 æ ¡éªŒå’Œï¼ŒæœåŠ¡å™¨å°±å¯ä»¥åœ¨ä¸çŸ¥é“è„šæœ¬æœ¬èº«çš„æƒ…å†µä¸‹ï¼Œç›´æ¥é€šè¿‡è°ƒç”¨ Lua å‡½æ•°æ¥æ‰§è¡Œè„šæœ¬</li></ul><p>EVAL å‘½ä»¤ç¬¬äºŒæ­¥æ˜¯å°†å®¢æˆ·ç«¯ä¼ å…¥çš„è„šæœ¬ä¿å­˜åˆ°æœåŠ¡å™¨çš„ lua_scripts å­—å…¸é‡Œï¼Œåœ¨å­—å…¸ä¸­æ–°æ·»åŠ ä¸€ä¸ªé”®å€¼å¯¹</p><hr><h4 id="æ‰§è¡Œå‡½æ•°" tabindex="-1"><a class="header-anchor" href="#æ‰§è¡Œå‡½æ•°" aria-hidden="true">#</a> æ‰§è¡Œå‡½æ•°</h4><p>EVAL å‘½ä»¤ç¬¬ä¸‰æ­¥æ˜¯æ‰§è¡Œè„šæœ¬å‡½æ•°</p><ul><li><p>å°† EVAL å‘½ä»¤ä¸­ä¼ å…¥çš„<strong>é”®åå‚æ•°å’Œè„šæœ¬å‚æ•°</strong>åˆ†åˆ«ä¿å­˜åˆ° KEYS æ•°ç»„å’Œ ARGV æ•°ç»„ï¼Œå°†è¿™ä¸¤ä¸ªæ•°ç»„ä½œä¸º<strong>å…¨å±€å˜é‡</strong>ä¼ å…¥åˆ° Lua ç¯å¢ƒ</p></li><li><p>ä¸º Lua ç¯å¢ƒè£…è½½è¶…æ—¶å¤„ç†é’©å­ï¼ˆhookï¼‰ï¼Œè¿™ä¸ªé’©å­å¯ä»¥åœ¨è„šæœ¬å‡ºç°è¶…æ—¶è¿è¡Œæƒ…å†µæ—¶ï¼Œè®©å®¢æˆ·ç«¯é€šè¿‡ <code>SCRIPT KILL</code> å‘½ä»¤åœæ­¢è„šæœ¬ï¼Œæˆ–è€…é€šè¿‡ SHUTDOWN å‘½ä»¤ç›´æ¥å…³é—­æœåŠ¡å™¨</p><p>å› ä¸º Redis æ˜¯å•çº¿ç¨‹çš„æ‰§è¡Œå‘½ä»¤ï¼Œå½“ Lua è„šæœ¬é˜»å¡æ—¶éœ€è¦å…œåº•ç­–ç•¥ï¼Œå¯ä»¥ä¸­æ–­æ‰§è¡Œ</p></li><li><p>æ‰§è¡Œè„šæœ¬å‡½æ•°</p></li><li><p>ç§»é™¤ä¹‹å‰è£…è½½çš„è¶…æ—¶é’©å­</p></li><li><p>å°†æ‰§è¡Œè„šæœ¬å‡½æ•°çš„ç»“æœä¿å­˜åˆ°å®¢æˆ·ç«¯çŠ¶æ€çš„è¾“å‡ºç¼“å†²åŒºé‡Œï¼Œç­‰å¾…æœåŠ¡å™¨å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯</p></li></ul><hr><h4 id="evalsha" tabindex="-1"><a class="header-anchor" href="#evalsha" aria-hidden="true">#</a> EVALSHA</h4><p>EVALSHA å‘½ä»¤çš„å®ç°åŸç†å°±æ˜¯æ ¹æ®è„šæœ¬çš„ SHA1 æ ¡éªŒå’Œæ¥è°ƒç”¨<strong>è„šæœ¬å¯¹åº”çš„å‡½æ•°</strong>ï¼Œå¦‚æœå‡½æ•°åœ¨ Lua ç¯å¢ƒä¸­ä¸å­˜åœ¨ï¼Œæ‰¾ä¸åˆ° f_ å¼€å¤´çš„å‡½æ•°ï¼Œå°±ä¼šè¿”å› <code>SCRIPT NOT FOUND</code></p><hr><h3 id="ç®¡ç†å‘½ä»¤" tabindex="-1"><a class="header-anchor" href="#ç®¡ç†å‘½ä»¤" aria-hidden="true">#</a> ç®¡ç†å‘½ä»¤</h3><p>Redis ä¸­ä¸ Lua è„šæœ¬æœ‰å…³çš„ç®¡ç†å‘½ä»¤æœ‰å››ä¸ªï¼š</p><ul><li><p>SCRIPT FLUSHï¼šç”¨äºæ¸…é™¤æœåŠ¡å™¨ä¸­æ‰€æœ‰å’Œ Lua è„šæœ¬æœ‰å…³çš„ä¿¡æ¯ï¼Œä¼šé‡Šæ”¾å¹¶é‡å»º lua_scripts å­—å…¸ï¼Œå…³é—­ç°æœ‰çš„ Lua ç¯å¢ƒå¹¶é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„ Lua ç¯å¢ƒ</p></li><li><p>SCRIPT EXISTSï¼šæ ¹æ®è¾“å…¥çš„ SHA1 æ ¡éªŒå’Œï¼ˆå…è®¸ä¸€æ¬¡ä¼ å…¥å¤šä¸ªæ ¡éªŒå’Œï¼‰ï¼Œæ£€æŸ¥æ ¡éªŒå’Œå¯¹åº”çš„è„šæœ¬æ˜¯å¦å­˜åœ¨äºæœåŠ¡å™¨ä¸­ï¼Œé€šè¿‡æ£€æŸ¥ lua_scripts å­—å…¸å®ç°</p></li><li><p>SCRIPT LOADï¼šåœ¨ Lua ç¯å¢ƒä¸­ä¸ºè„šæœ¬åˆ›å»ºç›¸å¯¹åº”çš„å‡½æ•°ï¼Œç„¶åå°†è„šæœ¬ä¿å­˜åˆ° lua_scriptså­—å…¸é‡Œ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis<span class="token operator">&gt;</span> SCRIPT LOAD <span class="token string">&quot;return &#39;hi&#39;&quot;</span>
<span class="token string">&quot;2f3lba2bb6d6a0f42ccl59d2e2dad55440778de3&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>SCRIPT KILLï¼šåœæ­¢è„šæœ¬</p></li></ul><p>å¦‚æœæœåŠ¡å™¨é…ç½®äº† lua-time-liÂ­mit é€‰é¡¹ï¼Œé‚£ä¹ˆåœ¨æ¯æ¬¡æ‰§è¡Œ Lua è„šæœ¬ä¹‹å‰ï¼Œéƒ½ä¼šè®¾ç½®ä¸€ä¸ªè¶…æ—¶å¤„ç†çš„é’©å­ã€‚é’©å­ä¼šåœ¨è„šæœ¬è¿è¡ŒæœŸé—´ä¼šå®šæœŸæ£€æŸ¥è¿è¡Œæ—¶é—´æ˜¯å¦è¶…è¿‡é…ç½®æ—¶é—´ï¼Œå¦‚æœè¶…æ—¶é’©å­å°†å®šæœŸåœ¨è„šæœ¬è¿è¡Œçš„é—´éš™ä¸­ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ SCRIPT KILL æˆ–è€… SHUTDOWN åˆ°è¾¾ï¼š</p><ul><li>å¦‚æœè¶…æ—¶è¿è¡Œçš„è„šæœ¬æ²¡æœ‰æ‰§è¡Œè¿‡å†™å…¥æ“ä½œï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ SCRIPT KILL æ¥åœæ­¢è¿™ä¸ªè„šæœ¬</li><li>å¦‚æœæ‰§è¡Œè¿‡å†™å…¥æ“ä½œï¼Œå®¢æˆ·ç«¯åªèƒ½ç”¨ SHUTDOWN nosave å‘½ä»¤æ¥åœæ­¢æœåŠ¡å™¨ï¼Œé˜²æ­¢ä¸åˆæ³•çš„æ•°æ®è¢«å†™å…¥æ•°æ®åº“ä¸­</li></ul><hr><h3 id="è„šæœ¬å¤åˆ¶" tabindex="-1"><a class="header-anchor" href="#è„šæœ¬å¤åˆ¶" aria-hidden="true">#</a> è„šæœ¬å¤åˆ¶</h3><h4 id="å‘½ä»¤å¤åˆ¶" tabindex="-1"><a class="header-anchor" href="#å‘½ä»¤å¤åˆ¶" aria-hidden="true">#</a> å‘½ä»¤å¤åˆ¶</h4><p>å½“æœåŠ¡å™¨è¿è¡Œåœ¨å¤åˆ¶æ¨¡å¼æ—¶ï¼Œå…·æœ‰å†™æ€§è´¨çš„è„šæœ¬å‘½ä»¤ä¹Ÿä¼šè¢«å¤åˆ¶åˆ°ä»æœåŠ¡å™¨ï¼ŒåŒ…æ‹¬ EVALã€EVALSHAã€SCRIPT FLUSHï¼Œä»¥åŠ SCRIPT LOAD å‘½ä»¤</p><p>Redis å¤åˆ¶ EVALã€SCRIPT FLUSHã€SCRIPT LOAD ä¸‰ä¸ªå‘½ä»¤çš„æ–¹æ³•å’Œå¤åˆ¶æ™®é€š Redis å‘½ä»¤çš„æ–¹æ³•ä¸€æ ·ï¼Œå½“ä¸»æœåŠ¡å™¨æ‰§è¡Œå®Œä»¥ä¸Šä¸‰ä¸ªå‘½ä»¤çš„å…¶ä¸­ä¸€ä¸ªæ—¶ï¼Œä¼šç›´æ¥å°†è¢«æ‰§è¡Œçš„å‘½ä»¤ä¼ æ’­ï¼ˆpropagateï¼‰ç»™æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œåœ¨ä»æœåŠ¡å™¨ä¸­äº§ç”Ÿç›¸åŒçš„æ•ˆæœ</p><hr><h4 id="evalsha-1" tabindex="-1"><a class="header-anchor" href="#evalsha-1" aria-hidden="true">#</a> EVALSHA</h4><p>EVALSHA å‘½ä»¤çš„å¤åˆ¶æ“ä½œç›¸å¯¹å¤æ‚ï¼Œå› ä¸ºå¤šä¸ªä»æœåŠ¡å™¨ä¹‹é—´è½½å…¥ Lua è„šæœ¬çš„æ¸…å†µå„æœ‰ä¸åŒï¼Œä¸€ä¸ªåœ¨ä¸»æœåŠ¡å™¨è¢«æˆåŠŸæ‰§è¡Œçš„ EVALSHA å‘½ä»¤ï¼Œåœ¨ä»æœåŠ¡å™¨æ‰§è¡Œæ—¶å¯èƒ½ä¼šå‡ºç°è„šæœ¬æœªæ‰¾åˆ°ï¼ˆnot foundï¼‰é”™è¯¯</p><p>Redis è¦æ±‚ä¸»æœåŠ¡å™¨åœ¨ä¼ æ’­ EVALSHA å‘½ä»¤æ—¶ï¼Œå¿…é¡»ç¡®ä¿ EVALSHA å‘½ä»¤è¦æ‰§è¡Œçš„è„šæœ¬å·²ç»è¢«æ‰€æœ‰ä»æœåŠ¡å™¨è½½å…¥è¿‡ï¼Œå¦‚æœä¸èƒ½ç¡®ä¿ä¸»æœåŠ¡å™¨ä¼š<strong>å°† EVALSHA å‘½ä»¤è½¬æ¢æˆä¸€ä¸ªç­‰ä»·çš„ EVAL å‘½ä»¤</strong>ï¼Œç„¶åé€šè¿‡ä¼ æ’­ EVAL å‘½ä»¤æ¥ä»£æ›¿ EVALSHA å‘½ä»¤</p><p>ä¸»æœåŠ¡å™¨ä½¿ç”¨æœåŠ¡å™¨çŠ¶æ€çš„ repl_scriptcache_dict å­—å…¸è®°å½•å·²ç»å°†å“ªäº›è„šæœ¬ä¼ æ’­ç»™äº†<strong>æ‰€æœ‰ä»æœåŠ¡å™¨</strong>ï¼Œå½“ä¸€ä¸ªæ ¡éªŒå’Œå‡ºç°åœ¨å­—å…¸æ—¶ï¼Œè¯´æ˜æ ¡éªŒå’Œå¯¹åº”çš„ Lua è„šæœ¬å·²ç»ä¼ æ’­ç»™äº†æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨å¯ä»¥ç›´æ¥ä¼ æ’­ EVALSHA å‘½ä»¤</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
    <span class="token comment">// é”®æ˜¯ä¸€ä¸ªä¸ª Lua è„šæœ¬çš„ SHA1 æ ¡éªŒå’Œï¼Œå€¼åˆ™å…¨éƒ¨éƒ½æ˜¯ NULL</span>
    dict <span class="token operator">*</span>repl_scriptcache_dict<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„ï¼šæ¯å½“ä¸»æœåŠ¡å™¨æ·»åŠ ä¸€ä¸ªæ–°çš„ä»æœåŠ¡å™¨æ—¶ï¼Œéƒ½ä¼šæ¸…ç©º repl_scriptcache_dict å­—å…¸ï¼Œå› ä¸ºå­—å…¸é‡Œé¢è®°å½•çš„è„šæœ¬å·²ç»ä¸å†è¢«æ‰€æœ‰ä»æœåŠ¡å™¨è½½å…¥è¿‡ï¼Œæ‰€ä»¥æœåŠ¡å™¨ä»¥æ¸…ç©ºå­—å…¸çš„æ–¹å¼ï¼Œå¼ºåˆ¶é‡æ–°å‘æ‰€æœ‰ä»æœåŠ¡å™¨ä¼ æ’­è„šæœ¬</p><p>é€šè¿‡ä½¿ç”¨ EVALSHA å‘½ä»¤æŒ‡å®šçš„ SHA1 æ ¡éªŒå’Œï¼Œä»¥åŠ lua_scripts å­—å…¸ä¿å­˜çš„ Lua è„šæœ¬ï¼Œå¯ä»¥å°†ä¸€ä¸ª EVALSHA å‘½ä»¤è½¬åŒ–ä¸º EVAL å‘½ä»¤</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>EVALSHA <span class="token string">&quot;533203lc6b470dc5a0dd9b4bf2030dea6d65de91&quot;</span> <span class="token number">0</span> 
<span class="token comment"># -&gt; è½¬æ¢</span>
EVAL <span class="token string">&quot;return&#39;hello world&#39;&quot;</span> <span class="token number">0</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è„šæœ¬å†…å®¹ <code>&quot;return&#39;hello world&#39;&quot;</code> æ¥æºäº lua_scripts å­—å…¸ 533203lc6b470dc5a0dd9b4bf2030dea6d65de91 é”®çš„å€¼</p><hr><h2 id="åˆ†å¸ƒå¼é”" tabindex="-1"><a class="header-anchor" href="#åˆ†å¸ƒå¼é”" aria-hidden="true">#</a> åˆ†å¸ƒå¼é”</h2><h3 id="åŸºæœ¬æ“ä½œ-1" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ“ä½œ-1" aria-hidden="true">#</a> åŸºæœ¬æ“ä½œ</h3><p>åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œé”å˜é‡éœ€è¦ç”±ä¸€ä¸ªå…±äº«å­˜å‚¨ç³»ç»Ÿæ¥ç»´æŠ¤ï¼Œå¤šä¸ªå®¢æˆ·ç«¯æ‰å¯ä»¥é€šè¿‡è®¿é—®å…±äº«å­˜å‚¨ç³»ç»Ÿæ¥è®¿é—®é”å˜é‡ï¼ŒåŠ é”å’Œé‡Šæ”¾é”çš„æ“ä½œå°±å˜æˆäº†è¯»å–ã€åˆ¤æ–­å’Œè®¾ç½®å…±äº«å­˜å‚¨ç³»ç»Ÿä¸­çš„é”å˜é‡å€¼å¤šæ­¥æ“ä½œ</p><p>Redis åˆ†å¸ƒå¼é”çš„åŸºæœ¬ä½¿ç”¨ï¼Œæ‚²è§‚é”</p><ul><li><p>ä½¿ç”¨ SETNX è®¾ç½®ä¸€ä¸ªå…¬å…±é”</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>SETNX lock-key value	<span class="token comment"># valueä»»æ„æ•°ï¼Œè¿”å›ä¸º1è®¾ç½®æˆåŠŸï¼Œè¿”å›ä¸º0è®¾ç½®å¤±è´¥</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p><code>NX</code>ï¼šåªåœ¨é”®ä¸å­˜åœ¨æ—¶ï¼Œæ‰å¯¹é”®è¿›è¡Œè®¾ç½®æ“ä½œï¼Œ<code>SET key value NX</code> æ•ˆæœç­‰åŒäº <code>SETNX key value</code></p><p><code>XX</code>ï¼šåªåœ¨é”®å·²ç»å­˜åœ¨æ—¶ï¼Œæ‰å¯¹é”®è¿›è¡Œè®¾ç½®æ“ä½œ</p><p><code>EX</code>ï¼šè®¾ç½®é”® key çš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ—¶ç§’</p><p><code>PX</code>ï¼šè®¾ç½®é”® key çš„è¿‡æœŸæ—¶é—´ï¼Œå•ä½æ—¶æ¯«ç§’</p><p>è¯´æ˜ï¼šç”±äº <code>SET</code> å‘½ä»¤åŠ ä¸Šé€‰é¡¹å·²ç»å¯ä»¥å®Œå…¨å–ä»£ SETNXã€SETEXã€PSETEX çš„åŠŸèƒ½ï¼ŒRedis ä¸æ¨èä½¿ç”¨è¿™å‡ ä¸ªå‘½ä»¤</p></li><li><p>æ“ä½œå®Œæ¯•é€šè¿‡ DEL æ“ä½œé‡Šæ”¾é”</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>DEL lock-key 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>ä½¿ç”¨ EXPIRE ä¸ºé” key æ·»åŠ å­˜æ´»ï¼ˆæŒæœ‰ï¼‰æ—¶é—´ï¼Œè¿‡æœŸè‡ªåŠ¨åˆ é™¤ï¼ˆæ”¾å¼ƒï¼‰é”ï¼Œé˜²æ­¢çº¿ç¨‹å‡ºç°å¼‚å¸¸ï¼Œæ— æ³•é‡Šæ”¾é”</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>EXPIRE lock-key second 
PEXPIRE lock-key milliseconds
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ EXPIRE è®¾ç½®è¿‡æœŸæ—¶é—´ç¼ºä¹åŸå­æ€§ï¼Œå¦‚æœåœ¨ SETNX å’Œ EXPIRE ä¹‹é—´å‡ºç°å¼‚å¸¸ï¼Œé”ä¹Ÿæ— æ³•é‡Šæ”¾</p></li><li><p>åœ¨ SET æ—¶æŒ‡å®šè¿‡æœŸæ—¶é—´ï¼Œä¿è¯åŸå­æ€§</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>SET key value NX <span class="token punctuation">[</span>EX seconds <span class="token operator">|</span> PX milliseconds<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><hr><h3 id="é˜²è¯¯åˆ " tabindex="-1"><a class="header-anchor" href="#é˜²è¯¯åˆ " aria-hidden="true">#</a> é˜²è¯¯åˆ </h3><p>åœºæ™¯æè¿°ï¼šçº¿ç¨‹ A æ­£åœ¨æ‰§è¡Œï¼Œä½†æ˜¯ä¸šåŠ¡é˜»å¡ï¼Œåœ¨é”çš„è¿‡æœŸæ—¶é—´å†…æœªæ‰§è¡Œå®Œæˆï¼Œè¿‡æœŸåˆ é™¤åçº¿ç¨‹ B é‡æ–°è·å–åˆ°é”ï¼Œæ­¤æ—¶çº¿ç¨‹ A æ‰§è¡Œå®Œæˆï¼Œåˆ é™¤é”ï¼Œå¯¼è‡´çº¿ç¨‹ B çš„é”è¢«çº¿ç¨‹ A è¯¯åˆ </p><p>SETNX è·å–é”æ—¶ï¼Œè®¾ç½®ä¸€ä¸ªæŒ‡å®šçš„å”¯ä¸€å€¼ï¼ˆUUIDï¼‰ï¼Œé‡Šæ”¾å‰è·å–è¿™ä¸ªå€¼ï¼Œåˆ¤æ–­æ˜¯å¦è‡ªå·±çš„é”ï¼Œé˜²æ­¢å‡ºç°çº¿ç¨‹ä¹‹é—´è¯¯åˆ äº†å…¶ä»–çº¿ç¨‹çš„é”</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// åŠ é”, unique_valueä½œä¸ºå®¢æˆ·ç«¯å”¯ä¸€æ€§çš„æ ‡è¯†ï¼Œ</span>
<span class="token comment">// PX 10000 åˆ™è¡¨ç¤º lock_key ä¼šåœ¨ 10s åè¿‡æœŸï¼Œä»¥å…å®¢æˆ·ç«¯åœ¨è¿™æœŸé—´å‘ç”Ÿå¼‚å¸¸è€Œæ— æ³•é‡Šæ”¾é”</span>
<span class="token constant">SET</span> lock_key unique_value <span class="token constant">NX</span> <span class="token constant">PX</span> <span class="token number">10000</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Lua è„šæœ¬ï¼ˆunlock.scriptï¼‰å®ç°çš„é‡Šæ”¾é”æ“ä½œçš„ä¼ªä»£ç ï¼škey ç±»å‹å‚æ•°ä¼šæ”¾å…¥ KEYS æ•°ç»„ï¼Œå…¶å®ƒå‚æ•°ä¼šæ”¾å…¥ ARGV æ•°ç»„ï¼Œåœ¨è„šæœ¬ä¸­é€šè¿‡ KEYS å’Œ ARGV ä¼ é€’å‚æ•°ï¼Œ<strong>ä¿è¯åˆ¤æ–­æ ‡è¯†å’Œé‡Šæ”¾é”è¿™ä¸¤ä¸ªæ“ä½œçš„åŸå­æ€§</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>EVAL <span class="token string">&quot;return redis.call(&#39;set&#39;, KEYS[1], ARGV[1])&quot;</span> <span class="token number">1</span> lock_key unique_value <span class="token comment"># 1 ä»£è¡¨éœ€è¦ä¸€ä¸ªå‚æ•°</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// é‡Šæ”¾é”ï¼ŒKEYS[1] å°±æ˜¯é”çš„ keyï¼ŒARGV[1] å°±æ˜¯æ ‡è¯†å€¼ï¼Œé¿å…è¯¯é‡Šæ”¾</span>
<span class="token comment">// è·å–æ ‡è¯†å€¼ï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡ç¤ºä¸€è‡´</span>
<span class="token keyword">if</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> then
    <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;del&quot;</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">else</span>
    <span class="token keyword">return</span> <span class="token number">0</span>
end
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="ä¼˜åŒ–é”" tabindex="-1"><a class="header-anchor" href="#ä¼˜åŒ–é”" aria-hidden="true">#</a> ä¼˜åŒ–é”</h3><h4 id="ä¸å¯é‡å…¥" tabindex="-1"><a class="header-anchor" href="#ä¸å¯é‡å…¥" aria-hidden="true">#</a> ä¸å¯é‡å…¥</h4><p>ä¸å¯é‡å…¥ï¼šåŒä¸€ä¸ªçº¿ç¨‹æ— æ³•å¤šæ¬¡è·å–åŒä¸€æŠŠé”</p><p>ä½¿ç”¨ hash é”®ï¼Œfiled æ˜¯åŠ é”çš„çº¿ç¨‹æ ‡è¯†ï¼Œ value æ˜¯<strong>é”é‡å…¥æ¬¡æ•°</strong></p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token operator">|</span>    <span class="token keyword">key</span>    <span class="token operator">|</span>       <span class="token keyword">value</span>       <span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token operator">|</span>  filed  <span class="token operator">|</span>  <span class="token keyword">value</span>  <span class="token operator">|</span>
<span class="token operator">|</span><span class="token comment">-------------------------------|</span>
<span class="token operator">|</span>  lock_key <span class="token operator">|</span> thread1 <span class="token operator">|</span>    <span class="token number">1</span>    <span class="token operator">|</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é”é‡å…¥ï¼š</p><ul><li>åŠ é”æ—¶åˆ¤æ–­é”çš„ filed å±æ€§æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯å°† value åŠ  1</li><li>è§£é”æ—¶åˆ¤æ–­é”çš„ filed å±æ€§æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ï¼Œé¦–å…ˆå°† value å‡ä¸€ï¼Œå¦‚æœ value ä¸º 0 ç›´æ¥é‡Šæ”¾é”</li></ul><p>ä½¿ç”¨ Lua è„šæœ¬ä¿è¯å¤šæ¡å‘½ä»¤çš„åŸå­æ€§</p><hr><h4 id="ä¸å¯é‡è¯•" tabindex="-1"><a class="header-anchor" href="#ä¸å¯é‡è¯•" aria-hidden="true">#</a> ä¸å¯é‡è¯•</h4><p>ä¸å¯é‡è¯•ï¼šè·å–é”åªå°è¯•ä¸€æ¬¡å°±è¿”å› falseï¼Œæ²¡æœ‰é‡è¯•æœºåˆ¶</p><ul><li>åˆ©ç”¨ Lua è„šæœ¬å°è¯•è·å–é”ï¼Œè·å–å¤±è´¥è·å–é”çš„å‰©ä½™è¶…æ—¶æ—¶é—´ ttlï¼Œæˆ–è€…é€šè¿‡å‚æ•°ä¼ å…¥çº¿ç¨‹æŠ¢é”å…è®¸ç­‰å¾…çš„æ—¶é—´</li><li>åˆ©ç”¨è®¢é˜…åŠŸèƒ½è®¢é˜…é”é‡Šæ”¾çš„ä¿¡æ¯ï¼Œç„¶åçº¿ç¨‹æŒ‚èµ·ç­‰å¾… ttl æ—¶é—´</li><li>åˆ©ç”¨ Lua è„šæœ¬åœ¨é‡Šæ”¾é”æ—¶ï¼Œå‘å¸ƒä¸€æ¡é”é‡Šæ”¾çš„æ¶ˆæ¯</li></ul><hr><h4 id="è¶…æ—¶é‡Šæ”¾" tabindex="-1"><a class="header-anchor" href="#è¶…æ—¶é‡Šæ”¾" aria-hidden="true">#</a> è¶…æ—¶é‡Šæ”¾</h4><p>è¶…æ—¶é‡Šæ”¾ï¼šé”è¶…æ—¶é‡Šæ”¾å¯ä»¥é¿å…æ­»é”ï¼Œä½†å¦‚æœæ˜¯ä¸šåŠ¡æ‰§è¡Œè€—æ—¶è¾ƒé•¿ï¼Œéœ€è¦è¿›è¡Œé”ç»­æ—¶ï¼Œé˜²æ­¢ä¸šåŠ¡æœªæ‰§è¡Œå®Œæå‰é‡Šæ”¾é”</p><p>çœ‹é—¨ç‹— Watch Dog æœºåˆ¶ï¼š</p><ul><li>è·å–é”æˆåŠŸåï¼Œæäº¤å‘¨æœŸä»»åŠ¡ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆRedisson ä¸­é»˜è®¤ä¸ºè¿‡æœŸæ—¶é—´ / 3ï¼‰ï¼Œé‡ç½®ä¸€æ¬¡è¶…æ—¶æ—¶é—´</li><li>å¦‚æœæœåŠ¡å®•æœºï¼ŒWatch Dog æœºåˆ¶çº¿ç¨‹å°±åœæ­¢ï¼Œå°±ä¸ä¼šå†å»¶é•¿ key çš„è¿‡æœŸæ—¶é—´</li><li>é‡Šæ”¾é”åï¼Œç»ˆæ­¢å‘¨æœŸä»»åŠ¡</li></ul><hr><h4 id="ä¸»ä»ä¸€è‡´" tabindex="-1"><a class="header-anchor" href="#ä¸»ä»ä¸€è‡´" aria-hidden="true">#</a> ä¸»ä»ä¸€è‡´</h4><p>ä¸»ä»ä¸€è‡´æ€§ï¼šé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œä¸»ä»åŒæ­¥å­˜åœ¨å»¶è¿Ÿï¼Œå½“åŠ é”åä¸»æœåŠ¡å™¨å®•æœºæ—¶ï¼Œä»æœåŠ¡å™¨è¿˜æ²¡åŒæ­¥ä¸»æœåŠ¡å™¨ä¸­çš„é”æ•°æ®ï¼Œæ­¤æ—¶ä»æœåŠ¡å™¨å‡çº§ä¸ºä¸»æœåŠ¡å™¨ï¼Œå…¶ä»–çº¿ç¨‹åˆå¯ä»¥è·å–åˆ°é”</p><p>å°†æœåŠ¡å™¨å‡çº§ä¸ºå¤šä¸»å¤šä»ï¼š</p><ul><li>è·å–é”éœ€è¦ä»æ‰€æœ‰ä¸»æœåŠ¡å™¨ SET æˆåŠŸæ‰ç®—è·å–æˆåŠŸ</li><li>æŸä¸ª master å®•æœºï¼Œslave è¿˜æ²¡æœ‰åŒæ­¥é”æ•°æ®å°±å‡çº§ä¸º masterï¼Œå…¶ä»–çº¿ç¨‹å°è¯•åŠ é”ä¼šåŠ é”å¤±è´¥ï¼Œå› ä¸ºå…¶ä»– master ä¸Šå·²ç»å­˜åœ¨è¯¥é”</li></ul><hr><h2 id="ä¸»ä»å¤åˆ¶" tabindex="-1"><a class="header-anchor" href="#ä¸»ä»å¤åˆ¶" aria-hidden="true">#</a> ä¸»ä»å¤åˆ¶</h2><h3 id="åŸºæœ¬æ“ä½œ-2" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ“ä½œ-2" aria-hidden="true">#</a> åŸºæœ¬æ“ä½œ</h3><h4 id="ä¸»ä»ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#ä¸»ä»ä»‹ç»" aria-hidden="true">#</a> ä¸»ä»ä»‹ç»</h4><p>ä¸»ä»å¤åˆ¶ï¼šä¸€ä¸ªæœåŠ¡å™¨å»å¤åˆ¶å¦ä¸€ä¸ªæœåŠ¡å™¨ï¼Œè¢«å¤åˆ¶çš„æœåŠ¡å™¨ä¸ºä¸»æœåŠ¡å™¨ masterï¼Œå¤åˆ¶çš„æœåŠ¡å™¨ä¸ºä»æœåŠ¡å™¨ slave</p><ul><li>master ç”¨æ¥<strong>å†™æ•°æ®</strong>ï¼Œæ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œå°†å‡ºç°å˜åŒ–çš„æ•°æ®è‡ªåŠ¨åŒæ­¥åˆ° slaveï¼Œå¾ˆå°‘ä¼šè¿›è¡Œè¯»å–æ“ä½œ</li><li>slave ç”¨æ¥è¯»æ•°æ®ï¼Œç¦æ­¢åœ¨ slave æœåŠ¡å™¨ä¸Šè¿›è¡Œè¯»æ“ä½œ</li></ul><p>è¿›è¡Œå¤åˆ¶ä¸­çš„ä¸»ä»æœåŠ¡å™¨åŒæ–¹çš„æ•°æ®åº“å°†ä¿å­˜ç›¸åŒçš„æ•°æ®ï¼Œå°†è¿™ç§ç°è±¡ç§°ä½œ<strong>æ•°æ®åº“çŠ¶æ€ä¸€è‡´</strong></p><p>ä¸»ä»å¤åˆ¶çš„ç‰¹ç‚¹ï¼š</p><ul><li><p><strong>è–ªç«ç›¸ä¼ </strong>ï¼šä¸€ä¸ª slave å¯ä»¥æ˜¯ä¸‹ä¸€ä¸ª slave çš„ masterï¼Œslave åŒæ ·å¯ä»¥æ¥æ”¶å…¶ä»– slave çš„è¿æ¥å’ŒåŒæ­¥è¯·æ±‚ï¼Œé‚£ä¹ˆè¯¥ slave ä½œä¸ºäº†é“¾æ¡ä¸­ä¸‹ä¸€ä¸ªçš„ masterï¼Œå¯ä»¥æœ‰æ•ˆå‡è½» master çš„å†™å‹åŠ›ï¼Œå»ä¸­å¿ƒåŒ–é™ä½é£é™©</p><p>æ³¨æ„ï¼šä¸»æœºæŒ‚äº†ï¼Œä»æœºè¿˜æ˜¯ä»æœºï¼Œæ— æ³•å†™æ•°æ®äº†</p></li><li><p><strong>åå®¢ä¸ºä¸»</strong>ï¼šå½“ä¸€ä¸ª master å®•æœºåï¼Œåé¢çš„ slave å¯ä»¥ç«‹åˆ»å‡ä¸º masterï¼Œå…¶åé¢çš„ slave ä¸åšä»»ä½•ä¿®æ”¹</p></li></ul><p>ä¸»ä»å¤åˆ¶çš„ä½œç”¨ï¼š</p><ul><li><strong>è¯»å†™åˆ†ç¦»</strong>ï¼šmaster å†™ã€slave è¯»ï¼Œæé«˜æœåŠ¡å™¨çš„è¯»å†™è´Ÿè½½èƒ½åŠ›</li><li><strong>è´Ÿè½½å‡è¡¡</strong>ï¼šåŸºäºä¸»ä»ç»“æ„ï¼Œé…åˆè¯»å†™åˆ†ç¦»ï¼Œç”± slave åˆ†æ‹… master è´Ÿè½½ï¼Œå¹¶æ ¹æ®éœ€æ±‚çš„å˜åŒ–ï¼Œæ”¹å˜ slave çš„æ•°é‡ï¼Œé€šè¿‡å¤šä¸ªä»èŠ‚ç‚¹åˆ†æ‹…æ•°æ®è¯»å–è´Ÿè½½ï¼Œå¤§å¤§æé«˜ Redis æœåŠ¡å™¨å¹¶å‘é‡ä¸æ•°æ®ååé‡</li><li>æ•…éšœæ¢å¤ï¼šå½“ master å‡ºç°é—®é¢˜æ—¶ï¼Œç”± slave æä¾›æœåŠ¡ï¼Œå®ç°å¿«é€Ÿçš„æ•…éšœæ¢å¤</li><li>æ•°æ®å†—ä½™ï¼šå®ç°æ•°æ®çƒ­å¤‡ä»½ï¼Œæ˜¯æŒä¹…åŒ–ä¹‹å¤–çš„ä¸€ç§æ•°æ®å†—ä½™æ–¹å¼</li><li>é«˜å¯ç”¨åŸºçŸ³ï¼šåŸºäºä¸»ä»å¤åˆ¶ï¼Œæ„å»ºå“¨å…µæ¨¡å¼ä¸é›†ç¾¤ï¼Œå®ç° Redis çš„é«˜å¯ç”¨æ–¹æ¡ˆ</li></ul><p><strong>ä¸‰é«˜</strong>æ¶æ„ï¼š</p><ul><li><p>é«˜å¹¶å‘ï¼šåº”ç”¨æä¾›æŸä¸€ä¸šåŠ¡è¦èƒ½æ”¯æŒå¾ˆå¤šå®¢æˆ·ç«¯åŒæ—¶è®¿é—®çš„èƒ½åŠ›ï¼Œç§°ä¸ºå¹¶å‘</p></li><li><p>é«˜æ€§èƒ½ï¼šæ€§èƒ½æœ€ç›´è§‚çš„æ„Ÿå—å°±æ˜¯é€Ÿåº¦å¿«ï¼Œæ—¶é—´çŸ­</p></li><li><p>é«˜å¯ç”¨ï¼š</p><ul><li>å¯ç”¨æ€§ï¼šåº”ç”¨æœåŠ¡åœ¨å…¨å¹´å®•æœºçš„æ—¶é—´åŠ åœ¨ä¸€èµ·å°±æ˜¯å…¨å¹´åº”ç”¨æœåŠ¡ä¸å¯ç”¨çš„æ—¶é—´</li><li>ä¸šç•Œå¯ç”¨æ€§ç›®æ ‡ 5 ä¸ª 9ï¼Œå³ 99.999%ï¼Œå³æœåŠ¡å™¨å¹´å®•æœºæ—¶é•¿ä½äº 315 ç§’ï¼Œçº¦ 5.25 åˆ†é’Ÿ</li></ul></li></ul><hr><h4 id="æ“ä½œæŒ‡ä»¤" tabindex="-1"><a class="header-anchor" href="#æ“ä½œæŒ‡ä»¤" aria-hidden="true">#</a> æ“ä½œæŒ‡ä»¤</h4><p>ç³»ç»ŸçŠ¶æ€æŒ‡ä»¤ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>INFO replication
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>master å’Œ slave äº’è¿ï¼š</p><ul><li><p>æ–¹å¼ä¸€ï¼šå®¢æˆ·ç«¯å‘é€å‘½ä»¤ï¼Œè®¾ç½® slaveof é€‰é¡¹ï¼Œäº§ç”Ÿä¸»ä»ç»“æ„</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>slaveof masterip masterport
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>æ–¹å¼äºŒï¼šæœåŠ¡å™¨å¸¦å‚å¯åŠ¨</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-server <span class="token parameter variable">--slaveof</span> masterip masterport
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>æ–¹å¼ä¸‰ï¼šæœåŠ¡å™¨é…ç½®ï¼ˆä¸»æµæ–¹å¼ï¼‰</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>slaveof masterip masterport
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><p>ä¸»ä»æ–­å¼€è¿æ¥ï¼š</p><ul><li><p>slave æ–­å¼€è¿æ¥åï¼Œä¸ä¼šåˆ é™¤å·²æœ‰æ•°æ®ï¼Œåªæ˜¯ä¸å†æ¥å— master å‘é€çš„æ•°æ®ï¼Œå¯ä»¥ä½œ<strong>ä¸ºä»æœåŠ¡å™¨å‡çº§ä¸ºä¸»æœåŠ¡å™¨çš„æŒ‡ä»¤</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>slaveof no one	
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><p>æˆæƒè®¿é—®ï¼šmaster æœ‰æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œslave ä¹Ÿæœ‰æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼Œä¸ä»…æœåŠ¡ç«¯ä¹‹é—´å¯ä»¥å‘å‘½ä»¤ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥</p><ul><li><p>master å®¢æˆ·ç«¯å‘é€å‘½ä»¤è®¾ç½®å¯†ç ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>requirepass password
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>master é…ç½®æ–‡ä»¶è®¾ç½®å¯†ç ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>config <span class="token builtin class-name">set</span> requirepass password
config get requirepass
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>slave å®¢æˆ·ç«¯å‘é€å‘½ä»¤è®¾ç½®å¯†ç ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>auth password
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>slave é…ç½®æ–‡ä»¶è®¾ç½®å¯†ç ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>masterauth password
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>slave å¯åŠ¨æœåŠ¡å™¨è®¾ç½®å¯†ç ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-server â€“a password
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><hr><h3 id="å¤åˆ¶æµç¨‹" tabindex="-1"><a class="header-anchor" href="#å¤åˆ¶æµç¨‹" aria-hidden="true">#</a> å¤åˆ¶æµç¨‹</h3><h4 id="æ—§ç‰ˆå¤åˆ¶" tabindex="-1"><a class="header-anchor" href="#æ—§ç‰ˆå¤åˆ¶" aria-hidden="true">#</a> æ—§ç‰ˆå¤åˆ¶</h4><p>Redis çš„å¤åˆ¶åŠŸèƒ½åˆ†ä¸ºåŒæ­¥ï¼ˆsyncï¼‰å’Œå‘½ä»¤ä¼ æ’­ï¼ˆcommand propagateï¼‰ä¸¤ä¸ªæ“ä½œï¼Œä¸»ä»åº“é—´çš„å¤åˆ¶æ˜¯<strong>å¼‚æ­¥è¿›è¡Œçš„</strong></p><p>åŒæ­¥æ“ä½œç”¨äºå°†ä»æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€æ›´æ–°è‡³ä¸»æœåŠ¡å™¨å½“å‰æ‰€å¤„çš„æ•°æ®åº“çŠ¶æ€ï¼Œè¯¥è¿‡ç¨‹åˆå«å…¨é‡å¤åˆ¶ï¼š</p><ul><li>ä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€ SYNC å‘½ä»¤æ¥è¿›è¡ŒåŒæ­¥</li><li>æ”¶åˆ° SYNC çš„ä¸»æœåŠ¡å™¨æ‰§è¡Œ BGSAVE å‘½ä»¤ï¼Œåœ¨åå°ç”Ÿæˆä¸€ä¸ª RDB æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ª<strong>ç¼“å†²åŒº</strong>è®°å½•ä»ç°åœ¨å¼€å§‹æ‰§è¡Œçš„æ‰€æœ‰<strong>å†™å‘½ä»¤</strong></li><li>å½“ BGSAVE å‘½ä»¤æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œä¸»æœåŠ¡å™¨ä¼šå°† RDB æ–‡ä»¶å‘é€ç»™ä»æœåŠ¡å™¨</li><li>ä»æœåŠ¡æ¥æ”¶å¹¶è½½å…¥ RDB æ–‡ä»¶ï¼ˆä»æœåŠ¡å™¨ä¼š<strong>æ¸…ç©ºåŸæœ‰æ•°æ®</strong>ï¼‰</li><li>ç¼“å†²åŒºè®°å½•äº† RDB æ–‡ä»¶æ‰€åœ¨çŠ¶æ€åçš„æ‰€æœ‰å†™å‘½ä»¤ï¼Œä¸»æœåŠ¡å™¨å°†åœ¨ç¼“å†²åŒºçš„æ‰€æœ‰å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä»æœåŠ¡å™¨æ‰§è¡Œè¿™äº›å†™å‘½ä»¤</li><li>è‡³æ­¤ä»æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€å’Œä¸»æœåŠ¡å™¨ä¸€è‡´</li></ul><p>å‘½ä»¤ä¼ æ’­ç”¨äºåœ¨ä¸»æœåŠ¡å™¨çš„æ•°æ®åº“çŠ¶æ€è¢«ä¿®æ”¹ï¼Œå¯¼è‡´ä¸»ä»æ•°æ®åº“çŠ¶æ€å‡ºç°ä¸ä¸€è‡´æ—¶ï¼Œ è®©ä¸»ä»æœåŠ¡å™¨çš„æ•°æ®åº“é‡æ–°å›åˆ°ä¸€è‡´çŠ¶æ€</p><ul><li>ä¸»æœåŠ¡å™¨ä¼šå°†è‡ªå·±æ‰§è¡Œçš„å†™å‘½ä»¤ï¼Œä¹Ÿå³æ˜¯é€ æˆä¸»ä»æœåŠ¡å™¨ä¸ä¸€è‡´çš„é‚£æ¡å†™å‘½ä»¤ï¼Œå‘é€ç»™ä»æœåŠ¡å™¨</li><li>ä»æœåŠ¡å™¨æ¥å—å‘½ä»¤å¹¶æ‰§è¡Œï¼Œä¸»ä»æœåŠ¡å™¨å°†å†æ¬¡å›åˆ°ä¸€è‡´çŠ¶æ€</li></ul><hr><h4 id="åŠŸèƒ½ç¼ºé™·" tabindex="-1"><a class="header-anchor" href="#åŠŸèƒ½ç¼ºé™·" aria-hidden="true">#</a> åŠŸèƒ½ç¼ºé™·</h4><p>SYNC æœ¬èº«å°±æ˜¯ä¸€ä¸ªéå¸¸æ¶ˆè€—èµ„æºçš„æ“ä½œï¼Œæ¯æ¬¡æ‰§è¡Œ SYNC å‘½ä»¤ï¼Œéƒ½éœ€è¦æ‰§è¡Œä»¥ä¸‹åŠ¨ä½œï¼š</p><ul><li>ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œè€—è´¹ä¸»æœåŠ¡å™¨å¤§é‡ CPU ã€å†…å­˜å’Œç£ç›˜ I/O èµ„æº</li><li>RDB æ–‡ä»¶å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œè€—è´¹ä¸»ä»æœåŠ¡å™¨å¤§é‡çš„ç½‘ç»œèµ„æºï¼ˆå¸¦å®½å’Œæµé‡ï¼‰ï¼Œå¹¶å¯¹ä¸»æœåŠ¡å™¨å“åº”å‘½ä»¤è¯·æ±‚çš„æ—¶é—´äº§ç”Ÿå½±å“</li><li>ä»æœåŠ¡å™¨è½½å…¥ RDB æ–‡ä»¶ï¼ŒæœŸé—´ä¼šå› ä¸ºé˜»å¡è€Œæ²¡åŠæ³•å¤„ç†å‘½ä»¤è¯·æ±‚</li></ul><p>SYNC å‘½ä»¤ä¸‹çš„ä»æœåŠ¡å™¨å¯¹ä¸»æœåŠ¡å™¨çš„å¤åˆ¶åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p><ul><li>åˆæ¬¡å¤åˆ¶ï¼šä»æœåŠ¡å™¨æ²¡æœ‰å¤åˆ¶è¿‡ä»»ä½•ä¸»æœåŠ¡å™¨ï¼Œæˆ–è€…ä»æœåŠ¡å™¨å½“å‰è¦å¤åˆ¶çš„ä¸»æœåŠ¡å™¨å’Œä¸Šä¸€æ¬¡å¤åˆ¶çš„ä¸»æœåŠ¡å™¨ä¸åŒ</li><li>æ–­çº¿åé‡å¤åˆ¶ï¼šå¤„äºå‘½ä»¤ä¼ æ’­é˜¶æ®µçš„ä¸»ä»æœåŠ¡å™¨å› ä¸ºç½‘ç»œåŸå› è€Œä¸­æ–­äº†å¤åˆ¶ï¼Œè‡ªåŠ¨é‡è¿åå¹¶ç»§ç»­å¤åˆ¶ä¸»æœåŠ¡å™¨</li></ul><p>æ—§ç‰ˆå¤åˆ¶åœ¨æ–­çº¿åé‡å¤åˆ¶æ—¶ï¼Œä¹Ÿä¼šåˆ›å»º RDB æ–‡ä»¶è¿›è¡Œ<strong>å…¨é‡å¤åˆ¶</strong>ï¼Œä½†æ˜¯ä»æœåŠ¡å™¨åªéœ€è¦æ–­çº¿æ—¶é—´å†…çš„è¿™éƒ¨åˆ†æ•°æ®ï¼Œæ‰€ä»¥æ—§ç‰ˆå¤åˆ¶çš„å®ç°æ–¹å¼éå¸¸æµªè´¹èµ„æº</p><hr><h4 id="æ–°ç‰ˆå¤åˆ¶" tabindex="-1"><a class="header-anchor" href="#æ–°ç‰ˆå¤åˆ¶" aria-hidden="true">#</a> æ–°ç‰ˆå¤åˆ¶</h4><p>Redis ä» 2.8 ç‰ˆæœ¬å¼€å§‹ï¼Œä½¿ç”¨ PSYNC å‘½ä»¤ä»£æ›¿ SYNC å‘½ä»¤æ¥æ‰§è¡Œå¤åˆ¶æ—¶çš„<strong>åŒæ­¥æ“ä½œ</strong>ï¼ˆå‘½ä»¤ä¼ æ’­é˜¶æ®µç›¸åŒï¼‰ï¼Œè§£å†³äº†æ—§ç‰ˆå¤åˆ¶åœ¨å¤„ç†æ–­çº¿é‡å¤åˆ¶æƒ…å†µçš„ä½æ•ˆé—®é¢˜</p><p>PSYNC å‘½ä»¤å…·æœ‰å®Œæ•´é‡åŒæ­¥ï¼ˆfull resynchronizationï¼‰å’Œ<strong>éƒ¨åˆ†é‡åŒæ­¥</strong>ï¼ˆpartial resynchronizationï¼‰ä¸¤ç§æ¨¡å¼ï¼š</p><ul><li>å®Œæ•´é‡åŒæ­¥ï¼šå¤„ç†åˆæ¬¡å¤åˆ¶æƒ…å†µï¼Œæ‰§è¡Œæ­¥éª¤å’Œ SYNCå‘½ä»¤åŸºæœ¬ä¸€æ ·</li><li>éƒ¨åˆ†é‡åŒæ­¥ï¼šå¤„ç†æ–­çº¿åé‡å¤åˆ¶æƒ…å†µï¼Œä¸»æœåŠ¡å™¨å¯ä»¥å°†ä¸»ä»è¿æ¥æ–­å¼€æœŸé—´æ‰§è¡Œçš„å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä»æœåŠ¡å™¨åªè¦æ¥æ”¶å¹¶æ‰§è¡Œè¿™äº›å†™å‘½ä»¤ï¼Œå°±å¯ä»¥å°†æ•°æ®åº“æ›´æ–°è‡³ä¸»æœåŠ¡å™¨å½“å‰æ‰€å¤„çš„çŠ¶æ€ï¼Œè¯¥è¿‡ç¨‹åˆå«<strong>éƒ¨åˆ†å¤åˆ¶</strong></li></ul><hr><h3 id="éƒ¨åˆ†åŒæ­¥" tabindex="-1"><a class="header-anchor" href="#éƒ¨åˆ†åŒæ­¥" aria-hidden="true">#</a> éƒ¨åˆ†åŒæ­¥</h3><p>éƒ¨åˆ†é‡åŒæ­¥åŠŸèƒ½ç”±ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†æ„æˆï¼š</p><ul><li>ä¸»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡ï¼ˆreplication offsetï¼‰å’Œä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡</li><li>ä¸»æœåŠ¡å™¨çš„å¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼ˆreplication backlogï¼‰</li><li>æœåŠ¡å™¨çš„è¿è¡Œ ID (run ID)</li></ul><h4 id="åç§»é‡" tabindex="-1"><a class="header-anchor" href="#åç§»é‡" aria-hidden="true">#</a> åç§»é‡</h4><p>ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨ä¼šåˆ†åˆ«ç»´æŠ¤ä¸€ä¸ªå¤åˆ¶åç§»é‡ï¼š</p><ul><li><p>ä¸»æœåŠ¡å™¨æ¯æ¬¡å‘ä»æœåŠ¡å™¨ä¼ æ’­ N ä¸ªå­—èŠ‚çš„æ•°æ®æ—¶ï¼Œå°±å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡çš„å€¼åŠ ä¸Š N</p></li><li><p>ä»æœåŠ¡å™¨æ¯æ¬¡æ”¶åˆ°ä¸»æœåŠ¡å™¨ä¼ æ’­æ¥çš„ N ä¸ªå­—èŠ‚çš„æ•°æ®æ—¶ï¼Œå°±å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡çš„å€¼åŠ ä¸Š N</p></li></ul><p>é€šè¿‡å¯¹æ¯”ä¸»ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡ï¼Œå¯ä»¥åˆ¤æ–­ä¸»ä»æœåŠ¡å™¨æ˜¯å¦å¤„äºä¸€è‡´çŠ¶æ€</p><ul><li>ä¸»ä»æœåŠ¡å™¨çš„åç§»é‡æ˜¯ç›¸åŒçš„ï¼Œè¯´æ˜ä¸»ä»æœåŠ¡å™¨å¤„äºä¸€è‡´çŠ¶æ€</li><li>ä¸»ä»æœåŠ¡å™¨çš„åç§»é‡æ˜¯ä¸åŒçš„ï¼Œè¯´æ˜ä¸»ä»æœåŠ¡å™¨å¤„äºä¸ä¸€è‡´çŠ¶æ€</li></ul><hr><h4 id="ç¼“å†²åŒº-1" tabindex="-1"><a class="header-anchor" href="#ç¼“å†²åŒº-1" aria-hidden="true">#</a> ç¼“å†²åŒº</h4><p>å¤åˆ¶ç§¯å‹ç¼“å†²åŒºæ˜¯ç”±ä¸»æœåŠ¡å™¨ç»´æŠ¤çš„ä¸€ä¸ªå›ºå®šé•¿åº¦ï¼ˆfixed-sizeï¼‰å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰é˜Ÿåˆ—ï¼Œé»˜è®¤å¤§å°ä¸º 1MB</p><ul><li>å‡ºé˜Ÿè§„åˆ™è·Ÿæ™®é€šçš„å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—ä¸€æ ·</li><li>å…¥é˜Ÿè§„åˆ™æ˜¯å½“å…¥é˜Ÿå…ƒç´ çš„æ•°é‡å¤§äºé˜Ÿåˆ—é•¿åº¦æ—¶ï¼Œæœ€å…ˆå…¥é˜Ÿçš„å…ƒç´ ä¼šè¢«å¼¹å‡ºï¼Œç„¶åæ–°å…ƒç´ æ‰ä¼šè¢«æ”¾å…¥é˜Ÿåˆ—</li></ul><p>å½“ä¸»æœåŠ¡å™¨è¿›è¡Œ<strong>å‘½ä»¤ä¼ æ’­æ—¶ï¼Œä¸ä»…ä¼šå°†å†™å‘½ä»¤å‘é€ç»™æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œè¿˜ä¼šå°†å†™å‘½ä»¤å…¥é˜Ÿåˆ°å¤åˆ¶ç§¯å‹ç¼“å†²åŒº</strong>ï¼Œç¼“å†²åŒºä¼šä¿å­˜ç€ä¸€éƒ¨åˆ†æœ€è¿‘ä¼ æ’­çš„å†™å‘½ä»¤ï¼Œå¹¶ä¸”ç¼“å†²åŒºä¼šä¸ºé˜Ÿåˆ—ä¸­çš„æ¯ä¸ªå­—èŠ‚è®°å½•ç›¸åº”çš„å¤åˆ¶åç§»é‡</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å¤åˆ¶ç§¯å‹ç¼“å†²åŒº.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>ä»æœåŠ¡å™¨ä¼šé€šè¿‡ PSYNC å‘½ä»¤å°†è‡ªå·±çš„å¤åˆ¶åç§»é‡ offset å‘é€ç»™ä¸»æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨ä¼šæ ¹æ®è¿™ä¸ªå¤åˆ¶åç§»é‡æ¥å†³å®šå¯¹ä»æœåŠ¡å™¨æ‰§è¡Œä½•ç§åŒæ­¥æ“ä½œï¼š</p><ul><li>offset ä¹‹åçš„æ•°æ®ï¼ˆå³ offset+1ï¼‰ä»ç„¶å­˜åœ¨äºå¤åˆ¶ç§¯å‹ç¼“å†²åŒºé‡Œï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨å°†å¯¹ä»æœåŠ¡å™¨æ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥æ“ä½œ</li><li>offset ä¹‹åçš„æ•°æ®å·²ç»ä¸åœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºï¼Œè¯´æ˜éƒ¨åˆ†æ•°æ®å·²ç»ä¸¢å¤±ï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨å°†å¯¹ä»æœåŠ¡å™¨æ‰§è¡Œå®Œæ•´é‡åŒæ­¥æ“ä½œ</li></ul><p>å¤åˆ¶ç¼“å†²åŒºå¤§å°è®¾å®šä¸åˆç†ï¼Œä¼šå¯¼è‡´<strong>æ•°æ®æº¢å‡º</strong>ã€‚æ¯”å¦‚ä¸»æœåŠ¡å™¨éœ€è¦æ‰§è¡Œå¤§é‡å†™å‘½ä»¤ï¼Œåˆæˆ–è€…ä¸»ä»æœåŠ¡å™¨æ–­çº¿åé‡è¿æ¥æ‰€éœ€çš„æ—¶é—´è¾ƒé•¿ï¼Œå¯¼è‡´ç¼“å†²åŒºä¸­çš„æ•°æ®å·²ç»ä¸¢å¤±ï¼Œåˆ™å¿…é¡»è¿›è¡Œå®Œæ•´é‡åŒæ­¥</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>repl-backlog-size ?mb
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å»ºè®®è®¾ç½®å¦‚ä¸‹ï¼Œè¿™æ ·å¯ä»¥ä¿è¯ç»å¤§éƒ¨åˆ†æ–­çº¿æƒ…å†µéƒ½èƒ½ç”¨éƒ¨åˆ†é‡åŒæ­¥æ¥å¤„ç†ï¼š</p><ul><li>ä»æœåŠ¡å™¨æ–­çº¿åé‡æ–°è¿æ¥ä¸Šä¸»æœåŠ¡å™¨æ‰€éœ€çš„å¹³å‡æ—¶é—´ second</li><li>è·å– master å¹³å‡æ¯ç§’äº§ç”Ÿå†™å‘½ä»¤æ•°æ®æ€»é‡ write_size_per_second</li><li>æœ€ä¼˜å¤åˆ¶ç¼“å†²åŒºç©ºé—´ = 2 * second * write_size_per_second</li></ul><hr><h4 id="è¿è¡Œid" tabindex="-1"><a class="header-anchor" href="#è¿è¡Œid" aria-hidden="true">#</a> è¿è¡ŒID</h4><p>æœåŠ¡å™¨è¿è¡Œ IDï¼ˆrun IDï¼‰ï¼šæ˜¯æ¯ä¸€å°æœåŠ¡å™¨æ¯æ¬¡è¿è¡Œçš„èº«ä»½è¯†åˆ«ç ï¼Œåœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶è‡ªåŠ¨ç”Ÿæˆï¼Œç”± 40 ä½éšæœºçš„åå…­è¿›åˆ¶å­—ç¬¦ç»„æˆï¼Œä¸€å°æœåŠ¡å™¨å¤šæ¬¡è¿è¡Œå¯ä»¥ç”Ÿæˆå¤šä¸ªè¿è¡Œ ID</p><p>ä½œç”¨ï¼šæœåŠ¡å™¨é—´è¿›è¡Œä¼ è¾“è¯†åˆ«èº«ä»½ï¼Œå¦‚æœæƒ³ä¸¤æ¬¡æ“ä½œå‡å¯¹åŒä¸€å°æœåŠ¡å™¨è¿›è¡Œï¼Œ<strong>æ¯æ¬¡å¿…é¡»æ“ä½œæºå¸¦å¯¹åº”çš„è¿è¡Œ ID</strong>ï¼Œç”¨äºå¯¹æ–¹è¯†åˆ«</p><p>ä»æœåŠ¡å™¨å¯¹ä¸»æœåŠ¡å™¨è¿›è¡Œåˆæ¬¡å¤åˆ¶æ—¶ï¼Œä¸»æœåŠ¡å™¨å°†è‡ªå·±çš„è¿è¡Œ ID ä¼ é€ç»™ä»æœåŠ¡å™¨ï¼Œç„¶åä»æœåŠ¡å™¨ä¼šå°†è¯¥è¿è¡Œ ID ä¿å­˜ã€‚å½“ä»æœåŠ¡å™¨æ–­çº¿å¹¶é‡æ–°è¿ä¸Šä¸€ä¸ªä¸»æœåŠ¡å™¨æ—¶ï¼Œä¼šå‘å½“å‰è¿æ¥çš„ä¸»æœåŠ¡å™¨å‘é€ä¹‹å‰ä¿å­˜çš„è¿è¡Œ IDï¼š</p><ul><li>å¦‚æœè¿è¡Œ ID å’Œå½“å‰è¿æ¥çš„ä¸»æœåŠ¡å™¨çš„è¿è¡Œ ID ç›¸åŒï¼Œè¯´æ˜ä»æœåŠ¡å™¨æ–­çº¿ä¹‹å‰å¤åˆ¶çš„å°±æ˜¯å½“å‰è¿æ¥çš„è¿™ä¸ªä¸»æœåŠ¡å™¨ï¼Œæ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥</li><li>å¦‚æœä¸åŒï¼Œéœ€è¦æ‰§è¡Œå®Œæ•´é‡åŒæ­¥æ“ä½œ</li></ul><hr><h4 id="psync" tabindex="-1"><a class="header-anchor" href="#psync" aria-hidden="true">#</a> PSYNC</h4><p>PSYNC å‘½ä»¤çš„è°ƒç”¨æ–¹æ³•æœ‰ä¸¤ç§</p><ul><li>å¦‚æœä»æœåŠ¡å™¨ä¹‹å‰æ²¡æœ‰å¤åˆ¶è¿‡ä»»ä½•ä¸»æœåŠ¡å™¨ï¼Œæˆ–è€…æ‰§è¡Œäº† <code>SLAVEOF no one</code>ï¼Œå¼€å§‹ä¸€æ¬¡æ–°çš„å¤åˆ¶æ—¶å°†å‘ä¸»æœåŠ¡å™¨å‘é€ <code>PSYNC ? -1</code> å‘½ä»¤ï¼Œä¸»åŠ¨è¯·æ±‚ä¸»æœåŠ¡å™¨è¿›è¡Œå®Œæ•´é‡åŒæ­¥</li><li>å¦‚æœä»æœåŠ¡å™¨å·²ç»å¤åˆ¶è¿‡æŸä¸ªä¸»æœåŠ¡å™¨ï¼Œé‚£ä¹ˆä»æœåŠ¡å™¨åœ¨å¼€å§‹ä¸€æ¬¡æ–°çš„å¤åˆ¶æ—¶å°†å‘ä¸»æœåŠ¡å™¨å‘é€ <code>PSYNC &lt;runid&gt; &lt;offset&gt;</code> å‘½ä»¤ï¼Œrunid æ˜¯ä¸Šä¸€æ¬¡å¤åˆ¶çš„ä¸»æœåŠ¡å™¨çš„è¿è¡Œ IDï¼Œoffset æ˜¯å¤åˆ¶çš„åç§»é‡</li></ul><p>æ¥æ”¶åˆ° PSYNC å‘½ä»¤çš„ä¸»æœåŠ¡å™¨ä¼šå‘ä»æœåŠ¡å™¨è¿”å›ä»¥ä¸‹ä¸‰ç§å›å¤çš„å…¶ä¸­ä¸€ç§ï¼š</p><ul><li>æ‰§è¡Œå®Œæ•´é‡åŒæ­¥æ“ä½œï¼šè¿”å› <code>+FULLRESYNC &lt;runid&gt; &lt;offset&gt;</code>ï¼Œrunid æ˜¯ä¸»æœåŠ¡å™¨çš„è¿è¡Œ IDï¼Œoffset æ˜¯ä¸»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡</li><li>æ‰§è¡Œéƒ¨åˆ†é‡åŒæ­¥æ“ä½œï¼šè¿”å› <code>+CONTINUE</code>ï¼Œä»æœåŠ¡å™¨æ”¶åˆ°è¯¥å›å¤è¯´æ˜åªéœ€è¦ç­‰å¾…ä¸»æœåŠ¡å™¨å‘é€ç¼ºå¤±çš„éƒ¨åˆ†æ•°æ®å³å¯</li><li>ä¸»æœåŠ¡å™¨çš„ç‰ˆæœ¬ä½äº Redis2.8ï¼šè¿”å› <code>-ERR</code>ï¼Œç‰ˆæœ¬è¿‡ä½è¯†åˆ«ä¸äº† PSYNCï¼Œä»æœåŠ¡å™¨å°†å‘ä¸»æœåŠ¡å™¨å‘é€ SYNC å‘½ä»¤</li></ul><hr><h3 id="å¤åˆ¶å®ç°" tabindex="-1"><a class="header-anchor" href="#å¤åˆ¶å®ç°" aria-hidden="true">#</a> å¤åˆ¶å®ç°</h3><h4 id="å®ç°æµç¨‹" tabindex="-1"><a class="header-anchor" href="#å®ç°æµç¨‹" aria-hidden="true">#</a> å®ç°æµç¨‹</h4><p>é€šè¿‡å‘ä»æœåŠ¡å™¨å‘é€ SLAVEOF å‘½ä»¤ï¼Œå¯ä»¥è®©ä»æœåŠ¡å™¨å»å¤åˆ¶ä¸€ä¸ªä¸»æœåŠ¡å™¨</p><ul><li><p>è®¾ç½®ä¸»æœåŠ¡å™¨çš„åœ°å€å’Œç«¯å£ï¼šå°† SLAVEOF å‘½ä»¤æŒ‡å®šçš„ ip å’Œ port ä¿å­˜åˆ°æœåŠ¡å™¨çŠ¶æ€ redisServer</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
	<span class="token comment">// ä¸»æœåŠ¡å™¨çš„åœ°å€ </span>
    <span class="token keyword">char</span> <span class="token operator">*</span>masterhost<span class="token punctuation">;</span> 
	 <span class="token comment">//ä¸»æœåŠ¡å™¨çš„ç«¯å£ </span>
    <span class="token keyword">int</span> masterport<span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>SLAVEOF å‘½ä»¤æ˜¯ä¸€ä¸ª<strong>å¼‚æ­¥å‘½ä»¤</strong>ï¼Œåœ¨å®Œæˆå±æ€§çš„è®¾ç½®åæœåŠ¡å™¨ç›´æ¥è¿”å› OKï¼Œè€Œå®é™…çš„å¤åˆ¶å·¥ä½œå°†åœ¨ OK è¿”å›ä¹‹åæ‰çœŸæ­£å¼€å§‹æ‰§è¡Œ</p></li><li><p>å»ºç«‹å¥—æ¥å­—è¿æ¥ï¼š</p><ul><li>ä»æœåŠ¡å™¨ connect ä¸»æœåŠ¡å™¨å»ºç«‹å¥—æ¥å­—è¿æ¥ï¼ŒæˆåŠŸåä»æœåŠ¡å™¨å°†ä¸ºè¿™ä¸ªå¥—æ¥å­—å…³è”ä¸€ä¸ªç”¨äºå¤åˆ¶å·¥ä½œçš„æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨ï¼Œè´Ÿè´£æ‰§è¡Œåç»­çš„å¤åˆ¶å·¥ä½œï¼Œå¦‚æ¥æ”¶ RDB æ–‡ä»¶ã€æ¥æ”¶ä¸»æœåŠ¡å™¨ä¼ æ’­æ¥çš„å†™å‘½ä»¤ç­‰</li><li>ä¸»æœåŠ¡å™¨åœ¨æ¥å— accept ä»åŠ¡å™¨çš„å¥—æ¥å­—è¿æ¥åï¼Œå°†ä¸ºè¯¥å¥—æ¥å­—åˆ›å»ºç›¸åº”çš„å®¢æˆ·ç«¯çŠ¶æ€ï¼Œå°†ä»æœåŠ¡å™¨çœ‹ä½œä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œä»æœåŠ¡å™¨å°†åŒæ—¶å…·æœ‰ server å’Œ clientï¼ˆå¯ä»¥å‘å‘½ä»¤ï¼‰ä¸¤ä¸ªèº«ä»½</li></ul></li><li><p>å‘é€ PING å‘½ä»¤ï¼šä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€ä¸€ä¸ª PING å‘½ä»¤ï¼Œæ£€æŸ¥ä¸»ä»ä¹‹é—´çš„é€šä¿¡æ˜¯å¦æ­£å¸¸ã€ä¸»æœåŠ¡å™¨å¤„ç†å‘½ä»¤çš„èƒ½åŠ›æ˜¯å¦æ­£å¸¸</p><ul><li>è¿”å›é”™è¯¯ï¼Œè¡¨ç¤ºä¸»æœåŠ¡å™¨æ— æ³•å¤„ç†ä»æœåŠ¡å™¨çš„å‘½ä»¤è¯·æ±‚ï¼ˆå¿™ç¢Œï¼‰ï¼Œä»æœåŠ¡å™¨æ–­å¼€å¹¶é‡æ–°åˆ›å»ºè¿å‘ä¸»æœåŠ¡å™¨çš„å¥—æ¥å­—</li><li>è¿”å›å‘½ä»¤å›å¤ï¼Œä½†ä»æœåŠ¡å™¨ä¸èƒ½åœ¨è§„å®šçš„æ—¶é—´å†…è¯»å–å‡ºå‘½ä»¤å›å¤çš„å†…å®¹ï¼Œè¡¨ç¤ºä¸»ä»ä¹‹é—´çš„ç½‘ç»œçŠ¶æ€ä¸ä½³ï¼Œéœ€è¦æ–­å¼€é‡è¿</li><li>è¯»å–åˆ° PONGï¼Œè¡¨ç¤ºä¸€åˆ‡çŠ¶æ€æ­£å¸¸ï¼Œå¯ä»¥æ‰§è¡Œå¤åˆ¶</li></ul></li><li><p>èº«ä»½éªŒè¯ï¼šå¦‚æœä»æœåŠ¡å™¨è®¾ç½®äº† masterauth é€‰é¡¹å°±è¿›è¡Œèº«ä»½éªŒè¯ï¼Œå°†å‘ä¸»æœåŠ¡å™¨å‘é€ä¸€æ¡ AUTH å‘½ä»¤ï¼Œå‘½ä»¤å‚æ•°ä¸ºä»æœåŠ¡å™¨ masterauth é€‰é¡¹çš„å€¼ï¼Œå¦‚æœä¸»ä»è®¾ç½®çš„å¯†ç ä¸ç›¸åŒï¼Œé‚£ä¹ˆä¸»å°†è¿”å›ä¸€ä¸ª invalid password é”™è¯¯</p></li><li><p>å‘é€ç«¯å£ä¿¡æ¯ï¼šèº«ä»½éªŒè¯å</p><ul><li>ä»æœåŠ¡å™¨æ‰§è¡Œå‘½ä»¤ <code>REPLCONF listening-port &lt;portÂ­number&gt;</code>ï¼Œ å‘ä¸»æœåŠ¡å™¨å‘é€ä»æœåŠ¡å™¨çš„ç›‘å¬ç«¯å£å·</li><li>ä¸»æœåŠ¡å™¨åœ¨æ¥æ”¶åˆ°è¿™ä¸ªå‘½ä»¤åï¼Œä¼šå°†ç«¯å£å·è®°å½•åœ¨å¯¹åº”çš„å®¢æˆ·ç«¯çŠ¶æ€ redisClient.slave_listening_port å±æ€§ä¸­ï¼š</li></ul></li><li><p>åŒæ­¥ï¼šä»æœåŠ¡å™¨å°†å‘ä¸»æœåŠ¡å™¨å‘é€ PSYNC å‘½ä»¤ï¼Œåœ¨åŒæ­¥æ“ä½œæ‰§è¡Œä¹‹åï¼Œ<strong>ä¸»ä»æœåŠ¡å™¨åŒæ–¹éƒ½æ˜¯å¯¹æ–¹çš„å®¢æˆ·ç«¯</strong>ï¼Œå¯ä»¥ç›¸äº’å‘é€å‘½ä»¤</p><ul><li><p>å®Œæ•´é‡åŒæ­¥ï¼šä¸»æœåŠ¡å™¨éœ€è¦æˆä¸ºä»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯ï¼Œæ‰èƒ½å°†ä¿å­˜åœ¨ç¼“å†²åŒºé‡Œé¢çš„å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨æ‰§è¡Œ</p></li><li><p>éƒ¨åˆ†é‡åŒæ­¥ï¼šä¸»æœåŠ¡å™¨éœ€è¦æˆä¸ºä»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯ï¼Œæ‰èƒ½å‘ä»æœåŠ¡å™¨å‘é€ä¿å­˜åœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºé‡Œé¢çš„å†™å‘½ä»¤</p></li></ul></li><li><p>å‘½ä»¤ä¼ æ’­ï¼šä¸»æœåŠ¡å™¨å°†å†™å‘½ä»¤å‘é€ç»™ä»æœåŠ¡å™¨ï¼Œä¿æŒæ•°æ®åº“çš„çŠ¶æ€ä¸€è‡´</p></li></ul><hr><h4 id="å¤åˆ¶å›¾ç¤º" tabindex="-1"><a class="header-anchor" href="#å¤åˆ¶å›¾ç¤º" aria-hidden="true">#</a> å¤åˆ¶å›¾ç¤º</h4><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-ä¸»ä»å¤åˆ¶æµç¨‹æ›´æ–°.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h3 id="å¿ƒè·³æ£€æµ‹" tabindex="-1"><a class="header-anchor" href="#å¿ƒè·³æ£€æµ‹" aria-hidden="true">#</a> å¿ƒè·³æ£€æµ‹</h3><h4 id="å¿ƒè·³æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#å¿ƒè·³æœºåˆ¶" aria-hidden="true">#</a> å¿ƒè·³æœºåˆ¶</h4><p>å¿ƒè·³æœºåˆ¶ï¼šè¿›å…¥å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼Œ<strong>ä»æœåŠ¡å™¨</strong>é»˜è®¤ä¼šä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡ï¼Œ<strong>å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤</strong>ï¼š<code>REPLCONF ACK &lt;replication_offset&gt;</code>ï¼Œreplication_offset æ˜¯ä»æœåŠ¡å™¨å½“å‰çš„å¤åˆ¶åç§»é‡</p><p>å¿ƒè·³çš„ä½œç”¨ï¼š</p><ul><li>æ£€æµ‹ä¸»ä»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥çŠ¶æ€</li><li>è¾…åŠ©å®ç° min-slaves é€‰é¡¹</li><li>æ£€æµ‹å‘½ä»¤ä¸¢å¤±</li></ul><hr><h4 id="ç½‘ç»œçŠ¶æ€" tabindex="-1"><a class="header-anchor" href="#ç½‘ç»œçŠ¶æ€" aria-hidden="true">#</a> ç½‘ç»œçŠ¶æ€</h4><p>å¦‚æœä¸»æœåŠ¡å™¨è¶…è¿‡ä¸€ç§’é’Ÿæ²¡æœ‰æ”¶åˆ°ä»æœåŠ¡å™¨å‘æ¥çš„ REPLCONF ACK å‘½ä»¤ï¼Œä¸»æœåŠ¡å°±è®¤ä¸ºä¸»ä»æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥å‡ºç°é—®é¢˜</p><p>å‘ä¸»æœåŠ¡å™¨å‘é€ <code>INFO replication</code> å‘½ä»¤ï¼Œlag ä¸€æ è¡¨ç¤ºä»æœåŠ¡å™¨æœ€åä¸€æ¬¡å‘ä¸»æœåŠ¡å™¨å‘é€ ACK å‘½ä»¤è·ç¦»ç°åœ¨å¤šå°‘ç§’ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> INFO replication 
<span class="token comment"># Replication </span>
role:master 
connected_slaves:2 
slave0: <span class="token assign-left variable">ip</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1,port<span class="token operator">=</span><span class="token number">11111</span>,state<span class="token operator">=</span>online,offset<span class="token operator">=</span><span class="token number">123</span>,lag<span class="token operator">=</span><span class="token number">0</span> <span class="token comment"># åˆšåˆšå‘é€è¿‡ REPLCONF ACK </span>
slavel: <span class="token assign-left variable">ip</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1,port<span class="token operator">=</span><span class="token number">22222</span>,state<span class="token operator">=</span>online,offset<span class="token operator">=</span><span class="token number">456</span>,lag<span class="token operator">=</span><span class="token number">3</span> <span class="token comment"># 3ç§’ä¹‹å‰å‘é€è¿‡REPLCONF ACK </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œlag çš„å€¼åº”è¯¥åœ¨ 0 æˆ–è€… 1 ç§’ä¹‹é—´è·³åŠ¨ï¼Œå¦‚æœè¶…è¿‡ 1 ç§’è¯´æ˜ä¸»ä»æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥å‡ºç°äº†æ•…éšœ</p><hr><h4 id="é…ç½®é€‰é¡¹" tabindex="-1"><a class="header-anchor" href="#é…ç½®é€‰é¡¹" aria-hidden="true">#</a> é…ç½®é€‰é¡¹</h4><p>Redis çš„ min-slaves-to-write å’Œ min-slaves-max-lag ä¸¤ä¸ªé€‰é¡¹å¯ä»¥é˜²æ­¢ä¸»æœåŠ¡å™¨åœ¨<strong>ä¸å®‰å…¨çš„æƒ…å†µä¸‹</strong>æ‹’ç»æ‰§è¡Œå†™å‘½ä»¤</p><p>æ¯”å¦‚å‘ä¸»æœåŠ¡å™¨è®¾ç½®ï¼š</p><ul><li>min-slaves-to-writeï¼šä¸»åº“æœ€å°‘æœ‰ N ä¸ªå¥åº·çš„ä»åº“å­˜æ´»æ‰èƒ½æ‰§è¡Œå†™å‘½ä»¤ï¼Œæ²¡æœ‰è¶³å¤Ÿçš„ä»åº“ç›´æ¥æ‹’ç»å†™å…¥</li><li>min-slaves-max-lagï¼šä»åº“å’Œä¸»åº“è¿›è¡Œæ•°æ®å¤åˆ¶æ—¶çš„ ACK æ¶ˆæ¯å»¶è¿Ÿçš„æœ€å¤§æ—¶é—´</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>min-slaves-to-write <span class="token number">5</span>
min-slaves-max-lag <span class="token number">10</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>é‚£ä¹ˆåœ¨ä»æœåŠ¡å™¨çš„æ•°å°‘äº 5 ä¸ªï¼Œæˆ–è€… 5 ä¸ªä»æœåŠ¡å™¨çš„å»¶è¿Ÿï¼ˆlagï¼‰å€¼éƒ½å¤§äºæˆ–ç­‰äº10 ç§’æ—¶ï¼Œä¸»æœåŠ¡å™¨å°†æ‹’ç»æ‰§è¡Œå†™å‘½ä»¤</p><hr><h4 id="å‘½ä»¤ä¸¢å¤±" tabindex="-1"><a class="header-anchor" href="#å‘½ä»¤ä¸¢å¤±" aria-hidden="true">#</a> å‘½ä»¤ä¸¢å¤±</h4><p>æ£€æµ‹å‘½ä»¤ä¸¢å¤±ï¼šç”±äºç½‘ç»œæˆ–è€…å…¶ä»–åŸå› ï¼Œä¸»æœåŠ¡å™¨ä¼ æ’­ç»™ä»æœåŠ¡å™¨çš„å†™å‘½ä»¤ä¸¢å¤±ï¼Œé‚£ä¹ˆå½“ä»æœåŠ¡å™¨å‘ä¸»æœåŠ¡å™¨å‘é€ REPLCONF ACK å‘½ä»¤æ—¶ï¼Œä¸»æœåŠ¡å™¨ä¼šæ£€æŸ¥ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»é‡æ˜¯å¦å°äºè‡ªå·±çš„ï¼Œç„¶ååœ¨å¤åˆ¶ç§¯å‹ç¼“å†²åŒºé‡Œæ‰¾åˆ°ä»æœåŠ¡å™¨ç¼ºå°‘çš„æ•°æ®ï¼Œå¹¶å°†è¿™äº›æ•°æ®é‡æ–°å‘é€ç»™ä»æœåŠ¡å™¨</p><p>è¯´æ˜ï¼šREPLCONF ACK å‘½ä»¤å’Œå¤åˆ¶ç§¯å‹ç¼“å†²åŒºéƒ½æ˜¯ Redis 2.8 ç‰ˆæœ¬æ–°å¢çš„ï¼Œåœ¨ Redis 2.8 ç‰ˆæœ¬ä»¥å‰ï¼Œå³ä½¿å‘½ä»¤åœ¨ä¼ æ’­è¿‡ç¨‹ä¸­ä¸¢å¤±ï¼Œä¸»ä»æœåŠ¡å™¨éƒ½ä¸ä¼šæ³¨æ„åˆ°ï¼Œä¹Ÿä¸ä¼šå‘ä»æœåŠ¡å™¨è¡¥å‘ä¸¢å¤±çš„æ•°æ®ï¼Œæ‰€ä»¥ä¸ºäº†ä¿è¯<strong>ä¸»ä»å¤åˆ¶çš„æ•°æ®ä¸€è‡´æ€§</strong>ï¼Œæœ€å¥½ä½¿ç”¨ 2.8 æˆ–ä»¥ä¸Šç‰ˆæœ¬çš„ Redis</p><hr><h3 id="å¸¸è§é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#å¸¸è§é—®é¢˜" aria-hidden="true">#</a> å¸¸è§é—®é¢˜</h3><h4 id="é‡å¯æ¢å¤" tabindex="-1"><a class="header-anchor" href="#é‡å¯æ¢å¤" aria-hidden="true">#</a> é‡å¯æ¢å¤</h4><p>ç³»ç»Ÿä¸æ–­è¿è¡Œï¼Œmaster çš„æ•°æ®é‡ä¼šè¶Šæ¥è¶Šå¤§ï¼Œä¸€æ—¦ <strong>master é‡å¯</strong>ï¼Œrunid å°†å‘ç”Ÿå˜åŒ–ï¼Œä¼šå¯¼è‡´å…¨éƒ¨ slave çš„å…¨é‡å¤åˆ¶æ“ä½œ</p><p>è§£å†³æ–¹æ³•ï¼šæœ¬æœºä¿å­˜ä¸Šæ¬¡ runidï¼Œé‡å¯åæ¢å¤è¯¥å€¼ï¼Œä½¿æ‰€æœ‰ slave è®¤ä¸ºè¿˜æ˜¯ä¹‹å‰çš„ master</p><p>ä¼˜åŒ–æ–¹æ¡ˆï¼š</p><ul><li><p>master å†…éƒ¨åˆ›å»º master_replid å˜é‡ï¼Œä½¿ç”¨ runid ç›¸åŒçš„ç­–ç•¥ç”Ÿæˆï¼Œå¹¶å‘é€ç»™æ‰€æœ‰ slave</p></li><li><p>åœ¨ master å…³é—­æ—¶æ‰§è¡Œå‘½ä»¤ <code>shutdown save</code>ï¼Œè¿›è¡Œ RDB æŒä¹…åŒ–ï¼Œå°† runid ä¸ offset ä¿å­˜åˆ° RDB æ–‡ä»¶ä¸­</p><p><code>redis-check-rdb dump.rdb</code> å‘½ä»¤å¯ä»¥æŸ¥çœ‹è¯¥ä¿¡æ¯ï¼Œä¿å­˜ä¸º repl-id å’Œ repl-offset</p></li><li><p>master é‡å¯ååŠ è½½ RDB æ–‡ä»¶ï¼Œæ¢å¤æ•°æ®ï¼Œå°† RDB æ–‡ä»¶ä¸­ä¿å­˜çš„ repl-id ä¸ repl-offset åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œmaster_repl_id = repl-idï¼Œmaster_repl_offset = repl-offset</p></li><li><p>é€šè¿‡ info å‘½ä»¤å¯ä»¥æŸ¥çœ‹è¯¥ä¿¡æ¯</p></li></ul><hr><h4 id="ç½‘ç»œä¸­æ–­" tabindex="-1"><a class="header-anchor" href="#ç½‘ç»œä¸­æ–­" aria-hidden="true">#</a> ç½‘ç»œä¸­æ–­</h4><p>master çš„ CPU å ç”¨è¿‡é«˜æˆ– slave é¢‘ç¹æ–­å¼€è¿æ¥</p><ul><li><p>å‡ºç°çš„åŸå› ï¼š</p><ul><li>slave æ¯ 1 ç§’å‘é€ REPLCONF ACK å‘½ä»¤åˆ° master</li><li>å½“ slave æ¥åˆ°äº†æ…¢æŸ¥è¯¢æ—¶ï¼ˆkeys * ï¼Œhgetall ç­‰ï¼‰ï¼Œä¼šå¤§é‡å ç”¨ CPU æ€§èƒ½</li><li>master æ¯ 1 ç§’è°ƒç”¨å¤åˆ¶å®šæ—¶å‡½æ•° replicationCron()ï¼Œæ¯”å¯¹ slave å‘ç°é•¿æ—¶é—´æ²¡æœ‰è¿›è¡Œå“åº”</li></ul><p>æœ€ç»ˆå¯¼è‡´ master å„ç§èµ„æºï¼ˆè¾“å‡ºç¼“å†²åŒºã€å¸¦å®½ã€è¿æ¥ç­‰ï¼‰è¢«ä¸¥é‡å ç”¨</p></li><li><p>è§£å†³æ–¹æ³•ï¼šé€šè¿‡è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼Œç¡®è®¤æ˜¯å¦é‡Šæ”¾ slave</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>repl-timeout	<span class="token comment"># è¯¥å‚æ•°å®šä¹‰äº†è¶…æ—¶æ—¶é—´çš„é˜ˆå€¼ï¼ˆé»˜è®¤60ç§’ï¼‰ï¼Œè¶…è¿‡è¯¥å€¼ï¼Œé‡Šæ”¾slave</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><p>slave ä¸ master è¿æ¥æ–­å¼€</p><ul><li><p>å‡ºç°çš„åŸå› ï¼š</p><ul><li>master å‘é€ ping æŒ‡ä»¤é¢‘åº¦è¾ƒä½</li><li>master è®¾å®šè¶…æ—¶æ—¶é—´è¾ƒçŸ­</li><li>ping æŒ‡ä»¤åœ¨ç½‘ç»œä¸­å­˜åœ¨ä¸¢åŒ…</li></ul></li><li><p>è§£å†³æ–¹æ³•ï¼šæé«˜ ping æŒ‡ä»¤å‘é€çš„é¢‘åº¦</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>repl-ping-slave-period	
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¶…æ—¶æ—¶é—´ repl-time çš„æ—¶é—´è‡³å°‘æ˜¯ ping æŒ‡ä»¤é¢‘åº¦çš„5åˆ°10å€ï¼Œå¦åˆ™ slave å¾ˆå®¹æ˜“åˆ¤å®šè¶…æ—¶</p></li></ul><hr><h4 id="ä¸€è‡´æ€§-1" tabindex="-1"><a class="header-anchor" href="#ä¸€è‡´æ€§-1" aria-hidden="true">#</a> ä¸€è‡´æ€§</h4><p>ç½‘ç»œä¿¡æ¯ä¸åŒæ­¥ï¼Œæ•°æ®å‘é€æœ‰å»¶è¿Ÿï¼Œå¯¼è‡´å¤šä¸ª slave è·å–ç›¸åŒæ•°æ®ä¸åŒæ­¥</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><ul><li><p><strong>ä¼˜åŒ–ä¸»ä»é—´çš„ç½‘ç»œç¯å¢ƒ</strong>ï¼Œé€šå¸¸æ”¾ç½®åœ¨åŒä¸€ä¸ªæœºæˆ¿éƒ¨ç½²ï¼Œå¦‚ä½¿ç”¨é˜¿é‡Œäº‘ç­‰äº‘æœåŠ¡å™¨æ—¶è¦æ³¨æ„æ­¤ç°è±¡</p></li><li><p>ç›‘æ§ä¸»ä»èŠ‚ç‚¹å»¶è¿Ÿï¼ˆé€šè¿‡offsetï¼‰åˆ¤æ–­ï¼Œå¦‚æœ slave å»¶è¿Ÿè¿‡å¤§ï¼Œ<strong>æš‚æ—¶å±è”½ç¨‹åºå¯¹è¯¥ slave çš„æ•°æ®è®¿é—®</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>slave-serve-stale-data <span class="token function">yes</span><span class="token operator">|</span>no
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å¼€å¯åä»…å“åº” infoã€slaveof ç­‰å°‘æ•°å‘½ä»¤ï¼ˆæ…ç”¨ï¼Œé™¤éå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚å¾ˆé«˜ï¼‰</p></li><li><p>å¤šä¸ª slave åŒæ—¶å¯¹ master è¯·æ±‚æ•°æ®åŒæ­¥ï¼Œmaster å‘é€çš„ RDB æ–‡ä»¶å¢å¤šï¼Œä¼šå¯¹å¸¦å®½é€ æˆå·¨å¤§å†²å‡»ï¼Œé€ æˆ master å¸¦å®½ä¸è¶³ï¼Œå› æ­¤æ•°æ®åŒæ­¥éœ€è¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œé€‚é‡é”™å³°</p></li></ul><hr><h2 id="å“¨å…µæ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#å“¨å…µæ¨¡å¼" aria-hidden="true">#</a> å“¨å…µæ¨¡å¼</h2><h3 id="å“¨å…µæ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#å“¨å…µæ¦‚è¿°" aria-hidden="true">#</a> å“¨å…µæ¦‚è¿°</h3><p>Sentinelï¼ˆå“¨å…µï¼‰æ˜¯ Redis çš„é«˜å¯ç”¨æ€§ï¼ˆhigh availabilityï¼‰è§£å†³æ–¹æ¡ˆï¼Œç”±ä¸€ä¸ªæˆ–å¤šä¸ª Sentinel å®ä¾‹ instance ç»„æˆçš„ Sentinel ç³»ç»Ÿå¯ä»¥ç›‘è§†ä»»æ„å¤šä¸ªä¸»æœåŠ¡å™¨ï¼Œä»¥åŠè¿™äº›ä¸»æœåŠ¡å™¨çš„æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œå¹¶åœ¨è¢«ç›‘è§†çš„ä¸»æœåŠ¡å™¨ä¸‹çº¿æ—¶è¿›è¡Œæ•…éšœè½¬ç§»</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å“¨å…µç³»ç»Ÿ.png" style="zoom:67%;"><ul><li>åŒç¯å›¾æ¡ˆè¡¨ç¤ºä¸»æœåŠ¡å™¨</li><li>å•ç¯å›¾æ¡ˆè¡¨ç¤ºä¸‰ä¸ªä»æœåŠ¡å™¨</li></ul><p>å“¨å…µçš„ä½œç”¨ï¼š</p><ul><li><p>ç›‘æ§ï¼šç›‘æ§ master å’Œ slaveï¼Œä¸æ–­çš„æ£€æŸ¥ master å’Œ slave æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œmaster å­˜æ´»æ£€æµ‹ã€master ä¸ slave è¿è¡Œæƒ…å†µæ£€æµ‹</p></li><li><p>é€šçŸ¥ï¼šå½“è¢«ç›‘æ§çš„æœåŠ¡å™¨å‡ºç°é—®é¢˜æ—¶ï¼Œå‘å…¶ä»–å“¨å…µå‘é€é€šçŸ¥</p></li><li><p>è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼šæ–­å¼€ master ä¸ slave è¿æ¥ï¼Œé€‰å–ä¸€ä¸ª slave ä½œä¸º masterï¼Œå°†å…¶ä»– slave è¿æ¥æ–°çš„ masterï¼Œå¹¶å‘ŠçŸ¥å®¢æˆ·ç«¯æ–°çš„æœåŠ¡å™¨åœ°å€</p></li></ul><hr><h3 id="å¯ç”¨å“¨å…µ" tabindex="-1"><a class="header-anchor" href="#å¯ç”¨å“¨å…µ" aria-hidden="true">#</a> å¯ç”¨å“¨å…µ</h3><h4 id="é…ç½®æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#é…ç½®æ–¹å¼" aria-hidden="true">#</a> é…ç½®æ–¹å¼</h4><p>é…ç½®ä¸‰ä¸ªå“¨å…µ sentinel.confï¼šä¸€èˆ¬å¤šä¸ªå“¨å…µé…ç½®ç›¸åŒã€ç«¯å£ä¸åŒï¼Œç‰¹æ®Šéœ€æ±‚å¯ä»¥é…ç½®ä¸åŒçš„å±æ€§</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>port <span class="token number">26401</span>
<span class="token function">dir</span> <span class="token string">&quot;/redis/data&quot;</span>
sentinel monitor mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6401</span> <span class="token number">2</span>
sentinel down-after-milliseconds mymaster <span class="token number">5000</span>
sentinel failover-timeout mymaster <span class="token number">20000</span>
sentinel parallel-sync mymaster <span class="token number">1</span>
sentinel deny-scripts-reconfig <span class="token function">yes</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é…ç½®è¯´æ˜ï¼š</p><ul><li><p>è®¾ç½®å“¨å…µç›‘å¬çš„ä¸»æœåŠ¡å™¨ä¿¡æ¯ï¼Œåˆ¤æ–­ä¸»è§‚ä¸‹çº¿æ‰€éœ€è¦çš„ç¥¨æ•°</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>sentinel monitor <span class="token operator">&lt;</span>master-name<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>master_ip<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>master_port<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>quorum<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>æŒ‡å®šå“¨å…µåœ¨ç›‘æ§ Redis æœåŠ¡æ—¶ï¼Œè®¾ç½®åˆ¤å®šæœåŠ¡å™¨å®•æœºçš„æ—¶é•¿ï¼Œè¯¥è®¾ç½®æ§åˆ¶æ˜¯å¦è¿›è¡Œä¸»ä»åˆ‡æ¢</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>sentinel down-after-milliseconds <span class="token operator">&lt;</span>master-name<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>million_seconds<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>å‡ºç°æ•…éšœåï¼Œæ•…éšœåˆ‡æ¢çš„æœ€å¤§è¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡è¯¥å€¼ï¼Œè®¤å®šåˆ‡æ¢å¤±è´¥ï¼Œé»˜è®¤ 3 åˆ†é’Ÿ</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>sentinel failover-timeout <span class="token operator">&lt;</span>master_name<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>million_seconds<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>æ•…éšœè½¬ç§»æ—¶ï¼ŒåŒæ—¶è¿›è¡Œä¸»ä»åŒæ­¥çš„ slave æ•°é‡ï¼Œæ•°å€¼è¶Šå¤§ï¼Œè¦æ±‚ç½‘ç»œèµ„æºè¶Šé«˜</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>sentinel parallel-syncs <span class="token operator">&lt;</span>master_name<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>sync_slave_number<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><p>å¯åŠ¨å“¨å…µï¼šæœåŠ¡ç«¯å‘½ä»¤ï¼ˆLinux å‘½ä»¤ï¼‰</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-sentinel filename
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><hr><h4 id="åˆå§‹åŒ–-1" tabindex="-1"><a class="header-anchor" href="#åˆå§‹åŒ–-1" aria-hidden="true">#</a> åˆå§‹åŒ–</h4><p>Sentinel æœ¬è´¨ä¸Šåªæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ç‰¹æ®Šæ¨¡å¼ä¸‹çš„ Redis æœåŠ¡å™¨ï¼Œå½“ä¸€ä¸ª Sentinel å¯åŠ¨æ—¶ï¼Œé¦–å…ˆåˆå§‹åŒ– Redis æœåŠ¡å™¨ï¼Œä½†æ˜¯åˆå§‹åŒ–è¿‡ç¨‹å’Œæ™®é€š Redis æœåŠ¡å™¨çš„åˆå§‹åŒ–è¿‡ç¨‹å¹¶ä¸å®Œå…¨ç›¸åŒï¼Œå“¨å…µ<strong>ä¸æä¾›æ•°æ®ç›¸å…³æœåŠ¡</strong>ï¼Œæ‰€ä»¥ä¸ä¼šè½½å…¥ RDBã€AOF æ–‡ä»¶</p><p>æ•´ä½“æµç¨‹ï¼š</p><ul><li><p>åˆå§‹åŒ–æœåŠ¡å™¨</p></li><li><p>å°†æ™®é€š Redis æœåŠ¡å™¨ä½¿ç”¨çš„ä»£ç æ›¿æ¢æˆ Sentinel ä¸“ç”¨ä»£ç </p></li><li><p>åˆå§‹åŒ– Sentinel çŠ¶æ€</p></li><li><p>æ ¹æ®ç»™å®šçš„é…ç½®æ–‡ä»¶ï¼Œåˆå§‹åŒ– Sentinel çš„ç›‘è§†ä¸»æœåŠ¡å™¨åˆ—è¡¨</p></li><li><p>åˆ›å»ºè¿å‘ä¸»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥</p></li></ul><hr><h4 id="ä»£ç æ›¿æ¢" tabindex="-1"><a class="header-anchor" href="#ä»£ç æ›¿æ¢" aria-hidden="true">#</a> ä»£ç æ›¿æ¢</h4><p>å°†ä¸€éƒ¨åˆ†æ™®é€š Redis æœåŠ¡å™¨ä½¿ç”¨çš„ä»£ç æ›¿æ¢æˆ Sentinel ä¸“ç”¨ä»£ç </p><p>Redis æœåŠ¡å™¨ç«¯å£ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name">REDIS_SERVERPORT</span> <span class="token expression"><span class="token number">6379</span> 		</span><span class="token comment">// æ™®é€šæœåŠ¡å™¨ç«¯å£</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name">REDIS_SENTINEL_PORT</span> <span class="token expression"><span class="token number">26379</span> 	</span><span class="token comment">// å“¨å…µç«¯å£</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>æœåŠ¡å™¨çš„å‘½ä»¤è¡¨ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// æ™®é€š Redis æœåŠ¡å™¨</span>
<span class="token keyword">struct</span> <span class="token class-name">redisCommand</span> redisCommandTable<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> getCommand<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;set&quot;</span><span class="token punctuation">,</span> setCommand<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;wm&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> noPreloadGetKeys<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//....</span>
<span class="token punctuation">}</span>
<span class="token comment">// å“¨å…µ</span>
<span class="token keyword">struct</span> <span class="token class-name">redisCommand</span> sentinelcmds<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span><span class="token string">&quot;ping&quot;</span><span class="token punctuation">,</span> pingCommand<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;sentinel&quot;</span><span class="token punctuation">,</span> sentinelCommand<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;subscribe&quot;</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&quot;unsubscribe&quot;</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>O<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&quot;psubscribe&quot;</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">&quot;punsubscribe&quot;</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string">&quot;info&quot;</span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šè¿°è¡¨æ˜¯å“¨å…µæ¨¡å¼ä¸‹å®¢æˆ·ç«¯å¯ä»¥æ‰§è¡Œçš„å‘½ä»¤ï¼Œæ‰€ä»¥å¯¹äº GETã€SET ç­‰å‘½ä»¤ï¼ŒæœåŠ¡å™¨æ ¹æœ¬å°±æ²¡æœ‰è½½å…¥</p><hr><h4 id="å“¨å…µçŠ¶æ€" tabindex="-1"><a class="header-anchor" href="#å“¨å…µçŠ¶æ€" aria-hidden="true">#</a> å“¨å…µçŠ¶æ€</h4><p>æœåŠ¡å™¨ä¼šåˆå§‹åŒ–ä¸€ä¸ª sentinelState ç»“æ„ï¼Œåˆå« Sentinel çŠ¶æ€ï¼Œç»“æ„ä¿å­˜äº†æœåŠ¡å™¨ä¸­æ‰€æœ‰å’Œ Sentinel åŠŸèƒ½æœ‰å…³çš„çŠ¶æ€ï¼ˆæœåŠ¡å™¨çš„ä¸€èˆ¬çŠ¶æ€ä»ç„¶ç”± redisServer ç»“æ„ä¿å­˜ï¼‰</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sentinelState</span> <span class="token punctuation">{</span>
    <span class="token comment">// å½“å‰çºªå…ƒï¼Œç”¨äºå®ç°æ•…éšœè½¬ç§»</span>
    <span class="token class-name">uint64_t</span> current_epoch<span class="token punctuation">;</span> 
    
    <span class="token comment">// ã€ä¿å­˜äº†æ‰€æœ‰è¢«è¿™ä¸ªsentinelç›‘è§†çš„ä¸»æœåŠ¡å™¨ã€‘</span>
    dict <span class="token operator">*</span>masters<span class="token punctuation">;</span>
    
    <span class="token comment">// æ˜¯å¦è¿›å…¥äº† TILT æ¨¡å¼</span>
    <span class="token keyword">int</span> tilt<span class="token punctuation">;</span>
    <span class="token comment">// è¿›å…¥ TILT æ¨¡å¼çš„æ—¶é—´</span>
    <span class="token class-name">mstime_t</span> tilt_start_time<span class="token punctuation">;</span>
    
    <span class="token comment">// æœ€åä¸€æ¬¡æ‰§è¡Œæ—¶é—´å¤„ç†çš„äº‹ä»¶</span>
    <span class="token class-name">mstime_t</span> previous_time<span class="token punctuation">;</span>
    
    <span class="token comment">// ç›®å‰æ­£åœ¨æ‰§è¡Œçš„è„šæœ¬æ•°é‡</span>
    <span class="token keyword">int</span> running_scripts<span class="token punctuation">;</span>
    <span class="token comment">// ä¸€ä¸ªFIFOé˜Ÿåˆ—ï¼ŒåŒ…å«äº†æ‰€æœ‰éœ€è¦æ‰§è¡Œçš„ç”¨æˆ·è„šæœ¬</span>
    list <span class="token operator">*</span>scripts_queue<span class="token punctuation">;</span>
    
<span class="token punctuation">}</span> sentinel<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="ç›‘æ§åˆ—è¡¨" tabindex="-1"><a class="header-anchor" href="#ç›‘æ§åˆ—è¡¨" aria-hidden="true">#</a> ç›‘æ§åˆ—è¡¨</h4><p>Sentinel çŠ¶æ€çš„åˆå§‹åŒ–å°† masters å­—å…¸çš„åˆå§‹åŒ–ï¼Œæ ¹æ®è¢«è½½å…¥çš„ Sentinel é…ç½®æ–‡ä»¶ conf æ¥è¿›è¡Œå±æ€§èµ‹å€¼</p><p>Sentinel çŠ¶æ€ä¸­çš„ masters å­—å…¸è®°å½•äº†æ‰€æœ‰è¢« Sentinel ç›‘è§†çš„<strong>ä¸»æœåŠ¡å™¨çš„ç›¸å…³ä¿¡æ¯</strong>ï¼Œå­—å…¸çš„é”®æ˜¯è¢«ç›‘è§†ä¸»æœåŠ¡å™¨çš„åå­—ï¼Œå€¼æ˜¯ä¸»æœåŠ¡å™¨å¯¹åº”çš„å®ä¾‹ç»“æ„</p><p>å®ä¾‹ç»“æ„æ˜¯ä¸€ä¸ª sentinelRedisinstance æ•°æ®ç±»å‹ï¼Œä»£è¡¨è¢« Sentinel ç›‘è§†çš„å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹å¯ä»¥æ˜¯ä¸»ã€ä»æœåŠ¡å™¨ï¼Œæˆ–è€…å…¶ä»– Sentinel</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">sentinelRedisinstance</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ ‡è¯†å€¼ï¼Œè®°å½•äº†å®ä¾‹çš„ç±»å‹ï¼Œä»¥åŠè¯¥å®ä¾‹çš„å½“å‰çŠ¶æ€</span>
    <span class="token keyword">int</span> flags<span class="token punctuation">;</span>
    
    <span class="token comment">// å®ä¾‹çš„åå­—ï¼Œä¸»æœåŠ¡å™¨çš„åå­—ç”±ç”¨æˆ·åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ï¼Œ</span>
    <span class="token comment">// ä»æœåŠ¡å™¨å’Œå“¨å…µçš„åå­—ç”± Sentinel è‡ªåŠ¨è®¾ç½®ï¼Œæ ¼å¼ä¸º ip:portï¼Œä¾‹å¦‚ 127.0.0.1:6379</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    
    <span class="token comment">// å®ä¾‹è¿è¡Œçš„ ID</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>runid<span class="token punctuation">;</span>
    
    <span class="token comment">// é…ç½®çºªå…ƒï¼Œç”¨äºå®ç°æ•…éšœè½¬ç§»</span>
    <span class="token class-name">uint64_t</span> config_epoch<span class="token punctuation">;</span>
    
    <span class="token comment">// å®ä¾‹åœ°å€</span>
    sentinelAddr <span class="token operator">*</span>addr<span class="token punctuation">;</span> 
    
    <span class="token comment">// å¦‚æœå½“å‰å®ä¾‹æ—¶ä¸»æœåŠ¡å™¨ï¼Œè¯¥å­—æ®µä¿å­˜ä»æœåŠ¡å™¨ä¿¡æ¯ï¼Œé”®æ˜¯åå­—æ ¼å¼ä¸º ip:portï¼Œå€¼æ˜¯å®ä¾‹ç»“æ„</span>
    dict <span class="token operator">*</span>slaves<span class="token punctuation">;</span>
    
    <span class="token comment">// æ‰€æœ‰ç›‘è§†å½“å‰æœåŠ¡å™¨çš„ Sentinel å®ä¾‹ï¼Œé”®æ˜¯åå­—æ ¼å¼ä¸º ip:portï¼Œå€¼æ˜¯å®ä¾‹ç»“æ„</span>
    dict <span class="token operator">*</span>sentinels<span class="token punctuation">;</span>
    
    <span class="token comment">// sentinel down-after-milliseconds çš„å€¼ï¼Œè¡¨ç¤ºå®ä¾‹æ— å“åº”å¤šå°‘æ¯«ç§’åä¼šè¢«åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿(subjectively down) </span>
    <span class="token class-name">mstime_t</span> down_after_period<span class="token punctuation">;</span>
    
    <span class="token comment">// sentinel monitor é€‰é¡¹ä¸­çš„quorumå‚æ•°ï¼Œåˆ¤æ–­è¿™ä¸ªå®ä¾‹ä¸ºå®¢è§‚ä¸‹çº¿(objectively down)æ‰€éœ€çš„æ”¯æŒæŠ•ç¥¨æ•°é‡</span>
    <span class="token keyword">int</span> quorum<span class="token punctuation">;</span>
    
    <span class="token comment">// sentinel parallel-syncs çš„å€¼ï¼Œåœ¨æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œæ—¶ï¼Œå¯ä»¥åŒæ—¶å¯¹æ–°çš„ä¸»æœåŠ¡å™¨è¿›è¡ŒåŒæ­¥çš„ä»æœåŠ¡å™¨æ•°é‡</span>
    <span class="token keyword">int</span> parallel<span class="token operator">-</span>syncs<span class="token punctuation">;</span>
    
    <span class="token comment">// sentinel failover-timeoutçš„å€¼ï¼Œåˆ·æ–°æ•…éšœè¿ç§»çŠ¶æ€çš„æœ€å¤§æ—¶é™</span>
    <span class="token class-name">mstime_t</span> failover_timeout<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>addr å±æ€§æ˜¯ä¸€ä¸ªæŒ‡å‘ sentinelAddr çš„æŒ‡é’ˆï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">sentinelAddr</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>ip<span class="token punctuation">;</span>
    <span class="token keyword">int</span> port<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="ç½‘ç»œè¿æ¥" tabindex="-1"><a class="header-anchor" href="#ç½‘ç»œè¿æ¥" aria-hidden="true">#</a> ç½‘ç»œè¿æ¥</h4><p>åˆå§‹åŒ– Sentinel çš„æœ€åä¸€æ­¥æ˜¯åˆ›å»ºè¿å‘è¢«ç›‘è§†ä¸»æœåŠ¡å™¨çš„ç½‘ç»œè¿æ¥ï¼ŒSentinel å°†æˆä¸ºä¸»æœåŠ¡å™¨çš„å®¢æˆ·ç«¯ï¼Œå¯ä»¥å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤ï¼Œå¹¶ä»å‘½ä»¤å›å¤ä¸­è·å–ç›¸å…³çš„ä¿¡æ¯</p><p>æ¯ä¸ªè¢« Sentinel ç›‘è§†çš„ä¸»æœåŠ¡å™¨ï¼ŒSentinel ä¼šåˆ›å»ºä¸¤ä¸ªè¿å‘ä¸»æœåŠ¡å™¨çš„<strong>å¼‚æ­¥ç½‘ç»œè¿æ¥</strong>ï¼š</p><ul><li>å‘½ä»¤è¿æ¥ï¼šç”¨äºå‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤ï¼Œå¹¶æ¥æ”¶å‘½ä»¤å›å¤</li><li>è®¢é˜…è¿æ¥ï¼šç”¨äºè®¢é˜…ä¸»æœåŠ¡å™¨çš„ <code>_sentinel_:hello</code> é¢‘é“</li></ul><p>å»ºç«‹ä¸¤ä¸ªè¿æ¥çš„åŸå› ï¼š</p><ul><li><p>åœ¨ Redis ç›®å‰çš„å‘å¸ƒä¸è®¢é˜…åŠŸèƒ½ä¸­ï¼Œè¢«å‘é€çš„ä¿¡æ¯éƒ½ä¸ä¼šä¿å­˜åœ¨ Redis æœåŠ¡å™¨é‡Œï¼Œ å¦‚æœåœ¨ä¿¡æ¯å‘é€æ—¶æ¥æ”¶ä¿¡æ¯çš„å®¢æˆ·ç«¯ç¦»çº¿æˆ–æ–­çº¿ï¼Œé‚£ä¹ˆè¿™ä¸ªå®¢æˆ·ç«¯å°±ä¼šä¸¢å¤±è¿™æ¡ä¿¡æ¯ï¼Œä¸ºäº†ä¸ä¸¢å¤± hello é¢‘é“çš„ä»»ä½•ä¿¡æ¯ï¼ŒSentinel å¿…é¡»ç”¨ä¸€ä¸ªè®¢é˜…è¿æ¥æ¥æ¥æ”¶è¯¥é¢‘é“çš„ä¿¡æ¯</p></li><li><p>Sentinel è¿˜å¿…é¡»å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤ï¼Œä»¥æ­¤æ¥ä¸ä¸»æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ï¼Œæ‰€ä»¥ Sentinel è¿˜å¿…é¡»å‘ä¸»æœåŠ¡å™¨åˆ›å»ºå‘½ä»¤è¿æ¥</p></li></ul><p>è¯´æ˜ï¼šæ–­çº¿çš„æ„æ€å°±æ˜¯ç½‘ç»œè¿æ¥æ–­å¼€</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å“¨å…µç³»ç»Ÿå»ºç«‹è¿æ¥.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h3 id="ä¿¡æ¯äº¤äº’" tabindex="-1"><a class="header-anchor" href="#ä¿¡æ¯äº¤äº’" aria-hidden="true">#</a> ä¿¡æ¯äº¤äº’</h3><h4 id="è·å–ä¿¡æ¯" tabindex="-1"><a class="header-anchor" href="#è·å–ä¿¡æ¯" aria-hidden="true">#</a> è·å–ä¿¡æ¯</h4><h5 id="ä¸»æœåŠ¡å™¨" tabindex="-1"><a class="header-anchor" href="#ä¸»æœåŠ¡å™¨" aria-hidden="true">#</a> ä¸»æœåŠ¡å™¨</h5><p>Sentinel é»˜è®¤ä¼šä»¥æ¯åç§’ä¸€æ¬¡çš„é¢‘ç‡ï¼Œé€šè¿‡å‘½ä»¤è¿æ¥å‘è¢«ç›‘è§†çš„ä¸»æœåŠ¡å™¨å‘é€ INFO å‘½ä»¤ï¼Œæ¥è·å–ä¸»æœåŠ¡å™¨çš„ä¿¡æ¯</p><ul><li>ä¸€éƒ¨åˆ†æ˜¯ä¸»æœåŠ¡å™¨æœ¬èº«çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ runid åŸŸè®°å½•çš„æœåŠ¡å™¨è¿è¡Œ IDï¼Œä»¥åŠ role åŸŸè®°å½•çš„æœåŠ¡å™¨è§’è‰²</li><li>å¦ä¸€éƒ¨åˆ†æ˜¯æœåŠ¡å™¨å±ä¸‹æ‰€æœ‰ä»æœåŠ¡å™¨çš„ä¿¡æ¯ï¼Œæ¯ä¸ªä»æœåŠ¡å™¨éƒ½ç”±ä¸€ä¸ª slave å­—ç¬¦ä¸²å¼€å¤´çš„è¡Œè®°å½•ï¼Œæ ¹æ®è¿™äº› IP åœ°å€å’Œç«¯å£å·ï¼ŒSentinel æ— é¡»ç”¨æˆ·æä¾›ä»æœåŠ¡å™¨çš„åœ°å€ä¿¡æ¯ï¼Œå°±å¯ä»¥<strong>è‡ªåŠ¨å‘ç°ä»æœåŠ¡å™¨</strong></li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># Server </span>
run_id:76llc59dc3a29aa6fa0609f84lbb6al019008a9c
<span class="token punctuation">..</span>.
<span class="token comment"># Replication </span>
role:master 
<span class="token punctuation">..</span>.
slave0: <span class="token assign-left variable">ip</span><span class="token operator">=</span>l27.0.0.1, <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">11111</span>, <span class="token assign-left variable">state</span><span class="token operator">=</span>online, <span class="token assign-left variable">offset</span><span class="token operator">=</span><span class="token number">22</span>, <span class="token assign-left variable">lag</span><span class="token operator">=</span><span class="token number">0</span>
slave1: <span class="token assign-left variable">ip</span><span class="token operator">=</span>l27.0.0.1, <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">22222</span>, <span class="token assign-left variable">state</span><span class="token operator">=</span>online, <span class="token assign-left variable">offset</span><span class="token operator">=</span><span class="token number">22</span>, <span class="token assign-left variable">lag</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ ¹æ® run_id å’Œ role è®°å½•çš„ä¿¡æ¯ Sentinel å°†å¯¹ä¸»æœåŠ¡å™¨çš„å®ä¾‹ç»“æ„è¿›è¡Œæ›´æ–°ï¼Œæ¯”å¦‚ä¸»æœåŠ¡å™¨é‡å¯ä¹‹åï¼Œè¿è¡Œ ID å°±ä¼šå’Œå®ä¾‹ç»“æ„ä¹‹å‰ä¿å­˜çš„è¿è¡Œ ID ä¸åŒï¼Œå“¨å…µæ£€æµ‹åˆ°è¿™ä¸€æƒ…å†µä¹‹åå°±ä¼šå¯¹å®ä¾‹ç»“æ„çš„è¿è¡Œ ID è¿›è¡Œæ›´æ–°</p><p>å¯¹äºä¸»æœåŠ¡å™¨è¿”å›çš„ä»æœåŠ¡å™¨ä¿¡æ¯ï¼Œç”¨å®ä¾‹ç»“æ„çš„ slaves å­—å…¸è®°å½•äº†ä»æœåŠ¡å™¨çš„ä¿¡æ¯ï¼š</p><ul><li>å¦‚æœä»æœåŠ¡å™¨å¯¹åº”çš„å®ä¾‹ç»“æ„å·²ç»å­˜åœ¨ï¼Œé‚£ä¹ˆ Sentinel å¯¹ä»æœåŠ¡å™¨çš„å®ä¾‹ç»“æ„è¿›è¡Œæ›´æ–°</li><li>å¦‚æœä¸å­˜åœ¨ï¼Œä¸ºè¿™ä¸ªä»æœåŠ¡å™¨æ–°åˆ›å»ºä¸€ä¸ªå®ä¾‹ç»“æ„åŠ å…¥å­—å…¸ï¼Œå­—å…¸é”®ä¸º <code>ip:port</code></li></ul><hr><h5 id="ä»æœåŠ¡å™¨" tabindex="-1"><a class="header-anchor" href="#ä»æœåŠ¡å™¨" aria-hidden="true">#</a> ä»æœåŠ¡å™¨</h5><p>å½“ Sentinel å‘ç°ä¸»æœåŠ¡å™¨æœ‰æ–°çš„ä»æœåŠ¡å™¨å‡ºç°æ—¶ï¼Œä¼šä¸ºè¿™ä¸ªæ–°çš„ä»æœåŠ¡å™¨åˆ›å»ºç›¸åº”çš„å®ä¾‹ç»“æ„ï¼Œè¿˜ä¼š<strong>åˆ›å»ºåˆ°ä»æœåŠ¡å™¨çš„å‘½ä»¤è¿æ¥å’Œè®¢é˜…è¿æ¥</strong>ï¼Œæ‰€ä»¥ Sentinel å¯¹æ‰€æœ‰çš„ä»æœåŠ¡å™¨ä¹‹é—´éƒ½å¯ä»¥è¿›è¡Œå‘½ä»¤æ“ä½œ</p><p>Sentinel é»˜è®¤ä¼šä»¥æ¯åç§’ä¸€æ¬¡çš„é¢‘ç‡ï¼Œå‘ä»æœåŠ¡å™¨å‘é€ INFO å‘½ä»¤ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># Server </span>
run_id:76llc59dc3a29aa6fa0609f84lbb6al019008a9c	<span class="token comment">#ä»æœåŠ¡å™¨çš„è¿è¡Œ id</span>
<span class="token punctuation">..</span>.
<span class="token comment"># Replication </span>
role:slave 				<span class="token comment"># ä»æœåŠ¡å™¨è§’è‰²</span>
<span class="token punctuation">..</span>.
master_host:127.0.0.1 	<span class="token comment"># ä¸»æœåŠ¡å™¨çš„ ip</span>
master_port:6379 		<span class="token comment"># ä¸»æœåŠ¡å™¨çš„ port</span>
master_link_status:up 	<span class="token comment"># ä¸»ä»æœåŠ¡å™¨çš„è¿æ¥çŠ¶æ€</span>
slave_repl_offset:11111	<span class="token comment"># ä»æœåŠ¡å™¨çš„å¤åˆ¶åç§»èœ‡</span>
slave_priority:100 		<span class="token comment"># ä»æœåŠ¡å™¨çš„ä¼˜å…ˆçº§</span>
<span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>ä¼˜å…ˆçº§å±æ€§</strong>åœ¨æ•…éšœè½¬ç§»æ—¶ä¼šç”¨åˆ°</li></ul><p>æ ¹æ®è¿™äº›ä¿¡æ¯ï¼ŒSentinel ä¼šå¯¹ä»æœåŠ¡å™¨çš„å®ä¾‹ç»“æ„è¿›è¡Œæ›´æ–°</p><hr><h4 id="å‘é€ä¿¡æ¯" tabindex="-1"><a class="header-anchor" href="#å‘é€ä¿¡æ¯" aria-hidden="true">#</a> å‘é€ä¿¡æ¯</h4><p>Sentinel åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šä»¥æ¯ä¸¤ç§’ä¸€æ¬¡çš„é¢‘ç‡ï¼Œé€šè¿‡å‘½ä»¤è¿æ¥å‘æ‰€æœ‰è¢«ç›‘è§†çš„ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨å‘é€ä»¥ä¸‹æ ¼å¼çš„å‘½ä»¤ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>PUBLISH _sentinel_:hello &quot;<span class="token operator">&lt;</span>s_ip<span class="token operator">&gt;</span>, <span class="token operator">&lt;</span>s_port<span class="token operator">&gt;</span>, <span class="token operator">&lt;</span>s_runid<span class="token operator">&gt;</span>, <span class="token operator">&lt;</span>s_epoch<span class="token operator">&gt;</span>, <span class="token operator">&lt;</span>m_name<span class="token operator">&gt;</span>, <span class="token operator">&lt;</span>m_ip<span class="token operator">&gt;</span>, <span class="token operator">&lt;</span>m_port<span class="token operator">&gt;</span>, <span class="token operator">&lt;</span>m_epoch<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¿™æ¡å‘½ä»¤å‘æœåŠ¡å™¨çš„ <code>_sentinel_:hello</code> é¢‘é“å‘é€äº†ä¸€æ¡ä¿¡æ¯ï¼Œä¿¡æ¯çš„å†…å®¹ç”±å¤šä¸ªå‚æ•°ç»„æˆï¼š</p><ul><li>ä»¥ s_ å¼€å¤´çš„å‚æ•°è®°å½•çš„æ˜¯ Sentinel æœ¬èº«çš„ä¿¡æ¯</li><li>ä»¥ m_ å¼€å¤´çš„å‚æ•°è®°å½•çš„åˆ™æ˜¯ä¸»æœåŠ¡å™¨çš„ä¿¡æ¯</li></ul><p>è¯´æ˜ï¼š<strong>é€šè¿‡å‘½ä»¤è¿æ¥å‘é€çš„é¢‘é“ä¿¡æ¯</strong></p><hr><h4 id="æ¥å—ä¿¡æ¯" tabindex="-1"><a class="header-anchor" href="#æ¥å—ä¿¡æ¯" aria-hidden="true">#</a> æ¥å—ä¿¡æ¯</h4><h5 id="è®¢é˜…é¢‘é“" tabindex="-1"><a class="header-anchor" href="#è®¢é˜…é¢‘é“" aria-hidden="true">#</a> è®¢é˜…é¢‘é“</h5><p>Sentinel ä¸ä¸€ä¸ªä¸»æˆ–ä»æœåŠ¡å™¨å»ºç«‹èµ·è®¢é˜…è¿æ¥ä¹‹åï¼Œå°±ä¼šé€šè¿‡è®¢é˜…è¿æ¥å‘æœåŠ¡å™¨å‘é€è®¢é˜…å‘½ä»¤ï¼Œé¢‘é“çš„è®¢é˜…ä¼šä¸€ç›´æŒç»­åˆ° Sentinel ä¸æœåŠ¡å™¨çš„è¿æ¥æ–­å¼€ä¸ºæ­¢</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>SUBSCRIBE _sentinel_:hello
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è®¢é˜…æˆåŠŸåï¼ŒSentinel å°±å¯ä»¥é€šè¿‡è®¢é˜…è¿æ¥ä»æœåŠ¡å™¨çš„ <code>_sentinel_:hello</code> é¢‘é“æ¥æ”¶ä¿¡æ¯ï¼Œå¯¹æ¶ˆæ¯åˆ†æï¼š</p><ul><li>å¦‚æœä¿¡æ¯ä¸­è®°å½•çš„ Sentinel è¿è¡Œ ID ä¸è‡ªå·±çš„ç›¸åŒï¼Œä¸åšè¿›ä¸€æ­¥å¤„ç†</li><li>å¦‚æœä¸åŒï¼Œå°†æ ¹æ®ä¿¡æ¯ä¸­çš„å„ä¸ªå‚æ•°ï¼Œå¯¹ç›¸åº”ä¸»æœåŠ¡å™¨çš„å®ä¾‹ç»“æ„è¿›è¡Œæ›´æ–°</li></ul><p>Sentinel ä¸ºä¸»æœåŠ¡å™¨åˆ›å»ºçš„å®ä¾‹ç»“æ„çš„ sentinels å­—å…¸ä¿å­˜æ‰€æœ‰åŒæ ·ç›‘è§†è¿™ä¸ª<strong>ä¸»æœåŠ¡å™¨çš„ Sentinel ä¿¡æ¯</strong>ï¼ˆåŒ…æ‹¬ Sentinel è‡ªå·±ï¼‰ï¼Œå­—å…¸çš„é”®æ˜¯ Sentinel çš„åå­—ï¼Œæ ¼å¼ä¸º <code>ip:port</code>ï¼Œå€¼æ˜¯é”®æ‰€å¯¹åº” Sentinel çš„å®ä¾‹ç»“æ„</p><p>ç›‘è§†åŒä¸€ä¸ªæœåŠ¡å™¨çš„ Sentinel è®¢é˜…çš„é¢‘é“ç›¸åŒï¼ŒSentinel å‘é€çš„ä¿¡æ¯ä¼šè¢«å…¶ä»– Sentinel æ¥æ”¶åˆ°ï¼ˆå‘é€ä¿¡æ¯çš„ä¸ºæº Sentinelï¼Œæ¥æ”¶ä¿¡æ¯çš„ä¸ºç›®æ ‡ Sentinelï¼‰ï¼Œç›®æ ‡ Sentinel åœ¨è‡ªå·±çš„ sentinelState.masters ä¸­æŸ¥æ‰¾æº Sentinel æœåŠ¡å™¨çš„å®ä¾‹ç»“æ„è¿›è¡Œæ·»åŠ æˆ–æ›´æ–°</p><p>å› ä¸º Sentinel å¯ä»¥æ¥æ”¶åˆ°çš„é¢‘é“ä¿¡æ¯æ¥æ„ŸçŸ¥å…¶ä»– Sentinel çš„å­˜åœ¨ï¼Œå¹¶é€šè¿‡å‘é€é¢‘é“ä¿¡æ¯æ¥è®©å…¶ä»– Sentinel çŸ¥é“è‡ªå·±çš„å­˜åœ¨ï¼Œæ‰€ä»¥ç”¨æˆ·åœ¨ä½¿ç”¨ Sentinel æ—¶å¹¶ä¸éœ€è¦æä¾›å„ä¸ª Sentinel çš„åœ°å€ä¿¡æ¯ï¼Œ<strong>ç›‘è§†åŒä¸€ä¸ªä¸»æœåŠ¡å™¨çš„å¤šä¸ª Sentinel å¯ä»¥ç›¸äº’å‘ç°å¯¹æ–¹</strong></p><p>å“¨å…µå®ä¾‹ä¹‹é—´å¯ä»¥ç›¸äº’å‘ç°ï¼Œè¦å½’åŠŸäº Redis æä¾›å‘å¸ƒè®¢é˜…æœºåˆ¶</p><hr><h5 id="å‘½ä»¤è¿æ¥" tabindex="-1"><a class="header-anchor" href="#å‘½ä»¤è¿æ¥" aria-hidden="true">#</a> å‘½ä»¤è¿æ¥</h5><p>Sentinel é€šè¿‡é¢‘é“ä¿¡æ¯å‘ç°æ–°çš„ Sentinelï¼Œé™¤äº†åˆ›å»ºå®ä¾‹ç»“æ„ï¼Œè¿˜ä¼šåˆ›å»ºä¸€ä¸ªè¿å‘æ–° Sentinel çš„å‘½ä»¤è¿æ¥ï¼Œè€Œæ–° Sentinel ä¹ŸåŒæ ·ä¼šåˆ›å»ºè¿å‘è¿™ä¸ª Sentinel çš„å‘½ä»¤è¿æ¥ï¼Œæœ€ç»ˆç›‘è§†åŒä¸€ä¸»æœåŠ¡å™¨çš„å¤šä¸ª Sentinel å°†å½¢æˆç›¸äº’è¿æ¥çš„ç½‘ç»œ</p><p>ä½œç”¨ï¼š<strong>é€šè¿‡å‘½ä»¤è¿æ¥ç›¸è¿çš„å„ä¸ª Sentinel</strong> å¯ä»¥å‘å…¶ä»– Sentinel å‘é€å‘½ä»¤è¯·æ±‚æ¥è¿›è¡Œä¿¡æ¯äº¤æ¢</p><p>Sentinel ä¹‹é—´ä¸ä¼šåˆ›å»ºè®¢é˜…è¿æ¥ï¼š</p><ul><li>Sentinel éœ€è¦é€šè¿‡æ¥æ”¶ä¸»æœåŠ¡å™¨æˆ–è€…ä»æœåŠ¡å™¨å‘æ¥çš„é¢‘é“ä¿¡æ¯æ¥å‘ç°æœªçŸ¥çš„æ–° Sentinelï¼Œæ‰€ä»¥æ‰åˆ›å»ºè®¢é˜…è¿æ¥</li><li>ç›¸äº’å·²çŸ¥çš„ Sentinel åªè¦ä½¿ç”¨å‘½ä»¤è¿æ¥æ¥è¿›è¡Œé€šä¿¡å°±è¶³å¤Ÿäº†</li></ul><hr><h3 id="ä¸‹çº¿æ£€æµ‹" tabindex="-1"><a class="header-anchor" href="#ä¸‹çº¿æ£€æµ‹" aria-hidden="true">#</a> ä¸‹çº¿æ£€æµ‹</h3><h4 id="ä¸»è§‚ä¸‹çº¿" tabindex="-1"><a class="header-anchor" href="#ä¸»è§‚ä¸‹çº¿" aria-hidden="true">#</a> ä¸»è§‚ä¸‹çº¿</h4><p>Sentinel åœ¨é»˜è®¤æƒ…å†µä¸‹ä¼šä»¥æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡å‘æ‰€æœ‰ä¸å®ƒåˆ›å»ºäº†å‘½ä»¤è¿æ¥çš„å®ä¾‹ï¼ˆåŒ…æ‹¬ä¸»ä»æœåŠ¡å™¨ã€å…¶ä»– Sentinelï¼‰å‘é€ PING å‘½ä»¤ï¼Œé€šè¿‡å®ä¾‹è¿”å›çš„ PING å‘½ä»¤å›å¤æ¥åˆ¤æ–­å®ä¾‹æ˜¯å¦åœ¨çº¿</p><ul><li>æœ‰æ•ˆå›å¤ï¼šå®ä¾‹è¿”å› +PONGã€-LOADINGã€-MASTERDOWN ä¸‰ç§å›å¤çš„å…¶ä¸­ä¸€ç§</li><li>æ— æ•ˆå›å¤ï¼šå®ä¾‹è¿”å›é™¤ä¸Šè¿°ä¸‰ç§ä»¥å¤–çš„ä»»ä½•æ•°æ®</li></ul><p>Sentinel é…ç½®æ–‡ä»¶ä¸­ down-after-milliseconds é€‰é¡¹æŒ‡å®šäº†åˆ¤æ–­å®ä¾‹è¿›å…¥ä¸»è§‚ä¸‹çº¿æ‰€éœ€çš„æ—¶é•¿ï¼Œå¦‚æœä¸»æœåŠ¡å™¨åœ¨è¯¥æ—¶é—´å†…ä¸€ç›´å‘ Sentinel è¿”å›æ— æ•ˆå›å¤ï¼ŒSentinel å°±ä¼šåœ¨è¯¥æœåŠ¡å™¨å¯¹åº”å®ä¾‹ç»“æ„çš„ flags å±æ€§æ‰“å¼€ SRI_S_DOWN æ ‡è¯†ï¼Œè¡¨ç¤ºè¯¥ä¸»æœåŠ¡å™¨è¿›å…¥ä¸»è§‚ä¸‹çº¿çŠ¶æ€</p><p>é…ç½®çš„ down-after-milliseconds å€¼ä¸ä»…é€‚ç”¨äºä¸»æœåŠ¡å™¨ï¼Œè¿˜ä¼šè¢«ç”¨äºå½“å‰ Sentinel åˆ¤æ–­ä¸»æœåŠ¡å™¨å±ä¸‹çš„æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œä»¥åŠæ‰€æœ‰åŒæ ·ç›‘è§†è¿™ä¸ªä¸»æœåŠ¡å™¨çš„å…¶ä»– Sentinel çš„ä¸»è§‚ä¸‹çº¿çŠ¶æ€</p><p>æ³¨æ„ï¼šå¯¹äºç›‘è§†åŒä¸€ä¸ªä¸»æœåŠ¡å™¨çš„å¤šä¸ª Sentinel æ¥è¯´ï¼Œè®¾ç½®çš„ down-after-milliseconds é€‰é¡¹çš„å€¼å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥å½“ä¸€ä¸ª Sentinel å°†ä¸»æœåŠ¡å™¨åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿æ—¶ï¼Œå…¶ä»– Sentinel å¯èƒ½ä»ç„¶ä¼šè®¤ä¸ºä¸»æœåŠ¡å™¨å¤„äºåœ¨çº¿çŠ¶æ€</p><hr><h4 id="å®¢è§‚ä¸‹çº¿" tabindex="-1"><a class="header-anchor" href="#å®¢è§‚ä¸‹çº¿" aria-hidden="true">#</a> å®¢è§‚ä¸‹çº¿</h4><p>å½“ Sentinel å°†ä¸€ä¸ªä¸»æœåŠ¡å™¨åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿ä¹‹åï¼Œä¼šå‘åŒæ ·ç›‘è§†è¿™ä¸€ä¸»æœåŠ¡å™¨çš„å…¶ä»– Sentinel è¿›è¡Œè¯¢é—®</p><p>Sentinel ä½¿ç”¨å‘½ä»¤è¯¢é—®å…¶ä»– Sentinel æ˜¯å¦åŒæ„ä¸»æœåŠ¡å™¨å·²ä¸‹çº¿ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>SENTINEL is-master-down-by-addr <span class="token operator">&lt;</span>ip<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>port<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>current_epoch<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>runid<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>ipï¼šè¢« Sentinel åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨çš„ IP åœ°å€</li><li>portï¼šè¢« Sentinel åˆ¤æ–­ä¸ºä¸»è§‚ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨çš„ç«¯å£å·</li><li>current_epochï¼šSentinel å½“å‰çš„é…ç½®çºªå…ƒï¼Œç”¨äºé€‰ä¸¾é¢†å¤´ Sentinel</li><li>runidï¼šå–å€¼ä¸º * ç¬¦å·ä»£è¡¨å‘½ä»¤ä»…ä»…ç”¨äºæ£€æµ‹ä¸»æœåŠ¡å™¨çš„å®¢è§‚ä¸‹çº¿çŠ¶æ€ï¼›å–å€¼ä¸º Sentinel çš„è¿è¡Œ ID åˆ™ç”¨äºé€‰ä¸¾é¢†å¤´ Sentinel</li></ul><p>ç›®æ ‡ Sentinel æ¥æ”¶åˆ°æº Sentinel çš„å‘½ä»¤æ—¶ï¼Œä¼šæ ¹æ®å‚æ•°çš„ lP å’Œç«¯å£å·ï¼Œæ£€æŸ¥ä¸»æœåŠ¡å™¨æ˜¯å¦å·²ä¸‹çº¿ï¼Œç„¶åè¿”å›ä¸€æ¡åŒ…å«ä¸‰ä¸ªå‚æ•°çš„ Multi Bulk å›å¤ï¼š</p><ul><li>down_stateï¼šè¿”å›ç›®æ ‡ Sentinel å¯¹æœåŠ¡å™¨çš„æ£€æŸ¥ç»“æœï¼Œ1 ä»£è¡¨ä¸»æœåŠ¡å™¨å·²ä¸‹çº¿ï¼Œ0 ä»£è¡¨æœªä¸‹çº¿</li><li>leader_runidï¼šå–å€¼ä¸º * ç¬¦å·ä»£è¡¨å‘½ä»¤ä»…ç”¨äºæ£€æµ‹æœåŠ¡å™¨çš„ä¸‹çº¿çŠ¶æ€ï¼›è€Œå±€éƒ¨é¢†å¤´ Sentinel çš„è¿è¡Œ ID åˆ™ç”¨äºé€‰ä¸¾é¢†å¤´ Sentinel</li><li>leader_epochï¼šç›®æ ‡ Sentinel çš„å±€éƒ¨é¢†å¤´ Sentinel çš„é…ç½®çºªå…ƒ</li></ul><p>æº Sentinel å°†ç»Ÿè®¡å…¶ä»– Sentinel åŒæ„ä¸»æœåŠ¡å™¨å·²ä¸‹çº¿çš„æ•°é‡ï¼Œå½“è¿™ä¸€æ•°é‡è¾¾åˆ°é…ç½®æŒ‡å®šçš„åˆ¤æ–­å®¢è§‚ä¸‹çº¿æ‰€éœ€çš„æ•°é‡ï¼ˆquorumï¼‰æ—¶ï¼ŒSentinel ä¼šå°†ä¸»æœåŠ¡å™¨å¯¹åº”å®ä¾‹ç»“æ„ flags å±æ€§çš„ SRI_O_DOWN æ ‡è¯†æ‰“å¼€ï¼Œä»£è¡¨å®¢è§‚ä¸‹çº¿ï¼Œå¹¶å¯¹ä¸»æœåŠ¡å™¨æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œ</p><p>æ³¨æ„ï¼š<strong>ä¸åŒ Sentinel åˆ¤æ–­å®¢è§‚ä¸‹çº¿çš„æ¡ä»¶å¯èƒ½ä¸åŒ</strong>ï¼Œå› ä¸ºè½½å…¥çš„é…ç½®æ–‡ä»¶ä¸­çš„å±æ€§ quorum å¯èƒ½ä¸åŒ</p><hr><h3 id="é¢†å¤´é€‰ä¸¾" tabindex="-1"><a class="header-anchor" href="#é¢†å¤´é€‰ä¸¾" aria-hidden="true">#</a> é¢†å¤´é€‰ä¸¾</h3><p>ä¸»æœåŠ¡å™¨è¢«åˆ¤æ–­ä¸ºå®¢è§‚ä¸‹çº¿æ—¶ï¼Œ<strong>ç›‘è§†è¯¥ä¸»æœåŠ¡å™¨çš„å„ä¸ª Sentinel ä¼šè¿›è¡Œåå•†</strong>ï¼Œé€‰ä¸¾å‡ºä¸€ä¸ªé¢†å¤´ Sentinel å¯¹ä¸‹çº¿æœåŠ¡å™¨æ‰§è¡Œæ•…éšœè½¬ç§»</p><p>Redis é€‰ä¸¾é¢†å¤´ Sentinel çš„è§„åˆ™ï¼š</p><ul><li><p>æ‰€æœ‰åœ¨çº¿çš„ Sentinel éƒ½æœ‰è¢«é€‰ä¸ºé¢†å¤´ Sentinel çš„èµ„æ ¼</p></li><li><p>æ¯ä¸ªå‘ç°ä¸»æœåŠ¡å™¨è¿›å…¥å®¢è§‚ä¸‹çº¿çš„ Sentinel éƒ½ä¼šè¦æ±‚å…¶ä»– Sentinel å°†è‡ªå·±è®¾ç½®ä¸ºå±€éƒ¨é¢†å¤´ Sentinel</p></li><li><p>åœ¨ä¸€ä¸ªé…ç½®çºªå…ƒé‡Œï¼Œæ‰€æœ‰ Sentinel éƒ½åªæœ‰ä¸€æ¬¡å°†æŸä¸ª Sentinel è®¾ç½®ä¸ºå±€éƒ¨é¢†å¤´ Sentinel çš„æœºä¼šï¼Œå¹¶ä¸”å±€éƒ¨é¢†å¤´ä¸€æ—¦è®¾ç½®ï¼Œåœ¨è¿™ä¸ªé…ç½®çºªå…ƒé‡Œå°±ä¸èƒ½å†æ›´æ”¹</p></li><li><p>Sentinel è®¾ç½®å±€éƒ¨é¢†å¤´ Sentinel çš„è§„åˆ™æ˜¯å…ˆåˆ°å…ˆå¾—ï¼Œæœ€å…ˆå‘ç›®æ ‡ Sentinel å‘é€è®¾ç½®è¦æ±‚çš„æº Sentinel å°†æˆä¸ºç›®æ ‡ Sentinel çš„å±€éƒ¨é¢†å¤´ Sentinelï¼Œä¹‹åæ¥æ”¶åˆ°çš„æ‰€æœ‰è®¾ç½®è¦æ±‚éƒ½ä¼šè¢«ç›®æ ‡ Sentinel æ‹’ç»</p></li><li><p>é¢†å¤´ Sentinel çš„äº§ç”Ÿ<strong>éœ€è¦åŠæ•°ä»¥ä¸Š Sentinel çš„æ”¯æŒ</strong>ï¼Œå¹¶ä¸”æ¯ä¸ª Sentinel åªæœ‰ä¸€ç¥¨ï¼Œæ‰€ä»¥ä¸€ä¸ªé…ç½®çºªå…ƒåªä¼šå‡ºç°ä¸€ä¸ªé¢†å¤´ Sentinelï¼Œæ¯”å¦‚ 10 ä¸ª Sentinel çš„ç³»ç»Ÿä¸­ï¼Œè‡³å°‘éœ€è¦ <code>10/2 + 1 = 6</code> ç¥¨</p></li></ul><p>é€‰ä¸¾è¿‡ç¨‹ï¼š</p><ul><li>ä¸€ä¸ª Sentinel å‘ç›®æ ‡ Sentinel å‘é€ <code>SENTINEL is-master-down-by-addr</code> å‘½ä»¤ï¼Œå‘½ä»¤ä¸­çš„ runid å‚æ•°ä¸æ˜¯ï¼Šç¬¦å·è€Œæ˜¯æº Sentinel çš„è¿è¡Œ IDï¼Œè¡¨ç¤ºæº Sentinel è¦æ±‚ç›®æ ‡ Sentinel å°†è‡ªå·±è®¾ç½®ä¸ºå®ƒçš„å±€éƒ¨é¢†å¤´ Sentinel</li><li>ç›®æ ‡ Sentinel æ¥å—å‘½ä»¤å¤„ç†å®Œæˆåï¼Œå°†è¿”å›ä¸€æ¡å‘½ä»¤å›å¤ï¼Œå›å¤ä¸­çš„ leader_runid å’Œ leader_epoch å‚æ•°åˆ†åˆ«è®°å½•äº†ç›®æ ‡ Sentinel çš„å±€éƒ¨é¢†å¤´ Sentinel çš„è¿è¡Œ ID å’Œé…ç½®çºªå…ƒ</li><li>æº Sentinel æ¥æ”¶ç›®æ ‡ Sentinel å‘½ä»¤å›å¤ä¹‹åï¼Œä¼šåˆ¤æ–­ leader_epoch æ˜¯å¦å’Œè‡ªå·±çš„ç›¸åŒï¼Œç›¸åŒå°±ç»§ç»­åˆ¤æ–­ leader_runid æ˜¯å¦å’Œè‡ªå·±çš„è¿è¡Œ ID ä¸€è‡´ï¼Œæˆç«‹è¡¨ç¤ºç›®æ ‡ Sentinel å°†æº Sentinel è®¾ç½®æˆäº†å±€éƒ¨é¢†å¤´ Sentinelï¼Œå³è·å¾—ä¸€ç¥¨</li><li>å¦‚æœæŸä¸ª Sentinel è¢«åŠæ•°ä»¥ä¸Šçš„ Sentinel è®¾ç½®æˆäº†å±€éƒ¨é¢†å¤´ Sentinelï¼Œé‚£ä¹ˆè¿™ä¸ª Sentinel æˆä¸ºé¢†å¤´ Sentinel</li><li>å¦‚æœåœ¨ç»™å®šæ—¶é™å†…ï¼Œæ²¡æœ‰ä¸€ä¸ª Sentinel è¢«é€‰ä¸¾ä¸ºé¢†å¤´ Sentinelï¼Œé‚£ä¹ˆå„ä¸ª Sentinel å°†åœ¨ä¸€æ®µæ—¶é—´å<strong>å†æ¬¡é€‰ä¸¾</strong>ï¼Œç›´åˆ°é€‰å‡ºé¢†å¤´</li><li>æ¯æ¬¡è¿›è¡Œé¢†å¤´ Sentinel é€‰ä¸¾ä¹‹åï¼Œä¸è®ºé€‰ä¸¾æ˜¯å¦æˆåŠŸï¼Œæ‰€æœ‰ Sentinel çš„é…ç½®çºªå…ƒï¼ˆconfiguration epochï¼‰éƒ½è¦è‡ªå¢ä¸€æ¬¡</li></ul><p>Sentinel é›†ç¾¤è‡³å°‘ 3 ä¸ªèŠ‚ç‚¹çš„åŸå› ï¼š</p><ul><li>å¦‚æœ Sentinel é›†ç¾¤åªæœ‰ 2 ä¸ª Sentinel èŠ‚ç‚¹ï¼Œåˆ™é¢†å¤´é€‰ä¸¾éœ€è¦ <code>2/2 + 1 = 2</code> ç¥¨ï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œé‚£å°±æ°¸è¿œé€‰ä¸å‡ºé¢†å¤´</li><li>Sentinel é›†ç¾¤å…è®¸ 1 ä¸ª Sentinel èŠ‚ç‚¹æ•…éšœåˆ™éœ€è¦ 3 ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œå…è®¸ 2 ä¸ªèŠ‚ç‚¹æ•…éšœåˆ™éœ€è¦ 5 ä¸ªèŠ‚ç‚¹é›†ç¾¤</li></ul><p><strong>å¦‚ä½•è·å–å“¨å…µèŠ‚ç‚¹çš„åŠæ•°æ•°é‡</strong>ï¼Ÿ</p><ul><li>å®¢è§‚ä¸‹çº¿æ˜¯é€šè¿‡é…ç½®æ–‡ä»¶è·å–çš„æ•°é‡ï¼Œè¾¾åˆ° quorum å°±å®¢è§‚ä¸‹çº¿</li><li>å“¨å…µæ•°é‡æ˜¯é€šè¿‡ä¸»èŠ‚ç‚¹æ˜¯å®ä¾‹ç»“æ„ä¸­ï¼Œä¿å­˜ç€ç›‘è§†è¯¥ä¸»èŠ‚ç‚¹çš„æ‰€æœ‰å“¨å…µä¿¡æ¯ï¼Œä»è€Œè·å–å¾—åˆ°</li></ul><hr><h3 id="æ•…éšœè½¬ç§»" tabindex="-1"><a class="header-anchor" href="#æ•…éšœè½¬ç§»" aria-hidden="true">#</a> æ•…éšœè½¬ç§»</h3><h4 id="æ‰§è¡Œæµç¨‹-1" tabindex="-1"><a class="header-anchor" href="#æ‰§è¡Œæµç¨‹-1" aria-hidden="true">#</a> æ‰§è¡Œæµç¨‹</h4><p>é¢†å¤´ Sentinel å°†å¯¹å·²ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œï¼Œè¯¥æ“ä½œåŒ…å«ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤</p><ul><li><p>ä»ä¸‹çº¿ä¸»æœåŠ¡å™¨å±ä¸‹çš„æ‰€æœ‰ä»æœåŠ¡å™¨é‡Œé¢ï¼ŒæŒ‘é€‰å‡ºä¸€ä¸ªä»æœåŠ¡å™¨ï¼Œæ‰§è¡Œ <code>SLAVEOF no one</code>ï¼Œå°†ä»æœåŠ¡å™¨å‡çº§ä¸ºä¸»æœåŠ¡å™¨</p><p>åœ¨å‘é€ SLAVEOF no one å‘½ä»¤åï¼Œé¢†å¤´ Sentinel ä¼šä»¥<strong>æ¯ç§’ä¸€æ¬¡çš„é¢‘ç‡</strong>ï¼ˆä¸€èˆ¬æ˜¯ 10s/æ¬¡ï¼‰å‘è¢«å‡çº§çš„ä»æœåŠ¡å™¨å‘é€ INFO å‘½ä»¤ï¼Œè§‚å¯Ÿå‘½ä»¤å›å¤ä¸­çš„è§’è‰²ä¿¡æ¯ï¼Œå½“è¢«å‡çº§æœåŠ¡å™¨çš„ role ä» slave å˜ä¸º master æ—¶ï¼Œè¯´æ˜ä»æœåŠ¡å™¨å·²ç»é¡ºåˆ©å‡çº§ä¸ºä¸»æœåŠ¡å™¨</p></li><li><p>å°†å·²ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨çš„æ‰€æœ‰ä»æœåŠ¡å™¨æ”¹ä¸ºå¤åˆ¶æ–°çš„ä¸»æœåŠ¡å™¨ï¼Œé€šè¿‡å‘ä»æœåŠ¡å™¨å‘é€ SLAVEOF å‘½ä»¤å®ç°</p></li><li><p>å°†å·²ç»ä¸‹çº¿çš„ä¸»æœåŠ¡å™¨è®¾ç½®ä¸ºæ–°çš„ä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨ï¼Œè®¾ç½®æ˜¯ä¿å­˜åœ¨æœåŠ¡å™¨å¯¹åº”çš„å®ä¾‹ç»“æ„ä¸­ï¼Œå½“æ—§çš„ä¸»æœåŠ¡å™¨é‡æ–°ä¸Šçº¿æ—¶ï¼ŒSentinel å°±ä¼šå‘å®ƒå‘é€ SLAVEOF å‘½ä»¤ï¼Œæˆä¸ºæ–°çš„ä¸»æœåŠ¡å™¨çš„ä»æœåŠ¡å™¨</p></li></ul><p>ç¤ºä¾‹ï¼šsever1 æ˜¯ä¸»ï¼Œsever2ã€sever3ã€sever4 æ˜¯ä»æœåŠ¡å™¨ï¼Œsever1 æ•…éšœåé€‰ä¸­ sever2 å‡çº§</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å“¨å…µæ‰§è¡Œæ•…éšœè½¬ç§».png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h4 id="é€‰æ‹©ç®—æ³•" tabindex="-1"><a class="header-anchor" href="#é€‰æ‹©ç®—æ³•" aria-hidden="true">#</a> é€‰æ‹©ç®—æ³•</h4><p>é¢†å¤´ Sentinel ä¼šå°†å·²ä¸‹çº¿ä¸»æœåŠ¡å™¨çš„æ‰€æœ‰ä»æœåŠ¡å™¨ä¿å­˜åˆ°ä¸€ä¸ªåˆ—è¡¨é‡Œï¼Œç„¶åæŒ‰ç…§ä»¥ä¸‹è§„åˆ™å¯¹åˆ—è¡¨è¿›è¡Œè¿‡æ»¤ï¼Œæœ€åæŒ‘é€‰å‡ºä¸€ä¸ª<strong>çŠ¶æ€è‰¯å¥½ã€æ•°æ®å®Œæ•´</strong>çš„ä»æœåŠ¡å™¨</p><ul><li><p>åˆ é™¤åˆ—è¡¨ä¸­æ‰€æœ‰å¤„äºä¸‹çº¿æˆ–è€…æ–­çº¿çŠ¶æ€çš„ä»æœåŠ¡å™¨ï¼Œä¿è¯åˆ—è¡¨ä¸­çš„ä»æœåŠ¡å™¨éƒ½æ˜¯æ­£å¸¸åœ¨çº¿çš„</p></li><li><p>åˆ é™¤åˆ—è¡¨ä¸­æ‰€æœ‰æœ€è¿‘äº”ç§’å†…æ²¡æœ‰å›å¤è¿‡é¢†å¤´ Sentinel çš„ INFO å‘½ä»¤çš„ä»æœåŠ¡å™¨ï¼Œä¿è¯åˆ—è¡¨ä¸­çš„ä»æœåŠ¡å™¨æœ€è¿‘æˆåŠŸè¿›è¡Œè¿‡é€šä¿¡</p></li><li><p>åˆ é™¤æ‰€æœ‰ä¸å·²ä¸‹çº¿ä¸»æœåŠ¡å™¨è¿æ¥æ–­å¼€è¶…è¿‡ <code>down-after-milliseconds * 10</code> æ¯«ç§’çš„ä»æœåŠ¡å™¨ï¼Œä¿è¯åˆ—è¡¨ä¸­å‰©ä½™çš„ä»æœåŠ¡å™¨éƒ½æ²¡æœ‰è¿‡æ—©åœ°ä¸ä¸»æœåŠ¡å™¨æ–­å¼€è¿æ¥ï¼Œä¿å­˜çš„æ•°æ®éƒ½æ˜¯æ¯”è¾ƒæ–°çš„</p><p>down-after-milliseconds æ—¶é—´ç”¨æ¥åˆ¤æ–­æ˜¯å¦ä¸»è§‚ä¸‹çº¿ï¼Œå…¶ä½™çš„æ—¶é—´å®Œå…¨å¯ä»¥å®Œæˆå®¢è§‚ä¸‹çº¿å’Œé¢†å¤´é€‰ä¸¾</p></li><li><p>æ ¹æ®ä»æœåŠ¡å™¨çš„ä¼˜å…ˆçº§ï¼Œå¯¹åˆ—è¡¨ä¸­å‰©ä½™çš„ä»æœåŠ¡å™¨è¿›è¡Œæ’åºï¼Œå¹¶é€‰å‡ºå…¶ä¸­<strong>ä¼˜å…ˆçº§æœ€é«˜</strong>çš„ä»æœåŠ¡å™¨</p></li><li><p>å¦‚æœæœ‰å¤šä¸ªå…·æœ‰ç›¸åŒæœ€é«˜ä¼˜å…ˆçº§çš„ä»æœåŠ¡å™¨ï¼Œé¢†å¤´ Sentinel å°†å¯¹è¿™äº›ç›¸åŒä¼˜å…ˆçº§çš„æœåŠ¡å™¨æŒ‰ç…§å¤åˆ¶åç§»é‡è¿›è¡Œæ’åºï¼Œé€‰å‡ºå…¶ä¸­åç§»é‡æœ€å¤§çš„ä»æœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯ä¿å­˜ç€æœ€æ–°æ•°æ®çš„ä»æœåŠ¡å™¨</p></li><li><p>å¦‚æœè¿˜æ²¡é€‰å‡ºæ¥ï¼Œå°±æŒ‰ç…§è¿è¡Œ ID å¯¹è¿™äº›ä»æœåŠ¡å™¨è¿›è¡Œæ’åºï¼Œå¹¶é€‰å‡ºå…¶ä¸­è¿è¡Œ ID æœ€å°çš„ä»æœåŠ¡å™¨</p></li></ul><hr><h2 id="é›†ç¾¤æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#é›†ç¾¤æ¨¡å¼" aria-hidden="true">#</a> é›†ç¾¤æ¨¡å¼</h2><h3 id="é›†ç¾¤èŠ‚ç‚¹" tabindex="-1"><a class="header-anchor" href="#é›†ç¾¤èŠ‚ç‚¹" aria-hidden="true">#</a> é›†ç¾¤èŠ‚ç‚¹</h3><h4 id="èŠ‚ç‚¹æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#èŠ‚ç‚¹æ¦‚è¿°" aria-hidden="true">#</a> èŠ‚ç‚¹æ¦‚è¿°</h4><p>Redis é›†ç¾¤æ˜¯ Redis æä¾›çš„åˆ†å¸ƒå¼æ•°æ®åº“æ–¹æ¡ˆï¼Œé›†ç¾¤é€šè¿‡åˆ†ç‰‡ï¼ˆshardingï¼‰æ¥è¿›è¡Œæ•°æ®å…±äº«ï¼Œ å¹¶æä¾›å¤åˆ¶å’Œæ•…éšœè½¬ç§»åŠŸèƒ½ï¼Œä¸€ä¸ª Redis é›†ç¾¤é€šå¸¸ç”±å¤šä¸ªèŠ‚ç‚¹ï¼ˆnodeï¼‰ç»„æˆï¼Œå°†å„ä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹è¿æ¥èµ·æ¥ï¼Œæ„æˆä¸€ä¸ªåŒ…å«å¤šèŠ‚ç‚¹çš„é›†ç¾¤</p><p>ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ª<strong>è¿è¡Œåœ¨é›†ç¾¤æ¨¡å¼ä¸‹çš„ Redis æœåŠ¡å™¨</strong>ï¼ŒRedis åœ¨å¯åŠ¨æ—¶ä¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„ <code>cluster-enabled</code> é…ç½®é€‰é¡¹æ˜¯å¦ä¸º yes æ¥å†³å®šæ˜¯å¦å¼€å¯æœåŠ¡å™¨çš„é›†ç¾¤æ¨¡å¼</p><p>èŠ‚ç‚¹ä¼šç»§ç»­ä½¿ç”¨æ‰€æœ‰åœ¨å•æœºæ¨¡å¼ä¸­ä½¿ç”¨çš„æœåŠ¡å™¨ç»„ä»¶ï¼Œä½¿ç”¨ redisServer ç»“æ„æ¥ä¿å­˜æœåŠ¡å™¨çš„çŠ¶æ€ï¼Œä½¿ç”¨ redisClient ç»“æ„æ¥ä¿å­˜å®¢æˆ·ç«¯çš„çŠ¶æ€ï¼Œä¹Ÿæœ‰é›†ç¾¤ç‰¹æœ‰çš„æ•°æ®ç»“æ„</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-é›†ç¾¤æ¨¡å¼.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h4 id="æ•°æ®ç»“æ„-2" tabindex="-1"><a class="header-anchor" href="#æ•°æ®ç»“æ„-2" aria-hidden="true">#</a> æ•°æ®ç»“æ„</h4><p>æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¿å­˜ç€ä¸€ä¸ªé›†ç¾¤çŠ¶æ€ clusterState ç»“æ„ï¼Œè¿™ä¸ªç»“æ„è®°å½•äº†åœ¨å½“å‰èŠ‚ç‚¹çš„è§†è§’ä¸‹ï¼Œé›†ç¾¤ç›®å‰æ‰€å¤„çš„çŠ¶æ€</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">clusterState</span> <span class="token punctuation">{</span>
    <span class="token comment">// æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„æŒ‡é’ˆ</span>
	clusterNode <span class="token operator">*</span>myself<span class="token punctuation">;</span>
    
	<span class="token comment">// é›†ç¾¤å½“å‰çš„é…ç½®çºªå…ƒï¼Œç”¨äºå®ç°æ•…éšœè½¬ç§»</span>
	<span class="token class-name">uint64_t</span> currentEpoch<span class="token punctuation">;</span>
    
	<span class="token comment">// é›†ç¾¤å½“å‰çš„çŠ¶æ€ï¼Œæ˜¯åœ¨çº¿è¿˜æ˜¯ä¸‹çº¿</span>
	<span class="token keyword">int</span> state<span class="token punctuation">;</span>
    
	<span class="token comment">// é›†ç¾¤ä¸­è‡³å°‘å¤„ç†ç€ä¸€ä¸ªæ§½çš„ï¼ˆä¸»ï¼‰èŠ‚ç‚¹çš„æ•°é‡ï¼Œä¸º0è¡¨ç¤ºé›†ç¾¤ç›®å‰æ²¡æœ‰ä»»ä½•èŠ‚ç‚¹åœ¨å¤„ç†æ§½</span>
    <span class="token comment">// ã€é€‰ä¸¾æ—¶æŠ•ç¥¨æ•°é‡è¶…è¿‡åŠæ•°ï¼Œä»è¿™é‡Œè·å–çš„ã€‘</span>
	<span class="token keyword">int</span> size<span class="token punctuation">;</span>

    <span class="token comment">// é›†ç¾¤èŠ‚ç‚¹åå•ï¼ˆåŒ…æ‹¬ myself èŠ‚ç‚¹ï¼‰ï¼Œå­—å…¸çš„é”®ä¸ºèŠ‚ç‚¹çš„åå­—ï¼Œå­—å…¸çš„å€¼ä¸ºèŠ‚ç‚¹å¯¹åº”çš„clusterNodeç»“æ„ </span>
    dict <span class="token operator">*</span>nodes<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šä½¿ç”¨ clusterNode ç»“æ„è®°å½•å½“å‰çŠ¶æ€ï¼Œå¹¶ä¸ºé›†ç¾¤ä¸­çš„æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬ä¸»èŠ‚ç‚¹å’Œä»èŠ‚ç‚¹ï¼‰éƒ½åˆ›å»ºä¸€ä¸ªç›¸åº”çš„ clusterNode ç»“æ„ï¼Œä»¥æ­¤æ¥è®°å½•å…¶ä»–èŠ‚ç‚¹çš„çŠ¶æ€</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">clusterNode</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ›å»ºèŠ‚ç‚¹çš„æ—¶é—´</span>
    <span class="token class-name">mstime_t</span> ctime<span class="token punctuation">;</span>
    
    <span class="token comment">// èŠ‚ç‚¹çš„åå­—ï¼Œç”± 40 ä¸ªåå…­è¿›åˆ¶å­—ç¬¦ç»„æˆ</span>
    <span class="token keyword">char</span> name<span class="token punctuation">[</span>REDIS_CLUSTER_NAMELEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">// èŠ‚ç‚¹æ ‡è¯†ï¼Œä½¿ç”¨å„ç§ä¸åŒçš„æ ‡è¯†å€¼è®°å½•èŠ‚ç‚¹çš„è§’è‰²ï¼ˆæ¯”å¦‚ä¸»èŠ‚ç‚¹æˆ–è€…ä»èŠ‚ç‚¹ï¼‰ä»¥åŠèŠ‚ç‚¹ç›®å‰æ‰€å¤„çš„çŠ¶æ€ï¼ˆæ¯”å¦‚åœ¨çº¿æˆ–è€…ä¸‹çº¿ï¼‰</span>
    <span class="token keyword">int</span> flags<span class="token punctuation">;</span>
    
    <span class="token comment">// èŠ‚ç‚¹å½“å‰çš„é…ç½®çºªå…ƒï¼Œç”¨äºå®ç°æ•…éšœè½¬ç§»</span>
    <span class="token class-name">uint64_t</span> configEpoch<span class="token punctuation">;</span>
    
    <span class="token comment">// èŠ‚ç‚¹çš„IPåœ°å€</span>
    <span class="token keyword">char</span> ip<span class="token punctuation">[</span>REDIS_IP_STR_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">// èŠ‚ç‚¹çš„ç«¯å£å·</span>
    <span class="token keyword">int</span> port<span class="token punctuation">;</span>
    
    <span class="token comment">// ä¿å­˜è¿æ¥èŠ‚ç‚¹æ‰€éœ€çš„æœ‰å…³ä¿¡æ¯</span>
    clusterLink <span class="token operator">*</span>link<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>clusterNode ç»“æ„çš„ link å±æ€§æ˜¯ä¸€ä¸ª clusterLink ç»“æ„ï¼Œè¯¥ç»“æ„ä¿å­˜äº†è¿æ¥èŠ‚ç‚¹æ‰€éœ€çš„æœ‰å…³ä¿¡æ¯</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">clusterLink</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿æ¥çš„åˆ›å»ºæ—¶é—´ </span>
    <span class="token class-name">mstime_t</span> ctime<span class="token punctuation">;</span>
    
	<span class="token comment">// TCPå¥—æ¥å­—æè¿°ç¬¦</span>
	<span class="token keyword">int</span> fd<span class="token punctuation">;</span>
    
	<span class="token comment">// è¾“å‡ºç¼“å†²åŒºï¼Œä¿å­˜ç€ç­‰å¾…å‘é€ç»™å…¶ä»–èŠ‚ç‚¹çš„æ¶ˆæ¯(message)ã€‚ </span>
    sds sndbuf<span class="token punctuation">;</span>
    
	<span class="token comment">// è¾“å…¥ç¼“å†²åŒºï¼Œä¿å­˜ç€ä»å…¶ä»–èŠ‚ç‚¹æ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚</span>
	sds rcvbuf<span class="token punctuation">;</span>
    
	<span class="token comment">// ä¸è¿™ä¸ªè¿æ¥ç›¸å…³è”çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å°±ä¸ºNULL</span>
	<span class="token keyword">struct</span> <span class="token class-name">clusterNode</span> <span class="token operator">*</span>node<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>redisClient ç»“æ„ä¸­çš„å¥—æ¥å®‡å’Œç¼“å†²åŒºæ˜¯ç”¨äºè¿æ¥å®¢æˆ·ç«¯çš„</li><li>clusterLink ç»“æ„ä¸­çš„å¥—æ¥å®‡å’Œç¼“å†²åŒºåˆ™æ˜¯ç”¨äºè¿æ¥èŠ‚ç‚¹çš„</li></ul><hr><h4 id="meet" tabindex="-1"><a class="header-anchor" href="#meet" aria-hidden="true">#</a> MEET</h4><p>CLUSTER MEET å‘½ä»¤ç”¨æ¥å°† ip å’Œ port æ‰€æŒ‡å®šçš„èŠ‚ç‚¹æ·»åŠ åˆ°æ¥å—å‘½ä»¤çš„èŠ‚ç‚¹æ‰€åœ¨çš„é›†ç¾¤ä¸­</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>CLUSTER MEET <span class="token operator">&lt;</span>ip<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>port<span class="token operator">&gt;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å‡è®¾å‘èŠ‚ç‚¹ A å‘é€ CLUSTER MEET å‘½ä»¤ï¼Œè®©èŠ‚ç‚¹ A å°†å¦ä¸€ä¸ªèŠ‚ç‚¹ B æ·»åŠ åˆ°èŠ‚ç‚¹ A å½“å‰æ‰€åœ¨çš„é›†ç¾¤é‡Œï¼Œæ”¶åˆ°å‘½ä»¤çš„èŠ‚ç‚¹ A å°†ä¸æ ¹æ® ip å’Œ port å‘èŠ‚ç‚¹ B è¿›è¡Œæ¡æ‰‹ï¼ˆhandshakeï¼‰ï¼š</p><ul><li>èŠ‚ç‚¹ A ä¼šä¸ºèŠ‚ç‚¹ B åˆ›å»ºä¸€ä¸ª clusterNode ç»“æ„ï¼Œå¹¶å°†è¯¥ç»“æ„æ·»åŠ åˆ°è‡ªå·±çš„ clusterState.nodes å­—å…¸é‡Œï¼Œç„¶åèŠ‚ç‚¹ A å‘èŠ‚ç‚¹ B <strong>å‘é€ MEET æ¶ˆæ¯</strong>ï¼ˆmessageï¼‰</li><li>èŠ‚ç‚¹ B æ”¶åˆ° MEET æ¶ˆæ¯åï¼ŒèŠ‚ç‚¹ B ä¼šä¸ºèŠ‚ç‚¹ A åˆ›å»ºä¸€ä¸ª clusterNode ç»“æ„ï¼Œå¹¶å°†è¯¥ç»“æ„æ·»åŠ åˆ°è‡ªå·±çš„ clusterState.nodes å­—å…¸é‡Œï¼Œä¹‹åèŠ‚ç‚¹ B å°†å‘èŠ‚ç‚¹ A <strong>è¿”å›ä¸€æ¡ PONG æ¶ˆæ¯</strong></li><li>èŠ‚ç‚¹ A æ”¶åˆ° PONG æ¶ˆæ¯åï¼Œä»£è¡¨èŠ‚ç‚¹ A å¯ä»¥çŸ¥é“èŠ‚ç‚¹ B å·²ç»æˆåŠŸåœ°æ¥æ”¶åˆ°äº†è‡ªå·²å‘é€çš„ MEET æ¶ˆæ¯ï¼Œæ­¤æ—¶èŠ‚ç‚¹ A å°†å‘èŠ‚ç‚¹ B <strong>è¿”å›ä¸€æ¡ PING æ¶ˆæ¯</strong></li><li>èŠ‚ç‚¹ B æ”¶åˆ° PING æ¶ˆæ¯åï¼Œ ä»£è¡¨èŠ‚ç‚¹ B å¯ä»¥çŸ¥é“èŠ‚ç‚¹ A å·²ç»æˆåŠŸåœ°æ¥æ”¶åˆ°äº†è‡ªå·±è¿”å›çš„ PONG æ¶ˆæ¯ï¼Œæ¡æ‰‹å®Œæˆ</li></ul><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-é›†ç¾¤èŠ‚ç‚¹æ¡æ‰‹.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>èŠ‚ç‚¹ A ä¼šå°†èŠ‚ç‚¹ B çš„ä¿¡æ¯é€šè¿‡ Gossip åè®®ä¼ æ’­ç»™é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼Œè®©å…¶ä»–èŠ‚ç‚¹ä¹Ÿä¸èŠ‚ç‚¹ B è¿›è¡Œæ¡æ‰‹ï¼Œæœ€ç»ˆç»è¿‡ä¸€æ®µæ—¶é—´ä¹‹åï¼ŒèŠ‚ç‚¹ B ä¼šè¢«é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹è®¤è¯†</p><hr><h3 id="æ§½æŒ‡æ´¾" tabindex="-1"><a class="header-anchor" href="#æ§½æŒ‡æ´¾" aria-hidden="true">#</a> æ§½æŒ‡æ´¾</h3><h4 id="åŸºæœ¬æ“ä½œ-3" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ“ä½œ-3" aria-hidden="true">#</a> åŸºæœ¬æ“ä½œ</h4><p>Redis é›†ç¾¤é€šè¿‡åˆ†ç‰‡çš„æ–¹å¼æ¥ä¿å­˜æ•°æ®åº“ä¸­çš„é”®å€¼å¯¹ï¼Œé›†ç¾¤çš„æ•´ä¸ªæ•°æ®åº“è¢«åˆ†ä¸º 16384 ä¸ªæ§½ï¼ˆslotï¼‰ï¼Œæ•°æ®åº“ä¸­çš„æ¯ä¸ªé”®éƒ½å±äº 16384 ä¸ªæ§½ä¸­çš„ä¸€ä¸ªï¼Œé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å¯ä»¥å¤„ç† 0 ä¸ªæˆ–æœ€å¤š 16384 ä¸ªæ§½ï¼ˆ<strong>æ¯ä¸ªä¸»èŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®å¹¶ä¸ä¸€æ ·</strong>ï¼‰</p><ul><li>å½“æ•°æ®åº“ä¸­çš„ 16384 ä¸ªæ§½éƒ½æœ‰èŠ‚ç‚¹åœ¨å¤„ç†æ—¶ï¼Œé›†ç¾¤å¤„äºä¸Šçº¿çŠ¶æ€ï¼ˆokï¼‰</li><li>å¦‚æœæ•°æ®åº“ä¸­æœ‰ä»»ä½•ä¸€ä¸ªæ§½å¾—åˆ°å¤„ç†ï¼Œé‚£ä¹ˆé›†ç¾¤å¤„äºä¸‹çº¿çŠ¶æ€ï¼ˆfailï¼‰</li></ul><p>é€šè¿‡å‘èŠ‚ç‚¹å‘é€ CLUSTER ADDSLOTS å‘½ä»¤ï¼Œå¯ä»¥å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ§½æŒ‡æ´¾ï¼ˆassignï¼‰ç»™èŠ‚ç‚¹è´Ÿè´£</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>CLUSTER ADDSLOTS <span class="token operator">&lt;</span>slot<span class="token operator">&gt;</span> <span class="token punctuation">[</span>slot <span class="token punctuation">..</span>. <span class="token punctuation">]</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:700<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> CLUSTER ADDSLOTS <span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token punctuation">..</span>. <span class="token number">5000</span> <span class="token comment"># å°†æ§½0è‡³æ§½5000æŒ‡æ´¾ç»™èŠ‚ç‚¹7000è´Ÿè´£</span>
OK 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å‘½ä»¤æ‰§è¡Œç»†èŠ‚ï¼š</p><ul><li>å¦‚æœå‘½ä»¤å‚æ•°ä¸­æœ‰ä¸€ä¸ªæ§½å·²ç»è¢«æŒ‡æ´¾ç»™äº†æŸä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆä¼šå‘å®¢æˆ·ç«¯è¿”å›é”™è¯¯ï¼Œå¹¶ç»ˆæ­¢å‘½ä»¤æ‰§è¡Œ</li><li>å°† slots æ•°ç»„ä¸­çš„ç´¢å¼• i ä¸Šçš„äºŒè¿›åˆ¶ä½è®¾ç½®ä¸º 1ï¼Œå°±ä»£è¡¨æŒ‡æ´¾æˆåŠŸ</li></ul><hr><h4 id="èŠ‚ç‚¹æŒ‡æ´¾" tabindex="-1"><a class="header-anchor" href="#èŠ‚ç‚¹æŒ‡æ´¾" aria-hidden="true">#</a> èŠ‚ç‚¹æŒ‡æ´¾</h4><p>clusterNode ç»“æ„çš„ slots å±æ€§å’Œ numslot å±æ€§è®°å½•äº†èŠ‚ç‚¹è´Ÿè´£å¤„ç†å“ªäº›æ§½ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">clusterNode</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¤„ç†ä¿¡æ¯ï¼Œä¸€å­—èŠ‚ç­‰äº 8 ä½</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> slots<span class="token punctuation">[</span>l6384<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// è®°å½•èŠ‚ç‚¹è´Ÿè´£å¤„ç†çš„æ§½çš„æ•°é‡ï¼Œå°±æ˜¯ slots æ•°ç»„ä¸­å€¼ä¸º 1 çš„äºŒè¿›åˆ¶ä½æ•°é‡</span>
    <span class="token keyword">int</span> numslots<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>slots æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶ä½æ•°ç»„ï¼ˆbit arrayï¼‰ï¼Œé•¿åº¦ä¸º <code>16384/8 = 2048</code> ä¸ªå­—èŠ‚ï¼ŒåŒ…å« 16384 ä¸ªäºŒè¿›åˆ¶ä½ï¼ŒRedis ä»¥ 0 ä¸ºèµ·å§‹ç´¢å¼•ï¼Œ16383 ä¸ºç»ˆæ­¢ç´¢å¼•ï¼Œå¯¹ slots æ•°ç»„çš„ 16384 ä¸ªäºŒè¿›åˆ¶ä½è¿›è¡Œç¼–å·ï¼Œå¹¶æ ¹æ®ç´¢å¼• i ä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼æ¥åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦è´Ÿè´£å¤„ç†æ§½ iï¼š</p><ul><li>åœ¨ç´¢å¼• i ä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼ä¸º 1ï¼Œé‚£ä¹ˆè¡¨ç¤ºèŠ‚ç‚¹è´Ÿè´£å¤„ç†æ§½ i</li><li>åœ¨ç´¢å¼• i ä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼ä¸º 0ï¼Œé‚£ä¹ˆè¡¨ç¤ºèŠ‚ç‚¹ä¸è´Ÿè´£å¤„ç†æ§½ i</li></ul><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-é›†ç¾¤æ§½æŒ‡æ´¾ä¿¡æ¯.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å–å‡ºå’Œè®¾ç½® slots æ•°ç»„ä¸­çš„ä»»æ„ä¸€ä¸ªäºŒè¿›åˆ¶ä½çš„å€¼çš„<strong>å¤æ‚åº¦ä»…ä¸º O(1)</strong>ï¼Œæ‰€ä»¥å¯¹äºä¸€ä¸ªç»™å®šèŠ‚ç‚¹çš„ slots æ•°ç»„æ¥è¯´ï¼Œæ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦è´Ÿè´£å¤„ç†æŸä¸ªæ§½æˆ–è€…å°†æŸä¸ªæ§½æŒ‡æ´¾ç»™èŠ‚ç‚¹è´Ÿè´£ï¼Œè¿™ä¸¤ä¸ªåŠ¨ä½œçš„å¤æ‚åº¦éƒ½æ˜¯ O(1)</p><p><strong>ä¼ æ’­èŠ‚ç‚¹çš„æ§½æŒ‡æ´¾ä¿¡æ¯</strong>ï¼šä¸€ä¸ªèŠ‚ç‚¹é™¤äº†ä¼šå°†è‡ªå·±è´Ÿè´£å¤„ç†çš„æ§½è®°å½•åœ¨ clusterNode ä¸­ï¼Œè¿˜ä¼šå°†è‡ªå·±çš„ slots æ•°ç»„é€šè¿‡æ¶ˆæ¯å‘é€ç»™é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼Œæ¯ä¸ªæ¥æ”¶åˆ° slots æ•°ç»„çš„èŠ‚ç‚¹éƒ½ä¼šå°†æ•°ç»„ä¿å­˜åˆ°ç›¸åº”èŠ‚ç‚¹çš„ clusterNode ç»“æ„é‡Œé¢ï¼Œå› æ­¤é›†ç¾¤ä¸­çš„<strong>æ¯ä¸ªèŠ‚ç‚¹</strong>éƒ½ä¼šçŸ¥é“æ•°æ®åº“ä¸­çš„ 16384 ä¸ªæ§½åˆ†åˆ«è¢«æŒ‡æ´¾ç»™äº†é›†ç¾¤ä¸­çš„å“ªäº›èŠ‚ç‚¹</p><hr><h4 id="é›†ç¾¤æŒ‡æ´¾" tabindex="-1"><a class="header-anchor" href="#é›†ç¾¤æŒ‡æ´¾" aria-hidden="true">#</a> é›†ç¾¤æŒ‡æ´¾</h4><p>é›†ç¾¤çŠ¶æ€ clusterState ç»“æ„ä¸­çš„ slots æ•°ç»„è®°å½•äº†é›†ç¾¤ä¸­æ‰€æœ‰ 16384 ä¸ªæ§½çš„æŒ‡æ´¾ä¿¡æ¯ï¼Œæ•°ç»„æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘ clusterNode çš„æŒ‡é’ˆ</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">clusterState</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    clusterNode <span class="token operator">*</span>slots<span class="token punctuation">[</span><span class="token number">16384</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>å¦‚æœ slots[i] æŒ‡é’ˆæŒ‡å‘ NULLï¼Œé‚£ä¹ˆè¡¨ç¤ºæ§½ i å°šæœªæŒ‡æ´¾ç»™ä»»ä½•èŠ‚ç‚¹</li><li>å¦‚æœ slots[i] æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ª clusterNode ç»“æ„ï¼Œé‚£ä¹ˆè¡¨ç¤ºæ§½ i å·²ç»æŒ‡æ´¾ç»™è¯¥èŠ‚ç‚¹æ‰€ä»£è¡¨çš„èŠ‚ç‚¹</li></ul><p>é€šè¿‡è¯¥èŠ‚ç‚¹ï¼Œç¨‹åºæ£€æŸ¥æ§½ i æ˜¯å¦å·²ç»è¢«æŒ‡æ´¾æˆ–è€…å–å¾—è´Ÿè´£å¤„ç†æ§½ i çš„èŠ‚ç‚¹ï¼Œåªéœ€è¦è®¿é—® clusterState. slots[i] å³å¯ï¼Œæ—¶é—´å¤æ‚åº¦ä»…ä¸º O(1)</p><hr><h4 id="é›†ç¾¤æ•°æ®" tabindex="-1"><a class="header-anchor" href="#é›†ç¾¤æ•°æ®" aria-hidden="true">#</a> é›†ç¾¤æ•°æ®</h4><p>é›†ç¾¤èŠ‚ç‚¹ä¿å­˜é”®å€¼å¯¹ä»¥åŠé”®å€¼å¯¹è¿‡æœŸæ—¶é—´çš„æ–¹å¼ï¼Œä¸å•æœº Redis æœåŠ¡å™¨ä¿å­˜é”®å€¼å¯¹ä»¥åŠé”®å€¼å¯¹è¿‡æœŸæ—¶é—´çš„æ–¹å¼å®Œå…¨ç›¸åŒï¼Œä½†æ˜¯<strong>é›†ç¾¤èŠ‚ç‚¹åªèƒ½ä½¿ç”¨ 0 å·æ•°æ®åº“</strong>ï¼Œå•æœºæœåŠ¡å™¨å¯ä»¥ä»»æ„ä½¿ç”¨</p><p>é™¤äº†å°†é”®å€¼å¯¹ä¿å­˜åœ¨æ•°æ®åº“é‡Œé¢ä¹‹å¤–ï¼ŒèŠ‚ç‚¹è¿˜ä¼šç”¨ clusterState ç»“æ„ä¸­çš„ slots_to_keys è·³è·ƒè¡¨æ¥<strong>ä¿å­˜æ§½å’Œé”®ä¹‹é—´çš„å…³ç³»</strong></p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">clusterState</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    zskiplist <span class="token operator">*</span>slots_to_keys<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>slots_to_keys è·³è·ƒè¡¨æ¯ä¸ªèŠ‚ç‚¹çš„åˆ†å€¼ï¼ˆscoreï¼‰éƒ½æ˜¯ä¸€ä¸ªæ§½å·ï¼Œè€Œæ¯ä¸ªèŠ‚ç‚¹çš„æˆå‘˜ï¼ˆmemberï¼‰éƒ½æ˜¯ä¸€ä¸ªæ•°æ®åº“é”®ï¼ˆæŒ‰æ§½å·å‡åºï¼‰</p><ul><li>å½“èŠ‚ç‚¹å¾€æ•°æ®åº“ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„é”®å€¼å¯¹æ—¶ï¼ŒèŠ‚ç‚¹å°±ä¼šå°†è¿™ä¸ªé”®ä»¥åŠé”®çš„æ§½å·å…³è”åˆ° slots_to_keys è·³è·ƒè¡¨</li><li>å½“èŠ‚ç‚¹åˆ é™¤æ•°æ®åº“ä¸­çš„æŸä¸ªé”®å€¼å¯¹æ—¶ï¼ŒèŠ‚ç‚¹å°±ä¼šåœ¨ slots_to_keys è·³è·ƒè¡¨è§£é™¤è¢«åˆ é™¤é”®ä¸æ§½å·çš„å…³è”</li></ul><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-æ§½å’Œé”®è·³è·ƒè¡¨.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>é€šè¿‡åœ¨ slots_to_keys è·³è·ƒè¡¨ä¸­è®°å½•å„ä¸ªæ•°æ®åº“é”®æ‰€å±çš„æ§½ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å¯¹å±äºæŸä¸ªæˆ–æŸäº›æ§½çš„æ‰€æœ‰æ•°æ®åº“é”®è¿›è¡Œæ‰¹é‡æ“ä½œï¼Œæ¯”å¦‚ <code>CLUSTER GETKEYSINSLOT &lt;slot&gt; &lt;count&gt;</code> å‘½ä»¤è¿”å›æœ€å¤š count ä¸ªå±äºæ§½ slot çš„æ•°æ®åº“é”®ï¼Œå°±æ˜¯é€šè¿‡è¯¥è·³è¡¨å®ç°</p><hr><h3 id="é›†ç¾¤å‘½ä»¤" tabindex="-1"><a class="header-anchor" href="#é›†ç¾¤å‘½ä»¤" aria-hidden="true">#</a> é›†ç¾¤å‘½ä»¤</h3><h4 id="æ‰§è¡Œå‘½ä»¤" tabindex="-1"><a class="header-anchor" href="#æ‰§è¡Œå‘½ä»¤" aria-hidden="true">#</a> æ‰§è¡Œå‘½ä»¤</h4><p>é›†ç¾¤å¤„äºä¸Šçº¿çŠ¶æ€ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥å‘é›†ç¾¤ä¸­çš„èŠ‚ç‚¹å‘é€å‘½ä»¤ï¼ˆ16384 ä¸ªæ§½å…¨éƒ¨æŒ‡æ´¾å°±è¿›å…¥ä¸Šçº¿çŠ¶æ€ï¼‰</p><p>å½“å®¢æˆ·ç«¯å‘èŠ‚ç‚¹å‘é€ä¸æ•°æ®åº“é”®æœ‰å…³çš„å‘½ä»¤æ—¶ï¼Œæ¥æ”¶å‘½ä»¤çš„èŠ‚ç‚¹ä¼šè®¡ç®—å‡ºå‘½ä»¤è¯¥é”®å±äºå“ªä¸ªæ§½ï¼Œå¹¶æ£€æŸ¥è¿™ä¸ªæ§½æ˜¯å¦æŒ‡æ´¾ç»™äº†è‡ªå·±</p><ul><li>å¦‚æœé”®æ‰€åœ¨çš„æ§½æ­£å¥½å°±æŒ‡æ´¾ç»™äº†å½“å‰èŠ‚ç‚¹ï¼Œé‚£ä¹ˆèŠ‚ç‚¹ç›´æ¥æ‰§è¡Œè¿™ä¸ªå‘½ä»¤</li><li>åä¹‹ï¼ŒèŠ‚ç‚¹ä¼šå‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ª MOVED é”™è¯¯ï¼ŒæŒ‡å¼•å®¢æˆ·ç«¯è½¬å‘ï¼ˆredirectï¼‰è‡³æ­£ç¡®çš„èŠ‚ç‚¹ï¼Œå†æ¬¡å‘é€è¯¥å‘½ä»¤</li></ul><p>è®¡ç®—é”®å½’å±å“ªä¸ªæ§½çš„<strong>å¯»å€ç®—æ³•</strong>ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>def <span class="token function">slot_number</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">:</span> 			<span class="token comment">// CRC16(key) è¯­å¥è®¡ç®—é”® key çš„ CRC-16 æ ¡éªŒå’Œ</span>
	<span class="token keyword">return</span> <span class="token function">CRC16</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">16383</span><span class="token punctuation">;</span>	<span class="token comment">// å–æ¨¡ï¼Œåè¿›åˆ¶å¯¹16384çš„å–ä½™</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½¿ç”¨ <code>CLUSTER KEYSLOT &lt;key&gt;</code> å‘½ä»¤å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªç»™å®šé”®å±äºå“ªä¸ªæ§½ï¼Œåº•å±‚å®ç°ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>def <span class="token function">CLUSTER_KEYSLOT</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token operator">:</span>
	<span class="token comment">// è®¡ç®—æ§½å·</span>
	slot <span class="token operator">=</span> <span class="token function">slot_number</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// å°†æ§½å·è¿”å›ç»™å®¢æˆ·ç«¯</span>
	<span class="token function">reply_client</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ¤æ–­æ§½æ˜¯å¦ç”±å½“å‰èŠ‚ç‚¹è´Ÿè´£å¤„ç†ï¼šå¦‚æœ clusterState.slots[i] ä¸ç­‰äº clusterState.myselfï¼Œé‚£ä¹ˆè¯´æ˜æ§½ i å¹¶éç”±å½“å‰èŠ‚ç‚¹è´Ÿè´£ï¼ŒèŠ‚ç‚¹ä¼šæ ¹æ® clusterState.slots[i] æŒ‡å‘çš„ clusterNode ç»“æ„æ‰€è®°å½•çš„èŠ‚ç‚¹ IP å’Œç«¯å£å·ï¼Œå‘å®¢æˆ·ç«¯è¿”å› MOVED é”™è¯¯</p><hr><h4 id="moved" tabindex="-1"><a class="header-anchor" href="#moved" aria-hidden="true">#</a> MOVED</h4><p>MOVED é”™è¯¯çš„æ ¼å¼ä¸ºï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>MOVED <span class="token operator">&lt;</span>slot<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>ip<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>portï¼
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å‚æ•° slot ä¸ºé”®æ‰€åœ¨çš„æ§½ï¼Œip å’Œ port æ˜¯è´Ÿè´£å¤„ç†æ§½ slot çš„èŠ‚ç‚¹çš„ ip åœ°å€å’Œç«¯å£å·</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>MOVED <span class="token number">12345</span> <span class="token number">127.0</span>.0.1:6380 <span class="token comment"># è¡¨ç¤ºæ§½ 12345 æ­£ç”± IPåœ°å€ä¸º 127.0.0.1, ç«¯å£å·ä¸º 6380 çš„èŠ‚ç‚¹è´Ÿè´£</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å½“å®¢æˆ·ç«¯æ¥æ”¶åˆ°èŠ‚ç‚¹è¿”å›çš„ MOVED é”™è¯¯æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šæ ¹æ® MOVED é”™è¯¯ä¸­æä¾›çš„ IP åœ°å€å’Œç«¯å£å·ï¼Œè½¬è‡³è´Ÿè´£å¤„ç†æ§½ slot çš„èŠ‚ç‚¹é‡æ–°å‘é€æ‰§è¡Œçš„å‘½ä»¤</p><ul><li><p>ä¸€ä¸ªé›†ç¾¤å®¢æˆ·ç«¯é€šå¸¸ä¼šä¸é›†ç¾¤ä¸­çš„å¤šä¸ªèŠ‚ç‚¹åˆ›å»ºå¥—æ¥å­—è¿æ¥ï¼ŒèŠ‚ç‚¹è½¬å‘å®é™…ä¸Šå°±æ˜¯æ¢ä¸€ä¸ªå¥—æ¥å­—æ¥å‘é€å‘½ä»¤</p></li><li><p>å¦‚æœå®¢æˆ·ç«¯å°šæœªä¸è½¬å‘çš„èŠ‚ç‚¹åˆ›å»ºå¥—æ¥å­—è¿æ¥ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¼šå…ˆæ ¹æ® IP åœ°å€å’Œç«¯å£å·æ¥è¿æ¥èŠ‚ç‚¹ï¼Œç„¶åå†è¿›è¡Œè½¬å‘</p></li></ul><p>é›†ç¾¤æ¨¡å¼çš„ redis-cli åœ¨æ¥æ”¶åˆ° MOVED é”™è¯¯æ—¶ï¼Œå¹¶ä¸ä¼šæ‰“å°å‡º MOVED é”™è¯¯ï¼Œè€Œæ˜¯æ ¹æ®é”™è¯¯<strong>è‡ªåŠ¨è¿›è¡ŒèŠ‚ç‚¹è½¬å‘</strong>ï¼Œå¹¶æ‰“å°å‡ºè½¬å‘ä¿¡æ¯ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ redis-cli <span class="token parameter variable">-c</span> <span class="token parameter variable">-p</span> <span class="token number">6379</span> 	<span class="token comment">#é›†ç¾¤æ¨¡å¼</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> SET msg <span class="token string">&quot;happy&quot;</span> 
-<span class="token operator">&gt;</span> Redirected to slot <span class="token punctuation">[</span><span class="token number">6257</span><span class="token punctuation">]</span> located at <span class="token number">127.0</span>.0.1:6380
OK 

<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½¿ç”¨å•æœºï¼ˆstand aloneï¼‰æ¨¡å¼çš„ redis-cli ä¼šæ‰“å°é”™è¯¯ï¼Œå› ä¸ºå•æœºæ¨¡å¼å®¢æˆ·ç«¯ä¸æ¸…æ¥š MOVED é”™è¯¯çš„ä½œç”¨ï¼Œä¸ä¼šè¿›è¡Œè‡ªåŠ¨è½¬å‘ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>$ redis-cli <span class="token parameter variable">-c</span> <span class="token parameter variable">-p</span> <span class="token number">6379</span> 	<span class="token comment">#é›†ç¾¤æ¨¡å¼</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> SET msg <span class="token string">&quot;happy&quot;</span> 
<span class="token punctuation">(</span>error<span class="token punctuation">)</span> MOVED <span class="token number">6257</span> <span class="token number">127.0</span>.0.1:6380

<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="é‡æ–°åˆ†ç‰‡" tabindex="-1"><a class="header-anchor" href="#é‡æ–°åˆ†ç‰‡" aria-hidden="true">#</a> é‡æ–°åˆ†ç‰‡</h3><h4 id="å®ç°åŸç†-1" tabindex="-1"><a class="header-anchor" href="#å®ç°åŸç†-1" aria-hidden="true">#</a> å®ç°åŸç†</h4><p>Redis é›†ç¾¤çš„é‡æ–°åˆ†ç‰‡æ“ä½œå¯ä»¥å°†ä»»æ„æ•°é‡å·²ç»æŒ‡æ´¾ç»™æŸä¸ªèŠ‚ç‚¹ï¼ˆæºèŠ‚ç‚¹ï¼‰çš„æ§½æ”¹ä¸ºæŒ‡æ´¾ç»™å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆç›®æ ‡èŠ‚ç‚¹ï¼‰ï¼Œå¹¶ä¸”ç›¸å…³æ§½çš„é”®å€¼å¯¹ä¹Ÿä¼šä»æºèŠ‚ç‚¹è¢«ç§»åŠ¨åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œè¯¥æ“ä½œæ˜¯å¯ä»¥åœ¨çº¿ï¼ˆonlineï¼‰è¿›è¡Œï¼Œåœ¨é‡æ–°åˆ†ç‰‡çš„è¿‡ç¨‹ä¸­æºèŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹éƒ½å¯ä»¥å¤„ç†å‘½ä»¤è¯·æ±‚</p><p>Redis çš„é›†ç¾¤ç®¡ç†è½¯ä»¶ redis-trib è´Ÿè´£æ‰§è¡Œé‡æ–°åˆ†ç‰‡æ“ä½œï¼Œredis-trib é€šè¿‡å‘æºèŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹å‘é€å‘½ä»¤æ¥è¿›è¡Œé‡æ–°åˆ†ç‰‡æ“ä½œ</p><ul><li>å‘ç›®æ ‡èŠ‚ç‚¹å‘é€ <code>CLUSTER SETSLOT &lt;slot&gt; IMPORTING &lt;source_id&gt;</code> å‘½ä»¤ï¼Œå‡†å¤‡å¥½ä»æºèŠ‚ç‚¹å¯¼å…¥å±äºæ§½ slot çš„é”®å€¼å¯¹</li><li>å‘æºèŠ‚ç‚¹å‘é€ <code>CLUSTER SETSLOT &lt;slot&gt; MIGRATING &lt;target_id&gt;</code> å‘½ä»¤ï¼Œè®©æºèŠ‚ç‚¹å‡†å¤‡å¥½å°†å±äºæ§½ slot çš„é”®å€¼å¯¹è¿ç§»</li><li>redis-trib å‘æºèŠ‚ç‚¹å‘é€ <code>CLUSTER GETKEYSINSLOT &lt;slot&gt; &lt;count&gt;</code> å‘½ä»¤ï¼Œè·å¾—æœ€å¤š count ä¸ªå±äºæ§½ slot çš„é”®å€¼å¯¹çš„é”®å</li><li>å¯¹äºæ¯ä¸ª keyï¼Œredis-trib éƒ½å‘æºèŠ‚ç‚¹å‘é€ä¸€ä¸ª <code>MIGRATE &lt;target_ip&gt; &lt;target_port&gt; &lt;key_name&gt; 0 &lt;timeoutï¼</code> å‘½ä»¤ï¼Œå°†è¢«é€‰ä¸­çš„é”®<strong>åŸå­åœ°</strong>ä»æºèŠ‚ç‚¹è¿ç§»è‡³ç›®æ ‡èŠ‚ç‚¹</li><li>é‡å¤ä¸Šè¿°æ­¥éª¤ï¼Œç›´åˆ°æºèŠ‚ç‚¹ä¿å­˜çš„æ‰€æœ‰æ§½ slot çš„é”®å€¼å¯¹éƒ½è¢«è¿ç§»è‡³ç›®æ ‡èŠ‚ç‚¹ä¸ºæ­¢</li><li>redis-trib å‘é›†ç¾¤ä¸­çš„ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹å‘é€ <code>CLUSTER SETSLOT &lt;slot&gt; NODE &lt;target _id&gt;</code> å‘½ä»¤ï¼Œå°†æ§½ slot æŒ‡æ´¾ç»™ç›®æ ‡èŠ‚ç‚¹ï¼Œè¿™ä¸€æŒ‡æ´¾ä¿¡æ¯ä¼šé€šè¿‡æ¶ˆæ¯ä¼ æ’­è‡³æ•´ä¸ªé›†ç¾¤ï¼Œæœ€ç»ˆé›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½ç›´åˆ°æ§½ slot å·²ç»æŒ‡æ´¾ç»™äº†ç›®æ ‡èŠ‚ç‚¹</li></ul><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-é›†ç¾¤é‡æ–°åˆ†ç‰‡.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å¦‚æœé‡æ–°åˆ†ç‰‡æ¶‰åŠå¤šä¸ªæ§½ï¼Œé‚£ä¹ˆ redis-trib å°†å¯¹æ¯ä¸ªç»™å®šçš„æ§½åˆ†åˆ«æ‰§è¡Œä¸Šé¢ç»™å‡ºçš„æ­¥éª¤</p><hr><h4 id="å‘½ä»¤åŸç†" tabindex="-1"><a class="header-anchor" href="#å‘½ä»¤åŸç†" aria-hidden="true">#</a> å‘½ä»¤åŸç†</h4><p>clusterState ç»“æ„çš„ importing_slots_from æ•°ç»„è®°å½•äº†å½“å‰èŠ‚ç‚¹æ­£åœ¨ä»å…¶ä»–èŠ‚ç‚¹å¯¼å…¥çš„æ§½ï¼Œmigrating_slots_to æ•°ç»„è®°å½•äº†å½“å‰èŠ‚ç‚¹æ­£åœ¨è¿ç§»è‡³å…¶ä»–èŠ‚ç‚¹çš„æ§½ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">clusterState</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœ importing_slots_from[i] çš„å€¼ä¸ä¸º NULLï¼Œè€Œæ˜¯æŒ‡å‘ä¸€ä¸ª clusterNode ç»“æ„ï¼Œ</span>
    <span class="token comment">// é‚£ä¹ˆè¡¨ç¤ºå½“å‰èŠ‚ç‚¹æ­£åœ¨ä» clusterNode æ‰€ä»£è¡¨çš„èŠ‚ç‚¹å¯¼å…¥æ§½ i</span>
    clusterNode <span class="token operator">*</span>importing_slots_from<span class="token punctuation">[</span><span class="token number">16384</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">// è¡¨ç¤ºå½“å‰èŠ‚ç‚¹æ­£åœ¨å°†æ§½ i è¿ç§»è‡³ clusterNode æ‰€ä»£è¡¨çš„èŠ‚ç‚¹</span>
    clusterNode <span class="token operator">*</span>migrating_slots_to<span class="token punctuation">[</span><span class="token number">16384</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>CLUSTER SETSLOT &lt;slot&gt; IMPORTING &lt;source_id&gt;</code> å‘½ä»¤ï¼šå°†ç›®æ ‡èŠ‚ç‚¹ <code>clusterState.importing_slots_from[slot]</code> çš„å€¼è®¾ç½®ä¸º source_id æ‰€ä»£è¡¨èŠ‚ç‚¹çš„ clusterNode ç»“æ„</p><p><code>CLUSTER SETSLOT &lt;slot&gt; MIGRATING &lt;target_id&gt;</code> å‘½ä»¤ï¼šå°†æºèŠ‚ç‚¹ <code>clusterState.migrating_slots_to[slot]</code> çš„å€¼è®¾ç½®ä¸ºtarget_id æ‰€ä»£è¡¨èŠ‚ç‚¹çš„ clusterNode ç»“æ„</p><hr><h4 id="ask-é”™è¯¯" tabindex="-1"><a class="header-anchor" href="#ask-é”™è¯¯" aria-hidden="true">#</a> ASK é”™è¯¯</h4><p>é‡æ–°åˆ†ç‰‡æœŸé—´ï¼ŒæºèŠ‚ç‚¹å‘ç›®æ ‡èŠ‚ç‚¹è¿ç§»ä¸€ä¸ªæ§½çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å‡ºç°è¢«è¿ç§»æ§½çš„ä¸€éƒ¨åˆ†é”®å€¼å¯¹ä¿å­˜åœ¨æºèŠ‚ç‚¹ï¼Œå¦ä¸€éƒ¨åˆ†ä¿å­˜åœ¨ç›®æ ‡èŠ‚ç‚¹</p><p>å®¢æˆ·ç«¯å‘æºèŠ‚ç‚¹å‘é€å‘½ä»¤è¯·æ±‚ï¼Œå¹¶ä¸”å‘½ä»¤è¦å¤„ç†çš„æ•°æ®åº“é”®å±äºè¢«è¿ç§»çš„æ§½ï¼š</p><ul><li><p>æºèŠ‚ç‚¹ä¼šå…ˆåœ¨æ•°æ®åº“é‡Œé¢æŸ¥æ‰¾æŒ‡å®šé”®ï¼Œå¦‚æœæ‰¾åˆ°çš„è¯ï¼Œå°±ç›´æ¥æ‰§è¡Œå®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤</p></li><li><p>æœªæ‰¾åˆ°ä¼šæ£€æŸ¥ clusterState.migrating_slots_to[slot]ï¼Œçœ‹é”® key æ‰€å±çš„æ§½ slot æ˜¯å¦æ­£åœ¨è¿›è¡Œè¿ç§»</p></li><li><p>æ§½ slot æ­£åœ¨è¿ç§»åˆ™æºèŠ‚ç‚¹å°†å‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ª ASK é”™è¯¯ï¼ŒæŒ‡å¼•å®¢æˆ·ç«¯è½¬å‘æ­£åœ¨å¯¼å…¥æ§½çš„ç›®æ ‡èŠ‚ç‚¹</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>ASK <span class="token operator">&lt;</span>slot<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>ip:port<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>æ¥åˆ° ASK é”™è¯¯çš„å®¢æˆ·ç«¯ï¼Œä¼šæ ¹æ®é”™è¯¯æä¾›çš„ IP åœ°å€å’Œç«¯å£å·è½¬å‘ç›®æ ‡èŠ‚ç‚¹ï¼Œé¦–å…ˆå‘ç›®æ ‡èŠ‚ç‚¹å‘é€ä¸€ä¸ª ASKING å‘½ä»¤ï¼Œå†é‡æ–°å‘é€åŸæœ¬æƒ³è¦æ‰§è¡Œçš„å‘½ä»¤</p></li></ul><p>å’Œ MOVED é”™è¯¯æƒ…å†µç±»ä¼¼ï¼Œé›†ç¾¤æ¨¡å¼çš„ redis-cli åœ¨æ¥åˆ° ASK é”™è¯¯æ—¶ä¸ä¼šæ‰“å°é”™è¯¯è¿›è¡Œè‡ªåŠ¨è½¬å‘ï¼›å•æœºæ¨¡å¼çš„ redis-cli ä¼šæ‰“å°é”™è¯¯</p><p>å¯¹æ¯” MOVED é”™è¯¯ï¼š</p><ul><li><p>MOVED é”™è¯¯ä»£è¡¨æ§½çš„è´Ÿè´£æƒå·²ç»ä»ä¸€ä¸ªèŠ‚ç‚¹è½¬ç§»åˆ°äº†å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè½¬å‘æ˜¯ä¸€ç§æŒä¹…æ€§çš„è½¬å‘</p></li><li><p>ASK é”™è¯¯åªæ˜¯ä¸¤ä¸ªèŠ‚ç‚¹åœ¨è¿ç§»æ§½çš„è¿‡ç¨‹ä¸­ä½¿ç”¨çš„ä¸€ç§ä¸´æ—¶æªæ–½ï¼ŒASK çš„è½¬å‘ä¸ä¼šå¯¹å®¢æˆ·ç«¯ä»Šåå‘é€å…³äºæ§½ slot çš„å‘½ä»¤è¯·æ±‚äº§ç”Ÿä»»ä½•å½±å“ï¼Œå®¢æˆ·ç«¯ä»ç„¶ä¼šå°†æ§½ slot çš„å‘½ä»¤è¯·æ±‚å‘é€è‡³ç›®å‰è´Ÿè´£å¤„ç†æ§½ slot çš„èŠ‚ç‚¹ï¼Œé™¤é ASK é”™è¯¯å†æ¬¡å‡ºç°</p></li></ul><hr><h4 id="asking" tabindex="-1"><a class="header-anchor" href="#asking" aria-hidden="true">#</a> ASKING</h4><p>å®¢æˆ·ç«¯ä¸å‘é€ ASKING å‘½ä»¤ï¼Œè€Œæ˜¯ç›´æ¥å‘é€æ‰§è¡Œçš„å‘½ä»¤ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤å°†è¢«èŠ‚ç‚¹æ‹’ç»æ‰§è¡Œï¼Œå¹¶è¿”å› MOVED é”™è¯¯</p><p>ASKING å‘½ä»¤ä½œç”¨æ˜¯æ‰“å¼€å‘é€è¯¥å‘½ä»¤çš„å®¢æˆ·ç«¯çš„ REDIS_ASKING æ ‡è¯†ï¼Œè¯¥å‘½ä»¤çš„ä¼ªä»£ç å®ç°ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code>def <span class="token function">ASKING</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
    <span class="token comment">// æ‰“å¼€æ ‡è¯†</span>
    client<span class="token punctuation">.</span>flags <span class="token operator">|=</span> REDIS_ASKING 
    <span class="token comment">// å‘å®¢æˆ·ç«¯è¿”å›OKå›å¤</span>
    <span class="token function">reply</span><span class="token punctuation">(</span><span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“å‰èŠ‚ç‚¹æ­£åœ¨å¯¼å…¥æ§½ slotï¼Œå¹¶ä¸”å‘é€å‘½ä»¤çš„å®¢æˆ·ç«¯å¸¦æœ‰ REDIS_ASKING æ ‡è¯†ï¼Œé‚£ä¹ˆèŠ‚ç‚¹å°†ç ´ä¾‹æ‰§è¡Œè¿™ä¸ªå…³äºæ§½ slot çš„å‘½ä»¤ä¸€æ¬¡</p><p>å®¢æˆ·ç«¯çš„ REDIS_ASKING æ ‡è¯†æ˜¯ä¸€æ¬¡æ€§æ ‡è¯†ï¼Œå½“èŠ‚ç‚¹æ‰§è¡Œäº†ä¸€ä¸ªå¸¦æœ‰ REDIS_ASKING æ ‡è¯†çš„å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤ä¹‹åï¼Œè¯¥å®¢æˆ·ç«¯çš„ REDIS_ASKING æ ‡è¯†å°±ä¼šè¢«ç§»é™¤</p><hr><h3 id="é«˜å¯ç”¨" tabindex="-1"><a class="header-anchor" href="#é«˜å¯ç”¨" aria-hidden="true">#</a> é«˜å¯ç”¨</h3><h4 id="èŠ‚ç‚¹å¤åˆ¶" tabindex="-1"><a class="header-anchor" href="#èŠ‚ç‚¹å¤åˆ¶" aria-hidden="true">#</a> èŠ‚ç‚¹å¤åˆ¶</h4><p>Redis é›†ç¾¤ä¸­çš„èŠ‚ç‚¹åˆ†ä¸ºä¸»èŠ‚ç‚¹ï¼ˆmasterï¼‰å’Œä»èŠ‚ç‚¹ï¼ˆslaveï¼‰ï¼Œå…¶ä¸­ä¸»èŠ‚ç‚¹ç”¨äºå¤„ç†æ§½ï¼Œè€Œä»èŠ‚ç‚¹åˆ™ç”¨äºå¤åˆ¶ä¸»èŠ‚ç‚¹ï¼Œå¹¶åœ¨è¢«å¤åˆ¶çš„ä¸»èŠ‚ç‚¹ä¸‹çº¿æ—¶ï¼Œä»£æ›¿ä¸‹çº¿ä¸»èŠ‚ç‚¹ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>CLUSTER REPLICATE <span class="token operator">&lt;</span>node_id<span class="token operator">&gt;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å‘ä¸€ä¸ªèŠ‚ç‚¹å‘é€å‘½ä»¤å¯ä»¥è®©æ¥æ”¶å‘½ä»¤çš„èŠ‚ç‚¹æˆä¸º node_id æ‰€æŒ‡å®šèŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼Œå¹¶å¼€å§‹å¯¹ä¸»èŠ‚ç‚¹è¿›è¡Œå¤åˆ¶</p><ul><li><p>æ¥å—å‘½ä»¤çš„èŠ‚ç‚¹é¦–å…ˆä¼šåœ¨çš„ clusterState.nodes å­—å…¸ä¸­æ‰¾åˆ° node_id æ‰€å¯¹åº”èŠ‚ç‚¹çš„ clusterNode ç»“æ„ï¼Œå¹¶å°†è‡ªå·±çš„èŠ‚ç‚¹ä¸­çš„ clusterState.myself.slaveof æŒ‡é’ˆæŒ‡å‘è¿™ä¸ªç»“æ„ï¼Œè®°å½•è¿™ä¸ªèŠ‚ç‚¹æ­£åœ¨å¤åˆ¶çš„ä¸»èŠ‚ç‚¹</p></li><li><p>èŠ‚ç‚¹ä¼šä¿®æ”¹ clusterState.myself.flags ä¸­çš„å±æ€§ï¼Œå…³é—­ REDIS_NODE_MASTER æ ‡è¯†ï¼Œæ‰“å¼€ REDIS_NODE_SLAVE æ ‡è¯†</p></li><li><p>èŠ‚ç‚¹ä¼šè°ƒç”¨å¤åˆ¶ä»£ç ï¼Œå¯¹ä¸»èŠ‚ç‚¹è¿›è¡Œå¤åˆ¶ï¼ˆèŠ‚ç‚¹çš„å¤åˆ¶åŠŸèƒ½å’Œå•æœº Redis æœåŠ¡å™¨çš„ä½¿ç”¨äº†ç›¸åŒçš„ä»£ç ï¼‰</p></li></ul><p>ä¸€ä¸ªèŠ‚ç‚¹æˆä¸ºä»èŠ‚ç‚¹ï¼Œå¹¶å¼€å§‹å¤åˆ¶æŸä¸ªä¸»èŠ‚ç‚¹è¿™ä¸€ä¿¡æ¯ä¼šé€šè¿‡æ¶ˆæ¯å‘é€ç»™é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ï¼Œæœ€ç»ˆé›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šçŸ¥é“æŸä¸ªä»èŠ‚ç‚¹æ­£åœ¨å¤åˆ¶æŸä¸ªä¸»èŠ‚ç‚¹</p><p>ä¸»èŠ‚ç‚¹çš„ clusterNode ç»“æ„çš„ slaves å±æ€§å’Œ numslaves å±æ€§ä¸­è®°å½•æ­£åœ¨å¤åˆ¶è¿™ä¸ªä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹åå•ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">clusterNode</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ­£åœ¨å¤åˆ¶è¿™ä¸ªä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹æ•°é‡</span>
    <span class="token keyword">int</span> numslaves<span class="token punctuation">;</span>
    
    <span class="token comment">// æ•°ç»„é¡¹æŒ‡å‘ä¸€ä¸ªæ­£åœ¨å¤åˆ¶è¿™ä¸ªä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹çš„clusterNodeç»“æ„</span>
    <span class="token keyword">struct</span> <span class="token class-name">clusterNode</span> <span class="token operator">*</span><span class="token operator">*</span>slaves<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="æ•…éšœæ£€æµ‹" tabindex="-1"><a class="header-anchor" href="#æ•…éšœæ£€æµ‹" aria-hidden="true">#</a> æ•…éšœæ£€æµ‹</h4><p>é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå®šæœŸåœ°å‘é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹å‘é€ PING æ¶ˆæ¯ï¼Œæ¥æ£€æµ‹å¯¹æ–¹æ˜¯å¦åœ¨çº¿ï¼Œå¦‚æœæ¥æ”¶ PING çš„èŠ‚ç‚¹æ²¡æœ‰åœ¨è§„å®šçš„æ—¶é—´å†…è¿”å› PONG æ¶ˆæ¯ï¼Œé‚£ä¹ˆå‘é€æ¶ˆæ¯èŠ‚ç‚¹å°±ä¼šå°†æ¥æ”¶èŠ‚ç‚¹æ ‡è®°ä¸º<strong>ç–‘ä¼¼ä¸‹çº¿</strong>ï¼ˆprobable failï¼‰</p><p>é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ä¼šäº’ç›¸å‘é€æ¶ˆæ¯ï¼Œæ¥<strong>äº¤æ¢é›†ç¾¤ä¸­å„ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ä¿¡æ¯</strong>ï¼Œå½“ä¸€ä¸ªä¸»èŠ‚ç‚¹ A é€šè¿‡æ¶ˆæ¯å¾—çŸ¥ä¸»èŠ‚ç‚¹ B è®¤ä¸ºä¸»èŠ‚ç‚¹ C è¿›å…¥äº†ç–‘ä¼¼ä¸‹çº¿çŠ¶æ€æ—¶ï¼Œä¸»èŠ‚ç‚¹ A ä¼šåœ¨ clusterState.nodes å­—å…¸ä¸­æ‰¾åˆ°ä¸»èŠ‚ç‚¹ C æ‰€å¯¹åº”çš„èŠ‚ç‚¹ï¼Œå¹¶å°†ä¸»èŠ‚ç‚¹ B çš„ä¸‹çº¿æŠ¥å‘Šï¼ˆfailure reportï¼‰æ·»åŠ åˆ° clusterNode.fail_reports é“¾è¡¨é‡Œé¢</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">clusterNode</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä¸€ä¸ªé“¾è¡¨ï¼Œè®°å½•äº†æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹å¯¹è¯¥èŠ‚ç‚¹çš„ä¸‹çº¿æŠ¥å‘Š </span>
    list <span class="token operator">*</span>fail_reports<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// æ¯ä¸ªä¸‹çº¿æŠ¥å‘Šç”±ä¸€ä¸ª clusterNodeFailReport ç»“æ„è¡¨ç¤º</span>
<span class="token keyword">struct</span> <span class="token class-name">clusterNodeFailReport</span> <span class="token punctuation">{</span>
    <span class="token comment">// æŠ¥å‘Šç›®æ ‡èŠ‚ç‚¹å·³ç»ä¸‹çº¿çš„èŠ‚ç‚¹ </span>
    <span class="token keyword">struct</span> <span class="token class-name">clusterNode</span> <span class="token operator">*</span>node<span class="token punctuation">;</span>
    
    <span class="token comment">// æœ€åä¸€æ¬¡ä»nodeèŠ‚ç‚¹æ”¶åˆ°ä¸‹çº¿æŠ¥å‘Šçš„æ—¶é—´</span>
    <span class="token comment">// ç¨‹åºä½¿ç”¨è¿™ä¸ªæ—¶é—´æˆ³æ¥æ£€æŸ¥ä¸‹çº¿æŠ¥å‘Šæ˜¯å¦è¿‡æœŸï¼Œä¸å½“å‰æ—¶é—´ç›¸å·®å¤ªä¹…çš„ä¸‹çº¿æŠ¥å‘Šä¼šè¢«åˆ é™¤ </span>
    <span class="token class-name">mstime_t</span> time<span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é›†ç¾¤é‡Œ<strong>åŠæ•°ä»¥ä¸Š</strong>è´Ÿè´£å¤„ç†æ§½çš„ä¸»èŠ‚ç‚¹éƒ½å°†æŸä¸ªä¸»èŠ‚ç‚¹ X æŠ¥å‘Šä¸ºç–‘ä¼¼ä¸‹çº¿ï¼Œé‚£ä¹ˆ X å°†è¢«æ ‡è®°ä¸º<strong>å·²ä¸‹çº¿</strong>ï¼ˆFAILï¼‰ï¼Œå°† X æ ‡è®°ä¸ºå·²ä¸‹çº¿çš„èŠ‚ç‚¹ä¼šå‘é›†ç¾¤å¹¿æ’­ä¸€æ¡å…³äºä¸»èŠ‚ç‚¹ X çš„ FAIL æ¶ˆæ¯ï¼Œæ‰€æœ‰æ”¶åˆ°æ¶ˆæ¯çš„èŠ‚ç‚¹éƒ½ä¼šå°† X æ ‡è®°ä¸ºå·²ä¸‹çº¿</p><hr><h4 id="æ•…éšœè½¬ç§»-1" tabindex="-1"><a class="header-anchor" href="#æ•…éšœè½¬ç§»-1" aria-hidden="true">#</a> æ•…éšœè½¬ç§»</h4><p>å½“ä¸€ä¸ªä»èŠ‚ç‚¹å‘ç°æ‰€å±çš„ä¸»èŠ‚ç‚¹è¿›å…¥äº†å·²ä¸‹çº¿çŠ¶æ€ï¼Œä»èŠ‚ç‚¹å°†å¼€å§‹å¯¹ä¸‹çº¿ä¸»èŠ‚ç‚¹è¿›è¡Œæ•…éšœè½¬ç§»ï¼Œæ‰§è¡Œæ­¥éª¤ï¼š</p><ul><li>ä¸‹å±çš„ä»èŠ‚ç‚¹é€šè¿‡é€‰ä¸¾äº§ç”Ÿä¸€ä¸ªèŠ‚ç‚¹</li><li>è¢«é€‰ä¸­çš„ä»èŠ‚ç‚¹ä¼šæ‰§è¡Œ <code>SLAVEOF no one</code> å‘½ä»¤ï¼Œæˆä¸ºæ–°çš„ä¸»èŠ‚ç‚¹</li><li>æ–°çš„ä¸»èŠ‚ç‚¹ä¼š<strong>æ’¤é”€æ‰€æœ‰å¯¹å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹çš„æ§½æŒ‡æ´¾</strong>ï¼Œå¹¶å°†è¿™äº›æ§½å…¨éƒ¨æŒ‡æ´¾ç»™è‡ªå·±</li><li>æ–°çš„ä¸»èŠ‚ç‚¹å‘é›†ç¾¤å¹¿æ’­ä¸€æ¡ PONG æ¶ˆæ¯ï¼Œè®©é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹çŸ¥é“å½“å‰èŠ‚ç‚¹å˜æˆäº†ä¸»èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ¥ç®¡äº†ä¸‹çº¿èŠ‚ç‚¹è´Ÿè´£å¤„ç†çš„æ§½</li><li>æ–°çš„ä¸»èŠ‚ç‚¹å¼€å§‹æ¥æ”¶æœ‰å…³çš„å‘½ä»¤è¯·æ±‚ï¼Œæ•…éšœè½¬ç§»å®Œæˆ</li></ul><hr><h4 id="é€‰ä¸¾ç®—æ³•" tabindex="-1"><a class="header-anchor" href="#é€‰ä¸¾ç®—æ³•" aria-hidden="true">#</a> é€‰ä¸¾ç®—æ³•</h4><p>é›†ç¾¤é€‰ä¸¾æ–°çš„ä¸»èŠ‚ç‚¹çš„è§„åˆ™ï¼š</p><ul><li>é›†ç¾¤çš„é…ç½®çºªå…ƒæ˜¯ä¸€ä¸ªè‡ªå¢çš„è®¡æ•°å™¨ï¼Œåˆå§‹å€¼ä¸º 0</li><li>å½“é›†ç¾¤é‡ŒæŸä¸ªèŠ‚ç‚¹å¼€å§‹ä¸€æ¬¡æ•…éšœè½¬ç§»ï¼Œé›†ç¾¤çš„é…ç½®çºªå…ƒå°±æ˜¯å¢åŠ ä¸€</li><li>æ¯ä¸ªé…ç½®çºªå…ƒé‡Œï¼Œé›†ç¾¤ä¸­æ¯ä¸ªä¸»èŠ‚ç‚¹éƒ½æœ‰ä¸€æ¬¡æŠ•ç¥¨çš„æœºä¼šï¼Œè€Œç¬¬ä¸€ä¸ªå‘ä¸»èŠ‚ç‚¹è¦æ±‚æŠ•ç¥¨çš„ä»èŠ‚ç‚¹å°†è·å¾—è¯¥ä¸»èŠ‚ç‚¹çš„æŠ•ç¥¨</li><li>å…·æœ‰æŠ•ç¥¨æƒçš„ä¸»èŠ‚ç‚¹æ˜¯å¿…é¡»å…·æœ‰æ­£åœ¨å¤„ç†çš„æ§½</li><li>é›†ç¾¤é‡Œæœ‰ N ä¸ªå…·æœ‰æŠ•ç¥¨æƒçš„ä¸»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå½“ä¸€ä¸ªä»èŠ‚ç‚¹æ”¶é›†åˆ°å¤§äºç­‰äº <code>N/2+1</code> å¼ æ”¯æŒç¥¨æ—¶ï¼Œä»èŠ‚ç‚¹å°±ä¼šå½“é€‰</li><li>æ¯ä¸ªé…ç½®çºªå…ƒé‡Œï¼Œå…·æœ‰æŠ•ç¥¨æƒçš„ä¸»èŠ‚ç‚¹åªèƒ½æŠ•ä¸€æ¬¡ç¥¨ï¼Œæ‰€ä»¥è·å¾—ä¸€åŠä»¥ä¸Šç¥¨çš„èŠ‚ç‚¹åªä¼šæœ‰ä¸€ä¸ª</li></ul><p>é€‰ä¸¾æµç¨‹ï¼š</p><ul><li>å½“æŸä¸ªä»èŠ‚ç‚¹å‘ç°æ­£åœ¨å¤åˆ¶çš„ä¸»èŠ‚ç‚¹è¿›å…¥å·²ä¸‹çº¿çŠ¶æ€æ—¶ï¼Œä¼šå‘é›†ç¾¤å¹¿æ’­ä¸€æ¡ <code>CLUSTERMSG_TYPE_FAILOVER_AUTH_REQUEST</code> æ¶ˆæ¯ï¼Œè¦æ±‚æ‰€æœ‰æ”¶åˆ°è¿™æ¡æ¶ˆæ¯ã€å¹¶ä¸”å…·æœ‰æŠ•ç¥¨æƒçš„ä¸»èŠ‚ç‚¹å‘è¿™ä¸ªä»èŠ‚ç‚¹æŠ•ç¥¨</li><li>å¦‚æœä¸»èŠ‚ç‚¹å°šæœªæŠ•ç¥¨ç»™å…¶ä»–ä»èŠ‚ç‚¹ï¼Œå°†å‘è¦æ±‚æŠ•ç¥¨çš„ä»èŠ‚ç‚¹è¿”å›ä¸€æ¡ <code>CLUSTERMSG_TYPE_FAILOVER_AUTH_ACK</code> æ¶ˆæ¯ï¼Œè¡¨ç¤ºè¿™ä¸ªä¸»èŠ‚ç‚¹æ”¯æŒä»èŠ‚ç‚¹æˆä¸ºæ–°çš„ä¸»èŠ‚ç‚¹</li><li>å¦‚æœä»èŠ‚ç‚¹è·å–åˆ°äº†åŠæ•°ä»¥ä¸Šçš„é€‰ç¥¨ï¼Œåˆ™ä¼šå½“é€‰æ–°çš„ä¸»èŠ‚ç‚¹</li><li>å¦‚æœä¸€ä¸ªé…ç½®çºªå…ƒé‡Œæ²¡æœ‰ä»èŠ‚ç‚¹èƒ½æ”¶é›†åˆ°è¶³å¤Ÿå¤šçš„æ”¯å¾…ç¥¨ï¼Œé‚£ä¹ˆé›†ç¾¤è¿›å…¥ä¸€ä¸ªæ–°çš„é…ç½®çºªå…ƒï¼Œå¹¶å†æ¬¡è¿›è¡Œé€‰ä¸¾ï¼Œç›´åˆ°é€‰å‡ºæ–°çš„ä¸»èŠ‚ç‚¹</li></ul><p>é€‰ä¸¾æ–°ä¸»èŠ‚ç‚¹çš„æ–¹æ³•å’Œé€‰ä¸¾é¢†å¤´ Sentinel çš„æ–¹æ³•éå¸¸ç›¸ä¼¼ï¼Œä¸¤è€…éƒ½æ˜¯åŸºäº Raft ç®—æ³•çš„é¢†å¤´é€‰ä¸¾ï¼ˆleader electionï¼‰æ–¹æ³•å®ç°çš„</p><hr><h3 id="æ¶ˆæ¯æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#æ¶ˆæ¯æœºåˆ¶" aria-hidden="true">#</a> æ¶ˆæ¯æœºåˆ¶</h3><h4 id="æ¶ˆæ¯ç»“æ„" tabindex="-1"><a class="header-anchor" href="#æ¶ˆæ¯ç»“æ„" aria-hidden="true">#</a> æ¶ˆæ¯ç»“æ„</h4><p>é›†ç¾¤ä¸­çš„å„ä¸ªèŠ‚ç‚¹é€šè¿‡å‘é€å’Œæ¥æ”¶æ¶ˆæ¯ï¼ˆmessageï¼‰æ¥è¿›è¡Œé€šä¿¡ï¼Œå°†å‘é€æ¶ˆæ¯çš„èŠ‚ç‚¹ç§°ä¸ºå‘é€è€…ï¼ˆsenderï¼‰ï¼Œæ¥æ”¶æ¶ˆæ¯çš„èŠ‚ç‚¹ç§°ä¸ºæ¥æ”¶è€…ï¼ˆreceiverï¼‰</p><p>èŠ‚ç‚¹å‘é€çš„æ¶ˆæ¯ä¸»è¦æœ‰ï¼š</p><ul><li><p>MEET æ¶ˆæ¯ï¼šå½“å‘é€è€…æ¥åˆ°å®¢æˆ·ç«¯å‘é€çš„ CLUSTER MEET å‘½ä»¤æ—¶ï¼Œä¼šå‘æ¥æ”¶è€…å‘é€ MEET æ¶ˆæ¯ï¼Œè¯·æ±‚æ¥æ”¶è€…åŠ å…¥åˆ°å‘é€è€…å½“å‰æ‰€å¤„çš„é›†ç¾¤é‡Œ</p></li><li><p>PING æ¶ˆæ¯ï¼šé›†ç¾¤é‡Œçš„æ¯ä¸ªèŠ‚ç‚¹é»˜è®¤æ¯éš”ä¸€ç§’é’Ÿå°±ä¼šä»å·²çŸ¥èŠ‚ç‚¹åˆ—è¡¨ä¸­éšæœºé€‰å‡ºäº”ä¸ªï¼Œç„¶åå¯¹è¿™äº”ä¸ªèŠ‚ç‚¹ä¸­æœ€é•¿æ—¶é—´æ²¡æœ‰å‘é€è¿‡ PING æ¶ˆæ¯çš„èŠ‚ç‚¹å‘é€ PINGï¼Œä»¥æ­¤æ¥<strong>éšæœºæ£€æµ‹</strong>è¢«é€‰ä¸­çš„èŠ‚ç‚¹æ˜¯å¦åœ¨çº¿</p><p>å¦‚æœèŠ‚ç‚¹ A æœ€åä¸€æ¬¡æ”¶åˆ°èŠ‚ç‚¹ B å‘é€çš„ PONG æ¶ˆæ¯çš„æ—¶é—´ï¼Œè·ç¦»å½“å‰å·²ç»è¶…è¿‡äº†èŠ‚ç‚¹ A çš„ cluster-nodeÂ­-timeout è®¾ç½®æ—¶é•¿çš„ä¸€åŠï¼Œé‚£ä¹ˆ A ä¹Ÿä¼šå‘ B å‘é€ PING æ¶ˆæ¯ï¼Œé˜²æ­¢ A å› ä¸ºé•¿æ—¶é—´æ²¡æœ‰éšæœºé€‰ä¸­ B å‘é€ PINGï¼Œè€Œå¯¼è‡´å¯¹èŠ‚ç‚¹ B çš„ä¿¡æ¯æ›´æ–°æ»å</p></li><li><p>PONG æ¶ˆæ¯ï¼šå½“æ¥æ”¶è€…æ”¶åˆ° MEET æ¶ˆæ¯æˆ–è€… PING æ¶ˆæ¯æ—¶ï¼Œä¸ºäº†è®©å‘é€è€…ç¡®è®¤å·²ç»æˆåŠŸæ¥æ”¶æ¶ˆæ¯ï¼Œä¼šå‘å‘é€è€…è¿”å›ä¸€æ¡ PONGï¼›èŠ‚ç‚¹ä¹Ÿå¯ä»¥é€šè¿‡å‘é›†ç¾¤å¹¿æ’­ PONG æ¶ˆæ¯æ¥è®©é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹ç«‹å³åˆ·æ–°å…³äºè¿™ä¸ªèŠ‚ç‚¹çš„è®¤è¯†ï¼ˆä»å‡çº§ä¸ºä¸»ï¼‰</p></li><li><p>FAIL æ¶ˆæ¯ï¼šå½“ä¸€ä¸ªä¸»èŠ‚ç‚¹ A åˆ¤æ–­å¦ä¸€ä¸ªä¸»èŠ‚ç‚¹ B å·²ç»è¿›å…¥ FAIL çŠ¶æ€æ—¶ï¼ŒèŠ‚ç‚¹ A ä¼šå‘é›†ç¾¤å¹¿æ’­ä¸€æ¡ B èŠ‚ç‚¹çš„ FAIL ä¿¡æ¯</p></li><li><p>PUBLISH æ¶ˆæ¯ï¼šå½“èŠ‚ç‚¹æ¥æ”¶åˆ°ä¸€ä¸ª PUBLISH å‘½ä»¤æ—¶ï¼ŒèŠ‚ç‚¹ä¼šæ‰§è¡Œè¿™ä¸ªå‘½ä»¤å¹¶å‘é›†ç¾¤å¹¿æ’­ä¸€æ¡ PUBLISH æ¶ˆæ¯ï¼Œæ¥æ”¶åˆ° PUBLISH æ¶ˆæ¯çš„èŠ‚ç‚¹éƒ½ä¼šæ‰§è¡Œç›¸åŒçš„ PUBLISH å‘½ä»¤</p></li></ul><hr><h4 id="æ¶ˆæ¯å¤´" tabindex="-1"><a class="header-anchor" href="#æ¶ˆæ¯å¤´" aria-hidden="true">#</a> æ¶ˆæ¯å¤´</h4><p>èŠ‚ç‚¹å‘é€çš„æ‰€æœ‰æ¶ˆæ¯éƒ½ç”±ä¸€ä¸ªæ¶ˆæ¯å¤´åŒ…è£¹ï¼Œæ¶ˆæ¯å¤´é™¤äº†åŒ…å«æ¶ˆæ¯æ­£æ–‡ä¹‹å¤–ï¼Œè¿˜è®°å½•äº†æ¶ˆæ¯å‘é€è€…è‡ªèº«çš„ä¸€äº›ä¿¡æ¯</p><p>æ¶ˆæ¯å¤´ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">clusterMsg</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ¶ˆæ¯çš„é•¿åº¦ï¼ˆåŒ…æ‹¬è¿™ä¸ªæ¶ˆæ¯å¤´çš„é•¿åº¦å’Œæ¶ˆæ¯æ­£æ–‡çš„é•¿åº¦ï¼‰</span>
	<span class="token class-name">uint32_t</span> totlen<span class="token punctuation">;</span>
	<span class="token comment">// æ¶ˆæ¯çš„ç±»å‹</span>
	<span class="token class-name">uint16_t</span> type<span class="token punctuation">;</span>
    <span class="token comment">// æ¶ˆæ¯æ­£æ–‡åŒ…å«çš„èŠ‚ç‚¹ä¿¡æ¯æ•°é‡ï¼Œåªåœ¨å‘é€MEETã€PINGã€PONGè¿™ä¸‰ç§Gossipåè®®æ¶ˆæ¯æ—¶ä½¿ç”¨ </span>
    <span class="token class-name">uint16_t</span> count<span class="token punctuation">;</span>
    
    <span class="token comment">// å‘é€è€…æ‰€å¤„çš„é…ç½®çºªå…ƒ</span>
    <span class="token class-name">uint64_t</span> currentEpoch<span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœå‘é€è€…æ˜¯ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™é‡Œè®°å½•çš„æ˜¯å‘é€è€…çš„é…ç½®çºªå…ƒ</span>
    <span class="token comment">// å¦‚æœå‘é€è€…æ˜¯ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™é‡Œè®°å½•çš„æ˜¯å‘é€è€…æ­£åœ¨å¤åˆ¶çš„ä¸»èŠ‚ç‚¹çš„é…ç½®çºªå…ƒ</span>
    <span class="token class-name">uint64_t</span> configEpoch<span class="token punctuation">;</span>
    
    <span class="token comment">// å‘é€è€…çš„åå­—(ID)</span>
	<span class="token keyword">char</span> sender<span class="token punctuation">[</span>REDIS CLUSTER NAMELEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">// å‘é€è€…ç›®å‰çš„æ§½æŒ‡æ´¾ä¿¡æ¯</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> myslots<span class="token punctuation">[</span>REDIS_CLUSTER_SLOTS<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">// å¦‚æœå‘é€è€…æ˜¯ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™é‡Œè®°å½•çš„æ˜¯å‘é€è€…æ­£åœ¨å¤åˆ¶çš„ä¸»èŠ‚ç‚¹çš„åå­—</span>
    <span class="token comment">// å¦‚æœå‘é€è€…æ˜¯ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™é‡Œè®°å½•çš„æ˜¯ REDIS_NODE_NULL_NAMEï¼Œä¸€ä¸ª 40 å®‡èŠ‚é•¿å€¼å…¨ä¸º 0 çš„å­—èŠ‚æ•°ç»„</span>
    <span class="token keyword">char</span> slaveof<span class="token punctuation">[</span>REDIS_CLUSTER_NAMELEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
	<span class="token comment">// å‘é€è€…çš„ç«¯å£å·</span>
	<span class="token class-name">uint16_t</span> port<span class="token punctuation">;</span>
	<span class="token comment">// å‘é€è€…çš„æ ‡è¯†å€¼</span>
    <span class="token class-name">uint16_t</span> flags<span class="token punctuation">;</span> 
	<span class="token comment">//å‘é€è€…æ‰€å¤„é›†ç¾¤çš„çŠ¶æ€</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> state<span class="token punctuation">;</span>
	<span class="token comment">// æ¶ˆæ¯çš„æ­£æ–‡ï¼ˆæˆ–è€…è¯´ï¼Œ å†…å®¹ï¼‰ </span>
    <span class="token keyword">union</span> clusterMsgData data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>clusterMsg ç»“æ„çš„ currentEpochã€senderã€myslots ç­‰å±æ€§è®°å½•äº†å‘é€è€…çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œæ¥æ”¶è€…ä¼šæ ¹æ®è¿™äº›ä¿¡æ¯åœ¨ clusterState.nodes å­—å…¸é‡Œæ‰¾åˆ°å‘é€è€…å¯¹åº”çš„ clusterNode ç»“æ„ï¼Œå¹¶å¯¹ç»“æ„è¿›è¡Œæ›´æ–°ï¼Œæ¯”å¦‚<strong>ä¼ æ’­èŠ‚ç‚¹çš„æ§½æŒ‡æ´¾ä¿¡æ¯</strong></p><p>æ¶ˆæ¯æ­£æ–‡ï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">union</span> clusterMsgData <span class="token punctuation">{</span>
    <span class="token comment">// MEETã€PINGã€PONG æ¶ˆæ¯çš„æ­£æ–‡</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ¯æ¡ MEETã€PINGã€PONG æ¶ˆæ¯éƒ½åŒ…å«ä¸¤ä¸ª clusterMsgDataGossip ç»“æ„</span>
        clusterMsgDataGossip gossip<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> ping<span class="token punctuation">;</span>
    
    <span class="token comment">// FAIL æ¶ˆæ¯çš„æ­£æ–‡</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span> 
		clusterMsgDataFail about<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> fail<span class="token punctuation">;</span>
    
    <span class="token comment">// PUBLISH æ¶ˆæ¯çš„æ­£æ–‡</span>
    <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    	clusterMsgDataPublish msg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> publish<span class="token punctuation">;</span>
    
    <span class="token comment">// å…¶ä»–æ¶ˆæ¯æ­£æ–‡...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="gossip" tabindex="-1"><a class="header-anchor" href="#gossip" aria-hidden="true">#</a> Gossip</h4><p>Redis é›†ç¾¤ä¸­çš„å„ä¸ªèŠ‚ç‚¹é€šè¿‡ Gossip åè®®æ¥äº¤æ¢å„è‡ªå…³äºä¸åŒèŠ‚ç‚¹çš„çŠ¶æ€ä¿¡æ¯ï¼Œå…¶ä¸­ Gossip åè®®ç”± MEETã€PINGã€PONG æ¶ˆæ¯å®ç°ï¼Œä¸‰ç§æ¶ˆæ¯ä½¿ç”¨ç›¸åŒçš„æ¶ˆæ¯æ­£æ–‡ï¼Œæ‰€ä»¥èŠ‚ç‚¹é€šè¿‡æ¶ˆæ¯å¤´çš„ type å±æ€§æ¥åˆ¤æ–­æ¶ˆæ¯çš„å…·ä½“ç±»å‹</p><p>å‘é€è€…å‘é€è¿™ä¸‰ç§æ¶ˆæ¯æ—¶ï¼Œä¼šä»å·²çŸ¥èŠ‚ç‚¹åˆ—è¡¨ä¸­<strong>éšæœºé€‰å‡ºä¸¤ä¸ªèŠ‚ç‚¹</strong>ï¼ˆä¸»ä»éƒ½å¯ä»¥ï¼‰ï¼Œå°†ä¸¤ä¸ªè¢«é€‰ä¸­èŠ‚ç‚¹ä¿¡æ¯ä¿å­˜åˆ°ä¸¤ä¸ª Gossip ç»“æ„</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">clusterMsgDataGossip</span> <span class="token punctuation">{</span>
    <span class="token comment">// èŠ‚ç‚¹çš„åå­—</span>
	<span class="token keyword">char</span> nodename<span class="token punctuation">[</span>REDIS CLUSTER NAMELEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
	<span class="token comment">// æœ€åä¸€æ¬¡å‘è¯¥èŠ‚ç‚¹å‘é€PINGæ¶ˆæ¯çš„æ—¶é—´æˆ³</span>
    <span class="token class-name">uint32_t</span> ping_sent<span class="token punctuation">;</span>
	<span class="token comment">// æœ€åä¸€æ¬¡ä»è¯¥èŠ‚ç‚¹æ¥æ”¶åˆ°PONGæ¶ˆæ¯çš„æ—¶é—´æˆ³</span>
    <span class="token class-name">uint32_t</span> pong_received<span class="token punctuation">;</span>
    
	<span class="token comment">// èŠ‚ç‚¹çš„IPåœ°å€</span>
	<span class="token keyword">char</span> ip<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// èŠ‚ç‚¹çš„ç«¯å£å·</span>
    <span class="token class-name">uint16_t</span> port<span class="token punctuation">;</span>
	<span class="token comment">// èŠ‚ç‚¹çš„æ ‡è¯†å€¼</span>
    <span class="token class-name">uint16_t</span> flags<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“æ¥æ”¶è€…æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œä¼šè®¿é—®æ¶ˆæ¯æ­£æ–‡ä¸­çš„ä¸¤ä¸ªæ•°æ®ç»“æ„ï¼Œæ¥è¿›è¡Œç›¸å…³æ“ä½œ</p><ul><li>å¦‚æœè¢«é€‰ä¸­èŠ‚ç‚¹ä¸å­˜åœ¨äºæ¥æ”¶è€…çš„å·²çŸ¥èŠ‚ç‚¹åˆ—è¡¨ï¼Œæ¥æ”¶è€…å°†æ ¹æ®ç»“æ„ä¸­è®°å½•çš„ IP åœ°å€å’Œç«¯å£å·ï¼Œä¸èŠ‚ç‚¹è¿›è¡Œæ¡æ‰‹</li><li>å¦‚æœå­˜åœ¨ï¼Œæ ¹æ® Gossip ç»“æ„è®°å½•çš„ä¿¡æ¯å¯¹èŠ‚ç‚¹æ‰€å¯¹åº”çš„ clusterNode ç»“æ„è¿›è¡Œæ›´æ–°</li></ul><hr><h4 id="fail" tabindex="-1"><a class="header-anchor" href="#fail" aria-hidden="true">#</a> FAIL</h4><p>åœ¨é›†ç¾¤çš„èŠ‚ç‚¹æ•°é‡æ¯”è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Gossip åè®®æ¥ä¼ æ’­èŠ‚ç‚¹çš„å·²ä¸‹çº¿ä¿¡æ¯ä¼šå¸¦æ¥ä¸€å®šå»¶è¿Ÿï¼Œå› ä¸º Gossip åè®®æ¶ˆæ¯é€šå¸¸éœ€è¦ä¸€æ®µæ—¶é—´æ‰èƒ½ä¼ æ’­è‡³æ•´ä¸ªé›†ç¾¤ï¼Œæ‰€ä»¥é€šè¿‡å‘é€ FAILæ¶ˆæ¯å¯ä»¥è®©é›†ç¾¤é‡Œçš„æ‰€æœ‰èŠ‚ç‚¹ç«‹å³çŸ¥é“æŸä¸ªä¸»èŠ‚ç‚¹å·²ä¸‹çº¿ï¼Œä»è€Œå°½å¿«è¿›è¡Œå…¶ä»–æ“ä½œ</p><p>FAIL æ¶ˆæ¯çš„æ­£æ–‡ç”± clusterMsgDataFail ç»“æ„è¡¨ç¤ºï¼Œè¯¥ç»“æ„åªæœ‰ä¸€ä¸ªå±æ€§ï¼Œè®°å½•äº†å·²ä¸‹çº¿èŠ‚ç‚¹çš„åå­—</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">clusterMsgDataFail</span> <span class="token punctuation">{</span>
	<span class="token keyword">char</span> nodename<span class="token punctuation">[</span>REDIS_CLUSTER_NAMELEN<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å› ä¸ºä¼ æ’­ä¸‹çº¿ä¿¡æ¯ä¸éœ€è¦å…¶ä»–å±æ€§ï¼Œæ‰€ä»¥èŠ‚çœäº†ä¼ æ’­çš„èµ„æº</p><hr><h4 id="publish" tabindex="-1"><a class="header-anchor" href="#publish" aria-hidden="true">#</a> PUBLISH</h4><p>å½“å®¢æˆ·ç«¯å‘é›†ç¾¤ä¸­çš„æŸä¸ªèŠ‚ç‚¹å‘é€å‘½ä»¤ï¼Œæ¥æ”¶åˆ° PUBLISH å‘½ä»¤çš„èŠ‚ç‚¹ä¸ä»…ä¼šå‘ channel é¢‘é“å‘é€æ¶ˆæ¯ messageï¼Œè¿˜ä¼šå‘é›†ç¾¤å¹¿æ’­ä¸€æ¡ PUBLISH æ¶ˆæ¯ï¼Œæ‰€æœ‰æ¥æ”¶åˆ°è¿™æ¡ PUBLISH æ¶ˆæ¯çš„èŠ‚ç‚¹éƒ½ä¼šå‘ channel é¢‘é“å‘é€ message æ¶ˆæ¯ï¼Œæœ€ç»ˆé›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹éƒ½å‘äº†</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>PUBLISH <span class="token operator">&lt;</span>channel<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>message<span class="token operator">&gt;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>PUBLISH æ¶ˆæ¯çš„æ­£æ–‡ç”± clusterMsgDataPublish ç»“æ„è¡¨ç¤ºï¼š</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">clusterMsgDataPublish</span> <span class="token punctuation">{</span>
    <span class="token comment">// channelå‚æ•°çš„é•¿åº¦</span>
    <span class="token class-name">uint32_t</span> channel_len<span class="token punctuation">;</span>
    <span class="token comment">// messageå‚æ•°çš„é•¿åº¦</span>
    <span class="token class-name">uint32_t</span> message_len<span class="token punctuation">;</span>
    
    <span class="token comment">// å®šä¹‰ä¸º8å­—èŠ‚åªæ˜¯ä¸ºäº†å¯¹é½å…¶ä»–æ¶ˆæ¯ç»“æ„ï¼Œå®é™…çš„é•¿åº¦ç”±ä¿å­˜çš„å†…å®¹å†³å®š</span>
    <span class="token comment">// bulk_data çš„ 0 è‡³ channel_len-1 å­—èŠ‚ä¿å­˜çš„æ˜¯channelå‚æ•°</span>
    <span class="token comment">// bulk_dataçš„ channel_len å­—èŠ‚è‡³ channel_len + message_len-1 å­—èŠ‚ä¿å­˜çš„åˆ™æ˜¯messageå‚æ•°</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> bulk_data<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è®©é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œç›¸åŒçš„ PUBLISH å‘½ä»¤ï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯å‘æ‰€æœ‰èŠ‚ç‚¹å¹¿æ’­ç›¸åŒçš„ PUBLISH å‘½ä»¤ï¼Œè¿™ä¹Ÿæ˜¯ Redis å¤åˆ¶ PUBLISH å‘½ä»¤æ—¶æ‰€ä½¿ç”¨çš„ï¼Œä½†æ˜¯è¿™ç§åšæ³•å¹¶ä¸ç¬¦åˆ Redis é›†ç¾¤çš„å„<strong>ä¸ªèŠ‚ç‚¹é€šè¿‡å‘é€å’Œæ¥æ”¶æ¶ˆæ¯æ¥è¿›è¡Œé€šä¿¡</strong>çš„è§„åˆ™</p><hr><h3 id="è„‘è£‚é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#è„‘è£‚é—®é¢˜" aria-hidden="true">#</a> è„‘è£‚é—®é¢˜</h3><p>è„‘è£‚æŒ‡åœ¨ä¸»ä»é›†ç¾¤ä¸­ï¼ŒåŒæ—¶æœ‰ä¸¤ä¸ªç›¸åŒçš„ä¸»èŠ‚ç‚¹èƒ½æ¥æ”¶å†™è¯·æ±‚ï¼Œå¯¼è‡´å®¢æˆ·ç«¯ä¸çŸ¥é“åº”è¯¥å¾€å“ªä¸ªä¸»èŠ‚ç‚¹å†™å…¥æ•°æ®ï¼Œæœ€å ä¸åŒå®¢æˆ·ç«¯å¾€ä¸åŒçš„ä¸»èŠ‚ç‚¹ä¸Šå†™å…¥æ•°æ®</p><ul><li>åŸä¸»èŠ‚ç‚¹å¹¶æ²¡æœ‰çœŸçš„å‘ç”Ÿæ•…éšœï¼Œç”±äºæŸäº›åŸå› æ— æ³•å¤„ç†è¯·æ±‚ï¼ˆCPU åˆ©ç”¨ç‡å¾ˆé«˜ã€è‡ªèº«é˜»å¡ï¼‰ï¼Œæ— æ³•æŒ‰æ—¶å“åº”å¿ƒè·³è¯·æ±‚ï¼Œè¢«å“¨å…µ/é›†ç¾¤ä¸»èŠ‚ç‚¹é”™è¯¯çš„åˆ¤æ–­ä¸ºä¸‹çº¿</li><li>åœ¨è¢«åˆ¤æ–­ä¸‹çº¿ä¹‹åï¼ŒåŸä¸»åº“åˆé‡æ–°å¼€å§‹å¤„ç†è¯·æ±‚äº†ï¼Œå“¨å…µ/é›†ç¾¤ä¸»èŠ‚ç‚¹è¿˜æ²¡æœ‰å®Œæˆä¸»ä»åˆ‡æ¢ï¼Œå®¢æˆ·ç«¯ä»ç„¶å¯ä»¥å’ŒåŸä¸»åº“é€šä¿¡ï¼Œå®¢æˆ·ç«¯å‘é€çš„å†™æ“ä½œå°±ä¼šåœ¨åŸä¸»åº“ä¸Šå†™å…¥æ•°æ®ï¼Œé€ æˆè„‘è£‚é—®é¢˜</li></ul><p>æ•°æ®ä¸¢å¤±é—®é¢˜ï¼šä»åº“ä¸€æ—¦å‡çº§ä¸ºæ–°ä¸»åº“ï¼Œå“¨å…µå°±ä¼šè®©åŸä¸»åº“æ‰§è¡Œ slave of å‘½ä»¤ï¼Œå’Œæ–°ä¸»åº“é‡æ–°è¿›è¡Œå…¨é‡åŒæ­¥ï¼ŒåŸä¸»åº“éœ€è¦æ¸…ç©ºæœ¬åœ°çš„æ•°æ®ï¼ŒåŠ è½½æ–°ä¸»åº“å‘é€çš„ RDB æ–‡ä»¶ï¼Œæ‰€ä»¥åŸä¸»åº“åœ¨ä¸»ä»åˆ‡æ¢æœŸé—´ä¿å­˜çš„æ–°å†™æ•°æ®å°±ä¸¢å¤±äº†</p><p>é¢„é˜²è„‘è£‚ï¼šåœ¨ä¸»ä»é›†ç¾¤éƒ¨ç½²æ—¶ï¼Œåˆç†åœ°é…ç½®å‚æ•° min-slaves-to-write å’Œ min-slaves-max-lag</p><ul><li>å‡è®¾ä»åº“æœ‰ K ä¸ªï¼Œå¯ä»¥å°† min-slaves-to-write è®¾ç½®ä¸º K/2+1ï¼ˆå¦‚æœ K ç­‰äº 1ï¼Œå°±è®¾ä¸º 1ï¼‰</li><li>å°† min-slaves-max-lag è®¾ç½®ä¸ºåå‡ ç§’ï¼ˆä¾‹å¦‚ 10ï½20sï¼‰</li><li>åœ¨å‡æ•…éšœæœŸé—´æ— æ³•å“åº”å“¨å…µå‘å‡ºçš„å¿ƒè·³æµ‹è¯•ï¼Œæ— æ³•å’Œä»åº“è¿›è¡Œ ACK ç¡®è®¤ï¼Œå¹¶ä¸”æ²¡æœ‰è¶³å¤Ÿçš„ä»åº“ï¼Œ<strong>æ‹’ç»å®¢æˆ·ç«¯çš„å†™å…¥</strong></li></ul><hr><h3 id="ç»“æ„æ­å»º" tabindex="-1"><a class="header-anchor" href="#ç»“æ„æ­å»º" aria-hidden="true">#</a> ç»“æ„æ­å»º</h3><p>æ•´ä½“æ¡†æ¶ï¼š</p><ul><li>é…ç½®æœåŠ¡å™¨ï¼ˆ3 ä¸» 3 ä»ï¼‰</li><li>å»ºç«‹é€šä¿¡ï¼ˆMeetï¼‰</li><li>åˆ†æ§½ï¼ˆSlotï¼‰</li><li>æ­å»ºä¸»ä»ï¼ˆmaster-slaveï¼‰</li></ul><p>åˆ›å»ºé›†ç¾¤ conf é…ç½®æ–‡ä»¶ï¼š</p><ul><li><p>redis-6501.conf</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>port <span class="token number">6501</span>
<span class="token function">dir</span> <span class="token string">&quot;/redis/data&quot;</span>
dbfilename <span class="token string">&quot;dump-6501.rdb&quot;</span>
cluster-enabled <span class="token function">yes</span>
cluster-config-file <span class="token string">&quot;cluster-6501.conf&quot;</span>
cluster-node-timeout <span class="token number">5000</span>

<span class="token comment">#å…¶ä»–é…ç½®æ–‡ä»¶å‚ç…§ä¸Šé¢çš„ä¿®æ”¹ç«¯å£å³å¯ï¼Œå†…å®¹å®Œå…¨ä¸€æ ·</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æœåŠ¡ç«¯å¯åŠ¨ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-server config_file_name
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>å®¢æˆ·ç«¯å¯åŠ¨ï¼š</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">-p</span> <span class="token number">6504</span> <span class="token parameter variable">-c</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><p><strong>cluster é…ç½®ï¼š</strong></p><ul><li><p>æ˜¯å¦å¯ç”¨ clusterï¼ŒåŠ å…¥ cluster èŠ‚ç‚¹</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>cluster-enabled <span class="token function">yes</span><span class="token operator">|</span>no
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>cluster é…ç½®æ–‡ä»¶åï¼Œè¯¥æ–‡ä»¶å±äºè‡ªåŠ¨ç”Ÿæˆï¼Œä»…ç”¨äºå¿«é€ŸæŸ¥æ‰¾æ–‡ä»¶å¹¶æŸ¥è¯¢æ–‡ä»¶å†…å®¹</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>cluster-config-file filename
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>èŠ‚ç‚¹æœåŠ¡å“åº”è¶…æ—¶æ—¶é—´ï¼Œç”¨äºåˆ¤å®šè¯¥èŠ‚ç‚¹æ˜¯å¦ä¸‹çº¿æˆ–åˆ‡æ¢ä¸ºä»èŠ‚ç‚¹</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>cluster-node-timeout milliseconds
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>master è¿æ¥çš„ slave æœ€å°æ•°é‡</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>cluster-migration-barrier min_slave_number
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><p>å®¢æˆ·ç«¯å¯åŠ¨å‘½ä»¤ï¼š</p><p><strong>cluster èŠ‚ç‚¹æ“ä½œå‘½ä»¤ï¼ˆå®¢æˆ·ç«¯å‘½ä»¤ï¼‰ï¼š</strong></p><ul><li><p>æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>cluster nodes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>æ›´æ”¹ slave æŒ‡å‘æ–°çš„ master</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>cluster replicate master-id
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>å‘ç°ä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼Œæ–°å¢ master</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>cluster meet ip:port
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>å¿½ç•¥ä¸€ä¸ªæ²¡æœ‰ solt çš„èŠ‚ç‚¹</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>cluster forget server_id
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>æ‰‹åŠ¨æ•…éšœè½¬ç§»</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>cluster failover
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><p><strong>é›†ç¾¤æ“ä½œå‘½ä»¤ï¼ˆLinuxï¼‰ï¼š</strong></p><ul><li><p>åˆ›å»ºé›†ç¾¤</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-cli â€“-cluster create masterhost1:masterport1 masterhost2:masterport2  masterhost3:masterport3 <span class="token punctuation">[</span>masterhostn:masterportn â€¦<span class="token punctuation">]</span> slavehost1:slaveport1  slavehost2:slaveport2 slavehost3:slaveport3 -â€“cluster-replicas n
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ³¨æ„ï¼šmaster ä¸ slave çš„æ•°é‡è¦åŒ¹é…ï¼Œä¸€ä¸ª master å¯¹åº” n ä¸ª slaveï¼Œç”±æœ€åçš„å‚æ•° n å†³å®šã€‚master ä¸ slave çš„åŒ¹é…é¡ºåºä¸ºç¬¬ä¸€ä¸ª master ä¸å‰ n ä¸ª slave åˆ†ä¸ºä¸€ç»„ï¼Œå½¢æˆä¸»ä»ç»“æ„</p></li><li><p>æ·»åŠ  master åˆ°å½“å‰é›†ç¾¤ä¸­ï¼Œè¿æ¥æ—¶å¯ä»¥æŒ‡å®šä»»æ„ç°æœ‰èŠ‚ç‚¹åœ°å€ä¸ç«¯å£</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">--cluster</span> add-node new-master-host:new-master-port now-host:now-port
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>æ·»åŠ  slave</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">--cluster</span> add-node new-slave-host:new-slave-port master-host:master-port --cluster-slave --cluster-master-id masterid
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>åˆ é™¤èŠ‚ç‚¹ï¼Œå¦‚æœåˆ é™¤çš„èŠ‚ç‚¹æ˜¯ masterï¼Œå¿…é¡»ä¿éšœå…¶ä¸­æ²¡æœ‰æ§½ slot</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">--cluster</span> del-node del-slave-host:del-slave-port del-slave-id
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>é‡æ–°åˆ†æ§½ï¼Œåˆ†æ§½æ˜¯ä»å…·æœ‰æ§½çš„ master ä¸­åˆ’åˆ†ä¸€éƒ¨åˆ†ç»™å…¶ä»– masterï¼Œè¿‡ç¨‹ä¸­ä¸åˆ›å»ºæ–°çš„æ§½</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">--cluster</span> reshard new-master-host:new-master:port --cluster-from src-  master-id1, src-master-id2, src-master-idn --cluster-to target-master-id --  cluster-slots slots
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ³¨æ„ï¼šå°†éœ€è¦å‚ä¸åˆ†æ§½çš„æ‰€æœ‰ masterid ä¸åˆ†å…ˆåé¡ºåºæ·»åŠ åˆ°å‚æ•°ä¸­ï¼Œä½¿ç”¨ <code>,</code> åˆ†éš”ï¼ŒæŒ‡å®šç›®æ ‡å¾—åˆ°çš„æ§½çš„æ•°é‡ï¼Œæ‰€æœ‰çš„æ§½å°†å¹³å‡ä»æ¯ä¸ªæ¥æºçš„ master å¤„è·å–</p></li><li><p>é‡æ–°åˆ†é…æ§½ï¼Œä»å…·æœ‰æ§½çš„ master ä¸­åˆ†é…æŒ‡å®šæ•°é‡çš„æ§½åˆ°å¦ä¸€ä¸ª master ä¸­ï¼Œå¸¸ç”¨äºæ¸…ç©ºæŒ‡å®š master ä¸­çš„æ§½</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis-cli <span class="token parameter variable">--cluster</span> reshard src-master-host:src-master-port --cluster-from src-  master-id --cluster-to target-master-id --cluster-slots slots --cluster-yes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><hr><h2 id="å…¶ä»–æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#å…¶ä»–æ“ä½œ" aria-hidden="true">#</a> å…¶ä»–æ“ä½œ</h2><h3 id="å‘å¸ƒè®¢é˜…" tabindex="-1"><a class="header-anchor" href="#å‘å¸ƒè®¢é˜…" aria-hidden="true">#</a> å‘å¸ƒè®¢é˜…</h3><h4 id="åŸºæœ¬æŒ‡ä»¤-1" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æŒ‡ä»¤-1" aria-hidden="true">#</a> åŸºæœ¬æŒ‡ä»¤</h4><p>Redis å‘å¸ƒè®¢é˜…ï¼ˆpub/subï¼‰æ˜¯ä¸€ç§æ¶ˆæ¯é€šä¿¡æ¨¡å¼ï¼šå‘é€è€…ï¼ˆpubï¼‰å‘é€æ¶ˆæ¯ï¼Œè®¢é˜…è€…ï¼ˆsubï¼‰æ¥æ”¶æ¶ˆæ¯</p><p>Redis å®¢æˆ·ç«¯å¯ä»¥è®¢é˜…ä»»æ„æ•°é‡çš„é¢‘é“ï¼Œæ¯å½“æœ‰å®¢æˆ·ç«¯å‘è¢«è®¢é˜…çš„é¢‘é“å‘é€æ¶ˆæ¯ï¼ˆmessageï¼‰æ—¶ï¼Œé¢‘é“çš„<strong>æ‰€æœ‰è®¢é˜…è€…éƒ½ä¼šæ”¶åˆ°æ¶ˆæ¯</strong></p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å‘å¸ƒè®¢é˜….png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>æ“ä½œè¿‡ç¨‹ï¼š</p><ul><li><p>æ‰“å¼€ä¸€ä¸ªå®¢æˆ·ç«¯è®¢é˜… channel1ï¼š<code>SUBSCRIBE channel1</code></p></li><li><p>æ‰“å¼€å¦ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œç»™ channel1 å‘å¸ƒæ¶ˆæ¯ helloï¼š<code>PUBLISH channel1 hello</code></p></li><li><p>ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯å¯ä»¥çœ‹åˆ°å‘é€çš„æ¶ˆæ¯</p></li></ul><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-å‘å¸ƒè®¢é˜…æŒ‡ä»¤æ“ä½œ.png" style="zoom:67%;"><p>å®¢æˆ·ç«¯è¿˜å¯ä»¥é€šè¿‡ PSUBSCRIBE å‘½ä»¤è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å¼ï¼Œæ¯å½“æœ‰å…¶ä»–å®¢æˆ·ç«¯å‘æŸä¸ªé¢‘é“å‘é€æ¶ˆæ¯æ—¶ï¼Œæ¶ˆæ¯ä¸ä»…ä¼šè¢«å‘é€ç»™è¿™ä¸ªé¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…ï¼Œè¿˜ä¼šè¢«<strong>å‘é€ç»™æ‰€æœ‰ä¸è¿™ä¸ªé¢‘é“ç›¸åŒ¹é…çš„æ¨¡å¼çš„è®¢é˜…è€…</strong>ï¼Œæ¯”å¦‚ <code>PSUBSCRIBE channel*</code> è®¢é˜…æ¨¡å¼ï¼Œä¸ channel1 åŒ¹é…</p><p>æ³¨æ„ï¼šå‘å¸ƒçš„æ¶ˆæ¯æ²¡æœ‰æŒä¹…åŒ–ï¼Œæ‰€ä»¥è®¢é˜…çš„å®¢æˆ·ç«¯åªèƒ½æ”¶åˆ°è®¢é˜…åå‘å¸ƒçš„æ¶ˆæ¯</p><hr><h4 id="é¢‘é“æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#é¢‘é“æ“ä½œ" aria-hidden="true">#</a> é¢‘é“æ“ä½œ</h4><p>Redis å°†æ‰€æœ‰é¢‘é“çš„è®¢é˜…å…³ç³»éƒ½ä¿å­˜åœ¨æœåŠ¡å™¨çŠ¶æ€çš„ pubsub_channels å­—å…¸é‡Œï¼Œé”®æ˜¯æŸä¸ªè¢«è®¢é˜…çš„é¢‘é“ï¼Œå€¼æ˜¯ä¸€ä¸ªè®°å½•æ‰€æœ‰è®¢é˜…è¿™ä¸ªé¢‘é“çš„å®¢æˆ·ç«¯é“¾è¡¨</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
	<span class="token comment">// ä¿å­˜æ‰€æœ‰é¢‘é“çš„è®¢é˜…å…³ç³»ï¼Œ</span>
	dict <span class="token operator">*</span>pubsub_channels<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®¢æˆ·ç«¯æ‰§è¡Œ SUBSCRIBE å‘½ä»¤è®¢é˜…æŸä¸ªæˆ–æŸäº›é¢‘é“ï¼ŒæœåŠ¡å™¨ä¼šå°†å®¢æˆ·ç«¯ä¸é¢‘é“è¿›è¡Œå…³è”ï¼š</p><ul><li>é¢‘é“å·²ç»å­˜åœ¨ï¼Œç›´æ¥å°†å®¢æˆ·ç«¯æ·»åŠ åˆ°é“¾è¡¨æœ«å°¾</li><li>é¢‘é“è¿˜æœªæœ‰ä»»ä½•è®¢é˜…è€…ï¼Œåœ¨å­—å…¸ä¸­ä¸ºé¢‘é“åˆ›å»ºä¸€ä¸ªé”®å€¼å¯¹ï¼Œå†å°†å®¢æˆ·ç«¯æ·»åŠ åˆ°é“¾è¡¨</li></ul><p>UNSUBSCRIBE å‘½ä»¤ç”¨æ¥é€€è®¢æŸä¸ªé¢‘é“ï¼ŒæœåŠ¡å™¨å°†ä» pubsub_channels ä¸­è§£é™¤å®¢æˆ·ç«¯ä¸è¢«é€€è®¢é¢‘é“ä¹‹é—´çš„å…³è”</p><hr><h4 id="æ¨¡å¼æ“ä½œ" tabindex="-1"><a class="header-anchor" href="#æ¨¡å¼æ“ä½œ" aria-hidden="true">#</a> æ¨¡å¼æ“ä½œ</h4><p>Redis æœåŠ¡å™¨å°†æ‰€æœ‰æ¨¡å¼çš„è®¢é˜…å…³ç³»éƒ½ä¿å­˜åœ¨æœåŠ¡å™¨çŠ¶æ€çš„ pubsub_patterns å±æ€§é‡Œ</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">{</span>
	<span class="token comment">// ä¿å­˜æ‰€æœ‰æ¨¡å¼è®¢é˜…å…³ç³»ï¼Œé“¾è¡¨ä¸­æ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ª pubsubPattern</span>
	list <span class="token operator">*</span>pubsub_patterns<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">pubsubPattern</span> <span class="token punctuation">{</span>
    <span class="token comment">// è®¢é˜…çš„å®¢æˆ·ç«¯</span>
    redisClient <span class="token operator">*</span>client<span class="token punctuation">;</span>
	<span class="token comment">// è¢«è®¢é˜…çš„æ¨¡å¼ï¼Œæ¯”å¦‚  channel*</span>
    robj <span class="token operator">*</span>pattern<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®¢æˆ·ç«¯æ‰§è¡Œ PSUBSCRIBE å‘½ä»¤è®¢é˜…æŸä¸ªæ¨¡å¼ï¼ŒæœåŠ¡å™¨ä¼šæ–°å»ºä¸€ä¸ª pubsubPattern ç»“æ„å¹¶èµ‹å€¼ï¼Œæ”¾å…¥ pubsub_patterns é“¾è¡¨ç»“å°¾</p><p>æ¨¡å¼çš„é€€è®¢å‘½ä»¤ PUNSUBSCRIBE æ˜¯è®¢é˜…å‘½ä»¤çš„åæ“ä½œï¼ŒæœåŠ¡å™¨åœ¨ pubsub_patterns é“¾è¡¨ä¸­æŸ¥æ‰¾å¹¶åˆ é™¤å¯¹åº”çš„ç»“æ„</p><hr><h4 id="å‘é€æ¶ˆæ¯" tabindex="-1"><a class="header-anchor" href="#å‘é€æ¶ˆæ¯" aria-hidden="true">#</a> å‘é€æ¶ˆæ¯</h4><p>Redis å®¢æˆ·ç«¯æ‰§è¡Œ <code>PUBLISH &lt;channel&gt; &lt;message&gt;</code> å‘½ä»¤å°†æ¶ˆæ¯ messageå‘é€ç»™é¢‘é“ channelï¼ŒæœåŠ¡å™¨ä¼šæ‰§è¡Œï¼š</p><ul><li>åœ¨ pubsub_channels å­—å…¸é‡Œæ‰¾åˆ°é¢‘é“ channel çš„è®¢é˜…è€…åå•ï¼Œå°†æ¶ˆæ¯ message å‘é€ç»™æ‰€æœ‰è®¢é˜…è€…</li><li>éå†æ•´ä¸ª pubsub_patterns é“¾è¡¨ï¼ŒæŸ¥æ‰¾ä¸ channel é¢‘é“ç›¸<strong>åŒ¹é…çš„æ¨¡å¼</strong>ï¼Œå¹¶å°†æ¶ˆæ¯å‘é€ç»™æ‰€æœ‰è®¢é˜…äº†è¿™äº›æ¨¡å¼çš„å®¢æˆ·ç«¯</li></ul><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// å¦‚æœé¢‘é“å’Œæ¨¡å¼ç›¸åŒ¹é…</span>
<span class="token keyword">if</span> <span class="token function">match</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> pubsubPattern<span class="token punctuation">.</span>pattern<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å°†æ¶ˆæ¯å‘é€ç»™è®¢é˜…è¯¥æ¨¡å¼çš„å®¢æˆ·ç«¯</span>
    <span class="token function">send_message</span><span class="token punctuation">(</span>pubsubPattern<span class="token punctuation">.</span>client<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="æŸ¥çœ‹ä¿¡æ¯" tabindex="-1"><a class="header-anchor" href="#æŸ¥çœ‹ä¿¡æ¯" aria-hidden="true">#</a> æŸ¥çœ‹ä¿¡æ¯</h4><p>PUBSUB å‘½ä»¤ç”¨æ¥æŸ¥çœ‹é¢‘é“æˆ–è€…æ¨¡å¼çš„ç›¸å…³ä¿¡æ¯</p><p><code>PUBSUB CHANNELS [pattern]</code> è¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…çš„é¢‘é“ï¼Œå…¶ä¸­ pattern å‚æ•°æ˜¯å¯é€‰çš„</p><ul><li>å¦‚æœä¸ç»™å®š pattern å‚æ•°ï¼Œé‚£ä¹ˆå‘½ä»¤è¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…çš„æ‰€æœ‰é¢‘é“</li><li>å¦‚æœç»™å®š pattern å‚æ•°ï¼Œé‚£ä¹ˆå‘½ä»¤è¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…çš„é¢‘é“ä¸­ä¸ pattern æ¨¡å¼ç›¸åŒ¹é…çš„é¢‘é“</li></ul><p><code>PUBSUB NUMSUB [channel-1 channel-2 ... channel-n]</code> å‘½ä»¤æ¥å—ä»»æ„å¤šä¸ªé¢‘é“ä½œä¸ºè¾“å…¥å‚æ•°ï¼Œå¹¶è¿”å›è¿™äº›é¢‘é“çš„è®¢é˜…è€…æ•°é‡</p><p><code>PUBSUB NUMPAT</code> å‘½ä»¤ç”¨äºè¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…æ¨¡å¼çš„æ•°é‡</p><hr><h3 id="acl-æŒ‡ä»¤" tabindex="-1"><a class="header-anchor" href="#acl-æŒ‡ä»¤" aria-hidden="true">#</a> ACL æŒ‡ä»¤</h3><p>Redis ACL æ˜¯ Access Control Listï¼ˆè®¿é—®æ§åˆ¶åˆ—è¡¨ï¼‰çš„ç¼©å†™ï¼Œè¯¥åŠŸèƒ½å…è®¸æ ¹æ®å¯ä»¥æ‰§è¡Œçš„å‘½ä»¤å’Œå¯ä»¥è®¿é—®çš„é”®æ¥é™åˆ¶æŸäº›è¿æ¥</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-ACLæŒ‡ä»¤.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li><p>acl catï¼šæŸ¥çœ‹æ·»åŠ æƒé™æŒ‡ä»¤ç±»åˆ«</p></li><li><p>acl whoamiï¼šæŸ¥çœ‹å½“å‰ç”¨æˆ·</p></li><li><p>acl setuser username on &gt;password ~cached:* +getï¼šè®¾ç½®æœ‰ç”¨æˆ·åã€å¯†ç ã€ACL æƒé™ï¼ˆåªèƒ½ getï¼‰</p></li></ul><hr><h3 id="ç›‘è§†å™¨" tabindex="-1"><a class="header-anchor" href="#ç›‘è§†å™¨" aria-hidden="true">#</a> ç›‘è§†å™¨</h3><p>MONITOR å‘½ä»¤ï¼Œå¯ä»¥å°†å®¢æˆ·ç«¯å˜ä¸ºä¸€ä¸ªç›‘è§†å™¨ï¼Œå®æ—¶åœ°æ¥æ”¶å¹¶æ‰“å°å‡ºæœåŠ¡å™¨å½“å‰å¤„ç†çš„å‘½ä»¤è¯·æ±‚çš„ç›¸å…³ä¿¡æ¯</p><div class="language-c line-numbers-mode" data-ext="c"><pre class="language-c"><code><span class="token comment">// å®ç°åŸç†</span>
def <span class="token function">MONITOR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span>
	<span class="token comment">// æ‰“å¼€å®¢æˆ·ç«¯çš„ç›‘è§†å™¨æ ‡å¿—</span>
	client<span class="token punctuation">.</span>flags <span class="token operator">|=</span> REDIS_MONITOR
        
  	<span class="token comment">// å°†å®¢æˆ·ç«¯æ·»åŠ åˆ°æœåŠ¡å™¨çŠ¶æ€çš„ redisServer.monitorsé“¾è¡¨çš„æœ«å°¾</span>
   	server<span class="token punctuation">.</span>monitors<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span>
  	<span class="token comment">// å‘å®¢æˆ·ç«¯è¿”å› ok</span>
	<span class="token function">send_reply</span><span class="token punctuation">(</span><span class="token string">&quot;OK&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœåŠ¡å™¨æ¯æ¬¡å¤„ç†å‘½ä»¤è¯·æ±‚éƒ½ä¼šè°ƒç”¨ replicationFeedMonitors å‡½æ•°ï¼Œå‡½æ•°å°†è¢«å¤„ç†çš„å‘½ä»¤è¯·æ±‚çš„ç›¸å…³ä¿¡æ¯<strong>å‘é€ç»™å„ä¸ªç›‘è§†å™¨</strong></p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/DB/Redis-ç›‘è§†å™¨.png" style="zoom:50%;"><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>redis<span class="token operator">&gt;</span> MONITOR 
OK 
<span class="token number">1378822099.421623</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token number">127.0</span>.0.1:56604<span class="token punctuation">]</span> <span class="token string">&quot;PING&quot;</span> 
<span class="token number">1378822105.089572</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token number">127.0</span>.0.1:56604<span class="token punctuation">]</span> <span class="token string">&quot;SET&quot;</span> <span class="token string">&quot;msg&quot;</span> <span class="token string">&quot;hello world&quot;</span> 
<span class="token number">1378822109.036925</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token number">127.0</span>.0.1:56604<span class="token punctuation">]</span> <span class="token string">&quot;SET&quot;</span> <span class="token string">&quot;number&quot;</span> <span class="token string">&quot;123&quot;</span> 
<span class="token number">1378822140.649496</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token number">127.0</span>.0.1:56604<span class="token punctuation">]</span> <span class="token string">&quot;SADD&quot;</span> <span class="token string">&quot;fruits&quot;</span> <span class="token string">&quot;Apple&quot;</span> <span class="token string">&quot;Banana&quot;</span> <span class="token string">&quot;Cherry&quot;</span> 
<span class="token number">1378822154.117160</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token number">127.0</span>.0.1:56604<span class="token punctuation">]</span> <span class="token string">&quot;EXPIRE&quot;</span> <span class="token string">&quot;msg&quot;</span> <span class="token string">&quot;10086&quot;</span> 
<span class="token number">1378822257.329412</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token number">127.0</span>.0.1:56604<span class="token punctuation">]</span> <span class="token string">&quot;KEYS&quot;</span> <span class="token string">&quot;*&quot;</span> 
<span class="token number">1378822258.690131</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token number">127.0</span>.0.1:56604<span class="token punctuation">]</span> <span class="token string">&quot;DBSIZE&quot;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="æ‰¹å¤„ç†" tabindex="-1"><a class="header-anchor" href="#æ‰¹å¤„ç†" aria-hidden="true">#</a> æ‰¹å¤„ç†</h3><p>Redis çš„ç®¡é“ Pipeline æœºåˆ¶å¯ä»¥ä¸€æ¬¡å¤„ç†å¤šæ¡æŒ‡ä»¤</p><ul><li>Pipeline ä¸­çš„å¤šæ¡å‘½ä»¤éåŸå­æ€§ï¼Œå› ä¸ºåœ¨å‘ç®¡é“å†…æ·»åŠ å‘½ä»¤æ—¶ï¼Œå…¶ä»–å®¢æˆ·ç«¯çš„å‘é€çš„å‘½ä»¤ä»ç„¶åœ¨æ‰§è¡Œ</li><li>åŸç”Ÿæ‰¹å‘½ä»¤ï¼ˆMSET ç­‰ï¼‰æ˜¯æœåŠ¡ç«¯å®ç°ï¼Œè€Œ Pipeline éœ€è¦æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯å…±åŒå®Œæˆ</li></ul><p>ä½¿ç”¨ Pipeline å°è£…çš„å‘½ä»¤æ•°é‡ä¸èƒ½å¤ªå¤šï¼Œæ•°æ®é‡è¿‡å¤§ä¼šå¢åŠ å®¢æˆ·ç«¯çš„ç­‰å¾…æ—¶é—´ï¼Œé€ æˆç½‘ç»œé˜»å¡ï¼ŒJedis ä¸­çš„ Pipeline ä½¿ç”¨æ–¹å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// åˆ›å»ºç®¡é“</span>
<span class="token class-name">Pipeline</span> pipeline <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">pipelined</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ”¾å…¥å‘½ä»¤åˆ°ç®¡é“</span>
    pipeline<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;key_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token string">&quot;value_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">1000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ¯æ”¾å…¥1000æ¡å‘½ä»¤ï¼Œæ‰¹é‡æ‰§è¡Œ</span>
        pipeline<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é›†ç¾¤ä¸‹æ¨¡å¼ä¸‹ï¼Œæ‰¹å¤„ç†å‘½ä»¤çš„å¤šä¸ª key å¿…é¡»è½åœ¨ä¸€ä¸ªæ’æ§½ä¸­ï¼Œå¦åˆ™å°±ä¼šå¯¼è‡´æ‰§è¡Œå¤±è´¥ï¼ŒN æ¡æ‰¹å¤„ç†å‘½ä»¤çš„ä¼˜åŒ–æ–¹å¼ï¼š</p><ul><li>ä¸²è¡Œå‘½ä»¤ï¼šfor å¾ªç¯éå†ï¼Œä¾æ¬¡æ‰§è¡Œæ¯ä¸ªå‘½ä»¤</li><li>ä¸²è¡Œ slotï¼šåœ¨å®¢æˆ·ç«¯è®¡ç®—æ¯ä¸ª key çš„ slotï¼Œå°† slot ä¸€è‡´çš„åˆ†ä¸ºä¸€ç»„ï¼Œæ¯ç»„éƒ½åˆ©ç”¨ Pipeline æ‰¹å¤„ç†ï¼Œä¸²è¡Œæ‰§è¡Œå„ç»„å‘½ä»¤</li><li>å¹¶è¡Œ slotï¼šåœ¨å®¢æˆ·ç«¯è®¡ç®—æ¯ä¸ª key çš„ slotï¼Œå°† slot ä¸€è‡´çš„åˆ†ä¸ºä¸€ç»„ï¼Œæ¯ç»„éƒ½åˆ©ç”¨ Pipeline æ‰¹å¤„ç†ï¼Œ<strong>å¹¶è¡Œæ‰§è¡Œå„ç»„å‘½ä»¤</strong></li><li>hash_tagï¼šå°†æ‰€æœ‰ key è®¾ç½®ç›¸åŒçš„ hash_tagï¼Œåˆ™æ‰€æœ‰ key çš„ slot ä¸€å®šç›¸åŒ</li></ul><table><thead><tr><th></th><th>è€—æ—¶</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr><td>ä¸²è¡Œå‘½ä»¤</td><td>N æ¬¡ç½‘ç»œè€—æ—¶ + N æ¬¡å‘½ä»¤è€—æ—¶</td><td>å®ç°ç®€å•</td><td>è€—æ—¶ä¹…</td></tr><tr><td>ä¸²è¡Œ slot</td><td>m æ¬¡ç½‘ç»œè€—æ—¶ + N æ¬¡å‘½ä»¤è€—æ—¶ï¼Œm = key çš„ slot ä¸ªæ•°</td><td>è€—æ—¶è¾ƒçŸ­</td><td>å®ç°ç¨å¤æ‚</td></tr><tr><td>å¹¶è¡Œ slot</td><td>1 æ¬¡ç½‘ç»œè€—æ—¶ + N æ¬¡å‘½ä»¤è€—æ—¶</td><td>è€—æ—¶éå¸¸çŸ­</td><td>å®ç°å¤æ‚</td></tr><tr><td>hash_tag</td><td>1 æ¬¡ç½‘ç»œè€—æ—¶ + N æ¬¡å‘½ä»¤è€—æ—¶</td><td>è€—æ—¶éå¸¸çŸ­ã€å®ç°ç®€å•</td><td>å®¹æ˜“å‡ºç°<strong>æ•°æ®å€¾æ–œ</strong></td></tr></tbody></table><hr><h2 id="è§£å†³æ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#è§£å†³æ–¹æ¡ˆ" aria-hidden="true">#</a> è§£å†³æ–¹æ¡ˆ</h2><h3 id="ç¼“å­˜æ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜æ–¹æ¡ˆ" aria-hidden="true">#</a> ç¼“å­˜æ–¹æ¡ˆ</h3><h4 id="ç¼“å­˜æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜æ¨¡å¼" aria-hidden="true">#</a> ç¼“å­˜æ¨¡å¼</h4><h5 id="æ—è·¯ç¼“å­˜" tabindex="-1"><a class="header-anchor" href="#æ—è·¯ç¼“å­˜" aria-hidden="true">#</a> æ—è·¯ç¼“å­˜</h5><p>ç¼“å­˜æœ¬è´¨ï¼šå¼¥è¡¥ CPU çš„é«˜ç®—åŠ›å’Œ IO çš„æ…¢è¯»å†™ä¹‹é—´å·¨å¤§çš„é¸¿æ²Ÿ</p><p>æ—è·¯ç¼“å­˜æ¨¡å¼ Cache Aside Pattern æ˜¯å¹³æ—¶ä½¿ç”¨æ¯”è¾ƒå¤šçš„ä¸€ä¸ªç¼“å­˜è¯»å†™æ¨¡å¼ï¼Œæ¯”è¾ƒé€‚åˆè¯»è¯·æ±‚æ¯”è¾ƒå¤šçš„åœºæ™¯</p><p>Cache Aside Pattern ä¸­æœåŠ¡ç«¯éœ€è¦åŒæ—¶ç»´ç³» DB å’Œ cacheï¼Œå¹¶ä¸”æ˜¯ä»¥ DB çš„ç»“æœä¸ºå‡†</p><ul><li>å†™æ“ä½œï¼šå…ˆæ›´æ–° DBï¼Œç„¶åç›´æ¥åˆ é™¤ cache</li><li>è¯»æ“ä½œï¼šä» cache ä¸­è¯»å–æ•°æ®ï¼Œè¯»å–åˆ°å°±ç›´æ¥è¿”å›ï¼›è¯»å–ä¸åˆ°å°±ä» DB ä¸­è¯»å–æ•°æ®è¿”å›ï¼Œå¹¶æ”¾åˆ° cache</li></ul><p>æ—¶åºå¯¼è‡´çš„ä¸ä¸€è‡´é—®é¢˜ï¼š</p><ul><li><p>åœ¨å†™æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œä¸èƒ½å…ˆåˆ é™¤ cache å†æ›´æ–° DBï¼Œå› ä¸ºä¼šé€ æˆç¼“å­˜çš„ä¸ä¸€è‡´ã€‚æ¯”å¦‚è¯·æ±‚ 1 å…ˆå†™æ•°æ® Aï¼Œè¯·æ±‚ 2 éšåè¯»æ•°æ® Aï¼Œå½“è¯·æ±‚ 1 åˆ é™¤ cache åï¼Œè¯·æ±‚ 2 ç›´æ¥è¯»å–äº† DBï¼Œæ­¤æ—¶è¯·æ±‚ 1 è¿˜æ²¡å†™å…¥ DBï¼ˆå»¶è¿ŸåŒåˆ ï¼‰</p></li><li><p>åœ¨å†™æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œå…ˆæ›´æ–° DB å†åˆ é™¤ cache ä¹Ÿä¼šå‡ºç°é—®é¢˜ï¼Œä½†æ˜¯æ¦‚ç‡å¾ˆå°ï¼Œå› ä¸ºç¼“å­˜çš„å†™å…¥é€Ÿåº¦éå¸¸å¿«</p></li></ul><p>æ—è·¯ç¼“å­˜çš„ç¼ºç‚¹ï¼š</p><ul><li>é¦–æ¬¡è¯·æ±‚æ•°æ®ä¸€å®šä¸åœ¨ cache çš„é—®é¢˜ï¼Œä¸€èˆ¬é‡‡ç”¨ç¼“å­˜é¢„çƒ­çš„æ–¹æ³•ï¼Œå°†çƒ­ç‚¹æ•°æ®å¯ä»¥æå‰æ”¾å…¥ cache ä¸­</li><li>å†™æ“ä½œæ¯”è¾ƒé¢‘ç¹çš„è¯å¯¼è‡´ cache ä¸­çš„æ•°æ®ä¼šè¢«é¢‘ç¹è¢«åˆ é™¤ï¼Œå½±å“ç¼“å­˜å‘½ä¸­ç‡</li></ul><p><strong>åˆ é™¤ç¼“å­˜è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜çš„åŸå› </strong>ï¼šæ¯æ¬¡æ›´æ–°æ•°æ®åº“éƒ½æ›´æ–°ç¼“å­˜ï¼Œé€ æˆæ— æ•ˆå†™æ“ä½œè¾ƒå¤šï¼ˆæ‡’æƒ°åŠ è½½ï¼Œéœ€è¦çš„æ—¶å€™å†æ”¾å…¥ç¼“å­˜ï¼‰</p><hr><h5 id="è¯»å†™ç©¿é€" tabindex="-1"><a class="header-anchor" href="#è¯»å†™ç©¿é€" aria-hidden="true">#</a> è¯»å†™ç©¿é€</h5><p>è¯»å†™ç©¿é€æ¨¡å¼ Read/Write Through Patternï¼šæœåŠ¡ç«¯æŠŠ cache è§†ä¸ºä¸»è¦æ•°æ®å­˜å‚¨ï¼Œä»ä¸­è¯»å–æ•°æ®å¹¶å°†æ•°æ®å†™å…¥å…¶ä¸­ï¼Œcache è´Ÿè´£å°†æ­¤æ•°æ®åŒæ­¥å†™å…¥ DBï¼Œä»è€Œå‡è½»äº†åº”ç”¨ç¨‹åºçš„èŒè´£</p><ul><li><p>å†™æ“ä½œï¼šå…ˆæŸ¥ cacheï¼Œcache ä¸­ä¸å­˜åœ¨ï¼Œç›´æ¥æ›´æ–° DBï¼›cache ä¸­å­˜åœ¨åˆ™å…ˆæ›´æ–° cacheï¼Œç„¶å cache æœåŠ¡æ›´æ–° DBï¼ˆåŒæ­¥æ›´æ–° cache å’Œ DBï¼‰</p></li><li><p>è¯»æ“ä½œï¼šä» cache ä¸­è¯»å–æ•°æ®ï¼Œè¯»å–åˆ°å°±ç›´æ¥è¿”å› ï¼›è¯»å–ä¸åˆ°å…ˆä» DB åŠ è½½ï¼Œå†™å…¥åˆ° cache åè¿”å›å“åº”</p><p>Read-Through Pattern å®é™…åªæ˜¯åœ¨ Cache-Aside Pattern ä¹‹ä¸Šè¿›è¡Œäº†å°è£…ã€‚åœ¨ Cache-Aside Pattern ä¸‹ï¼Œå‘ç”Ÿè¯»è¯·æ±‚çš„æ—¶å€™ï¼Œå¦‚æœ cache ä¸­ä¸å­˜åœ¨å¯¹åº”çš„æ•°æ®ï¼Œæ˜¯ç”±å®¢æˆ·ç«¯è´Ÿè´£æŠŠæ•°æ®å†™å…¥ cacheï¼Œè€Œ Read Through Pattern åˆ™æ˜¯ cache æœåŠ¡è‡ªå·±æ¥å†™å…¥ç¼“å­˜çš„ï¼Œå¯¹å®¢æˆ·ç«¯æ˜¯é€æ˜çš„</p></li></ul><p>Read-Through Pattern ä¹Ÿå­˜åœ¨é¦–æ¬¡ä¸å‘½ä¸­çš„é—®é¢˜ï¼Œé‡‡ç”¨ç¼“å­˜é¢„çƒ­è§£å†³</p><hr><h5 id="å¼‚æ­¥ç¼“å­˜" tabindex="-1"><a class="header-anchor" href="#å¼‚æ­¥ç¼“å­˜" aria-hidden="true">#</a> å¼‚æ­¥ç¼“å­˜</h5><p>å¼‚æ­¥ç¼“å­˜å†™å…¥ Write Behind Pattern ç”± cache æœåŠ¡æ¥è´Ÿè´£ cache å’Œ DB çš„è¯»å†™ï¼Œå¯¹æ¯”è¯»å†™ç©¿é€ä¸åŒçš„æ˜¯ Write Behind Caching æ˜¯åªæ›´æ–°ç¼“å­˜ï¼Œä¸ç›´æ¥æ›´æ–° DBï¼Œæ”¹ä¸º<strong>å¼‚æ­¥æ‰¹é‡</strong>çš„æ–¹å¼æ¥æ›´æ–° DBï¼Œå¯ä»¥å‡å°å†™çš„æˆæœ¬</p><p>ç¼ºç‚¹ï¼šè¿™ç§æ¨¡å¼å¯¹æ•°æ®ä¸€è‡´æ€§æ²¡æœ‰é«˜è¦æ±‚ï¼Œå¯èƒ½å‡ºç° cache è¿˜æ²¡å¼‚æ­¥æ›´æ–° DBï¼ŒæœåŠ¡å°±æŒ‚æ‰äº†</p><p>åº”ç”¨ï¼š</p><ul><li><p>DB çš„å†™æ€§èƒ½éå¸¸é«˜ï¼Œé€‚åˆä¸€äº›æ•°æ®ç»å¸¸å˜åŒ–åˆå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼Œæ¯”å¦‚æµè§ˆé‡ã€ç‚¹èµé‡</p></li><li><p>MySQL çš„ InnoDB Buffer Pool æœºåˆ¶ç”¨åˆ°äº†è¿™ç§ç­–ç•¥</p></li></ul><hr><h4 id="ç¼“å­˜ä¸€è‡´" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜ä¸€è‡´" aria-hidden="true">#</a> ç¼“å­˜ä¸€è‡´</h4><p>ä½¿ç”¨ç¼“å­˜ä»£è¡¨ä¸éœ€è¦å¼ºä¸€è‡´æ€§ï¼Œåªéœ€è¦æœ€ç»ˆä¸€è‡´æ€§</p><p>ç¼“å­˜ä¸ä¸€è‡´çš„æ–¹æ³•ï¼š</p><ul><li><p>æ•°æ®åº“å’Œç¼“å­˜æ•°æ®å¼ºä¸€è‡´åœºæ™¯ï¼š</p><ul><li><p>åŒæ­¥åŒå†™ï¼šæ›´æ–° DB æ—¶åŒæ ·æ›´æ–° cacheï¼Œä¿è¯åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œé€šè¿‡åŠ é”æ¥ä¿è¯æ›´æ–° cache æ—¶ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜</p></li><li><p>å»¶è¿ŸåŒåˆ ï¼šå…ˆæ·˜æ±°ç¼“å­˜å†å†™æ•°æ®åº“ï¼Œä¼‘çœ  1 ç§’å†æ¬¡æ·˜æ±°ç¼“å­˜ï¼Œå¯ä»¥å°† 1 ç§’å†…é€ æˆçš„ç¼“å­˜è„æ•°æ®å†æ¬¡åˆ é™¤</p></li><li><p>å¼‚æ­¥é€šçŸ¥ï¼š</p><ul><li>åŸºäº MQ çš„å¼‚æ­¥é€šçŸ¥ï¼šå¯¹æ•°æ®çš„ä¿®æ”¹åï¼Œä»£ç éœ€è¦å‘é€ä¸€æ¡æ¶ˆæ¯åˆ° MQ ä¸­ï¼Œç¼“å­˜æœåŠ¡ç›‘å¬ MQ æ¶ˆæ¯</li><li>Canal è®¢é˜… MySQL binlog çš„å˜æ›´ä¸ŠæŠ¥ç»™ Kafkaï¼Œç³»ç»Ÿç›‘å¬ Kafka æ¶ˆæ¯è§¦å‘ç¼“å­˜å¤±æ•ˆï¼Œæˆ–è€…ç›´æ¥å°†å˜æ›´å‘é€åˆ°å¤„ç†æœåŠ¡ï¼Œ<strong>æ²¡æœ‰ä»»ä½•ä»£ç ä¾µå…¥</strong></li></ul><p>ä½è€¦åˆï¼Œå¯ä»¥åŒæ—¶é€šçŸ¥å¤šä¸ªç¼“å­˜æœåŠ¡ï¼Œä½†æ˜¯æ—¶æ•ˆæ€§ä¸€èˆ¬ï¼Œå¯èƒ½å­˜åœ¨ä¸­é—´ä¸ä¸€è‡´çŠ¶æ€</p></li></ul></li><li><p>ä½ä¸€è‡´æ€§åœºæ™¯ï¼š</p><ul><li>æ›´æ–° DB çš„æ—¶å€™åŒæ ·æ›´æ–° cacheï¼Œä½†æ˜¯ç»™ç¼“å­˜åŠ ä¸€ä¸ªæ¯”è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯å³ä½¿æ•°æ®ä¸ä¸€è‡´å½±å“ä¹Ÿæ¯”è¾ƒå°</li><li>ä½¿ç”¨ Redis è‡ªå¸¦çš„å†…å­˜æ·˜æ±°æœºåˆ¶</li></ul></li></ul><hr><h4 id="ç¼“å­˜é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜é—®é¢˜" aria-hidden="true">#</a> ç¼“å­˜é—®é¢˜</h4><h5 id="ç¼“å­˜é¢„çƒ­" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜é¢„çƒ­" aria-hidden="true">#</a> ç¼“å­˜é¢„çƒ­</h5><p>åœºæ™¯ï¼šå®•æœºï¼ŒæœåŠ¡å™¨å¯åŠ¨åè¿…é€Ÿå®•æœº</p><p>é—®é¢˜æ’æŸ¥ï¼š</p><ol><li><p>è¯·æ±‚æ•°é‡è¾ƒé«˜ï¼Œå¤§é‡çš„è¯·æ±‚è¿‡æ¥ä¹‹åéƒ½éœ€è¦å»ä»ç¼“å­˜ä¸­è·å–æ•°æ®ï¼Œä½†æ˜¯ç¼“å­˜ä¸­åˆæ²¡æœ‰ï¼Œæ­¤æ—¶ä»æ•°æ®åº“ä¸­æŸ¥æ‰¾æ•°æ®ç„¶åå°†æ•°æ®å†å­˜å…¥ç¼“å­˜ï¼Œé€ æˆäº†çŸ­æœŸå†…å¯¹ redis çš„é«˜å¼ºåº¦æ“ä½œä»è€Œå¯¼è‡´é—®é¢˜</p></li><li><p>ä¸»ä»ä¹‹é—´æ•°æ®ååé‡è¾ƒå¤§ï¼Œæ•°æ®åŒæ­¥æ“ä½œé¢‘åº¦è¾ƒé«˜</p></li></ol><p>è§£å†³æ–¹æ¡ˆï¼š</p><ul><li><p>å‰ç½®å‡†å¤‡å·¥ä½œï¼š</p><ol><li><p>æ—¥å¸¸ä¾‹è¡Œç»Ÿè®¡æ•°æ®è®¿é—®è®°å½•ï¼Œç»Ÿè®¡è®¿é—®é¢‘åº¦è¾ƒé«˜çš„çƒ­ç‚¹æ•°æ®</p></li><li><p>åˆ©ç”¨ LRU æ•°æ®åˆ é™¤ç­–ç•¥ï¼Œæ„å»ºæ•°æ®ç•™å­˜é˜Ÿåˆ—ä¾‹å¦‚ï¼šstorm ä¸ kafka é…åˆ</p></li></ol></li><li><p>å‡†å¤‡å·¥ä½œï¼š</p><ol><li><p>å°†ç»Ÿè®¡ç»“æœä¸­çš„æ•°æ®åˆ†ç±»ï¼Œæ ¹æ®çº§åˆ«ï¼Œredis ä¼˜å…ˆåŠ è½½çº§åˆ«è¾ƒé«˜çš„çƒ­ç‚¹æ•°æ®</p></li><li><p>åˆ©ç”¨åˆ†å¸ƒå¼å¤šæœåŠ¡å™¨åŒæ—¶è¿›è¡Œæ•°æ®è¯»å–ï¼Œæé€Ÿæ•°æ®åŠ è½½è¿‡ç¨‹</p></li><li><p>çƒ­ç‚¹æ•°æ®ä¸»ä»åŒæ—¶é¢„çƒ­</p></li></ol></li><li><p>å®æ–½ï¼š</p><ol start="4"><li><p>ä½¿ç”¨è„šæœ¬ç¨‹åºå›ºå®šè§¦å‘æ•°æ®é¢„çƒ­è¿‡ç¨‹</p></li><li><p>å¦‚æœæ¡ä»¶å…è®¸ï¼Œä½¿ç”¨äº† CDNï¼ˆå†…å®¹åˆ†å‘ç½‘ç»œï¼‰ï¼Œæ•ˆæœä¼šæ›´å¥½</p></li></ol></li></ul><p>æ€»çš„æ¥è¯´ï¼šç¼“å­˜é¢„çƒ­å°±æ˜¯ç³»ç»Ÿå¯åŠ¨å‰ï¼Œæå‰å°†ç›¸å…³çš„ç¼“å­˜æ•°æ®ç›´æ¥åŠ è½½åˆ°ç¼“å­˜ç³»ç»Ÿã€‚é¿å…åœ¨ç”¨æˆ·è¯·æ±‚çš„æ—¶å€™ï¼Œå…ˆæŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åå†å°†æ•°æ®ç¼“å­˜çš„é—®é¢˜ï¼Œç”¨æˆ·ç›´æ¥æŸ¥è¯¢äº‹å…ˆè¢«é¢„çƒ­çš„ç¼“å­˜æ•°æ®</p><hr><h5 id="ç¼“å­˜é›ªå´©" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜é›ªå´©" aria-hidden="true">#</a> ç¼“å­˜é›ªå´©</h5><p>åœºæ™¯ï¼šæ•°æ®åº“æœåŠ¡å™¨å´©æºƒï¼Œä¸€è¿ä¸²çš„é—®é¢˜ä¼šéšä¹‹è€Œæ¥</p><p>é—®é¢˜æ’æŸ¥ï¼šåœ¨ä¸€ä¸ªè¾ƒçŸ­çš„æ—¶é—´å†…ï¼Œ<strong>ç¼“å­˜ä¸­è¾ƒå¤šçš„ key é›†ä¸­è¿‡æœŸ</strong>ï¼Œæ­¤å‘¨æœŸå†…è¯·æ±‚è®¿é—®è¿‡æœŸçš„æ•°æ® Redis æœªå‘½ä¸­ï¼ŒRedis å‘æ•°æ®åº“è·å–æ•°æ®ï¼Œæ•°æ®åº“åŒæ—¶æ”¶åˆ°å¤§é‡çš„è¯·æ±‚æ— æ³•åŠæ—¶å¤„ç†ã€‚</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><ol><li>åŠ é”ï¼Œæ…ç”¨</li><li>è®¾ç½®çƒ­ç‚¹æ•°æ®æ°¸è¿œä¸è¿‡æœŸï¼Œå¦‚æœç¼“å­˜æ•°æ®åº“æ˜¯åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå°†çƒ­ç‚¹æ•°æ®å‡åŒ€åˆ†å¸ƒåœ¨ä¸åŒæå¾—ç¼“å­˜æ•°æ®åº“ä¸­</li><li>ç¼“å­˜æ•°æ®çš„è¿‡æœŸæ—¶é—´è®¾ç½®éšæœºï¼Œé˜²æ­¢åŒä¸€æ—¶é—´å¤§é‡æ•°æ®è¿‡æœŸç°è±¡å‘ç”Ÿ</li><li>æ„å»º<strong>å¤šçº§ç¼“å­˜</strong>æ¶æ„ï¼ŒNginx ç¼“å­˜ + Redis ç¼“å­˜ + ehcache ç¼“å­˜</li><li>ç¾éš¾é¢„è­¦æœºåˆ¶ï¼Œç›‘æ§ Redis æœåŠ¡å™¨æ€§èƒ½æŒ‡æ ‡ï¼ŒCPU ä½¿ç”¨ç‡ã€å†…å­˜å®¹é‡ã€å¹³å‡å“åº”æ—¶é—´ã€çº¿ç¨‹æ•°</li><li><strong>é™æµã€é™çº§</strong>ï¼šçŸ­æ—¶é—´èŒƒå›´å†…ç‰ºç‰²ä¸€äº›å®¢æˆ·ä½“éªŒï¼Œé™åˆ¶ä¸€éƒ¨åˆ†è¯·æ±‚è®¿é—®ï¼Œé™ä½åº”ç”¨æœåŠ¡å™¨å‹åŠ›ï¼Œå¾…ä¸šåŠ¡ä½é€Ÿè¿è½¬åå†é€æ­¥æ”¾å¼€è®¿é—®</li></ol><p>æ€»çš„æ¥è¯´ï¼šç¼“å­˜é›ªå´©å°±æ˜¯ç¬é—´è¿‡æœŸæ•°æ®é‡å¤ªå¤§ï¼Œå¯¼è‡´å¯¹æ•°æ®åº“æœåŠ¡å™¨é€ æˆå‹åŠ›ã€‚å¦‚èƒ½å¤Ÿæœ‰æ•ˆé¿å…è¿‡æœŸæ—¶é—´é›†ä¸­ï¼Œå¯ä»¥æœ‰æ•ˆè§£å†³é›ªå´©ç°è±¡çš„å‡ºç°ï¼ˆçº¦ 40%ï¼‰ï¼Œé…åˆå…¶ä»–ç­–ç•¥ä¸€èµ·ä½¿ç”¨ï¼Œå¹¶ç›‘æ§æœåŠ¡å™¨çš„è¿è¡Œæ•°æ®ï¼Œæ ¹æ®è¿è¡Œè®°å½•åšå¿«é€Ÿè°ƒæ•´ã€‚</p><hr><h5 id="ç¼“å­˜å‡»ç©¿" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜å‡»ç©¿" aria-hidden="true">#</a> ç¼“å­˜å‡»ç©¿</h5><p>ç¼“å­˜å‡»ç©¿ä¹Ÿå«çƒ­ç‚¹ Key é—®é¢˜</p><ol><li><p><strong>Redis ä¸­æŸä¸ª key è¿‡æœŸï¼Œè¯¥ key è®¿é—®é‡å·¨å¤§</strong></p></li><li><p>å¤šä¸ªæ•°æ®è¯·æ±‚ä»æœåŠ¡å™¨ç›´æ¥å‹åˆ° Redis åï¼Œå‡æœªå‘½ä¸­</p></li><li><p>Redis åœ¨çŸ­æ—¶é—´å†…å‘èµ·äº†å¤§é‡å¯¹æ•°æ®åº“ä¸­åŒä¸€æ•°æ®çš„è®¿é—®</p></li></ol><p>è§£å†³æ–¹æ¡ˆï¼š</p><ol><li><p>é¢„å…ˆè®¾å®šï¼šä»¥ç”µå•†ä¸ºä¾‹ï¼Œæ¯ä¸ªå•†å®¶æ ¹æ®åº—é“ºç­‰çº§ï¼ŒæŒ‡å®šè‹¥å¹²æ¬¾ä¸»æ‰“å•†å“ï¼Œåœ¨è´­ç‰©èŠ‚æœŸé—´ï¼ŒåŠ å¤§æ­¤ç±»ä¿¡æ¯ key çš„è¿‡æœŸæ—¶é•¿ æ³¨æ„ï¼šè´­ç‰©èŠ‚ä¸ä»…ä»…æŒ‡å½“å¤©ï¼Œä»¥åŠåç»­è‹¥å¹²å¤©ï¼Œè®¿é—®å³°å€¼å‘ˆç°é€æ¸é™ä½çš„è¶‹åŠ¿</p></li><li><p>ç°åœºè°ƒæ•´ï¼šç›‘æ§è®¿é—®é‡ï¼Œå¯¹è‡ªç„¶æµé‡æ¿€å¢çš„æ•°æ®<strong>å»¶é•¿è¿‡æœŸæ—¶é—´æˆ–è®¾ç½®ä¸ºæ°¸ä¹…æ€§ key</strong></p></li><li><p>åå°åˆ·æ–°æ•°æ®ï¼šå¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼Œé«˜å³°æœŸæ¥ä¸´ä¹‹å‰ï¼Œåˆ·æ–°æ•°æ®æœ‰æ•ˆæœŸï¼Œç¡®ä¿ä¸ä¸¢å¤±</p></li><li><p><strong>äºŒçº§ç¼“å­˜</strong>ï¼šè®¾ç½®ä¸åŒçš„å¤±æ•ˆæ—¶é—´ï¼Œä¿éšœä¸ä¼šè¢«åŒæ—¶æ·˜æ±°å°±è¡Œ</p></li><li><p>åŠ é”ï¼šåˆ†å¸ƒå¼é”ï¼Œé˜²æ­¢è¢«å‡»ç©¿ï¼Œä½†æ˜¯è¦æ³¨æ„ä¹Ÿæ˜¯æ€§èƒ½ç“¶é¢ˆï¼Œæ…é‡</p></li></ol><p>æ€»çš„æ¥è¯´ï¼šç¼“å­˜å‡»ç©¿å°±æ˜¯å•ä¸ªé«˜çƒ­æ•°æ®è¿‡æœŸçš„ç¬é—´ï¼Œæ•°æ®è®¿é—®é‡è¾ƒå¤§ï¼Œæœªå‘½ä¸­ Redis åï¼Œå‘èµ·äº†å¤§é‡å¯¹åŒä¸€æ•°æ®çš„æ•°æ®åº“è®¿é—®ï¼Œå¯¼è‡´å¯¹æ•°æ®åº“æœåŠ¡å™¨é€ æˆå‹åŠ›ã€‚åº”å¯¹ç­–ç•¥åº”è¯¥åœ¨ä¸šåŠ¡æ•°æ®åˆ†æä¸é¢„é˜²æ–¹é¢è¿›è¡Œï¼Œé…åˆè¿è¡Œç›‘æ§æµ‹è¯•ä¸å³æ—¶è°ƒæ•´ç­–ç•¥ï¼Œæ¯•ç«Ÿå•ä¸ª key çš„è¿‡æœŸç›‘æ§éš¾åº¦è¾ƒé«˜ï¼Œé…åˆé›ªå´©å¤„ç†ç­–ç•¥å³å¯</p><hr><h5 id="ç¼“å­˜ç©¿é€" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜ç©¿é€" aria-hidden="true">#</a> ç¼“å­˜ç©¿é€</h5><p>åœºæ™¯ï¼šç³»ç»Ÿå¹³ç¨³è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œåº”ç”¨æœåŠ¡å™¨æµé‡éšæ—¶é—´å¢é‡è¾ƒå¤§ï¼ŒRedis æœåŠ¡å™¨å‘½ä¸­ç‡éšæ—¶é—´é€æ­¥é™ä½ï¼ŒRedis å†…å­˜å¹³ç¨³ï¼Œå†…å­˜æ— å‹åŠ›ï¼ŒRedis æœåŠ¡å™¨ CPU å ç”¨æ¿€å¢ï¼Œæ•°æ®åº“æœåŠ¡å™¨å‹åŠ›æ¿€å¢ï¼Œæ•°æ®åº“å´©æºƒ</p><p>é—®é¢˜æ’æŸ¥ï¼š</p><ol><li><p>Redis ä¸­å¤§é¢ç§¯å‡ºç°æœªå‘½ä¸­</p></li><li><p>å‡ºç°éæ­£å¸¸ URL è®¿é—®</p></li></ol><p>é—®é¢˜åˆ†æï¼š</p><ul><li>è®¿é—®äº†ä¸å­˜åœ¨çš„æ•°æ®ï¼Œè·³è¿‡äº† Redis ç¼“å­˜ï¼Œæ•°æ®åº“é¡µæŸ¥è¯¢ä¸åˆ°å¯¹åº”æ•°æ®</li><li>Redis è·å–åˆ° null æ•°æ®æœªè¿›è¡ŒæŒä¹…åŒ–ï¼Œç›´æ¥è¿”å›</li><li>å‡ºç°é»‘å®¢æ”»å‡»æœåŠ¡å™¨</li></ul><p>è§£å†³æ–¹æ¡ˆï¼š</p><ol><li><p>ç¼“å­˜ nullï¼šå¯¹æŸ¥è¯¢ç»“æœä¸º null çš„æ•°æ®è¿›è¡Œç¼“å­˜ï¼Œè®¾å®šçŸ­æ—¶é™ï¼Œä¾‹å¦‚ 30-60 ç§’ï¼Œæœ€é«˜ 5 åˆ†é’Ÿ</p></li><li><p>ç™½åå•ç­–ç•¥ï¼šæå‰é¢„çƒ­å„ç§åˆ†ç±»<strong>æ•°æ® id å¯¹åº”çš„ bitmaps</strong>ï¼Œid ä½œä¸º bitmaps çš„ offsetï¼Œç›¸å½“äºè®¾ç½®äº†æ•°æ®ç™½åå•ã€‚å½“åŠ è½½æ­£å¸¸æ•°æ®æ—¶æ”¾è¡Œï¼ŒåŠ è½½å¼‚å¸¸æ•°æ®æ—¶ç›´æ¥æ‹¦æˆªï¼ˆæ•ˆç‡åä½ï¼‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆæœ‰å…³å¸ƒéš†è¿‡æ»¤å™¨çš„å‘½ä¸­é—®é¢˜å¯¹å½“å‰çŠ¶å†µå¯ä»¥å¿½ç•¥ï¼‰</p></li><li><p>å®æ—¶ç›‘æ§ï¼šå®æ—¶ç›‘æ§ Redis å‘½ä¸­ç‡ï¼ˆä¸šåŠ¡æ­£å¸¸èŒƒå›´æ—¶ï¼Œé€šå¸¸ä¼šæœ‰ä¸€ä¸ªæ³¢åŠ¨å€¼ï¼‰ä¸ null æ•°æ®çš„å æ¯”</p><ul><li>éæ´»åŠ¨æ—¶æ®µæ³¢åŠ¨ï¼šé€šå¸¸æ£€æµ‹ 3-5 å€ï¼Œè¶…è¿‡ 5 å€çº³å…¥é‡ç‚¹æ’æŸ¥å¯¹è±¡</li><li>æ´»åŠ¨æ—¶æ®µæ³¢åŠ¨ï¼šé€šå¸¸æ£€æµ‹10-50 å€ï¼Œè¶…è¿‡ 50 å€çº³å…¥é‡ç‚¹æ’æŸ¥å¯¹è±¡</li></ul><p>æ ¹æ®å€æ•°ä¸åŒï¼Œå¯åŠ¨ä¸åŒçš„æ’æŸ¥æµç¨‹ã€‚ç„¶åä½¿ç”¨é»‘åå•è¿›è¡Œé˜²æ§</p></li><li><p>key åŠ å¯†ï¼šä¸´æ—¶å¯åŠ¨é˜²ç¾ä¸šåŠ¡ keyï¼Œå¯¹ key è¿›è¡Œä¸šåŠ¡å±‚ä¼ è¾“åŠ å¯†æœåŠ¡ï¼Œè®¾å®šæ ¡éªŒç¨‹åºï¼Œè¿‡æ¥çš„ key æ ¡éªŒï¼›ä¾‹å¦‚æ¯å¤©éšæœºåˆ†é… 60 ä¸ªåŠ å¯†ä¸²ï¼ŒæŒ‘é€‰ 2 åˆ° 3 ä¸ªï¼Œæ··æ·†åˆ°é¡µé¢æ•°æ® id ä¸­ï¼Œå‘ç°è®¿é—® key ä¸æ»¡è¶³è§„åˆ™ï¼Œé©³å›æ•°æ®è®¿é—®</p></li></ol><p>æ€»çš„æ¥è¯´ï¼šç¼“å­˜å‡»ç©¿æ˜¯æŒ‡è®¿é—®äº†ä¸å­˜åœ¨çš„æ•°æ®ï¼Œè·³è¿‡äº†åˆæ³•æ•°æ®çš„ Redis æ•°æ®ç¼“å­˜é˜¶æ®µï¼Œ<strong>æ¯æ¬¡è®¿é—®æ•°æ®åº“</strong>ï¼Œå¯¼è‡´å¯¹æ•°æ®åº“æœåŠ¡å™¨é€ æˆå‹åŠ›ã€‚é€šå¸¸æ­¤ç±»æ•°æ®çš„å‡ºç°é‡æ˜¯ä¸€ä¸ªè¾ƒä½çš„å€¼ï¼Œå½“å‡ºç°æ­¤ç±»æƒ…å†µä»¥æ¯’æ”»æ¯’ï¼Œå¹¶åŠæ—¶æŠ¥è­¦ã€‚æ— è®ºæ˜¯é»‘åå•è¿˜æ˜¯ç™½åå•ï¼Œéƒ½æ˜¯å¯¹æ•´ä½“ç³»ç»Ÿçš„å‹åŠ›ï¼Œè­¦æŠ¥è§£é™¤åå°½å¿«ç§»é™¤</p><p>å‚è€ƒè§†é¢‘ï¼š<a href="https://www.bilibili.com/video/BV15y4y1r7X3" target="_blank" rel="noopener noreferrer">https://www.bilibili.com/video/BV15y4y1r7X3<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><hr><h3 id="key-è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#key-è®¾è®¡" aria-hidden="true">#</a> Key è®¾è®¡</h3><p>å¤§ Keyï¼šé€šå¸¸ä»¥ Key çš„å¤§å°å’Œ Key ä¸­æˆå‘˜çš„æ•°é‡æ¥ç»¼åˆåˆ¤å®šï¼Œå¼•å‘çš„é—®é¢˜ï¼š</p><ul><li>å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤çš„æ—¶é•¿å˜æ…¢</li><li>Redis å†…å­˜è¾¾åˆ° maxmemory å®šä¹‰çš„ä¸Šé™å¼•å‘æ“ä½œé˜»å¡æˆ–é‡è¦çš„ Key è¢«é€å‡ºï¼Œç”šè‡³å¼•å‘å†…å­˜æº¢å‡ºï¼ˆOOMï¼‰</li><li>é›†ç¾¤æ¶æ„ä¸‹ï¼ŒæŸä¸ªæ•°æ®åˆ†ç‰‡çš„å†…å­˜ä½¿ç”¨ç‡è¿œè¶…å…¶ä»–æ•°æ®åˆ†ç‰‡ï¼Œä½¿<strong>æ•°æ®åˆ†ç‰‡çš„å†…å­˜èµ„æºä¸å‡è¡¡</strong></li><li>å¯¹å¤§ Key æ‰§è¡Œè¯»è¯·æ±‚ï¼Œä¼šä½¿ Redis å®ä¾‹çš„å¸¦å®½ä½¿ç”¨ç‡è¢«å æ»¡ï¼Œå¯¼è‡´è‡ªèº«æœåŠ¡å˜æ…¢ï¼ŒåŒæ—¶æ˜“æ³¢åŠç›¸å…³çš„æœåŠ¡</li><li>å¯¹å¤§ Key æ‰§è¡Œåˆ é™¤æ“ä½œï¼Œä¼šé€ æˆä¸»åº“è¾ƒé•¿æ—¶é—´çš„é˜»å¡ï¼Œè¿›è€Œå¯èƒ½å¼•å‘åŒæ­¥ä¸­æ–­æˆ–ä¸»ä»åˆ‡æ¢</li></ul><p>çƒ­ Keyï¼šé€šå¸¸ä»¥å…¶æ¥æ”¶åˆ°çš„ Key è¢«è¯·æ±‚é¢‘ç‡æ¥åˆ¤å®šï¼Œå¼•å‘çš„é—®é¢˜ï¼š</p><ul><li>å ç”¨å¤§é‡çš„ CPU èµ„æºï¼Œå½±å“å…¶ä»–è¯·æ±‚å¹¶å¯¼è‡´æ•´ä½“æ€§èƒ½é™ä½</li><li>åˆ†å¸ƒå¼é›†ç¾¤æ¶æ„ä¸‹ï¼Œäº§ç”Ÿ<strong>è®¿é—®å€¾æ–œ</strong>ï¼Œå³æŸä¸ªæ•°æ®åˆ†ç‰‡è¢«å¤§é‡è®¿é—®ï¼Œè€Œå…¶ä»–æ•°æ®åˆ†ç‰‡å¤„äºç©ºé—²çŠ¶æ€ï¼Œå¯èƒ½å¼•èµ·è¯¥æ•°æ®åˆ†ç‰‡çš„è¿æ¥æ•°è¢«è€—å°½ï¼Œæ–°çš„è¿æ¥å»ºç«‹è¯·æ±‚è¢«æ‹’ç»ç­‰é—®é¢˜</li><li>åœ¨æŠ¢è´­æˆ–ç§’æ€åœºæ™¯ä¸‹ï¼Œå¯èƒ½å› å•†å“å¯¹åº”åº“å­˜ Key çš„è¯·æ±‚é‡è¿‡å¤§ï¼Œè¶…å‡º Redis å¤„ç†èƒ½åŠ›é€ æˆè¶…å–</li><li>çƒ­ Key çš„è¯·æ±‚å‹åŠ›æ•°é‡è¶…å‡º Redis çš„æ‰¿å—èƒ½åŠ›æ˜“é€ æˆç¼“å­˜å‡»ç©¿ï¼Œå³å¤§é‡è¯·æ±‚å°†è¢«ç›´æ¥æŒ‡å‘åç«¯çš„å­˜å‚¨å±‚ï¼Œå¯¼è‡´å­˜å‚¨è®¿é—®é‡æ¿€å¢ç”šè‡³å®•æœºï¼Œä»è€Œå½±å“å…¶ä»–ä¸šåŠ¡</li></ul><p>çƒ­ Key åˆ†ç±»ä¸¤ç§ï¼Œæ²»ç†æ–¹å¼å¦‚ä¸‹ï¼š</p><ul><li>ä¸€ç§æ˜¯å•ä¸€æ•°æ®ï¼Œæ¯”å¦‚ç§’æ€åœºæ™¯ï¼Œå‡è®¾æ€»é‡ 10000 å¯ä»¥æ‹†ä¸ºå¤šä¸ª Key è¿›è¡Œè®¿é—®ï¼Œæ¯æ¬¡å¯¹è¯·æ±‚è¿›è¡Œè·¯ç”±åˆ°ä¸åŒçš„ Key è®¿é—®ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œä½†æ˜¯ä¼šå‡ºç°è®¿é—®ä¸åŒ Key äº§ç”Ÿçš„å‰©ä½™é‡æ˜¯ä¸åŒçš„ï¼Œè¿™æ—¶å¯ä»¥é€šè¿‡å‰ç«¯è¿›è¡Œ Mock å‡æ•°æ®</li><li>ä¸€ç§æ˜¯å¤šæ•°æ®é›†åˆï¼Œæ¯”å¦‚è¿›è¡Œ ID è¿‡æ»¤ï¼Œè¿™æ—¶å¯ä»¥æ·»åŠ æœ¬åœ° LRU ç¼“å­˜ï¼Œå‡å°‘å¯¹çƒ­ Key çš„è®¿é—®</li></ul><p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://help.aliyun.com/document_detail/353223.html" target="_blank" rel="noopener noreferrer">https://help.aliyun.com/document_detail/353223.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><hr><h3 id="æ…¢æŸ¥è¯¢" tabindex="-1"><a class="header-anchor" href="#æ…¢æŸ¥è¯¢" aria-hidden="true">#</a> æ…¢æŸ¥è¯¢</h3><p>ç¡®è®¤æœåŠ¡å’Œ Redis ä¹‹é—´çš„é“¾è·¯æ˜¯å¦æ­£å¸¸ï¼Œæ’é™¤ç½‘ç»œåŸå› åè¿›è¡Œ Redis çš„æ’æŸ¥ï¼š</p><ul><li>ä½¿ç”¨å¤æ‚åº¦è¿‡é«˜çš„å‘½ä»¤</li><li>æ“ä½œå¤§ keyï¼Œåˆ†é…å†…å­˜å’Œé‡Šæ”¾å†…å­˜ä¼šæ¯”è¾ƒè€—æ—¶</li><li>key é›†ä¸­è¿‡æœŸï¼Œå¯¼è‡´å®šæ—¶ä»»åŠ¡éœ€è¦æ›´é•¿çš„æ—¶é—´å»æ¸…ç†</li><li>å®ä¾‹å†…å­˜è¾¾åˆ°ä¸Šé™ï¼Œæ¯æ¬¡å†™å…¥æ–°çš„æ•°æ®ä¹‹å‰ï¼ŒRedis å¿…é¡»å…ˆä»å®ä¾‹ä¸­è¸¢å‡ºä¸€éƒ¨åˆ†æ•°æ®</li></ul><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/traditional/p/15633919.html%EF%BC%88%E9%9D%9E%E5%B8%B8%E5%A5%BD%EF%BC%89" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/traditional/p/15633919.htmlï¼ˆéå¸¸å¥½ï¼‰<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><hr></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/rockbenben/LearnData/edit/main/docs/æ•°æ®åº“/Redis.md" rel="noopener noreferrer" target="_blank" aria-label="ç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->ç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><!----></div></footer><nav class="vp-page-nav"><a class="vp-link nav-link prev" href="/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL.html"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->MySQL</div></a><!----></nav><div id="comment" class="waline-wrapper" darkmode="false" style="display:block;"><div data-waline provider="Waline"><div class="wl-reaction"><div class="wl-reaction-title">å·²åˆ°è¾¾æ–‡ç« åº•éƒ¨ï¼Œæ¬¢è¿ç•™è¨€ã€è¡¨æƒ…äº’åŠ¨~</div><ul class="wl-reaction-list"><!--[--><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-y/twemoji/13.1.0/72x72/1f44d.png" alt="èµä¸€ä¸ª"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text">èµä¸€ä¸ª</div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-y/twemoji/13.1.0/72x72/1f44f.png" alt="æ”¯æŒä¸‹"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text">æ”¯æŒä¸‹</div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-y/twemoji/13.1.0/72x72/1f60e.png" alt="æœ‰ç‚¹é…·"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text">æœ‰ç‚¹é…·</div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-y/twemoji/13.1.0/72x72/1f602.png" alt="å•¥ç©æ„"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text">å•¥ç©æ„</div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-y/twemoji/13.1.0/72x72/1f635-200d-1f4ab.png" alt="çœ‹ä¸æ‡‚"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text">çœ‹ä¸æ‡‚</div></li><!--]--></ul></div><div class="wl-comment"><!--v-if--><div class="wl-panel"><div class="wl-header item3"><!--[--><div class="wl-header-item"><label for="wl-nick">æ˜µç§°</label><input id="wl-nick" class="wl-input wl-nick" name="nick" type="text" value></div><div class="wl-header-item"><label for="wl-mail">é‚®ç®±</label><input id="wl-mail" class="wl-input wl-mail" name="mail" type="email" value></div><div class="wl-header-item"><label for="wl-link">ç½‘å€</label><input id="wl-link" class="wl-input wl-link" name="link" type="text" value></div><!--]--></div><textarea id="wl-edit" class="wl-editor" placeholder="è¯·ç•™è¨€ã€‚(å¡«å†™é‚®ç®±å¯åœ¨è¢«å›å¤æ—¶æ”¶åˆ°é‚®ä»¶æé†’)"></textarea><div class="wl-preview" style="display:none;"><hr><h4>é¢„è§ˆ:</h4><div class="wl-content"></div></div><div class="wl-footer"><div class="wl-actions"><a href="https://guides.github.com/features/mastering-markdown/" title="Markdown Guide" aria-label="Markdown is supported" class="wl-action" target="_blank" rel="noopener noreferrer"><svg width="16" height="16" ariaHidden="true"><path d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z" fill="currentColor"></path></svg></a><button type="button" class="wl-action" title="è¡¨æƒ…" style="display:none;"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M563.2 463.3 677 540c1.7 1.2 3.7 1.8 5.8 1.8.7 0 1.4-.1 2-.2 2.7-.5 5.1-2.1 6.6-4.4l25.3-37.8c1.5-2.3 2.1-5.1 1.6-7.8s-2.1-5.1-4.4-6.6l-73.6-49.1 73.6-49.1c2.3-1.5 3.9-3.9 4.4-6.6.5-2.7 0-5.5-1.6-7.8l-25.3-37.8a10.1 10.1 0 0 0-6.6-4.4c-.7-.1-1.3-.2-2-.2-2.1 0-4.1.6-5.8 1.8l-113.8 76.6c-9.2 6.2-14.7 16.4-14.7 27.5.1 11 5.5 21.3 14.7 27.4zM387 348.8h-45.5c-5.7 0-10.4 4.7-10.4 10.4v153.3c0 5.7 4.7 10.4 10.4 10.4H387c5.7 0 10.4-4.7 10.4-10.4V359.2c0-5.7-4.7-10.4-10.4-10.4zm333.8 241.3-41-20a10.3 10.3 0 0 0-8.1-.5c-2.6.9-4.8 2.9-5.9 5.4-30.1 64.9-93.1 109.1-164.4 115.2-5.7.5-9.9 5.5-9.5 11.2l3.9 45.5c.5 5.3 5 9.5 10.3 9.5h.9c94.8-8 178.5-66.5 218.6-152.7 2.4-5 .3-11.2-4.8-13.6zm186-186.1c-11.9-42-30.5-81.4-55.2-117.1-24.1-34.9-53.5-65.6-87.5-91.2-33.9-25.6-71.5-45.5-111.6-59.2-41.2-14-84.1-21.1-127.8-21.1h-1.2c-75.4 0-148.8 21.4-212.5 61.7-63.7 40.3-114.3 97.6-146.5 165.8-32.2 68.1-44.3 143.6-35.1 218.4 9.3 74.8 39.4 145 87.3 203.3.1.2.3.3.4.5l36.2 38.4c1.1 1.2 2.5 2.1 3.9 2.6 73.3 66.7 168.2 103.5 267.5 103.5 73.3 0 145.2-20.3 207.7-58.7 37.3-22.9 70.3-51.5 98.1-85 27.1-32.7 48.7-69.5 64.2-109.1 15.5-39.7 24.4-81.3 26.6-123.8 2.4-43.6-2.5-87-14.5-129zm-60.5 181.1c-8.3 37-22.8 72-43 104-19.7 31.1-44.3 58.6-73.1 81.7-28.8 23.1-61 41-95.7 53.4-35.6 12.7-72.9 19.1-110.9 19.1-82.6 0-161.7-30.6-222.8-86.2l-34.1-35.8c-23.9-29.3-42.4-62.2-55.1-97.7-12.4-34.7-18.8-71-19.2-107.9-.4-36.9 5.4-73.3 17.1-108.2 12-35.8 30-69.2 53.4-99.1 31.7-40.4 71.1-72 117.2-94.1 44.5-21.3 94-32.6 143.4-32.6 49.3 0 97 10.8 141.8 32 34.3 16.3 65.3 38.1 92 64.8 26.1 26 47.5 56 63.6 89.2 16.2 33.2 26.6 68.5 31 105.1 4.6 37.5 2.7 75.3-5.6 112.3z" fill="currentColor"></path></svg></button><button type="button" class="wl-action" title="è¡¨æƒ…åŒ…"><svg width="24" height="24" fill="currentcolor" viewBox="0 0 24 24"><path style="transform: translateY(0.5px)" d="M18.968 10.5H15.968V11.484H17.984V12.984H15.968V15H14.468V9H18.968V10.5V10.5ZM8.984 9C9.26533 9 9.49967 9.09367 9.687 9.281C9.87433 9.46833 9.968 9.70267 9.968 9.984V10.5H6.499V13.5H8.468V12H9.968V14.016C9.968 14.2973 9.87433 14.5317 9.687 14.719C9.49967 14.9063 9.26533 15 8.984 15H5.984C5.70267 15 5.46833 14.9063 5.281 14.719C5.09367 14.5317 5 14.2973 5 14.016V9.985C5 9.70367 5.09367 9.46933 5.281 9.282C5.46833 9.09467 5.70267 9.001 5.984 9.001H8.984V9ZM11.468 9H12.968V15H11.468V9V9Z"></path><path d="M18.5 3H5.75C3.6875 3 2 4.6875 2 6.75V18C2 20.0625 3.6875 21.75 5.75 21.75H18.5C20.5625 21.75 22.25 20.0625 22.25 18V6.75C22.25 4.6875 20.5625 3 18.5 3ZM20.75 18C20.75 19.2375 19.7375 20.25 18.5 20.25H5.75C4.5125 20.25 3.5 19.2375 3.5 18V6.75C3.5 5.5125 4.5125 4.5 5.75 4.5H18.5C19.7375 4.5 20.75 5.5125 20.75 6.75V18Z"></path></svg></button><input id="wl-image-upload" class="upload" type="file" accept=".png,.jpg,.jpeg,.webp,.bmp,.gif"><label for="wl-image-upload" class="wl-action" title="ä¸Šä¼ å›¾ç‰‡"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M784 112H240c-88 0-160 72-160 160v480c0 88 72 160 160 160h544c88 0 160-72 160-160V272c0-88-72-160-160-160zm96 640c0 52.8-43.2 96-96 96H240c-52.8 0-96-43.2-96-96V272c0-52.8 43.2-96 96-96h544c52.8 0 96 43.2 96 96v480z" fill="currentColor"></path><path d="M352 480c52.8 0 96-43.2 96-96s-43.2-96-96-96-96 43.2-96 96 43.2 96 96 96zm0-128c17.6 0 32 14.4 32 32s-14.4 32-32 32-32-14.4-32-32 14.4-32 32-32zm462.4 379.2-3.2-3.2-177.6-177.6c-25.6-25.6-65.6-25.6-91.2 0l-80 80-36.8-36.8c-25.6-25.6-65.6-25.6-91.2 0L200 728c-4.8 6.4-8 14.4-8 24 0 17.6 14.4 32 32 32 9.6 0 16-3.2 22.4-9.6L380.8 640l134.4 134.4c6.4 6.4 14.4 9.6 24 9.6 17.6 0 32-14.4 32-32 0-9.6-4.8-17.6-9.6-24l-52.8-52.8 80-80L769.6 776c6.4 4.8 12.8 8 20.8 8 17.6 0 32-14.4 32-32 0-8-3.2-16-8-20.8z" fill="currentColor"></path></svg></label><button type="button" class="wl-action" title="é¢„è§ˆ"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M710.816 654.301c70.323-96.639 61.084-230.578-23.705-314.843-46.098-46.098-107.183-71.109-172.28-71.109-65.008 0-126.092 25.444-172.28 71.109-45.227 46.098-70.756 107.183-70.756 172.106 0 64.923 25.444 126.007 71.194 172.106 46.099 46.098 107.184 71.109 172.28 71.109 51.414 0 100.648-16.212 142.824-47.404l126.53 126.006c7.058 7.06 16.297 10.979 26.406 10.979 10.105 0 19.343-3.919 26.402-10.979 14.467-14.467 14.467-38.172 0-52.723L710.816 654.301zm-315.107-23.265c-65.88-65.88-65.88-172.54 0-238.42 32.069-32.07 74.245-49.149 119.471-49.149 45.227 0 87.407 17.603 119.472 49.149 65.88 65.879 65.88 172.539 0 238.42-63.612 63.178-175.242 63.178-238.943 0zm0 0" fill="currentColor"></path><path d="M703.319 121.603H321.03c-109.8 0-199.469 89.146-199.469 199.38v382.034c0 109.796 89.236 199.38 199.469 199.38h207.397c20.653 0 37.384-16.645 37.384-37.299 0-20.649-16.731-37.296-37.384-37.296H321.03c-68.582 0-124.352-55.77-124.352-124.267V321.421c0-68.496 55.77-124.267 124.352-124.267h382.289c68.582 0 124.352 55.771 124.352 124.267V524.72c0 20.654 16.736 37.299 37.385 37.299 20.654 0 37.384-16.645 37.384-37.299V320.549c-.085-109.8-89.321-198.946-199.121-198.946zm0 0" fill="currentColor"></path></svg></button></div><div class="wl-info"><div class="wl-captcha-container"></div><div class="wl-text-number">0 <!--v-if--> Â å­—</div><button type="button" class="wl-btn">ç™»å½•</button><button type="submit" class="primary wl-btn" title="Cmd|Ctrl + Enter"><!--[-->æäº¤<!--]--></button></div><div class="wl-gif-popup"><input type="text" placeholder="æœç´¢è¡¨æƒ…åŒ…"><!--v-if--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div></div><div class="wl-emoji-popup"><!--[--><!--]--><!--v-if--></div></div></div><!--v-if--></div><div class="wl-meta-head"><div class="wl-count"><!--v-if--> è¯„è®º</div><ul class="wl-sort"><!--[--><li class="active">æŒ‰æ­£åº</li><li class="">æŒ‰å€’åº</li><li class="">æŒ‰çƒ­åº¦</li><!--]--></ul></div><div class="wl-cards"><!--[--><!--]--></div><!--[--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div><!--]--><div class="wl-power"> Powered by <a href="https://github.com/walinejs/waline" target="_blank" rel="noopener noreferrer"> Waline </a> v2.15.5</div></div></div><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app-3aac6385.js" defer></script>
    <!-- çœ‹æ¿å¨˜åŒºå— -->
    <script src="/live2d-widget/autoload.js"></script>
    <!-- End çœ‹æ¿å¨˜åŒºå— -->
    <script src="https://oss.newzone.top/instantpage.min.js" type="module"></script>
  </body>
</html>
