<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta property="og:url" content="https://newzone.top/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html"><meta property="og:site_name" content="æŒ¨è¸¢ç‰›é©¬"><meta property="og:title" content="Spring"><meta property="og:description" content="Spring æ¦‚è¿° Spring æ˜¯åˆ†å±‚çš„ JavaSE/EE åº”ç”¨ full-stack è½»é‡çº§å¼€æºæ¡†æ¶ Spring ä¼˜ç‚¹ï¼š æ–¹ä¾¿è§£è€¦ï¼Œç®€åŒ–å¼€å‘ æ–¹ä¾¿é›†æˆå„ç§æ¡†æ¶ æ–¹ä¾¿ç¨‹åºæµ‹è¯• AOP ç¼–ç¨‹éš¾è¿‡çš„æ”¯æŒ å£°æ˜å¼äº‹åŠ¡çš„æ”¯æŒ é™ä½ JavaEE API çš„ä½¿ç”¨éš¾åº¦"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-08-16T07:46:55.000Z"><meta property="article:author" content="æŒ¨è¸¢ç‰›é©¬"><meta property="article:modified_time" content="2023-08-16T07:46:55.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Spring","image":[""],"dateModified":"2023-08-16T07:46:55.000Z","author":[{"@type":"Person","name":"æŒ¨è¸¢ç‰›é©¬","url":"https://newzone.top"}]}</script><link rel="alternate" type="application/rss+xml" href="https://newzone.top/learn_data/rss.xml" title="æŒ¨è¸¢ç‰›é©¬ RSS Feed"><title>Spring | æŒ¨è¸¢ç‰›é©¬</title><meta name="description" content="Spring æ¦‚è¿° Spring æ˜¯åˆ†å±‚çš„ JavaSE/EE åº”ç”¨ full-stack è½»é‡çº§å¼€æºæ¡†æ¶ Spring ä¼˜ç‚¹ï¼š æ–¹ä¾¿è§£è€¦ï¼Œç®€åŒ–å¼€å‘ æ–¹ä¾¿é›†æˆå„ç§æ¡†æ¶ æ–¹ä¾¿ç¨‹åºæµ‹è¯• AOP ç¼–ç¨‹éš¾è¿‡çš„æ”¯æŒ å£°æ˜å¼äº‹åŠ¡çš„æ”¯æŒ é™ä½ JavaEE API çš„ä½¿ç”¨éš¾åº¦">
    <meta name="keywords" content="è‡ªæˆ‘æå‡,æ•ˆç‡æå‡,å¼€æºå·¥å…·,å­¦ä¹ ç¬”è®°" />
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #252232;
      }

      html,
      body {
        background: var(--bg-color);
      }
      .wwads-cn * {
        color: var(--text-color) !important;
      }
      @media screen and (max-width: 1300px) {
        .wwads-cn {
          display: none;
        }
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/learn_data/assets/style-962fc479.css" as="style"><link rel="stylesheet" href="/learn_data/assets/style-962fc479.css">
    <link rel="modulepreload" href="/learn_data/assets/app-109af9bf.js"><link rel="modulepreload" href="/learn_data/assets/Spring.html-eba7dfae.js"><link rel="modulepreload" href="/learn_data/assets/plugin-vue_export-helper-c27b6911.js"><link rel="modulepreload" href="/learn_data/assets/Spring.html-5f0e244d.js">
    <!-- <script type="text/javascript" charset="UTF-8" src="https://cdn.wwads.cn/js/makemoney.js" async></script> -->
	  <!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7585955822109216"
     crossorigin="anonymous"></script> -->
    <!-- Matomo æ­¤åŒºå—ä¸ºç»Ÿè®¡ä»£ç ï¼Œè¯·åˆ é™¤-->
    <script>
      var _paq = window._paq = window._paq || [];
      /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);
      (function() {
        var u="https://piwik.seoipo.com/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '7']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
      })();
    </script>
    <!-- End Matomo Code æ­¤åŒºå—ä¸ºç»Ÿè®¡ä»£ç ï¼Œè¯·åˆ é™¤-->
  </head>
  <body>
    <!-- <div class="wwads-cn wwads-vertical wwads-sticky" data-id="255" data-sticky-position="left" style="max-width:180px; background-color:var(--bg-color);"></div> -->
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand" href="/learn_data/"><img class="vp-nav-logo" src="/learn_data/æ©˜çŒ«.jpeg" alt="æŒ¨è¸¢ç‰›é©¬"><!----><span class="vp-site-name hide-in-pad">æŒ¨è¸¢ç‰›é©¬</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="Contact"><span class="title"><span class="font-icon icon iconfont icon-advance" style=""></span>Contact</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="https://img.newzone.top/wechat.svg" rel="noopener noreferrer" target="_blank" aria-label="å¾®ä¿¡" class="nav-link"><span class="font-icon icon iconfont icon-wechat" style=""></span>å¾®ä¿¡<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li><li class="dropdown-item"><a href="mailto:learndata@newzone.top" aria-label="Email" class="nav-link"><span class="font-icon icon iconfont icon-alias" style=""></span>Email<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item hide-in-mobile"><button type="button" class="outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!--[--><button type="button" class="search-pro-button" role="search" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">æœç´¢</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">ğŸ§° Java</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">ğŸŒ æ•°æ®åº“</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">ğŸ—ï¸ ä¸­é—´ä»¶</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><!----><span class="vp-sidebar-title">ğŸ‹ Springå…¨å®¶æ¡¶</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/MyBatis.html"><!---->MyBatis<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html"><!---->Spring<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#æ¦‚è¿°"><!---->æ¦‚è¿°<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#ioc"><!---->IoC<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#åŸºæœ¬æ¦‚è¿°"><!---->åŸºæœ¬æ¦‚è¿°<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#å…¥é—¨é¡¹ç›®"><!---->å…¥é—¨é¡¹ç›®<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#xmlå¼€å‘"><!---->XMLå¼€å‘<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#æ³¨è§£å¼€å‘"><!---->æ³¨è§£å¼€å‘<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#iocåŸç†"><!---->IoCåŸç†<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#aop"><!---->AOP<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#åŸºæœ¬æ¦‚è¿°-2"><!---->åŸºæœ¬æ¦‚è¿°<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#æ ¸å¿ƒæ¦‚å¿µ"><!---->æ ¸å¿ƒæ¦‚å¿µ<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#xmlå¼€å‘-1"><!---->XMLå¼€å‘<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#æ³¨è§£å¼€å‘-1"><!---->æ³¨è§£å¼€å‘<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#aop-åŸç†"><!---->AOP åŸç†<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#äº‹åŠ¡"><!---->äº‹åŠ¡<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#äº‹åŠ¡æœºåˆ¶"><!---->äº‹åŠ¡æœºåˆ¶<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#æ ¸å¿ƒå¯¹è±¡"><!---->æ ¸å¿ƒå¯¹è±¡<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#ç¼–ç¨‹å¼"><!---->ç¼–ç¨‹å¼<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#å£°æ˜å¼"><!---->å£°æ˜å¼<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#æ¨¡æ¿å¯¹è±¡"><!---->æ¨¡æ¿å¯¹è±¡<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#åŸç†"><!---->åŸç†<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#xml-4"><!---->XML<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#ioc-1"><!---->IOC<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#aop-2"><!---->AOP<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#äº‹åŠ¡-1"><!---->äº‹åŠ¡<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="vp-link nav-link vp-sidebar-link vp-heading" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html#æ³¨è§£-1"><!---->æ³¨è§£<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/SpringBoot.html"><!---->SpringBoot<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/SpringCloud.html"><!---->SpringCloud<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="vp-link nav-link vp-sidebar-link vp-sidebar-page" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/SpringMVC.html"><!---->SpringMVC<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">ğŸ‹ å¹¶å‘åŒ…</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">ğŸ‹ å·¥å…·</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">ğŸ‹ JavaWeb</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->Spring</h1><div class="page-info"><!----><!----><span class="page-word-info" aria-label="å­—æ•°ğŸ” " data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>çº¦ 41164 å­—</span><meta property="wordCount" content="41164"></span><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 137 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT137M"></span><span class="page-pageview-info" aria-label="è®¿é—®é‡ğŸ”¢" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon eye-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="eye icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z"></path></svg><span id="ArtalkPV" class="waline-pageview-count" data-path="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/Spring.html">...</span></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/learn_data/#æ¦‚è¿°">æ¦‚è¿°</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/learn_data/#ioc">IoC</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#åŸºæœ¬æ¦‚è¿°">åŸºæœ¬æ¦‚è¿°</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#å…¥é—¨é¡¹ç›®">å…¥é—¨é¡¹ç›®</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#xmlå¼€å‘">XMLå¼€å‘</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#æ³¨è§£å¼€å‘">æ³¨è§£å¼€å‘</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#iocåŸç†">IoCåŸç†</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/learn_data/#aop">AOP</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#åŸºæœ¬æ¦‚è¿°-2">åŸºæœ¬æ¦‚è¿°</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#æ ¸å¿ƒæ¦‚å¿µ">æ ¸å¿ƒæ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#xmlå¼€å‘-1">XMLå¼€å‘</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#æ³¨è§£å¼€å‘-1">æ³¨è§£å¼€å‘</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#aop-åŸç†">AOP åŸç†</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/learn_data/#äº‹åŠ¡">äº‹åŠ¡</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#äº‹åŠ¡æœºåˆ¶">äº‹åŠ¡æœºåˆ¶</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#æ ¸å¿ƒå¯¹è±¡">æ ¸å¿ƒå¯¹è±¡</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#ç¼–ç¨‹å¼">ç¼–ç¨‹å¼</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#å£°æ˜å¼">å£°æ˜å¼</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#æ¨¡æ¿å¯¹è±¡">æ¨¡æ¿å¯¹è±¡</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2" href="/learn_data/#åŸç†">åŸç†</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#xml-4">XML</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#ioc-1">IOC</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#aop-2">AOP</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#äº‹åŠ¡-1">äº‹åŠ¡</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3" href="/learn_data/#æ³¨è§£-1">æ³¨è§£</a></li><!----><!--]--></ul></li><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h1 id="spring" tabindex="-1"><a class="header-anchor" href="#spring" aria-hidden="true">#</a> Spring</h1><h2 id="æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#æ¦‚è¿°" aria-hidden="true">#</a> æ¦‚è¿°</h2><p>Spring æ˜¯åˆ†å±‚çš„ JavaSE/EE åº”ç”¨ full-stack è½»é‡çº§å¼€æºæ¡†æ¶</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Spring-æ¡†æ¶ä»‹ç».png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Spring ä¼˜ç‚¹ï¼š</p><ul><li>æ–¹ä¾¿è§£è€¦ï¼Œç®€åŒ–å¼€å‘</li><li>æ–¹ä¾¿é›†æˆå„ç§æ¡†æ¶</li><li>æ–¹ä¾¿ç¨‹åºæµ‹è¯•</li><li>AOP ç¼–ç¨‹éš¾è¿‡çš„æ”¯æŒ</li><li>å£°æ˜å¼äº‹åŠ¡çš„æ”¯æŒ</li><li>é™ä½ JavaEE API çš„ä½¿ç”¨éš¾åº¦</li></ul><p>ä½“ç³»ç»“æ„ï¼š</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Spring-ä½“ç³»ç»“æ„.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å‚è€ƒè§†é¢‘ï¼š<a href="https://space.bilibili.com/37974444" target="_blank" rel="noopener noreferrer">https://space.bilibili.com/37974444<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><hr><h2 id="ioc" tabindex="-1"><a class="header-anchor" href="#ioc" aria-hidden="true">#</a> IoC</h2><h3 id="åŸºæœ¬æ¦‚è¿°" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ¦‚è¿°" aria-hidden="true">#</a> åŸºæœ¬æ¦‚è¿°</h3><ul><li>IoCï¼ˆInversion Of Controlï¼‰æ§åˆ¶åè½¬ï¼ŒSpring åå‘æ§åˆ¶åº”ç”¨ç¨‹åºæ‰€éœ€è¦ä½¿ç”¨çš„å¤–éƒ¨èµ„æº</li><li><strong>Spring æ§åˆ¶çš„èµ„æºå…¨éƒ¨æ”¾ç½®åœ¨ Spring å®¹å™¨ä¸­ï¼Œè¯¥å®¹å™¨ç§°ä¸º IoC å®¹å™¨</strong>ï¼ˆå­˜æ”¾å®ä¾‹å¯¹è±¡ï¼‰</li><li>å®˜æ–¹ç½‘ç«™ï¼š<a href="https://spring.io/" target="_blank" rel="noopener noreferrer">https://spring.io/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> â†’ Projects â†’ spring-framework â†’ LEARN â†’ Reference Doc</li></ul><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Spring-IOCä»‹ç».png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li>è€¦åˆï¼ˆCouplingï¼‰ï¼šä»£ç ç¼–å†™è¿‡ç¨‹ä¸­æ‰€ä½¿ç”¨æŠ€æœ¯çš„ç»“åˆç´§å¯†åº¦ï¼Œç”¨äºè¡¡é‡è½¯ä»¶ä¸­å„ä¸ªæ¨¡å—ä¹‹é—´çš„äº’è”ç¨‹åº¦</li><li>å†…èšï¼ˆCohesionï¼‰ï¼šä»£ç ç¼–å†™è¿‡ç¨‹ä¸­å•ä¸ªæ¨¡å—å†…éƒ¨å„ç»„æˆéƒ¨åˆ†é—´çš„è”ç³»ï¼Œç”¨äºè¡¡é‡è½¯ä»¶ä¸­å„ä¸ªåŠŸèƒ½æ¨¡å—å†…éƒ¨çš„åŠŸèƒ½è”ç³»</li><li>ä»£ç ç¼–å†™çš„ç›®æ ‡ï¼šé«˜å†…èšï¼Œä½è€¦åˆã€‚åŒä¸€ä¸ªæ¨¡å—å†…çš„å„ä¸ªå…ƒç´ ä¹‹é—´è¦é«˜åº¦ç´§å¯†ï¼Œå„ä¸ªæ¨¡å—ä¹‹é—´çš„ç›¸äº’ä¾å­˜åº¦ä¸ç´§å¯†</li></ul><hr><h3 id="å…¥é—¨é¡¹ç›®" tabindex="-1"><a class="header-anchor" href="#å…¥é—¨é¡¹ç›®" aria-hidden="true">#</a> å…¥é—¨é¡¹ç›®</h3><p>æ¨¡æ‹Ÿä¸‰å±‚æ¶æ„ä¸­è¡¨ç°å±‚è°ƒç”¨ä¸šåŠ¡å±‚åŠŸèƒ½</p><ul><li><p>è¡¨ç°å±‚ï¼šUserApp æ¨¡æ‹Ÿ UserServletï¼ˆä½¿ç”¨ main æ–¹æ³•æ¨¡æ‹Ÿï¼‰</p></li><li><p>ä¸šåŠ¡å±‚ï¼šUserService</p></li></ul><p>æ­¥éª¤ï¼š</p><ol><li><p>å¯¼å…¥ spring åæ ‡ï¼ˆ5.1.9.releaseï¼‰</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-context<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.9.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>ç¼–å†™ä¸šåŠ¡å±‚ä¸è¡¨ç°å±‚ï¼ˆæ¨¡æ‹Ÿï¼‰æ¥å£ä¸å®ç°ç±» service.UserServiceï¼Œservice.impl.UserServiceImpl</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
	<span class="token comment">//ä¸šåŠ¡æ–¹æ³•  </span>
	<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user service running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>å»ºç«‹ Spring é…ç½®æ–‡ä»¶ï¼šresources.<strong>applicationContext</strong>.xml (åå­—ä¸€èˆ¬ä½¿ç”¨è¯¥æ ¼å¼)</p></li><li><p>é…ç½®æ‰€éœ€èµ„æºï¼ˆServiceï¼‰ä¸º Spring æ§åˆ¶çš„èµ„æº</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 1.åˆ›å»ºspringæ§åˆ¶çš„èµ„æº--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>service.impl.UserServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>è¡¨ç°å±‚ï¼ˆAppï¼‰é€šè¿‡ Spring è·å–èµ„æºï¼ˆService å®ä¾‹ï¼‰</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserApp</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//2.åŠ è½½é…ç½®æ–‡ä»¶</span>
        <span class="token class-name">ApplicationContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">&quot;applicationContext.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//3.è·å–èµ„æº</span>
        <span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//user service running...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Spring-IOCå®ç°.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></li></ol><hr><h3 id="xmlå¼€å‘" tabindex="-1"><a class="header-anchor" href="#xmlå¼€å‘" aria-hidden="true">#</a> XMLå¼€å‘</h3><h4 id="bean" tabindex="-1"><a class="header-anchor" href="#bean" aria-hidden="true">#</a> bean</h4><h5 id="åŸºæœ¬å±æ€§" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬å±æ€§" aria-hidden="true">#</a> åŸºæœ¬å±æ€§</h5><p>æ ‡ç­¾ï¼š&lt;bean&gt; æ ‡ç­¾ï¼Œ&lt;beans&gt; çš„å­æ ‡ç­¾</p><p>ä½œç”¨ï¼šå®šä¹‰ Spring ä¸­çš„èµ„æºï¼Œå—æ­¤æ ‡ç­¾å®šä¹‰çš„èµ„æºå°†å—åˆ° Spring æ§åˆ¶</p><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŸºæœ¬å±æ€§</p><ul><li>idï¼šbean çš„åç§°ï¼Œé€šè¿‡ id å€¼è·å– bean (é¦–å­—æ¯å°å†™)</li><li>classï¼šbean çš„ç±»å‹ï¼Œä½¿ç”¨å®Œå…¨é™å®šç±»å</li><li>nameï¼šbean çš„åç§°ï¼Œå¯ä»¥é€šè¿‡ name å€¼è·å– beanï¼Œç”¨äºå¤šäººé…åˆæ—¶ç»™ bean èµ·åˆ«å</li></ul><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>beanId<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>beanName1,beanName2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ClassName<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>ctx<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;beanId&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> ctx<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;beanName1&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> ctx<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;beanName2&quot;</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><hr><h5 id="ä½œç”¨èŒƒå›´" tabindex="-1"><a class="header-anchor" href="#ä½œç”¨èŒƒå›´" aria-hidden="true">#</a> ä½œç”¨èŒƒå›´</h5><p>ä½œç”¨ï¼šå®šä¹‰ bean çš„ä½œç”¨èŒƒå›´</p><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>singleton<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å–å€¼ï¼š</p><ul><li>singletonï¼šè®¾å®šåˆ›å»ºå‡ºçš„å¯¹è±¡ä¿å­˜åœ¨ Spring å®¹å™¨ä¸­ï¼Œæ˜¯ä¸€ä¸ªå•ä¾‹çš„å¯¹è±¡</li><li>prototypeï¼šè®¾å®šåˆ›å»ºå‡ºçš„å¯¹è±¡ä¿å­˜åœ¨ Spring å®¹å™¨ä¸­ï¼Œæ˜¯ä¸€ä¸ªéå•ä¾‹ï¼ˆåŸå‹ï¼‰çš„å¯¹è±¡</li><li>requestã€sessionã€applicationã€ websocket ï¼šè®¾å®šåˆ›å»ºå‡ºçš„å¯¹è±¡æ”¾ç½®åœ¨ web å®¹å™¨å¯¹åº”çš„ä½ç½®</li></ul><p>Spring å®¹å™¨ä¸­ Bean çš„<strong>çº¿ç¨‹å®‰å…¨</strong>é—®é¢˜ï¼š</p><ul><li><p>åŸå‹ Beanï¼Œæ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œçº¿ç¨‹ä¹‹é—´å¹¶ä¸å­˜åœ¨ Bean å…±äº«ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰çº¿ç¨‹å®‰å…¨çš„é—®é¢˜</p></li><li><p>å•ä¾‹ Beanï¼Œæ‰€æœ‰çº¿ç¨‹å…±äº«ä¸€ä¸ªå•ä¾‹å®ä¾‹ Beanï¼Œå› æ­¤æ˜¯å­˜åœ¨èµ„æºçš„ç«äº‰ï¼Œå¦‚æœå•ä¾‹ Beanæ˜¯ä¸€ä¸ª<strong>æ— çŠ¶æ€ Bean</strong>ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹ä¸­çš„æ“ä½œä¸ä¼šå¯¹ Bean çš„æˆå‘˜æ‰§è¡ŒæŸ¥è¯¢ä»¥å¤–çš„æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸ªå•ä¾‹ Bean æ˜¯çº¿ç¨‹å®‰å…¨çš„</p><p>è§£å†³æ–¹æ³•ï¼šå¼€å‘äººå‘˜æ¥è¿›è¡Œçº¿ç¨‹å®‰å…¨çš„ä¿è¯ï¼Œæœ€ç®€å•çš„åŠæ³•å°±æ˜¯æŠŠ Bean çš„ä½œç”¨åŸŸ singleton æ”¹ä¸º protopyte</p></li></ul><hr><h5 id="ç”Ÿå‘½å‘¨æœŸ" tabindex="-1"><a class="header-anchor" href="#ç”Ÿå‘½å‘¨æœŸ" aria-hidden="true">#</a> ç”Ÿå‘½å‘¨æœŸ</h5><p>ä½œç”¨ï¼šå®šä¹‰ bean å¯¹è±¡åœ¨åˆå§‹åŒ–æˆ–é”€æ¯æ—¶å®Œæˆçš„å·¥ä½œ</p><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>&lt;bean init-method=&quot;init&quot; destroy-method=&quot;destroy&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å–å€¼ï¼šbean å¯¹åº”çš„ç±»ä¸­å¯¹åº”çš„å…·ä½“æ–¹æ³•å</p><p>å®ç°æ¥å£çš„æ–¹å¼å®ç°åˆå§‹åŒ–ï¼Œæ— éœ€é…ç½®æ–‡ä»¶é…ç½® init-methodï¼š</p><ul><li>å®ç° InitializingBeanï¼Œå®šä¹‰åˆå§‹åŒ–é€»è¾‘</li><li>å®ç° DisposableBeanï¼Œå®šä¹‰é”€æ¯é€»è¾‘</li></ul><p>æ³¨æ„äº‹é¡¹ï¼š</p><ul><li>å½“ scope=â€œsingletonâ€ æ—¶ï¼ŒSpring å®¹å™¨ä¸­æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå¯¹è±¡ï¼Œinit æ–¹æ³•åœ¨åˆ›å»ºå®¹å™¨æ—¶ä»…æ‰§è¡Œä¸€æ¬¡</li><li>å½“ scope=â€œprototypeâ€ æ—¶ï¼ŒSpring å®¹å™¨è¦åˆ›å»ºåŒä¸€ç±»å‹çš„å¤šä¸ªå¯¹è±¡ï¼Œinit æ–¹æ³•åœ¨æ¯ä¸ªå¯¹è±¡åˆ›å»ºæ—¶å‡æ‰§è¡Œä¸€æ¬¡</li><li>å½“ scope=â€œsingletonâ€ æ—¶ï¼Œå…³é—­å®¹å™¨ï¼ˆ<code>.close()</code>ï¼‰ä¼šå¯¼è‡´ bean å®ä¾‹çš„é”€æ¯ï¼Œè°ƒç”¨ destroy æ–¹æ³•ä¸€æ¬¡</li><li>å½“ scope=â€œprototypeâ€ æ—¶ï¼Œå¯¹è±¡çš„é”€æ¯ç”±åƒåœ¾å›æ”¶æœºåˆ¶ GC æ§åˆ¶ï¼Œdestroy æ–¹æ³•å°†ä¸ä¼šè¢«æ‰§è¡Œ</li></ul><p>bean é…ç½®ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--init-methodå’Œdestroy-methodç”¨äºæ§åˆ¶beançš„ç”Ÿå‘½å‘¨æœŸ--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userService3<span class="token punctuation">&quot;</span></span> <span class="token attr-name">scope</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>prototype<span class="token punctuation">&quot;</span></span> <span class="token attr-name">init-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>init<span class="token punctuation">&quot;</span></span> <span class="token attr-name">destroy-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>destroy<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>service.impl.UserServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸šåŠ¡å±‚å®ç°ç±»ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">UserServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot; constructor is running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;init....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;destroy....&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user service running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æµ‹è¯•ç±»ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span>ctx<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><hr><h5 id="åˆ›å»ºæ–¹å¼" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºæ–¹å¼" aria-hidden="true">#</a> åˆ›å»ºæ–¹å¼</h5><ul><li><p>é™æ€å·¥å‚</p><p>ä½œç”¨ï¼šå®šä¹‰ bean å¯¹è±¡åˆ›å»ºæ–¹å¼ï¼Œä½¿ç”¨é™æ€å·¥å‚çš„å½¢å¼åˆ›å»º beanï¼Œå…¼å®¹æ—©æœŸé—ç•™ç³»ç»Ÿçš„å‡çº§å·¥ä½œ</p><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>FactoryClassName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">factory-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>factoryMethodName<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å–å€¼ï¼šå·¥å‚ bean ä¸­ç”¨äºè·å–å¯¹è±¡çš„é™æ€æ–¹æ³•å</p><p>æ³¨æ„äº‹é¡¹ï¼šclass å±æ€§å¿…é¡»é…ç½®æˆé™æ€å·¥å‚çš„ç±»å</p><p>bean é…ç½®ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--é™æ€å·¥å‚åˆ›å»º bean--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userService4<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>service.UserServiceFactory<span class="token punctuation">&quot;</span></span> <span class="token attr-name">factory-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getService<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å·¥å‚ç±»ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceFactory</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">UserService</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;factory create object...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æµ‹è¯•ç±»ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span>ctx<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService4&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>å®ä¾‹å·¥å‚</p><p>ä½œç”¨ï¼šå®šä¹‰ bean å¯¹è±¡åˆ›å»ºæ–¹å¼ï¼Œä½¿ç”¨å®ä¾‹å·¥å‚çš„å½¢å¼åˆ›å»º beanï¼Œå…¼å®¹æ—©æœŸé—ç•™ç³»ç»Ÿçš„å‡çº§å·¥ä½œ</p><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">factory-bean</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>factoryBeanId<span class="token punctuation">&quot;</span></span> <span class="token attr-name">factory-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>factoryMethodName<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ³¨æ„äº‹é¡¹ï¼š</p><ul><li><p>ä½¿ç”¨å®ä¾‹å·¥å‚åˆ›å»º bean é¦–å…ˆéœ€è¦å°†å®ä¾‹å·¥å‚é…ç½® beanï¼Œäº¤ç”± Spring è¿›è¡Œç®¡ç†</p></li><li><p>factory-bean æ˜¯å®ä¾‹å·¥å‚çš„ Id</p></li></ul><p>bean é…ç½®ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--å®ä¾‹å·¥å‚åˆ›å»º beanï¼Œä¾èµ–å·¥å‚å¯¹è±¡å¯¹åº”çš„ bean--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>factoryBean<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>service.UserServiceFactory2<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userService5<span class="token punctuation">&quot;</span></span> <span class="token attr-name">factory-bean</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>factoryBean<span class="token punctuation">&quot;</span></span> <span class="token attr-name">factory-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>getService<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å·¥å‚ç±»ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceFactory2</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">UserService</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot; instance factory create object...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UserServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h5 id="è·å–bean" tabindex="-1"><a class="header-anchor" href="#è·å–bean" aria-hidden="true">#</a> è·å–Bean</h5><p>ApplicationContext å­ç±»ç›¸å…³APIï¼š</p><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>String[] getBeanDefinitionNames()</td><td>è·å– Spring å®¹å™¨ä¸­å®šä¹‰çš„æ‰€æœ‰ JavaBean çš„åç§°</td></tr><tr><td>BeanDefinition getBeanDefinition(String beanName)</td><td>è¿”å›ç»™å®š bean åç§°çš„ BeanDefinition</td></tr><tr><td>String[] getBeanNamesForType(Class&lt;?&gt; type)</td><td>è·å– Spring å®¹å™¨ä¸­æŒ‡å®šç±»å‹çš„æ‰€æœ‰ JavaBean çš„åç§°</td></tr><tr><td>Environment getEnvironment()</td><td>è·å–ä¸æ­¤ç»„ä»¶å…³è”çš„ç¯å¢ƒ</td></tr></tbody></table><hr><h4 id="di" tabindex="-1"><a class="header-anchor" href="#di" aria-hidden="true">#</a> DI</h4><h5 id="ä¾èµ–æ³¨å…¥" tabindex="-1"><a class="header-anchor" href="#ä¾èµ–æ³¨å…¥" aria-hidden="true">#</a> ä¾èµ–æ³¨å…¥</h5><ul><li><p>IoCï¼ˆInversion Of Controlï¼‰æ§åˆ¶ç¿»è½¬ï¼ŒSpring åå‘æ§åˆ¶åº”ç”¨ç¨‹åºæ‰€éœ€è¦ä½¿ç”¨çš„å¤–éƒ¨èµ„æº</p></li><li><p>DIï¼ˆDependency Injectionï¼‰ä¾èµ–æ³¨å…¥ï¼Œåº”ç”¨ç¨‹åºè¿è¡Œä¾èµ–çš„èµ„æºç”± Spring ä¸ºå…¶æä¾›ï¼Œèµ„æºè¿›å…¥åº”ç”¨ç¨‹åºçš„æ–¹å¼ç§°ä¸ºæ³¨å…¥ï¼Œç®€å•è¯´å°±æ˜¯åˆ©ç”¨åå°„æœºåˆ¶ä¸ºç±»çš„å±æ€§èµ‹å€¼çš„æ“ä½œ</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Spring-DIä»‹ç».png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure></li></ul><p>IoC å’Œ DI çš„å…³ç³»ï¼šIoC ä¸ DI æ˜¯åŒä¸€ä»¶äº‹ç«™åœ¨ä¸åŒè§’åº¦çœ‹å¾…é—®é¢˜</p><hr><h5 id="set-æ³¨å…¥" tabindex="-1"><a class="header-anchor" href="#set-æ³¨å…¥" aria-hidden="true">#</a> set æ³¨å…¥</h5><p>æ ‡ç­¾ï¼š&lt;property&gt; æ ‡ç­¾ï¼Œ&lt;bean&gt; çš„å­æ ‡ç­¾</p><p>ä½œç”¨ï¼šä½¿ç”¨ set æ–¹æ³•çš„å½¢å¼ä¸º bean æä¾›èµ„æº</p><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token punctuation">/&gt;</span></span>
    .....
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŸºæœ¬å±æ€§ï¼š</p><ul><li>nameï¼šå¯¹åº” bean ä¸­çš„å±æ€§åï¼Œè¦æ³¨å…¥çš„å˜é‡åï¼Œè¦æ±‚è¯¥å±æ€§å¿…é¡»æä¾›å¯è®¿é—®çš„ set æ–¹æ³•ï¼ˆä¸¥æ ¼è§„èŒƒæ­¤åç§°æ˜¯ set æ–¹æ³•å¯¹åº”åç§°ï¼Œé¦–å­—æ¯å¿…é¡»å°å†™ï¼‰</li><li>valueï¼šè®¾å®šéå¼•ç”¨ç±»å‹å±æ€§å¯¹åº”çš„å€¼ï¼Œ<strong>ä¸èƒ½ä¸ ref åŒæ—¶ä½¿ç”¨</strong></li><li>refï¼šè®¾å®šå¼•ç”¨ç±»å‹å±æ€§å¯¹åº” bean çš„ id ï¼Œä¸èƒ½ä¸ value åŒæ—¶ä½¿ç”¨</li></ul><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>propertyName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>propertyValue<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>beanId<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ä»£ç å®ç°ï¼š</p><ul><li><p>DAO å±‚ï¼šè¦æ³¨å…¥çš„èµ„æº</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDao</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDaoImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDao</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user dao running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>Service ä¸šåŠ¡å±‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token class-name">UserDao</span> userDao<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> num<span class="token punctuation">;</span>
    
    <span class="token comment">//1.å¯¹éœ€è¦è¿›è¡Œæ³¨å…¥çš„å˜é‡æ·»åŠ setæ–¹æ³•</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserDao</span><span class="token punctuation">(</span><span class="token class-name">UserDao</span> userDao<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userDao <span class="token operator">=</span> userDao<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setNum</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>num <span class="token operator">=</span> num<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user service running...&quot;</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        userDao<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bookDao<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>é…ç½® applicationContext.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--2.å°†è¦æ³¨å…¥çš„èµ„æºå£°æ˜ä¸ºbean--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dao.impl.UserDaoImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>service.impl.UserServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!--3.å°†è¦æ³¨å…¥çš„å¼•ç”¨ç±»å‹çš„å˜é‡é€šè¿‡propertyå±æ€§è¿›è¡Œæ³¨å…¥ï¼Œ--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userDao<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>num<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>666<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æµ‹è¯•ç±»</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserApp</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ApplicationContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">&quot;applicationContext.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h5 id="æ„é€ æ³¨å…¥" tabindex="-1"><a class="header-anchor" href="#æ„é€ æ³¨å…¥" aria-hidden="true">#</a> æ„é€ æ³¨å…¥</h5><p>æ ‡ç­¾ï¼š&lt;constructor-arg&gt; æ ‡ç­¾ï¼Œ&lt;bean&gt; çš„å­æ ‡ç­¾</p><p>ä½œç”¨ï¼šä½¿ç”¨æ„é€ æ–¹æ³•çš„å½¢å¼ä¸º bean æä¾›èµ„æºï¼Œå…¼å®¹æ—©æœŸé—ç•™ç³»ç»Ÿçš„å‡çº§å·¥ä½œ</p><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token punctuation">/&gt;</span></span>
    .....<span class="token comment">&lt;!--ä¸€ä¸ªbeanå¯ä»¥æœ‰å¤šä¸ªconstructor-argæ ‡ç­¾--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å±æ€§ï¼š</p><ul><li>nameï¼šå¯¹åº”beanä¸­çš„æ„é€ æ–¹æ³•æ‰€æºå¸¦çš„å‚æ•°å</li><li>valueï¼šè®¾å®šéå¼•ç”¨ç±»å‹æ„é€ æ–¹æ³•å‚æ•°å¯¹åº”çš„å€¼ï¼Œä¸èƒ½ä¸ ref åŒæ—¶ä½¿ç”¨</li><li>refï¼šè®¾å®šå¼•ç”¨ç±»å‹æ„é€ æ–¹æ³•å‚æ•°å¯¹åº” bean çš„ id ï¼Œä¸èƒ½ä¸ value åŒæ—¶ä½¿ç”¨</li><li>typeï¼šè®¾å®šæ„é€ æ–¹æ³•å‚æ•°çš„ç±»å‹ï¼Œç”¨äºæŒ‰ç±»å‹åŒ¹é…å‚æ•°æˆ–è¿›è¡Œç±»å‹æ ¡éªŒ</li><li>indexï¼šè®¾å®šæ„é€ æ–¹æ³•å‚æ•°çš„ä½ç½®ï¼Œç”¨äºæŒ‰ä½ç½®åŒ¹é…å‚æ•°ï¼Œå‚æ•° index å€¼ä» 0 å¼€å§‹è®¡æ•°</li></ul><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>argsName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>argsValue<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>arg-index<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>arg-type<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>beanId<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»£ç å®ç°ï¼š</p><ul><li><p>DAO å±‚ï¼šè¦æ³¨å…¥çš„èµ„æº</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDaoImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDao</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> pwd<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> driver<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">UserDaoImpl</span><span class="token punctuation">(</span><span class="token class-name">String</span> driver<span class="token punctuation">,</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> pwd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>driver <span class="token operator">=</span> driver<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>username <span class="token operator">=</span> username<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pwd <span class="token operator">=</span> pwd<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user dao running...&quot;</span><span class="token operator">+</span>username<span class="token operator">+</span><span class="token string">&quot; &quot;</span><span class="token operator">+</span>pwd<span class="token operator">+</span><span class="token string">&quot; &quot;</span><span class="token operator">+</span>driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>Service ä¸šåŠ¡å±‚ï¼šå‚è€ƒ set æ³¨å…¥</p></li><li><p>é…ç½® applicationContext.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dao.impl.UserDaoImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--ä½¿ç”¨æ„é€ æ–¹æ³•è¿›è¡Œæ³¨å…¥ï¼Œéœ€è¦ä¿éšœæ³¨å…¥çš„å±æ€§ä¸beanä¸­å®šä¹‰çš„å±æ€§ä¸€è‡´--&gt;</span>
	<span class="token comment">&lt;!--ä¸€è‡´æŒ‡é¡ºåºä¸€è‡´æˆ–ç±»å‹ä¸€è‡´æˆ–ä½¿ç”¨indexè§£å†³è¯¥é—®é¢˜--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>123<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>root<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>0<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.mysql.jdbc.Driver<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>service.impl.UserServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userDao<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>num<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>666<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ–¹å¼äºŒï¼šä½¿ç”¨ UserServiceImpl çš„æ„é€ æ–¹æ³•æ³¨å…¥</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>service.impl.UserServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userDao<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>constructor-arg</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>num<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>666666<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æµ‹è¯•ç±»ï¼šå‚è€ƒ set æ³¨å…¥</p></li></ul><hr><h5 id="é›†åˆæ³¨å…¥" tabindex="-1"><a class="header-anchor" href="#é›†åˆæ³¨å…¥" aria-hidden="true">#</a> é›†åˆæ³¨å…¥</h5><p>æ ‡ç­¾ï¼š<code>&lt;array&gt; &lt;list&gt; &lt;set&gt; &lt;map&gt; &lt;props&gt;ï¼Œ&lt;property&gt;</code> æˆ– <code>&lt;constructor-arg&gt; </code>æ ‡ç­¾çš„å­æ ‡ç­¾</p><p>ä½œç”¨ï¼šæ³¨å…¥é›†åˆæ•°æ®ç±»å‹å±æ€§</p><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»£ç å®ç°ï¼š</p><ul><li><p>DAO å±‚ï¼šè¦æ³¨å…¥çš„èµ„æº</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BookDao</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookDaoImpl</span> <span class="token keyword">implements</span> <span class="token class-name">BookDao</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">ArrayList</span> al<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Properties</span> properties<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">HashSet</span> hs<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">HashMap</span> hm <span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAl</span><span class="token punctuation">(</span><span class="token class-name">ArrayList</span> al<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>al <span class="token operator">=</span> al<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>properties <span class="token operator">=</span> properties<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setArr</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>arr <span class="token operator">=</span> arr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setHs</span><span class="token punctuation">(</span><span class="token class-name">HashSet</span> hs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hs <span class="token operator">=</span> hs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setHm</span><span class="token punctuation">(</span><span class="token class-name">HashMap</span> hm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hm <span class="token operator">=</span> hm<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;book dao running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ArrayList:&quot;</span> <span class="token operator">+</span> al<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Properties:&quot;</span> <span class="token operator">+</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;HashSet:&quot;</span> <span class="token operator">+</span> hs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;HashMap:&quot;</span> <span class="token operator">+</span> hm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>Service ä¸šåŠ¡å±‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">BookDao</span> bookDao<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">UserServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBookDao</span><span class="token punctuation">(</span><span class="token class-name">BookDao</span> bookDao<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>bookDao <span class="token operator">=</span> bookDao<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user service running...&quot;</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        bookDao<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>é…ç½® applicationContext.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>service.impl.UserServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bookDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bookDao<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bookDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dao.impl.BookDaoImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>al<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>list</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>seazean<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>66666<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>list</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>properties<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>props</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>prop</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>seazean666<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>prop</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>prop</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>value<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>666666<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>prop</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>props</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>arr<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>array</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>123456<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>66666<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>array</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hs<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>set</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>seazean<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>value</span><span class="token punctuation">&gt;</span></span>66666<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>value</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>set</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hm<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>map</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>seazean66666<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>entry</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>value<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>6666666666<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>map</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>property</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h4 id="p" tabindex="-1"><a class="header-anchor" href="#p" aria-hidden="true">#</a> P</h4><p>æ ‡ç­¾ï¼š&lt;p:propertyName&gt;ï¼Œ&lt;p:propertyName-ref&gt;</p><p>ä½œç”¨ï¼šä¸º bean æ³¨å…¥å±æ€§å€¼</p><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name"><span class="token namespace">p:</span>propertyName</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>propertyValue<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">p:</span>propertyName-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>beanId<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å¼€å¯ p å‘½ä»¤ç©ºé—´ï¼šå¼€å¯ Spring å¯¹ p å‘½ä»¤ç©ºé—´çš„çš„æ”¯æŒï¼Œåœ¨ beans æ ‡ç­¾ä¸­æ·»åŠ å¯¹åº”ç©ºé—´æ”¯æŒ</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans<span class="token punctuation">&quot;</span></span>   		
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>    
       <span class="token attr-name"><span class="token namespace">xmlns:</span>p</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/p<span class="token punctuation">&quot;</span></span>       
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>
		http://www.springframework.org/schema/beans     
		https://www.springframework.org/schema/beans/spring-beans.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ä¾‹ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> 
      <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userService<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>service.impl.UserServiceImpl<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name"><span class="token namespace">p:</span>userDao-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userDao<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name"><span class="token namespace">p:</span>bookDao-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bookDao<span class="token punctuation">&quot;</span></span>
      <span class="token attr-name"><span class="token namespace">p:</span>num</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>10<span class="token punctuation">&quot;</span></span>
	<span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="spel" tabindex="-1"><a class="header-anchor" href="#spel" aria-hidden="true">#</a> SpEL</h4><p>Spring æä¾›äº†å¯¹ EL è¡¨è¾¾å¼çš„æ”¯æŒï¼Œç»Ÿä¸€å±æ€§æ³¨å…¥æ ¼å¼</p><p>ä½œç”¨ï¼šä¸º bean æ³¨å…¥å±æ€§å€¼</p><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>EL<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ³¨æ„ï¼šæ‰€æœ‰å±æ€§å€¼ä¸åŒºåˆ†æ˜¯å¦å¼•ç”¨ç±»å‹ï¼Œç»Ÿä¸€ä½¿ç”¨valueèµ‹å€¼</p><p>æ‰€æœ‰æ ¼å¼ç»Ÿä¸€ä½¿ç”¨ value=â€œ#{}â€</p><ul><li><p>å¸¸é‡ <code>#{10} #{3.14} #{2e5} #{â€˜itâ€™}</code></p></li><li><p>å¼•ç”¨ bean <code>#{beanId} </code></p></li><li><p>å¼•ç”¨ bean å±æ€§ <code>#{beanId.propertyName}</code></p></li><li><p>å¼•ç”¨ bean æ–¹æ³• <code>beanId.methodName().method2()</code></p></li><li><p>å¼•ç”¨é™æ€æ–¹æ³• <code>T(java.lang.Math).PI</code></p></li><li><p>è¿ç®—ç¬¦æ”¯æŒ <code>#{3 lt 4 == 4 ge 3}</code></p></li><li><p>æ­£åˆ™è¡¨è¾¾å¼æ”¯æŒ <code>#{user.name matchesâ€˜[a-z]{6,}â€™}</code></p></li><li><p>é›†åˆæ”¯æŒ <code>#{likes[3]}</code></p></li></ul><p>å®ä¾‹ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>service.impl.UserServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#{userDao}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bookDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#{bookDao}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>num<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>#{666666666}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="prop" tabindex="-1"><a class="header-anchor" href="#prop" aria-hidden="true">#</a> prop</h4><p>Spring æä¾›äº†è¯»å–å¤–éƒ¨ properties æ–‡ä»¶çš„æœºåˆ¶ï¼Œä½¿ç”¨è¯»å–åˆ°çš„æ•°æ®ä¸º bean çš„å±æ€§èµ‹å€¼</p><p>æ“ä½œæ­¥éª¤ï¼š</p><ol><li><p>å‡†å¤‡å¤–éƒ¨ properties æ–‡ä»¶</p></li><li><p>å¼€å¯ context å‘½åç©ºé—´æ”¯æŒ</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/context<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>
        http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        https://www.springframework.org/schema/context/spring-context.xsd
        <span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>åŠ è½½æŒ‡å®šçš„ properties æ–‡ä»¶</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>property-placeholder</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>classpath:data.properties<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>ä½¿ç”¨åŠ è½½çš„æ•°æ®</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>propertyName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${propertiesName}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ol><ul><li><p>æ³¨æ„ï¼šå¦‚æœéœ€è¦åŠ è½½æ‰€æœ‰çš„ properties æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>*.properties</code> è¡¨ç¤ºåŠ è½½æ‰€æœ‰çš„ properties æ–‡ä»¶</p></li><li><p>æ³¨æ„ï¼šè¯»å–æ•°æ®ä½¿ç”¨ <strong>${propertiesName}</strong> æ ¼å¼è¿›è¡Œï¼Œå…¶ä¸­ propertiesName æŒ‡ properties æ–‡ä»¶ä¸­çš„å±æ€§å</p></li></ul><p>ä»£ç å®ç°ï¼š</p><ul><li><p>data.properties</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">username</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token key attr-name">pwd</span><span class="token punctuation">=</span><span class="token value attr-value">123456</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>DAO å±‚ï¼šæ³¨å…¥çš„èµ„æº</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDao</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDaoImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDao</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserName</span><span class="token punctuation">(</span><span class="token class-name">String</span> userName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userName <span class="token operator">=</span> userName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> password<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user dao running...&quot;</span><span class="token operator">+</span>userName<span class="token operator">+</span><span class="token string">&quot; &quot;</span><span class="token operator">+</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>Service ä¸šåŠ¡å±‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">UserDao</span> userDao<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setUserDao</span><span class="token punctuation">(</span><span class="token class-name">UserDao</span> userDao<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userDao <span class="token operator">=</span> userDao<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user service running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userDao<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>applicationContext.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>property-placeholder</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>classpath:*.properties<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dao.impl.UserDaoImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${pwd}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>service.impl.UserServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userDao<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æµ‹è¯•ç±»</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserApp</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ApplicationContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">&quot;applicationContext.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h4 id="import" tabindex="-1"><a class="header-anchor" href="#import" aria-hidden="true">#</a> import</h4><p>æ ‡ç­¾ï¼š<code>&lt;import&gt;ï¼Œ&lt;beans&gt;</code>æ ‡ç­¾çš„å­æ ‡ç­¾</p><p>ä½œç”¨ï¼šåœ¨å½“å‰é…ç½®æ–‡ä»¶ä¸­å¯¼å…¥å…¶ä»–é…ç½®æ–‡ä»¶ä¸­çš„é¡¹</p><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>import</span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å±æ€§ï¼š</p><ul><li>resourceï¼šåŠ è½½çš„é…ç½®æ–‡ä»¶å</li></ul><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>&lt;import resource=â€œconfig2.xml&quot;/&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>Spring å®¹å™¨åŠ è½½å¤šä¸ªé…ç½®æ–‡ä»¶ï¼š</p><ul><li><p>applicationContext-book.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bookDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dao.impl.BookDaoImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>num<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>applicationContext-user.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dao.impl.UserDaoImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${pwd}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>service.impl.UserServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userDao<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bookDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bookDao<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>applicationContext.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>import</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>applicationContext-user.xml<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>import</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>applicationContext-book.xml<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>bookDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.seazean.dao.impl.BookDaoImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>num<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>2<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æµ‹è¯•ç±»</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">&quot;applicationContext-user.xml&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;applicationContext-book.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">&quot;applicationContext.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>Spring å®¹å™¨ä¸­çš„ bean å®šä¹‰å†²çªé—®é¢˜</p><ul><li><p>åŒ id çš„ beanï¼Œåå®šä¹‰çš„è¦†ç›–å…ˆå®šä¹‰çš„</p></li><li><p>å¯¼å…¥é…ç½®æ–‡ä»¶å¯ä»¥ç†è§£ä¸ºå°†å¯¼å…¥çš„é…ç½®æ–‡ä»¶å¤åˆ¶ç²˜è´´åˆ°å¯¹åº”ä½ç½®ï¼Œç¨‹åºæ‰§è¡Œé€‰æ‹©æœ€ä¸‹é¢çš„é…ç½®ä½¿ç”¨</p></li><li><p>å¯¼å…¥é…ç½®æ–‡ä»¶çš„é¡ºåºä¸ä½ç½®ä¸åŒå¯èƒ½ä¼šå¯¼è‡´æœ€ç»ˆç¨‹åºè¿è¡Œç»“æœä¸åŒ</p></li></ul><hr><h4 id="ä¸‰æ–¹èµ„æº" tabindex="-1"><a class="header-anchor" href="#ä¸‰æ–¹èµ„æº" aria-hidden="true">#</a> ä¸‰æ–¹èµ„æº</h4><h5 id="druid" tabindex="-1"><a class="header-anchor" href="#druid" aria-hidden="true">#</a> Druid</h5><p>ç¬¬ä¸‰æ–¹èµ„æºé…ç½®</p><ul><li><p>pom.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>druid<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.16<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>applicationContext.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--åŠ è½½druidèµ„æº--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.alibaba.druid.pool.DruidDataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>driverClassName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.mysql.jdbc.Driver<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>url<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>jdbc:mysql://192.168.2.185:3306/spring_db<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>root<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>123456<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>App.java</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ApplicationContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">&quot;applicationContext.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DruidDataSource</span> datasource <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DruidDataSource</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;datasource&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>datasource<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h5 id="mybatis" tabindex="-1"><a class="header-anchor" href="#mybatis" aria-hidden="true">#</a> Mybatis</h5><p>Mybatis æ ¸å¿ƒé…ç½®æ–‡ä»¶æ¶ˆå¤±</p><ul><li><p>ç¯å¢ƒ environment è½¬æ¢æˆæ•°æ®æºå¯¹è±¡</p></li><li><p>æ˜ å°„ Mapper æ‰«æå·¥ä½œäº¤ç”± Spring å¤„ç†</p></li><li><p>ç±»å‹åˆ«åäº¤ç”± Spring å¤„ç†</p></li></ul><p>DAO æ¥å£ä¸éœ€è¦åˆ›å»ºå®ç°ç±»ï¼ŒMyBatis-Spring æä¾›äº†ä¸€ä¸ªåŠ¨æ€ä»£ç†çš„å®ç° <strong>MapperFactoryBean</strong>ï¼Œè¿™ä¸ªç±»å¯ä»¥è®©ç›´æ¥æ³¨å…¥æ•°æ®æ˜ å°„å™¨æ¥å£åˆ° service å±‚ bean ä¸­ï¼Œåº•å±‚å°†ä¼šåŠ¨æ€ä»£ç†åˆ›å»ºç±»</p><p>æ•´åˆåŸç†ï¼šåˆ©ç”¨ Spring æ¡†æ¶çš„ SPI æœºåˆ¶ï¼Œåœ¨ META-INF ç›®å½•çš„ spring.handlers ä¸­ç»™ Spring å®¹å™¨ä¸­å¯¼å…¥ NamespaceHandler ç±»</p><ul><li><p>NamespaceHandler çš„ init æ–¹æ³•æ³¨å†Œ bean ä¿¡æ¯çš„è§£æå™¨ MapperScannerBeanDefinitionParser</p></li><li><p>è§£æå™¨åœ¨ Spring å®¹å™¨åˆ›å»ºè¿‡ç¨‹ä¸­å»<strong>è§£æ mapperScanner æ ‡ç­¾</strong>ï¼Œè§£æå‡ºçš„å±æ€§å¡«å……åˆ° MapperScannerConfigurer ä¸­</p></li><li><p>MapperScannerConfigurer å®ç°äº† BeanDefinitionRegistryPostProcessor æ¥å£ï¼Œé‡å†™ postProcessBeanDefinitionRegistry() æ–¹æ³•ï¼Œå¯ä»¥æ‰«æåˆ° MyBatis çš„ Mapper</p></li></ul><hr><h3 id="æ³¨è§£å¼€å‘" tabindex="-1"><a class="header-anchor" href="#æ³¨è§£å¼€å‘" aria-hidden="true">#</a> æ³¨è§£å¼€å‘</h3><h4 id="æ³¨è§£é©±åŠ¨" tabindex="-1"><a class="header-anchor" href="#æ³¨è§£é©±åŠ¨" aria-hidden="true">#</a> æ³¨è§£é©±åŠ¨</h4><h5 id="xml" tabindex="-1"><a class="header-anchor" href="#xml" aria-hidden="true">#</a> XML</h5><p>å¯åŠ¨æ³¨è§£æ‰«æï¼ŒåŠ è½½ç±»ä¸­é…ç½®çš„æ³¨è§£é¡¹ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>packageName1,packageName2<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><ul><li>åœ¨è¿›è¡ŒåŒ…æ‰«ææ—¶ï¼Œä¼šå¯¹é…ç½®çš„åŒ…åŠå…¶å­åŒ…ä¸­æ‰€æœ‰æ–‡ä»¶è¿›è¡Œæ‰«æï¼Œå¤šä¸ªåŒ…é‡‡ç”¨<code>,</code>éš”å¼€</li><li>æ‰«æè¿‡ç¨‹æ˜¯ä»¥æ–‡ä»¶å¤¹é€’å½’è¿­ä»£çš„å½¢å¼è¿›è¡Œçš„</li><li>æ‰«æè¿‡ç¨‹ä»…è¯»å–åˆæ³•çš„ Java æ–‡ä»¶</li><li>æ‰«ææ—¶ä»…è¯»å– Spring å¯è¯†åˆ«çš„æ³¨è§£</li><li>æ‰«æç»“æŸåä¼šå°†å¯è¯†åˆ«çš„æœ‰æ•ˆæ³¨è§£è½¬åŒ–ä¸º Spring å¯¹åº”çš„èµ„æºåŠ å…¥ IoC å®¹å™¨</li><li>ä»åŠ è½½æ•ˆç‡ä¸Šæ¥è¯´æ³¨è§£ä¼˜äº XML é…ç½®æ–‡ä»¶</li></ul><p>æ³¨è§£ï¼šå¯åŠ¨æ—¶ä½¿ç”¨æ³¨è§£çš„å½¢å¼æ›¿ä»£ xml é…ç½®ï¼Œå°† Spring é…ç½®æ–‡ä»¶ä»å·¥ç¨‹ä¸­æ¶ˆé™¤ï¼Œç®€åŒ–ä¹¦å†™</p><p>ç¼ºç‚¹ï¼šä¸ºäº†è¾¾æˆæ³¨è§£é©±åŠ¨çš„ç›®çš„ï¼Œå¯èƒ½ä¼šå°†åŸå…ˆå¾ˆç®€å•çš„ä¹¦å†™ï¼Œå˜çš„æ›´åŠ å¤æ‚ã€‚XML ä¸­é…ç½®ç¬¬ä¸‰æ–¹å¼€å‘çš„èµ„æºæ˜¯å¾ˆæ–¹ä¾¿çš„ï¼Œä½†ä½¿ç”¨æ³¨è§£é©±åŠ¨æ— æ³•åœ¨ç¬¬ä¸‰æ–¹å¼€å‘çš„èµ„æºä¸­è¿›è¡Œç¼–è¾‘ï¼Œå› æ­¤ä¼šå¢å¤§å¼€å‘å·¥ä½œé‡</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/æ³¨è§£é©±åŠ¨ç¤ºä¾‹.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h5 id="çº¯æ³¨è§£" tabindex="-1"><a class="header-anchor" href="#çº¯æ³¨è§£" aria-hidden="true">#</a> çº¯æ³¨è§£</h5><p>æ³¨è§£é…ç½®ç±»</p><p>åç§°ï¼š@Configurationã€@ComponentScan</p><p>ç±»å‹ï¼šç±»æ³¨è§£</p><p>ä½œç”¨ï¼š<strong>è®¾ç½®å½“å‰ç±»ä¸º Spring æ ¸å¿ƒé…ç½®åŠ è½½ç±»</strong></p><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;scanPackageName1&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;scanPackageName2&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringConfigClassName</span><span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><ul><li>æ ¸å¿ƒé…åˆç±»ç”¨äºæ›¿æ¢ Spring æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼Œæ­¤ç±»å¯ä»¥è®¾ç½®ç©ºçš„ï¼Œä¸è®¾ç½®å˜é‡ä¸å±æ€§</li><li>bean æ‰«æå·¥ä½œä½¿ç”¨æ³¨è§£ @ComponentScan æ›¿ä»£ï¼Œå¤šä¸ªåŒ…ç”¨ <code>{} å’Œ ,</code> éš”å¼€</li></ul><p>åŠ è½½çº¯æ³¨è§£æ ¼å¼ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œéœ€è¦ä½¿ç”¨ <strong>AnnotationConfigApplicationContext</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Person</span> <span class="token function">person</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Person1</span><span class="token punctuation">(</span><span class="token string">&quot;lisi&quot;</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ApplicationContext</span> applicationContext <span class="token operator">=</span> <span class="token keyword">new</span> 
            		<span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">SpringConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//æ–¹å¼ä¸€ï¼šåç§°å¯¹åº”ç±»å</span>
        <span class="token class-name">Person</span> bean <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
        <span class="token comment">//æ–¹å¼äºŒï¼šåç§°å¯¹åº”æ–¹æ³•å </span>
        <span class="token class-name">Person</span> bean1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Person</span><span class="token punctuation">)</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;person1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
        
        <span class="token comment">//æ–¹æ³•ä¸‰ï¼šæŒ‡å®šåç§°@Bean(&quot;person2&quot;)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h5 id="æ‰«æå™¨" tabindex="-1"><a class="header-anchor" href="#æ‰«æå™¨" aria-hidden="true">#</a> æ‰«æå™¨</h5><p>ç»„ä»¶æ‰«æè¿‡æ»¤å™¨</p><p>å¼€å‘è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ ¹æ®éœ€æ±‚åŠ è½½å¿…è¦çš„ beanï¼Œæ’é™¤æŒ‡å®š bean</p><p>åç§°ï¼š@ComponentScan</p><p>ç±»å‹ï¼š<strong>ç±»æ³¨è§£</strong></p><p>ä½œç”¨ï¼šè®¾ç½® Spring é…ç½®åŠ è½½ç±»æ‰«æè§„åˆ™</p><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>
    value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;dao&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;service&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>			<span class="token comment">//è®¾ç½®åŸºç¡€æ‰«æè·¯å¾„</span>
    excludeFilters <span class="token operator">=</span>					<span class="token comment">//è®¾ç½®è¿‡æ»¤è§„åˆ™ï¼Œå½“å‰ä¸ºæ’é™¤è¿‡æ»¤</span>
	<span class="token annotation punctuation">@ComponentScan.Filter</span><span class="token punctuation">(</span>				<span class="token comment">//è®¾ç½®è¿‡æ»¤å™¨</span>
	    type<span class="token operator">=</span> <span class="token class-name">FilterType</span><span class="token punctuation">.</span><span class="token constant">ANNOTATION</span><span class="token punctuation">,</span>  	<span class="token comment">//è®¾ç½®è¿‡æ»¤æ–¹å¼ä¸ºæŒ‰ç…§æ³¨è§£è¿›è¡Œè¿‡æ»¤</span>
	    classes <span class="token operator">=</span> <span class="token class-name">Service</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>     	<span class="token comment">//è®¾ç½®å…·ä½“çš„è¿‡æ»¤é¡¹ï¼Œè¿‡æ»¤æ‰€æœ‰@Serviceä¿®é¥°çš„bean</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å±æ€§ï¼š</p><ul><li>includeFiltersï¼šè®¾ç½®åŒ…å«æ€§è¿‡æ»¤å™¨</li><li>excludeFiltersï¼šè®¾ç½®æ’é™¤æ€§è¿‡æ»¤å™¨</li><li>typeï¼šè®¾ç½®è¿‡æ»¤å™¨ç±»å‹</li></ul><hr><h4 id="åŸºæœ¬æ³¨è§£" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ³¨è§£" aria-hidden="true">#</a> åŸºæœ¬æ³¨è§£</h4><h5 id="è®¾ç½®-bean" tabindex="-1"><a class="header-anchor" href="#è®¾ç½®-bean" aria-hidden="true">#</a> è®¾ç½® bean</h5><p>åç§°ï¼š@Componentã€@Controllerã€@Serviceã€@Repository</p><p>ç±»å‹ï¼šç±»æ³¨è§£ï¼Œå†™åœ¨ç±»å®šä¹‰ä¸Šæ–¹</p><p>ä½œç”¨ï¼šè®¾ç½®è¯¥ç±»ä¸º Spring ç®¡ç†çš„ bean</p><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassName</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š@Controllerã€@Service ã€@Repository æ˜¯ @Component çš„è¡ç”Ÿæ³¨è§£ï¼ŒåŠŸèƒ½åŒ @Component</p><p>å±æ€§ï¼š</p><ul><li>valueï¼ˆé»˜è®¤ï¼‰ï¼šå®šä¹‰ bean çš„è®¿é—® id</li></ul><hr><h5 id="ä½œç”¨èŒƒå›´-1" tabindex="-1"><a class="header-anchor" href="#ä½œç”¨èŒƒå›´-1" aria-hidden="true">#</a> ä½œç”¨èŒƒå›´</h5><p>åç§°ï¼š@Scope</p><p>ç±»å‹ï¼šç±»æ³¨è§£ï¼Œå†™åœ¨ç±»å®šä¹‰ä¸Šæ–¹</p><p>ä½œç”¨ï¼šè®¾ç½®è¯¥ç±»ä½œä¸º bean å¯¹åº”çš„ scope å±æ€§</p><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Scope</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassName</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>ç›¸å…³å±æ€§</p><ul><li>valueï¼ˆé»˜è®¤ï¼‰ï¼šå®šä¹‰ bean çš„ä½œç”¨åŸŸï¼Œé»˜è®¤ä¸º singletonï¼Œéå•ä¾‹å–å€¼ prototype</li></ul><hr><h5 id="ç”Ÿå‘½å‘¨æœŸ-1" tabindex="-1"><a class="header-anchor" href="#ç”Ÿå‘½å‘¨æœŸ-1" aria-hidden="true">#</a> ç”Ÿå‘½å‘¨æœŸ</h5><p>åç§°ï¼š@PostConstructã€@PreDestroy</p><p>ç±»å‹ï¼šæ–¹æ³•æ³¨è§£ï¼Œå†™åœ¨æ–¹æ³•å®šä¹‰ä¸Šæ–¹</p><p>ä½œç”¨ï¼šè®¾ç½®è¯¥ç±»ä½œä¸º bean å¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•</p><p>ç¤ºä¾‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//å®šä¹‰beanï¼Œåé¢æ·»åŠ beançš„id</span>
<span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">)</span>
<span class="token comment">//å®šä¹‰beançš„ä½œç”¨åŸŸ</span>
<span class="token annotation punctuation">@Scope</span><span class="token punctuation">(</span><span class="token string">&quot;singleton&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token comment">//åˆå§‹åŒ–</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user service init...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//é”€æ¯</span>
    <span class="token annotation punctuation">@PreDestroy</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user service destroy...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸€ä¸ªå¯¹è±¡çš„æ‰§è¡Œé¡ºåºï¼šConstructor &gt;&gt; @Autowiredï¼ˆæ³¨å…¥å±æ€§ï¼‰ &gt;&gt; @PostConstructï¼ˆåˆå§‹åŒ–é€»è¾‘ï¼‰</p><hr><h5 id="åŠ è½½èµ„æº" tabindex="-1"><a class="header-anchor" href="#åŠ è½½èµ„æº" aria-hidden="true">#</a> åŠ è½½èµ„æº</h5><p>åç§°ï¼š@Bean</p><p>ç±»å‹ï¼šæ–¹æ³•æ³¨è§£</p><p>ä½œç”¨ï¼šè®¾ç½®è¯¥æ–¹æ³•çš„è¿”å›å€¼ä½œä¸º Spring ç®¡ç†çš„ bean</p><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;dataSource&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">DruidDataSource</span> <span class="token function">createDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> â€¦â€¦<span class="token punctuation">;</span>    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><ul><li><p>å› ä¸ºç¬¬ä¸‰æ–¹ bean æ— æ³•åœ¨å…¶æºç ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œä½¿ç”¨ @Bean è§£å†³ç¬¬ä¸‰æ–¹ bean çš„å¼•å…¥é—®é¢˜</p></li><li><p>è¯¥æ³¨è§£ç”¨äºæ›¿ä»£ XML é…ç½®ä¸­çš„é™æ€å·¥å‚ä¸å®ä¾‹å·¥å‚åˆ›å»º beanï¼Œä¸åŒºåˆ†æ–¹æ³•æ˜¯å¦ä¸ºé™æ€æˆ–éé™æ€</p></li><li><p>@Bean æ‰€åœ¨çš„ç±»å¿…é¡»è¢« Spring æ‰«æåŠ è½½ï¼Œå¦åˆ™è¯¥æ³¨è§£æ— æ³•ç”Ÿæ•ˆ</p></li></ul><p>ç›¸å…³å±æ€§</p><ul><li>valueï¼ˆé»˜è®¤ï¼‰ï¼šå®šä¹‰ bean çš„è®¿é—® id</li><li>initMethodï¼šå£°æ˜åˆå§‹åŒ–æ–¹æ³•</li><li>destroyMethodï¼šå£°æ˜é”€æ¯æ–¹æ³•</li></ul><hr><h4 id="å±æ€§æ³¨å…¥" tabindex="-1"><a class="header-anchor" href="#å±æ€§æ³¨å…¥" aria-hidden="true">#</a> å±æ€§æ³¨å…¥</h4><h5 id="åŸºæœ¬ç±»å‹" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬ç±»å‹" aria-hidden="true">#</a> åŸºæœ¬ç±»å‹</h5><p>åç§°ï¼š@Value</p><p>ç±»å‹ï¼šå±æ€§æ³¨è§£ã€æ–¹æ³•æ³¨è§£</p><p>ä½œç”¨ï¼šè®¾ç½®å¯¹åº”å±æ€§çš„å€¼æˆ–å¯¹æ–¹æ³•è¿›è¡Œä¼ å‚</p><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//@Value(&quot;${jdbc.username}&quot;)</span>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><ul><li><p>value å€¼<strong>ä»…æ”¯æŒéå¼•ç”¨ç±»å‹æ•°æ®</strong>ï¼Œèµ‹å€¼æ—¶å¯¹æ–¹æ³•çš„æ‰€æœ‰å‚æ•°å…¨éƒ¨èµ‹å€¼</p></li><li><p>value å€¼æ”¯æŒè¯»å– properties æ–‡ä»¶ä¸­çš„å±æ€§å€¼ï¼Œé€šè¿‡ç±»å±æ€§å°† properties ä¸­æ•°æ®ä¼ å…¥ç±»ä¸­</p></li><li><p>value å€¼æ”¯æŒ SpEL</p></li><li><p>@value æ³¨è§£å¦‚æœæ·»åŠ åœ¨å±æ€§ä¸Šæ–¹ï¼Œå¯ä»¥çœç•¥ set æ–¹æ³•ï¼ˆset æ–¹æ³•çš„ç›®çš„æ˜¯ä¸ºå±æ€§èµ‹å€¼ï¼‰</p></li></ul><p>ç›¸å…³å±æ€§ï¼š</p><ul><li>valueï¼ˆé»˜è®¤ï¼‰ï¼šå®šä¹‰å¯¹åº”çš„å±æ€§å€¼æˆ–å‚æ•°å€¼</li></ul><hr><h5 id="è‡ªåŠ¨è£…é…" tabindex="-1"><a class="header-anchor" href="#è‡ªåŠ¨è£…é…" aria-hidden="true">#</a> è‡ªåŠ¨è£…é…</h5><h6 id="å±æ€§æ³¨å…¥-1" tabindex="-1"><a class="header-anchor" href="#å±æ€§æ³¨å…¥-1" aria-hidden="true">#</a> å±æ€§æ³¨å…¥</h6><p>åç§°ï¼š@Autowiredã€@Qualifier</p><p>ç±»å‹ï¼šå±æ€§æ³¨è§£ã€æ–¹æ³•æ³¨è§£</p><p>ä½œç”¨ï¼šè®¾ç½®å¯¹åº”å±æ€§çš„å¯¹è±¡ã€å¯¹æ–¹æ³•è¿›è¡Œå¼•ç”¨ç±»å‹ä¼ å‚</p><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;userDao&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">UserDao</span> userDao<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><ul><li>@Autowired é»˜è®¤æŒ‰ç±»å‹è£…é…ï¼ŒæŒ‡å®š @Qualifier åå¯ä»¥æŒ‡å®šè‡ªåŠ¨è£…é…çš„ bean çš„ id</li></ul><p>ç›¸å…³å±æ€§ï¼š</p><ul><li>requiredï¼š<strong>ä¸º true ï¼ˆé»˜è®¤ï¼‰è¡¨ç¤ºæ³¨å…¥ bean æ—¶è¯¥ bean å¿…é¡»å­˜åœ¨</strong>ï¼Œä¸ç„¶å°±ä¼šæ³¨å…¥å¤±è´¥æŠ›å‡ºå¼‚å¸¸ï¼›ä¸º false è¡¨ç¤ºæ³¨å…¥æ—¶è¯¥ bean å­˜åœ¨å°±æ³¨å…¥ï¼Œä¸å­˜åœ¨å°±å¿½ç•¥è·³è¿‡</li></ul><p>æ³¨æ„ï¼šåœ¨ä½¿ç”¨ @Autowired æ—¶ï¼Œé¦–å…ˆåœ¨å®¹å™¨ä¸­æŸ¥è¯¢å¯¹åº”ç±»å‹çš„ beanï¼Œå¦‚æœæŸ¥è¯¢ç»“æœåˆšå¥½ä¸ºä¸€ä¸ªï¼Œå°±å°†è¯¥ bean è£…é…ç»™ @Autowired æŒ‡å®šçš„æ•°æ®ï¼Œå¦‚æœæŸ¥è¯¢çš„ç»“æœä¸æ­¢ä¸€ä¸ªï¼Œé‚£ä¹ˆ @Autowired ä¼šæ ¹æ®åç§°æ¥æŸ¥æ‰¾ï¼Œå¦‚æœæŸ¥è¯¢çš„ç»“æœä¸ºç©ºï¼Œé‚£ä¹ˆä¼šæŠ›å‡ºå¼‚å¸¸</p><p>è§£å†³æ–¹æ³•ï¼šä½¿ç”¨ required = false</p><hr><h6 id="ä¼˜å…ˆæ³¨å…¥" tabindex="-1"><a class="header-anchor" href="#ä¼˜å…ˆæ³¨å…¥" aria-hidden="true">#</a> ä¼˜å…ˆæ³¨å…¥</h6><p>åç§°ï¼š@Primary</p><p>ç±»å‹ï¼šç±»æ³¨è§£</p><p>ä½œç”¨ï¼šè®¾ç½®ç±»å¯¹åº”çš„ bean æŒ‰ç±»å‹è£…é…æ—¶ä¼˜å…ˆè£…é…</p><p>èŒƒä¾‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Primary</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassName</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><ul><li>@Autowired é»˜è®¤æŒ‰ç±»å‹è£…é…ï¼Œå½“å‡ºç°ç›¸åŒç±»å‹çš„ beanï¼Œä½¿ç”¨ @Primary æé«˜æŒ‰ç±»å‹è‡ªåŠ¨è£…é…çš„ä¼˜å…ˆçº§ï¼Œå¤šä¸ª @Primary ä¼šå¯¼è‡´ä¼˜å…ˆçº§è®¾ç½®æ— æ•ˆ</li></ul><hr><h6 id="æ³¨è§£å¯¹æ¯”" tabindex="-1"><a class="header-anchor" href="#æ³¨è§£å¯¹æ¯”" aria-hidden="true">#</a> æ³¨è§£å¯¹æ¯”</h6><p>åç§°ï¼š@Injectã€@Namedã€@Resource</p><ul><li>@Inject ä¸ @Named æ˜¯ JSR330 è§„èŒƒä¸­çš„æ³¨è§£ï¼ŒåŠŸèƒ½ä¸ @Autowired å’Œ @Qualifier å®Œå…¨ç›¸åŒï¼Œé€‚ç”¨äºä¸åŒæ¶æ„åœºæ™¯</li><li>@Resource æ˜¯ JSR250 è§„èŒƒä¸­çš„æ³¨è§£ï¼Œå¯ä»¥ç®€åŒ–ä¹¦å†™æ ¼å¼</li></ul><p>@Resource ç›¸å…³å±æ€§</p><ul><li><p>nameï¼šè®¾ç½®æ³¨å…¥çš„ bean çš„ id</p></li><li><p>typeï¼šè®¾ç½®æ³¨å…¥çš„ bean çš„ç±»å‹ï¼Œæ¥æ”¶çš„å‚æ•°ä¸º Class ç±»å‹</p></li></ul><p>@Autowired å’Œ @Resourceä¹‹é—´çš„åŒºåˆ«ï¼š</p><ul><li><p>@Autowired é»˜è®¤æ˜¯<strong>æŒ‰ç…§ç±»å‹è£…é…</strong>æ³¨å…¥ï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒè¦æ±‚ä¾èµ–å¯¹è±¡å¿…é¡»å­˜åœ¨ï¼ˆå¯ä»¥è®¾ç½® required å±æ€§ä¸º falseï¼‰</p></li><li><p>@Resource é»˜è®¤<strong>æŒ‰ç…§åç§°è£…é…</strong>æ³¨å…¥ï¼Œåªæœ‰å½“æ‰¾ä¸åˆ°ä¸åç§°åŒ¹é…çš„ bean æ‰ä¼šæŒ‰ç…§ç±»å‹æ¥è£…é…æ³¨å…¥</p></li></ul><hr><h5 id="é™æ€æ³¨å…¥" tabindex="-1"><a class="header-anchor" href="#é™æ€æ³¨å…¥" aria-hidden="true">#</a> é™æ€æ³¨å…¥</h5><p>Spring å®¹å™¨ç®¡ç†çš„éƒ½æ˜¯å®ä¾‹å¯¹è±¡ï¼Œ<strong>@Autowired ä¾èµ–æ³¨å…¥çš„éƒ½æ˜¯å®¹å™¨å†…çš„å¯¹è±¡å®ä¾‹</strong>ï¼Œåœ¨ Java ä¸­ static ä¿®é¥°çš„é™æ€å±æ€§ï¼ˆå˜é‡å’Œæ–¹æ³•ï¼‰æ˜¯å±äºç±»çš„ï¼Œè€Œéå±äºå®ä¾‹å¯¹è±¡</p><p>å½“ç±»åŠ è½½å™¨åŠ è½½é™æ€å˜é‡æ—¶ï¼ŒSpring ä¸Šä¸‹æ–‡å°šæœªåŠ è½½ï¼Œæ‰€ä»¥ç±»åŠ è½½å™¨ä¸ä¼šåœ¨ Bean ä¸­æ­£ç¡®æ³¨å…¥é™æ€ç±»</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestClass</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Component</span> component<span class="token punctuation">;</span>

    <span class="token comment">// è°ƒç”¨é™æ€ç»„ä»¶çš„æ–¹æ³•</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        component<span class="token punctuation">.</span><span class="token function">callTestMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>ï¼›
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
<span class="token comment">// ç¼–è¯‘æ­£å¸¸ï¼Œä½†è¿è¡Œæ—¶æŠ¥java.lang.NullPointerExceptionï¼Œæ‰€ä»¥åœ¨è°ƒç”¨testMethod()æ–¹æ³•æ—¶ï¼Œcomponentå˜é‡è¿˜æ²¡è¢«åˆå§‹åŒ–</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è§£å†³æ–¹æ³•ï¼š</p><ul><li><p>@Autowired æ³¨è§£åˆ°<strong>ç±»çš„æ„é€ å‡½æ•°</strong>ä¸Šï¼ŒSpring æ‰«æåˆ° Component çš„ Beanï¼Œç„¶åèµ‹ç»™é™æ€å˜é‡ component</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestClass</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Component</span> component<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">TestClass</span><span class="token punctuation">(</span><span class="token class-name">Component</span> component<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TestClass</span><span class="token punctuation">.</span>component <span class="token operator">=</span> component<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        component<span class="token punctuation">.</span><span class="token function">callTestMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>ï¼›
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>@Autowired æ³¨è§£åˆ°<strong>é™æ€å±æ€§çš„ setter æ–¹æ³•</strong>ä¸Š</p></li><li><p>ä½¿ç”¨ @PostConstruct æ³¨è§£ä¸€ä¸ªæ–¹æ³•ï¼Œåœ¨æ–¹æ³•å†…ä¸º static é™æ€æˆå‘˜èµ‹å€¼</p></li><li><p>ä½¿ç”¨ Spring æ¡†æ¶å·¥å…·ç±»è·å– beanï¼Œå®šä¹‰æˆå±€éƒ¨å˜é‡ä½¿ç”¨</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestClass</span> <span class="token punctuation">{</span>
    <span class="token comment">// è°ƒç”¨é™æ€ç»„ä»¶çš„æ–¹æ³•</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">Component</span> component <span class="token operator">=</span> <span class="token class-name">SpringApplicationContextUtil</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;component&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      component<span class="token punctuation">.</span><span class="token function">callTestMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>å‚è€ƒæ–‡ç« ï¼š<a href="http://jessehzx.top/2018/03/18/spring-autowired-static-field/" target="_blank" rel="noopener noreferrer">http://jessehzx.top/2018/03/18/spring-autowired-static-field/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><hr><h4 id="æ–‡ä»¶è¯»å–" tabindex="-1"><a class="header-anchor" href="#æ–‡ä»¶è¯»å–" aria-hidden="true">#</a> æ–‡ä»¶è¯»å–</h4><p>åç§°ï¼š@PropertySource</p><p>ç±»å‹ï¼šç±»æ³¨è§£</p><p>ä½œç”¨ï¼šåŠ è½½ properties æ–‡ä»¶ä¸­çš„å±æ€§å€¼</p><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@PropertySource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;classpath:filename.properties&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassName</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${propertiesAttributeName}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> attributeName<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><ul><li>ä¸æ”¯æŒ * é€šé…ç¬¦ï¼ŒåŠ è½½åï¼Œæ‰€æœ‰ Spring æ§åˆ¶çš„ bean ä¸­å‡å¯ä½¿ç”¨å¯¹åº”å±æ€§å€¼ï¼ŒåŠ è½½å¤šä¸ªéœ€è¦ç”¨ <code>{} å’Œ ,</code> éš”å¼€</li></ul><p>ç›¸å…³å±æ€§</p><ul><li><p>valueï¼ˆé»˜è®¤ï¼‰ï¼šè®¾ç½®åŠ è½½çš„ properties æ–‡ä»¶å</p></li><li><p>ignoreResourceNotFoundï¼šå¦‚æœèµ„æºæœªæ‰¾åˆ°ï¼Œæ˜¯å¦å¿½ç•¥ï¼Œé»˜è®¤ä¸º false</p></li></ul><hr><h4 id="åŠ è½½æ§åˆ¶" tabindex="-1"><a class="header-anchor" href="#åŠ è½½æ§åˆ¶" aria-hidden="true">#</a> åŠ è½½æ§åˆ¶</h4><h5 id="ä¾èµ–åŠ è½½" tabindex="-1"><a class="header-anchor" href="#ä¾èµ–åŠ è½½" aria-hidden="true">#</a> ä¾èµ–åŠ è½½</h5><p>@DependsOn</p><ul><li><p>åç§°ï¼š@DependsOn</p></li><li><p>ç±»å‹ï¼šç±»æ³¨è§£ã€æ–¹æ³•æ³¨è§£</p></li><li><p>ä½œç”¨ï¼šæ§åˆ¶ bean çš„åŠ è½½é¡ºåºï¼Œä½¿å…¶åœ¨æŒ‡å®š bean åŠ è½½å®Œæ¯•åå†åŠ è½½</p></li><li><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@DependsOn</span><span class="token punctuation">(</span><span class="token string">&quot;beanId&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassName</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>è¯´æ˜ï¼š</p><ul><li><p>é…ç½®åœ¨æ–¹æ³•ä¸Šï¼Œä½¿ @DependsOn æŒ‡å®šçš„ bean ä¼˜å…ˆäº @Bean é…ç½®çš„ bean è¿›è¡ŒåŠ è½½</p></li><li><p>é…ç½®åœ¨ç±»ä¸Šï¼Œä½¿ @DependsOn æŒ‡å®šçš„ bean ä¼˜å…ˆäºå½“å‰ç±»ä¸­æ‰€æœ‰ @Bean é…ç½®çš„ bean è¿›è¡ŒåŠ è½½</p></li><li><p>é…ç½®åœ¨ç±»ä¸Šï¼Œä½¿ @DependsOn æŒ‡å®šçš„ bean ä¼˜å…ˆäº @Component ç­‰é…ç½®çš„ bean è¿›è¡ŒåŠ è½½</p></li></ul></li><li><p>ç›¸å…³å±æ€§</p><ul><li>valueï¼ˆé»˜è®¤ï¼‰ï¼šè®¾ç½®å½“å‰ bean æ‰€ä¾èµ–çš„ bean çš„ id</li></ul></li></ul><p>@Order</p><ul><li><p>åç§°ï¼š@Order</p></li><li><p>ç±»å‹ï¼š<strong>é…ç½®ç±»æ³¨è§£</strong></p></li><li><p>ä½œç”¨ï¼šæ§åˆ¶é…ç½®ç±»çš„åŠ è½½é¡ºåºï¼Œå€¼è¶Šå°è¶Šå…ˆåŠ è½½</p></li><li><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringConfigClassName</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>@Lazy</p><ul><li><p>åç§°ï¼š@Lazy</p></li><li><p>ç±»å‹ï¼šç±»æ³¨è§£ã€æ–¹æ³•æ³¨è§£</p></li><li><p>ä½œç”¨ï¼šæ§åˆ¶ bean çš„åŠ è½½æ—¶æœºï¼Œä½¿å…¶å»¶è¿ŸåŠ è½½ï¼Œè·å–çš„æ—¶å€™åŠ è½½</p></li><li><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Lazy</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassName</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h5 id="åº”ç”¨åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#åº”ç”¨åœºæ™¯" aria-hidden="true">#</a> åº”ç”¨åœºæ™¯</h5><p>@DependsOn</p><ul><li><p>å¾®ä¿¡è®¢é˜…å·ï¼Œå‘å¸ƒæ¶ˆæ¯å’Œè®¢é˜…æ¶ˆæ¯çš„ bean çš„åŠ è½½é¡ºåºæ§åˆ¶ï¼ˆå…ˆå¼€è®¢é˜…ï¼Œå†å‘å¸ƒï¼‰</p></li><li><p>åŒ 11 æ´»åŠ¨ï¼Œé›¶ç‚¹å‰æ˜¯ç»“ç®—ç­–ç•¥ Aï¼Œé›¶ç‚¹åæ˜¯ç»“ç®—ç­–ç•¥ Bï¼Œç­–ç•¥ B æ“ä½œçš„æ•°æ®ä¸ºä¿ƒé”€æ•°æ®ï¼Œç­–ç•¥ B åŠ è½½é¡ºåºä¸ä¿ƒé”€æ•°æ®çš„åŠ è½½é¡ºåº</p></li></ul><p>@Lazy</p><ul><li>ç¨‹åºç¾éš¾å‡ºç°åå¯¹åº”çš„åº”æ€¥é¢„æ¡ˆå¤„ç†æ˜¯å¯åŠ¨å®¹å™¨æ—¶åŠ è½½æ—¶æœº</li></ul><p>@Order</p><ul><li>å¤šä¸ªç§ç±»çš„é…ç½®å‡ºç°åï¼Œä¼˜å…ˆåŠ è½½ç³»ç»Ÿçº§çš„ï¼Œç„¶ååŠ è½½ä¸šåŠ¡çº§çš„ï¼Œé¿å…ç»†ç²’åº¦çš„åŠ è½½æ§åˆ¶</li></ul><hr><h4 id="æ•´åˆèµ„æº" tabindex="-1"><a class="header-anchor" href="#æ•´åˆèµ„æº" aria-hidden="true">#</a> æ•´åˆèµ„æº</h4><h5 id="å¯¼å…¥" tabindex="-1"><a class="header-anchor" href="#å¯¼å…¥" aria-hidden="true">#</a> å¯¼å…¥</h5><p>åç§°ï¼š@Import</p><p>ç±»å‹ï¼šç±»æ³¨è§£</p><p>ä½œç”¨ï¼šå¯¼å…¥ç¬¬ä¸‰æ–¹ bean ä½œä¸º Spring æ§åˆ¶çš„èµ„æºï¼Œè¿™äº›ç±»éƒ½ä¼šè¢« Spring åˆ›å»ºå¹¶æ”¾å…¥ ioc å®¹å™¨</p><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">OtherClassName</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassName</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><ul><li>@Import æ³¨è§£åœ¨åŒä¸€ä¸ªç±»ä¸Šï¼Œä»…å…è®¸æ·»åŠ ä¸€æ¬¡ï¼Œå¦‚æœéœ€è¦å¯¼å…¥å¤šä¸ªï¼Œä½¿ç”¨æ•°ç»„çš„å½¢å¼è¿›è¡Œè®¾å®š</li><li>åœ¨è¢«å¯¼å…¥çš„ç±»ä¸­å¯ä»¥ç»§ç»­ä½¿ç”¨ @Import å¯¼å…¥å…¶ä»–èµ„æº</li><li>@Bean æ‰€åœ¨çš„ç±»å¯ä»¥ä½¿ç”¨å¯¼å…¥çš„å½¢å¼è¿›å…¥ Spring å®¹å™¨ï¼Œæ— éœ€å£°æ˜ä¸º bean</li></ul><hr><h5 id="druid-1" tabindex="-1"><a class="header-anchor" href="#druid-1" aria-hidden="true">#</a> Druid</h5><ul><li><p>åŠ è½½èµ„æº</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JDBCConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;dataSource&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">DruidDataSource</span> <span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DruidDataSource</span> ds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DruidDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ds<span class="token punctuation">.</span><span class="token function">setDriverClassName</span><span class="token punctuation">(</span><span class="token string">&quot;com.mysql.jdbc.Driver&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ds<span class="token punctuation">.</span><span class="token function">setUrl</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc:mysql://192.168.2.185:3306/spring_db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ds<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ds<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ds<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>å¯¼å…¥èµ„æº</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;service&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;dao&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">JDBCConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringConfig</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æµ‹è¯•</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">DruidDataSource</span> dataSource <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DruidDataSource</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;dataSource&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h5 id="junit" tabindex="-1"><a class="header-anchor" href="#junit" aria-hidden="true">#</a> Junit</h5><p>Spring æ¥ç®¡ Junit çš„è¿è¡Œæƒï¼Œä½¿ç”¨ Spring ä¸“ç”¨çš„ Junit ç±»åŠ è½½å™¨ï¼Œä¸º Junit æµ‹è¯•ç”¨ä¾‹è®¾å®šå¯¹åº”çš„ Spring å®¹å™¨</p><p>æ³¨æ„ï¼š</p><ul><li><p>ä» Spring5.0 ä»¥åï¼Œè¦æ±‚ Junit çš„ç‰ˆæœ¬å¿…é¡»æ˜¯4.12åŠä»¥ä¸Š</p></li><li><p>Junit ä»…ç”¨äºå•å…ƒæµ‹è¯•ï¼Œä¸èƒ½å°† Junit çš„æµ‹è¯•ç±»é…ç½®æˆ Spring çš„ beanï¼Œå¦åˆ™è¯¥é…ç½®å°†ä¼šè¢«æ‰“åŒ…è¿›å…¥å·¥ç¨‹ä¸­</p></li></ul><p>test / java / service / UserServiceTest</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//è®¾å®šspringä¸“ç”¨çš„ç±»åŠ è½½å™¨</span>
<span class="token annotation punctuation">@RunWith</span><span class="token punctuation">(</span><span class="token class-name">SpringJUnit4ClassRunner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token comment">//è®¾å®šåŠ è½½çš„springä¸Šä¸‹æ–‡å¯¹åº”çš„é…ç½®</span>
<span class="token annotation punctuation">@ContextConfiguration</span><span class="token punctuation">(</span>classes <span class="token operator">=</span> <span class="token class-name">SpringConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceTest</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AccountService</span> accountService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testFindById</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Account</span> account <span class="token operator">=</span> accountService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">&quot;Mike&quot;</span><span class="token punctuation">,</span> account<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>pom.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.9.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="iocåŸç†" tabindex="-1"><a class="header-anchor" href="#iocåŸç†" aria-hidden="true">#</a> IoCåŸç†</h3><h4 id="æ ¸å¿ƒç±»" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒç±»" aria-hidden="true">#</a> æ ¸å¿ƒç±»</h4><h5 id="beanfactory" tabindex="-1"><a class="header-anchor" href="#beanfactory" aria-hidden="true">#</a> BeanFactory</h5><p>ApplicationContextï¼š</p><ol><li><p>ApplicationContext æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæä¾›äº†è®¿é—® Spring å®¹å™¨çš„ API</p></li><li><p>ClassPathXmlApplicationContext æ˜¯ä¸€ä¸ªç±»ï¼Œå®ç°äº†ä¸Šè¿°åŠŸèƒ½</p></li><li><p>ApplicationContext çš„é¡¶å±‚æ¥å£æ˜¯ BeanFactory</p></li><li><p>BeanFactory å®šä¹‰äº† bean ç›¸å…³çš„æœ€åŸºæœ¬æ“ä½œ</p></li><li><p>ApplicationContext åœ¨ BeanFactory åŸºç¡€ä¸Šè¿½åŠ äº†è‹¥å¹²æ–°åŠŸèƒ½</p></li></ol><p><strong>ApplicationContext å’Œ BeanFactoryå¯¹æ¯”ï¼š</strong></p><ul><li><p>BeanFactory å’Œ ApplicationContext æ˜¯ Spring çš„ä¸¤å¤§æ ¸å¿ƒæ¥å£ï¼Œéƒ½å¯ä»¥å½“åš Spring çš„å®¹å™¨</p></li><li><p>BeanFactory æ˜¯ Spring é‡Œé¢æœ€åº•å±‚çš„æ¥å£ï¼Œæ˜¯ IoC çš„æ ¸å¿ƒï¼Œå®šä¹‰äº† IoC çš„åŸºæœ¬åŠŸèƒ½ï¼ŒåŒ…å«äº†å„ç§ Bean çš„å®šä¹‰ã€åŠ è½½ã€å®ä¾‹åŒ–ï¼Œä¾èµ–æ³¨å…¥å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚ApplicationContext æ¥å£ä½œä¸º BeanFactory çš„å­ç±»ï¼Œé™¤äº†æä¾› BeanFactory æ‰€å…·æœ‰çš„åŠŸèƒ½å¤–ï¼Œè¿˜æä¾›äº†æ›´å®Œæ•´çš„æ¡†æ¶åŠŸèƒ½ï¼š</p><ul><li>ç»§æ‰¿ MessageSourceï¼Œå› æ­¤æ”¯æŒå›½é™…åŒ–</li><li>èµ„æºæ–‡ä»¶è®¿é—®ï¼Œå¦‚ URL å’Œæ–‡ä»¶ï¼ˆResourceLoaderï¼‰ã€‚</li><li>è½½å…¥å¤šä¸ªï¼ˆæœ‰ç»§æ‰¿å…³ç³»ï¼‰ä¸Šä¸‹æ–‡ï¼ˆå³åŠ è½½å¤šä¸ªé…ç½®æ–‡ä»¶ï¼‰ ï¼Œä½¿å¾—æ¯ä¸€ä¸ªä¸Šä¸‹æ–‡éƒ½ä¸“æ³¨äºä¸€ä¸ªç‰¹å®šçš„å±‚æ¬¡ï¼Œæ¯”å¦‚åº”ç”¨çš„ web å±‚</li><li>æä¾›åœ¨ç›‘å¬å™¨ä¸­æ³¨å†Œ bean çš„äº‹ä»¶</li></ul></li><li><p>BeanFactory åˆ›å»ºçš„ bean é‡‡ç”¨å»¶è¿ŸåŠ è½½å½¢å¼ï¼Œåªæœ‰åœ¨ä½¿ç”¨åˆ°æŸä¸ª Bean æ—¶ï¼ˆè°ƒç”¨ getBeanï¼‰ï¼Œæ‰å¯¹è¯¥ Bean è¿›è¡ŒåŠ è½½å®ä¾‹åŒ–ï¼ˆSpring æ—©æœŸä½¿ç”¨è¯¥æ–¹æ³•è·å– beanï¼‰ï¼Œè¿™æ ·å°±ä¸èƒ½æå‰å‘ç°ä¸€äº›å­˜åœ¨çš„ Spring çš„é…ç½®é—®é¢˜ï¼›ApplicationContext æ˜¯åœ¨å®¹å™¨å¯åŠ¨æ—¶ï¼Œä¸€æ¬¡æ€§åˆ›å»ºäº†æ‰€æœ‰çš„ Beanï¼Œå®¹å™¨å¯åŠ¨æ—¶ï¼Œå°±å¯ä»¥å‘ç° Spring ä¸­å­˜åœ¨çš„é…ç½®é”™è¯¯ï¼Œè¿™æ ·æœ‰åˆ©äºæ£€æŸ¥æ‰€ä¾èµ–å±æ€§æ˜¯å¦æ³¨å…¥</p></li><li><p>ApplicationContext å¯åŠ¨åé¢„è½½å…¥æ‰€æœ‰çš„å•å®ä¾‹ Beanï¼Œæ‰€ä»¥ç¨‹åºå¯åŠ¨æ…¢ï¼Œè¿è¡Œæ—¶é€Ÿåº¦å¿«</p></li><li><p>ä¸¤è€…éƒ½æ”¯æŒ BeanPostProcessorã€BeanFactoryPostProcessor çš„ä½¿ç”¨ï¼Œä½†ä¸¤è€…ä¹‹é—´çš„åŒºåˆ«æ˜¯ï¼šBeanFactory éœ€è¦æ‰‹åŠ¨æ³¨å†Œï¼Œè€Œ ApplicationContext åˆ™æ˜¯è‡ªåŠ¨æ³¨å†Œ</p></li></ul><p>FileSystemXmlApplicationContextï¼šåŠ è½½æ–‡ä»¶ç³»ç»Ÿä¸­ä»»æ„ä½ç½®çš„é…ç½®æ–‡ä»¶ï¼Œè€Œ ClassPathXmlAC åªèƒ½åŠ è½½ç±»è·¯å¾„ä¸‹çš„é…ç½®æ–‡ä»¶</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Spring-ApplicationContextå±‚çº§ç»“æ„å›¾.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>BeanFactory çš„æˆå‘˜å±æ€§ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">String</span> <span class="token constant">FACTORY_BEAN_PREFIX</span> <span class="token operator">=</span> <span class="token string">&quot;&amp;&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>åŒºåˆ†æ˜¯ FactoryBean è¿˜æ˜¯åˆ›å»ºçš„ Beanï¼ŒåŠ ä¸Š &amp; ä»£è¡¨æ˜¯å·¥å‚ï¼ŒgetBean å°†ä¼šè¿”å›å·¥å‚</li><li>FactoryBeanï¼šå¦‚æœæŸä¸ª bean çš„é…ç½®éå¸¸å¤æ‚ï¼Œæˆ–è€…æƒ³è¦ä½¿ç”¨ç¼–ç çš„å½¢å¼å»æ„å»ºå®ƒï¼Œå¯ä»¥æä¾›ä¸€ä¸ªæ„å»ºè¯¥ bean å®ä¾‹çš„å·¥å‚ï¼Œè¿™ä¸ªå·¥å‚å°±æ˜¯ FactoryBean æ¥å£å®ç°ç±»ï¼ŒFactoryBean æ¥å£å®ç°ç±»ä¹Ÿæ˜¯éœ€è¦ Spring ç®¡ç† <ul><li>è¿™é‡Œäº§ç”Ÿä¸¤ç§å¯¹è±¡ï¼Œä¸€ç§æ˜¯ FactoryBean æ¥å£å®ç°ç±»ï¼ˆIOC ç®¡ç†ï¼‰ï¼Œå¦ä¸€ç§æ˜¯ FactoryBean æ¥å£å†…éƒ¨ç®¡ç†çš„å¯¹è±¡</li><li>è·å– FactoryBean æ¥å£å®ç°ç±»ï¼Œä½¿ç”¨ getBean æ—¶ä¼ çš„ beanName éœ€è¦å¸¦ &amp; å¼€å¤´</li><li>è·å– FactoryBean å†…éƒ¨ç®¡ç†çš„å¯¹è±¡ï¼Œä¸éœ€è¦å¸¦ &amp; å¼€å¤´</li></ul></li></ul><p>BeanFactory çš„åŸºæœ¬ä½¿ç”¨ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">Resource</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;applicationContext.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">BeanFactory</span> bf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XmlBeanFactory</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span>bf<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h5 id="factorybean" tabindex="-1"><a class="header-anchor" href="#factorybean" aria-hidden="true">#</a> FactoryBean</h5><p>FactoryBeanï¼šå¯¹å•ä¸€çš„ bean çš„åˆå§‹åŒ–è¿‡ç¨‹è¿›è¡Œå°è£…ï¼Œè¾¾åˆ°ç®€åŒ–é…ç½®çš„ç›®çš„</p><p>FactoryBeanä¸ BeanFactory åŒºåˆ«ï¼š</p><ul><li><p>FactoryBeanï¼šå°è£…å•ä¸ª bean çš„åˆ›å»ºè¿‡ç¨‹ï¼Œå°±æ˜¯å·¥å‚çš„ Bean</p></li><li><p>BeanFactoryï¼šSpring å®¹å™¨é¡¶å±‚æ¥å£ï¼Œå®šä¹‰äº† bean ç›¸å…³çš„è·å–æ“ä½œ</p></li></ul><p>ä»£ç å®ç°ï¼š</p><ul><li><p>FactoryBeanï¼Œå®ç°ç±»ä¸€èˆ¬æ˜¯ MapperFactoryBeanï¼Œåˆ›å»º DAO å±‚æ¥å£çš„å®ç°ç±»</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EquipmentDaoImplFactoryBean</span> <span class="token keyword">implements</span> <span class="token class-name">FactoryBean</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>	<span class="token comment">//è·å–Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EquipmentDaoImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>	<span class="token comment">//è·å–beançš„ç±»å‹</span>
    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">getObjectType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>	<span class="token comment">//æ˜¯å¦å•ä¾‹</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>MapperFactoryBean ç»§æ‰¿ SqlSessionDaoSupportï¼Œå¯ä»¥è·å– SqlSessionTemplateï¼Œå®Œæˆ MyBatis çš„æ•´åˆ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SqlSessionDaoSupport</span> <span class="token keyword">extends</span> <span class="token class-name">DaoSupport</span> <span class="token punctuation">{</span>
  	<span class="token keyword">private</span> <span class="token class-name">SqlSessionTemplate</span> sqlSessionTemplate<span class="token punctuation">;</span>
	<span class="token comment">// è·å– SqlSessionTemplate å¯¹è±¡</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSqlSessionFactory</span><span class="token punctuation">(</span><span class="token class-name">SqlSessionFactory</span> sqlSessionFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionTemplate <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> 
        	sqlSessionFactory <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionTemplate<span class="token punctuation">.</span><span class="token function">getSqlSessionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      		<span class="token keyword">this</span><span class="token punctuation">.</span>sqlSessionTemplate <span class="token operator">=</span> <span class="token function">createSqlSessionTemplate</span><span class="token punctuation">(</span>sqlSessionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span>
  	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h4 id="è¿‡æ»¤å™¨" tabindex="-1"><a class="header-anchor" href="#è¿‡æ»¤å™¨" aria-hidden="true">#</a> è¿‡æ»¤å™¨</h4><h5 id="æ•°æ®å‡†å¤‡" tabindex="-1"><a class="header-anchor" href="#æ•°æ®å‡†å¤‡" aria-hidden="true">#</a> æ•°æ®å‡†å¤‡</h5><ul><li><p>DAO å±‚ UserDaoã€AccountDaoã€BookDaoã€EquipmentDao</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserDao</span> <span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span><span class="token punctuation">(</span><span class="token string">&quot;userDao&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDaoImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDao</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user dao running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>Service ä¸šåŠ¡å±‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserDao</span> userDao<span class="token punctuation">;</span><span class="token comment">//...........BookDaoç­‰</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user service running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userDao<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h5 id="è¿‡æ»¤å™¨-1" tabindex="-1"><a class="header-anchor" href="#è¿‡æ»¤å™¨-1" aria-hidden="true">#</a> è¿‡æ»¤å™¨</h5><p>åç§°ï¼šTypeFilter</p><p>ç±»å‹ï¼š<strong>æ¥å£</strong></p><p>ä½œç”¨ï¼šè‡ªå®šä¹‰ç±»å‹è¿‡æ»¤å™¨</p><p>ç¤ºä¾‹ï¼š</p><ul><li><p>config / filter / MyTypeFilter</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyTypeFilter</span> <span class="token keyword">implements</span> <span class="token class-name">TypeFilter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token doc-comment comment">/**
    * metadataReader:è¯»å–åˆ°çš„å½“å‰æ­£åœ¨æ‰«æçš„ç±»çš„ä¿¡æ¯
    * metadataReaderFactory:å¯ä»¥è·å–åˆ°ä»»ä½•å…¶ä»–ç±»çš„ä¿¡æ¯
    */</span>
    <span class="token comment">//åŠ è½½çš„ç±»æ»¡è¶³è¦æ±‚ï¼ŒåŒ¹é…æˆåŠŸ</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token class-name">MetadataReader</span> metadataReader<span class="token punctuation">,</span> <span class="token class-name">MetadataReaderFactory</span> metadataReaderFactory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//è·å–å½“å‰ç±»æ³¨è§£çš„ä¿¡æ¯</span>
		<span class="token class-name">AnnotationMetadata</span> am <span class="token operator">=</span> metadataReader<span class="token punctuation">.</span><span class="token function">getAnnotationMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//è·å–å½“å‰æ­£åœ¨æ‰«æçš„ç±»çš„ç±»ä¿¡æ¯</span>
		<span class="token class-name">ClassMetadata</span> classMetadata <span class="token operator">=</span> metadataReader<span class="token punctuation">.</span><span class="token function">getClassMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//è·å–å½“å‰ç±»èµ„æºï¼ˆç±»çš„è·¯å¾„ï¼‰</span>
		<span class="token class-name">Resource</span> resource <span class="token operator">=</span> metadataReader<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        
        <span class="token comment">//é€šè¿‡ç±»çš„å…ƒæ•°æ®è·å–ç±»çš„åç§°</span>
        <span class="token class-name">String</span> className <span class="token operator">=</span> classMetadata<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//å¦‚æœåŠ è½½çš„ç±»åæ»¡è¶³è¿‡æ»¤å™¨è¦æ±‚ï¼Œè¿”å›åŒ¹é…æˆåŠŸ</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;service.impl.UserServiceImpl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       	<span class="token comment">//è¿”å›trueè¡¨ç¤ºåŒ¹é…æˆåŠŸï¼Œè¿”å›falseè¡¨ç¤ºåŒ¹é…å¤±è´¥ã€‚æ­¤å¤„ä»…ç¡®è®¤åŒ¹é…ç»“æœï¼Œä¸ä¼šç¡®è®¤æ˜¯æ’é™¤è¿˜æ˜¯åŠ å…¥ï¼Œæ’é™¤/åŠ å…¥ç”±é…ç½®é¡¹å†³å®šï¼Œä¸æ­¤å¤„æ— å…³</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>SpringConfig</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token comment">//è®¾ç½®æ’é™¤beanï¼Œæ’é™¤çš„è§„åˆ™æ˜¯è‡ªå®šä¹‰è§„åˆ™ï¼ˆFilterType.CUSTOMï¼‰ï¼Œå…·ä½“çš„è§„åˆ™å®šä¹‰ä¸ºMyTypeFilter</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span>
        value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&quot;dao&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;service&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        excludeFilters <span class="token operator">=</span> <span class="token annotation punctuation">@ComponentScan.Filter</span><span class="token punctuation">(</span>
                type<span class="token operator">=</span> <span class="token class-name">FilterType</span><span class="token punctuation">.</span><span class="token constant">CUSTOM</span><span class="token punctuation">,</span>
                classes <span class="token operator">=</span> <span class="token class-name">MyTypeFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span>
        <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringConfig</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h4 id="å¯¼å…¥å™¨" tabindex="-1"><a class="header-anchor" href="#å¯¼å…¥å™¨" aria-hidden="true">#</a> å¯¼å…¥å™¨</h4><p>bean åªæœ‰é€šè¿‡é…ç½®æ‰å¯ä»¥è¿›å…¥ Spring å®¹å™¨ï¼Œè¢« Spring åŠ è½½å¹¶æ§åˆ¶</p><ul><li><p>é…ç½® bean çš„æ–¹å¼å¦‚ä¸‹ï¼š</p><ul><li>XML æ–‡ä»¶ä¸­ä½¿ç”¨ <!----> æ ‡ç­¾é…ç½®</li><li>ä½¿ç”¨ @Component åŠè¡ç”Ÿæ³¨è§£é…ç½®</li></ul></li></ul><p>å¯¼å…¥å™¨å¯ä»¥å¿«é€Ÿé«˜æ•ˆå¯¼å…¥å¤§é‡ beanï¼Œæ›¿ä»£ @Import({a.class,b.class})ï¼Œæ— éœ€åœ¨æ¯ä¸ªç±»ä¸Šæ·»åŠ  @Bean</p><p>åç§°ï¼š ImportSelector</p><p>ç±»å‹ï¼š<strong>æ¥å£</strong></p><p>ä½œç”¨ï¼šè‡ªå®šä¹‰beanå¯¼å…¥å™¨</p><ul><li><p>selector / MyImportSelector</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyImportSelector</span> <span class="token keyword">implements</span> <span class="token class-name">ImportSelector</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">selectImports</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> importingClassMetadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//      1.ç¼–ç¨‹å½¢å¼åŠ è½½ä¸€ä¸ªç±»</span>
<span class="token comment">//      return new String[]{&quot;dao.impl.BookDaoImpl&quot;};</span>

<span class="token comment">//      2.åŠ è½½import.propertiesæ–‡ä»¶ä¸­çš„å•ä¸ªç±»å</span>
<span class="token comment">//      ResourceBundle bundle = ResourceBundle.getBundle(&quot;import&quot;);</span>
<span class="token comment">//      String className = bundle.getString(&quot;className&quot;);</span>

<span class="token comment">//      3.åŠ è½½import.propertiesæ–‡ä»¶ä¸­çš„å¤šä¸ªç±»å</span>
        <span class="token class-name">ResourceBundle</span> bundle <span class="token operator">=</span> <span class="token class-name">ResourceBundle</span><span class="token punctuation">.</span><span class="token function">getBundle</span><span class="token punctuation">(</span><span class="token string">&quot;import&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> className <span class="token operator">=</span> bundle<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;className&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> className<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>import.properties</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#2.åŠ è½½import.propertiesæ–‡ä»¶ä¸­çš„å•ä¸ªç±»å</span>
<span class="token comment">#className=dao.impl.BookDaoImpl</span>

<span class="token comment">#3.åŠ è½½import.propertiesæ–‡ä»¶ä¸­çš„å¤šä¸ªç±»å</span>
<span class="token comment">#className=dao.impl.BookDaoImpl,dao.impl.AccountDaoImpl</span>

<span class="token comment">#4.å¯¼å…¥åŒ…ä¸­çš„æ‰€æœ‰ç±»</span>
<span class="token key attr-name">path</span><span class="token punctuation">=</span><span class="token value attr-value">dao.impl.*</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>SpringConfig</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;dao&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;service&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">MyImportSelector</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringConfig</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h4 id="æ³¨å†Œå™¨" tabindex="-1"><a class="header-anchor" href="#æ³¨å†Œå™¨" aria-hidden="true">#</a> æ³¨å†Œå™¨</h4><p>å¯ä»¥å–ä»£ ComponentScan æ‰«æå™¨</p><p>åç§°ï¼šImportBeanDefinitionRegistrar</p><p>ç±»å‹ï¼š<strong>æ¥å£</strong></p><p>ä½œç”¨ï¼šè‡ªå®šä¹‰ bean å®šä¹‰æ³¨å†Œå™¨</p><ul><li><p>registrar / MyImportBeanDefinitionRegistrar</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyImportBeanDefinitionRegistrar</span> <span class="token keyword">implements</span> <span class="token class-name">ImportBeanDefinitionRegistrar</span> <span class="token punctuation">{</span>
<span class="token doc-comment comment">/**
 * AnnotationMetadata:å½“å‰ç±»çš„æ³¨è§£ä¿¡æ¯
 * BeanDefinitionRegistry:BeanDefinitionæ³¨å†Œç±»ï¼ŒæŠŠæ‰€æœ‰éœ€è¦æ·»åŠ åˆ°å®¹å™¨ä¸­çš„beanè°ƒç”¨registerBeanDefinitionæ‰‹å·¥æ³¨å†Œè¿›æ¥
 */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">AnnotationMetadata</span> importingClassMetadata<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionRegistry</span> registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//è‡ªå®šä¹‰æ³¨å†Œå™¨</span>
        <span class="token comment">//1.å¼€å¯ç±»è·¯å¾„beanå®šä¹‰æ‰«æå™¨ï¼Œéœ€è¦å‚æ•°beanå®šä¹‰æ³¨å†Œå™¨BeanDefinitionRegistryï¼Œéœ€è¦åˆ¶å®šæ˜¯å¦ä½¿ç”¨é»˜è®¤ç±»å‹è¿‡æ»¤å™¨</span>
        <span class="token class-name">ClassPathBeanDefinitionScanner</span> scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2.æ·»åŠ åŒ…å«æ€§åŠ è½½ç±»å‹è¿‡æ»¤å™¨ï¼ˆå¯é€‰ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸ºæ’é™¤æ€§åŠ è½½ç±»å‹è¿‡æ»¤å™¨ï¼‰</span>
        scanner<span class="token punctuation">.</span><span class="token function">addIncludeFilter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token class-name">MetadataReader</span> metadataReader<span class="token punctuation">,</span> <span class="token class-name">MetadataReaderFactory</span> metadataReaderFactory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                <span class="token comment">//æ‰€æœ‰åŒ¹é…å…¨éƒ¨æˆåŠŸï¼Œæ­¤å¤„åº”è¯¥æ·»åŠ å®é™…çš„ä¸šåŠ¡åˆ¤å®šæ¡ä»¶</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è®¾ç½®æ‰«æè·¯å¾„</span>
        scanner<span class="token punctuation">.</span><span class="token function">addExcludeFilter</span><span class="token punctuation">(</span>tf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//æ’é™¤</span>
        scanner<span class="token punctuation">.</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token string">&quot;dao&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;service&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>SpringConfig</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">MyImportBeanDefinitionRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringConfig</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h4 id="å¤„ç†å™¨" tabindex="-1"><a class="header-anchor" href="#å¤„ç†å™¨" aria-hidden="true">#</a> å¤„ç†å™¨</h4><p>é€šè¿‡åˆ›å»ºç±»<strong>ç»§æ‰¿ç›¸åº”çš„å¤„ç†å™¨çš„æ¥å£</strong>ï¼Œé‡å†™åç½®å¤„ç†çš„æ–¹æ³•ï¼Œæ¥å®ç°<strong>æ‹¦æˆª Bean çš„ç”Ÿå‘½å‘¨æœŸ</strong>æ¥å®ç°è‡ªå·±è‡ªå®šä¹‰çš„é€»è¾‘</p><p>BeanPostProcessorï¼šbean åç½®å¤„ç†å™¨ï¼Œbean åˆ›å»ºå¯¹è±¡åˆå§‹åŒ–å‰åè¿›è¡Œæ‹¦æˆªå·¥ä½œçš„</p><p>BeanFactoryPostProcessorï¼šbeanFactory çš„åç½®å¤„ç†å™¨</p><ul><li><pre><code> åŠ è½½æ—¶æœºï¼šåœ¨ BeanFactory åˆå§‹åŒ–ä¹‹åè°ƒç”¨ï¼Œæ¥å®šåˆ¶å’Œä¿®æ”¹ BeanFactory çš„å†…å®¹ï¼›æ‰€æœ‰çš„ bean å®šä¹‰å·²ç»ä¿å­˜åŠ è½½åˆ° beanFactoryï¼Œä½†æ˜¯ bean çš„å®ä¾‹è¿˜æœªåˆ›å»º
</code></pre></li><li><pre><code>  æ‰§è¡Œæµç¨‹ï¼š
</code></pre><ul><li>ioc å®¹å™¨åˆ›å»ºå¯¹è±¡</li><li>invokeBeanFactoryPostProcessors(beanFactory)ï¼šæ‰§è¡Œ BeanFactoryPostProcessor <ul><li>åœ¨ BeanFactory ä¸­æ‰¾åˆ°æ‰€æœ‰ç±»å‹æ˜¯ BeanFactoryPostProcessor çš„ç»„ä»¶ï¼Œå¹¶æ‰§è¡Œå®ƒä»¬çš„æ–¹æ³•</li><li>åœ¨åˆå§‹åŒ–åˆ›å»ºå…¶ä»–ç»„ä»¶å‰é¢æ‰§è¡Œ</li></ul></li></ul></li></ul><p>BeanDefinitionRegistryPostProcessorï¼š</p><ul><li><p>åŠ è½½æ—¶æœºï¼šåœ¨æ‰€æœ‰ bean å®šä¹‰ä¿¡æ¯å°†è¦è¢«åŠ è½½ï¼Œä½†æ˜¯ bean å®ä¾‹è¿˜æœªåˆ›å»ºï¼Œä¼˜å…ˆäº BeanFactoryPostProcessor æ‰§è¡Œï¼›åˆ©ç”¨ BeanDefinitionRegistryPostProcessor ç»™å®¹å™¨ä¸­å†é¢å¤–æ·»åŠ ä¸€äº›ç»„ä»¶</p></li><li><p>æ‰§è¡Œæµç¨‹ï¼š</p><ul><li>ioc å®¹å™¨åˆ›å»ºå¯¹è±¡</li><li>refresh() â†’ invokeBeanFactoryPostProcessors(beanFactory)</li><li>ä»å®¹å™¨ä¸­è·å–åˆ°æ‰€æœ‰çš„ BeanDefinitionRegistryPostProcessor ç»„ä»¶ <ul><li>ä¾æ¬¡è§¦å‘æ‰€æœ‰çš„ postProcessBeanDefinitionRegistry() æ–¹æ³•</li><li>å†æ¥è§¦å‘ postProcessBeanFactory() æ–¹æ³•</li></ul></li></ul></li></ul><hr><h4 id="ç›‘å¬å™¨" tabindex="-1"><a class="header-anchor" href="#ç›‘å¬å™¨" aria-hidden="true">#</a> ç›‘å¬å™¨</h4><h5 id="åŸºæœ¬æ¦‚è¿°-1" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ¦‚è¿°-1" aria-hidden="true">#</a> åŸºæœ¬æ¦‚è¿°</h5><p>ApplicationListenerï¼šç›‘å¬å®¹å™¨ä¸­å‘å¸ƒçš„äº‹ä»¶ï¼Œå®Œæˆäº‹ä»¶é©±åŠ¨æ¨¡å‹å¼€å‘</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span> <span class="token keyword">extends</span> <span class="token class-name">ApplicationEvent</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ‰€ä»¥ç›‘å¬ ApplicationEvent åŠå…¶ä¸‹é¢çš„å­äº‹ä»¶</p><p>åº”ç”¨ç›‘å¬å™¨æ­¥éª¤ï¼š</p><ul><li>å†™ä¸€ä¸ªç›‘å¬å™¨ï¼ˆApplicationListenerå®ç°ç±»ï¼‰æ¥ç›‘å¬æŸä¸ªäº‹ä»¶ï¼ˆApplicationEventåŠå…¶å­ç±»ï¼‰</li><li>æŠŠç›‘å¬å™¨åŠ å…¥åˆ°å®¹å™¨ @Component</li><li>åªè¦å®¹å™¨ä¸­æœ‰ç›¸å…³äº‹ä»¶çš„å‘å¸ƒï¼Œå°±èƒ½ç›‘å¬åˆ°è¿™ä¸ªäº‹ä»¶ï¼› <ul><li><pre><code>  ContextRefreshedEventï¼šå®¹å™¨åˆ·æ–°å®Œæˆï¼ˆæ‰€æœ‰ bean éƒ½å®Œå…¨åˆ›å»ºï¼‰ä¼šå‘å¸ƒè¿™ä¸ªäº‹ä»¶
</code></pre></li><li><pre><code>  ContextClosedEventï¼šå…³é—­å®¹å™¨ä¼šå‘å¸ƒè¿™ä¸ªäº‹ä»¶
</code></pre></li></ul></li><li>å‘å¸ƒä¸€ä¸ªäº‹ä»¶ï¼š<code>applicationContext.publishEvent()</code></li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyApplicationListener</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ApplicationEvent</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
	<span class="token comment">//å½“å®¹å™¨ä¸­å‘å¸ƒæ­¤äº‹ä»¶ä»¥åï¼Œæ–¹æ³•è§¦å‘</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ”¶åˆ°äº‹ä»¶ï¼š&quot;</span> <span class="token operator">+</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h5 id="å®ç°åŸç†" tabindex="-1"><a class="header-anchor" href="#å®ç°åŸç†" aria-hidden="true">#</a> å®ç°åŸç†</h5><p>ContextRefreshedEvent äº‹ä»¶ï¼š</p><ul><li><p>å®¹å™¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­æ‰§è¡Œ <code>initApplicationEventMulticaster()</code>ï¼šåˆå§‹åŒ–äº‹ä»¶å¤šæ’­å™¨</p><ul><li>å…ˆå»å®¹å™¨ä¸­æŸ¥è¯¢ <code>id = applicationEventMulticaster</code> çš„ç»„ä»¶ï¼Œæœ‰ç›´æ¥è¿”å›</li><li>æ²¡æœ‰å°±æ‰§è¡Œ <code>this.applicationEventMulticaster = new SimpleApplicationEventMulticaster(beanFactory)</code> å¹¶ä¸”åŠ å…¥åˆ°å®¹å™¨ä¸­</li><li>ä»¥ååœ¨å…¶ä»–ç»„ä»¶è¦æ´¾å‘äº‹ä»¶ï¼Œè‡ªåŠ¨æ³¨å…¥è¿™ä¸ª applicationEventMulticaster</li></ul></li><li><p>å®¹å™¨åˆå§‹åŒ–è¿‡ç¨‹æ‰§è¡Œ <strong>registerListeners()</strong> æ³¨å†Œç›‘å¬å™¨</p><ul><li>ä»å®¹å™¨ä¸­è·å–æ‰€æœ‰ç›‘å¬å™¨ï¼š<code>getBeanNamesForType(ApplicationListener.class, true, false)</code></li><li>å°† listener æ³¨å†Œåˆ° ApplicationEventMulticaster</li></ul></li><li><p>å®¹å™¨åˆ·æ–°å®Œæˆï¼šfinishRefresh() â†’ publishEvent(new ContextRefreshedEvent(this))</p><p>å‘å¸ƒ ContextRefreshedEvent äº‹ä»¶ï¼š</p><ul><li>è·å–äº‹ä»¶çš„å¤šæ’­å™¨ï¼ˆæ´¾å‘å™¨ï¼‰ï¼šgetApplicationEventMulticaster()</li><li>multicastEvent æ´¾å‘äº‹ä»¶ <ul><li>è·å–åˆ°æ‰€æœ‰çš„ ApplicationListener</li><li>éå† ApplicationListener <ul><li>å¦‚æœæœ‰ Executorï¼Œå¯ä»¥ä½¿ç”¨ Executor å¼‚æ­¥æ´¾å‘ <code>Executor executor = getTaskExecutor()</code></li><li>æ²¡æœ‰å°±åŒæ­¥æ‰§è¡Œ listener æ–¹æ³• <code>invokeListener(listener, event)</code>ï¼Œæ‹¿åˆ° listener å›è°ƒ onApplicationEvent</li></ul></li></ul></li></ul></li></ul><p>å®¹å™¨å…³é—­ä¼šå‘å¸ƒ ContextClosedEvent</p><hr><h5 id="æ³¨è§£å®ç°" tabindex="-1"><a class="header-anchor" href="#æ³¨è§£å®ç°" aria-hidden="true">#</a> æ³¨è§£å®ç°</h5><p>æ³¨è§£ï¼š@EventListener</p><p>åŸºæœ¬ä½¿ç”¨ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@EventListener</span><span class="token punctuation">(</span>classes<span class="token operator">=</span><span class="token punctuation">{</span><span class="token class-name">ApplicationEvent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token class-name">ApplicationEvent</span> event<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;UserServiceã€‚ã€‚ç›‘å¬åˆ°çš„äº‹ä»¶ï¼š&quot;</span> <span class="token operator">+</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŸç†ï¼šä½¿ç”¨ EventListenerMethodProcessor å¤„ç†å™¨æ¥è§£ææ–¹æ³•ä¸Šçš„ @EventListenerï¼ŒSpring æ‰«æä½¿ç”¨æ³¨è§£çš„æ–¹æ³•ï¼Œå¹¶ä¸ºä¹‹åˆ›å»ºä¸€ä¸ªç›‘å¬å¯¹è±¡</p><p>SmartInitializingSingleton åŸç†ï¼šafterSingletonsInstantiated()</p><ul><li><pre><code> 	IOC å®¹å™¨åˆ›å»ºå¯¹è±¡å¹¶ refresh()
</code></pre></li><li><pre><code> 	finishBeanFactoryInitialization(beanFactory)ï¼šåˆå§‹åŒ–å‰©ä¸‹çš„å•å®ä¾‹ bean
* å…ˆåˆ›å»ºæ‰€æœ‰çš„å•å®ä¾‹ beanï¼šgetBean()
* è·å–æ‰€æœ‰åˆ›å»ºå¥½çš„å•å®ä¾‹ beanï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ SmartInitializingSingleton ç±»å‹çš„ï¼Œå¦‚æœæ˜¯å°±è°ƒç”¨ afterSingletonsInstantiated()
</code></pre></li></ul><hr><h2 id="aop" tabindex="-1"><a class="header-anchor" href="#aop" aria-hidden="true">#</a> AOP</h2><h3 id="åŸºæœ¬æ¦‚è¿°-2" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ¦‚è¿°-2" aria-hidden="true">#</a> åŸºæœ¬æ¦‚è¿°</h3><p>AOPï¼ˆAspect Oriented Programingï¼‰ï¼šé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œä¸€ç§ç¼–ç¨‹<strong>èŒƒå¼</strong>ï¼ŒæŒ‡å¯¼å¼€å‘è€…å¦‚ä½•ç»„ç»‡ç¨‹åºç»“æ„</p><p>AOP å¼¥è¡¥äº† OOP çš„ä¸è¶³ï¼ŒåŸºäº OOP åŸºç¡€ä¹‹ä¸Šè¿›è¡Œæ¨ªå‘å¼€å‘ï¼š</p><ul><li><p>uOOP è§„å®šç¨‹åºå¼€å‘ä»¥ç±»ä¸ºä¸»ä½“æ¨¡å‹ï¼Œä¸€åˆ‡å›´ç»•å¯¹è±¡è¿›è¡Œï¼Œå®ŒæˆæŸä¸ªä»»åŠ¡å…ˆæ„å»ºæ¨¡å‹</p></li><li><p>uAOP ç¨‹åºå¼€å‘ä¸»è¦å…³æ³¨åŸºäº OOP å¼€å‘ä¸­çš„å…±æ€§åŠŸèƒ½ï¼Œä¸€åˆ‡å›´ç»•å…±æ€§åŠŸèƒ½è¿›è¡Œï¼Œå®ŒæˆæŸä¸ªä»»åŠ¡å…ˆæ„å»ºå¯èƒ½é‡åˆ°çš„æ‰€æœ‰å…±æ€§åŠŸèƒ½ï¼ˆå½“æ‰€æœ‰åŠŸèƒ½éƒ½å¼€å‘å‡ºæ¥ä¹Ÿå°±æ²¡æœ‰å…±æ€§ä¸éå…±æ€§ä¹‹åˆ†ï¼‰ï¼Œå°†è½¯ä»¶å¼€å‘ç”±æ‰‹å·¥åˆ¶ä½œèµ°å‘åŠè‡ªåŠ¨åŒ–/å…¨è‡ªåŠ¨åŒ–é˜¶æ®µï¼Œå®ç°â€œæ’æ‹”å¼ç»„ä»¶ä½“ç³»ç»“æ„â€æ­å»º</p></li></ul><p>AOP ä½œç”¨ï¼š</p><ul><li><p>æé«˜ä»£ç çš„å¯é‡ç”¨æ€§</p></li><li><p>ä¸šåŠ¡ä»£ç ç¼–ç æ›´ç®€æ´</p></li><li><p>ä¸šåŠ¡ä»£ç ç»´æŠ¤æ›´é«˜æ•ˆ</p></li><li><p>ä¸šåŠ¡åŠŸèƒ½æ‰©å±•æ›´ä¾¿æ·</p></li></ul><hr><h3 id="æ ¸å¿ƒæ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒæ¦‚å¿µ" aria-hidden="true">#</a> æ ¸å¿ƒæ¦‚å¿µ</h3><h4 id="æ¦‚å¿µè¯¦è§£" tabindex="-1"><a class="header-anchor" href="#æ¦‚å¿µè¯¦è§£" aria-hidden="true">#</a> æ¦‚å¿µè¯¦è§£</h4><ul><li><p>Joinpointï¼ˆè¿æ¥ç‚¹ï¼‰ï¼šå°±æ˜¯æ–¹æ³•</p></li><li><p>Pointcutï¼ˆåˆ‡å…¥ç‚¹ï¼‰ï¼šå°±æ˜¯æŒ–æ‰å…±æ€§åŠŸèƒ½çš„æ–¹æ³•</p></li><li><p>Adviceï¼ˆé€šçŸ¥ï¼‰ï¼šå°±æ˜¯å…±æ€§åŠŸèƒ½ï¼Œæœ€ç»ˆä»¥ä¸€ä¸ªæ–¹æ³•çš„å½¢å¼å‘ˆç°</p></li><li><p>Aspectï¼ˆåˆ‡é¢ï¼‰ï¼šå°±æ˜¯å…±æ€§åŠŸèƒ½ä¸æŒ–çš„ä½ç½®çš„å¯¹åº”å…³ç³»</p></li><li><p>Targetï¼ˆç›®æ ‡å¯¹è±¡ï¼‰ï¼šå°±æ˜¯æŒ–æ‰åŠŸèƒ½çš„æ–¹æ³•å¯¹åº”çš„ç±»äº§ç”Ÿçš„å¯¹è±¡ï¼Œè¿™ç§å¯¹è±¡æ˜¯æ— æ³•ç›´æ¥å®Œæˆæœ€ç»ˆå·¥ä½œçš„</p></li><li><p>Weavingï¼ˆç»‡å…¥ï¼‰ï¼šå°±æ˜¯å°†æŒ–æ‰çš„åŠŸèƒ½å›å¡«çš„åŠ¨æ€è¿‡ç¨‹</p></li><li><p>Proxyï¼ˆä»£ç†ï¼‰ï¼šç›®æ ‡å¯¹è±¡æ— æ³•ç›´æ¥å®Œæˆå·¥ä½œï¼Œéœ€è¦å¯¹å…¶è¿›è¡ŒåŠŸèƒ½å›å¡«ï¼Œé€šè¿‡åˆ›å»ºåŸå§‹å¯¹è±¡çš„ä»£ç†å¯¹è±¡å®ç°</p></li><li><p>Introductionï¼ˆå¼•å…¥/å¼•ä»‹ï¼‰ï¼šå°±æ˜¯å¯¹åŸå§‹å¯¹è±¡æ— ä¸­ç”Ÿæœ‰çš„æ·»åŠ æˆå‘˜å˜é‡æˆ–æˆå‘˜æ–¹æ³•</p></li></ul><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/AOPè¿æ¥ç‚¹.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/AOPåˆ‡å…¥ç‚¹åˆ‡é¢é€šçŸ¥.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/AOPç»‡å…¥.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h4 id="å…¥é—¨é¡¹ç›®-1" tabindex="-1"><a class="header-anchor" href="#å…¥é—¨é¡¹ç›®-1" aria-hidden="true">#</a> å…¥é—¨é¡¹ç›®</h4><p>å¼€å‘æ­¥éª¤ï¼š</p><ul><li><p>å¼€å‘é˜¶æ®µ</p><ul><li><p>åˆ¶ä½œç¨‹åº</p></li><li><p>å°†éå…±æ€§åŠŸèƒ½å¼€å‘åˆ°å¯¹åº”çš„ç›®æ ‡å¯¹è±¡ç±»ä¸­ï¼Œå¹¶åˆ¶ä½œæˆåˆ‡å…¥ç‚¹æ–¹æ³•</p></li><li><p>å°†å…±æ€§åŠŸèƒ½ç‹¬ç«‹å¼€å‘å‡ºæ¥ï¼Œåˆ¶ä½œæˆé€šçŸ¥</p></li><li><p>åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå£°æ˜åˆ‡å…¥ç‚¹</p></li><li><p>åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå£°æ˜åˆ‡å…¥ç‚¹ä¸é€šçŸ¥é—´çš„å…³ç³»ï¼ˆå«é€šçŸ¥ç±»å‹ï¼‰ï¼Œå³åˆ‡é¢</p></li></ul></li><li><p>è¿è¡Œé˜¶æ®µï¼ˆAOP å®Œæˆï¼‰</p><ul><li><p>Spring å®¹å™¨åŠ è½½é…ç½®æ–‡ä»¶ï¼Œç›‘æ§æ‰€æœ‰é…ç½®çš„<strong>åˆ‡å…¥ç‚¹</strong>æ–¹æ³•çš„æ‰§è¡Œ</p></li><li><p>å½“ç›‘æ§åˆ°åˆ‡å…¥ç‚¹æ–¹æ³•è¢«è¿è¡Œï¼Œ<strong>ä½¿ç”¨ä»£ç†æœºåˆ¶ï¼ŒåŠ¨æ€åˆ›å»ºç›®æ ‡å¯¹è±¡çš„ä»£ç†å¯¹è±¡ï¼Œæ ¹æ®é€šçŸ¥ç±»åˆ«ï¼Œåœ¨ä»£ç†å¯¹è±¡çš„å¯¹åº”ä½ç½®å°†é€šçŸ¥å¯¹åº”çš„åŠŸèƒ½ç»‡å…¥</strong>ï¼Œå®Œæˆå®Œæ•´çš„ä»£ç é€»è¾‘å¹¶è¿è¡Œ</p></li></ul></li></ul><ol><li><p>å¯¼å…¥åæ ‡ pom.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-context<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.9.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.aspectj<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>aspectjweaver<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>ä¸šåŠ¡å±‚æŠ½å–é€šç”¨ä»£ç  service / UserServiceImpl</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//System.out.println(&quot;å…±æ€§åŠŸèƒ½&quot;);</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user service running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>aop.AOPAdvice</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//1.åˆ¶ä½œé€šçŸ¥ç±»ï¼Œåœ¨ç±»ä¸­å®šä¹‰ä¸€ä¸ªæ–¹æ³•ç”¨äºå®Œæˆå…±æ€§åŠŸèƒ½</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AOPAdvice</span> <span class="token punctuation">{</span>
    <span class="token comment">//å…±æ€§åŠŸèƒ½æŠ½å–åèŒç§°ç‹¬ç«‹çš„æ–¹æ³•</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å…±æ€§åŠŸèƒ½&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æŠŠé€šçŸ¥åŠ å…¥springå®¹å™¨ç®¡ç†ï¼Œé…ç½®aop applicationContext.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/context<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>aop</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/aop<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>
        http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        https://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/aop
        https://www.springframework.org/schema/aop/spring-aop.xsd
        <span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--åŸå§‹Springæ§åˆ¶èµ„æº--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span> <span class="token punctuation">&quot;</span>service.impl.UserServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!--2.é…ç½®å…±æ€§åŠŸèƒ½æˆåŠŸspringæ§åˆ¶çš„èµ„æº--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aop.AOPAdvice<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!--3.å¼€å¯AOPå‘½åç©ºé—´: beansæ ‡ç­¾å†…--&gt;</span>
    <span class="token comment">&lt;!--4.é…ç½®AOP--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--5.é…ç½®åˆ‡å…¥ç‚¹--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* *..*(..))<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!--6.é…ç½®åˆ‡é¢ï¼ˆåˆ‡å…¥ç‚¹ä¸é€šçŸ¥çš„å…³ç³»ï¼‰--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myAdvice<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--7.é…ç½®å…·ä½“çš„åˆ‡å…¥ç‚¹å¯¹åº”é€šçŸ¥ä¸­é‚£ä¸ªæ“ä½œæ–¹æ³•--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>before</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>function<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æµ‹è¯•ç±»</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ApplicationContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">&quot;applicationContext.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å…ˆè¾“å‡ºå…±æ€§åŠŸèƒ½ï¼Œç„¶å user service running...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><hr><h3 id="xmlå¼€å‘-1" tabindex="-1"><a class="header-anchor" href="#xmlå¼€å‘-1" aria-hidden="true">#</a> XMLå¼€å‘</h3><h4 id="aspectj" tabindex="-1"><a class="header-anchor" href="#aspectj" aria-hidden="true">#</a> AspectJ</h4><p>Aspectï¼ˆåˆ‡é¢ï¼‰ç”¨äºæè¿°åˆ‡å…¥ç‚¹ä¸é€šçŸ¥é—´çš„å…³ç³»ï¼Œæ˜¯ AOP ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªæ¦‚å¿µ</p><p>AspectJ æ˜¯åŸºäº java è¯­è¨€å¯¹ Aspect çš„å®ç°</p><hr><h4 id="aop-1" tabindex="-1"><a class="header-anchor" href="#aop-1" aria-hidden="true">#</a> AOP</h4><h5 id="config" tabindex="-1"><a class="header-anchor" href="#config" aria-hidden="true">#</a> config</h5><p>æ ‡ç­¾ï¼š<a href="aop:config">aop:config</a>ï¼Œ&lt;beans&gt; çš„å­æ ‡ç­¾</p><p>ä½œç”¨ï¼šè®¾ç½® AOP</p><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>â€¦â€¦<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>â€¦â€¦<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--ä¸€ä¸ªbeansæ ‡ç­¾ä¸­å¯ä»¥é…ç½®å¤šä¸ªaop:configæ ‡ç­¾--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h5 id="pointcut" tabindex="-1"><a class="header-anchor" href="#pointcut" aria-hidden="true">#</a> pointcut</h5><p>æ ‡ç­¾ï¼š<a href="aop:pointcut">aop:pointcut</a>ï¼Œå½’å±äº aop:config æ ‡ç­¾å’Œ aop:aspect æ ‡ç­¾</p><p>ä½œç”¨ï¼šè®¾ç½®åˆ‡å…¥ç‚¹</p><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pointcutId<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>â€¦â€¦<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pointcutId<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>â€¦â€¦<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><ul><li>ä¸€ä¸ª aop:config æ ‡ç­¾ä¸­å¯ä»¥é…ç½®å¤šä¸ª aop:pointcut æ ‡ç­¾ï¼Œä¸”è¯¥æ ‡ç­¾å¯ä»¥é…ç½®åœ¨ aop:aspect æ ‡ç­¾å†…</li></ul><p>å±æ€§ï¼š</p><ul><li><p>id ï¼šè¯†åˆ«åˆ‡å…¥ç‚¹çš„åç§°</p></li><li><p>expression ï¼šåˆ‡å…¥ç‚¹è¡¨è¾¾å¼</p></li></ul><hr><h5 id="aspect" tabindex="-1"><a class="header-anchor" href="#aspect" aria-hidden="true">#</a> aspect</h5><p>æ ‡ç­¾ï¼š<a href="aop:aspect">aop:aspect</a>ï¼Œaop:config çš„å­æ ‡ç­¾</p><p>ä½œç”¨ï¼šè®¾ç½®å…·ä½“çš„ AOP é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹ï¼ˆåˆ‡é¢ï¼‰</p><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>beanId<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>â€¦â€¦<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>beanId<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>â€¦â€¦<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--ä¸€ä¸ªaop:configæ ‡ç­¾ä¸­å¯ä»¥é…ç½®å¤šä¸ªaop:aspectæ ‡ç­¾--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å±æ€§ï¼š</p><ul><li>ref ï¼šé€šçŸ¥æ‰€åœ¨çš„ bean çš„ id</li></ul><hr><h4 id="pointcut-1" tabindex="-1"><a class="header-anchor" href="#pointcut-1" aria-hidden="true">#</a> Pointcut</h4><h5 id="åˆ‡å…¥ç‚¹" tabindex="-1"><a class="header-anchor" href="#åˆ‡å…¥ç‚¹" aria-hidden="true">#</a> åˆ‡å…¥ç‚¹</h5><p>åˆ‡å…¥ç‚¹æè¿°çš„æ˜¯æŸä¸ªæ–¹æ³•</p><p>åˆ‡å…¥ç‚¹è¡¨è¾¾å¼æ˜¯ä¸€ä¸ªå¿«é€ŸåŒ¹é…æ–¹æ³•æè¿°çš„é€šé…æ ¼å¼ï¼Œç±»ä¼¼äºæ­£åˆ™è¡¨è¾¾å¼</p><hr><h5 id="è¡¨è¾¾å¼" tabindex="-1"><a class="header-anchor" href="#è¡¨è¾¾å¼" aria-hidden="true">#</a> è¡¨è¾¾å¼</h5><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>å…³é”®å­—(è®¿é—®ä¿®é¥°ç¬¦  è¿”å›å€¼  åŒ…å.ç±»å.æ–¹æ³•å(å‚æ•°)å¼‚å¸¸å)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>ç¤ºä¾‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//åŒ¹é…UserServiceä¸­åªå«æœ‰ä¸€ä¸ªå‚æ•°çš„findByIdæ–¹æ³•</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token class-name"><span class="token namespace">service<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>æ ¼å¼è§£æï¼š</p><ul><li>å…³é”®å­—ï¼šæè¿°è¡¨è¾¾å¼çš„åŒ¹é…æ¨¡å¼ï¼ˆå‚çœ‹å…³é”®å­—åˆ—è¡¨ï¼‰</li><li>è®¿é—®ä¿®é¥°ç¬¦ï¼šæ–¹æ³•çš„è®¿é—®æ§åˆ¶æƒé™ä¿®é¥°ç¬¦</li><li>ç±»åï¼šæ–¹æ³•æ‰€åœ¨çš„ç±»ï¼ˆæ­¤å¤„å¯ä»¥é…ç½®æ¥å£åç§°ï¼‰</li><li>å¼‚å¸¸ï¼šæ–¹æ³•å®šä¹‰ä¸­æŒ‡å®šæŠ›å‡ºçš„å¼‚å¸¸</li></ul><p>å…³é”®å­—ï¼š</p><ul><li><p>execution ï¼šåŒ¹é…æ‰§è¡ŒæŒ‡å®šæ–¹æ³•</p></li><li><p>args ï¼šåŒ¹é…å¸¦æœ‰æŒ‡å®šå‚æ•°ç±»å‹çš„æ–¹æ³•</p></li><li><p>withinã€thisã€targetã€@withinã€@targetã€@argsã€@annotationã€beanã€reference pointcutç­‰</p></li></ul><p>é€šé…ç¬¦ï¼š</p><ul><li><p>*ï¼šå•ä¸ªç‹¬ç«‹çš„ä»»æ„ç¬¦å·ï¼Œå¯ä»¥ç‹¬ç«‹å‡ºç°ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºå‰ç¼€æˆ–è€…åç¼€çš„åŒ¹é…ç¬¦å‡ºç°</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//åŒ¹é…com.seazeanåŒ…ä¸‹çš„ä»»æ„åŒ…ä¸­çš„UserServiceç±»æˆ–æ¥å£ä¸­æ‰€æœ‰findå¼€å¤´çš„å¸¦æœ‰ä¸€ä¸ªä»»æ„å‚æ•°çš„æ–¹æ³•</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token operator">*</span> com<span class="token punctuation">.</span>seazean<span class="token punctuation">.</span>*<span class="token punctuation">.</span>UserService<span class="token punctuation">.</span>find<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>.. ï¼šå¤šä¸ªè¿ç»­çš„ä»»æ„ç¬¦å·ï¼Œå¯ä»¥ç‹¬ç«‹å‡ºç°ï¼Œå¸¸ç”¨äºç®€åŒ–åŒ…åä¸å‚æ•°</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//åŒ¹é…comåŒ…ä¸‹çš„ä»»æ„åŒ…ä¸­çš„UserServiceç±»æˆ–æ¥å£ä¸­æ‰€æœ‰åç§°ä¸ºfindByIdå‚æ•°ä»»æ„æ•°é‡å’Œç±»å‹çš„æ–¹æ³•</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token class-name">User</span> com<span class="token punctuation">.</span><span class="token punctuation">.</span>UserService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>+ï¼šä¸“ç”¨äºåŒ¹é…å­ç±»ç±»å‹</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//åŒ¹é…ä»»æ„åŒ…ä¸‹çš„Serviceç»“å°¾çš„ç±»æˆ–è€…æ¥å£çš„å­ç±»æˆ–è€…å®ç°ç±»</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token operator">*</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token punctuation">.</span>*<span class="token class-name">Service</span><span class="token operator">+</span><span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>é€»è¾‘è¿ç®—ç¬¦ï¼š</p><ul><li>&amp;&amp;ï¼šè¿æ¥ä¸¤ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œè¡¨ç¤ºä¸¤ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼åŒæ—¶æˆç«‹çš„åŒ¹é…</li><li>||ï¼šè¿æ¥ä¸¤ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œè¡¨ç¤ºä¸¤ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼æˆç«‹ä»»æ„ä¸€ä¸ªçš„åŒ¹é…</li><li>! ï¼šè¿æ¥å•ä¸ªåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œè¡¨ç¤ºè¯¥åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ä¸æˆç«‹çš„åŒ¹é…</li></ul><p>ç¤ºä¾‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token function">execution</span><span class="token punctuation">(</span><span class="token operator">*</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>		<span class="token comment">//å‰ä¸‰ä¸ªéƒ½æ˜¯åŒ¹é…å…¨éƒ¨</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token operator">*</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token operator">*</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token punctuation">.</span>*<span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token operator">*</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token punctuation">.</span>*<span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token punctuation">.</span>*<span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token punctuation">.</span>*<span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token keyword">void</span> com<span class="token punctuation">.</span><span class="token punctuation">.</span>*<span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token keyword">void</span> com<span class="token punctuation">.</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>*<span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token keyword">void</span> com<span class="token punctuation">.</span>seazean<span class="token punctuation">.</span>service<span class="token punctuation">.</span>*<span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>seazean<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span>User</span><span class="token operator">*</span><span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token keyword">void</span> com<span class="token punctuation">.</span>seazean<span class="token punctuation">.</span>service<span class="token punctuation">.</span>*<span class="token class-name">Service</span><span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>seazean<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span>*<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>seazean<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span>find<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	<span class="token comment">//findå¼€å¤´</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>seazean<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span>*<span class="token class-name">Id</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>		<span class="token comment">//I</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>seazean<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>seazean<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>seazean<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>seazean<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>seazean<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span>UserService</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">execution</span><span class="token punctuation">(</span><span class="token class-name">List</span> com<span class="token punctuation">.</span>seazean<span class="token punctuation">.</span>service<span class="token punctuation">.</span>*<span class="token class-name">Service</span><span class="token operator">+</span><span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h5 id="é…ç½®æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#é…ç½®æ–¹å¼" aria-hidden="true">#</a> é…ç½®æ–¹å¼</h5><p>XML é…ç½®è§„åˆ™ï¼š</p><ul><li><p>ä¼ä¸šå¼€å‘å‘½åè§„èŒƒä¸¥æ ¼éµå¾ªè§„èŒƒæ–‡æ¡£è¿›è¡Œ</p></li><li><p>å…ˆä¸ºæ–¹æ³•é…ç½®å±€éƒ¨åˆ‡å…¥ç‚¹ï¼Œå†æŠ½å–ç±»ä¸­å…¬å…±åˆ‡å…¥ç‚¹ï¼Œæœ€åæŠ½å–å…¨å±€åˆ‡å…¥ç‚¹</p></li><li><p>ä»£ç èµ°æŸ¥è¿‡ç¨‹ä¸­æ£€æµ‹åˆ‡å…¥ç‚¹æ˜¯å¦å­˜åœ¨è¶Šç•Œæ€§åŒ…å«</p></li><li><p>ä»£ç èµ°æŸ¥è¿‡ç¨‹ä¸­æ£€æµ‹åˆ‡å…¥ç‚¹æ˜¯å¦å­˜åœ¨éåŒ…å«æ€§è¿›é©»</p></li><li><p>è®¾å®š AOP æ‰§è¡Œæ£€æµ‹ç¨‹åºï¼Œåœ¨å•å…ƒæµ‹è¯•ä¸­ç›‘æ§é€šçŸ¥è¢«æ‰§è¡Œæ¬¡æ•°ä¸é¢„è®¡æ¬¡æ•°æ˜¯å¦åŒ¹é…ï¼ˆä¸ç»å¯¹æ­£ç¡®ï¼šåŠ è¿›ä¸€ä¸ªä¸è¯¥åŠ çš„ï¼Œåˆ å»ä¸€ä¸ªä¸è¯¥åˆ çš„ç›¸å½“äºç»“æœä¸å˜ï¼‰</p></li><li><p>è®¾å®šå®Œæ¯•çš„åˆ‡å…¥ç‚¹å¦‚æœå‘ç”Ÿè°ƒæ•´åŠ¡å¿…è¿›è¡Œå›å½’æµ‹è¯•</p></li></ul><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--1.é…ç½®å…¬å…±åˆ‡å…¥ç‚¹--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* *(..))<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myAdvice<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--2.é…ç½®å±€éƒ¨åˆ‡å…¥ç‚¹--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* *(..))<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!--å¼•ç”¨å…¬å…±åˆ‡å…¥ç‚¹--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>before</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>logAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt1<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!--å¼•ç”¨å±€éƒ¨åˆ‡å…¥ç‚¹--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>before</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>logAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt2<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!--3.ç›´æ¥é…ç½®åˆ‡å…¥ç‚¹--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>before</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>logAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* *(..))<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="advice" tabindex="-1"><a class="header-anchor" href="#advice" aria-hidden="true">#</a> Advice</h4><h5 id="é€šçŸ¥ç±»å‹" tabindex="-1"><a class="header-anchor" href="#é€šçŸ¥ç±»å‹" aria-hidden="true">#</a> é€šçŸ¥ç±»å‹</h5><p>AOP çš„é€šçŸ¥ç±»å‹å…±5ç§ï¼šå‰ç½®é€šçŸ¥ï¼Œåç½®é€šçŸ¥ã€è¿”å›åé€šçŸ¥ã€æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥ã€ç¯ç»•é€šçŸ¥</p><h6 id="before" tabindex="-1"><a class="header-anchor" href="#before" aria-hidden="true">#</a> before</h6><p>æ ‡ç­¾ï¼š<a href="aop:before">aop:before</a>ï¼Œaop:aspectçš„å­æ ‡ç­¾</p><p>ä½œç”¨ï¼šè®¾ç½®å‰ç½®é€šçŸ¥</p><ul><li><strong>å‰ç½®é€šçŸ¥</strong>ï¼šåŸå§‹æ–¹æ³•æ‰§è¡Œå‰æ‰§è¡Œï¼Œå¦‚æœé€šçŸ¥ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œé˜»æ­¢åŸå§‹æ–¹æ³•è¿è¡Œ</li><li>åº”ç”¨ï¼šæ•°æ®æ ¡éªŒ</li></ul><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>adviceId<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>before</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>methodName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* *(..))<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!--ä¸€ä¸ªaop:aspectæ ‡ç­¾ä¸­å¯ä»¥é…ç½®å¤šä¸ªaop:beforeæ ‡ç­¾--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŸºæœ¬å±æ€§ï¼š</p><ul><li><p>methodï¼šåœ¨é€šçŸ¥ç±»ä¸­è®¾ç½®å½“å‰é€šçŸ¥ç±»åˆ«å¯¹åº”çš„æ–¹æ³•</p></li><li><p>pointcutï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œä¸pointcut-refå±æ€§å†²çª</p></li><li><p>pointcut-refï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹idï¼Œä¸pointcutå±æ€§å†²çª</p></li></ul><h6 id="after" tabindex="-1"><a class="header-anchor" href="#after" aria-hidden="true">#</a> after</h6><p>æ ‡ç­¾ï¼š<a href="aop:after">aop:after</a>ï¼Œaop:aspectçš„å­æ ‡ç­¾</p><p>ä½œç”¨ï¼šè®¾ç½®åç½®é€šçŸ¥</p><ul><li><p><strong>åç½®é€šçŸ¥</strong>ï¼šåŸå§‹æ–¹æ³•æ‰§è¡Œåæ‰§è¡Œï¼Œæ— è®ºåŸå§‹æ–¹æ³•ä¸­æ˜¯å¦å‡ºç°å¼‚å¸¸ï¼Œéƒ½å°†æ‰§è¡Œé€šçŸ¥</p></li><li><p>åº”ç”¨ï¼šç°åœºæ¸…ç†</p></li></ul><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>adviceId<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>after</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>methodName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* *(..))<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!--ä¸€ä¸ªaop:aspectæ ‡ç­¾ä¸­å¯ä»¥é…ç½®å¤šä¸ªaop:afteræ ‡ç­¾--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŸºæœ¬å±æ€§ï¼š</p><ul><li><p>methodï¼šåœ¨é€šçŸ¥ç±»ä¸­è®¾ç½®å½“å‰é€šçŸ¥ç±»åˆ«å¯¹åº”çš„æ–¹æ³•</p></li><li><p>pointcutï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œä¸pointcut-refå±æ€§å†²çª</p></li><li><p>pointcut-refï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹idï¼Œä¸pointcutå±æ€§å†²çª</p></li></ul><h6 id="after-r" tabindex="-1"><a class="header-anchor" href="#after-r" aria-hidden="true">#</a> after-r</h6><p>æ ‡ç­¾ï¼š<a href="aop:after-returning">aop:after-returning</a>ï¼Œaop:aspectçš„å­æ ‡ç­¾</p><p>ä½œç”¨ï¼šè®¾ç½®è¿”å›åé€šçŸ¥</p><ul><li><p><strong>è¿”å›åé€šçŸ¥</strong>ï¼šåŸå§‹æ–¹æ³•æ­£å¸¸æ‰§è¡Œå®Œæ¯•å¹¶è¿”å›ç»“æœåæ‰§è¡Œï¼Œå¦‚æœåŸå§‹æ–¹æ³•ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œæ— æ³•æ‰§è¡Œ</p></li><li><p>åº”ç”¨ï¼šè¿”å›å€¼ç›¸å…³æ•°æ®å¤„ç†</p></li></ul><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>adviceId<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>after-returning</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>methodName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* *(..))<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!--ä¸€ä¸ªaop:aspectæ ‡ç­¾ä¸­å¯ä»¥é…ç½®å¤šä¸ªaop:after-returningæ ‡ç­¾--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŸºæœ¬å±æ€§ï¼š</p><ul><li>methodï¼šåœ¨é€šçŸ¥ç±»ä¸­è®¾ç½®å½“å‰é€šçŸ¥ç±»åˆ«å¯¹åº”çš„æ–¹æ³•</li><li>pointcutï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œä¸pointcut-refå±æ€§å†²çª</li><li>pointcut-refï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹idï¼Œä¸pointcutå±æ€§å†²çª</li><li>returningï¼šè®¾ç½®æ¥å—è¿”å›å€¼çš„å‚æ•°ï¼Œä¸é€šçŸ¥ç±»ä¸­å¯¹åº”æ–¹æ³•çš„å‚æ•°ä¸€è‡´</li></ul><h6 id="after-t" tabindex="-1"><a class="header-anchor" href="#after-t" aria-hidden="true">#</a> after-t</h6><p>æ ‡ç­¾ï¼š<a href="aop:after-throwing">aop:after-throwing</a>ï¼Œaop:aspectçš„å­æ ‡ç­¾</p><p>ä½œç”¨ï¼šè®¾ç½®æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥</p><ul><li><strong>æŠ›å‡ºå¼‚å¸¸åé€šçŸ¥</strong>ï¼šåŸå§‹æ–¹æ³•æŠ›å‡ºå¼‚å¸¸åæ‰§è¡Œï¼Œå¦‚æœåŸå§‹æ–¹æ³•æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œæ— æ³•æ‰§è¡Œ</li><li>åº”ç”¨ï¼šå¯¹åŸå§‹æ–¹æ³•ä¸­å‡ºç°çš„å¼‚å¸¸ä¿¡æ¯è¿›è¡Œå¤„ç†</li></ul><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>adviceId<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>after-throwing</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>methodName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* *(..))<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!--ä¸€ä¸ªaop:aspectæ ‡ç­¾ä¸­å¯ä»¥é…ç½®å¤šä¸ªaop:after-throwingæ ‡ç­¾--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŸºæœ¬å±æ€§ï¼š</p><ul><li>methodï¼šåœ¨é€šçŸ¥ç±»ä¸­è®¾ç½®å½“å‰é€šçŸ¥ç±»åˆ«å¯¹åº”çš„æ–¹æ³•</li><li>pointcutï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œä¸pointcut-refå±æ€§å†²çª</li><li>pointcut-refï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹idï¼Œä¸pointcutå±æ€§å†²çª</li><li>throwingï¼šè®¾ç½®æ¥å—å¼‚å¸¸å¯¹è±¡çš„å‚æ•°ï¼Œä¸é€šçŸ¥ç±»ä¸­å¯¹åº”æ–¹æ³•çš„å‚æ•°ä¸€è‡´</li></ul><h6 id="around" tabindex="-1"><a class="header-anchor" href="#around" aria-hidden="true">#</a> around</h6><p>æ ‡ç­¾ï¼š<a href="aop:around">aop:around</a>ï¼Œaop:aspectçš„å­æ ‡ç­¾</p><p>ä½œç”¨ï¼šè®¾ç½®ç¯ç»•é€šçŸ¥</p><ul><li><p><strong>ç¯ç»•é€šçŸ¥</strong>ï¼šåœ¨åŸå§‹æ–¹æ³•æ‰§è¡Œå‰åå‡æœ‰å¯¹åº”æ‰§è¡Œæ‰§è¡Œï¼Œè¿˜å¯ä»¥é˜»æ­¢åŸå§‹æ–¹æ³•çš„æ‰§è¡Œ</p></li><li><p>åº”ç”¨ï¼šåŠŸèƒ½å¼ºå¤§ï¼Œå¯ä»¥åšä»»ä½•äº‹æƒ…</p></li></ul><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>adviceId<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>around</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>methodName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* *(..))<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!--ä¸€ä¸ªaop:aspectæ ‡ç­¾ä¸­å¯ä»¥é…ç½®å¤šä¸ªaop:aroundæ ‡ç­¾--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŸºæœ¬å±æ€§ï¼š</p><ul><li><p>method ï¼šåœ¨é€šçŸ¥ç±»ä¸­è®¾ç½®å½“å‰é€šçŸ¥ç±»åˆ«å¯¹åº”çš„æ–¹æ³•</p></li><li><p>pointcut ï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼ï¼Œä¸pointcut-refå±æ€§å†²çª</p></li><li><p>pointcut-ref ï¼šè®¾ç½®å½“å‰é€šçŸ¥å¯¹åº”çš„åˆ‡å…¥ç‚¹idï¼Œä¸pointcutå±æ€§å†²çª</p></li></ul><p>ç¯ç»•é€šçŸ¥çš„å¼€å‘æ–¹å¼ï¼ˆå‚è€ƒé€šçŸ¥é¡ºåºç« èŠ‚ï¼‰ï¼š</p><ul><li><p>ç¯ç»•é€šçŸ¥æ˜¯<strong>åœ¨åŸå§‹æ–¹æ³•çš„å‰åæ·»åŠ åŠŸèƒ½</strong>ï¼Œåœ¨ç¯ç»•é€šçŸ¥ä¸­ï¼Œå­˜åœ¨å¯¹åŸå§‹æ–¹æ³•çš„æ˜¾å¼è°ƒç”¨</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">around</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> ret <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>ç¯ç»•é€šçŸ¥æ–¹æ³•ç›¸å…³è¯´æ˜ï¼š</p><ul><li><p>æ–¹æ³•é¡»è®¾å®š Object ç±»å‹çš„è¿”å›å€¼ï¼Œå¦åˆ™ä¼š<strong>æ‹¦æˆª</strong>åŸå§‹æ–¹æ³•çš„è¿”å›ã€‚å¦‚æœåŸå§‹æ–¹æ³•è¿”å›å€¼ç±»å‹ä¸º voidï¼Œé€šçŸ¥æ–¹æ³•ä¹Ÿå¯ä»¥è®¾å®šè¿”å›å€¼ç±»å‹ä¸º voidï¼Œæœ€ç»ˆè¿”å› null</p></li><li><p>æ–¹æ³•éœ€åœ¨ç¬¬ä¸€ä¸ªå‚æ•°ä½ç½®è®¾å®š ProceedingJoinPoint å¯¹è±¡ï¼Œé€šè¿‡è¯¥å¯¹è±¡è°ƒç”¨ proceed() æ–¹æ³•ï¼Œå®ç°<strong>å¯¹åŸå§‹æ–¹æ³•çš„è°ƒç”¨</strong>ã€‚å¦‚çœç•¥è¯¥å‚æ•°ï¼ŒåŸå§‹æ–¹æ³•å°†æ— æ³•æ‰§è¡Œ</p></li><li><p>ä½¿ç”¨ proceed() æ–¹æ³•è°ƒç”¨åŸå§‹æ–¹æ³•æ—¶ï¼Œå› æ— æ³•é¢„çŸ¥åŸå§‹æ–¹æ³•è¿è¡Œè¿‡ç¨‹ä¸­æ˜¯å¦ä¼šå‡ºç°å¼‚å¸¸ï¼Œå¼ºåˆ¶æŠ›å‡º Throwable å¯¹è±¡ï¼Œå°è£…åŸå§‹æ–¹æ³•ä¸­å¯èƒ½å‡ºç°çš„å¼‚å¸¸ä¿¡æ¯</p></li></ul></li></ul><hr><h5 id="é€šçŸ¥é¡ºåº" tabindex="-1"><a class="header-anchor" href="#é€šçŸ¥é¡ºåº" aria-hidden="true">#</a> é€šçŸ¥é¡ºåº</h5><p>å½“åŒä¸€ä¸ªåˆ‡å…¥ç‚¹é…ç½®äº†å¤šä¸ªé€šçŸ¥æ—¶ï¼Œé€šçŸ¥ä¼šå­˜åœ¨è¿è¡Œçš„å…ˆåé¡ºåºï¼Œè¯¥é¡ºåºä»¥é€šçŸ¥é…ç½®çš„é¡ºåºä¸ºå‡†ã€‚</p><ul><li><p>AOPAdvice</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AOPAdvice</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>&quot;before<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;after...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterReturing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;afterReturing...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterThrowing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;afterThrowing...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">around</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;around before...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       	<span class="token comment">//å¯¹åŸå§‹æ–¹æ³•çš„è°ƒç”¨</span>
        <span class="token class-name">Object</span> ret <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;around after...&quot;</span><span class="token operator">+</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
   	    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>applicationContext.xml <strong>é¡ºåºæ‰§è¡Œ</strong></p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* *..*(..))<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myAdvice<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>before</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>before<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>after</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>after<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>after-returning</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>afterReturing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>after-throwing</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>afterThrowing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>around</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>around<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h5 id="è·å–æ•°æ®" tabindex="-1"><a class="header-anchor" href="#è·å–æ•°æ®" aria-hidden="true">#</a> è·å–æ•°æ®</h5><h6 id="å‚æ•°" tabindex="-1"><a class="header-anchor" href="#å‚æ•°" aria-hidden="true">#</a> å‚æ•°</h6><p>ç¬¬ä¸€ç§æ–¹å¼ï¼š</p><ul><li><p>è®¾å®šé€šçŸ¥æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°ä¸º JoinPointï¼Œé€šè¿‡è¯¥å¯¹è±¡è°ƒç”¨ getArgs() æ–¹æ³•ï¼Œè·å–åŸå§‹æ–¹æ³•è¿è¡Œçš„å‚æ•°æ•°ç»„</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> jp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> jp<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æ‰€æœ‰çš„é€šçŸ¥å‡å¯ä»¥è·å–å‚æ•°ï¼Œç¯ç»•é€šçŸ¥ä½¿ç”¨ProceedingJoinPoint.getArgs()æ–¹æ³•</p></li></ul><p>ç¬¬äºŒç§æ–¹å¼ï¼š</p><ul><li><p>è®¾å®šåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ä¸ºé€šçŸ¥æ–¹æ³•ä¼ é€’å‚æ•°ï¼ˆé”å®šé€šçŸ¥å˜é‡åï¼‰</p></li><li><p>æµç¨‹å›¾ï¼š<img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/AOPé€šçŸ¥è·å–å‚æ•°æ–¹å¼äºŒ.png" alt="" loading="lazy"></p></li><li><p>è§£é‡Šï¼š</p><ul><li><code>&amp;amp</code> ä»£è¡¨å¹¶ä¸” &amp;</li><li>è¾“å‡ºç»“æœï¼ša = param1 b = param2</li></ul></li></ul><p>ç¬¬ä¸‰ç§æ–¹å¼ï¼š</p><ul><li><p>è®¾å®šåˆ‡å…¥ç‚¹è¡¨è¾¾å¼ä¸ºé€šçŸ¥æ–¹æ³•ä¼ é€’å‚æ•°ï¼ˆæ”¹å˜é€šçŸ¥å˜é‡åçš„å®šä¹‰é¡ºåºï¼‰</p></li><li><p>æµç¨‹å›¾ï¼š<img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/AOPé€šçŸ¥è·å–å‚æ•°æ–¹å¼ä¸‰.png" alt="" loading="lazy"></p></li><li><p>è§£é‡Šï¼šè¾“å‡ºç»“æœ a = param2 b = param1</p></li></ul><hr><h6 id="è¿”å›å€¼" tabindex="-1"><a class="header-anchor" href="#è¿”å›å€¼" aria-hidden="true">#</a> è¿”å›å€¼</h6><p>ç¯ç»•é€šçŸ¥å’Œè¿”å›åé€šçŸ¥å¯ä»¥è·å–è¿”å›å€¼ï¼Œåç½®é€šçŸ¥ä¸ä¸€å®šï¼Œå…¶ä»–ç±»å‹è·å–ä¸åˆ°</p><p>ç¬¬ä¸€ç§æ–¹å¼ï¼šé€‚ç”¨äºè¿”å›åé€šçŸ¥ï¼ˆafter-returningï¼‰</p><ul><li><p>è®¾å®šè¿”å›å€¼å˜é‡å</p></li><li><p>åŸå§‹æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user service running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>AOP é…ç½®ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myAdvice<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* *(..))<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>after-returning</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>afterReturning<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span> <span class="token attr-name">returning</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ret<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>é€šçŸ¥ç±»ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AOPAdvice</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterReturning</span><span class="token punctuation">(</span><span class="token class-name">Object</span> ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;return:&quot;</span> <span class="token operator">+</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>ç¬¬äºŒç§ï¼šé€‚ç”¨äºç¯ç»•é€šçŸ¥ï¼ˆaroundï¼‰</p><ul><li><p>åœ¨é€šçŸ¥ç±»çš„æ–¹æ³•ä¸­è°ƒç”¨åŸå§‹æ–¹æ³•è·å–è¿”å›å€¼</p></li><li><p>åŸå§‹æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user service running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>AOP é…ç½®ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myAdvice<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* *(..))  <span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>around</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>around<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>é€šçŸ¥ç±»ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AOPAdvice</span> <span class="token punctuation">{</span>    
	<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">around</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> ret <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æµ‹è¯•ç±»ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ApplicationContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">&quot;applicationContext.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> ret <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       	<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;app.....&quot;</span> <span class="token operator">+</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h6 id="å¼‚å¸¸" tabindex="-1"><a class="header-anchor" href="#å¼‚å¸¸" aria-hidden="true">#</a> å¼‚å¸¸</h6><p>ç¯ç»•é€šçŸ¥å’ŒæŠ›å‡ºå¼‚å¸¸åé€šçŸ¥å¯ä»¥è·å–å¼‚å¸¸ï¼Œåç½®é€šçŸ¥ä¸ä¸€å®šï¼Œå…¶ä»–ç±»å‹è·å–ä¸åˆ°</p><p>ç¬¬ä¸€ç§ï¼šé€‚ç”¨äºè¿”å›åé€šçŸ¥ï¼ˆafter-throwingï¼‰</p><ul><li><p>è®¾å®šå¼‚å¸¸å¯¹è±¡å˜é‡å</p></li><li><p>åŸå§‹æ–¹æ³•</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user service running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>AOP é…ç½®</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myAdvice<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* *(..))  <span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>after-throwing</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>afterThrowing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span> <span class="token attr-name">throwing</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>t<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>é€šçŸ¥ç±»</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterThrowing</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p>ç¬¬äºŒç§ï¼šé€‚ç”¨äºç¯ç»•é€šçŸ¥ï¼ˆaroundï¼‰</p><ul><li>åœ¨é€šçŸ¥ç±»çš„æ–¹æ³•ä¸­è°ƒç”¨åŸå§‹æ–¹æ³•æ•è·å¼‚å¸¸</li></ul><ul><li><p>åŸå§‹æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user service running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>AOP é…ç½®ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myAdvice<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* *(..))  <span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>around</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>around<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>é€šçŸ¥ç±»ï¼štryâ€¦â€¦catchâ€¦â€¦æ•è·å¼‚å¸¸åï¼Œretä¸ºnull</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">around</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> ret <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//å¯¹æ­¤å¤„è°ƒç”¨è¿›è¡Œtryâ€¦â€¦catchâ€¦â€¦æ•è·å¼‚å¸¸ï¼Œæˆ–æŠ›å‡ºå¼‚å¸¸</span>
    <span class="token comment">/* try {
            ret = pjp.proceed();
        } catch (Throwable throwable) {
            System.out.println(&quot;around exception...&quot; + throwable.getMessage());
        }*/</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><ul><li><p>æµ‹è¯•ç±»</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>userService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><hr><h6 id="è·å–å…¨éƒ¨" tabindex="-1"><a class="header-anchor" href="#è·å–å…¨éƒ¨" aria-hidden="true">#</a> è·å–å…¨éƒ¨</h6><ul><li><p>UserService</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user service running...&quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user service update running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;user service delete running...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>AOPAdvice</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AOPAdvice</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> jp<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//é€šè¿‡JoinPointå‚æ•°è·å–è°ƒç”¨åŸå§‹æ–¹æ³•æ‰€æºå¸¦çš„å‚æ•°</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> jp<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;before...&quot;</span><span class="token operator">+</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> jp<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> jp<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;after...&quot;</span><span class="token operator">+</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterReturing</span><span class="token punctuation">(</span><span class="token class-name">Object</span> ret<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;afterReturing...&quot;</span><span class="token operator">+</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterThrowing</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;afterThrowing...&quot;</span><span class="token operator">+</span>t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">around</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;around before...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> ret <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//å¯¹åŸå§‹æ–¹æ³•çš„è°ƒç”¨</span>
            ret <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;around...exception....&quot;</span><span class="token operator">+</span>throwable<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;around after...&quot;</span><span class="token operator">+</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>applicationContext.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/beans<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/context<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>aop</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.springframework.org/schema/aop<span class="token punctuation">&quot;</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>
        http://www.springframework.org/schema/beans
        https://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        https://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/aop
        https://www.springframework.org/schema/aop/spring-aop.xsd
        <span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>userService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>service.impl.UserServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aop.AOPAdvice<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* *..*(..))<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>myAdvice<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>before</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>before<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>around</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>around<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>after</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>after<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>after-returning</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>afterReturning<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span> <span class="token attr-name">returning</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ret<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>after-throwing</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>afterThrowing<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span> <span class="token attr-name">throwing</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>t<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æµ‹è¯•ç±»</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ApplicationContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">&quot;applicationContext.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        userService.save(666, 888);</span>
<span class="token comment">//        int ret = userService.update();</span>
<span class="token comment">//        System.out.println(&quot;app.....&quot; + ret);</span>
        userService<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h3 id="æ³¨è§£å¼€å‘-1" tabindex="-1"><a class="header-anchor" href="#æ³¨è§£å¼€å‘-1" aria-hidden="true">#</a> æ³¨è§£å¼€å‘</h3><h4 id="aopæ³¨è§£" tabindex="-1"><a class="header-anchor" href="#aopæ³¨è§£" aria-hidden="true">#</a> AOPæ³¨è§£</h4><p>AOP æ³¨è§£ç®€åŒ– XMLï¼š</p><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/AOPæ³¨è§£å¼€å‘.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>æ³¨æ„äº‹é¡¹ï¼š</p><ol><li><p>åˆ‡å…¥ç‚¹æœ€ç»ˆä½“ç°ä¸ºä¸€ä¸ªæ–¹æ³•ï¼Œæ— å‚æ— è¿”å›å€¼ï¼Œæ— å®é™…æ–¹æ³•ä½“å†…å®¹ï¼Œä½†ä¸èƒ½æ˜¯æŠ½è±¡æ–¹æ³•</p></li><li><p>å¼•ç”¨åˆ‡å…¥ç‚¹æ—¶å¿…é¡»ä½¿ç”¨æ–¹æ³•è°ƒç”¨åç§°ï¼Œæ–¹æ³•åé¢çš„ () ä¸èƒ½çœç•¥</p></li><li><p>åˆ‡é¢ç±»ä¸­å®šä¹‰çš„åˆ‡å…¥ç‚¹åªèƒ½åœ¨å½“å‰ç±»ä¸­ä½¿ç”¨ï¼Œå¦‚æœæƒ³å¼•ç”¨å…¶ä»–ç±»ä¸­å®šä¹‰çš„åˆ‡å…¥ç‚¹ä½¿ç”¨â€œç±»å.æ–¹æ³•å()â€å¼•ç”¨</p></li><li><p>å¯ä»¥åœ¨é€šçŸ¥ç±»å‹æ³¨è§£åæ·»åŠ å‚æ•°ï¼Œå®ç° XML é…ç½®ä¸­çš„å±æ€§ï¼Œä¾‹å¦‚ after-returning åçš„ returning æ€§</p></li></ol><hr><h4 id="å¯åŠ¨æ³¨è§£" tabindex="-1"><a class="header-anchor" href="#å¯åŠ¨æ³¨è§£" aria-hidden="true">#</a> å¯åŠ¨æ³¨è§£</h4><h5 id="xml-1" tabindex="-1"><a class="header-anchor" href="#xml-1" aria-hidden="true">#</a> XML</h5><p>å¼€å¯ AOP æ³¨è§£æ”¯æŒï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspectj-autoproxy</span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aop,config,service<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span><span class="token comment">&lt;!--å¯åŠ¨Springæ‰«æ--&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å¼€å‘æ­¥éª¤ï¼š</p><ol><li>å¯¼å…¥åæ ‡ï¼ˆä¼´éš spring-context åæ ‡å¯¼å…¥å·²ç»ä¾èµ–å¯¼å…¥å®Œæˆï¼‰</li><li>å¼€å¯ AOP æ³¨è§£æ”¯æŒ</li><li>é…ç½®åˆ‡é¢ @Aspect</li><li>å®šä¹‰ä¸“ç”¨çš„åˆ‡å…¥ç‚¹æ–¹æ³•ï¼Œå¹¶é…ç½®åˆ‡å…¥ç‚¹ @Pointcut</li><li>ä¸ºé€šçŸ¥æ–¹æ³•é…ç½®é€šçŸ¥ç±»å‹åŠå¯¹åº”åˆ‡å…¥ç‚¹ @Before</li></ol><h5 id="çº¯æ³¨è§£-1" tabindex="-1"><a class="header-anchor" href="#çº¯æ³¨è§£-1" aria-hidden="true">#</a> çº¯æ³¨è§£</h5><p>æ³¨è§£ï¼š@EnableAspectJAutoProxy</p><p>ä½ç½®ï¼šSpring æ³¨è§£é…ç½®ç±»å®šä¹‰ä¸Šæ–¹</p><p>ä½œç”¨ï¼šè®¾ç½®å½“å‰ç±»å¼€å¯ AOP æ³¨è§£é©±åŠ¨çš„æ”¯æŒï¼ŒåŠ è½½ AOP æ³¨è§£</p><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span><span class="token string">&quot;com.seazean&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableAspectJAutoProxy</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringConfig</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="åŸºæœ¬æ³¨è§£-1" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ³¨è§£-1" aria-hidden="true">#</a> åŸºæœ¬æ³¨è§£</h4><h5 id="aspect-1" tabindex="-1"><a class="header-anchor" href="#aspect-1" aria-hidden="true">#</a> Aspect</h5><p>æ³¨è§£ï¼š@Aspect</p><p>ä½ç½®ï¼šç±»å®šä¹‰ä¸Šæ–¹</p><p>ä½œç”¨ï¼šè®¾ç½®å½“å‰ç±»ä¸ºåˆ‡é¢ç±»</p><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Aspect</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AopAdvice</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="pointcut-2" tabindex="-1"><a class="header-anchor" href="#pointcut-2" aria-hidden="true">#</a> Pointcut</h5><p>æ³¨è§£ï¼š@Pointcut</p><p>ä½ç½®ï¼šæ–¹æ³•å®šä¹‰ä¸Šæ–¹</p><p>ä½œç”¨ï¼šä½¿ç”¨å½“å‰æ–¹æ³•åä½œä¸ºåˆ‡å…¥ç‚¹å¼•ç”¨åç§°</p><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">&quot;execution(* *(..))&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼šè¢«ä¿®é¥°çš„æ–¹æ³•å¿½ç•¥å…¶ä¸šåŠ¡åŠŸèƒ½ï¼Œæ ¼å¼è®¾å®šä¸ºæ— å‚æ— è¿”å›å€¼çš„æ–¹æ³•ï¼Œæ–¹æ³•ä½“å†…ç©ºå®ç°ï¼ˆéæŠ½è±¡ï¼‰</p><h5 id="before-1" tabindex="-1"><a class="header-anchor" href="#before-1" aria-hidden="true">#</a> Before</h5><p>æ³¨è§£ï¼š@Before</p><p>ä½ç½®ï¼šæ–¹æ³•å®šä¹‰ä¸Šæ–¹</p><p>ä½œç”¨ï¼šæ ‡æ³¨å½“å‰æ–¹æ³•ä½œä¸ºå‰ç½®é€šçŸ¥</p><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;pt()&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//joinPoint.getArgs();</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„ï¼š<strong>å¤šä¸ªå‚æ•°æ—¶ï¼ŒJoinPointå‚æ•°ä¸€å®šè¦åœ¨ç¬¬ä¸€ä½</strong></p><h5 id="after-1" tabindex="-1"><a class="header-anchor" href="#after-1" aria-hidden="true">#</a> After</h5><p>æ³¨è§£ï¼š@After</p><p>ä½ç½®ï¼šæ–¹æ³•å®šä¹‰ä¸Šæ–¹</p><p>ä½œç”¨ï¼šæ ‡æ³¨å½“å‰æ–¹æ³•ä½œä¸ºåç½®é€šçŸ¥</p><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@After</span><span class="token punctuation">(</span><span class="token string">&quot;pt()&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">after</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="afterr" tabindex="-1"><a class="header-anchor" href="#afterr" aria-hidden="true">#</a> AfterR</h5><p>æ³¨è§£ï¼š@AfterReturning</p><p>ä½ç½®ï¼šæ–¹æ³•å®šä¹‰ä¸Šæ–¹</p><p>ä½œç”¨ï¼šæ ‡æ³¨å½“å‰æ–¹æ³•ä½œä¸ºè¿”å›åé€šçŸ¥</p><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@AfterReturning</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">&quot;pt()&quot;</span><span class="token punctuation">,</span> returning <span class="token operator">=</span> <span class="token string">&quot;result&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterReturning</span><span class="token punctuation">(</span><span class="token class-name">Object</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç‰¹æ®Šå‚æ•°ï¼š</p><ul><li>returning ï¼šè®¾å®šä½¿ç”¨é€šçŸ¥æ–¹æ³•å‚æ•°<strong>æ¥æ”¶</strong>è¿”å›å€¼çš„å˜é‡å</li></ul><h5 id="aftert" tabindex="-1"><a class="header-anchor" href="#aftert" aria-hidden="true">#</a> AfterT</h5><p>æ³¨è§£ï¼š@AfterThrowing</p><p>ä½ç½®ï¼šæ–¹æ³•å®šä¹‰ä¸Šæ–¹</p><p>ä½œç”¨ï¼šæ ‡æ³¨å½“å‰æ–¹æ³•ä½œä¸ºå¼‚å¸¸åé€šçŸ¥</p><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@AfterThrowing</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">&quot;pt()&quot;</span><span class="token punctuation">,</span> throwing <span class="token operator">=</span> <span class="token string">&quot;t&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterThrowing</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç‰¹æ®Šå‚æ•°ï¼š</p><ul><li>throwing ï¼šè®¾å®šä½¿ç”¨é€šçŸ¥æ–¹æ³•å‚æ•°æ¥æ”¶åŸå§‹æ–¹æ³•ä¸­æŠ›å‡ºçš„å¼‚å¸¸å¯¹è±¡å</li></ul><h5 id="around-1" tabindex="-1"><a class="header-anchor" href="#around-1" aria-hidden="true">#</a> Around</h5><p>æ³¨è§£ï¼š@Around</p><p>ä½ç½®ï¼šæ–¹æ³•å®šä¹‰ä¸Šæ–¹</p><p>ä½œç”¨ï¼šæ ‡æ³¨å½“å‰æ–¹æ³•ä½œä¸ºç¯ç»•é€šçŸ¥</p><p>æ ¼å¼ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;pt()&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">around</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> ret <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="æ‰§è¡Œé¡ºåº" tabindex="-1"><a class="header-anchor" href="#æ‰§è¡Œé¡ºåº" aria-hidden="true">#</a> æ‰§è¡Œé¡ºåº</h4><p>AOP ä½¿ç”¨ XML é…ç½®æƒ…å†µä¸‹ï¼Œé€šçŸ¥çš„æ‰§è¡Œé¡ºåºç”±é…ç½®é¡ºåºå†³å®šï¼Œåœ¨æ³¨è§£æƒ…å†µä¸‹ç”±äºä¸å­˜åœ¨é…ç½®é¡ºåºçš„æ¦‚å¿µï¼Œå‚ç…§é€šçŸ¥æ‰€é…ç½®çš„<strong>æ–¹æ³•åå­—ç¬¦ä¸²å¯¹åº”çš„ç¼–ç å€¼é¡ºåº</strong>ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºå­—æ¯æ’åº</p><ul><li><p>åŒä¸€ä¸ªé€šçŸ¥ç±»ä¸­ï¼Œç›¸åŒé€šçŸ¥ç±»å‹ä»¥æ–¹æ³•åæ’åºä¸ºå‡†</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;aop.AOPPointcut.pt()&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">aop001Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;aop.AOPPointcut.pt()&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">aop002Exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>ä¸åŒé€šçŸ¥ç±»ä¸­ï¼Œä»¥ç±»åæ’åºä¸ºå‡†</p></li><li><p>ä½¿ç”¨ @Order æ³¨è§£é€šè¿‡å˜æ›´ bean çš„åŠ è½½é¡ºåºæ”¹å˜é€šçŸ¥çš„åŠ è½½é¡ºåº</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">//å…ˆæ‰§è¡Œ</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AOPAdvice2</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AOPAdvice1</span> <span class="token punctuation">{</span><span class="token comment">//é»˜è®¤æ‰§è¡Œæ­¤é€šçŸ¥</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h3 id="aop-åŸç†" tabindex="-1"><a class="header-anchor" href="#aop-åŸç†" aria-hidden="true">#</a> AOP åŸç†</h3><h4 id="é™æ€ä»£ç†" tabindex="-1"><a class="header-anchor" href="#é™æ€ä»£ç†" aria-hidden="true">#</a> é™æ€ä»£ç†</h4><p>è£…é¥°è€…æ¨¡å¼ï¼ˆDecorator Patternï¼‰ï¼šåœ¨ä¸æƒŠåŠ¨åŸå§‹è®¾è®¡çš„åŸºç¡€ä¸Šï¼Œä¸ºå…¶æ·»åŠ åŠŸèƒ½</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceDecorator</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">UserServiceDecorator</span><span class="token punctuation">(</span><span class="token class-name">UserService</span> userService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userService <span class="token operator">=</span> userService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//åŸå§‹è°ƒç”¨</span>
        userService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//å¢å¼ºåŠŸèƒ½ï¼ˆåç½®ï¼‰</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;åç½®å¢å¼ºåŠŸèƒ½&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="proxy" tabindex="-1"><a class="header-anchor" href="#proxy" aria-hidden="true">#</a> Proxy</h4><p>JDKProxy åŠ¨æ€ä»£ç†æ˜¯é’ˆå¯¹å¯¹è±¡åšä»£ç†ï¼Œè¦æ±‚åŸå§‹å¯¹è±¡å…·æœ‰æ¥å£å®ç°ï¼Œå¹¶å¯¹æ¥å£æ–¹æ³•è¿›è¡Œå¢å¼ºï¼Œå› ä¸º<strong>ä»£ç†ç±»ç»§æ‰¿Proxy</strong></p><p>é™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†çš„åŒºåˆ«ï¼š</p><ul><li>é™æ€ä»£ç†æ˜¯åœ¨ç¼–è¯‘æ—¶å°±å·²ç»å°†æ¥å£ã€ä»£ç†ç±»ã€è¢«ä»£ç†ç±»çš„å­—èŠ‚ç æ–‡ä»¶ç¡®å®šä¸‹æ¥</li><li>åŠ¨æ€ä»£ç†æ˜¯ç¨‹åºåœ¨è¿è¡Œåé€šè¿‡åå°„åˆ›å»ºå­—èŠ‚ç æ–‡ä»¶äº¤ç”± JVM åŠ è½½</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceJDKProxy</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">UserService</span> <span class="token function">createUserServiceJDKProxy</span><span class="token punctuation">(</span><span class="token class-name">UserService</span> userService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">UserService</span> service <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>
            userService<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//è·å–è¢«ä»£ç†å¯¹è±¡çš„ç±»åŠ è½½å™¨</span>
            userService<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token comment">//è·å–è¢«ä»£ç†å¯¹è±¡å®ç°çš„æ¥å£</span>
            <span class="token keyword">new</span> <span class="token class-name">InvocationHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>				<span class="token comment">//å¯¹åŸå§‹æ–¹æ³•æ‰§è¡Œè¿›è¡Œæ‹¦æˆªå¹¶å¢å¼º</span>
				<span class="token annotation punctuation">@Override</span>
				<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;save&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å‰ç½®å¢å¼º&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Object</span> ret <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>userService<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;åç½®å¢å¼º&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
 			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> service<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="cglib" tabindex="-1"><a class="header-anchor" href="#cglib" aria-hidden="true">#</a> CGLIB</h4><p>CGLIBï¼ˆCode Generation Libraryï¼‰ï¼šCode ç”Ÿæˆç±»åº“</p><p>CGLIB ç‰¹ç‚¹ï¼š</p><ul><li>CGLIB åŠ¨æ€ä»£ç†<strong>ä¸é™å®š</strong>æ˜¯å¦å…·æœ‰æ¥å£ï¼Œå¯ä»¥å¯¹ä»»æ„æ“ä½œè¿›è¡Œå¢å¼º</li><li>CGLIB åŠ¨æ€ä»£ç†æ— éœ€è¦åŸå§‹è¢«ä»£ç†å¯¹è±¡ï¼ŒåŠ¨æ€åˆ›å»ºå‡ºæ–°çš„ä»£ç†å¯¹è±¡</li><li>CGLIB <strong>ç»§æ‰¿è¢«ä»£ç†ç±»</strong>ï¼Œå¦‚æœä»£ç†ç±»æ˜¯ final åˆ™ä¸èƒ½å®ç°</li></ul><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/AOPåº•å±‚åŸç†-cglib.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><ul><li><p>CGLIB ç±»</p><ul><li>JDKProxy ä»…å¯¹æ¥å£æ–¹æ³•åšå¢å¼ºï¼ŒCGLIB å¯¹æ‰€æœ‰æ–¹æ³•åšå¢å¼ºï¼ŒåŒ…æ‹¬ Object ç±»ä¸­çš„æ–¹æ³•ï¼ˆtoStringã€hashCodeï¼‰</li><li>è¿”å›å€¼ç±»å‹é‡‡ç”¨å¤šæ€å‘ä¸‹è½¬å‹ï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®çˆ¶ç±»ç±»å‹</li></ul><p>éœ€è¦å¯¹æ–¹æ³•è¿›è¡Œåˆ¤æ–­æ˜¯å¦æ˜¯ saveï¼Œæ¥é€‰æ‹©æ€§å¢å¼º</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImplCglibProxy</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">UserService</span> <span class="token function">createUserServiceCglibProxy</span><span class="token punctuation">(</span><span class="token class-name">Class</span> cls<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">//1.åˆ›å»ºEnhancerå¯¹è±¡ï¼ˆå¯ä»¥ç†è§£ä¸ºå†…å­˜ä¸­åŠ¨æ€åˆ›å»ºäº†ä¸€ä¸ªç±»çš„å­—èŠ‚ç ï¼‰</span>
        <span class="token class-name">Enhancer</span> enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//2.è®¾ç½®Enhancerå¯¹è±¡çš„çˆ¶ç±»æ˜¯æŒ‡å®šç±»å‹UserServerImpl</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setSuperclass</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//3.è®¾ç½®å›è°ƒæ–¹æ³•</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MethodInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token class-name">Method</span> m<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token class-name">MethodProxy</span> mp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
                <span class="token comment">//oæ˜¯è¢«ä»£ç†å‡ºçš„ç±»åˆ›å»ºçš„å¯¹è±¡ï¼Œæ‰€ä»¥ä½¿ç”¨MethodProxyè°ƒç”¨ï¼Œå¹¶ä¸”æ˜¯è°ƒç”¨çˆ¶ç±»</span>
                <span class="token comment">//é€šè¿‡è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•å®ç°å¯¹åŸå§‹æ–¹æ³•çš„è°ƒç”¨</span>
                <span class="token class-name">Object</span> ret <span class="token operator">=</span> methodProxy<span class="token punctuation">.</span><span class="token function">invokeSuper</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//åç½®å¢å¼ºå†…å®¹,éœ€è¦åˆ¤æ–­æ˜¯éƒ½æ˜¯saveæ–¹æ³•</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;save&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;I love Java&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ä½¿ç”¨Enhancerå¯¹è±¡åˆ›å»ºå¯¹åº”çš„å¯¹è±¡</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span>enhancer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>Testç±»</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token class-name">UserServiceCglibProxy</span><span class="token punctuation">.</span><span class="token function">createUserServiceCglibProxy</span><span class="token punctuation">(</span><span class="token class-name">UserServiceImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userService<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h4 id="ä»£ç†é€‰æ‹©" tabindex="-1"><a class="header-anchor" href="#ä»£ç†é€‰æ‹©" aria-hidden="true">#</a> ä»£ç†é€‰æ‹©</h4><p>Spirng å¯ä»¥é€šè¿‡é…ç½®çš„å½¢å¼æ§åˆ¶ä½¿ç”¨çš„ä»£ç†å½¢å¼ï¼ŒSpring ä¼šå…ˆåˆ¤æ–­æ˜¯å¦å®ç°äº†æ¥å£ï¼Œå¦‚æœå®ç°äº†æ¥å£å°±ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ï¼Œå¦‚æœæ²¡æœ‰å®ç°æ¥å£åˆ™ä½¿ç”¨ CGLIB åŠ¨æ€ä»£ç†ï¼Œé€šè¿‡é…ç½®å¯ä»¥ä¿®æ”¹ä¸ºä½¿ç”¨ CGLIB</p><ul><li><p>XML é…ç½®</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--XMLé…ç½®AOP--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span> <span class="token attr-name">proxy-target-class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>XML æ³¨è§£æ”¯æŒ</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--æ³¨è§£é…ç½®AOP--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspectj-autoproxy</span> <span class="token attr-name">proxy-target-class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æ³¨è§£é©±åŠ¨</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//ä¿®æ”¹ä¸ºä½¿ç”¨ cglib åˆ›å»ºä»£ç†å¯¹è±¡</span>
<span class="token annotation punctuation">@EnableAspectJAutoProxy</span><span class="token punctuation">(</span>proxyTargetClass <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><ul><li><p>JDK åŠ¨æ€ä»£ç†å’Œ CGLIB åŠ¨æ€ä»£ç†çš„åŒºåˆ«ï¼š</p><ul><li>JDK åŠ¨æ€ä»£ç†åªèƒ½å¯¹å®ç°äº†æ¥å£çš„ç±»ç”Ÿæˆä»£ç†ï¼Œæ²¡æœ‰å®ç°æ¥å£çš„ç±»ä¸èƒ½ä½¿ç”¨ã€‚</li><li>CGLIB åŠ¨æ€ä»£ç†å³ä½¿è¢«ä»£ç†çš„ç±»æ²¡æœ‰å®ç°æ¥å£ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œå› ä¸º CGLIB åŠ¨æ€ä»£ç†æ˜¯ä½¿ç”¨ç»§æ‰¿è¢«ä»£ç†ç±»çš„æ–¹å¼è¿›è¡Œæ‰©å±•</li><li>CGLIB åŠ¨æ€ä»£ç†æ˜¯é€šè¿‡ç»§æ‰¿çš„æ–¹å¼ï¼Œè¦†ç›–è¢«ä»£ç†ç±»çš„æ–¹æ³•æ¥è¿›è¡Œä»£ç†ï¼Œæ‰€ä»¥å¦‚æœæ–¹æ³•æ˜¯è¢« final ä¿®é¥°çš„è¯ï¼Œå°±ä¸èƒ½è¿›è¡Œä»£ç†</li></ul></li></ul><hr><h4 id="ç»‡å…¥æ—¶æœº" tabindex="-1"><a class="header-anchor" href="#ç»‡å…¥æ—¶æœº" aria-hidden="true">#</a> ç»‡å…¥æ—¶æœº</h4><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/AOPç»‡å…¥æ—¶æœº.png" alt="AOPç»‡å…¥æ—¶æœº" tabindex="0" loading="lazy"><figcaption>AOPç»‡å…¥æ—¶æœº</figcaption></figure><hr><h2 id="äº‹åŠ¡" tabindex="-1"><a class="header-anchor" href="#äº‹åŠ¡" aria-hidden="true">#</a> äº‹åŠ¡</h2><h3 id="äº‹åŠ¡æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#äº‹åŠ¡æœºåˆ¶" aria-hidden="true">#</a> äº‹åŠ¡æœºåˆ¶</h3><h4 id="äº‹åŠ¡ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#äº‹åŠ¡ä»‹ç»" aria-hidden="true">#</a> äº‹åŠ¡ä»‹ç»</h4><p>äº‹åŠ¡ï¼šæ•°æ®åº“ä¸­å¤šä¸ªæ“ä½œåˆå¹¶åœ¨ä¸€èµ·å½¢æˆçš„æ“ä½œåºåˆ—ï¼Œäº‹åŠ¡ç‰¹å¾ï¼ˆACIDï¼‰</p><p>ä½œç”¨ï¼š</p><ul><li>å½“æ•°æ®åº“æ“ä½œåºåˆ—ä¸­ä¸ªåˆ«æ“ä½œå¤±è´¥æ—¶ï¼Œæä¾›ä¸€ç§æ–¹å¼ä½¿æ•°æ®åº“çŠ¶æ€æ¢å¤åˆ°æ­£å¸¸çŠ¶æ€ï¼ˆ<strong>A</strong>ï¼‰ï¼Œä¿éšœæ•°æ®åº“å³ä½¿åœ¨å¼‚å¸¸çŠ¶æ€ä¸‹ä»èƒ½ä¿æŒæ•°æ®ä¸€è‡´æ€§ï¼ˆ<strong>C</strong>ï¼‰ï¼ˆè¦ä¹ˆæ“ä½œå‰çŠ¶æ€ï¼Œè¦ä¹ˆæ“ä½œåçŠ¶æ€ï¼‰</li><li>å½“å‡ºç°å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œåœ¨å¤šä¸ªè®¿é—®é—´è¿›è¡Œç›¸äº’éš”ç¦»ï¼Œé˜²æ­¢å¹¶å‘è®¿é—®æ“ä½œç»“æœäº’ç›¸å¹²æ‰°ï¼ˆ<strong>I</strong>ï¼‰</li></ul><p>Spring äº‹åŠ¡ä¸€èˆ¬åŠ åˆ°ä¸šåŠ¡å±‚ï¼Œå¯¹åº”ç€ä¸šåŠ¡çš„æ“ä½œï¼ŒSpring äº‹åŠ¡çš„æœ¬è´¨å…¶å®å°±æ˜¯æ•°æ®åº“å¯¹äº‹åŠ¡çš„æ”¯æŒï¼Œæ²¡æœ‰æ•°æ®åº“çš„äº‹åŠ¡æ”¯æŒï¼ŒSpring æ˜¯æ— æ³•æä¾›äº‹åŠ¡åŠŸèƒ½çš„ï¼ŒSpring åªæä¾›ç»Ÿä¸€äº‹åŠ¡ç®¡ç†æ¥å£</p><p>Spring åœ¨äº‹åŠ¡å¼€å§‹æ—¶ï¼Œæ ¹æ®å½“å‰ç¯å¢ƒä¸­è®¾ç½®çš„éš”ç¦»çº§åˆ«ï¼Œè°ƒæ•´æ•°æ®åº“éš”ç¦»çº§åˆ«ï¼Œç”±æ­¤ä¿æŒä¸€è‡´ã€‚ç¨‹åºæ˜¯å¦æ”¯æŒäº‹åŠ¡é¦–å…ˆå–å†³äºæ•°æ®åº“ ï¼Œæ¯”å¦‚ MySQL ï¼Œå¦‚æœæ˜¯ <strong>Innodb å¼•æ“</strong>ï¼Œæ˜¯æ”¯æŒäº‹åŠ¡çš„ï¼›å¦‚æœ MySQL ä½¿ç”¨ MyISAM å¼•æ“ï¼Œé‚£ä»æ ¹ä¸Šå°±æ˜¯ä¸æ”¯æŒäº‹åŠ¡çš„</p><p><strong>ä¿è¯åŸå­æ€§</strong>ï¼š</p><ul><li>è¦ä¿è¯äº‹åŠ¡çš„åŸå­æ€§ï¼Œå°±éœ€è¦åœ¨å¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œå¯¹å·²ç»æ‰§è¡Œçš„æ“ä½œè¿›è¡Œ<strong>å›æ»š</strong></li><li>åœ¨ MySQL ä¸­ï¼Œæ¢å¤æœºåˆ¶æ˜¯é€šè¿‡<strong>å›æ»šæ—¥å¿—ï¼ˆundo logï¼‰</strong> å®ç°ï¼Œæ‰€æœ‰äº‹åŠ¡è¿›è¡Œçš„ä¿®æ”¹éƒ½ä¼šå…ˆå…ˆè®°å½•åˆ°è¿™ä¸ªå›æ»šæ—¥å¿—ä¸­ï¼Œç„¶åå†æ‰§è¡Œç›¸å…³çš„æ“ä½œã€‚å¦‚æœæ‰§è¡Œè¿‡ç¨‹ä¸­é‡åˆ°å¼‚å¸¸çš„è¯ï¼Œç›´æ¥åˆ©ç”¨å›æ»šæ—¥å¿—ä¸­çš„ä¿¡æ¯å°†æ•°æ®å›æ»šåˆ°ä¿®æ”¹ä¹‹å‰çš„æ ·å­å³å¯</li><li>å›æ»šæ—¥å¿—ä¼šå…ˆäºæ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šï¼Œè¿™æ ·ä¿è¯äº†å³ä½¿é‡åˆ°æ•°æ®åº“çªç„¶å®•æœºç­‰æƒ…å†µï¼Œå½“ç”¨æˆ·å†æ¬¡å¯åŠ¨æ•°æ®åº“çš„æ—¶å€™ï¼Œæ•°æ®åº“è¿˜èƒ½å¤Ÿé€šè¿‡æŸ¥è¯¢å›æ»šæ—¥å¿—æ¥å›æ»šå°†ä¹‹å‰æœªå®Œæˆçš„äº‹åŠ¡</li></ul><hr><h4 id="éš”ç¦»çº§åˆ«" tabindex="-1"><a class="header-anchor" href="#éš”ç¦»çº§åˆ«" aria-hidden="true">#</a> éš”ç¦»çº§åˆ«</h4><p>TransactionDefinition æ¥å£ä¸­å®šä¹‰äº†äº”ä¸ªè¡¨ç¤ºéš”ç¦»çº§åˆ«çš„å¸¸é‡ï¼š</p><ul><li>TransactionDefinition.ISOLATION_DEFAULTï¼šä½¿ç”¨åç«¯æ•°æ®åº“é»˜è®¤çš„éš”ç¦»çº§åˆ«ï¼ŒMySQL é»˜è®¤é‡‡ç”¨çš„ REPEATABLE_READ éš”ç¦»çº§åˆ«ï¼ŒOracle é»˜è®¤é‡‡ç”¨çš„ READ_COMMITTEDéš”ç¦»çº§åˆ«.</li><li>TransactionDefinition.ISOLATION_READ_UNCOMMITTEDï¼šæœ€ä½çš„éš”ç¦»çº§åˆ«ï¼Œå…è®¸è¯»å–å°šæœªæäº¤çš„æ•°æ®å˜æ›´ï¼Œå¯èƒ½ä¼šå¯¼è‡´è„è¯»ã€å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»</li><li>TransactionDefinition.ISOLATION_READ_COMMITTEDï¼šå…è®¸è¯»å–å¹¶å‘äº‹åŠ¡å·²ç»æäº¤çš„æ•°æ®ï¼Œå¯ä»¥é˜»æ­¢è„è¯»ï¼Œä½†æ˜¯å¹»è¯»æˆ–ä¸å¯é‡å¤è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿ</li><li>TransactionDefinition.ISOLATION_REPEATABLE_READï¼šå¯¹åŒä¸€å­—æ®µçš„å¤šæ¬¡è¯»å–ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ï¼Œé™¤éæ•°æ®æ˜¯è¢«æœ¬èº«äº‹åŠ¡è‡ªå·±æ‰€ä¿®æ”¹ï¼Œå¯ä»¥é˜»æ­¢è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†å¹»è¯»ä»æœ‰å¯èƒ½å‘ç”Ÿã€‚</li><li>TransactionDefinition.ISOLATION_SERIALIZABLEï¼šæœ€é«˜çš„éš”ç¦»çº§åˆ«ï¼Œå®Œå…¨æœä» ACID çš„éš”ç¦»çº§åˆ«ã€‚æ‰€æœ‰çš„äº‹åŠ¡ä¾æ¬¡é€ä¸ªæ‰§è¡Œï¼Œè¿™æ ·äº‹åŠ¡ä¹‹é—´å°±å®Œå…¨ä¸å¯èƒ½äº§ç”Ÿå¹²æ‰°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥çº§åˆ«å¯ä»¥é˜²æ­¢è„è¯»ã€ä¸å¯é‡å¤è¯»ä»¥åŠå¹»è¯»ã€‚ä½†æ˜¯è¿™å°†ä¸¥é‡å½±å“ç¨‹åºçš„æ€§èƒ½ã€‚é€šå¸¸æƒ…å†µä¸‹ä¹Ÿä¸ä¼šç”¨åˆ°è¯¥çº§åˆ«</li></ul><p>MySQL InnoDB å­˜å‚¨å¼•æ“çš„é»˜è®¤æ”¯æŒçš„éš”ç¦»çº§åˆ«æ˜¯ <strong>REPEATABLE-READï¼ˆå¯é‡è¯»ï¼‰</strong></p><p><strong>åˆ†å¸ƒå¼äº‹åŠ¡</strong>ï¼šå…è®¸å¤šä¸ªç‹¬ç«‹çš„äº‹åŠ¡èµ„æºï¼ˆtransactional resourcesï¼‰å‚ä¸åˆ°ä¸€ä¸ªå…¨å±€çš„äº‹åŠ¡ä¸­ã€‚äº‹åŠ¡èµ„æºé€šå¸¸æ˜¯å…³ç³»å‹æ•°æ®åº“ç³»ç»Ÿï¼Œä½†ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–ç±»å‹çš„èµ„æºï¼Œå…¨å±€äº‹åŠ¡è¦æ±‚åœ¨å…¶ä¸­çš„æ‰€æœ‰å‚ä¸çš„äº‹åŠ¡è¦ä¹ˆéƒ½æäº¤ï¼Œè¦ä¹ˆéƒ½å›æ»šï¼Œè¿™å¯¹äºäº‹åŠ¡åŸæœ‰çš„ ACID è¦æ±‚åˆæœ‰äº†æé«˜</p><p>åœ¨ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼ŒInnoDB å­˜å‚¨å¼•æ“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«å¿…é¡»è®¾ç½®ä¸º SERIALIZABLE</p><hr><h4 id="ä¼ æ’­è¡Œä¸º" tabindex="-1"><a class="header-anchor" href="#ä¼ æ’­è¡Œä¸º" aria-hidden="true">#</a> ä¼ æ’­è¡Œä¸º</h4><p>äº‹åŠ¡ä¼ æ’­è¡Œä¸ºæ˜¯ä¸ºäº†è§£å†³ä¸šåŠ¡å±‚æ–¹æ³•ä¹‹é—´äº’ç›¸è°ƒç”¨çš„äº‹åŠ¡é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æ–¹æ³•åµŒå¥—ï¼š</p><ul><li><p>å½“äº‹åŠ¡æ–¹æ³•è¢«å¦ä¸€ä¸ªäº‹åŠ¡æ–¹æ³•è°ƒç”¨æ—¶ï¼Œå¿…é¡»æŒ‡å®šäº‹åŠ¡åº”è¯¥å¦‚ä½•ä¼ æ’­ã€‚</p></li><li><p>ä¾‹å¦‚ï¼šæ–¹æ³•å¯èƒ½ç»§ç»­åœ¨ç°æœ‰äº‹åŠ¡ä¸­è¿è¡Œï¼Œä¹Ÿå¯èƒ½å¼€å¯ä¸€ä¸ªæ–°äº‹åŠ¡ï¼Œå¹¶åœ¨è‡ªå·±çš„äº‹åŠ¡ä¸­è¿è¡Œ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//å¤–å±‚äº‹åŠ¡ Service A çš„ aMethod è°ƒç”¨å†…å±‚ Service B çš„ bMethod</span>
<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation<span class="token operator">=</span>propagation<span class="token punctuation">.</span>xxx<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> aMethod <span class="token punctuation">{</span>
        <span class="token class-name">B</span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        b<span class="token punctuation">.</span><span class="token function">bMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>propagation<span class="token operator">=</span>propagation<span class="token punctuation">.</span>xxx<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> bMethod <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p><strong>æ”¯æŒå½“å‰äº‹åŠ¡</strong>çš„æƒ…å†µï¼š</p><ul><li>TransactionDefinition.PROPAGATION_REQUIREDï¼š å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡åˆ™<strong>åŠ å…¥è¯¥äº‹åŠ¡</strong>ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ <ul><li>å†…å¤–å±‚æ˜¯ç›¸åŒçš„äº‹åŠ¡ï¼Œåœ¨ aMethod æˆ–è€…åœ¨ bMethod å†…çš„ä»»ä½•åœ°æ–¹å‡ºç°å¼‚å¸¸ï¼Œäº‹åŠ¡éƒ½ä¼šè¢«å›æ»š</li><li>å·¥ä½œæµç¨‹ï¼š <ul><li>çº¿ç¨‹æ‰§è¡Œåˆ° serviceA.aMethod() æ—¶ï¼Œå…¶å®æ˜¯æ‰§è¡Œçš„ä»£ç† serviceA å¯¹è±¡çš„ aMethod</li><li>é¦–å…ˆæ‰§è¡Œäº‹åŠ¡å¢å¼ºå™¨é€»è¾‘ï¼ˆç¯ç»•å¢å¼ºï¼‰ï¼Œæå–äº‹åŠ¡æ ‡ç­¾å±æ€§ï¼Œæ£€æŸ¥å½“å‰çº¿ç¨‹æ˜¯å¦ç»‘å®š connection æ•°æ®åº“è¿æ¥èµ„æºï¼Œæ²¡æœ‰å°±è°ƒç”¨ datasource.getConnection()ï¼Œè®¾ç½®äº‹åŠ¡æäº¤ä¸ºæ‰‹åŠ¨æäº¤ autocommit(false)</li><li>æ‰§è¡Œå…¶ä»–å¢å¼ºå™¨çš„é€»è¾‘ï¼Œç„¶åè°ƒç”¨ target çš„ç›®æ ‡æ–¹æ³• aMethod() æ–¹æ³•ï¼Œè¿›å…¥ serviceB çš„é€»è¾‘</li><li>serviceB ä¹Ÿæ˜¯å…ˆæ‰§è¡Œäº‹åŠ¡å¢å¼ºå™¨çš„é€»è¾‘ï¼Œæå–äº‹åŠ¡æ ‡ç­¾å±æ€§ï¼Œä½†æ­¤æ—¶ä¼šæ£€æŸ¥åˆ°çº¿ç¨‹ç»‘å®šäº† connectionï¼Œæ£€æŸ¥æ³¨è§£çš„ä¼ æ’­å±æ€§ï¼Œæ‰€ä»¥è°ƒç”¨ DataSourceUtils.getConnection(datasource) å…±äº«è¯¥è¿æ¥èµ„æºï¼Œæ‰§è¡Œå®Œç›¸å…³çš„å¢å¼ºå’Œ SQL åï¼Œå‘ç°äº‹åŠ¡å¹¶ä¸æ˜¯å½“å‰æ–¹æ³•å¼€å¯çš„ï¼Œå¯ä»¥ç›´æ¥è¿”å›ä¸Šå±‚</li><li>serviceA.aMethod() ç»§ç»­æ‰§è¡Œï¼Œæ‰§è¡Œå®Œå¢å¼ºåè¿›è¡Œæäº¤äº‹åŠ¡æˆ–å›æ»šäº‹åŠ¡</li></ul></li></ul></li><li>TransactionDefinition.PROPAGATION_SUPPORTSï¼š å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™<strong>åŠ å…¥è¯¥äº‹åŠ¡</strong>ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™ä»¥éäº‹åŠ¡çš„æ–¹å¼ç»§ç»­è¿è¡Œ</li><li>TransactionDefinition.PROPAGATION_MANDATORYï¼š å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™<strong>åŠ å…¥è¯¥äº‹åŠ¡</strong>ï¼›å¦‚æœå½“å‰æ²¡æœ‰äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</li></ul><p><strong>ä¸æ”¯æŒå½“å‰äº‹åŠ¡</strong>çš„æƒ…å†µï¼š</p><ul><li>TransactionDefinition.PROPAGATION_REQUIRES_NEWï¼š åˆ›å»ºä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ· <ul><li>å†…å¤–å±‚æ˜¯ä¸åŒçš„äº‹åŠ¡ï¼Œå¦‚æœ bMethod å·²ç»æäº¤ï¼Œå¦‚æœ aMethod å¤±è´¥å›æ»š ï¼ŒbMethod ä¸ä¼šå›æ»š</li><li>å¦‚æœ bMethod å¤±è´¥å›æ»šï¼ŒServiceB æŠ›å‡ºçš„å¼‚å¸¸è¢« ServiceA æ•è·ï¼Œå¦‚æœ B æŠ›å‡ºçš„å¼‚å¸¸æ˜¯ A ä¼šå›æ»šçš„å¼‚å¸¸ï¼ŒaMethod äº‹åŠ¡éœ€è¦å›æ»šï¼Œå¦åˆ™ä»ç„¶å¯ä»¥æäº¤</li></ul></li><li>TransactionDefinition.PROPAGATION_NOT_SUPPORTEDï¼š <strong>ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œ</strong>ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·</li><li>TransactionDefinition.PROPAGATION_NEVERï¼š <strong>ä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œ</strong>ï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</li></ul><p>å…¶ä»–æƒ…å†µï¼š</p><ul><li>TransactionDefinition.PROPAGATION_NESTEDï¼š å¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªäº‹åŠ¡ä½œä¸ºå½“å‰äº‹åŠ¡çš„åµŒå¥—äº‹åŠ¡ï¼ˆä¸¤ä¸ªäº‹åŠ¡æ²¡æœ‰å…³ç³»ï¼‰æ¥è¿è¡Œ <ul><li>å¦‚æœ ServiceB å¼‚å¸¸å›æ»šï¼Œå¯ä»¥é€šè¿‡ try-catch æœºåˆ¶æ‰§è¡Œ ServiceC</li><li>å¦‚æœ ServiceB æäº¤ï¼Œ ServiceA å¯ä»¥æ ¹æ®å…·ä½“çš„é…ç½®å†³å®šæ˜¯ commit è¿˜æ˜¯ rollback</li><li><strong>åº”ç”¨åœºæ™¯</strong>ï¼šåœ¨æŸ¥è¯¢æ•°æ®çš„æ—¶å€™è¦å‘æ•°æ®åº“ä¸­å­˜å‚¨ä¸€äº›æ—¥å¿—ï¼Œç³»ç»Ÿä¸å¸Œæœ›å­˜æ—¥å¿—çš„è¡Œä¸ºå½±å“åˆ°ä¸»é€»è¾‘ï¼Œå¯ä»¥ä½¿ç”¨è¯¥ä¼ æ’­</li></ul></li></ul><p>requiedï¼šå¿…é¡»çš„ã€supportsï¼šæ”¯æŒçš„ã€mandatoryï¼šå¼ºåˆ¶çš„ã€nestedï¼šåµŒå¥—çš„</p><hr><h4 id="è¶…æ—¶å±æ€§" tabindex="-1"><a class="header-anchor" href="#è¶…æ—¶å±æ€§" aria-hidden="true">#</a> è¶…æ—¶å±æ€§</h4><p>äº‹åŠ¡è¶…æ—¶ï¼ŒæŒ‡ä¸€ä¸ªäº‹åŠ¡æ‰€å…è®¸æ‰§è¡Œçš„æœ€é•¿æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡è¯¥æ—¶é—´é™åˆ¶äº‹åŠ¡è¿˜æ²¡æœ‰å®Œæˆï¼Œåˆ™è‡ªåŠ¨å›æ»šäº‹åŠ¡ã€‚åœ¨ TransactionDefinition ä¸­ä»¥ int çš„å€¼æ¥è¡¨ç¤ºè¶…æ—¶æ—¶é—´ï¼Œå…¶å•ä½æ˜¯ç§’ï¼Œé»˜è®¤å€¼ä¸º -1</p><hr><h4 id="åªè¯»å±æ€§" tabindex="-1"><a class="header-anchor" href="#åªè¯»å±æ€§" aria-hidden="true">#</a> åªè¯»å±æ€§</h4><p>å¯¹äºåªæœ‰è¯»å–æ•°æ®æŸ¥è¯¢çš„äº‹åŠ¡ï¼Œå¯ä»¥æŒ‡å®šäº‹åŠ¡ç±»å‹ä¸º readonlyï¼Œå³åªè¯»äº‹åŠ¡ï¼›åªè¯»äº‹åŠ¡ä¸æ¶‰åŠæ•°æ®çš„ä¿®æ”¹ï¼Œæ•°æ®åº“ä¼šæä¾›ä¸€äº›ä¼˜åŒ–æ‰‹æ®µï¼Œé€‚åˆç”¨åœ¨æœ‰å¤šæ¡æ•°æ®åº“æŸ¥è¯¢æ“ä½œçš„æ–¹æ³•ä¸­</p><p>è¯»æ“ä½œä¸ºä»€ä¹ˆéœ€è¦å¯ç”¨äº‹åŠ¡æ”¯æŒï¼š</p><ul><li>MySQL é»˜è®¤å¯¹æ¯ä¸€ä¸ªæ–°å»ºç«‹çš„è¿æ¥éƒ½å¯ç”¨äº† <code>autocommit</code> æ¨¡å¼ï¼Œåœ¨è¯¥æ¨¡å¼ä¸‹ï¼Œæ¯ä¸€ä¸ªå‘é€åˆ° MySQL æœåŠ¡å™¨çš„ SQL è¯­å¥éƒ½ä¼šåœ¨ä¸€ä¸ª<strong>å•ç‹¬</strong>çš„äº‹åŠ¡ä¸­è¿›è¡Œå¤„ç†ï¼Œæ‰§è¡Œç»“æŸåä¼šè‡ªåŠ¨æäº¤äº‹åŠ¡ï¼Œå¹¶å¼€å¯ä¸€ä¸ªæ–°çš„äº‹åŠ¡</li><li>æ‰§è¡Œå¤šæ¡æŸ¥è¯¢è¯­å¥ï¼Œå¦‚æœæ–¹æ³•åŠ ä¸Šäº† <code>@Transactional</code> æ³¨è§£ï¼Œè¿™ä¸ªæ–¹æ³•æ‰§è¡Œçš„æ‰€æœ‰ SQL ä¼šè¢«æ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå¦‚æœå£°æ˜äº†åªè¯»äº‹åŠ¡çš„è¯ï¼Œæ•°æ®åº“å°±ä¼šå»ä¼˜åŒ–å®ƒçš„æ‰§è¡Œï¼Œå¹¶ä¸ä¼šå¸¦æ¥å…¶ä»–çš„æ”¶ç›Šã€‚å¦‚æœä¸åŠ  <code>@Transactional</code>ï¼Œæ¯æ¡ SQL ä¼šå¼€å¯ä¸€ä¸ªå•ç‹¬çš„äº‹åŠ¡ï¼Œä¸­é—´è¢«å…¶å®ƒäº‹åŠ¡ä¿®æ”¹äº†æ•°æ®ï¼Œæ¯”å¦‚åœ¨å‰æ¡ SQL æŸ¥è¯¢ä¹‹åï¼Œåæ¡ SQL æŸ¥è¯¢ä¹‹å‰ï¼Œæ•°æ®è¢«å…¶ä»–ç”¨æˆ·æ”¹å˜ï¼Œåˆ™è¿™æ¬¡æ•´ä½“çš„ç»Ÿè®¡æŸ¥è¯¢å°†ä¼šå‡º<strong>ç°è¯»æ•°æ®ä¸ä¸€è‡´çš„çŠ¶æ€</strong></li></ul><hr><h3 id="æ ¸å¿ƒå¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒå¯¹è±¡" aria-hidden="true">#</a> æ ¸å¿ƒå¯¹è±¡</h3><h4 id="äº‹åŠ¡å¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#äº‹åŠ¡å¯¹è±¡" aria-hidden="true">#</a> äº‹åŠ¡å¯¹è±¡</h4><p>J2EE å¼€å‘ä½¿ç”¨åˆ†å±‚è®¾è®¡çš„æ€æƒ³è¿›è¡Œï¼Œå¯¹äºç®€å•çš„ä¸šåŠ¡å±‚è½¬è°ƒæ•°æ®å±‚çš„å•ä¸€æ“ä½œï¼Œäº‹åŠ¡å¼€å¯åœ¨ä¸šåŠ¡å±‚æˆ–è€…æ•°æ®å±‚å¹¶æ— å¤ªå¤§å·®åˆ«ï¼Œå½“ä¸šåŠ¡ä¸­åŒ…å«å¤šä¸ªæ•°æ®å±‚çš„è°ƒç”¨æ—¶ï¼Œéœ€è¦åœ¨ä¸šåŠ¡å±‚å¼€å¯äº‹åŠ¡ï¼Œå¯¹æ•°æ®å±‚ä¸­å¤šä¸ªæ“ä½œè¿›è¡Œç»„åˆå¹¶å½’å±äºåŒä¸€ä¸ªäº‹åŠ¡è¿›è¡Œå¤„ç†</p><p>Spring ä¸ºä¸šåŠ¡å±‚æä¾›äº†æ•´å¥—çš„äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼š</p><ul><li><p>PlatformTransactionManager</p></li><li><p>TransactionDefinition</p></li><li><p>TransactionStatus</p></li></ul><hr><h4 id="ptm" tabindex="-1"><a class="header-anchor" href="#ptm" aria-hidden="true">#</a> PTM</h4><p>PlatformTransactionManagerï¼Œå¹³å°äº‹åŠ¡ç®¡ç†å™¨å®ç°ç±»ï¼š</p><ul><li><p>DataSourceTransactionManager é€‚ç”¨äº Spring JDBC æˆ– MyBatis</p></li><li><p>HibernateTransactionManager é€‚ç”¨äº Hibernate3.0 åŠä»¥ä¸Šç‰ˆæœ¬</p></li><li><p>JpaTransactionManager é€‚ç”¨äº JPA</p></li><li><p>JdoTransactionManager é€‚ç”¨äº JDO</p></li><li><p>JtaTransactionManager é€‚ç”¨äº JTA</p></li></ul><p>ç®¡ç†å™¨ï¼š</p><ul><li><p>JPAï¼ˆJava Persistence APIï¼‰Java EE æ ‡å‡†ä¹‹ä¸€ï¼Œä¸º POJO æä¾›æŒä¹…åŒ–æ ‡å‡†è§„èŒƒï¼Œå¹¶è§„èŒƒäº†æŒä¹…åŒ–å¼€å‘çš„ç»Ÿä¸€ APIï¼Œç¬¦åˆ JPA è§„èŒƒçš„å¼€å‘å¯ä»¥åœ¨ä¸åŒçš„ JPA æ¡†æ¶ä¸‹è¿è¡Œ</p><p><strong>éæŒä¹…åŒ–ä¸€ä¸ªå­—æ®µ</strong>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token class-name">String</span> transient1<span class="token punctuation">;</span> <span class="token comment">// not persistent because of static</span>
<span class="token keyword">final</span> <span class="token class-name">String</span> transient2 <span class="token operator">=</span> â€œ<span class="token class-name">Satish</span>â€<span class="token punctuation">;</span> <span class="token comment">// not persistent because of final</span>
<span class="token keyword">transient</span> <span class="token class-name">String</span> transient3<span class="token punctuation">;</span> <span class="token comment">// not persistent because of transient</span>
<span class="token annotation punctuation">@Transient</span>
<span class="token class-name">String</span> transient4<span class="token punctuation">;</span> <span class="token comment">// not persistent because of @Transient</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>JDOï¼ˆJava Data Objectï¼‰æ˜¯ Java å¯¹è±¡æŒä¹…åŒ–è§„èŒƒï¼Œç”¨äºå­˜å–æŸç§æ•°æ®åº“ä¸­çš„å¯¹è±¡ï¼Œå¹¶æä¾›æ ‡å‡†åŒ– APIã€‚JDBC ä»…é’ˆå¯¹å…³ç³»æ•°æ®åº“è¿›è¡Œæ“ä½œï¼ŒJDO å¯ä»¥æ‰©å±•åˆ°å…³ç³»æ•°æ®åº“ã€XMLã€å¯¹è±¡æ•°æ®åº“ç­‰ï¼Œå¯ç§»æ¤æ€§æ›´å¼º</p></li><li><p>JTAï¼ˆJava Transaction APIï¼‰Java EE æ ‡å‡†ä¹‹ä¸€ï¼Œå…è®¸åº”ç”¨ç¨‹åºæ‰§è¡Œåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ã€‚ä¸ JDBC ç›¸æ¯”ï¼ŒJDBC äº‹åŠ¡åˆ™è¢«é™å®šåœ¨ä¸€ä¸ªå•ä¸€çš„æ•°æ®åº“è¿æ¥ï¼Œè€Œä¸€ä¸ª JTA äº‹åŠ¡å¯ä»¥æœ‰å¤šä¸ªå‚ä¸è€…ï¼Œæ¯”å¦‚ JDBC è¿æ¥ã€JDO éƒ½å¯ä»¥å‚ä¸åˆ°ä¸€ä¸ª JTA äº‹åŠ¡ä¸­</p></li></ul><p>æ­¤æ¥å£å®šä¹‰äº†äº‹åŠ¡çš„åŸºæœ¬æ“ä½œï¼š</p><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>TransactionStatus getTransaction(TransactionDefinition definition)</td><td>è·å–äº‹åŠ¡</td></tr><tr><td>void commit(TransactionStatus status)</td><td>æäº¤äº‹åŠ¡</td></tr><tr><td>void rollback(TransactionStatus status)</td><td>å›æ»šäº‹åŠ¡</td></tr></tbody></table><hr><h4 id="definition" tabindex="-1"><a class="header-anchor" href="#definition" aria-hidden="true">#</a> Definition</h4><p>TransactionDefinition æ­¤æ¥å£å®šä¹‰äº†äº‹åŠ¡çš„åŸºæœ¬ä¿¡æ¯ï¼š</p><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>String getName()</td><td>è·å–äº‹åŠ¡å®šä¹‰åç§°</td></tr><tr><td>boolean isReadOnly()</td><td>è·å–äº‹åŠ¡çš„è¯»å†™å±æ€§</td></tr><tr><td>int getIsolationLevel()</td><td>è·å–äº‹åŠ¡éš”ç¦»çº§åˆ«</td></tr><tr><td>int getTimeout()</td><td>è·å–äº‹åŠ¡è¶…æ—¶æ—¶é—´</td></tr><tr><td>int getPropagationBehavior()</td><td>è·å–äº‹åŠ¡ä¼ æ’­è¡Œä¸ºç‰¹å¾</td></tr></tbody></table><hr><h4 id="status" tabindex="-1"><a class="header-anchor" href="#status" aria-hidden="true">#</a> Status</h4><p>TransactionStatus æ­¤æ¥å£å®šä¹‰äº†äº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æŸä¸ªæ—¶é—´ç‚¹ä¸Šçš„çŠ¶æ€ä¿¡æ¯åŠå¯¹åº”çš„çŠ¶æ€æ“ä½œï¼š</p><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>boolean isNewTransaction()</td><td>è·å–äº‹åŠ¡æ˜¯å¦å¤„äºæ–°å¼€å§‹äº‹åŠ¡çŠ¶æ€</td></tr><tr><td>voin flush()</td><td>åˆ·æ–°äº‹åŠ¡çŠ¶æ€</td></tr><tr><td>boolean isCompleted()</td><td>è·å–äº‹åŠ¡æ˜¯å¦å¤„äºå·²å®ŒæˆçŠ¶æ€</td></tr><tr><td>boolean hasSavepoint()</td><td>è·å–äº‹åŠ¡æ˜¯å¦å…·æœ‰å›æ»šå‚¨å­˜ç‚¹</td></tr><tr><td>boolean isRollbackOnly()</td><td>è·å–äº‹åŠ¡æ˜¯å¦å¤„äºå›æ»šçŠ¶æ€</td></tr><tr><td>void setRollbackOnly()</td><td>è®¾ç½®äº‹åŠ¡å¤„äºå›æ»šçŠ¶æ€</td></tr></tbody></table><hr><h3 id="ç¼–ç¨‹å¼" tabindex="-1"><a class="header-anchor" href="#ç¼–ç¨‹å¼" aria-hidden="true">#</a> ç¼–ç¨‹å¼</h3><h4 id="æ§åˆ¶æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#æ§åˆ¶æ–¹å¼" aria-hidden="true">#</a> æ§åˆ¶æ–¹å¼</h4><p>ç¼–ç¨‹å¼ã€å£°æ˜å¼ï¼ˆXMLï¼‰ã€å£°æ˜å¼ï¼ˆæ³¨è§£ï¼‰</p><h4 id="ç¯å¢ƒå‡†å¤‡" tabindex="-1"><a class="header-anchor" href="#ç¯å¢ƒå‡†å¤‡" aria-hidden="true">#</a> ç¯å¢ƒå‡†å¤‡</h4><p>é“¶è¡Œè½¬è´¦ä¸šåŠ¡</p><ul><li><p>åŒ…è£…ç±»</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Account</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Double</span> money<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>DAOå±‚æ¥å£ï¼šAccountDao</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AccountDao</span> <span class="token punctuation">{</span>
    <span class="token comment">//å…¥è´¦æ“ä½œ	name:å…¥è´¦ç”¨æˆ·å	money:å…¥è´¦é‡‘é¢</span>
    <span class="token keyword">void</span> <span class="token function">inMoney</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;money&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//å‡ºè´¦æ“ä½œ	name:å‡ºè´¦ç”¨æˆ·å	money:å‡ºè´¦é‡‘é¢</span>
    <span class="token keyword">void</span> <span class="token function">outMoney</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;money&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>ä¸šåŠ¡å±‚æ¥å£æä¾›è½¬è´¦æ“ä½œï¼šAccountService</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AccountService</span> <span class="token punctuation">{</span>
	<span class="token comment">//è½¬è´¦æ“ä½œ	outName:å‡ºè´¦ç”¨æˆ·å	inName:å…¥è´¦ç”¨æˆ·å	money:è½¬è´¦é‡‘é¢</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">String</span> outName<span class="token punctuation">,</span><span class="token class-name">String</span> inName<span class="token punctuation">,</span><span class="token class-name">Double</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>ä¸šåŠ¡å±‚å®ç°æä¾›è½¬è´¦æ“ä½œï¼šAccountServiceImpl</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AccountService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">AccountDao</span> accountDao<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAccountDao</span><span class="token punctuation">(</span><span class="token class-name">AccountDao</span> accountDao<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>accountDao <span class="token operator">=</span> accountDao<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">String</span> outName<span class="token punctuation">,</span><span class="token class-name">String</span> inName<span class="token punctuation">,</span><span class="token class-name">Double</span> money<span class="token punctuation">)</span><span class="token punctuation">{</span>
		accountDao<span class="token punctuation">.</span><span class="token function">inMoney</span><span class="token punctuation">(</span>outName<span class="token punctuation">,</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        accountDao<span class="token punctuation">.</span><span class="token function">outMoney</span><span class="token punctuation">(</span>inName<span class="token punctuation">,</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æ˜ å°„é…ç½®æ–‡ä»¶ï¼šdao / AccountDao.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dao.AccountDao<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>inMoney<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        UPDATE account SET money = money + #{money} WHERE name = #{name}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>outMoney<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        UPDATE account SET money = money - #{money} WHERE name = #{name}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>jdbc.properties</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">jdbc.driver</span><span class="token punctuation">=</span><span class="token value attr-value">com.mysql.jdbc.Driver</span>
<span class="token key attr-name">jdbc.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:mysql://192.168.2.185:3306/spring_db</span>
<span class="token key attr-name">jdbc.username</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>
<span class="token key attr-name">jdbc.password</span><span class="token punctuation">=</span><span class="token value attr-value">1234</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼šapplicationContext.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>property-placeholder</span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>classpath:*.properties<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>com.alibaba.druid.pool.DruidDataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>driverClassName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${jdbc.driver}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>url<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${jdbc.url}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>username<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${jdbc.username}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>password<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>${jdbc.password}<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>accountService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>service.impl.AccountServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>accountDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>accountDao<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.mybatis.spring.SqlSessionFactoryBean<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>typeAliasesPackage<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>domain<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--æ‰«ææ˜ å°„é…ç½®å’ŒDao--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.mybatis.spring.mapper.MapperScannerConfigurer<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>basePackage<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dao<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æµ‹è¯•ç±»</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ApplicationContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">&quot;ap...xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">AccountService</span> accountService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AccountService</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;accountService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
accountService<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token string">&quot;Jock1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Jock2&quot;</span><span class="token punctuation">,</span> <span class="token number">100d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h4 id="ç¼–ç¨‹å¼-1" tabindex="-1"><a class="header-anchor" href="#ç¼–ç¨‹å¼-1" aria-hidden="true">#</a> ç¼–ç¨‹å¼</h4><p>ç¼–ç¨‹å¼äº‹åŠ¡å°±æ˜¯ä»£ç æ˜¾å¼çš„ç»™å‡ºäº‹åŠ¡çš„å¼€å¯å’Œæäº¤</p><ul><li><p>ä¿®æ”¹ä¸šåŠ¡å±‚å®ç°æä¾›è½¬è´¦æ“ä½œï¼šAccountServiceImpl</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">String</span> outName<span class="token punctuation">,</span><span class="token class-name">String</span> inName<span class="token punctuation">,</span><span class="token class-name">Double</span> money<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//1.åˆ›å»ºäº‹åŠ¡ç®¡ç†å™¨ï¼Œ</span>
    <span class="token class-name">DataSourceTransactionManager</span> dstm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//2.ä¸ºäº‹åŠ¡ç®¡ç†å™¨è®¾ç½®ä¸æ•°æ®å±‚ç›¸åŒçš„æ•°æ®æº</span>
    dstm<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//3.åˆ›å»ºäº‹åŠ¡å®šä¹‰å¯¹è±¡</span>
    <span class="token class-name">TransactionDefinition</span> td <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultTransactionDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//4.åˆ›å»ºäº‹åŠ¡çŠ¶æ€å¯¹è±¡ï¼Œç”¨äºæ§åˆ¶äº‹åŠ¡æ‰§è¡Œï¼Œã€å¼€å¯äº‹åŠ¡ã€‘</span>
    <span class="token class-name">TransactionStatus</span> ts <span class="token operator">=</span> dstm<span class="token punctuation">.</span><span class="token function">getTransaction</span><span class="token punctuation">(</span>td<span class="token punctuation">)</span><span class="token punctuation">;</span>
    accountDao<span class="token punctuation">.</span><span class="token function">inMoney</span><span class="token punctuation">(</span>inName<span class="token punctuation">,</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">//æ¨¡æ‹Ÿä¸šåŠ¡å±‚äº‹åŠ¡è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯</span>
    accountDao<span class="token punctuation">.</span><span class="token function">outMoney</span><span class="token punctuation">(</span>outName<span class="token punctuation">,</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//5.æäº¤äº‹åŠ¡</span>
    dstm<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>é…ç½® applicationContext.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--æ·»åŠ å±æ€§æ³¨å…¥--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>accountService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>service.impl.AccountServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>accountDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>accountDao<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h4 id="aopæ”¹é€ " tabindex="-1"><a class="header-anchor" href="#aopæ”¹é€ " aria-hidden="true">#</a> AOPæ”¹é€ </h4><ul><li><p>å°†ä¸šåŠ¡å±‚çš„äº‹åŠ¡å¤„ç†åŠŸèƒ½æŠ½å–å‡ºæ¥åˆ¶ä½œæˆ AOP é€šçŸ¥ï¼Œåˆ©ç”¨ç¯ç»•é€šçŸ¥è¿è¡ŒæœŸåŠ¨æ€ç»‡å…¥</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TxAdvice</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setDataSource</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dataSource <span class="token operator">=</span> dataSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">tx</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token comment">//å¼€å¯äº‹åŠ¡</span>
        <span class="token class-name">PlatformTransactionManager</span> ptm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//äº‹åŠ¡å®šä¹‰</span>
        <span class="token class-name">TransactionDefinition</span> td <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultTransactionDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//äº‹åŠ¡çŠ¶æ€</span>
        <span class="token class-name">TransactionStatus</span> ts <span class="token operator">=</span>  ptm<span class="token punctuation">.</span><span class="token function">getTransaction</span><span class="token punctuation">(</span>td<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//pjp.getArgs()æ ‡å‡†å†™æ³•ï¼Œä¹Ÿå¯ä»¥ä¸åŠ ï¼ŒåŒæ ·å¯ä»¥ä¼ é€’å‚æ•°</span>
        <span class="token class-name">Object</span> ret <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>pjp<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">//æäº¤äº‹åŠ¡</span>
        ptm<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>é…ç½® applicationContext.xmlï¼Œè¦å¼€å¯ AOP ç©ºé—´</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--ä¿®æ”¹beançš„å±æ€§æ³¨å…¥--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>accountService<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>service.impl.AccountServiceImpl<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>accountDao<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>accountDao<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--é…ç½®AOPé€šçŸ¥ç±»ï¼Œå¹¶æ³¨å…¥dataSource--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>aop.TxAdvice<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--ä½¿ç”¨ç¯ç»•é€šçŸ¥å°†é€šçŸ¥ç±»ç»‡å…¥åˆ°åŸå§‹ä¸šåŠ¡å¯¹è±¡æ‰§è¡Œè¿‡ç¨‹ä¸­--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* *..transfer(..))<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>aspect</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txAdvice<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>around</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tx<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>aspect</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>ä¿®æ”¹ä¸šåŠ¡å±‚å®ç°æä¾›è½¬è´¦æ“ä½œï¼šAccountServiceImpl</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AccountService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">AccountDao</span> accountDao<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAccountDao</span><span class="token punctuation">(</span><span class="token class-name">AccountDao</span> accountDao<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>accountDao <span class="token operator">=</span> accountDao<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">String</span> outName<span class="token punctuation">,</span><span class="token class-name">String</span> inName<span class="token punctuation">,</span><span class="token class-name">Double</span> money<span class="token punctuation">)</span><span class="token punctuation">{</span>
		accountDao<span class="token punctuation">.</span><span class="token function">inMoney</span><span class="token punctuation">(</span>outName<span class="token punctuation">,</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//int i = 1 / 0;</span>
        accountDao<span class="token punctuation">.</span><span class="token function">outMoney</span><span class="token punctuation">(</span>inName<span class="token punctuation">,</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h3 id="å£°æ˜å¼" tabindex="-1"><a class="header-anchor" href="#å£°æ˜å¼" aria-hidden="true">#</a> å£°æ˜å¼</h3><h4 id="xml-2" tabindex="-1"><a class="header-anchor" href="#xml-2" aria-hidden="true">#</a> XML</h4><h5 id="txä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#txä½¿ç”¨" aria-hidden="true">#</a> txä½¿ç”¨</h5><p>åˆ é™¤ TxAdvice é€šçŸ¥ç±»ï¼Œå¼€å¯ tx å‘½åç©ºé—´ï¼Œé…ç½® applicationContext.xml</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token comment">&lt;!--é…ç½®å¹³å°äº‹åŠ¡ç®¡ç†å™¨--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txManager<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>org.springframework.jdbc.datasource.DataSourceTransactionManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>dataSource<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--å®šä¹‰äº‹åŠ¡ç®¡ç†çš„é€šçŸ¥ç±»--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>advice</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">transaction-manager</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--å®šä¹‰æ§åˆ¶çš„äº‹åŠ¡--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>transfer<span class="token punctuation">&quot;</span></span> <span class="token attr-name">read-only</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>advice</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--ä½¿ç”¨aop:advisoråœ¨AOPé…ç½®ä¸­å¼•ç”¨äº‹åŠ¡ä¸“å±é€šçŸ¥ç±»ï¼Œåº•å±‚invokeè°ƒç”¨--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* service.*Service.*(..))<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>advisor</span> <span class="token attr-name">advice-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">pointcut-ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">aop:</span>config</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>aop:advice ä¸ aop:advisor åŒºåˆ« <ul><li><p>aop:advice é…ç½®çš„é€šçŸ¥ç±»å¯ä»¥æ˜¯æ™®é€š Java å¯¹è±¡ï¼Œä¸å®ç°æ¥å£ï¼Œä¹Ÿä¸ä½¿ç”¨ç»§æ‰¿å…³ç³»</p></li><li><p>aop:advisor é…ç½®çš„é€šçŸ¥ç±»å¿…é¡»å®ç°é€šçŸ¥æ¥å£ï¼Œåº•å±‚ invoke è°ƒç”¨</p><ul><li><p>MethodBeforeAdvice</p></li><li><p>AfterReturningAdvice</p></li><li><p>ThrowsAdvice</p></li></ul></li></ul></li></ul><p>pom.xml æ–‡ä»¶å¼•å…¥ä¾èµ–ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-tx<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.9.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h5 id="txé…ç½®" tabindex="-1"><a class="header-anchor" href="#txé…ç½®" aria-hidden="true">#</a> txé…ç½®</h5><h6 id="advice-1" tabindex="-1"><a class="header-anchor" href="#advice-1" aria-hidden="true">#</a> advice</h6><p>æ ‡ç­¾ï¼štx:adviceï¼Œbeans çš„å­æ ‡ç­¾</p><p>ä½œç”¨ï¼šä¸“ç”¨äºå£°æ˜äº‹åŠ¡é€šçŸ¥</p><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>advice</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">transaction-manager</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>advice</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŸºæœ¬å±æ€§ï¼š</p><ul><li>idï¼šç”¨äºé…ç½® aop æ—¶æŒ‡å®šé€šçŸ¥å™¨çš„ id</li><li>transaction-managerï¼šæŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨ bean</li></ul><h6 id="attributes" tabindex="-1"><a class="header-anchor" href="#attributes" aria-hidden="true">#</a> attributes</h6><p>ç±»å‹ï¼štx:attributesï¼Œtx:advice çš„å­æ ‡ç­¾</p><p>ä½œç”¨ï¼šå®šä¹‰é€šçŸ¥å±æ€§</p><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>advice</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txAdvice<span class="token punctuation">&quot;</span></span> <span class="token attr-name">transaction-manager</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>advice</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h6 id="method" tabindex="-1"><a class="header-anchor" href="#method" aria-hidden="true">#</a> method</h6><p>æ ‡ç­¾ï¼štx:methodï¼Œtx:attribute çš„å­æ ‡ç­¾</p><p>ä½œç”¨ï¼šè®¾ç½®å…·ä½“çš„äº‹åŠ¡å±æ€§</p><p>æ ¼å¼ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--æ ‡å‡†æ ¼å¼--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>*<span class="token punctuation">&quot;</span></span> <span class="token attr-name">read-only</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>get*<span class="token punctuation">&quot;</span></span> <span class="token attr-name">read-only</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>method</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>find*<span class="token punctuation">&quot;</span></span> <span class="token attr-name">read-only</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>true<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">tx:</span>attributes</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">aop:</span>pointcut</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>pt<span class="token punctuation">&quot;</span></span> <span class="token attr-name">expression</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>execution(* service.*Service.*(..))<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span><span class="token comment">&lt;!--æ ‡å‡†--&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼šé€šå¸¸äº‹åŠ¡å±æ€§ä¼šé…ç½®å¤šä¸ªï¼ŒåŒ…å« 1 ä¸ªè¯»å†™çš„å…¨äº‹åŠ¡å±æ€§ï¼Œ1 ä¸ªåªè¯»çš„æŸ¥è¯¢ç±»äº‹åŠ¡å±æ€§</p><p>å±æ€§ï¼š</p><ul><li>nameï¼šå¾…æ·»åŠ äº‹åŠ¡çš„æ–¹æ³•åè¡¨è¾¾å¼ï¼ˆæ”¯æŒ * é€šé…ç¬¦ï¼‰</li><li>read-onlyï¼šè®¾ç½®äº‹åŠ¡çš„è¯»å†™å±æ€§ï¼Œtrue ä¸ºåªè¯»ï¼Œfalse ä¸ºè¯»å†™</li><li>timeoutï¼šè®¾ç½®äº‹åŠ¡çš„è¶…æ—¶æ—¶é•¿ï¼Œå•ä½ç§’ï¼Œ-1 ä¸ºæ— é™é•¿</li><li>isolationï¼šè®¾ç½®äº‹åŠ¡çš„éš”ç¦»ç•Œåˆ«ï¼Œè¯¥éš”ç¦»çº§è®¾å®šæ˜¯åŸºäº Spring çš„è®¾å®šï¼Œéæ•°æ®åº“ç«¯</li><li>no-rollback-forï¼šè®¾ç½®äº‹åŠ¡ä¸­ä¸å›æ»šçš„å¼‚å¸¸ï¼Œå¤šä¸ªå¼‚å¸¸ä½¿ç”¨ <code>,</code> åˆ†éš”</li><li>rollback-forï¼šè®¾ç½®äº‹åŠ¡ä¸­å¿…å›æ»šçš„å¼‚å¸¸ï¼Œå¤šä¸ªå¼‚å¸¸ä½¿ç”¨ <code>,</code> åˆ†éš”</li><li>propagationï¼šè®¾ç½®äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º</li></ul><hr><h4 id="æ³¨è§£" tabindex="-1"><a class="header-anchor" href="#æ³¨è§£" aria-hidden="true">#</a> æ³¨è§£</h4><h5 id="å¼€å¯æ³¨è§£" tabindex="-1"><a class="header-anchor" href="#å¼€å¯æ³¨è§£" aria-hidden="true">#</a> å¼€å¯æ³¨è§£</h5><h6 id="xml-3" tabindex="-1"><a class="header-anchor" href="#xml-3" aria-hidden="true">#</a> XML</h6><p>æ ‡ç­¾ï¼štx:annotation-driven</p><p>å½’å±ï¼šbeans æ ‡ç­¾</p><p>ä½œç”¨ï¼šå¼€å¯äº‹åŠ¡æ³¨è§£é©±åŠ¨ï¼Œå¹¶æŒ‡å®šå¯¹åº”çš„äº‹åŠ¡ç®¡ç†å™¨</p><p>èŒƒä¾‹ï¼š</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>annotation-driven</span> <span class="token attr-name">transaction-manager</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><hr><h6 id="çº¯æ³¨è§£-2" tabindex="-1"><a class="header-anchor" href="#çº¯æ³¨è§£-2" aria-hidden="true">#</a> çº¯æ³¨è§£</h6><p>åç§°ï¼š@EnableTransactionManagement</p><p>ç±»å‹ï¼šç±»æ³¨è§£ï¼ŒSpring æ³¨è§£é…ç½®ç±»ä¸Šæ–¹</p><p>ä½œç”¨ï¼šå¼€å¯æ³¨è§£é©±åŠ¨ï¼Œç­‰åŒ XML æ ¼å¼ä¸­çš„æ³¨è§£é©±åŠ¨</p><p>èŒƒä¾‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span><span class="token string">&quot;com.seazean&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PropertySource</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:jdbc.properties&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">JDBCConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">MyBatisConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">TransactionManagerConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableTransactionManagement</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringConfig</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionManagerConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>												<span class="token comment">//è‡ªåŠ¨è£…é…</span>
    <span class="token keyword">public</span> <span class="token class-name">PlatformTransactionManager</span> <span class="token function">getTransactionManager</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Autowired</span> <span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h5 id="é…ç½®æ³¨è§£" tabindex="-1"><a class="header-anchor" href="#é…ç½®æ³¨è§£" aria-hidden="true">#</a> é…ç½®æ³¨è§£</h5><p>åç§°ï¼š@Transactional</p><p>ç±»å‹ï¼šæ–¹æ³•æ³¨è§£ï¼Œç±»æ³¨è§£ï¼Œæ¥å£æ³¨è§£</p><p>ä½œç”¨ï¼šè®¾ç½®å½“å‰ç±»/æ¥å£ä¸­æ‰€æœ‰æ–¹æ³•æˆ–å…·ä½“æ–¹æ³•å¼€å¯äº‹åŠ¡ï¼Œå¹¶æŒ‡å®šç›¸å…³äº‹åŠ¡å±æ€§</p><p>èŒƒä¾‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>
    readOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    timeout <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
    isolation <span class="token operator">=</span> <span class="token class-name">Isolation</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">,</span>
    rollbackFor <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">ArithmeticException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    noRollbackFor <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">REQUIRES_NEW</span>
<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> addAccount<span class="token punctuation">{</span><span class="token punctuation">}</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><ul><li><p><code>@Transactional</code> æ³¨è§£åªæœ‰ä½œç”¨åˆ° public æ–¹æ³•ä¸Šäº‹åŠ¡æ‰ç”Ÿæ•ˆ</p></li><li><p>ä¸æ¨èåœ¨æ¥å£ä¸Šä½¿ç”¨ <code>@Transactional</code> æ³¨è§£</p><p>åŸå› ï¼šåœ¨æ¥å£ä¸Šä½¿ç”¨æ³¨è§£ï¼Œ<strong>åªæœ‰åœ¨ä½¿ç”¨åŸºäºæ¥å£çš„ä»£ç†ï¼ˆJDKï¼‰æ—¶æ‰ä¼šç”Ÿæ•ˆï¼Œå› ä¸ºæ³¨è§£æ˜¯ä¸èƒ½ç»§æ‰¿çš„</strong>ï¼Œè¿™å°±æ„å‘³ç€å¦‚æœæ­£åœ¨ä½¿ç”¨åŸºäºç±»çš„ä»£ç†ï¼ˆCGLIBï¼‰æ—¶ï¼Œé‚£ä¹ˆäº‹åŠ¡çš„è®¾ç½®å°†ä¸èƒ½è¢«åŸºäºç±»çš„ä»£ç†æ‰€è¯†åˆ«</p></li><li><p>æ­£ç¡®çš„è®¾ç½® <code>@Transactional</code> çš„ rollbackFor å’Œ propagation å±æ€§ï¼Œå¦åˆ™äº‹åŠ¡å¯èƒ½ä¼šå›æ»šå¤±è´¥</p></li><li><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œäº‹åŠ¡åªæœ‰é‡åˆ°è¿è¡ŒæœŸå¼‚å¸¸ å’Œ Error ä¼šå¯¼è‡´äº‹åŠ¡å›æ»šï¼Œä½†æ˜¯åœ¨é‡åˆ°æ£€æŸ¥å‹ï¼ˆCheckedï¼‰å¼‚å¸¸æ—¶ä¸ä¼šå›æ»š</p><ul><li>ç»§æ‰¿è‡ª RuntimeException æˆ– error çš„æ˜¯éæ£€æŸ¥å‹å¼‚å¸¸ï¼Œæ¯”å¦‚ç©ºæŒ‡é’ˆå’Œç´¢å¼•è¶Šç•Œï¼Œè€Œç»§æ‰¿è‡ª Exception çš„åˆ™æ˜¯æ£€æŸ¥å‹å¼‚å¸¸ï¼Œæ¯”å¦‚ IOExceptionã€ClassNotFoundExceptionï¼ŒRuntimeException æœ¬èº«ç»§æ‰¿ Exception</li><li>éæ£€æŸ¥å‹ç±»å¼‚å¸¸å¯ä»¥ä¸ç”¨æ•è·ï¼Œè€Œæ£€æŸ¥å‹å¼‚å¸¸åˆ™å¿…é¡»ç”¨ try è¯­å¥å—æŠŠå¼‚å¸¸äº¤ç»™ä¸Šçº§æ–¹æ³•ï¼Œè¿™æ ·äº‹åŠ¡æ‰èƒ½æœ‰æ•ˆ</li></ul></li></ul><p><strong>äº‹åŠ¡ä¸ç”Ÿæ•ˆçš„é—®é¢˜</strong></p><ul><li><p>æƒ…å†µ 1ï¼šç¡®è®¤åˆ›å»ºçš„ MySQL æ•°æ®åº“è¡¨å¼•æ“æ˜¯ InnoDBï¼ŒMyISAM ä¸æ”¯æŒäº‹åŠ¡</p></li><li><p>æƒ…å†µ 2ï¼šæ³¨è§£åˆ° protectedï¼Œprivate æ–¹æ³•ä¸Šäº‹åŠ¡ä¸ç”Ÿæ•ˆï¼Œä½†ä¸ä¼šæŠ¥é”™</p><p>åŸå› ï¼šç†è®ºä¸Šè€Œè¨€ï¼Œä¸ç”¨ public ä¿®é¥°ï¼Œä¹Ÿå¯ä»¥ç”¨ aop å®ç°äº‹åŠ¡çš„åŠŸèƒ½ï¼Œä½†æ˜¯æ–¹æ³•ç§æœ‰åŒ–è®©å…¶ä»–ä¸šåŠ¡æ— æ³•è°ƒç”¨</p><p>AopUtils.canApplyï¼š<code>methodMatcher.matches(method, targetClass) --true--&gt; return true</code><br><code>TransactionAttributeSourcePointcut.matches()</code> ï¼ŒAbstractFallbackTransactionAttributeSource ä¸­ getTransactionAttribute æ–¹æ³•è°ƒç”¨äº†å…¶æœ¬èº«çš„ computeTransactionAttribute æ–¹æ³•ï¼Œå½“åŠ äº†äº‹åŠ¡æ³¨è§£çš„æ–¹æ³•ä¸æ˜¯ public æ—¶ï¼Œè¯¥æ–¹æ³•ç›´æ¥è¿”å› nullï¼Œæ‰€ä»¥é€ æˆå¢å¼ºä¸åŒ¹é…</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">TransactionAttribute</span> <span class="token function">computeTransactionAttribute</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Don&#39;t allow no-public methods as required.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">allowPublicMethodsOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">Modifier</span><span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æƒ…å†µ 3ï¼šæ³¨è§£æ‰€åœ¨çš„ç±»æ²¡æœ‰è¢«åŠ è½½æˆ Bean</p></li><li><p>æƒ…å†µ 4ï¼šåœ¨ä¸šåŠ¡å±‚æ•æ‰å¼‚å¸¸åæœªå‘ä¸ŠæŠ›å‡ºï¼Œäº‹åŠ¡ä¸ç”Ÿæ•ˆ</p><p>åŸå› ï¼šåœ¨ä¸šåŠ¡å±‚æ•æ‰å¹¶å¤„ç†äº†å¼‚å¸¸ï¼ˆtry..catchï¼‰ç­‰äºæŠŠå¼‚å¸¸å¤„ç†æ‰äº†ï¼ŒSpring å°±ä¸çŸ¥é“è¿™é‡Œæœ‰é”™ï¼Œä¹Ÿä¸ä¼šä¸»åŠ¨å»å›æ»šæ•°æ®ï¼Œæ¨èåšæ³•æ˜¯åœ¨ä¸šåŠ¡å±‚ç»Ÿä¸€æŠ›å‡ºå¼‚å¸¸ï¼Œç„¶ååœ¨æ§åˆ¶å±‚ç»Ÿä¸€å¤„ç†</p></li><li><p>æƒ…å†µ 5ï¼šé‡åˆ°æ£€æµ‹å¼‚å¸¸æ—¶ï¼Œä¹Ÿæ— æ³•å›æ»š</p><p>åŸå› ï¼šSpring çš„é»˜è®¤çš„äº‹åŠ¡è§„åˆ™æ˜¯é‡åˆ°è¿è¡Œå¼‚å¸¸ï¼ˆRuntimeExceptionï¼‰å’Œç¨‹åºé”™è¯¯ï¼ˆErrorï¼‰æ‰ä¼šå›æ»šã€‚æƒ³é’ˆå¯¹æ£€æµ‹å¼‚å¸¸è¿›è¡Œäº‹åŠ¡å›æ»šï¼Œå¯ä»¥åœ¨ @Transactional æ³¨è§£é‡Œä½¿ç”¨ rollbackFor å±æ€§æ˜ç¡®æŒ‡å®šå¼‚å¸¸</p></li><li><p>æƒ…å†µ 6ï¼šSpring çš„äº‹åŠ¡ä¼ æ’­ç­–ç•¥åœ¨<strong>å†…éƒ¨æ–¹æ³•</strong>è°ƒç”¨æ—¶å°†ä¸èµ·ä½œç”¨ï¼Œåœ¨ä¸€ä¸ª Service å†…éƒ¨ï¼Œäº‹åŠ¡æ–¹æ³•ä¹‹é—´çš„åµŒå¥—è°ƒç”¨ï¼Œæ™®é€šæ–¹æ³•å’Œäº‹åŠ¡æ–¹æ³•ä¹‹é—´çš„åµŒå¥—è°ƒç”¨ï¼Œéƒ½ä¸ä¼šå¼€å¯æ–°çš„äº‹åŠ¡ï¼Œäº‹åŠ¡æ³¨è§£è¦åŠ åˆ°è°ƒç”¨æ–¹æ³•ä¸Šæ‰ç”Ÿæ•ˆ</p><p>åŸå› ï¼šSpring çš„äº‹åŠ¡éƒ½æ˜¯ä½¿ç”¨ AOP ä»£ç†çš„æ¨¡å¼ï¼ŒåŠ¨æ€ä»£ç† invoke åä¼šè°ƒç”¨åŸå§‹å¯¹è±¡ï¼Œè€ŒåŸå§‹å¯¹è±¡åœ¨å»è°ƒç”¨æ–¹æ³•æ—¶æ˜¯ä¸ä¼šè§¦å‘æ‹¦æˆªå™¨ï¼Œå°±æ˜¯<strong>ä¸€ä¸ªæ–¹æ³•è°ƒç”¨æœ¬å¯¹è±¡çš„å¦ä¸€ä¸ªæ–¹æ³•</strong>ï¼Œæ‰€ä»¥äº‹åŠ¡ä¹Ÿå°±æ— æ³•ç”Ÿæ•ˆ</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//æ³¨è§£æ·»åŠ åœ¨updateæ–¹æ³•ä¸Šæ— æ•ˆï¼Œéœ€è¦æ·»åŠ åˆ°add()æ–¹æ³•ä¸Š</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æƒ…å†µ 7ï¼šæ³¨è§£åœ¨æ¥å£ä¸Šï¼Œä»£ç†å¯¹è±¡æ˜¯ CGLIB</p></li></ul><hr><h5 id="ä½¿ç”¨æ³¨è§£" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨æ³¨è§£" aria-hidden="true">#</a> ä½¿ç”¨æ³¨è§£</h5><ul><li><p>Dao å±‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AccountDao</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token string">&quot;update account set money = money + #{money} where name = #{name}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">void</span> <span class="token function">inMoney</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;money&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token string">&quot;update account set money = money - #{money} where name = #{name}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">void</span> <span class="token function">outMoney</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;money&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Double</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>ä¸šåŠ¡å±‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AccountService</span> <span class="token punctuation">{</span>
    <span class="token comment">//å¯¹å½“å‰æ–¹æ³•æ·»åŠ äº‹åŠ¡ï¼Œè¯¥é…ç½®å°†æ›¿æ¢æ¥å£çš„é…ç½®</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>
        readOnly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        timeout <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
        isolation <span class="token operator">=</span> <span class="token class-name">Isolation</span><span class="token punctuation">.</span><span class="token constant">DEFAULT</span><span class="token punctuation">,</span>
        rollbackFor <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//java.lang.ArithmeticException.class, IOException.class</span>
        noRollbackFor <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        propagation <span class="token operator">=</span> <span class="token class-name">Propagation</span><span class="token punctuation">.</span><span class="token constant">REQUIRED</span>
        <span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">String</span> outName<span class="token punctuation">,</span> <span class="token class-name">String</span> inName<span class="token punctuation">,</span> <span class="token class-name">Double</span> money<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">AccountService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">AccountDao</span> accountDao<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token class-name">String</span> outName<span class="token punctuation">,</span> <span class="token class-name">String</span> inName<span class="token punctuation">,</span> <span class="token class-name">Double</span> money<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        accountDao<span class="token punctuation">.</span><span class="token function">inMoney</span><span class="token punctuation">(</span>outName<span class="token punctuation">,</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//int i = 1/0;</span>
        accountDao<span class="token punctuation">.</span><span class="token function">outMoney</span><span class="token punctuation">(</span>inName<span class="token punctuation">,</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>æ·»åŠ æ–‡ä»¶ Spring.configã€Mybatis.configã€JDBCConfig (å‚è€ƒioc_Mybatis)ã€TransactionManagerConfig</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ComponentScan</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PropertySource</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:jdbc.properties&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">JDBCConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token class-name">MyBatisConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableTransactionManagement</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpringConfig</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><hr><h3 id="æ¨¡æ¿å¯¹è±¡" tabindex="-1"><a class="header-anchor" href="#æ¨¡æ¿å¯¹è±¡" aria-hidden="true">#</a> æ¨¡æ¿å¯¹è±¡</h3><p>Spring æ¨¡æ¿å¯¹è±¡ï¼šTransactionTemplateã€JdbcTemplateã€RedisTemplateã€RabbitTemplateã€JmsTemplateã€HibernateTemplateã€RestTemplate</p><ul><li><p>JdbcTemplateï¼šæä¾›æ ‡å‡†çš„ sql è¯­å¥æ“ä½œAPI</p></li><li><p>NamedParameterJdbcTemplateï¼šæä¾›æ ‡å‡†çš„å…·å sql è¯­å¥æ“ä½œAPI</p></li><li><p>RedisTemplateï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">changeMoney</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">,</span> <span class="token class-name">Double</span> money<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;account:id:&quot;</span><span class="token operator">+</span>id<span class="token punctuation">,</span>money<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">Double</span> <span class="token function">findMondyById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> money <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;account:id:&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Double</span><span class="token punctuation">(</span>money<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Spring-RedisTemplate.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h2 id="åŸç†" tabindex="-1"><a class="header-anchor" href="#åŸç†" aria-hidden="true">#</a> åŸç†</h2><h3 id="xml-4" tabindex="-1"><a class="header-anchor" href="#xml-4" aria-hidden="true">#</a> XML</h3><p>ä¸‰å¤§å¯¹è±¡ï¼š</p><ul><li><p><strong>BeanDefinition</strong>ï¼šæ˜¯ Spring ä¸­æå…¶é‡è¦çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå­˜å‚¨äº† bean å¯¹è±¡çš„æ‰€æœ‰ç‰¹å¾ä¿¡æ¯ï¼Œå¦‚æ˜¯å¦å•ä¾‹ã€æ˜¯å¦æ‡’åŠ è½½ã€factoryBeanName ç­‰ï¼Œå’Œ bean çš„å…³ç³»å°±æ˜¯ç±»ä¸å¯¹è±¡çš„å…³ç³»ï¼Œä¸€ä¸ªä¸åŒçš„ bean å¯¹åº”ä¸€ä¸ª BeanDefinition</p></li><li><p><strong>BeanDefinationRegistry</strong>ï¼šå­˜æ”¾ BeanDefination çš„å®¹å™¨ï¼Œæ˜¯ä¸€ç§é”®å€¼å¯¹çš„å½¢å¼ï¼Œé€šè¿‡ç‰¹å®šçš„ Bean å®šä¹‰çš„ idï¼Œæ˜ å°„åˆ°ç›¸åº”çš„ BeanDefinationï¼Œ<strong>BeanFactory çš„å®ç°ç±»åŒæ ·ç»§æ‰¿ BeanDefinationRegistry æ¥å£</strong>ï¼Œæ‹¥æœ‰ä¿å­˜ BD çš„èƒ½åŠ›</p></li><li><p><strong>BeanDefinitionReader</strong>ï¼šè¯»å–é…ç½®æ–‡ä»¶ï¼Œ<strong>XML ç”¨ Dom4j è§£æ</strong>ï¼Œ<strong>æ³¨è§£ç”¨ IO æµåŠ è½½è§£æ</strong></p></li></ul><p>ç¨‹åºï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">BeanFactory</span> bf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XmlBeanFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPathResource</span><span class="token punctuation">(</span><span class="token string">&quot;applicationContext.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">UserService</span> userService1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span>bf<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>æºç è§£æï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">XmlBeanFactory</span><span class="token punctuation">(</span><span class="token class-name">Resource</span> resource<span class="token punctuation">,</span> <span class="token class-name">BeanFactory</span> parentBeanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>parentBeanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reader<span class="token punctuation">.</span><span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token class-name">Resource</span> resource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//å°† resource åŒ…è£…æˆå¸¦ç¼–ç æ ¼å¼çš„ EncodedResource</span>
    <span class="token comment">//EncodedResource ä¸­ getReader()æ–¹æ³•ï¼Œè°ƒç”¨java.ioåŒ…ä¸‹çš„ è½¬æ¢æµ åˆ›å»ºæŒ‡å®šç¼–ç çš„è¾“å…¥æµå¯¹è±¡</span>
    <span class="token keyword">return</span> <span class="token function">loadBeanDefinitions</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EncodedResource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><code>XmlBeanDefinitionReader.loadBeanDefinitions()</code>ï¼š<strong>æŠŠ Resource è§£ææˆ BeanDefinition å¯¹è±¡</strong></p><ul><li><code>currentResources = this.resourcesCurrentlyBeingLoaded.get()</code>ï¼šæ‹¿åˆ°å½“å‰çº¿ç¨‹å·²ç»åŠ è½½è¿‡çš„æ‰€æœ‰ EncodedResoure èµ„æºï¼Œç”¨ ThreadLocal ä¿è¯çº¿ç¨‹å®‰å…¨</li><li><code>if (currentResources == null)</code>ï¼šåˆ¤æ–­ currentResources æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™è¿›è¡Œåˆå§‹åŒ–</li><li><code>if (!currentResources.add(encodedResource))</code>ï¼šå¦‚æœå·²ç»åŠ è½½è¿‡è¯¥èµ„æºä¼šæŠ¥é”™ï¼Œé˜²æ­¢é‡å¤åŠ è½½</li><li><code>inputSource = new InputSource(inputStream)</code>ï¼šèµ„æºå¯¹è±¡åŒ…è£…æˆ InputSourceï¼ŒInputSource æ˜¯ <strong>SAX</strong> ä¸­çš„èµ„æºå¯¹è±¡ï¼Œç”¨æ¥è¿›è¡Œ XML æ–‡ä»¶çš„è§£æ</li><li><code>return doLoadBeanDefinitions()</code>ï¼š<strong>åŠ è½½è¿”å›</strong></li><li><code>currentResources.remove(encodedResource)</code>ï¼šåŠ è½½å®Œæˆç§»é™¤å½“å‰ encodedResource</li><li><code>resourcesCurrentlyBeingLoaded.remove()</code>ï¼šThreadLocal ä¸ºç©ºæ—¶ç§»é™¤å…ƒç´ ï¼Œé˜²æ­¢å†…å­˜æ³„éœ²</li></ul></li><li><p><code>XmlBeanDefinitionReader.doLoadBeanDefinitions(inputSource, resource)</code>ï¼šçœŸæ­£çš„åŠ è½½å‡½æ•°</p><p><code>Document doc = doLoadDocument(inputSource, resource)</code>ï¼šè½¬æ¢æˆæœ‰<strong>å±‚æ¬¡ç»“æ„</strong>çš„ Document å¯¹è±¡</p><ul><li><p><code>getEntityResolver()</code><strong>ï¼šè·å–ç”¨æ¥è§£æ DTDã€XSD çº¦æŸçš„è§£æå™¨</strong></p></li><li><p><code>getValidationModeForResource(resource)</code>ï¼šè·å–éªŒè¯æ¨¡å¼</p></li></ul><p><code>int count = registerBeanDefinitions(doc, resource)</code>ï¼š<strong>å°† Document è§£ææˆ BD å¯¹è±¡ï¼Œæ³¨å†Œï¼ˆæ·»åŠ ï¼‰åˆ° BeanDefinationRegistry ä¸­</strong>ï¼Œè¿”å›æ–°æ³¨å†Œçš„æ•°é‡</p><ul><li><code>createBeanDefinitionDocumentReader()</code>ï¼šåˆ›å»º DefaultBeanDefinitionDocumentReader å¯¹è±¡</li><li><code>getRegistry().getBeanDefinitionCount()</code>ï¼šè·å–è§£æå‰ BeanDefinationRegistry ä¸­çš„ bd æ•°é‡</li><li><code>registerBeanDefinitions(doc, readerContext)</code>ï¼šæ³¨å†Œ BD <ul><li><code>this.readerContext = readerContext</code>ï¼šä¿å­˜ä¸Šä¸‹æ–‡å¯¹è±¡</li><li><code>doRegisterBeanDefinitions(doc.getDocumentElement())</code>ï¼šçœŸæ­£çš„æ³¨å†Œ BD å‡½æ•° <ul><li><code>doc.getDocumentElement()</code>ï¼šæ‹¿å‡ºé¡¶å±‚æ ‡ç­¾ <!----></li></ul></li></ul></li><li><code>return getRegistry().getBeanDefinitionCount() - countBefore</code>ï¼šè¿”å›æ–°åŠ å…¥çš„æ•°é‡</li></ul></li><li><p><code>DefaultBeanDefinitionDocumentReader.doRegisterBeanDefinitions()</code>ï¼šæ³¨å†Œ BD åˆ° BR</p><ul><li><code>createDelegate(getReaderContext(), root, parent)</code>ï¼šbeans æ˜¯æ ‡ç­¾çš„è§£æå™¨å¯¹è±¡</li><li><code>delegate.isDefaultNamespace(root)</code>ï¼šåˆ¤æ–­ beans æ ‡ç­¾æ˜¯å¦æ˜¯é»˜è®¤çš„å±æ€§</li><li><code>root.getAttribute(PROFILE_ATTRIBUTE)</code>ï¼šè§£æ profile å±æ€§</li><li><code>preProcessXml(root)</code>ï¼šè§£æå‰ç½®å¤„ç†ï¼Œè‡ªå®šä¹‰å®ç°</li><li><code>parseBeanDefinitions(root, this.delegate)</code>ï¼š<strong>è§£æ beans æ ‡ç­¾ä¸­çš„å­æ ‡ç­¾</strong><ul><li><code>parseDefaultElement(ele, delegate)</code>ï¼šå¦‚æœæ˜¯é»˜è®¤çš„æ ‡ç­¾ï¼Œç”¨è¯¥æ–¹æ³•è§£æå­æ ‡ç­¾ <ul><li>åˆ¤æ–­æ ‡ç­¾åç§°ï¼Œè¿›è¡Œç›¸åº”çš„è§£æ</li><li><code>processBeanDefinition(ele, delegate)</code>ï¼š</li></ul></li><li><code>delegate.parseCustomElement(ele)</code>ï¼šè§£æè‡ªå®šä¹‰çš„æ ‡ç­¾</li></ul></li><li><code>postProcessXml(root)</code>ï¼šè§£æåç½®å¤„ç†</li></ul></li><li><p><code>DefaultBeanDefinitionDocumentReader.processBeanDefinition()</code>ï¼š<strong>è§£æ bean æ ‡ç­¾å¹¶æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ</strong></p><ul><li><p><code>delegate.parseBeanDefinitionElement(ele)</code>ï¼šè§£æ bean æ ‡ç­¾å°è£…ä¸º BeanDefinitionHolder</p><ul><li><p><code>if (!StringUtils.hasText(beanName) &amp;&amp; !aliases.isEmpty())</code>ï¼šæ¡ä»¶ä¸€æˆç«‹è¯´æ˜ name æ²¡æœ‰å€¼ï¼Œæ¡ä»¶äºŒæˆç«‹è¯´æ˜åˆ«åæœ‰å€¼</p><p><code>beanName = aliases.remove(0)</code>ï¼šæ‹¿åˆ«ååˆ—è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ å½“ä½œ beanName</p></li><li><p><code>parseBeanDefinitionElement(ele, beanName, containingBean)</code>ï¼š<strong>è§£æ bean æ ‡ç­¾</strong></p><ul><li><code>parseState.push(new BeanEntry(beanName))</code>ï¼šå½“å‰è§£æå™¨çš„çŠ¶æ€è®¾ç½®ä¸º BeanEntry</li><li>class å’Œ parent å±æ€§å­˜åœ¨ä¸€ä¸ªï¼Œparent æ˜¯ä½œä¸ºçˆ¶æ ‡ç­¾ä¸ºäº†è¢«ç»§æ‰¿</li><li><code>createBeanDefinition(className, parent)</code>ï¼šè®¾ç½®äº†class çš„ GenericBeanDefinitionå¯¹è±¡</li><li><code>parseBeanDefinitionAttributes()</code>ï¼šè§£æ bean æ ‡ç­¾çš„å±æ€§</li><li>æ¥ä¸‹æ¥è§£æå­æ ‡ç­¾</li></ul></li><li><p><code>beanName = this.readerContext.generateBeanName(beanDefinition)</code>ï¼šç”Ÿæˆ className + # + åºå·çš„åç§°èµ‹å€¼ç»™ beanName</p></li><li><p><code>return new BeanDefinitionHolder(beanDefinition, beanName, aliases)</code>ï¼š<strong>åŒ…è£…æˆ BeanDefinitionHolder</strong></p></li></ul></li><li><p><code>registerBeanDefinition(bdHolder, getReaderContext().getRegistry())</code>ï¼š<strong>æ³¨å†Œåˆ°å®¹å™¨</strong></p><ul><li><code>beanName = definitionHolder.getBeanName()</code>ï¼šè·å–beanName</li><li><code>this.beanDefinitionMap.put(beanName, beanDefinition)</code>ï¼šæ·»åŠ åˆ°æ³¨å†Œä¸­å¿ƒ</li></ul></li><li><p><code>getReaderContext().fireComponentRegistered()</code>ï¼šå‘é€æ³¨å†Œå®Œæˆäº‹ä»¶</p></li></ul></li></ul><p><strong>è¯´æ˜ï¼šæºç éƒ¨åˆ†çš„ç¬”è®°ä¸ä¸€å®šé€‚åˆæ‰€æœ‰äººé˜…è¯»ï¼Œä½œè€…é‡‡ç”¨æµæ°´çº¿å¼å»è§£æé‡è¦çš„ä»£ç ï¼Œè§£æçš„ç»“æ„ç±»ä¼¼äºæ ‘çŠ¶ï¼Œå¦‚æœè§†è§‰ç–²åŠ³å¯ä»¥å»ç½‘ä¸Šå‚è€ƒä¸€äº›åšå®¢å’Œæµç¨‹å›¾å­¦ä¹ æºç ã€‚</strong></p><hr><h3 id="ioc-1" tabindex="-1"><a class="header-anchor" href="#ioc-1" aria-hidden="true">#</a> IOC</h3><h4 id="å®¹å™¨å¯åŠ¨" tabindex="-1"><a class="header-anchor" href="#å®¹å™¨å¯åŠ¨" aria-hidden="true">#</a> å®¹å™¨å¯åŠ¨</h4><p>Spring IOC å®¹å™¨æ˜¯ ApplicationContext æˆ–è€… BeanFactoryï¼Œä½¿ç”¨å¤šä¸ª Map é›†åˆä¿å­˜å•å®ä¾‹ Beanï¼Œç¯å¢ƒä¿¡æ¯ç­‰èµ„æºï¼Œä¸åŒå±‚çº§æœ‰ä¸åŒçš„å®¹å™¨ï¼Œæ¯”å¦‚æ•´åˆ SpringMVC çš„çˆ¶å­å®¹å™¨ï¼ˆå…ˆçœ‹ Bean éƒ¨åˆ†çš„æºç è§£æå†å›çœ‹å®¹å™¨ï¼‰</p><p>ClassPathXmlApplicationContext ä¸ AnnotationConfigApplicationContext å·®ä¸å¤šï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> annotatedClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">register</span><span class="token punctuation">(</span>annotatedClasses<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è§£æé…ç½®ç±»ï¼Œå°è£…æˆä¸€ä¸ª BeanDefinitionHolderï¼Œå¹¶æ³¨å†Œåˆ°å®¹å™¨</span>
    <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// åŠ è½½åˆ·æ–°å®¹å™¨ä¸­çš„ Bean</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">AnnotationConfigApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ³¨å†Œ Spring çš„æ³¨è§£è§£æå™¨åˆ°å®¹å™¨</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AnnotatedBeanDefinitionReader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å®ä¾‹åŒ–è·¯å¾„æ‰«æå™¨ï¼Œç”¨äºå¯¹æŒ‡å®šçš„åŒ…ç›®å½•è¿›è¡Œæ‰«ææŸ¥æ‰¾ bean å¯¹è±¡</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>scanner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathBeanDefinitionScanner</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AbstractApplicationContext.refresh()ï¼š</p><ul><li><p>prepareRefresh()ï¼šåˆ·æ–°å‰çš„<strong>é¢„å¤„ç†</strong></p><ul><li><code>this.startupDate = System.currentTimeMillis()</code>ï¼šè®¾ç½®å®¹å™¨çš„å¯åŠ¨æ—¶é—´</li><li><code>initPropertySources()</code>ï¼šåˆå§‹åŒ–ä¸€äº›å±æ€§è®¾ç½®ï¼Œå¯ä»¥è‡ªå®šä¹‰ä¸ªæ€§åŒ–çš„å±æ€§è®¾ç½®æ–¹æ³•</li><li><code>getEnvironment().validateRequiredProperties()</code>ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡</li><li><code>earlyApplicationEvents= new LinkedHashSet&lt;ApplicationEvent&gt;()</code>ï¼šä¿å­˜å®¹å™¨ä¸­æ—©æœŸçš„äº‹ä»¶</li></ul></li><li><p>obtainFreshBeanFactory()ï¼šè·å–ä¸€ä¸ª<strong>å…¨æ–°çš„ BeanFactory æ¥å£å®ä¾‹</strong>ï¼Œå¦‚æœå®¹å™¨ä¸­å­˜åœ¨å·¥å‚å®ä¾‹ç›´æ¥é”€æ¯</p><p><code>refreshBeanFactory()</code>ï¼šåˆ›å»º BeanFactoryï¼Œè®¾ç½®åºåˆ—åŒ– IDã€è¯»å– BeanDefinition å¹¶åŠ è½½åˆ°å·¥å‚</p><ul><li><code>if (hasBeanFactory())</code>ï¼šapplicationContext å†…éƒ¨æ‹¥æœ‰ä¸€ä¸ª beanFactory å®ä¾‹ï¼Œéœ€è¦å°†è¯¥å®ä¾‹å®Œå…¨é‡Šæ”¾é”€æ¯</li><li><code>destroyBeans()</code>ï¼šé”€æ¯åŸ beanFactory å®ä¾‹ï¼Œå°† beanFactory å†…éƒ¨ç»´æŠ¤çš„å•å®ä¾‹ bean å…¨éƒ¨æ¸…æ‰ï¼Œå¦‚æœå“ªä¸ª bean å®ç°äº† Disposablejieæ¥å£ï¼Œè¿˜ä¼šè¿›è¡Œ bean distroy æ–¹æ³•çš„è°ƒç”¨å¤„ç† <ul><li><code>this.singletonsCurrentlyInDestruction = true</code>ï¼šè®¾ç½®å½“å‰ beanFactory çŠ¶æ€ä¸ºé”€æ¯çŠ¶æ€</li><li><code>String[] disposableBeanNames</code>ï¼šè·å–é”€æ¯é›†åˆä¸­çš„ beanï¼Œå¦‚æœå½“å‰ bean æœ‰<strong>ææ„å‡½æ•°</strong>å°±ä¼šåœ¨é”€æ¯é›†åˆ</li><li><code>destroySingleton(disposableBeanNames[i])</code>ï¼šéå†æ‰€æœ‰çš„ disposableBeansï¼Œæ‰§è¡Œé”€æ¯æ–¹æ³• <ul><li><code>removeSingleton(beanName)</code>ï¼šæ¸…é™¤ä¸‰çº§ç¼“å­˜å’Œ registeredSingletons ä¸­çš„å½“å‰ beanName çš„æ•°æ®</li><li><code>this.disposableBeans.remove(beanName)</code>ï¼šä»é”€æ¯é›†åˆä¸­æ¸…é™¤ï¼Œæ¯ä¸ª bean åªèƒ½ destroy ä¸€æ¬¡</li><li><code>destroyBean(beanName, disposableBean)</code>ï¼šé”€æ¯ bean <ul><li>dependentBeanMap è®°å½•äº†ä¾èµ–å½“å‰ bean çš„å…¶ä»– bean ä¿¡æ¯ï¼Œå› ä¸ºä¾èµ–çš„å¯¹è±¡è¦è¢«å›æ”¶äº†ï¼Œæ‰€ä»¥ä¾èµ–å½“å‰ bean çš„å…¶ä»–å¯¹è±¡éƒ½è¦æ‰§è¡Œ destroySingletonï¼Œéå† dependentBeanMap æ‰§è¡Œé”€æ¯</li><li><code>bean.destroy()</code>ï¼šè§£å†³å®Œæˆä¾èµ–åï¼Œæ‰§è¡Œ DisposableBean çš„ destroy æ–¹æ³•</li><li><code> this.dependenciesForBeanMap.remove(beanName)</code>ï¼šä¿å­˜å½“å‰ bean ä¾èµ–äº†è°ï¼Œç›´æ¥æ¸…é™¤</li></ul></li></ul></li><li>è¿›è¡Œä¸€äº›é›†åˆå’Œç¼“å­˜çš„æ¸…ç†å·¥ä½œ</li></ul></li><li><code>closeBeanFactory()</code>ï¼šå°†å®¹å™¨å†…éƒ¨çš„ beanFactory è®¾ç½®ä¸ºç©ºï¼Œé‡æ–°åˆ›å»º</li><li><code>beanFactory = createBeanFactory()</code>ï¼šåˆ›å»ºæ–°çš„ DefaultListableBeanFactory å¯¹è±¡</li><li><code>beanFactory.setSerializationId(getId())</code>ï¼šè¿›è¡Œ ID çš„è®¾ç½®ï¼Œå¯ä»¥æ ¹æ® ID è·å– BeanFactory å¯¹è±¡</li><li><code>customizeBeanFactory(beanFactory)</code>ï¼šè®¾ç½®æ˜¯å¦å…è®¸è¦†ç›–å’Œå¾ªç¯å¼•ç”¨</li><li><code>loadBeanDefinitions(beanFactory)</code>ï¼š<strong>åŠ è½½ BeanDefinition ä¿¡æ¯ï¼Œæ³¨å†Œ BDæ³¨å†Œåˆ° BeanFactory ä¸­</strong></li><li><code>this.beanFactory = beanFactory</code>ï¼šæŠŠ beanFactory å¡«å……è‡³å®¹å™¨ä¸­</li></ul><p><code>getBeanFactory()</code>ï¼šè¿”å›åˆ›å»ºçš„ DefaultListableBeanFactory å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç»§æ‰¿ BeanDefinitionRegistry</p></li><li><p>prepareBeanFactory(beanFactory)ï¼š<strong>BeanFactory çš„é¢„å‡†å¤‡</strong>å·¥ä½œï¼Œå‘å®¹å™¨ä¸­æ·»åŠ ä¸€äº›ç»„ä»¶</p><ul><li><code>setBeanClassLoader(getClassLoader())</code>ï¼šç»™å½“å‰ bf è®¾ç½®ä¸€ä¸ª<strong>ç±»åŠ è½½å™¨</strong>ï¼ŒåŠ è½½ bd çš„ class ä¿¡æ¯</li><li><code>setBeanExpressionResolver()</code>ï¼šè®¾ç½® EL è¡¨è¾¾å¼è§£æå™¨</li><li><code>addPropertyEditorRegistrar</code>ï¼šæ·»åŠ ä¸€ä¸ªå±æ€§ç¼–è¾‘å™¨ï¼Œè§£å†³å±æ€§æ³¨å…¥æ—¶çš„æ ¼å¼è½¬æ¢</li><li><code>addBeanPostProcessor()</code>ï¼šæ·»åŠ åå¤„ç†å™¨ï¼Œä¸»è¦ç”¨äºå‘ bean å†…éƒ¨æ³¨å…¥ä¸€äº›æ¡†æ¶çº§åˆ«çš„å®ä¾‹</li><li><code>ignoreDependencyInterface()</code>ï¼šè®¾ç½®å¿½ç•¥è‡ªåŠ¨è£…é…çš„æ¥å£ï¼Œbean å†…éƒ¨çš„è¿™äº›ç±»å‹çš„å­—æ®µ ä¸å‚ä¸ä¾èµ–æ³¨å…¥</li><li><code>registerResolvableDependency()</code>ï¼šæ³¨å†Œä¸€äº›ç±»å‹ä¾èµ–å…³ç³»</li><li><code>addBeanPostProcessor()</code>ï¼šå°†é…ç½®çš„ç›‘å¬è€…æ³¨å†Œåˆ°å®¹å™¨ä¸­ï¼Œå½“å‰ bean å®ç° ApplicationListener æ¥å£å°±æ˜¯ç›‘å¬å™¨äº‹ä»¶</li><li><code>beanFactory.registerSingleton()</code>ï¼šæ·»åŠ ä¸€äº›ç³»ç»Ÿä¿¡æ¯</li></ul></li><li><p>postProcessBeanFactory(beanFactory)ï¼šBeanFactory å‡†å¤‡å·¥ä½œå®Œæˆåè¿›è¡Œçš„åç½®å¤„ç†å·¥ä½œï¼Œæ‰©å±•æ–¹æ³•</p></li><li><p>invokeBeanFactoryPostProcessors(beanFactory)ï¼š<strong>æ‰§è¡Œ BeanFactoryPostProcessor çš„æ–¹æ³•</strong></p><ul><li><p><code>processedBeans = new HashSet&lt;&gt;()</code>ï¼šå­˜å‚¨å·²ç»æ‰§è¡Œè¿‡çš„ BeanFactoryPostProcessor çš„ beanName</p></li><li><p><code>if (beanFactory instanceof BeanDefinitionRegistry)</code>ï¼š<strong>å½“å‰ BeanFactory æ˜¯ bd çš„æ³¨å†Œä¸­å¿ƒï¼Œbd å…¨éƒ¨æ³¨å†Œåˆ° bf</strong></p></li><li><p><code>for (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors)</code>ï¼šéå†æ‰€æœ‰çš„ bf åç½®å¤„ç†å™¨</p></li><li><p><code>if (postProcessor instanceof BeanDefinitionRegistryPostProcessor)</code>ï¼šæ˜¯ Registry ç±»çš„åç½®å¤„ç†å™¨</p><p><code>registryProcessor.postProcessBeanDefinitionRegistry(registry)</code>ï¼šå‘ bf ä¸­æ³¨å†Œä¸€äº› bd</p><p><code>registryProcessors.add(registryProcessor)</code>ï¼šæ·»åŠ åˆ° BeanDefinitionRegistryPostProcessor é›†åˆ</p></li><li><p><code>regularPostProcessors.add(postProcessor)</code>ï¼šæ·»åŠ åˆ° BeanFactoryPostProcessor é›†åˆ</p></li><li><p>é€»è¾‘åˆ°è¿™é‡Œå·²ç»è·å–åˆ°æ‰€æœ‰ BeanDefinitionRegistryPostProcessor å’Œ BeanFactoryPostProcessor æ¥å£ç±»å‹çš„åç½®å¤„ç†å™¨</p></li><li><p><strong>é¦–å…ˆå›è°ƒ BeanDefinitionRegistryPostProcessor ç±»çš„åç½®å¤„ç†æ–¹æ³• postProcessBeanDefinitionRegistry()</strong></p><ul><li><p>è·å–å®ç°äº† PriorityOrderedï¼ˆä¸»æ’åºæ¥å£ï¼‰æ¥å£çš„ bdrppï¼Œè¿›è¡Œ sort æ’åºï¼Œç„¶åå…¨éƒ¨æ‰§è¡Œå¹¶æ”¾å…¥å·²ç»å¤„ç†è¿‡çš„é›†åˆ</p></li><li><p>å†æ‰§è¡Œå®ç°äº† Orderedï¼ˆæ¬¡æ’åºæ¥å£ï¼‰æ¥å£çš„ bdrpp</p></li><li><p>æœ€åæ‰§è¡Œæ²¡æœ‰å®ç°ä»»ä½•ä¼˜å…ˆçº§æˆ–è€…æ˜¯é¡ºåºæ¥å£ bdrppï¼Œ<code>boolean reiterate = true</code> æ§åˆ¶ while æ˜¯å¦éœ€è¦å†æ¬¡å¾ªç¯ï¼Œå¾ªç¯å†…æ˜¯æŸ¥æ‰¾å¹¶æ‰§è¡Œ bdrpp åå¤„ç†å™¨çš„ registry ç›¸å…³çš„æ¥å£æ–¹æ³•ï¼Œæ¥å£æ–¹æ³•æ‰§è¡Œä»¥åä¼šå‘ bf å†…æ³¨å†Œ bdï¼Œæ³¨å†Œçš„ bd ä¹Ÿæœ‰å¯èƒ½æ˜¯ bdrpp ç±»å‹ï¼Œæ‰€ä»¥éœ€è¦è¯¥å˜é‡æ§åˆ¶å¾ªç¯</p></li><li><p><code>processedBeans.add(ppName)</code>ï¼šå·²ç»æ‰§è¡Œè¿‡çš„åç½®å¤„ç†å™¨å­˜å‚¨åˆ°è¯¥é›†åˆä¸­ï¼Œé˜²æ­¢é‡å¤æ‰§è¡Œ</p></li><li><p><code> invokeBeanFactoryPostProcessors()</code>ï¼šbdrpp ç»§æ‰¿äº† BeanFactoryPostProcessorï¼Œæœ‰ postProcessBeanFactory æ–¹æ³•</p></li></ul></li><li><p><strong>æ‰§è¡Œæ™®é€š BeanFactoryPostProcessor çš„ç›¸å…³ postProcessBeanFactory æ–¹æ³•ï¼ŒæŒ‰ç…§ä¸»æ¬¡æ— æ¬¡åºæ‰§è¡Œ</strong></p><ul><li><code>if (processedBeans.contains(ppName))</code>ï¼šä¼šè¿‡æ»¤æ‰å·²ç»æ‰§è¡Œè¿‡çš„åç½®å¤„ç†å™¨</li></ul></li><li><p><code>beanFactory.clearMetadataCache()</code>ï¼šæ¸…é™¤ç¼“å­˜ä¸­åˆå¹¶çš„ Bean å®šä¹‰ï¼Œå› ä¸ºåç½®å¤„ç†å™¨å¯èƒ½æ›´æ”¹äº†å…ƒæ•°æ®</p></li></ul></li></ul><p><strong>ä»¥ä¸Šæ˜¯ BeanFactory çš„åˆ›å»ºåŠé¢„å‡†å¤‡å·¥ä½œï¼Œæ¥ä¸‹æ¥è¿›å…¥ Bean çš„æµç¨‹</strong></p><ul><li><p>registerBeanPostProcessors(beanFactory)ï¼š<strong>æ³¨å†Œ Bean çš„åç½®å¤„ç†å™¨</strong>ï¼Œä¸ºäº†å¹²é¢„ Spring åˆå§‹åŒ– bean çš„æµç¨‹ï¼Œè¿™é‡Œä»…ä»…æ˜¯å‘å®¹å™¨ä¸­<strong>æ³¨å…¥è€Œéä½¿ç”¨</strong></p><ul><li><p><code>beanFactory.getBeanNamesForType(BeanPostProcessor.class)</code>ï¼š<strong>è·å–é…ç½®ä¸­å®ç°äº† BeanPostProcessor æ¥å£ç±»å‹</strong></p></li><li><p><code>int beanProcessorTargetCount</code>ï¼šåç½®å¤„ç†å™¨çš„æ•°é‡ï¼Œå·²ç»æ³¨å†Œçš„ + æœªæ³¨å†Œçš„ + å³å°†è¦æ·»åŠ çš„ä¸€ä¸ª</p></li><li><p><code>beanFactory.addBeanPostProcessor(new BeanPostProcessorChecker())</code>ï¼šæ·»åŠ ä¸€ä¸ªæ£€æŸ¥å™¨</p><p><code>BeanPostProcessorChecker.postProcessAfterInitialization()</code>ï¼šåˆå§‹åŒ–åçš„åå¤„ç†å™¨æ–¹æ³•</p><ul><li><code>!(bean instanceof BeanPostProcessor) </code>ï¼šå½“å‰ bean ç±»å‹æ˜¯æ™®é€š beanï¼Œä¸æ˜¯åç½®å¤„ç†å™¨</li><li><code>!isInfrastructureBean(beanName)</code>ï¼šæˆç«‹è¯´æ˜å½“å‰ beanName æ˜¯ç”¨æˆ·çº§åˆ«çš„ bean ä¸æ˜¯ Spring æ¡†æ¶çš„</li><li><code>this.beanFactory.getBeanPostProcessorCount() &lt; this.beanPostProcessorTargetCount</code>ï¼šBeanFactory ä¸Šé¢æ³¨å†Œåå¤„ç†å™¨æ•°é‡ &lt; åå¤„ç†å™¨æ•°é‡ï¼Œè¯´æ˜åå¤„ç†æ¡†æ¶å°šæœªåˆå§‹åŒ–å®Œæˆ</li></ul></li><li><p><code>for (String ppName : postProcessorNames)</code>ï¼šéå† PostProcessor é›†åˆï¼Œ<strong>æ ¹æ®å®ç°ä¸åŒçš„é¡ºåºæ¥å£æ·»åŠ åˆ°ä¸åŒé›†åˆ</strong></p></li><li><p><code>sortPostProcessors(priorityOrderedPostProcessors, beanFactory)</code>ï¼šå®ç° PriorityOrdered æ¥å£çš„åå¤„ç†å™¨æ’åº</p><p><code>registerBeanPostProcessors(beanFactory, priorityOrderedPostProcessors)</code>ï¼š<strong>æ³¨å†Œåˆ° beanFactory ä¸­</strong></p></li><li><p>æ¥ç€æ’åºæ³¨å†Œå®ç° Ordered æ¥å£çš„åç½®å¤„ç†å™¨ï¼Œç„¶åæ³¨å†Œæ™®é€šçš„ï¼ˆ æ²¡æœ‰å®ç°ä»»ä½•ä¼˜å…ˆçº§æ¥å£ï¼‰åç½®å¤„ç†å™¨</p></li><li><p>æœ€åæ’åº MergedBeanDefinitionPostProcessor ç±»å‹çš„å¤„ç†å™¨ï¼Œæ ¹æ®å®ç°çš„æ’åºæ¥å£ï¼Œæ’åºå®Œæ³¨å†Œåˆ° beanFactory ä¸­</p></li><li><p><code>beanFactory.addBeanPostProcessor(new ApplicationListenerDetector(applicationContext))</code>ï¼šé‡æ–°æ³¨å†Œ ApplicationListenerDetector åå¤„ç†å™¨ï¼Œç”¨äºåœ¨ Bean åˆ›å»ºå®Œæˆåæ£€æŸ¥æ˜¯å¦å±äº ApplicationListener ç±»å‹ï¼Œå¦‚æœæ˜¯å°±æŠŠ Bean æ”¾åˆ°<strong>ç›‘å¬å™¨å®¹å™¨</strong>ä¸­ä¿å­˜èµ·æ¥</p></li></ul></li><li><p>initMessageSource()ï¼šåˆå§‹åŒ– MessageSource ç»„ä»¶ï¼Œä¸»è¦ç”¨äºåšå›½é™…åŒ–åŠŸèƒ½ï¼Œæ¶ˆæ¯ç»‘å®šä¸æ¶ˆæ¯è§£æ</p><ul><li><code>if (beanFactory.containsLocalBean(MESSAGE_SOURCE_BEAN_NAME))</code>ï¼šå®¹å™¨æ˜¯å¦å«æœ‰åç§°ä¸º messageSource çš„ bean</li><li><code>beanFactory.getBean(MESSAGE_SOURCE_BEAN_NAME, MessageSource.class)</code>ï¼šå¦‚æœæœ‰è¯æ˜ç”¨æˆ·è‡ªå®šä¹‰äº†è¯¥ç±»å‹çš„ beanï¼Œè·å–åç›´æ¥èµ‹å€¼ç»™ this.messageSource</li><li><code>dms = new DelegatingMessageSource()</code>ï¼šå®¹å™¨ä¸­æ²¡æœ‰å°±æ–°å»ºä¸€ä¸ªèµ‹å€¼</li></ul></li><li><p>initApplicationEventMulticaster()ï¼š<strong>åˆå§‹åŒ–äº‹ä»¶ä¼ æ’­å™¨</strong>ï¼Œåœ¨æ³¨å†Œç›‘å¬å™¨æ—¶ä¼šç”¨åˆ°</p><ul><li><code>if (beanFactory.containsLocalBean(APPLICATION_EVENT_MULTICASTER_BEAN_NAME))</code>ï¼š<strong>æ¡ä»¶æˆç«‹è¯´æ˜ç”¨æˆ·è‡ªå®šä¹‰äº†äº‹ä»¶ä¼ æ’­å™¨</strong>ï¼Œå¯ä»¥å®ç° ApplicationEventMulticaster æ¥å£ç¼–å†™è‡ªå·±çš„äº‹ä»¶ä¼ æ’­å™¨ï¼Œé€šè¿‡ bean çš„æ–¹å¼æä¾›ç»™ Spring</li><li>å¦‚æœæœ‰å°±ç›´æ¥ä»å®¹å™¨ä¸­è·å–ï¼›å¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ª SimpleApplicationEventMulticaster æ³¨å†Œ</li></ul></li><li><p>onRefresh()ï¼šç•™ç»™ç”¨æˆ·å»å®ç°ï¼Œå¯ä»¥ç¡¬ç¼–ç æä¾›ä¸€äº›ç»„ä»¶ï¼Œæ¯”å¦‚æä¾›ä¸€äº›ç›‘å¬å™¨</p></li><li><p>registerListeners()ï¼šæ³¨å†Œé€šè¿‡é…ç½®æä¾›çš„ Listenerï¼Œè¿™äº›<strong>ç›‘å¬å™¨</strong>æœ€ç»ˆæ³¨å†Œåˆ° ApplicationEventMulticaster å†…</p><ul><li><p><code>for (ApplicationListener&lt;?&gt; listener : getApplicationListeners()) </code>ï¼šæ³¨å†Œç¼–ç å®ç°çš„ç›‘å¬å™¨</p></li><li><p><code>getBeanNamesForType(ApplicationListener.class, true, false)</code>ï¼šæ³¨å†Œé€šè¿‡é…ç½®æä¾›çš„ Listener</p></li><li><p><code>multicastEvent(earlyEvent)</code>ï¼š<strong>å‘å¸ƒå‰é¢æ­¥éª¤äº§ç”Ÿçš„äº‹ä»¶ applicationEvents</strong></p><p><code>Executor executor = getTaskExecutor()</code>ï¼šè·å–çº¿ç¨‹æ± ï¼Œæœ‰çº¿ç¨‹æ± å°±å¼‚æ­¥æ‰§è¡Œï¼Œæ²¡æœ‰å°±åŒæ­¥æ‰§è¡Œ</p></li></ul></li><li><p>finishBeanFactoryInitialization()ï¼š<strong>å®ä¾‹åŒ–éæ‡’åŠ è½½çŠ¶æ€çš„å•å®ä¾‹</strong></p><ul><li><p><code>beanFactory.freezeConfiguration()</code>ï¼š<strong>å†»ç»“é…ç½®ä¿¡æ¯</strong>ï¼Œå°±æ˜¯å†»ç»“ BD ä¿¡æ¯ï¼Œå†»ç»“åæ— æ³•å†å‘ bf å†…æ³¨å†Œ bd</p></li><li><p><code>beanFactory.preInstantiateSingletons()</code>ï¼šå®ä¾‹åŒ– non-lazy-init singletons</p><ul><li><p><code>for (String beanName : beanNames)</code>ï¼šéå†å®¹å™¨å†…æ‰€æœ‰çš„ beanDefinitionNames</p></li><li><p><code>getMergedLocalBeanDefinition(beanName)</code>ï¼šè·å–ä¸çˆ¶ç±»åˆå¹¶åçš„å¯¹è±¡ï¼ˆBean â†’ è·å–æµç¨‹éƒ¨åˆ†è¯¦è§£æ­¤å‡½æ•°ï¼‰</p></li><li><p><code>if (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit())</code>ï¼šBD å¯¹åº”çš„ Class æ»¡è¶³éæŠ½è±¡ã€å•å®ä¾‹ï¼Œéæ‡’åŠ è½½ï¼Œéœ€è¦é¢„å…ˆå®ä¾‹åŒ–</p><p><code>if (isFactoryBean(beanName))</code>ï¼šBD å¯¹åº”çš„ Class æ˜¯ factoryBean å¯¹è±¡</p><ul><li><code>getBean(FACTORY_BEAN_PREFIX + beanName)</code>ï¼šè·å–å·¥å‚ FactoryBean å®ä¾‹æœ¬èº«</li><li><code>isEagerInit</code>ï¼šæ§åˆ¶ FactoryBean å†…éƒ¨ç®¡ç†çš„ Bean æ˜¯å¦ä¹Ÿåˆå§‹åŒ–</li><li><code>getBean(beanName)</code>ï¼š<strong>åˆå§‹åŒ– Beanï¼Œè·å– Bean è¯¦è§£æ­¤å‡½æ•°</strong></li></ul><p><code>getBean(beanName)</code>ï¼šä¸æ˜¯å·¥å‚ bean ç›´æ¥è·å–</p></li><li><p><code>for (String beanName : beanNames)</code>ï¼šæ£€æŸ¥æ‰€æœ‰çš„ Bean æ˜¯å¦å®ç° SmartInitializingSingleton æ¥å£ï¼Œå®ç°äº†å°±æ‰§è¡Œ afterSingletonsInstantiated()ï¼Œè¿›è¡Œä¸€äº›åˆ›å»ºåçš„æ“ä½œ</p></li></ul></li></ul></li><li><p><code>finishRefresh()</code>ï¼šå®Œæˆåˆ·æ–°ååšçš„ä¸€äº›äº‹æƒ…ï¼Œä¸»è¦æ˜¯å¯åŠ¨ç”Ÿå‘½å‘¨æœŸ</p><ul><li><code>clearResourceCaches()</code>ï¼šæ¸…ç©ºä¸Šä¸‹æ–‡ç¼“å­˜</li><li><code>initLifecycleProcessor()</code>ï¼š<strong>åˆå§‹åŒ–å’Œç”Ÿå‘½å‘¨æœŸæœ‰å…³çš„åç½®å¤„ç†å™¨</strong>ï¼Œå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸ <ul><li><code>if (beanFactory.containsLocalBean(LIFECYCLE_PROCESSOR_BEAN_NAME))</code>ï¼šæˆç«‹è¯´æ˜è‡ªå®šä¹‰äº†ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨</li><li><code>defaultProcessor = new DefaultLifecycleProcessor()</code>ï¼šSpring é»˜è®¤æä¾›çš„ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨</li><li><code> beanFactory.registerSingleton()</code>ï¼šå°†ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨æ³¨å†Œåˆ° bf çš„ä¸€çº§ç¼“å­˜å’Œæ³¨å†Œå•ä¾‹é›†åˆä¸­</li></ul></li><li><code>getLifecycleProcessor().onRefresh()</code>ï¼šè·å–è¯¥<strong>ç”Ÿå‘½å‘¨æœŸåç½®å¤„ç†å™¨å›è°ƒ onRefresh()</strong>ï¼Œè°ƒç”¨ <code>startBeans(true)</code><ul><li><code>lifecycleBeans = getLifecycleBeans()</code>ï¼šè·å–åˆ°æ‰€æœ‰å®ç°äº† Lifecycle æ¥å£çš„å¯¹è±¡åŒ…è£…åˆ° Map å†…ï¼Œkey æ˜¯beanNameï¼Œ value æ˜¯ Lifecycle å¯¹è±¡</li><li><code>int phase = getPhase(bean)</code>ï¼šè·å–å½“å‰ Lifecycle çš„ phase å€¼ï¼Œå½“å‰ç”Ÿå‘½å‘¨æœŸå¯¹è±¡å¯èƒ½ä¾èµ–å…¶ä»–ç”Ÿå‘½å‘¨æœŸå¯¹è±¡çš„æ‰§è¡Œç»“æœï¼Œæ‰€ä»¥éœ€è¦ phase å†³å®šæ‰§è¡Œé¡ºåºï¼Œæ•°å€¼è¶Šä½çš„ä¼˜å…ˆæ‰§è¡Œ</li><li><code>LifecycleGroup group = phases.get(phase)</code>ï¼šæŠŠ phsae ç›¸åŒçš„ Lifecycle å­˜å…¥ LifecycleGroup</li><li><code>if (group == null)</code>ï¼šgroup ä¸ºç©ºåˆ™åˆ›å»ºï¼Œåˆå§‹æƒ…å†µä¸‹æ˜¯ç©ºçš„</li><li><code>group.add(beanName, bean)</code>ï¼šå°†å½“å‰ Lifecycle æ·»åŠ åˆ°å½“å‰ phase å€¼ä¸€æ ·çš„ group å†…</li><li><code>Collections.sort(keys)</code>ï¼š<strong>ä»å°åˆ°å¤§æ’åºï¼ŒæŒ‰ä¼˜å…ˆçº§å¯åŠ¨</strong></li><li><code>phases.get(key).start()</code>ï¼šéå†æ‰€æœ‰çš„ Lifecycle å¯¹è±¡å¼€å§‹å¯åŠ¨</li><li><code>doStart(this.lifecycleBeans, member.name, this.autoStartupOnly)</code>ï¼šåº•å±‚è°ƒç”¨è¯¥æ–¹æ³•å¯åŠ¨ <ul><li><code>bean = lifecycleBeans.remove(beanName)</code>ï¼š ç¡®ä¿ Lifecycle åªè¢«å¯åŠ¨ä¸€æ¬¡ï¼Œåœ¨ä¸€ä¸ªåˆ†ç»„å†…è¢«å¯åŠ¨äº†åœ¨å…¶ä»–åˆ†ç»„å†…å°±çœ‹ä¸åˆ° Lifecycle äº†</li><li><code>dependenciesForBean = getBeanFactory().getDependenciesForBean(beanName)</code>ï¼šè·å–å½“å‰å³å°†è¢«å¯åŠ¨çš„ Lifecycle æ‰€ä¾èµ–çš„å…¶ä»– beanNameï¼Œéœ€è¦<strong>å…ˆå¯åŠ¨æ‰€ä¾èµ–çš„ bean</strong>ï¼Œæ‰èƒ½å¯åŠ¨è‡ªèº«</li><li><code>if ()</code>ï¼šä¼ å…¥çš„å‚æ•° autoStartupOnly ä¸º true è¡¨ç¤ºå¯åŠ¨ isAutoStartUp ä¸º true çš„ SmartLifecycle å¯¹è±¡ï¼Œä¸ä¼šå¯åŠ¨æ™®é€šçš„ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡ï¼›false ä»£è¡¨å…¨éƒ¨å¯åŠ¨</li><li>bean.start()ï¼š<strong>è°ƒç”¨å¯åŠ¨æ–¹æ³•</strong></li></ul></li></ul></li><li><code>publishEvent(new ContextRefreshedEvent(this))</code>ï¼š<strong>å‘å¸ƒå®¹å™¨åˆ·æ–°å®Œæˆäº‹ä»¶</strong></li><li><code>liveBeansView.registerApplicationContext(this)</code>ï¼šæš´éœ² Mbean</li></ul></li></ul><p>è¡¥å……ç”Ÿå‘½å‘¨æœŸ stop() æ–¹æ³•çš„è°ƒç”¨</p><ul><li><p>DefaultLifecycleProcessor.stop()ï¼šè°ƒç”¨ DefaultLifecycleProcessor.stopBeans()</p><ul><li><p>è·å–åˆ°æ‰€æœ‰å®ç°äº† Lifecycle æ¥å£çš„å¯¹è±¡å¹¶æŒ‰ phase æ•°å€¼åˆ†ç»„çš„</p></li><li><p><code>keys.sort(Collections.reverseOrder())</code>ï¼šæŒ‰ phase é™åºæ’åº Lifecycle æ¥å£ï¼Œæœ€å…ˆå¯åŠ¨çš„æœ€æ™šå…³é—­ï¼ˆè´£ä»»é“¾ï¼Ÿï¼‰</p></li><li><p><code>phases.get(key).stop()</code>ï¼šéå†æ‰€æœ‰çš„ Lifecycle å¯¹è±¡å¼€å§‹åœæ­¢</p><ul><li><p><code>latch = new CountDownLatch(this.smartMemberCount)</code>ï¼šåˆ›å»º CountDownLatchï¼Œè®¾ç½® latch å†…éƒ¨çš„å€¼ä¸ºå½“å‰åˆ†ç»„å†…çš„ smartMemberCount çš„æ•°é‡</p></li><li><p><code>countDownBeanNames = Collections.synchronizedSet(new LinkedHashSet&lt;&gt;())</code>ï¼šä¿å­˜å½“å‰æ­£åœ¨å¤„ç†å…³é—­çš„smartLifecycle çš„ BeanName</p></li><li><p><code>for (LifecycleGroupMember member : this.members)</code>ï¼šå¤„ç†æœ¬åˆ†ç»„å†…éœ€è¦å…³é—­çš„ Lifecycle</p><p><code>doStop(this.lifecycleBeans, member.name, latch, countDownBeanNames)</code>ï¼šçœŸæ­£çš„åœæ­¢æ–¹æ³•</p><ul><li><p><code>getBeanFactory().getDependentBeans(beanName)</code>ï¼š<strong>è·å–ä¾èµ–å½“å‰ Lifecycle çš„å…¶ä»–å¯¹è±¡çš„ beanName</strong>ï¼Œå› ä¸ºå½“å‰çš„ Lifecycle å³å°†è¦å…³é—­äº†ï¼Œæ‰€æœ‰çš„ä¾èµ–äº†å½“å‰ Lifecycle çš„ bean ä¹Ÿè¦å…³é—­</p></li><li><p><code>countDownBeanNames.add(beanName)</code>ï¼šå°†å½“å‰ SmartLifecycle beanName æ·»åŠ åˆ° countDownBeanNames é›†åˆå†…ï¼Œè¯¥é›†åˆè¡¨ç¤ºæ­£åœ¨å…³é—­çš„ SmartLifecycle</p></li><li><p><code>bean.stop()</code>ï¼šè°ƒç”¨åœæ­¢çš„æ–¹æ³•</p></li></ul></li></ul></li></ul></li></ul><hr><h4 id="è·å–bean-1" tabindex="-1"><a class="header-anchor" href="#è·å–bean-1" aria-hidden="true">#</a> è·å–Bean</h4><p>å•å®ä¾‹ï¼šåœ¨å®¹å™¨å¯åŠ¨æ—¶åˆ›å»ºå¯¹è±¡</p><p>å¤šå®ä¾‹ï¼šåœ¨æ¯æ¬¡è·å–çš„æ—¶å€™åˆ›å»ºå¯¹è±¡</p><p>è·å–æµç¨‹ï¼š<strong>è·å– Bean æ—¶å…ˆä»å•ä¾‹æ± è·å–ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›è¡Œç¬¬äºŒæ¬¡è·å–ï¼Œå¹¶å¸¦ä¸Šå·¥å‚ç±»å»åˆ›å»ºå¹¶æ·»åŠ è‡³å•ä¾‹æ± </strong></p><p>Java å¯åŠ¨ Spring ä»£ç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ApplicationContext</span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassPathXmlApplicationContext</span><span class="token punctuation">(</span><span class="token string">&quot;applicationContext.xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token string">&quot;userService&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>AbstractBeanFactory.doGetBean()ï¼šè·å– Beanï¼Œcontext.getBean() è¿½è¸ªåˆ°æ­¤</p><ul><li><p><code>beanName = transformedBeanName(name)</code>ï¼šname å¯èƒ½æ˜¯ä¸€ä¸ªåˆ«åï¼Œé‡å®šå‘å‡ºæ¥çœŸå® beanNameï¼›ä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ª &amp; å¼€å¤´çš„ nameï¼Œè¯´æ˜è¦è·å–çš„ bean å®ä¾‹å¯¹è±¡ï¼Œæ˜¯ä¸€ä¸ª FactoryBean å¯¹è±¡ï¼ˆIOC åŸç† â†’ æ ¸å¿ƒç±»ï¼‰</p><ul><li><code>BeanFactoryUtils.transformedBeanName(name)</code>ï¼šåˆ¤æ–­æ˜¯å“ªç§ nameï¼Œè¿”å›æˆªå– &amp; ä»¥åçš„ name å¹¶æ”¾å…¥ç¼“å­˜ <ul><li><code>transformedBeanNameCache.computeIfAbsent</code>ï¼šç¼“å­˜æ˜¯å¹¶å‘å®‰å…¨é›†åˆï¼Œkey == null || value == null æ—¶ put æˆåŠŸ</li><li>do while å¾ªç¯ä¸€ç›´å»é™¤ &amp; ç›´åˆ°ä¸å†å«æœ‰ &amp;</li></ul></li><li><code>canonicalName(name)</code>ï¼šaliasMap ä¿å­˜åˆ«åä¿¡æ¯ï¼Œå…¶ä¸­çš„ do while é€»è¾‘æ˜¯è¿­ä»£æŸ¥æ‰¾ï¼Œæ¯”å¦‚ A åˆ«åå«åš Bï¼Œä½†æ˜¯ B åˆæœ‰åˆ«åå« Cï¼Œ aliasMap ä¸º {&quot;C&quot;:&quot;B&quot;, &quot;B&quot;:&quot;A&quot;}ï¼Œget(C) æœ€åè¿”å›çš„æ˜¯ A</li></ul></li><li><p><code>DefaultSingletonBeanRegistry.getSingleton()</code>ï¼š<strong>ç¬¬ä¸€æ¬¡è·å–ä»ç¼“å­˜æ± è·å–</strong>ï¼ˆå¾ªç¯ä¾èµ–è¯¦è§£æ­¤ä»£ç ï¼‰</p><ul><li>ç¼“å­˜ä¸­æœ‰æ•°æ®è¿›è¡Œ getObjectForBeanInstance() è·å–å¯ä½¿ç”¨çš„ Beanï¼ˆæœ¬èŠ‚ç»“æŸéƒ¨åˆ†è¯¦è§£æ­¤å‡½æ•°ï¼‰</li><li>ç¼“å­˜ä¸­æ²¡æœ‰æ•°æ®è¿›è¡Œä¸‹é¢çš„é€»è¾‘è¿›è¡Œåˆ›å»º</li></ul></li><li><p><code>if(isPrototypeCurrentlyInCreation(beanName))</code>ï¼šæ£€æŸ¥ bean æ˜¯å¦åœ¨åŸå‹ï¼ˆPrototypeï¼‰æ­£åœ¨è¢«åˆ›å»ºçš„é›†åˆä¸­ï¼Œå¦‚æœæ˜¯å°±æŠ¥é”™ï¼Œè¯´æ˜äº§ç”Ÿäº†å¾ªç¯ä¾èµ–ï¼Œ<strong>åŸå‹æ¨¡å¼è§£å†³ä¸äº†å¾ªç¯ä¾èµ–</strong></p><p>åŸå› ï¼šå…ˆåŠ è½½ Aï¼ŒæŠŠ A åŠ å…¥é›†åˆï¼ŒA ä¾èµ– B å»åŠ è½½ Bï¼ŒB åˆä¾èµ– Aï¼Œå»åŠ è½½ Aï¼Œå‘ç° A åœ¨æ­£åœ¨åˆ›å»ºé›†åˆä¸­ï¼Œäº§ç”Ÿå¾ªç¯ä¾èµ–</p></li><li><p><code>markBeanAsCreated(beanName)</code>ï¼šæŠŠ bean æ ‡è®°ä¸ºå·²ç»åˆ›å»ºï¼Œ<strong>é˜²æ­¢å…¶ä»–çº¿ç¨‹é‡æ–°åˆ›å»º Bean</strong></p></li><li><p><code>mbd = getMergedLocalBeanDefinition(beanName)</code>ï¼š<strong>è·å–åˆå¹¶çˆ¶ BD åçš„ BD å¯¹è±¡</strong>ï¼ŒBD æ˜¯ç›´æ¥ç»§æ‰¿çš„ï¼Œåˆå¹¶åçš„ BD ä¿¡æ¯æ˜¯åŒ…å«çˆ¶ç±»çš„ BD ä¿¡æ¯</p><ul><li><p><code>this.mergedBeanDefinitions.get(beanName)</code>ï¼šä»ç¼“å­˜ä¸­è·å–</p></li><li><p><code>if(bd.getParentName()==null)</code>ï¼šbeanName å¯¹åº” BD æ²¡æœ‰çˆ¶ BD å°±ä¸ç”¨å¤„ç†ç»§æ‰¿ï¼Œå°è£…ä¸º RootBeanDefinition è¿”å›</p></li><li><p><code>parentBeanName = transformedBeanName(bd.getParentName())</code>ï¼šå¤„ç†çˆ¶ BD çš„ name ä¿¡æ¯</p></li><li><p><code>if(!beanName.equals(parentBeanName))</code>ï¼šä¸€èˆ¬æƒ…å†µçˆ¶å­ BD çš„åç§°ä¸åŒ</p><p><code>pbd = getMergedBeanDefinition(parentBeanName)</code>ï¼šé€’å½’è°ƒç”¨ï¼Œæœ€ç»ˆè¿”å›çˆ¶ BD çš„çˆ¶ BD ä¿¡æ¯</p></li><li><p><code>mbd = new RootBeanDefinition(pbd)</code>ï¼šæŒ‰ç…§çˆ¶ BD ä¿¡æ¯åˆ›å»º RootBeanDefinition å¯¹è±¡</p></li><li><p><code>mbd.overrideFrom(bd)</code>ï¼š<strong>å­ BD ä¿¡æ¯è¦†ç›– mbd</strong>ï¼Œå› ä¸ºæ˜¯è¦ä»¥å­ BD ä¸ºåŸºå‡†ï¼Œä¸å­˜åœ¨çš„æ‰å»çˆ¶ BD å¯»æ‰¾ï¼ˆ<strong>ç±»ä¼¼ Java ç»§æ‰¿</strong>ï¼‰</p></li><li><p><code>this.mergedBeanDefinitions.put(beanName, mbd)</code>ï¼šæ”¾å…¥ç¼“å­˜</p></li></ul></li><li><p><code>checkMergedBeanDefinition()</code>ï¼šåˆ¤æ–­å½“å‰ BD æ˜¯å¦ä¸º<strong>æŠ½è±¡ BD</strong>ï¼ŒæŠ½è±¡ BD ä¸èƒ½åˆ›å»ºå®ä¾‹ï¼Œåªèƒ½ä½œä¸ºçˆ¶ BD è¢«ç»§æ‰¿</p></li><li><p><code>mbd.getDependsOn()</code>ï¼šè·å– bean æ ‡ç­¾ depends-on</p></li><li><p><code>if(dependsOn != null)</code>ï¼š<strong>éå†æ‰€æœ‰çš„ä¾èµ–åŠ è½½ï¼Œè§£å†³ä¸äº†å¾ªç¯ä¾èµ–</strong></p><p><code>isDependent(beanName, dep)</code>ï¼šåˆ¤æ–­å¾ªç¯ä¾èµ–ï¼Œå‡ºç°å¾ªç¯ä¾èµ–é—®é¢˜æŠ¥é”™</p><ul><li><p>ä¸¤ä¸ª Mapï¼š<code>&lt;bean name=&quot;A&quot; depends-on=&quot;B&quot; ...&gt;</code></p><ul><li>dependentBeanMapï¼šè®°å½•ä¾èµ–äº†å½“å‰ beanName çš„å…¶ä»– beanNameï¼ˆè°ä¾èµ–æˆ‘ï¼Œæˆ‘è®°å½•è°ï¼‰</li><li>dependenciesForBeanMapï¼šè®°å½•å½“å‰ beanName ä¾èµ–çš„å…¶å®ƒ beanName</li><li>ä»¥ B ä¸ºè§†è§’ dependentBeanMap {&quot;B&quot;ï¼š{&quot;A&quot;}}ï¼Œä»¥ A ä¸ºè§†è§’ dependenciesForBeanMap {&quot;A&quot; :{&quot;B&quot;}}</li></ul></li><li><p><code>canonicalName(beanName)</code>ï¼šå¤„ç† bean çš„ name</p></li><li><p><code>dependentBeans = this.dependentBeanMap.get(canonicalName)</code>ï¼šè·å–ä¾èµ–äº†å½“å‰ bean çš„ name</p></li><li><p><code>if (dependentBeans.contains(dependentBeanName))</code>ï¼šä¾èµ–äº†å½“å‰ bean çš„é›†åˆä¸­æ˜¯å¦æœ‰è¯¥ nameï¼Œæœ‰å°±äº§ç”Ÿå¾ªç¯ä¾èµ–</p></li><li><p>è¿›è¡Œé€’å½’å¤„ç†æ‰€æœ‰çš„å¼•ç”¨ï¼šå‡å¦‚ <code>&lt;bean name=&quot;A&quot; dp=&quot;B&quot;&gt; &lt;bean name=&quot;B&quot; dp=&quot;C&quot;&gt; &lt;bean name=&quot;C&quot; dp=&quot;A&quot;&gt;</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>dependentBeanMap<span class="token operator">=</span><span class="token punctuation">{</span><span class="token class-name">A</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token class-name">C</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token class-name">A</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">C</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token class-name">B</span><span class="token punctuation">}</span><span class="token punctuation">}</span> 
<span class="token comment">// C ä¾èµ– A     		åˆ¤æ–­è°ä¾èµ–äº†C				é€’å½’åˆ¤æ–­				è°ä¾èµ–äº†B</span>
<span class="token function">isDependent</span><span class="token punctuation">(</span><span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token punctuation">)</span>  â†’ <span class="token class-name">C</span>#dependentBeans<span class="token operator">=</span><span class="token punctuation">{</span><span class="token class-name">B</span><span class="token punctuation">}</span> â†’ <span class="token function">isDependent</span><span class="token punctuation">(</span><span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token punctuation">)</span><span class="token punctuation">;</span> â†’ <span class="token class-name">B</span>#dependentBeans<span class="token operator">=</span><span class="token punctuation">{</span><span class="token class-name">A</span><span class="token punctuation">}</span> <span class="token comment">//è¿”å›true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p><code>registerDependentBean(dep, beanName)</code>ï¼šæŠŠ bean å’Œä¾èµ–æ³¨å†Œåˆ°ä¸¤ä¸ª Map ä¸­ï¼Œæ³¨æ„å‚æ•°çš„ä½ç½®ï¼Œè¢«ä¾èµ–çš„åœ¨å‰</p><p><code>getBean(dep)</code>ï¼š<strong>å…ˆåŠ è½½ä¾èµ–çš„ Bean</strong>ï¼Œåˆè¿›å…¥ doGetBean() çš„é€»è¾‘</p></li><li><p><code>if (mbd.isSingleton())</code>ï¼š<strong>åˆ¤æ–­ bean æ˜¯å¦æ˜¯å•ä¾‹çš„ bean</strong></p><p><code>getSingleton(String, ObjectFactory&lt;?&gt;)</code>ï¼š<strong>ç¬¬äºŒæ¬¡è·å–ï¼Œä¼ å…¥ä¸€ä¸ªå·¥å‚å¯¹è±¡</strong>ï¼Œè¿™ä¸ªæ–¹æ³•æ›´å€¾å‘äºåˆ›å»ºå®ä¾‹å¹¶è¿”å›</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//åˆ›å»ºï¼Œè·³è½¬ç”Ÿå‘½å‘¨æœŸ</span>
    <span class="token comment">//lambdaè¡¨è¾¾å¼ï¼Œè°ƒç”¨äº†ObjectFactoryçš„getObject()æ–¹æ³•ï¼Œå®é™…å›è°ƒæ¥å£å®ç°çš„æ˜¯ createBean()æ–¹æ³•è¿›è¡Œåˆ›å»ºå¯¹è±¡</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><code>singletonObjects.get(beanName)</code>ï¼šä»ä¸€çº§ç¼“å­˜æ£€æŸ¥æ˜¯å¦å·²ç»è¢«åŠ è½½ï¼Œå•ä¾‹æ¨¡å¼å¤ç”¨å·²ç»åˆ›å»ºçš„ bean</p></li><li><p><code>this.singletonsCurrentlyInDestruction</code>ï¼šå®¹å™¨é”€æ¯æ—¶ä¼šè®¾ç½®è¿™ä¸ªå±æ€§ä¸º trueï¼Œè¿™æ—¶å°±ä¸èƒ½å†åˆ›å»º bean å®ä¾‹äº†</p></li><li><p><code>beforeSingletonCreation(beanName)</code>ï¼šæ£€æŸ¥æ„é€ æ³¨å…¥çš„ä¾èµ–ï¼Œ<strong>æ„é€ å‚æ•°æ³¨å…¥äº§ç”Ÿçš„å¾ªç¯ä¾èµ–æ— æ³•è§£å†³</strong></p><p><code>!this.singletonsCurrentlyInCreation.add(beanName)</code>ï¼šå°†å½“å‰ beanName æ”¾å…¥åˆ°æ­£åœ¨åˆ›å»ºä¸­å•å®ä¾‹é›†åˆï¼Œæ”¾å…¥æˆåŠŸè¯´æ˜æ²¡æœ‰äº§ç”Ÿå¾ªç¯ä¾èµ–ï¼Œå¤±è´¥åˆ™äº§ç”Ÿå¾ªç¯ä¾èµ–ï¼Œè¿›å…¥åˆ¤æ–­æ¡ä»¶å†…çš„é€»è¾‘æŠ›å‡ºå¼‚å¸¸</p><p>åŸå› ï¼šåŠ è½½ Aï¼Œå‘æ­£åœ¨åˆ›å»ºé›†åˆä¸­æ·»åŠ äº† {A}ï¼Œæ ¹æ® A çš„æ„é€ æ–¹æ³•å®ä¾‹åŒ– A å¯¹è±¡ï¼Œå‘ç° A çš„æ„é€ æ–¹æ³•ä¾èµ– Bï¼Œç„¶ååŠ è½½ Bï¼ŒB æ„é€ æ–¹æ³•çš„å‚æ•°ä¾èµ–äº Aï¼Œåˆå»åŠ è½½ A æ—¶æ¥åˆ°å½“å‰æ–¹æ³•ï¼Œå› ä¸ºåˆ›å»ºä¸­é›†åˆå·²ç»å­˜åœ¨ Aï¼Œæ‰€ä»¥æ·»åŠ å¤±è´¥</p></li><li><p><code>singletonObject = singletonFactory.getObject()</code>ï¼š<strong>åˆ›å»º bean</strong>ï¼ˆç”Ÿå‘½å‘¨æœŸéƒ¨åˆ†è¯¦è§£ï¼‰</p></li><li><p><strong>åˆ›å»ºå®Œæˆä»¥åï¼ŒBean å·²ç»åˆå§‹åŒ–å¥½ï¼Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„å¯ä½¿ç”¨çš„ Bean</strong></p></li><li><p><code>afterSingletonCreation(beanName)</code>ï¼šä»æ­£åœ¨åˆ›å»ºä¸­çš„é›†åˆä¸­ç§»å‡º</p></li><li><p><code>addSingleton(beanName, singletonObject)</code>ï¼š<strong>æ·»åŠ ä¸€çº§ç¼“å­˜å•ä¾‹æ± ä¸­ï¼Œä»äºŒçº§ä¸‰çº§ç¼“å­˜ç§»é™¤</strong></p></li></ul><p><code>bean = getObjectForBeanInstance</code>ï¼š<strong>å•å®ä¾‹å¯èƒ½æ˜¯æ™®é€šå•å®ä¾‹æˆ–è€… FactoryBean</strong>ï¼Œå¦‚æœæ˜¯ FactoryBean å®ä¾‹ï¼Œéœ€è¦åˆ¤æ–­ name æ˜¯å¸¦ &amp; è¿˜æ˜¯ä¸å¸¦ &amp;ï¼Œå¸¦ &amp; è¯´æ˜ getBean è·å– FactoryBean å¯¹è±¡ï¼Œå¦åˆ™æ˜¯è·å– FactoryBean å†…éƒ¨ç®¡ç†çš„å®ä¾‹</p><ul><li><p>å‚æ•° name æ˜¯æœªå¤„ç† &amp; çš„ nameï¼ŒbeanName æ˜¯å¤„ç†è¿‡ &amp; å’Œåˆ«ååçš„ name</p></li><li><p><code>if(BeanFactoryUtils.isFactoryDereference(name))</code>ï¼šåˆ¤æ–­ doGetBean ä¸­å‚æ•° name å‰æ˜¯å¦å¸¦ &amp;ï¼Œä¸æ˜¯å¤„ç†åçš„</p></li><li><p><code>if(!(beanInstance instanceof FactoryBean) || BeanFactoryUtils.isFactoryDereference(name))</code>ï¼šBean æ˜¯æ™®é€šå•å®ä¾‹æˆ–è€…æ˜¯ FactoryBean å°±å¯ä»¥ç›´æ¥è¿”å›ï¼Œå¦åˆ™è¿›å…¥ä¸‹é¢çš„è·å– <strong>FactoryBean å†…éƒ¨ç®¡ç†çš„å®ä¾‹</strong>çš„é€»è¾‘</p></li><li><p><code>getCachedObjectForFactoryBean(beanName)</code>ï¼šå°è¯•åˆ°ç¼“å­˜è·å–ï¼Œè·å–åˆ°ç›´æ¥è¿”å›ï¼Œè·å–ä¸åˆ°è¿›è¡Œä¸‹é¢é€»è¾‘</p></li><li><p><code>if (mbd == null &amp;&amp; containsBeanDefinition(beanName))</code>ï¼šSpring ä¸­æœ‰å½“å‰ beanName çš„ BeanDefinition ä¿¡æ¯</p><p><code>mbd = getMergedLocalBeanDefinition(beanName)</code>ï¼šè·å–åˆå¹¶åçš„ BeanDefinition</p></li><li><p><code>mbd.isSynthetic()</code>ï¼šé»˜è®¤å€¼æ˜¯ false è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªç”¨æˆ·å¯¹è±¡ï¼Œå¦‚æœæ˜¯ true è¡¨ç¤ºæ˜¯ç³»ç»Ÿå¯¹è±¡</p></li><li><p><code>object = getObjectFromFactoryBean(factory, beanName, !synthetic)</code>ï¼šä»å·¥å‚å†…è·å–å®ä¾‹</p><ul><li><code>factory.isSingleton() &amp;&amp; containsSingleton(beanName)</code>ï¼šå·¥å‚å†…éƒ¨ç»´æŠ¤çš„å¯¹è±¡æ˜¯å•å®ä¾‹å¹¶ä¸”ä¸€çº§ç¼“å­˜å­˜åœ¨è¯¥ bean</li><li>é¦–å…ˆå»ç¼“å­˜ä¸­è·å–ï¼Œè·å–ä¸åˆ°å°±<strong>ä½¿ç”¨å·¥å‚è·å–</strong>ç„¶åæ”¾å…¥ç¼“å­˜ï¼Œè¿›è¡Œå¾ªç¯ä¾èµ–åˆ¤æ–­</li></ul></li></ul></li><li><p><code>else if (mbd.isPrototype())</code>ï¼š<strong>bean æ˜¯åŸå‹çš„ bean</strong></p><p><code>beforePrototypeCreation(beanName)</code>ï¼šå½“å‰çº¿ç¨‹æ­£åœ¨åˆ›å»ºçš„åŸå‹å¯¹è±¡ beanName å­˜å…¥ prototypesCurrentlyInCreation</p><ul><li><code>curVal = this.prototypesCurrentlyInCreation.get()</code>ï¼šè·å–å½“å‰çº¿ç¨‹çš„æ­£åœ¨åˆ›å»ºçš„åŸå‹ç±»é›†åˆ</li><li><code>this.prototypesCurrentlyInCreation.set(beanName)</code>ï¼šé›†åˆä¸ºç©ºå°±æŠŠå½“å‰ beanName åŠ å…¥</li><li><code>if (curVal instanceof String)</code>ï¼šå·²ç»æœ‰çº¿ç¨‹ç›¸å…³åŸå‹ç±»åˆ›å»ºäº†ï¼ŒæŠŠå½“å‰çš„åˆ›å»ºçš„åŠ è¿›å»</li></ul><p><code>createBean(beanName, mbd, args)</code>ï¼šåˆ›å»ºåŸå‹ç±»å¯¹è±¡ï¼Œä¸éœ€è¦ä¸‰çº§ç¼“å­˜</p><p><code>afterPrototypeCreation(beanName)</code>ï¼šä»æ­£åœ¨åˆ›å»ºä¸­çš„é›†åˆä¸­ç§»é™¤è¯¥ beanNameï¼Œ <strong>ä¸ beforePrototypeCreationé€»è¾‘ç›¸å</strong></p></li><li><p><code>convertIfNecessary()</code>ï¼š<strong>ä¾èµ–æ£€æŸ¥</strong>ï¼Œæ£€æŸ¥æ‰€éœ€çš„ç±»å‹æ˜¯å¦ä¸å®é™… bean å®ä¾‹çš„ç±»å‹åŒ¹é…</p></li><li><p><code>return (T) bean</code>ï¼šè¿”å›åˆ›å»ºå®Œæˆçš„ bean</p></li></ul><hr><h4 id="ç”Ÿå‘½å‘¨æœŸ-2" tabindex="-1"><a class="header-anchor" href="#ç”Ÿå‘½å‘¨æœŸ-2" aria-hidden="true">#</a> ç”Ÿå‘½å‘¨æœŸ</h4><h5 id="å››ä¸ªé˜¶æ®µ" tabindex="-1"><a class="header-anchor" href="#å››ä¸ªé˜¶æ®µ" aria-hidden="true">#</a> å››ä¸ªé˜¶æ®µ</h5><p>Bean çš„ç”Ÿå‘½å‘¨æœŸï¼šå®ä¾‹åŒ– instantiationï¼Œå¡«å……å±æ€§ populateï¼Œåˆå§‹åŒ– initializationï¼Œé”€æ¯ destruction</p><p>AbstractAutowireCapableBeanFactory.createBean()ï¼šè¿›å…¥ Bean ç”Ÿå‘½å‘¨æœŸçš„æµç¨‹</p><ul><li><p><code>resolvedClass = resolveBeanClass(mbd, beanName)</code>ï¼šåˆ¤æ–­ mdb ä¸­çš„ class æ˜¯å¦å·²ç»<strong>åŠ è½½åˆ° JVM</strong>ï¼Œå¦‚æœæœªåŠ è½½åˆ™ä½¿ç”¨ç±»åŠ è½½å™¨å°† beanName åŠ è½½åˆ° JVMä¸­å¹¶è¿”å› class å¯¹è±¡</p></li><li><p><code>if (resolvedClass != null &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != null)</code>ï¼šæ¡ä»¶æˆç«‹å°è£… mbd å¹¶æŠŠ resolveBeanClass è®¾ç½®åˆ° bd ä¸­</p><ul><li>æ¡ä»¶äºŒï¼šmbd åœ¨ resolveBeanClass ä¹‹å‰æ˜¯å¦æœ‰ class</li><li>æ¡ä»¶ä¸‰ï¼šmbd æœ‰ className</li></ul></li><li><p><code>bean = resolveBeforeInstantiation(beanName, mbdToUse)</code>ï¼šå®ä¾‹åŒ–å‰çš„åç½®å¤„ç†å™¨è¿”å›ä¸€ä¸ªä»£ç†å®ä¾‹å¯¹è±¡ï¼ˆä¸æ˜¯ AOPï¼‰</p><ul><li>è‡ªå®šä¹‰ç±»ç»§æ‰¿ InstantiationAwareBeanPostProcessorï¼Œé‡å†™ postProcessBeforeInstantiation æ–¹æ³•ï¼Œ<strong>æ–¹æ³•é€»è¾‘ä¸ºåˆ›å»ºå¯¹è±¡</strong></li><li>å¹¶é…ç½®æ–‡ä»¶ <code>&lt;bean class=&quot;intefacePackage.MyInstantiationAwareBeanPostProcessor&quot;&gt;</code> å¯¼å…¥ä¸º bean</li><li>æ¡ä»¶æˆç«‹ï¼Œ<strong>çŸ­è·¯æ“ä½œ</strong>ï¼Œç›´æ¥ return bean</li></ul></li><li><p><code>Object beanInstance = doCreateBean(beanName, mbdToUse, args)</code>ï¼šDo it</p></li></ul><p>AbstractAutowireCapableBeanFactory.<strong>doCreateBean</strong>(beanName, RootBeanDefinition, Object[] args)ï¼šåˆ›å»º Bean</p><ul><li><p><code>BeanWrapper instanceWrapper = null</code>ï¼š<strong>Spring ç»™æ‰€æœ‰åˆ›å»ºçš„ Bean å®ä¾‹åŒ…è£…æˆ BeanWrapper</strong>ï¼Œå†…éƒ¨æœ€æ ¸å¿ƒçš„æ–¹æ³•æ˜¯è·å–å®ä¾‹ï¼Œæä¾›äº†ä¸€äº›é¢å¤–çš„æ¥å£æ–¹æ³•ï¼Œæ¯”å¦‚å±æ€§è®¿é—®å™¨</p></li><li><p><code>instanceWrapper = this.factoryBeanInstanceCache.remove(beanName)</code>ï¼šå•ä¾‹å¯¹è±¡å°è¯•ä»ç¼“å­˜ä¸­è·å–ï¼Œä¼šç§»é™¤ç¼“å­˜</p></li><li><p><code>createBeanInstance()</code>ï¼š<strong>ç¼“å­˜ä¸­æ²¡æœ‰å®ä¾‹å°±è¿›è¡Œåˆ›å»ºå®ä¾‹</strong>ï¼ˆé€»è¾‘å¤æ‚ï¼Œä¸‹ä¸€å°èŠ‚è¯¦è§£ï¼‰</p></li><li><p><code>if (!mbd.postProcessed)</code>ï¼šæ¯ä¸ª bean åªè¿›è¡Œä¸€æ¬¡è¯¥é€»è¾‘</p><p><code>applyMergedBeanDefinitionPostProcessors()</code>ï¼š<strong>åç½®å¤„ç†å™¨ï¼Œåˆå¹¶ bd ä¿¡æ¯</strong>ï¼Œæ¥ä¸‹æ¥è¦å±æ€§å¡«å……äº†</p><p><code>AutowiredAnnotationBeanPostProcessor.postProcessMergedBeanDefinition()</code>ï¼š<strong>åç½®å¤„ç†é€»è¾‘ï¼ˆ@Autowiredï¼‰</strong></p><ul><li><p><code>metadata = findAutowiringMetadata(beanName, beanType, null)</code>ï¼šæå–å½“å‰ bean æ•´ä¸ªç»§æ‰¿ä½“ç³»å†…çš„ <strong>@Autowiredã€@Valueã€@Inject</strong> ä¿¡æ¯ï¼Œå­˜å…¥ä¸€ä¸ª InjectionMetadata å¯¹è±¡ï¼Œä¿å­˜ç€å½“å‰ bean ä¿¡æ¯å’Œè¦è‡ªåŠ¨æ³¨å…¥çš„å­—æ®µä¿¡æ¯</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">;</span>							<span class="token comment">//å½“å‰ bean </span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InjectedElement</span><span class="token punctuation">&gt;</span></span> injectedElements<span class="token punctuation">;</span>	<span class="token comment">//è¦æ³¨å…¥çš„ä¿¡æ¯é›†åˆ</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><code>metadata = buildAutowiringMetadata(clazz)</code>ï¼šæŸ¥è¯¢å½“å‰ clazz æ„Ÿå…´è¶£çš„æ³¨è§£ä¿¡æ¯</p><ul><li><p><code>ReflectionUtils.doWithLocalFields()</code>ï¼šæå–<strong>å­—æ®µ</strong>çš„æ³¨è§£çš„ä¿¡æ¯</p><p><code>findAutowiredAnnotation(field)</code>ï¼šä»£è¡¨æ„Ÿå…´è¶£çš„æ³¨è§£å°±æ˜¯é‚£ä¸‰ç§æ³¨è§£ï¼Œè·å–è¿™ä¸‰ç§æ³¨è§£çš„å…ƒæ•°æ®</p></li><li><p><code>ReflectionUtils.doWithLocalMethods()</code>ï¼šæå–<strong>æ–¹æ³•</strong>çš„æ³¨è§£çš„ä¿¡æ¯</p></li><li><p><code>do{} while (targetClass != null &amp;&amp; targetClass != Object.class)</code>ï¼šå¾ªç¯ä»çˆ¶ç±»ä¸­è§£æï¼Œç›´åˆ° Object ç±»</p></li></ul></li><li><p><code>this.injectionMetadataCache.put(cacheKey, metadata)</code>ï¼šå­˜å…¥ç¼“å­˜</p></li></ul></li></ul><p><code>mbd.postProcessed = true</code>ï¼šè®¾ç½®ä¸º trueï¼Œä¸‹æ¬¡è®¿é—®è¯¥é€»è¾‘ä¸ä¼šå†è¿›å…¥</p></li><li><p><code>earlySingletonExposure = (mbd.isSingleton() &amp;&amp; this.allowCircularReferences &amp;&amp; isSingletonCurrentlyInCreation(beanName)</code>ï¼šå•ä¾‹ã€è§£å†³å¾ªç¯å¼•ç”¨ã€æ˜¯å¦åœ¨å•ä¾‹æ­£åœ¨åˆ›å»ºé›†åˆä¸­</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ã€æ”¾å…¥ä¸‰çº§ç¼“å­˜ä¸€ä¸ªå·¥å‚å¯¹è±¡ï¼Œç”¨æ¥è·å–æå‰å¼•ç”¨ã€‘</span>
    <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// lamda è¡¨è¾¾å¼ï¼Œç”¨æ¥è·å–æå‰å¼•ç”¨ï¼Œå¾ªç¯ä¾èµ–éƒ¨åˆ†è¯¦è§£è¯¥é€»è¾‘</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code> populateBean(beanName, mbd, instanceWrapper)</code>ï¼š**å±æ€§å¡«å……ï¼Œä¾èµ–æ³¨å…¥ï¼Œæ•´ä½“é€»è¾‘æ˜¯å…ˆå¤„ç†æ ‡ç­¾å†å¤„ç†æ³¨è§£ï¼Œå¡«å……è‡³ pvs ä¸­ï¼Œæœ€åé€šè¿‡ apply æ–¹æ³•æœ€åå®Œæˆå±æ€§ä¾èµ–æ³¨å…¥åˆ° BeanWrapper **</p><ul><li><p><code>if (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName))</code>ï¼šå®ä¾‹åŒ–åçš„åç½®å¤„ç†å™¨ï¼Œé»˜è®¤è¿”å› trueï¼Œå¯ä»¥è‡ªå®šä¹‰ç±»ç»§æ‰¿ InstantiationAwareBeanPostProcessor ä¿®æ”¹åç½®å¤„ç†æ–¹æ³•çš„è¿”å›å€¼ä¸º falseï¼Œä½¿ continueWithPropertyPopulation ä¸º falseï¼Œ<strong>ä¼šå¯¼è‡´ç›´æ¥è¿”å›ï¼Œä¸è¿›è¡Œå±æ€§çš„æ³¨å…¥</strong></p></li><li><p><code>if (!continueWithPropertyPopulation)</code>ï¼šè‡ªå®šä¹‰æ–¹æ³•è¿”å›å€¼ä¼šé€ æˆè¯¥æ¡ä»¶æˆç«‹ï¼Œé€»è¾‘ä¸ºç›´æ¥è¿”å›ï¼Œ<strong>ä¸è¿›è¡Œä¾èµ–æ³¨å…¥</strong></p></li><li><p><code>PropertyValues pvs = (mbd.hasPropertyValues() ? mbd.getPropertyValues() : null)</code>ï¼šå¤„ç†ä¾èµ–æ³¨å…¥é€»è¾‘å¼€å§‹</p></li><li><p><code>mbd.getResolvedAutowireMode() == ?</code>ï¼š<strong>æ ¹æ® bean æ ‡ç­¾é…ç½®çš„ autowire</strong> åˆ¤æ–­æ˜¯ BY_NAME æˆ–è€… BY_TYPE</p><p><code>autowireByName(beanName, mbd, bw, newPvs)</code>ï¼šæ ¹æ®å­—æ®µåç§°å»è·å–ä¾èµ–çš„ beanï¼Œè¿˜æ²¡æ³¨å…¥ï¼Œåªæ˜¯æ·»åŠ åˆ° pvs</p><ul><li><p><code>propertyNames = unsatisfiedNonSimpleProperties(mbd, bw)</code>ï¼šbean å®ä¾‹ä¸­æœ‰è¯¥å­—æ®µå’Œè¯¥å­—æ®µçš„ setter æ–¹æ³•ï¼Œä½†æ˜¯åœ¨ bd ä¸­æ²¡æœ‰ property å±æ€§</p><ul><li><p>æ‹¿åˆ°é…ç½®çš„ property ä¿¡æ¯å’Œ bean çš„æ‰€æœ‰å­—æ®µä¿¡æ¯</p></li><li><p><code>pd.getWriteMethod() != null</code>ï¼š<strong>å½“å‰å­—æ®µæ˜¯å¦æœ‰ set æ–¹æ³•ï¼Œé…ç½®ç±»æ³¨å…¥çš„æ–¹å¼éœ€è¦ set æ–¹æ³•</strong></p><p><code>!isExcludedFromDependencyCheck(pd)</code>ï¼šå½“å‰å­—æ®µç±»å‹æ˜¯å¦åœ¨å¿½ç•¥è‡ªåŠ¨æ³¨å…¥çš„åˆ—è¡¨ä¸­</p><p><code>!pvs.contains(pd.getName()</code>ï¼šå½“å‰å­—æ®µä¸åœ¨ xml æˆ–è€…å…¶ä»–æ–¹å¼çš„é…ç½®ä¸­ï¼Œä¹Ÿå°±æ˜¯ bd ä¸­ä¸å­˜åœ¨å¯¹åº”çš„ property</p><p><code>!BeanUtils.isSimpleProperty(pd.getPropertyType()</code>ï¼šæ˜¯å¦æ˜¯åŸºæœ¬æ•°æ®ç±»å‹å’Œå†…ç½®çš„å‡ ç§æ•°æ®ç±»å‹ï¼ŒåŸºæœ¬æ•°æ®ç±»å‹ä¸å…è®¸è‡ªåŠ¨æ³¨å…¥</p></li></ul></li><li><p><code>if (containsBean(propertyName))</code>ï¼šBeanFactory ä¸­å­˜åœ¨å½“å‰ property çš„ bean å®ä¾‹ï¼Œè¯´æ˜æ‰¾åˆ°å¯¹åº”çš„ä¾èµ–æ•°æ®</p></li><li><p><code>getBean(propertyName)</code>ï¼š<strong>æ‹¿åˆ° propertyName å¯¹åº”çš„ bean å®ä¾‹</strong></p></li><li><p><code>pvs.add(propertyName, bean)</code>ï¼šå¡«å……åˆ° pvs ä¸­</p></li><li><p><code>registerDependentBean(propertyName, beanName))</code>ï¼šæ·»åŠ åˆ°ä¸¤ä¸ªä¾èµ– Mapï¼ˆdependsOnï¼‰ä¸­</p></li></ul><p><code>autowireByType(beanName, mbd, bw, newPvs)</code>ï¼šæ ¹æ®å­—æ®µç±»å‹å»æŸ¥æ‰¾ä¾èµ–çš„ bean</p><ul><li><code>desc = new AutowireByTypeDependencyDescriptor(methodParam, eager)</code>ï¼šä¾èµ–æè¿°ä¿¡æ¯</li><li><code>resolveDependency(desc, beanName, autowiredBeanNames, converter)</code>ï¼šæ ¹æ®æè¿°ä¿¡æ¯ï¼ŒæŸ¥æ‰¾ä¾èµ–å¯¹è±¡ï¼Œå®¹å™¨ä¸­æ²¡æœ‰å¯¹åº”çš„å®ä¾‹ä½†æ˜¯æœ‰å¯¹åº”çš„ BDï¼Œä¼šè°ƒç”¨ getBean(Type) è·å–å¯¹è±¡</li></ul><p><code>pvs = newPvs</code>ï¼šnewPvs æ˜¯å¤„ç†äº†ä¾èµ–æ•°æ®åçš„ pvsï¼Œæ‰€ä»¥èµ‹å€¼ç»™ pvs</p></li><li><p><code>hasInstAwareBpps</code>ï¼šè¡¨ç¤ºå½“å‰æ˜¯å¦æœ‰ InstantiationAwareBeanPostProcessors çš„åç½®å¤„ç†å™¨ï¼ˆAutowiredï¼‰</p></li><li><p><code>pvsToUse = ibp.postProcessProperties(pvs, bw.getWrappedInstance(), beanName)</code>ï¼š<strong>@Autowired æ³¨è§£çš„æ³¨å…¥</strong>ï¼Œè¿™ä¸ªä¼ å…¥çš„ pvs å¯¹è±¡ï¼Œæœ€ååŸå°ä¸åŠ¨çš„è¿”å›ï¼Œä¸ä¼šæ·»åŠ ä¸œè¥¿</p><ul><li><p><code>findAutowiringMetadata()</code>ï¼šåŒ…è£…ç€å½“å‰ bd éœ€è¦æ³¨å…¥çš„æ³¨è§£ä¿¡æ¯é›†åˆï¼Œ<strong>ä¸‰ç§æ³¨è§£çš„å…ƒæ•°æ®</strong>ï¼Œç›´æ¥ç¼“å­˜è·å–</p></li><li><p><code>InjectionMetadata.InjectedElement.inject()</code>ï¼šéå†æ³¨è§£ä¿¡æ¯è§£æåæ³¨å…¥åˆ° Beanï¼Œæ–¹æ³•å’Œå­—æ®µçš„æ³¨å…¥å®ç°ä¸åŒ</p><p>ä»¥å­—æ®µæ³¨å…¥ä¸ºä¾‹ï¼š</p><ul><li><p><code>value = resolveFieldValue(field, bean, beanName)</code>ï¼šå¤„ç†å­—æ®µå±æ€§å€¼</p><p><code>value = beanFactory.resolveDependency()</code>ï¼šè§£å†³ä¾èµ–</p><p><code>result = doResolveDependency()</code>ï¼š<strong>çœŸæ­£å¤„ç†è‡ªåŠ¨æ³¨å…¥ä¾èµ–çš„é€»è¾‘</strong></p><ul><li><p><code>Object shortcut = descriptor.resolveShortcut(this)</code>ï¼šé»˜è®¤è¿”å› null</p></li><li><p><code>Object value = getAutowireCandidateResolver().getSuggestedValue(descriptor)</code>ï¼š<strong>è·å– @Value çš„å€¼</strong></p></li><li><p><code>converter.convertIfNecessary(value, type, descriptor.getTypeDescriptor())</code>ï¼šå¦‚æœ value ä¸æ˜¯ nullï¼Œå°±ç›´æ¥è¿›è¡Œç±»å‹è½¬æ¢è¿”å›æ•°æ®</p></li><li><p><code>matchingBeans = findAutowireCandidates(beanName, type, descriptor)</code>ï¼šå¦‚æœ value æ˜¯ç©ºè¯´æ˜å­—æ®µæ˜¯å¼•ç”¨ç±»å‹ï¼Œ<strong>è·å– @Autowired çš„ Bean</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// addCandidateEntry() â†’ Object beanInstance = descriptor.resolveCandidate()</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">resolveCandidate</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> requiredType<span class="token punctuation">,</span> <span class="token class-name">BeanFactory</span> beanFactory<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{</span>
	<span class="token comment">// è·å– bean</span>
    <span class="token keyword">return</span> beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p><code>ReflectionUtils.makeAccessible(field)</code>ï¼šä¿®æ”¹è®¿é—®æƒé™</p></li><li><p><code>field.set(bean, value)</code>ï¼šè·å–å±æ€§è®¿é—®å™¨ä¸ºæ­¤ field å¯¹è±¡èµ‹å€¼</p></li></ul></li></ul></li><li><p><code>applyPropertyValues()</code>ï¼š<strong>å°†æ‰€æœ‰è§£æçš„ PropertyValues çš„æ³¨å…¥è‡³ BeanWrapper å®ä¾‹ä¸­</strong>ï¼ˆæ·±æ‹·è´ï¼‰</p><ul><li><code>if (pvs.isEmpty())</code>ï¼šæ³¨è§£ @Autowired å’Œ @Value æ ‡æ³¨çš„ä¿¡æ¯åœ¨åç½®å¤„ç†çš„é€»è¾‘æ³¨å…¥å®Œæˆï¼Œæ­¤å¤„ä¸ºç©ºç›´æ¥è¿”å›</li><li>ä¸‹é¢çš„é€»è¾‘è¿›è¡Œ XML é…ç½®çš„å±æ€§çš„æ³¨å…¥ï¼Œé¦–å…ˆè·å–è½¬æ¢å™¨è¿›è¡Œæ•°æ®è½¬æ¢ï¼Œç„¶å<strong>è·å– WriteMethod (set) æ–¹æ³•è¿›è¡Œåå°„è°ƒç”¨</strong>ï¼Œå®Œæˆå±æ€§çš„æ³¨å…¥</li></ul></li></ul></li><li><p><code>initializeBean(String,Object,RootBeanDefinition)</code>ï¼š<strong>åˆå§‹åŒ–ï¼Œåˆ†ä¸ºé…ç½®æ–‡ä»¶å’Œå®ç°æ¥å£ä¸¤ç§æ–¹å¼</strong></p><ul><li><p><code>invokeAwareMethods(beanName, bean)</code>ï¼šæ ¹æ® bean æ˜¯å¦å®ç° Aware æ¥å£æ‰§è¡Œåˆå§‹åŒ–çš„æ–¹æ³•</p></li><li><p><code>wrappedBean = applyBeanPostProcessorsBeforeInitialization</code>ï¼šåˆå§‹åŒ–å‰çš„åç½®å¤„ç†å™¨ï¼Œå¯ä»¥ç»§æ‰¿æ¥å£é‡å†™æ–¹æ³•</p><ul><li><code>processor.postProcessBeforeInitialization()</code>ï¼šæ‰§è¡Œåç½®å¤„ç†çš„æ–¹æ³•ï¼Œé»˜è®¤è¿”å› bean æœ¬èº«</li><li><code>if (current == null) return result</code>ï¼šé‡å†™æ–¹æ³•è¿”å› nullï¼Œä¼šé€ æˆåç½®å¤„ç†çš„çŸ­è·¯ï¼Œç›´æ¥è¿”å›</li></ul></li><li><p><code>invokeInitMethods(beanName, wrappedBean, mbd)</code>ï¼š<strong>åå°„æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•</strong></p><ul><li><p><code>isInitializingBean = (bean instanceof InitializingBean)</code>ï¼šåˆå§‹åŒ–æ–¹æ³•çš„å®šä¹‰æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯è‡ªå®šä¹‰ç±»å®ç° InitializingBean æ¥å£ï¼Œå¦ä¸€ç§æ˜¯é…ç½®æ–‡ä»¶é…ç½® &lt;bean id=&quot;...&quot; class=&quot;...&quot; init-method=&quot;init&quot;/ &gt;</p></li><li><p><code>isInitializingBean &amp;&amp; (mbd == null || !mbd.isExternallyManagedInitMethod(&quot;afterPropertiesSet&quot;))</code>ï¼š</p><ul><li><p>æ¡ä»¶ä¸€ï¼šå½“å‰ bean æ˜¯ä¸æ˜¯å®ç°äº† InitializingBean</p></li><li><p>æ¡ä»¶äºŒï¼šInitializingBean æ¥å£ä¸­çš„æ–¹æ³• afterPropertiesSetï¼Œåˆ¤æ–­è¯¥æ–¹æ³•æ˜¯å¦æ˜¯å®¹å™¨å¤–ç®¡ç†çš„æ–¹æ³•</p></li></ul></li><li><p><code>if (mbd != null &amp;&amp; bean.getClass() != NullBean.class)</code>ï¼šæˆç«‹è¯´æ˜æ˜¯é…ç½®æ–‡ä»¶çš„æ–¹å¼</p><p><code>if(!(æ¥å£æ¡ä»¶))</code>è¡¨ç¤º<strong>å¦‚æœé€šè¿‡æ¥å£å®ç°äº†åˆå§‹åŒ–æ–¹æ³•çš„è¯ï¼Œå°±ä¸ä¼šåœ¨è°ƒç”¨é…ç½®ç±»ä¸­ init-method å®šä¹‰çš„æ–¹æ³•</strong></p><p><code>((InitializingBean) bean).afterPropertiesSet()</code>ï¼šè°ƒç”¨æ–¹æ³•</p><p><code>invokeCustomInitMethod</code>ï¼šæ‰§è¡Œè‡ªå®šä¹‰çš„æ–¹æ³•</p><ul><li><code>initMethodName = mbd.getInitMethodName()</code>ï¼šè·å–æ–¹æ³•å</li><li><code>Method initMethod = ()</code>ï¼šæ ¹æ®æ–¹æ³•åè·å–åˆ° init-method æ–¹æ³•</li><li><code> methodToInvoke = ClassUtils.getInterfaceMethodIfPossible(initMethod)</code>ï¼šå°†æ–¹æ³•è½¬æˆä»æ¥å£å±‚é¢è·å–</li><li><code>ReflectionUtils.makeAccessible(methodToInvoke)</code>ï¼šè®¿é—®æƒé™è®¾ç½®æˆå¯è®¿é—®</li><li><code> methodToInvoke.invoke(bean)</code>ï¼š<strong>åå°„è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•</strong>ï¼Œä»¥å½“å‰ bean ä¸ºè§’åº¦å»è°ƒç”¨</li></ul></li></ul></li><li><p><code>wrappedBean = applyBeanPostProcessorsAfterInitialization</code>ï¼šåˆå§‹åŒ–åçš„åç½®å¤„ç†å™¨</p><ul><li><p><code>AbstractAutoProxyCreator.postProcessAfterInitialization()</code>ï¼šå¦‚æœ Bean è¢«å­ç±»æ ‡è¯†ä¸ºè¦ä»£ç†çš„ beanï¼Œåˆ™ä½¿ç”¨é…ç½®çš„æ‹¦æˆªå™¨<strong>åˆ›å»ºä»£ç†å¯¹è±¡</strong>ï¼ŒAOP éƒ¨åˆ†è¯¦è§£</p></li><li><p>å¦‚æœä¸å­˜åœ¨å¾ªç¯ä¾èµ–ï¼Œåˆ›å»ºåŠ¨æ€ä»£ç† bean åœ¨æ­¤å¤„å®Œæˆï¼›å¦åˆ™çœŸæ­£çš„åˆ›å»ºé˜¶æ®µæ˜¯åœ¨å±æ€§å¡«å……æ—¶è·å–æå‰å¼•ç”¨çš„é˜¶æ®µï¼Œ<strong>å¾ªç¯ä¾èµ–</strong>è¯¦è§£ï¼Œæºç åˆ†æï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// è¯¥é›†åˆç”¨æ¥é¿å…é‡å¤å°†æŸä¸ª bean ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œ</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> earlyProxyReferences <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span><span class="token class-name">String</span> bN<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// cacheKey æ˜¯ beanName æˆ–è€…åŠ ä¸Š &amp;</span>
        <span class="token class-name">Object</span> cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>y
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlyProxyReferences<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span> <span class="token operator">!=</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å»æå‰ä»£ç†å¼•ç”¨æ± ä¸­å¯»æ‰¾è¯¥keyï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºä»£ç†</span>
                <span class="token comment">// å¦‚æœå­˜åœ¨åˆ™è¯æ˜è¢«ä»£ç†è¿‡ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰çš„ beanï¼Œä¸æ˜¯åˆ™åˆ›å»ºä»£ç†</span>
                <span class="token keyword">return</span> <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> bN<span class="token punctuation">,</span> cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li></ul></li><li><p><code>if (earlySingletonExposure)</code>ï¼šæ˜¯å¦å…è®¸æå‰å¼•ç”¨</p><p><code>earlySingletonReference = getSingleton(beanName, false)</code>ï¼š<strong>ä»äºŒçº§ç¼“å­˜è·å–å®ä¾‹</strong>ï¼Œæ”¾å…¥ä¸€çº§ç¼“å­˜æ˜¯åœ¨ doGetBean ä¸­çš„sharedInstance = getSingleton() é€»è¾‘ä¸­ï¼Œæ­¤æ—¶åœ¨ createBean çš„é€»è¾‘è¿˜æ²¡æœ‰è¿”å›ï¼Œæ‰€ä»¥ä¸€çº§ç¼“å­˜æ²¡æœ‰</p><p><code>if (earlySingletonReference != null)</code>ï¼šå½“å‰ bean å®ä¾‹ä»äºŒçº§ç¼“å­˜ä¸­è·å–åˆ°äº†ï¼Œè¯´æ˜<strong>äº§ç”Ÿäº†å¾ªç¯ä¾èµ–</strong>ï¼Œåœ¨å±æ€§å¡«å……é˜¶æ®µä¼šæå‰è°ƒç”¨ä¸‰çº§ç¼“å­˜ä¸­çš„å·¥å‚ç”Ÿæˆ Bean çš„ä»£ç†å¯¹è±¡ï¼ˆæˆ–åŸå§‹å®ä¾‹ï¼‰ï¼Œæ”¾å…¥äºŒçº§ç¼“å­˜ä¸­ï¼Œç„¶åä½¿ç”¨åŸå§‹ bean ç»§ç»­æ‰§è¡Œåˆå§‹åŒ–</p><ul><li><p><code> if (exposedObject == bean)</code>ï¼š<strong>åˆå§‹åŒ–åçš„ bean == åˆ›å»ºçš„åŸå§‹å®ä¾‹</strong>ï¼Œæ¡ä»¶æˆç«‹çš„ä¸¤ç§æƒ…å†µï¼šå½“å‰çš„çœŸå®å®ä¾‹ä¸éœ€è¦è¢«ä»£ç†ï¼›å½“å‰å®ä¾‹å­˜åœ¨å¾ªç¯ä¾èµ–å·²ç»è¢«æå‰ä»£ç†è¿‡äº†ï¼Œåˆå§‹åŒ–æ—¶çš„åç½®å¤„ç†å™¨ç›´æ¥è¿”å› bean åŸå®ä¾‹</p><p><code>exposedObject = earlySingletonReference</code>ï¼š<strong>æŠŠä»£ç†åçš„ Bean ä¼ ç»™ exposedObject ç”¨æ¥è¿”å›ï¼Œå› ä¸ºåªæœ‰ä»£ç†å¯¹è±¡æ‰å°è£…äº†æ‹¦æˆªå™¨é“¾ï¼Œmain æ–¹æ³•ä¸­ç”¨ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•æ—¶ä¼šè¿›è¡Œå¢å¼ºï¼Œä»£ç†æ˜¯å¯¹åŸå§‹å¯¹è±¡çš„åŒ…è£…ï¼Œæ‰€ä»¥è¿™é‡Œè¿”å›çš„ä»£ç†å¯¹è±¡ä¸­å«æœ‰å®Œæ•´çš„åŸå®ä¾‹ï¼ˆå±æ€§å¡«å……å’Œåˆå§‹åŒ–åçš„ï¼‰ï¼Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„ä»£ç†å¯¹è±¡ï¼Œè¿”å›åå¤–å±‚æ–¹æ³•ä¼šå°†å½“å‰ Bean æ”¾å…¥ä¸€çº§ç¼“å­˜</strong></p></li><li><p><code>else if (!this.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName))</code>ï¼šæ˜¯å¦æœ‰å…¶ä»– bean ä¾èµ–å½“å‰ beanï¼Œæ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜æ˜¯ä¸å­˜åœ¨å¾ªç¯ä¾èµ–ã€å­˜åœ¨å¢å¼ºä»£ç†çš„é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯æ­£å¸¸çš„é€»è¾‘</p><ul><li><p><code>dependentBeans = getDependentBeans(beanName)</code>ï¼šå–åˆ°ä¾èµ–å½“å‰ bean çš„å…¶ä»– beanName</p></li><li><p><code>if (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean))</code>ï¼šåˆ¤æ–­ dependentBean æ˜¯å¦åˆ›å»ºå®Œæˆ</p><ul><li><code>if (!this.alreadyCreated.contains(beanName))</code>ï¼šæˆç«‹å½“å‰ bean å°šæœªåˆ›å»ºå®Œæˆï¼Œå½“å‰ bean æ˜¯ä¾èµ–exposedObject çš„ beanï¼Œè¿”å› true</li></ul></li><li><p><code>return false</code>ï¼šåˆ›å»ºå®Œæˆè¿”å› false</p><p><code>actualDependentBeans.add(dependentBean)</code>ï¼šåˆ›å»ºå®Œæˆçš„ dependentBean åŠ å…¥è¯¥é›†åˆ</p></li><li><p><code>if (!actualDependentBeans.isEmpty())</code>ï¼šæ¡ä»¶æˆç«‹è¯´æ˜æœ‰ä¾èµ–äºå½“å‰ bean çš„ bean å®ä¾‹åˆ›å»ºå®Œæˆï¼Œä½†æ˜¯å½“å‰çš„ bean è¿˜æ²¡åˆ›å»ºå®Œæˆè¿”å›ï¼Œä¾èµ–å½“å‰ bean çš„å¤–éƒ¨ bean æŒæœ‰çš„æ˜¯ä¸å®Œæ•´çš„ beanï¼Œæ‰€ä»¥éœ€è¦æŠ¥é”™</p></li></ul></li></ul></li><li><p><code>registerDisposableBeanIfNecessary</code>ï¼šåˆ¤æ–­å½“å‰ bean æ˜¯å¦éœ€è¦<strong>æ³¨å†Œææ„å‡½æ•°å›è°ƒ</strong>ï¼Œå½“å®¹å™¨é”€æ¯æ—¶è¿›è¡Œå›è°ƒ</p><ul><li><p><code>if (!mbd.isPrototype() &amp;&amp; requiresDestruction(bean, mbd))</code></p><ul><li><p>å¦‚æœæ˜¯åŸå‹ prototype ä¸ä¼šæ³¨å†Œææ„å›è°ƒï¼Œä¸ä¼šå›è°ƒè¯¥å‡½æ•°ï¼Œå¯¹è±¡çš„å›æ”¶ç”± JVM çš„ GC æœºåˆ¶å®Œæˆ</p></li><li><p>requiresDestruction()ï¼š</p><ul><li><p><code>DisposableBeanAdapter.hasDestroyMethod(bean, mbd)</code>ï¼šbd ä¸­å®šä¹‰äº† DestroyMethod è¿”å› true</p></li><li><p><code>hasDestructionAwareBeanPostProcessors()</code>ï¼šåå¤„ç†å™¨æ¡†æ¶å†³å®šæ˜¯å¦è¿›è¡Œææ„å›è°ƒ</p></li></ul></li></ul></li><li><p><code>registerDisposableBean()</code>ï¼šæ¡ä»¶æˆç«‹è¿›å…¥è¯¥æ–¹æ³•ï¼Œç»™å½“å‰å•å®ä¾‹æ³¨å†Œå›è°ƒé€‚é…å™¨ï¼Œé€‚é…å™¨å†…æ ¹æ®å½“å‰ bean å®ä¾‹æ˜¯ç»§æ‰¿æ¥å£ï¼ˆDisposableBeanï¼‰è¿˜æ˜¯è‡ªå®šä¹‰æ ‡ç­¾æ¥åˆ¤å®šå…·ä½“è°ƒç”¨å“ªä¸ªæ–¹æ³•å®ç°</p></li></ul></li><li><p><code>this.disposableBeans.put(beanName, bean)</code>ï¼šå‘é”€æ¯é›†åˆæ·»åŠ å®ä¾‹</p></li></ul><hr><h5 id="åˆ›å»ºå®ä¾‹" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºå®ä¾‹" aria-hidden="true">#</a> åˆ›å»ºå®ä¾‹</h5><p>AbstractAutowireCapableBeanFactory.createBeanInstance(beanName, RootBeanDefinition, Object[] args)</p><ul><li><p><code>resolveBeanClass(mbd, beanName)</code>ï¼šç¡®ä¿ Bean çš„ Class çœŸæ­£çš„è¢«åŠ è½½</p></li><li><p>åˆ¤æ–­ç±»çš„è®¿é—®æƒé™æ˜¯ä¸æ˜¯ publicï¼Œä¸æ˜¯è¿›å…¥ä¸‹ä¸€ä¸ªåˆ¤æ–­ï¼Œæ˜¯å¦å…è®¸è®¿é—®ç±»çš„ non-public çš„æ„é€ æ–¹æ³•ï¼Œä¸å…è®¸åˆ™æŠ¥é”™</p></li><li><p><code>Supplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier()</code>ï¼šè·å–åˆ›å»ºå®ä¾‹çš„å‡½æ•°ï¼Œå¯ä»¥è‡ªå®šä¹‰ï¼Œæ²¡æœ‰è¿›å…¥ä¸‹é¢çš„é€»è¾‘</p></li><li><p><code>if (mbd.getFactoryMethodName() != null)</code>ï¼š<strong>åˆ¤æ–­ bean æ˜¯å¦è®¾ç½®äº† factory-method å±æ€§ï¼Œä¼˜å…ˆä½¿ç”¨</strong></p><p><code>&lt;bean class=&quot;&quot; factory-method=&quot;&quot;&gt;</code>ï¼Œè®¾ç½®äº†è¯¥å±æ€§è¿›å…¥ factory-method æ–¹æ³•åˆ›å»ºå®ä¾‹</p></li><li><p><code>resolved = false</code>ï¼šä»£è¡¨ bd å¯¹åº”çš„æ„é€ ä¿¡æ¯æ˜¯å¦å·²ç»è§£ææˆå¯ä»¥åå°„è°ƒç”¨çš„æ„é€ æ–¹æ³•</p></li><li><p><code>autowireNecessary = false</code>ï¼šæ˜¯å¦è‡ªåŠ¨åŒ¹é…æ„é€ æ–¹æ³•</p></li><li><p><code>if(mbd.resolvedConstructorOrFactoryMethod != null)</code>ï¼šè·å– bd çš„æ„é€ ä¿¡æ¯è½¬åŒ–æˆåå°„è°ƒç”¨çš„ method ä¿¡æ¯</p><ul><li>method ä¸º null åˆ™ resolved å’Œ autowireNecessary éƒ½ä¸ºé»˜è®¤å€¼ false</li><li><code>autowireNecessary = mbd.constructorArgumentsResolved</code>ï¼šæ„é€ æ–¹æ³•æœ‰å‚æ•°ï¼Œè®¾ç½®ä¸º true</li></ul></li><li><p><strong>bd å¯¹åº”çš„æ„é€ ä¿¡æ¯è§£æå®Œæˆï¼Œå¯ä»¥ç›´æ¥åå°„è°ƒç”¨æ„é€ æ–¹æ³•äº†</strong>ï¼š</p><ul><li><p><code>return autowireConstructor(beanName, mbd, null, null)</code>ï¼š<strong>æœ‰å‚æ„é€ </strong>ï¼Œæ ¹æ®å‚æ•°åŒ¹é…æœ€ä¼˜çš„æ„é€ å™¨åˆ›å»ºå®ä¾‹</p></li><li><p><code>return instantiateBean(beanName, mbd)</code>ï¼š<strong>æ— å‚æ„é€ æ–¹æ³•é€šè¿‡åå°„åˆ›å»ºå®ä¾‹</strong></p><ul><li><p><code>SimpleInstantiationStrategy.instantiate()</code>ï¼š<strong>çœŸæ­£ç”¨æ¥å®ä¾‹åŒ–çš„å‡½æ•°</strong>ï¼ˆæ— è®ºå¦‚ä½•éƒ½ä¼šèµ°åˆ°è¿™ä¸€æ­¥ï¼‰</p><ul><li><p><code>if (!bd.hasMethodOverrides())</code>ï¼šæ²¡æœ‰æ–¹æ³•é‡å†™è¦†ç›–</p><p><code>BeanUtils.instantiateClass(constructorToUse)</code>ï¼šè°ƒç”¨ <code>Constructor.newInstance()</code> å®ä¾‹åŒ–</p></li><li><p><code>instantiateWithMethodInjection(bd, beanName, owner)</code>ï¼š<strong>æœ‰æ–¹æ³•é‡å†™é‡‡ç”¨ CGLIB å®ä¾‹åŒ–</strong></p></li></ul></li><li><p><code>BeanWrapper bw = new BeanWrapperImpl(beanInstance)</code>ï¼šåŒ…è£…æˆ BeanWrapper ç±»å‹çš„å¯¹è±¡</p></li><li><p><code>return bw</code>ï¼šè¿”å›å®ä¾‹</p></li></ul></li></ul></li><li><p><code>ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName)</code>ï¼š<strong>@Autowired æ³¨è§£</strong>ï¼Œå¯¹åº”çš„åç½®å¤„ç†å™¨ AutowiredAnnotationBeanPostProcessor é€»è¾‘</p><ul><li><p>é…ç½®äº† lookup çš„ç›¸å…³é€»è¾‘</p></li><li><p><code>this.candidateConstructorsCache.get(beanClass)</code>ï¼šä»ç¼“å­˜ä¸­è·å–æ„é€ æ–¹æ³•ï¼Œç¬¬ä¸€æ¬¡è·å–ä¸º nullï¼Œè¿›å…¥ä¸‹é¢é€»è¾‘</p></li><li><p><code>rawCandidates = beanClass.getDeclaredConstructors()</code>ï¼šè·å–æ‰€æœ‰çš„æ„é€ å™¨</p></li><li><p><code>Constructor&lt;?&gt; requiredConstructor = null</code>ï¼šå”¯ä¸€çš„é€‰é¡¹æ„é€ å™¨ï¼Œ<strong>@Autowired(required = &quot;true&quot;)</strong> æ—¶æœ‰å€¼</p></li><li><p><code>for (Constructor&lt;?&gt; candidate : rawCandidates)</code>ï¼šéå†æ‰€æœ‰çš„æ„é€ å™¨ï¼š</p><p><code>ann = findAutowiredAnnotation(candidate)</code>ï¼šæœ‰ä¸‰ç§æ³¨è§£ä¸­çš„ä¸€ä¸ªä¼šè¿”å›æ³¨è§£çš„å±æ€§</p><ul><li><p>éå† this.autowiredAnnotationTypes ä¸­çš„ä¸‰ç§æ³¨è§£ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">this</span><span class="token punctuation">.</span>autowiredAnnotationTypes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Autowired</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>autowiredAnnotationTypes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Value</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>autowiredAnnotationTypes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>ClassUtils<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;javax.inject.Inject&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><code> AnnotatedElementUtils.getMergedAnnotationAttributes(ao, type)</code>ï¼šè·å–æ³¨è§£çš„å±æ€§</p></li><li><p><code>if (attributes != null) return attributes</code>ï¼šä»»æ„ä¸€ä¸ªæ³¨è§£å±æ€§ä¸ä¸ºç©ºå°±æ³¨è§£è¿”å›</p></li></ul><p><code>if (ann == null)</code>ï¼šæ³¨è§£å±æ€§ä¸ºç©º</p><ul><li><code>userClass = ClassUtils.getUserClass(beanClass)</code>ï¼šå¦‚æœå½“å‰ beanClass æ˜¯ä»£ç†å¯¹è±¡ï¼Œæ–¹æ³•ä¸Šå°±å·²ç»æ²¡æœ‰æ³¨è§£äº†ï¼Œæ‰€ä»¥<strong>è·å–åŸå§‹çš„ç”¨æˆ·ç±»å‹é‡æ–°è·å–è¯¥æ„é€ å™¨ä¸Šçš„æ³¨è§£å±æ€§</strong>ï¼ˆ<strong>äº‹åŠ¡æ³¨è§£å¤±æ•ˆ</strong>ä¹Ÿæ˜¯è¿™ä¸ªåŸç†ï¼‰</li></ul><p><code>if (ann != null)</code>ï¼šæ³¨è§£å±æ€§ä¸ä¸ºç©ºäº†</p><ul><li><p><code>required = determineRequiredStatus(ann)</code>ï¼šè·å– required å±æ€§çš„å€¼</p><ul><li><code>!ann.containsKey(this.requiredParameterName) || </code>ï¼šåˆ¤æ–­å±æ€§æ˜¯å¦åŒ…å« requiredï¼Œä¸åŒ…å«è¿›å…¥åé¢é€»è¾‘</li><li><code>this.requiredParameterValue == ann.getBoolean(this.requiredParameterName)</code>ï¼šè·å–å±æ€§å€¼è¿”å›</li></ul></li><li><p><code>if (required)</code>ï¼šä»£è¡¨æ³¨è§£ @Autowired(required = true)</p><p><code>if (!candidates.isEmpty())</code>ï¼štrue ä»£è¡¨åªèƒ½æœ‰ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œæ„é€ é›†åˆä¸æ˜¯ç©ºä»£è¡¨å¯é€‰çš„æ„é€ å™¨ä¸å”¯ä¸€ï¼ŒæŠ¥é”™</p><p><code>requiredConstructor = candidate</code>ï¼šæŠŠæ„é€ å™¨èµ‹å€¼ç»™ requiredConstructor</p></li><li><p><code>candidates.add(candidate)</code>ï¼šæŠŠå½“å‰æ„é€ æ–¹æ³•æ·»åŠ è‡³ candidates é›†åˆ</p></li></ul><p><code> if(candidate.getParameterCount() == 0)</code>ï¼šå½“å‰éå†çš„æ„é€ å™¨çš„å‚æ•°ä¸º 0 ä»£è¡¨æ²¡æœ‰å‚æ•°ï¼Œæ˜¯<strong>é»˜è®¤æ„é€ å™¨</strong>ï¼Œèµ‹å€¼ç»™ defaultConstructor</p></li><li><p><code>candidateConstructors = candidates.toArray(new Constructor&lt;?&gt;[0])</code>ï¼š<strong>å°†æ„é€ å™¨è½¬æˆæ•°ç»„è¿”å›</strong></p></li></ul></li><li><p><code>if(ctors != null)</code>ï¼šæ¡ä»¶æˆç«‹ä»£è¡¨æŒ‡å®šäº†<strong>æ„é€ æ–¹æ³•æ•°ç»„</strong></p><p><code>mbd.getResolvedAutowireMode() == AUTOWIRE_CONSTRUCTOR</code>ï¼š<code>&lt;bean autowire=&quot;&quot;&gt;</code> æ ‡ç­¾å†… autowiremode çš„å±æ€§å€¼ï¼Œé»˜è®¤æ˜¯ noï¼ŒAUTOWIRE_CONSTRUCTOR ä»£è¡¨é€‰æ‹©æœ€ä¼˜çš„æ„é€ æ–¹æ³•</p><p><code>mbd.hasConstructorArgumentValues()</code>ï¼šbean ä¿¡æ¯ä¸­æ˜¯å¦é…ç½®äº†æ„é€ å‚æ•°çš„å€¼</p><p><code>!ObjectUtils.isEmpty(args)</code>ï¼šgetBean æ—¶ï¼ŒæŒ‡å®šäº†å‚æ•° arg</p></li><li><p><code>return autowireConstructor(beanName, mbd, ctors, args)</code>ï¼š<strong>é€‰æ‹©æœ€ä¼˜çš„æ„é€ å™¨è¿›è¡Œåˆ›å»ºå®ä¾‹</strong>ï¼ˆå¤æ‚ï¼Œä¸å»ºè®®ç ”ç©¶ï¼‰</p><ul><li><p><code>beanFactory.initBeanWrapper(bw)</code>ï¼šå‘ BeanWrapper ä¸­æ³¨å†Œè½¬æ¢å™¨ï¼Œå‘å·¥å‚ä¸­æ³¨å†Œå±æ€§ç¼–è¾‘å™¨</p></li><li><p><code>Constructor&lt;?&gt; constructorToUse = null</code>ï¼šå®ä¾‹åŒ–åå°„æ„é€ å™¨</p><p><code>ArgumentsHolder argsHolderToUse</code>ï¼šå®ä¾‹åŒ–æ—¶çœŸæ­£å»ç”¨çš„å‚æ•°ï¼Œå¹¶æŒæœ‰å¯¹è±¡</p><ul><li>rawArguments æ˜¯è½¬æ¢å‰çš„å‚æ•°ï¼Œarguments æ˜¯ç±»å‹è½¬æ¢å®Œæˆçš„å‚æ•°</li></ul><p><code>Object[] argsToUse</code>ï¼šå‚æ•°å®ä¾‹åŒ–æ—¶ä½¿ç”¨çš„å‚æ•°</p></li><li><p><code>Object[] argsToResolve</code>ï¼šè¡¨ç¤ºæ„é€ å™¨å‚æ•°åšè½¬æ¢åçš„å‚æ•°å¼•ç”¨</p></li><li><p><code>if (constructorToUse != null &amp;&amp; mbd.constructorArgumentsResolved)</code>ï¼š</p><ul><li>æ¡ä»¶ä¸€æˆç«‹è¯´æ˜å½“å‰ bd ç”Ÿæˆçš„å®ä¾‹ä¸æ˜¯ç¬¬ä¸€æ¬¡ï¼Œç¼“å­˜ä¸­æœ‰è§£æå¥½çš„æ„é€ å™¨æ–¹æ³•å¯ä»¥ç›´æ¥æ‹¿æ¥åå°„è°ƒç”¨</li><li>æ¡ä»¶äºŒæˆç«‹è¯´æ˜æ„é€ å™¨å‚æ•°å·²ç»è§£æè¿‡äº†</li></ul></li><li><p><code>argsToUse = resolvePreparedArguments()</code>ï¼šargsToResolve ä¸æ˜¯å®Œå…¨è§£æå¥½çš„ï¼Œè¿˜éœ€è¦ç»§ç»­è§£æ</p></li><li><p><code>if (constructorToUse == null || argsToUse == null)</code>ï¼šæ¡ä»¶æˆç«‹è¯´æ˜ç¼“å­˜æœºåˆ¶å¤±è´¥ï¼Œè¿›å…¥æ„é€ å™¨åŒ¹é…é€»è¾‘</p></li><li><p><code>Constructor&lt;?&gt;[] candidates = chosenCtors</code>ï¼šchosenCtors åªæœ‰åœ¨æ„é€ æ–¹æ³•ä¸Šæœ‰ autowaire ä¸‰ç§æ³¨è§£æ—¶æ‰æœ‰æ•°æ®</p></li><li><p><code>if (candidates == null)</code>ï¼šcandidates ä¸ºç©ºå°±æ ¹æ® beanClass æ˜¯å¦å…è®¸è®¿é—®éå…¬å¼€çš„æ–¹æ³•æ¥è·å–æ„é€ æ–¹æ³•</p></li><li><p><code>if (candidates.length == 1 &amp;&amp; explicitArgs == null &amp;&amp; !mbd.hasConstructorArgumentValues())</code>ï¼šé»˜è®¤æ— å‚</p><p><code>bw.setBeanInstance(instantiate())</code>ï¼š<strong>ä½¿ç”¨æ— å‚æ„é€ å™¨åå°„è°ƒç”¨ï¼Œåˆ›å»ºå‡ºå®ä¾‹å¯¹è±¡ï¼Œè®¾ç½®åˆ° BeanWrapper ä¸­å»</strong></p></li><li><p><code>boolean autowiring</code>ï¼š<strong>éœ€è¦é€‰æ‹©æœ€ä¼˜çš„æ„é€ å™¨</strong></p></li><li><p><code>cargs = mbd.getConstructorArgumentValues()</code>ï¼šè·å–å‚æ•°å€¼</p><p><code>resolvedValues = new ConstructorArgumentValues()</code>ï¼šè·å–å·²ç»è§£æåçš„æ„é€ å™¨å‚æ•°å€¼</p><ul><li><code>final Map&lt;Integer, ValueHolder&gt; indexedArgumentValues</code>ï¼škey æ˜¯ indexï¼Œ value æ˜¯å€¼</li><li><code>final List&lt;ValueHolder&gt; genericArgumentValues</code>ï¼šæ²¡æœ‰ index çš„å€¼</li></ul><p><code>minNrOfArgs = resolveConstructorArguments(..,resolvedValues)</code>ï¼šä» bd ä¸­è§£æå¹¶è·å–æ„é€ å™¨å‚æ•°çš„ä¸ªæ•°</p><ul><li><code>valueResolver.resolveValueIfNecessary()</code>ï¼šå°†å¼•ç”¨è½¬æ¢æˆçœŸå®çš„å¯¹è±¡</li><li><code>resolvedValueHolder.setSource(valueHolder)</code>ï¼šå°†å¯¹è±¡å¡«å……è‡³ ValueHolder ä¸­</li><li><code> resolvedValues.addIndexedArgumentValue()</code>ï¼šå°†å‚æ•°å€¼å°è£…è‡³ resolvedValues ä¸­</li></ul></li><li><p><code>AutowireUtils.sortConstructors(candidates)</code>ï¼šæ’åºè§„åˆ™ public &gt; éå…¬å¼€çš„ &gt; å‚æ•°å¤šçš„ &gt; å‚æ•°å°‘çš„</p></li><li><p><code> int minTypeDiffWeight = Integer.MAX_VALUE</code>ï¼šå€¼è¶Šä½è¯´æ˜æ„é€ å™¨<strong>å‚æ•°åˆ—è¡¨ç±»å‹</strong>å’Œæ„é€ å‚æ•°çš„åŒ¹é…åº¦è¶Šé«˜</p></li><li><p><code>Set&lt;Constructor&lt;?&gt;&gt; ambiguousConstructors</code>ï¼šæ¨¡æ£±ä¸¤å¯çš„æ„é€ å™¨ï¼Œä¸¤ä¸ªæ„é€ å™¨åŒ¹é…åº¦ç›¸ç­‰æ—¶æ”¾å…¥</p></li><li><p><code>for (Constructor&lt;?&gt; candidate : candidates)</code>ï¼šéå†ç­›é€‰å‡º minTypeDiffWeight æœ€ä½çš„æ„é€ å™¨</p></li><li><p><code>Class&lt;?&gt;[] paramTypes = candidate.getParameterTypes()</code>ï¼šè·å–å½“å‰å¤„ç†çš„æ„é€ å™¨çš„å‚æ•°ç±»å‹</p></li><li><p><code>if()</code>ï¼šcandidates æ˜¯æ’è¿‡åºçš„ï¼Œå½“å‰ç­›é€‰å‡ºæ¥çš„æ„é€ å™¨çš„ä¼˜å…ˆçº§ä¸€å®šæ˜¯ä¼˜å…ˆäºåé¢çš„ constructor</p></li><li><p><code>if (paramTypes.length &lt; minNrOfArgs)</code>ï¼šéœ€æ±‚çš„å°äºç»™çš„ï¼Œä¸åŒ¹é…</p></li><li><p><code>int typeDiffWeight</code>ï¼šè·å–åŒ¹é…åº¦</p><ul><li><code>mbd.isLenientConstructorResolution()</code>ï¼štrue è¡¨ç¤º ambiguousConstructors å…è®¸æœ‰æ•°æ®ï¼Œfalse ä»£è¡¨ä¸å…è®¸æœ‰æ•°æ®ï¼Œæœ‰æ•°æ®å°±æŠ¥é”™ï¼ˆLenientConstructorResolutionï¼šå®½æ¾çš„æ„é€ å‡½æ•°è§£æï¼‰</li><li><code>argsHolder.getTypeDifferenceWeight(paramTypes)</code>ï¼šé€‰æ‹©å‚æ•°è½¬æ¢å‰å’Œè½¬æ¢ååŒ¹é…åº¦æœ€ä½çš„ï¼Œå¾ªç¯å‘çˆ¶ç±»ä¸­å¯»æ‰¾è¯¥æ–¹æ³•ï¼Œç›´åˆ°å¯»æ‰¾åˆ° Obejct ç±»</li></ul></li><li><p><code> if (typeDiffWeight &lt; minTypeDiffWeight)</code>ï¼šæ¡ä»¶æˆç«‹è¯´æ˜å½“å‰å¾ªç¯å¤„ç†çš„æ„é€ å™¨æ›´ä¼˜</p></li><li><p><code>else if (constructorToUse != null &amp;&amp; typeDiffWeight == minTypeDiffWeight)</code>ï¼šå½“å‰å¤„ç†çš„æ„é€ å™¨çš„è®¡ç®—å‡ºæ¥çš„ DiffWeight ä¸ä¸Šä¸€æ¬¡ç­›é€‰å‡ºæ¥çš„æœ€ä¼˜æ„é€ å™¨çš„å€¼ä¸€è‡´ï¼Œè¯´æ˜æœ‰æ¨¡æ£±ä¸¤å¯çš„æƒ…å†µ</p></li><li><p><code>if (constructorToUse == null)</code>ï¼šæœªæ‰¾åˆ°å¯ä»¥ä½¿ç”¨çš„æ„é€ å™¨ï¼ŒæŠ¥é”™</p></li><li><p><code> else if (ambiguousConstructors != null &amp;&amp; !mbd.isLenientConstructorResolution())</code>ï¼šæ¨¡æ£±ä¸¤å¯æœ‰æ•°æ®ï¼ŒLenientConstructorResolution == falseï¼Œæ‰€ä»¥æŠ¥é”™</p></li><li><p><code>argsHolderToUse.storeCache(mbd, constructorToUse)</code>ï¼šåŒ¹é…æˆåŠŸï¼Œè¿›è¡Œç¼“å­˜ï¼Œæ–¹ä¾¿åæ¥è€…ä½¿ç”¨è¯¥ bd å®ä¾‹åŒ–</p></li><li><p><code> bw.setBeanInstance(instantiate(beanName, mbd, constructorToUse, argsToUse))</code>ï¼šåŒ¹é…æˆåŠŸè°ƒç”¨ instantiate åˆ›å»ºå‡ºå®ä¾‹å¯¹è±¡ï¼Œè®¾ç½®åˆ° BeanWrapper ä¸­å»</p></li></ul></li><li><p><code>return instantiateBean(beanName, mbd)</code>ï¼šé»˜è®¤èµ°åˆ°è¿™é‡Œ</p></li></ul><hr><h4 id="å¾ªç¯ä¾èµ–" tabindex="-1"><a class="header-anchor" href="#å¾ªç¯ä¾èµ–" aria-hidden="true">#</a> å¾ªç¯ä¾èµ–</h4><h5 id="å¾ªç¯å¼•ç”¨" tabindex="-1"><a class="header-anchor" href="#å¾ªç¯å¼•ç”¨" aria-hidden="true">#</a> å¾ªç¯å¼•ç”¨</h5><p>å¾ªç¯ä¾èµ–ï¼šæ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªå¯¹è±¡å®ä¾‹ä¹‹é—´å­˜åœ¨ç›´æ¥æˆ–é—´æ¥çš„ä¾èµ–å…³ç³»ï¼Œè¿™ç§ä¾èµ–å…³ç³»æ„æˆä¸€ä¸ªç¯å½¢è°ƒç”¨</p><p>Spring å¾ªç¯ä¾èµ–æœ‰å››ç§ï¼š</p><ul><li>DependsOn ä¾èµ–åŠ è½½ã€æ— æ³•è§£å†³ã€‘ï¼ˆä¸¤ç§ Mapï¼‰</li><li>åŸå‹æ¨¡å¼ Prototype å¾ªç¯ä¾èµ–ã€æ— æ³•è§£å†³ã€‘ï¼ˆæ­£åœ¨åˆ›å»ºé›†åˆï¼‰</li><li>å•ä¾‹ Bean å¾ªç¯ä¾èµ–ï¼šæ„é€ å‚æ•°äº§ç”Ÿä¾èµ–ã€æ— æ³•è§£å†³ã€‘ï¼ˆæ­£åœ¨åˆ›å»ºé›†åˆï¼ŒgetSingleton() é€»è¾‘ä¸­ï¼‰</li><li>å•ä¾‹ Bean å¾ªç¯ä¾èµ–ï¼šsetter äº§ç”Ÿä¾èµ–ã€å¯ä»¥è§£å†³ã€‘</li></ul><p>è§£å†³å¾ªç¯ä¾èµ–ï¼šæå‰å¼•ç”¨ï¼Œæå‰æš´éœ²åˆ›å»ºä¸­çš„ Bean</p><ul><li>Spring å…ˆå®ä¾‹åŒ– Aï¼Œæ‹¿åˆ° A çš„æ„é€ æ–¹æ³•åå°„åˆ›å»ºå‡ºæ¥ A çš„æ—©æœŸå®ä¾‹å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡è¢«åŒ…è£…æˆ ObjectFactory å¯¹è±¡ï¼Œæ”¾å…¥ä¸‰çº§ç¼“å­˜</li><li>å¤„ç† A çš„ä¾èµ–æ•°æ®ï¼Œæ£€æŸ¥å‘ç° A ä¾èµ– B å¯¹è±¡ï¼Œæ‰€ä»¥ Spring å°±ä¼šå»æ ¹æ® B ç±»å‹åˆ°å®¹å™¨ä¸­å» getBean(B)ï¼Œè¿™é‡Œäº§ç”Ÿé€’å½’</li><li>æ‹¿åˆ° B çš„æ„é€ æ–¹æ³•ï¼Œè¿›è¡Œåå°„åˆ›å»ºå‡ºæ¥ B çš„æ—©æœŸå®ä¾‹å¯¹è±¡ï¼Œä¹Ÿä¼šæŠŠ B åŒ…è£…æˆ ObjectFactory å¯¹è±¡ï¼Œæ”¾åˆ°ä¸‰çº§ç¼“å­˜ï¼Œå¤„ç† B çš„ä¾èµ–æ•°æ®ï¼Œæ£€æŸ¥å‘ç° B ä¾èµ–äº† A å¯¹è±¡ï¼Œç„¶å Spring å°±ä¼šå»æ ¹æ® A ç±»å‹åˆ°å®¹å™¨ä¸­å» getBean(A.class)</li><li>è¿™æ—¶ä»ä¸‰çº§ç¼“å­˜ä¸­è·å–åˆ° A çš„æ—©æœŸå¯¹è±¡è¿›å…¥å±æ€§å¡«å……</li></ul><p>å¾ªç¯ä¾èµ–çš„ä¸‰çº§ç¼“å­˜ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//ä¸€çº§ç¼“å­˜ï¼šå­˜æ”¾æ‰€æœ‰åˆå§‹åŒ–å®Œæˆå•å®ä¾‹ beanï¼Œå•ä¾‹æ± ï¼Œkeyæ˜¯beanNameï¼Œvalueæ˜¯å¯¹åº”çš„å•å®ä¾‹å¯¹è±¡å¼•ç”¨</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> singletonObjects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//äºŒçº§ç¼“å­˜ï¼šå­˜æ”¾å®ä¾‹åŒ–æœªè¿›è¡Œåˆå§‹åŒ–çš„ Beanï¼Œæå‰å¼•ç”¨æ± </span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> earlySingletonObjects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/** Cache of singleton factories: bean name to ObjectFactory. 3*/</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ObjectFactory</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> singletonFactories <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>ä¸ºä»€ä¹ˆéœ€è¦ä¸‰çº§ç¼“å­˜ï¼Ÿ</p><ul><li>å¾ªç¯ä¾èµ–è§£å†³éœ€è¦æå‰å¼•ç”¨åŠ¨æ€ä»£ç†å¯¹è±¡ï¼ŒAOP åŠ¨æ€ä»£ç†æ˜¯åœ¨ Bean åˆå§‹åŒ–åçš„åç½®å¤„ç†ä¸­è¿›è¡Œï¼Œè¿™æ—¶çš„ bean å·²ç»æ˜¯æˆå“å¯¹è±¡ã€‚å› ä¸ºéœ€è¦æå‰è¿›è¡ŒåŠ¨æ€ä»£ç†ï¼Œä¸‰çº§ç¼“å­˜çš„ ObjectFactory æå‰äº§ç”Ÿéœ€è¦ä»£ç†çš„å¯¹è±¡ï¼ŒæŠŠæå‰å¼•ç”¨æ”¾å…¥äºŒçº§ç¼“å­˜</li><li>å¦‚æœåªæœ‰äºŒçº§ç¼“å­˜ï¼Œæå‰å¼•ç”¨å°±ç›´æ¥æ”¾å…¥äº†ä¸€çº§ç¼“å­˜ï¼Œç„¶å Bean åˆå§‹åŒ–å®Œæˆååˆä¼šæ”¾å…¥ä¸€çº§ç¼“å­˜ï¼Œäº§ç”Ÿæ•°æ®è¦†ç›–ï¼Œ<strong>å¯¼è‡´æå‰å¼•ç”¨çš„å¯¹è±¡å’Œä¸€çº§ç¼“å­˜ä¸­çš„å¹¶ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡</strong></li><li>ä¸€çº§ç¼“å­˜åªèƒ½å­˜æ”¾å®Œæ•´çš„å•å®ä¾‹ï¼Œ<strong>ä¸ºäº†ä¿è¯ Bean çš„ç”Ÿå‘½å‘¨æœŸä¸è¢«ç ´å</strong>ï¼Œä¸èƒ½å°†æœªåˆå§‹åŒ–çš„ Bean æš´éœ²åˆ°ä¸€çº§ç¼“å­˜</li><li>è‹¥å­˜åœ¨å¾ªç¯ä¾èµ–ï¼Œ<strong>åç½®å¤„ç†ä¸åˆ›å»ºä»£ç†å¯¹è±¡ï¼ŒçœŸæ­£åˆ›å»ºä»£ç†å¯¹è±¡çš„è¿‡ç¨‹æ˜¯åœ¨ getBean(B) çš„é˜¶æ®µä¸­</strong></li></ul></li><li><p>ä¸‰çº§ç¼“å­˜ä¸€å®šä¼šåˆ›å»ºæå‰å¼•ç”¨å—ï¼Ÿ</p><ul><li>å‡ºç°å¾ªç¯ä¾èµ–å°±ä¼šå»ä¸‰çº§ç¼“å­˜è·å–æå‰å¼•ç”¨ï¼Œä¸å‡ºç°å°±ä¸ä¼šï¼Œèµ°æ­£å¸¸çš„é€»è¾‘ï¼Œåˆ›å»ºå®Œæˆç›´æ¥æ”¾å…¥ä¸€çº§ç¼“å­˜</li><li>å­˜åœ¨å¾ªç¯ä¾èµ–ï¼Œå°±åˆ›å»ºä»£ç†å¯¹è±¡æ”¾å…¥äºŒçº§ç¼“å­˜ï¼Œå¦‚æœæ²¡æœ‰å¢å¼ºæ–¹æ³•å°±è¿”å› createBeanInstance åˆ›å»ºçš„å®ä¾‹ï¼Œå› ä¸º addSingletonFactory å‚æ•°ä¸­ä¼ å…¥äº†å®ä¾‹åŒ–çš„ Beanï¼Œåœ¨ singletonFactory.getObject() ä¸­è¿”å›ç»™ singletonObjectï¼Œæ‰€ä»¥<strong>å­˜åœ¨å¾ªç¯ä¾èµ–å°±ä¸€å®šä¼šä½¿ç”¨å·¥å‚</strong>ï¼Œä½†æ˜¯ä¸ä¸€å®šåˆ›å»ºçš„æ˜¯ä»£ç†å¯¹è±¡ï¼Œä¸éœ€è¦å¢å¼ºå°±æ˜¯åŸå§‹å¯¹è±¡</li></ul></li><li><p>wrapIfNecessary ä¸€å®šåˆ›å»ºä»£ç†å¯¹è±¡å—ï¼Ÿï¼ˆAOP åŠ¨æ€ä»£ç†éƒ¨åˆ†æœ‰æºç è§£æï¼‰</p><ul><li>å­˜åœ¨å¢å¼ºå™¨ä¼šåˆ›å»ºåŠ¨æ€ä»£ç†ï¼Œä¸éœ€è¦å¢å¼ºå°±ä¸éœ€è¦åˆ›å»ºåŠ¨æ€ä»£ç†å¯¹è±¡</li><li>å­˜åœ¨å¾ªç¯ä¾èµ–ä¼šæå‰å¢å¼ºï¼Œåˆå§‹åŒ–åä¸éœ€è¦å¢å¼º</li></ul></li><li><p>ä»€ä¹ˆæ—¶å€™å°† Bean çš„å¼•ç”¨æå‰æš´éœ²ç»™ç¬¬ä¸‰çº§ç¼“å­˜çš„ ObjectFactory æŒæœ‰ï¼Ÿ</p><ul><li><p>å®ä¾‹åŒ–ä¹‹åï¼Œä¾èµ–æ³¨å…¥ä¹‹å‰</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>createBeanInstance <span class="token operator">-&gt;</span> addSingletonFactory <span class="token operator">-&gt;</span> populateBean
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul></li></ul><hr><h5 id="æºç è§£æ" tabindex="-1"><a class="header-anchor" href="#æºç è§£æ" aria-hidden="true">#</a> æºç è§£æ</h5><p>å‡å¦‚ A ä¾èµ– Bï¼ŒB ä¾èµ– A</p><ul><li><p>å½“ A åˆ›å»ºå®ä¾‹åå¡«å……å±æ€§å‰ï¼Œæ‰§è¡Œï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// æ·»åŠ ç»™å®šçš„å•ä¾‹å·¥å‚ä»¥æ„å»ºæŒ‡å®šçš„å•ä¾‹</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> singletonFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>singletonFactory<span class="token punctuation">,</span> <span class="token string">&quot;Singleton factory must not be null&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å•ä¾‹æ± åŒ…å«è¯¥Beanè¯´æ˜å·²ç»åˆ›å»ºå®Œæˆï¼Œä¸éœ€è¦å¾ªç¯ä¾èµ–</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//åŠ å…¥ä¸‰çº§ç¼“å­˜</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span>singletonFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ä»äºŒçº§ç¼“å­˜ç§»é™¤ï¼Œå› ä¸ºä¸‰ä¸ªMapä¸­éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¸èƒ½åŒæ—¶å­˜åœ¨ï¼</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>registeredSingletons<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>å¡«å……å±æ€§æ—¶ A ä¾èµ– Bï¼Œè¿™æ—¶éœ€è¦ getBean(B)ï¼Œä¹Ÿä¼šæŠŠ B çš„å·¥å‚æ”¾å…¥ä¸‰çº§ç¼“å­˜ï¼Œæ¥ç€ B å¡«å……å±æ€§æ—¶å‘ç°ä¾èµ– Aï¼Œå»è¿›è¡Œ**ç¬¬ä¸€æ¬¡ ** getSingleton(A)</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ä¸ºtrueä»£è¡¨å…è®¸æ‹¿åˆ°æ—©æœŸå¼•ç”¨ã€‚</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åœ¨ä¸€çº§ç¼“å­˜ä¸­è·å– beanName å¯¹åº”çš„å•å®ä¾‹å¯¹è±¡ã€‚</span>
    <span class="token class-name">Object</span> singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å•å®ä¾‹ç¡®å®å°šæœªåˆ›å»ºï¼›å•å®ä¾‹æ­£åœ¨åˆ›å»ºï¼Œå‘ç”Ÿäº†å¾ªç¯ä¾èµ–</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ä»äºŒçº§ç¼“å­˜è·å–</span>
            singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// äºŒçº§ç¼“å­˜ä¸å­˜åœ¨ï¼Œå¹¶ä¸”å…è®¸è·å–æ—©æœŸå®ä¾‹å¯¹è±¡ï¼Œå»ä¸‰çº§ç¼“å­˜æŸ¥çœ‹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ObjectFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> singletonFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ä»ä¸‰çº§ç¼“å­˜è·å–å·¥å‚å¯¹è±¡ï¼Œå¹¶å¾—åˆ° bean çš„æå‰å¼•ç”¨</span>
                    singletonObject <span class="token operator">=</span> singletonFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// ã€ç¼“å­˜å‡çº§ã€‘ï¼Œæ”¾å…¥äºŒçº§ç¼“å­˜ï¼Œæå‰å¼•ç”¨æ± </span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// ä»ä¸‰çº§ç¼“å­˜ç§»é™¤è¯¥å¯¹è±¡</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> singletonObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>ä»ä¸‰çº§ç¼“å­˜è·å– A çš„ Beanï¼š<code>singletonFactory.getObject()</code>ï¼Œè°ƒç”¨äº† lambda è¡¨è¾¾å¼çš„ getEarlyBeanReference æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ã€å‘æå‰å¼•ç”¨ä»£ç†æ±  earlyProxyReferences ä¸­æ·»åŠ è¯¥ Beanï¼Œé˜²æ­¢å¯¹è±¡è¢«é‡æ–°ä»£ç†ã€‘</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>earlyProxyReferences<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ›å»ºä»£ç†å¯¹è±¡ï¼ŒcreateProxy</span>
    <span class="token keyword">return</span> <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>B å¡«å……äº† A çš„æå‰å¼•ç”¨åä¼šç»§ç»­åˆå§‹åŒ–ç›´åˆ°å®Œæˆï¼Œ<strong>è¿”å›åŸå§‹ A çš„é€»è¾‘ç»§ç»­æ‰§è¡Œ</strong></p></li></ul><hr><h3 id="aop-2" tabindex="-1"><a class="header-anchor" href="#aop-2" aria-hidden="true">#</a> AOP</h3><h4 id="æ³¨è§£åŸç†" tabindex="-1"><a class="header-anchor" href="#æ³¨è§£åŸç†" aria-hidden="true">#</a> æ³¨è§£åŸç†</h4><p>@EnableAspectJAutoProxyï¼šAOP æ³¨è§£é©±åŠ¨ï¼Œç»™å®¹å™¨ä¸­å¯¼å…¥ AspectJAutoProxyRegistrar</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token class-name">AspectJAutoProxyRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">EnableAspectJAutoProxy</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ˜¯å¦å¼ºåˆ¶ä½¿ç”¨ CGLIB åˆ›å»ºä»£ç†å¯¹è±¡ </span>
    <span class="token comment">// é…ç½®æ–‡ä»¶æ–¹å¼ï¼š&lt;aop:aspectj-autoproxy proxy-target-class=&quot;true&quot;/&gt;</span>
	<span class="token keyword">boolean</span> <span class="token function">proxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
	
    <span class="token comment">// å°†å½“å‰ä»£ç†å¯¹è±¡æš´éœ²åˆ°ä¸Šä¸‹æ–‡å†…ï¼Œæ–¹ä¾¿ä»£ç†å¯¹è±¡å†…éƒ¨çš„çœŸå®å¯¹è±¡æ‹¿åˆ°ä»£ç†å¯¹è±¡</span>
    <span class="token comment">// é…ç½®æ–‡ä»¶æ–¹å¼ï¼š&lt;aop:aspectj-autoproxy expose-proxy=&quot;true&quot;/&gt;</span>
	<span class="token keyword">boolean</span> <span class="token function">exposeProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AspectJAutoProxyRegistrar åœ¨ç”¨æ¥å‘å®¹å™¨ä¸­æ³¨å†Œ <strong>AnnotationAwareAspectJAutoProxyCreator</strong>ï¼Œä»¥ BeanDefiantion å½¢å¼å­˜åœ¨ï¼Œåœ¨å®¹å™¨åˆå§‹åŒ–æ—¶åŠ è½½ã€‚AnnotationAwareAspectJAutoProxyCreator é—´æ¥å®ç°äº† InstantiationAwareBeanPostProcessorï¼ŒOrder æ¥å£ï¼Œè¯¥ç±»ä¼šåœ¨ Bean çš„å®ä¾‹åŒ–å’Œåˆå§‹åŒ–çš„å‰åèµ·ä½œç”¨</p><p>å·¥ä½œæµç¨‹ï¼šåˆ›å»º IOC å®¹å™¨ï¼Œè°ƒç”¨ refresh() åˆ·æ–°å®¹å™¨ï¼Œ<code>registerBeanPostProcessors(beanFactory)</code> é˜¶æ®µï¼Œé€šè¿‡ getBean() åˆ›å»º AnnotationAwareAspectJAutoProxyCreator å¯¹è±¡ï¼Œåœ¨ç”Ÿå‘½å‘¨æœŸçš„åˆå§‹åŒ–æ–¹æ³•ä¸­æ‰§è¡Œå›è°ƒ initBeanFactory() æ–¹æ³•åˆå§‹åŒ–æ³¨å†Œä¸‰ä¸ªå·¥å…·ç±»ï¼šBeanFactoryAdvisorRetrievalHelperAdapterã€ReflectiveAspectJAdvisorFactoryã€BeanFactoryAspectJAdvisorsBuilderAdapter</p><hr><h4 id="åç½®å¤„ç†" tabindex="-1"><a class="header-anchor" href="#åç½®å¤„ç†" aria-hidden="true">#</a> åç½®å¤„ç†</h4><p>Bean åˆå§‹åŒ–å®Œæˆçš„æ‰§è¡Œåç½®å¤„ç†å™¨çš„æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> bean<span class="token punctuation">,</span><span class="token class-name">String</span> bN<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// cacheKey æ˜¯ ã€beanName æˆ–è€…åŠ ä¸Š &amp; çš„ beanNameã€‘</span>
        <span class="token class-name">Object</span> cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlyProxyReferences<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span> <span class="token operator">!=</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å»æå‰ä»£ç†å¼•ç”¨æ± ä¸­å¯»æ‰¾è¯¥ keyï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºä»£ç†</span>
                <span class="token comment">// å¦‚æœå­˜åœ¨åˆ™è¯æ˜è¢«ä»£ç†è¿‡ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰çš„ beanï¼Œä¸æ˜¯åˆ™åˆ›å»ºä»£ç†</span>
                <span class="token keyword">return</span> <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> bN<span class="token punctuation">,</span> cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AbstractAutoProxyCreator.wrapIfNecessary()ï¼šæ ¹æ®é€šçŸ¥åˆ›å»ºåŠ¨æ€ä»£ç†ï¼Œæ²¡æœ‰é€šçŸ¥ç›´æ¥è¿”å›åŸå®ä¾‹</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span><span class="token class-name">Object</span> bean<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token class-name">Object</span> cacheKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ¡ä»¶ä¸€èˆ¬ä¸æˆç«‹ï¼Œå¾ˆå°‘ä½¿ç”¨ TargetSourceCreator å»åˆ›å»ºå¯¹è±¡ BeforeInstantiation é˜¶æ®µï¼ŒdoCreateBean ä¹‹å‰çš„é˜¶æ®µ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>targetSourcedBeans<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// advisedBeans é›†åˆä¿å­˜çš„æ˜¯ bean æ˜¯å¦è¢«å¢å¼ºè¿‡äº†</span>
    <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ beanName å¯¹åº”çš„å®ä¾‹ä¸éœ€è¦è¢«å¢å¼ºå¤„ç†ï¼Œåˆ¤æ–­æ˜¯åœ¨ BeforeInstantiation é˜¶æ®µåšçš„</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ¡ä»¶ä¸€ï¼šåˆ¤æ–­å½“å‰ bean ç±»å‹æ˜¯å¦æ˜¯åŸºç¡€æ¡†æ¶ç±»å‹ï¼Œè¿™ä¸ªç±»çš„å®ä¾‹ä¸èƒ½è¢«å¢å¼º</span>
    <span class="token comment">// æ¡ä»¶äºŒï¼šshouldSkip åˆ¤æ–­å½“å‰ beanName æ˜¯å¦æ˜¯ .ORIGINAL ç»“å°¾ï¼Œå¦‚æœæ˜¯å°±è·³è¿‡å¢å¼ºé€»è¾‘ï¼Œç›´æ¥è¿”å›</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInfrastructureClass</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">shouldSkip</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ã€æŸ¥æ‰¾é€‚åˆå½“å‰ bean å®ä¾‹çš„å¢å¼ºæ–¹æ³•ã€‘ï¼ˆä¸‹ä¸€èŠ‚è¯¦è§£ï¼‰</span>
    <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> specificInterceptors <span class="token operator">=</span> <span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜ä¸Šé¢æ–¹æ³•æŸ¥è¯¢åˆ°é€‚åˆå½“å‰classçš„é€šçŸ¥</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>specificInterceptors <span class="token operator">!=</span> <span class="token constant">DO_NOT_PROXY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ ¹æ®æŸ¥è¯¢åˆ°çš„å¢å¼ºåˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆä¸‹ä¸€èŠ‚è¯¦è§£ï¼‰</span>
        <span class="token comment">// å‚æ•°ä¸€ï¼šç›®æ ‡å¯¹è±¡</span>
        <span class="token comment">// å‚æ•°äºŒï¼šbeanName</span>
        <span class="token comment">// å‚æ•°ä¸‰ï¼šåŒ¹é…å½“å‰ç›®æ ‡å¯¹è±¡ clazz çš„ Advisor æ•°æ®</span>
        <span class="token class-name">Object</span> proxy <span class="token operator">=</span> <span class="token function">createProxy</span><span class="token punctuation">(</span>
            bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SingletonTargetSource</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä¿å­˜ä»£ç†å¯¹è±¡ç±»å‹</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>proxyTypes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è¿”å›ä»£ç†å¯¹è±¡</span>
        <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜æ²¡æœ‰æŸ¥åˆ°é€šçŸ¥ï¼Œå½“å‰ bean ä¸éœ€è¦å¢å¼º</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token class-name">Boolean</span><span class="token punctuation">.</span><span class="token constant">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ã€è¿”å›åŸå§‹çš„ bean å®ä¾‹ã€‘</span>
    <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="è·å–é€šçŸ¥" tabindex="-1"><a class="header-anchor" href="#è·å–é€šçŸ¥" aria-hidden="true">#</a> è·å–é€šçŸ¥</h4><p>AbstractAdvisorAutoProxyCreator.getAdvicesAndAdvisorsForBean()ï¼šæŸ¥æ‰¾é€‚åˆå½“å‰ç±»å®ä¾‹çš„å¢å¼ºï¼Œå¹¶è¿›è¡Œæ’åº</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> beanClass<span class="token punctuation">,</span> <span class="token class-name">String</span> beanName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TargetSource</span> targetSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// æŸ¥è¯¢é€‚åˆå½“å‰ç±»å‹çš„å¢å¼ºé€šçŸ¥</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Advisor</span><span class="token punctuation">&gt;</span></span> advisors <span class="token operator">=</span> <span class="token function">findEligibleAdvisors</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>advisors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¢å¼ºä¸ºç©ºç›´æ¥è¿”å› nullï¼Œä¸éœ€è¦åˆ›å»ºä»£ç†</span>
        <span class="token keyword">return</span> <span class="token constant">DO_NOT_PROXY</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ä¸æ˜¯ç©ºï¼Œè½¬æˆæ•°ç»„è¿”å›</span>
    <span class="token keyword">return</span> advisors<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AbstractAdvisorAutoProxyCreator.findEligibleAdvisors()ï¼š</p><ul><li><p><code>candidateAdvisors = findCandidateAdvisors()</code>ï¼š<strong>è·å–å½“å‰å®¹å™¨å†…å¯ä»¥ä½¿ç”¨ï¼ˆæ‰€æœ‰ï¼‰çš„ advisor</strong>ï¼Œè°ƒç”¨çš„æ˜¯ AnnotationAwareAspectJAutoProxyCreator ç±»çš„æ–¹æ³•ï¼Œæ¯ä¸ªæ–¹æ³•å¯¹åº”ä¸€ä¸ª Advisor</p><ul><li><p><code>advisors = super.findCandidateAdvisors()</code>ï¼š<strong>æŸ¥è¯¢å‡º XML é…ç½®çš„æ‰€æœ‰ Advisor ç±»å‹</strong></p><ul><li><code>advisorNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors()</code>ï¼šé€šè¿‡ BF æŸ¥è¯¢å‡ºæ¥ BD é…ç½®çš„ class ä¸­ æ˜¯ Advisor å­ç±»çš„ BeanName</li><li><code>advisors.add()</code>ï¼šä½¿ç”¨ Spring å®¹å™¨è·å–å½“å‰è¿™ä¸ª Advisor ç±»å‹çš„å®ä¾‹</li></ul></li><li><p><code>advisors.addAll(....buildAspectJAdvisors())</code>ï¼š<strong>è·å–æ‰€æœ‰æ·»åŠ  @Aspect æ³¨è§£ç±»ä¸­çš„ Advisor</strong></p><p><code>buildAspectJAdvisors()</code>ï¼šæ„å»ºçš„æ–¹æ³•ï¼Œ<strong>æŠŠ Advice å°è£…æˆ Advisor</strong></p><ul><li><p><code> beanNames = BeanFactoryUtils.beanNamesForTypeIncludingAncestors(this.beanFactory, Object.class, true, false)</code>ï¼šè·å–å‡ºå®¹å™¨å†… Object æ‰€æœ‰çš„ beanNameï¼Œå°±æ˜¯å…¨éƒ¨çš„</p></li><li><p><code> for (String beanName : beanNames)</code>ï¼šéå†æ‰€æœ‰çš„ beanNameï¼Œåˆ¤æ–­æ¯ä¸ª beanName å¯¹åº”çš„ Class æ˜¯å¦æ˜¯ Aspect ç±»å‹ï¼Œå°±æ˜¯åŠ äº† @Aspect æ³¨è§£çš„ç±»</p><ul><li><p><code>factory = new BeanFactoryAspectInstanceFactory(this.beanFactory, beanName)</code>ï¼šä½¿ç”¨å·¥å‚æ¨¡å¼ç®¡ç† Aspect çš„å…ƒæ•°æ®ï¼Œå…³è”çš„çœŸå® @Aspect æ³¨è§£çš„å®ä¾‹å¯¹è±¡</p></li><li><p><code>classAdvisors = this.advisorFactory.getAdvisors(factory)</code>ï¼šæ·»åŠ äº† @Aspect æ³¨è§£çš„ç±»çš„é€šçŸ¥ä¿¡æ¯</p><ul><li><p>aspectClassï¼š@Aspect æ ‡ç­¾çš„ç±»çš„ class</p></li><li><p><code>for (Method method : getAdvisorMethods(aspectClass))</code>ï¼šéå†<strong>ä¸åŒ…æ‹¬ @Pointcut æ³¨è§£çš„æ–¹æ³•</strong></p><p><code>Advisor advisor = getAdvisor(method, lazySingletonAspectInstanceFactory, advisors.size(), aspectName)</code>ï¼š<strong>å°†å½“å‰ method åŒ…è£…æˆ Advisor æ•°æ®</strong></p><ul><li><p><code>AspectJExpressionPointcut expressionPointcut = getPointcut()</code>ï¼šè·å–åˆ‡ç‚¹è¡¨è¾¾å¼</p></li><li><p><code>return new InstantiationModelAwarePointcutAdvisorImpl()</code>ï¼šæŠŠ method ä¸­ Advice åŒ…è£…æˆ Advisorï¼ŒSpring ä¸­æ¯ä¸ª Advisor å†…éƒ¨ä¸€å®šæ˜¯æŒæœ‰ä¸€ä¸ª Advice çš„ï¼ŒAdvice å†…éƒ¨æœ€é‡è¦çš„æ•°æ®æ˜¯å½“å‰ method å’ŒaspectInstanceFactoryï¼Œå·¥å‚ç”¨æ¥è·å–å®ä¾‹</p><p><code>this.instantiatedAdvice = instantiateAdvice(this.declaredPointcut)</code>ï¼šå®ä¾‹åŒ– Advice å¯¹è±¡ï¼Œé€»è¾‘æ˜¯è·å–æ³¨è§£ä¿¡æ¯ï¼Œæ ¹æ®æ³¨è§£çš„ä¸åŒç”Ÿæˆå¯¹åº”çš„ Advice å¯¹è±¡</p></li></ul></li></ul></li><li><p><code>advisors.addAll(classAdvisors)</code>ï¼šä¿å­˜é€šè¿‡ @Aspect æ³¨è§£å®šä¹‰çš„ Advisor æ•°æ®</p></li></ul></li><li><p><code>this.aspectBeanNames = aspectNames</code>ï¼šå°†æ‰€æœ‰ @Aspect æ³¨è§£ beanName ç¼“å­˜èµ·æ¥ï¼Œè¡¨ç¤ºæå– Advisor å·¥ä½œå®Œæˆ</p></li><li><p><code>return advisors</code>ï¼šè¿”å› Advisor åˆ—è¡¨</p></li></ul></li></ul></li><li><p><code>eligibleAdvisors = findAdvisorsThatCanApply(candidateAdvisors, ...)</code>ï¼š<strong>é€‰å‡ºåŒ¹é…å½“å‰ç±»çš„å¢å¼º</strong></p><ul><li><p><code>if (candidateAdvisors.isEmpty())</code>ï¼šæ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ Spring æ²¡æœ‰å¯ä»¥æ“ä½œçš„ Advisor</p></li><li><p><code>List&lt;Advisor&gt; eligibleAdvisors = new ArrayList&lt;&gt;()</code>ï¼šå­˜æ”¾åŒ¹é…å½“å‰ beanClass çš„ Advisors ä¿¡æ¯</p></li><li><p><code>for (Advisor candidate : candidateAdvisors)</code>ï¼š<strong>éå†æ‰€æœ‰çš„ Advisor</strong></p><p><code> if (canApply(candidate, clazz, hasIntroductions))</code>ï¼šåˆ¤æ–­éå†çš„ advisor æ˜¯å¦åŒ¹é…å½“å‰çš„ classï¼ŒåŒ¹é…å°±åŠ å…¥é›†åˆ</p><ul><li><p><code>if (advisor instanceof PointcutAdvisor)</code>ï¼šåˆ›å»ºçš„ advisor æ˜¯ InstantiationModelAwarePointcutAdvisorImpl ç±»å‹</p><p><code>PointcutAdvisor pca = (PointcutAdvisor) advisor</code>ï¼šå°è£…å½“å‰ Advisor</p><p><code>return canApply(pca.getPointcut(), targetClass, hasIntroductions)</code>ï¼šé‡è½½è¯¥æ–¹æ³•</p><ul><li><code>if (!pc.getClassFilter().matches(targetClass))</code>ï¼š<strong>ç±»ä¸åŒ¹é… Pointcut è¡¨è¾¾å¼ï¼Œç›´æ¥è¿”å› false</strong></li><li><code>methodMatcher = pc.getMethodMatcher()</code>ï¼š<strong>è·å– Pointcut æ–¹æ³•åŒ¹é…å™¨</strong>ï¼Œç±»åŒ¹é…è¿›è¡Œç±»ä¸­æ–¹æ³•çš„åŒ¹é…</li><li><code>Set&lt;Class&lt;?&gt;&gt; classes</code>ï¼šä¿å­˜ç›®æ ‡å¯¹è±¡ class å’Œç›®æ ‡å¯¹è±¡çˆ¶ç±»è¶…ç±»çš„æ¥å£å’Œè‡ªèº«å®ç°çš„æ¥å£</li><li><code>if (!Proxy.isProxyClass(targetClass))</code>ï¼šåˆ¤æ–­å½“å‰å®ä¾‹æ˜¯ä¸æ˜¯ä»£ç†ç±»ï¼Œç¡®ä¿ class å†…å­˜å‚¨çš„æ•°æ®åŒ…æ‹¬ç›®æ ‡å¯¹è±¡çš„class è€Œä¸æ˜¯ä»£ç†ç±»çš„ class</li><li><code>for (Class&lt;?&gt; clazz : classes)</code>ï¼š<strong>æ£€æŸ¥ç›®æ ‡ class å’Œä¸Šçº§æ¥å£çš„æ‰€æœ‰æ–¹æ³•ï¼ŒæŸ¥çœ‹æ˜¯å¦ä¼šè¢«æ–¹æ³•åŒ¹é…å™¨åŒ¹é…</strong>ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ–¹æ³•åŒ¹é…æˆåŠŸï¼Œå°±è¯´æ˜ç›®æ ‡å¯¹è±¡ AOP ä»£ç†éœ€è¦å¢å¼º <ul><li><code>specificMethod = AopUtils.getMostSpecificMethod(method, targetClass)</code>ï¼šæ–¹æ³•å¯èƒ½æ˜¯æ¥å£çš„ï¼Œåˆ¤æ–­å½“å‰ç±»æœ‰æ²¡æœ‰è¯¥æ–¹æ³•</li><li><code>return (specificMethod != method &amp;&amp; matchesMethod(specificMethod))</code>ï¼š<strong>ç±»å’Œæ–¹æ³•çš„åŒ¹é…</strong>ï¼Œä¸åŒ…æ‹¬å‚æ•°</li></ul></li></ul></li></ul></li></ul></li><li><p><code>extendAdvisors(eligibleAdvisors)</code>ï¼šåœ¨ eligibleAdvisors åˆ—è¡¨çš„ç´¢å¼• 0 çš„ä½ç½®æ·»åŠ  DefaultPointcutAdvisorï¼Œ<strong>å°è£…äº† ExposeInvocationInterceptor æ‹¦æˆªå™¨</strong></p></li><li><p><code> eligibleAdvisors = sortAdvisors(eligibleAdvisors)</code>ï¼š<strong>å¯¹æ‹¦æˆªå™¨è¿›è¡Œæ’åº</strong>ï¼Œæ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œé«˜çš„æ’åœ¨å‰é¢</p><ul><li>å®ç° Ordered æˆ– PriorityOrdered æ¥å£ï¼ŒPriorityOrdered çš„çº§åˆ«è¦ä¼˜å…ˆäº Orderedï¼Œä½¿ç”¨ OrderComparator æ¯”è¾ƒå™¨</li><li>ä½¿ç”¨ @Orderï¼ˆSpring è§„èŒƒï¼‰æˆ– @Priorityï¼ˆJDK è§„èŒƒï¼‰æ³¨è§£ï¼Œä½¿ç”¨ AnnotationAwareOrderComparator æ¯”è¾ƒå™¨</li><li>ExposeInvocationInterceptor å®ç°äº† PriorityOrdered ï¼Œæ‰€ä»¥æ€»æ˜¯æ’åœ¨ç¬¬ä¸€ä½ï¼ŒMethodBeforeAdviceInterceptor æ²¡å®ç°ä»»ä½•æ¥å£ï¼Œæ‰€ä»¥ä¼˜å…ˆçº§æœ€ä½ï¼Œæ’åœ¨æœ€å</li></ul></li><li><p><code>return eligibleAdvisors</code>ï¼šè¿”å›æ‹¦æˆªå™¨é“¾</p></li></ul><hr><h4 id="åˆ›å»ºä»£ç†" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºä»£ç†" aria-hidden="true">#</a> åˆ›å»ºä»£ç†</h4><p>AbstractAutoProxyCreator.createProxy()ï¼šæ ¹æ®å¢å¼ºæ–¹æ³•åˆ›å»ºä»£ç†å¯¹è±¡</p><ul><li><p><code>ProxyFactory proxyFactory = new ProxyFactory()</code>ï¼š<strong>æ— å‚æ„é€  ProxyFactory</strong>ï¼Œæ­¤å¤„è®²è§£ä¸€ä¸‹ä¸¤ç§æœ‰å‚æ„é€ æ–¹æ³•ï¼š</p><ul><li><p>public ProxyFactory(Object target)ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ProxyFactory</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// å°†ç›®æ ‡å¯¹è±¡å°è£…æˆ SingletonTargetSource ä¿å­˜åˆ°çˆ¶ç±»çš„å­—æ®µä¸­</span>
   	<span class="token function">setTarget</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–ç›®æ ‡å¯¹è±¡ class æ‰€æœ‰æ¥å£ä¿å­˜åˆ° AdvisedSupport ä¸­çš„ interfaces é›†åˆä¸­</span>
   	<span class="token function">setInterfaces</span><span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">getAllInterfaces</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ClassUtils.getAllInterfaces(target) åº•å±‚è°ƒç”¨ getAllInterfacesForClassAsSet(java.lang.Class&lt;?&gt;, java.lang.ClassLoader)ï¼š</p><ul><li><code>if (clazz.isInterface() &amp;&amp; isVisible(clazz, classLoader))</code>ï¼š <ul><li>æ¡ä»¶ä¸€ï¼šåˆ¤æ–­å½“å‰ç›®æ ‡å¯¹è±¡æ˜¯æ¥å£</li><li>æ¡ä»¶äºŒï¼šæ£€æŸ¥ç»™å®šçš„ç±»åœ¨ç»™å®šçš„ ClassLoader ä¸­æ˜¯å¦å¯è§</li></ul></li><li><code>Class&lt;?&gt;[] ifcs = current.getInterfaces()</code>ï¼šæ‹¿åˆ°è‡ªå·±å®ç°çš„æ¥å£ï¼Œæ‹¿ä¸åˆ°æ¥å£å®ç°çš„æ¥å£</li><li><code>current = current.getSuperclass()</code>ï¼šé€’å½’å¯»æ‰¾çˆ¶ç±»çš„æ¥å£ï¼Œå»è·å–çˆ¶ç±»å®ç°çš„æ¥å£</li></ul></li><li><p>public ProxyFactory(Class&lt;?&gt; proxyInterface, Interceptor interceptor)ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">ProxyFactory</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> proxyInterface<span class="token punctuation">,</span> <span class="token class-name">Interceptor</span> interceptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ·»åŠ ä¸€ä¸ªä»£ç†çš„æ¥å£</span>
    <span class="token function">addInterface</span><span class="token punctuation">(</span>proxyInterface<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ·»åŠ é€šçŸ¥ï¼Œåº•å±‚è°ƒç”¨ addAdvisor</span>
    <span class="token function">addAdvice</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>addAdvisor(pos, new DefaultPointcutAdvisor(advice))</code>ï¼šSpring ä¸­ Advice å¯¹åº”çš„æ¥å£å°±æ˜¯ Advisorï¼ŒSpring ä½¿ç”¨ Advisor åŒ…è£… Advice å®ä¾‹</li></ul></li></ul></li><li><p><code>proxyFactory.copyFrom(this)</code>ï¼šå¡«å……ä¸€äº›ä¿¡æ¯åˆ° proxyFactory</p></li><li><p><code>if (!proxyFactory.isProxyTargetClass())</code>ï¼šæ¡ä»¶æˆç«‹è¯´æ˜ proxyTargetClass ä¸º falseï¼ˆé»˜è®¤ï¼‰ï¼Œä¸¤ç§é…ç½®æ–¹æ³•ï¼š</p><ul><li><code>&lt;aop:aspectj-autoproxy proxy-target-class=&quot;true&quot;/&gt; </code>ï¼šå¼ºåˆ¶ä½¿ç”¨ CGLIB</li><li><code>@EnableAspectJAutoProxy(proxyTargetClass = true)</code></li></ul><p><code>if (shouldProxyTargetClass(beanClass, beanName))</code>ï¼šå¦‚æœ bd å†…æœ‰ preserveTargetClass = true ï¼Œé‚£ä¹ˆè¿™ä¸ª bd å¯¹åº”çš„ class <strong>åˆ›å»ºä»£ç†æ—¶å¿…é¡»ä½¿ç”¨ CGLIB</strong>ï¼Œæ¡ä»¶æˆç«‹è®¾ç½® proxyTargetClass ä¸º true</p><p><code>evaluateProxyInterfaces(beanClass, proxyFactory)</code>ï¼š<strong>æ ¹æ®ç›®æ ‡ç±»åˆ¤å®šæ˜¯å¦å¯ä»¥ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†</strong></p><ul><li><code>targetInterfaces = ClassUtils.getAllInterfacesForClass()</code>ï¼šè·å–å½“å‰ç›®æ ‡å¯¹è±¡ class å’Œçˆ¶ç±»çš„å…¨éƒ¨å®ç°æ¥å£</li><li><code>boolean hasReasonableProxyInterface = false</code>ï¼šå®ç°çš„æ¥å£ä¸­æ˜¯å¦æœ‰ä¸€ä¸ªåˆç†çš„æ¥å£</li><li><code>if (!isConfigurationCallbackInterface(ifc) &amp;&amp; !isInternalLanguageInterface(ifc) &amp;&amp; ifc.getMethods().length &gt; 0)</code>ï¼šéå†æ‰€æœ‰çš„æ¥å£ï¼Œå¦‚æœæœ‰ä»»æ„ä¸€ä¸ªæ¥å£æ»¡è¶³æ¡ä»¶ï¼Œè®¾ç½® hRPI å˜é‡ä¸º true <ul><li>æ¡ä»¶ä¸€ï¼šåˆ¤æ–­å½“å‰æ¥å£æ˜¯å¦æ˜¯ Spring ç”Ÿå‘½å‘¨æœŸå†…ä¼šå›è°ƒçš„æ¥å£</li><li>æ¡ä»¶äºŒï¼šæ¥å£ä¸èƒ½æ˜¯ GroovyObjectã€Factoryã€MockAccess ç±»å‹çš„</li><li>æ¡ä»¶ä¸‰ï¼šæ‰¾åˆ°ä¸€ä¸ªå¯ä»¥ä½¿ç”¨çš„è¢«ä»£ç†çš„æ¥å£</li></ul></li><li><code>if (hasReasonableProxyInterface)</code>ï¼š<strong>æœ‰åˆç†çš„æ¥å£ï¼Œå°†è¿™äº›æ¥å£è®¾ç½®åˆ° proxyFactory å†…</strong></li><li><code>proxyFactory.setProxyTargetClass(true)</code>ï¼š<strong>æ²¡æœ‰åˆç†çš„ä»£ç†æ¥å£ï¼Œå¼ºåˆ¶ä½¿ç”¨ CGLIB åˆ›å»ºå¯¹è±¡</strong></li></ul></li><li><p><code>advisors = buildAdvisors(beanName, specificInterceptors)</code>ï¼šåŒ¹é…ç›®æ ‡å¯¹è±¡ clazz çš„ Advisorsï¼Œå¡«å……è‡³ ProxyFactory</p></li><li><p><code>proxyFactory.setPreFiltered(true)</code>ï¼šè®¾ç½®ä¸º true è¡¨ç¤ºä¼ é€’ç»™ proxyFactory çš„ Advisors ä¿¡æ¯åšè¿‡åŸºç¡€ç±»å’Œæ–¹æ³•çš„åŒ¹é…</p></li><li><p><code>return proxyFactory.getProxy(getProxyClassLoader())</code>ï¼šåˆ›å»ºä»£ç†å¯¹è±¡</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createAopProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>DefaultAopProxyFactory.createAopProxy(AdvisedSupport config)ï¼šå‚æ•°æ˜¯ä¸€ä¸ªé…ç½®å¯¹è±¡ï¼Œä¿å­˜ç€åˆ›å»ºä»£ç†éœ€è¦çš„ç”Ÿäº§èµ„æ–™ï¼Œä¼šåŠ é”åˆ›å»ºï¼Œä¿è¯çº¿ç¨‹å®‰å…¨</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">AopProxy</span> <span class="token function">createAopProxy</span><span class="token punctuation">(</span><span class="token class-name">AdvisedSupport</span> config<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AopConfigException</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ¡ä»¶äºŒä¸º true ä»£è¡¨å¼ºåˆ¶ä½¿ç”¨ CGLIB åŠ¨æ€ä»£ç†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isOptimize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> config<span class="token punctuation">.</span><span class="token function">isProxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> 
        <span class="token comment">// æ¡ä»¶ä¸‰ï¼šè¢«ä»£ç†å¯¹è±¡æ²¡æœ‰å®ç°ä»»ä½•æ¥å£æˆ–è€…åªå®ç°äº† SpringProxy æ¥å£ï¼Œåªèƒ½ä½¿ç”¨ CGLIB åŠ¨æ€ä»£ç†</span>
        <span class="token function">hasNoUserSuppliedProxyInterfaces</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>targetClass <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AopConfigException</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜ target ã€æ˜¯æ¥å£æˆ–è€…æ˜¯å·²ç»è¢«ä»£ç†è¿‡çš„ç±»å‹ã€‘ï¼Œåªèƒ½ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>targetClass<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">isProxyClass</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ObjenesisCglibAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// ä½¿ç”¨ CGLIB åŠ¨æ€ä»£ç†</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// ã€æœ‰æ¥å£çš„æƒ…å†µä¸‹åªèƒ½ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ã€‘</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>JdkDynamicAopProxy.getProxy(java.lang.ClassLoader)ï¼šè·å– JDK çš„ä»£ç†å¯¹è±¡</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">(</span><span class="token class-name">AdvisedSupport</span> config<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AopConfigException</span> <span class="token punctuation">{</span>
      <span class="token comment">// é…ç½®ç±»å°è£…åˆ° JdkDynamicAopProxy.advised å±æ€§ä¸­</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>advised <span class="token operator">=</span> config<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è·å–éœ€è¦ä»£ç†çš„æ¥å£æ•°ç»„</span>
      <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> proxiedInterfaces <span class="token operator">=</span> <span class="token class-name">AopProxyUtils</span><span class="token punctuation">.</span><span class="token function">completeProxiedInterfaces</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// æŸ¥æ‰¾å½“å‰æ‰€æœ‰çš„éœ€è¦ä»£ç†çš„æ¥å£ï¼Œçœ‹æ˜¯å¦æœ‰ equals æ–¹æ³•å’Œ hashcode æ–¹æ³•ï¼Œå¦‚æœæœ‰å°±åšä¸€ä¸ªæ ‡è®°</span>
      <span class="token function">findDefinedEqualsAndHashCodeMethods</span><span class="token punctuation">(</span>proxiedInterfaces<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// è¯¥æ–¹æ³•æœ€ç»ˆè¿”å›ä¸€ä¸ªä»£ç†ç±»å¯¹è±¡</span>
      <span class="token keyword">return</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">,</span> proxiedInterfaces<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// classLoaderï¼šç±»åŠ è½½å™¨  proxiedInterfacesï¼šç”Ÿæˆçš„ä»£ç†ç±»ï¼Œéœ€è¦å®ç°çš„æ¥å£é›†åˆ</span>
      <span class="token comment">// this JdkDynamicAopProxy å®ç°äº† InvocationHandler</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AopProxyUtils.completeProxiedInterfaces(this.advised, true)ï¼šè·å–ä»£ç†çš„æ¥å£æ•°ç»„ï¼Œå¹¶æ·»åŠ  SpringProxy æ¥å£</p><ul><li><p><code>specifiedInterfaces = advised.getProxiedInterfaces()</code>ï¼šä» ProxyFactory ä¸­æ‹¿åˆ°æ‰€æœ‰çš„ target æå–å‡ºæ¥çš„æ¥å£</p><ul><li><code>if (specifiedInterfaces.length == 0)</code>ï¼šå¦‚æœæ²¡æœ‰å®ç°æ¥å£ï¼Œæ£€æŸ¥å½“å‰ target æ˜¯ä¸æ˜¯æ¥å£æˆ–è€…å·²ç»æ˜¯ä»£ç†ç±»ï¼Œå°è£…åˆ° ProxyFactory çš„ interfaces é›†åˆä¸­</li></ul></li><li><p><code> addSpringProxy = !advised.isInterfaceProxied(SpringProxy.class)</code>ï¼šåˆ¤æ–­ç›®æ ‡å¯¹è±¡æ‰€æœ‰æ¥å£ä¸­æ˜¯å¦æœ‰ SpringProxy æ¥å£ï¼Œæ²¡æœ‰çš„è¯éœ€è¦æ·»åŠ ï¼Œè¿™ä¸ªæ¥å£<strong>æ ‡è¯†è¿™ä¸ªä»£ç†ç±»å‹æ˜¯ Spring ç®¡ç†çš„</strong></p><ul><li><code>addAdvised = !advised.isOpaque() &amp;&amp; !advised.isInterfaceProxied(Advised.class)</code>ï¼šåˆ¤æ–­ç›®æ ‡å¯¹è±¡çš„æ‰€æœ‰æ¥å£ï¼Œæ˜¯å¦å·²ç»æœ‰ Advised æ¥å£</li><li><code> addDecoratingProxy = (decoratingProxy &amp;&amp; !advised.isInterfaceProxied(DecoratingProxy.class))</code>ï¼šåˆ¤æ–­ç›®æ ‡å¯¹è±¡çš„æ‰€æœ‰æ¥å£ï¼Œæ˜¯å¦å·²ç»æœ‰ DecoratingProxy æ¥å£</li><li><code>int nonUserIfcCount = 0</code>ï¼šéç”¨æˆ·è‡ªå®šä¹‰çš„æ¥å£æ•°é‡ï¼Œæ¥ä¸‹æ¥è¦æ·»åŠ ä¸Šé¢çš„ä¸‰ä¸ªæ¥å£äº†</li><li><code>proxiedInterfaces = new Class&lt;?&gt;[specifiedInterfaces.length + nonUserIfcCount]</code>ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ class æ•°ç»„ï¼Œé•¿åº¦æ˜¯åŸç›®æ ‡å¯¹è±¡æå–å‡ºæ¥çš„æ¥å£æ•°é‡å’Œ Spring è¿½åŠ çš„æ•°é‡ï¼Œç„¶åè¿›è¡Œ <strong>System.arraycopy æ‹·è´åˆ°æ–°æ•°ç»„ä¸­</strong></li><li><code>int index = specifiedInterfaces.length</code>ï¼šè·å–åŸç›®æ ‡å¯¹è±¡æå–å‡ºæ¥çš„æ¥å£æ•°é‡ï¼Œå½“ä½œ index</li><li><code>if(addSpringProxy)</code>ï¼šæ ¹æ®ä¸Šé¢ä¸‰ä¸ªå¸ƒå°”å€¼æŠŠæ¥å£æ·»åŠ åˆ°æ–°æ•°ç»„ä¸­</li><li><code>return proxiedInterfaces</code>ï¼šè¿”å›è¿½åŠ åçš„æ¥å£é›†åˆ</li></ul></li></ul><p>JdkDynamicAopProxy.findDefinedEqualsAndHashCodeMethods()ï¼šæŸ¥æ‰¾åœ¨ä»»ä½•å®šä¹‰åœ¨æ¥å£ä¸­çš„ equals å’Œ hashCode æ–¹æ³•</p><ul><li><code>for (Class&lt;?&gt; proxiedInterface : proxiedInterfaces)</code>ï¼šéå†æ‰€æœ‰çš„æ¥å£ <ul><li><p><code> Method[] methods = proxiedInterface.getDeclaredMethods()</code>ï¼šè·å–æ¥å£ä¸­çš„æ‰€æœ‰æ–¹æ³•</p></li><li><p><code>for (Method method : methods)</code>ï¼šéå†æ‰€æœ‰çš„æ–¹æ³•</p><ul><li><code>if (AopUtils.isEqualsMethod(method))</code>ï¼šå½“å‰æ–¹æ³•æ˜¯ equals æ–¹æ³•ï¼ŒæŠŠ equalsDefined ç½®ä¸º true</li><li><code>if (AopUtils.isHashCodeMethod(method))</code>ï¼šå½“å‰æ–¹æ³•æ˜¯ hashCode æ–¹æ³•ï¼ŒæŠŠ hashCodeDefined ç½®ä¸º true</li></ul></li><li><p><code>if (this.equalsDefined &amp;&amp; this.hashCodeDefined)</code>ï¼šå¦‚æœæœ‰ä¸€ä¸ªæ¥å£ä¸­æœ‰è¿™ä¸¤ç§æ–¹æ³•ï¼Œç›´æ¥è¿”å›</p></li></ul></li></ul></li></ul><hr><h4 id="æ–¹æ³•å¢å¼º" tabindex="-1"><a class="header-anchor" href="#æ–¹æ³•å¢å¼º" aria-hidden="true">#</a> æ–¹æ³•å¢å¼º</h4><p>main() å‡½æ•°ä¸­è°ƒç”¨ç”¨æˆ·æ–¹æ³•ï¼Œä¼šè¿›å…¥ä»£ç†å¯¹è±¡çš„ invoke æ–¹æ³•</p><p>JdkDynamicAopProxy ç±»ä¸­çš„ invoke æ–¹æ³•æ˜¯çœŸæ­£æ‰§è¡Œä»£ç†æ–¹æ³•</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// proxyï¼šä»£ç†å¯¹è±¡ï¼Œmethodï¼šç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ï¼Œargsï¼šç›®æ ‡å¯¹è±¡æ–¹æ³•å¯¹åº”çš„å‚æ•°</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token class-name">Object</span> oldProxy <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> setProxyContext <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// advised å°±æ˜¯åˆå§‹åŒ– JdkDynamicAopProxy å¯¹è±¡æ—¶ä¼ å…¥çš„å˜é‡</span>
    <span class="token class-name">TargetSource</span> targetSource <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span>targetSource<span class="token punctuation">;</span>
    <span class="token class-name">Object</span> target <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜ä»£ç†ç±»å®ç°çš„æ¥å£æ²¡æœ‰å®šä¹‰ equals æ–¹æ³•ï¼Œå¹¶ä¸”å½“å‰ method è°ƒç”¨ equals æ–¹æ³•ï¼Œ</span>
        <span class="token comment">// å°±è°ƒç”¨ JdkDynamicAopProxy æä¾›çš„ equals æ–¹æ³•</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>equalsDefined <span class="token operator">&amp;&amp;</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">isEqualsMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">equals</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token comment">//.....</span>

        <span class="token class-name">Object</span> retVal<span class="token punctuation">;</span>
		<span class="token comment">// éœ€ä¸éœ€è¦æš´éœ²å½“å‰ä»£ç†å¯¹è±¡åˆ° AOP ä¸Šä¸‹æ–‡å†…</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span>exposeProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// ã€æŠŠä»£ç†å¯¹è±¡è®¾ç½®åˆ°ä¸Šä¸‹æ–‡ç¯å¢ƒã€‘</span>
            oldProxy <span class="token operator">=</span> <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">setCurrentProxy</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            setProxyContext <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// æ ¹æ® targetSource è·å–çœŸæ­£çš„ä»£ç†å¯¹è±¡</span>
        target <span class="token operator">=</span> targetSource<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æŸ¥æ‰¾ã€é€‚åˆè¯¥æ–¹æ³•çš„å¢å¼ºã€‘ï¼Œé¦–å…ˆä»ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾ä¸åˆ°è¿›å…¥ä¸»æ–¹æ³•ã€ä¸‹æ–‡è¯¦è§£ã€‘</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> chain <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span><span class="token function">getInterceptorsAndDynamicInterceptionAdvice</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// æ‹¦æˆªå™¨é“¾æ˜¯ç©ºï¼Œè¯´æ˜å½“å‰ method ä¸éœ€è¦è¢«å¢å¼º</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argsToUse <span class="token operator">=</span> <span class="token class-name">AopProxyUtils</span><span class="token punctuation">.</span><span class="token function">adaptArgumentsIfNecessary</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            retVal <span class="token operator">=</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">invokeJoinpointUsingReflection</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> method<span class="token punctuation">,</span> argsToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// æœ‰åŒ¹é…å½“å‰ method çš„æ–¹æ³•æ‹¦æˆªå™¨ï¼Œè¦åšå¢å¼ºå¤„ç†ï¼ŒæŠŠæ–¹æ³•ä¿¡æ¯å°è£…åˆ°æ–¹æ³•è°ƒç”¨å™¨é‡Œ</span>
            <span class="token class-name">MethodInvocation</span> invocation <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">ReflectiveMethodInvocation</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> target<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ã€æ‹¦æˆªå™¨é“¾é©±åŠ¨æ–¹æ³•ï¼Œæ ¸å¿ƒã€‘</span>
            retVal <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> returnType <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>retVal <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> retVal <span class="token operator">==</span> target <span class="token operator">&amp;&amp;</span>
            returnType <span class="token operator">!=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> returnType<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span><span class="token class-name">RawTargetAccess</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          	<span class="token comment">// å¦‚æœç›®æ ‡æ–¹æ³•è¿”å›ç›®æ ‡å¯¹è±¡ï¼Œè¿™é‡Œåšä¸ªæ™®é€šæ›¿æ¢è¿”å›ä»£ç†å¯¹è±¡</span>
            retVal <span class="token operator">=</span> proxy<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// è¿”å›æ‰§è¡Œçš„ç»“æœ</span>
        <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>targetSource<span class="token punctuation">.</span><span class="token function">isStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            targetSource<span class="token punctuation">.</span><span class="token function">releaseTarget</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å¦‚æœå…è®¸äº†æå‰æš´éœ²ï¼Œè¿™é‡Œéœ€è¦è®¾ç½®ä¸ºåˆå§‹çŠ¶æ€</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>setProxyContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å½“å‰ä»£ç†å¯¹è±¡å·²ç»å®Œæˆå·¥ä½œï¼Œã€æŠŠåŸå§‹å¯¹è±¡è®¾ç½®å›ä¸Šä¸‹æ–‡ã€‘</span>
            <span class="token class-name">AopContext</span><span class="token punctuation">.</span><span class="token function">setCurrentProxy</span><span class="token punctuation">(</span>oldProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>this.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass)ï¼šæŸ¥æ‰¾é€‚åˆè¯¥æ–¹æ³•çš„å¢å¼ºï¼Œé¦–å…ˆä»ç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œè·å–é€šçŸ¥æ—¶æ˜¯ä»å…¨éƒ¨å¢å¼ºä¸­è·å–é€‚åˆå½“å‰ç±»çš„ï¼Œè¿™é‡Œæ˜¯<strong>ä»å½“å‰ç±»çš„ä¸­è·å–é€‚åˆå½“å‰æ–¹æ³•çš„å¢å¼º</strong></p><ul><li><p><code>AdvisorAdapterRegistry registry = GlobalAdvisorAdapterRegistry.getInstance()</code>ï¼šå‘å®¹å™¨æ³¨å†Œé€‚é…å™¨ï¼Œ<strong>å¯ä»¥å°†é Advisor ç±»å‹çš„å¢å¼ºï¼ŒåŒ…è£…æˆä¸º Advisorï¼Œå°† Advisor ç±»å‹çš„å¢å¼ºæå–å‡ºæ¥å¯¹åº”çš„ MethodInterceptor</strong></p><ul><li><p><code>instance = new DefaultAdvisorAdapterRegistry()</code>ï¼šè¯¥å¯¹è±¡å‘å®¹å™¨ä¸­æ³¨å†Œäº† MethodBeforeAdviceAdapterã€AfterReturningAdviceAdapterã€ThrowsAdviceAdapter ä¸‰ä¸ªé€‚é…å™¨</p></li><li><p>Advisor ä¸­æŒæœ‰ Advice å¯¹è±¡</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Advisor</span> <span class="token punctuation">{</span>
	<span class="token class-name">Advice</span> <span class="token function">getAdvice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p><code>advisors = config.getAdvisors()</code>ï¼šè·å– ProxyFactory å†…éƒ¨æŒæœ‰çš„å¢å¼ºä¿¡æ¯</p></li><li><p><code>interceptorList = new ArrayList&lt;&gt;(advisors.length)</code>ï¼šæ‹¦æˆªå™¨åˆ—è¡¨æœ‰ 5 ä¸ªï¼Œ1 ä¸ª ExposeInvocationå’Œ 4 ä¸ªå¢å¼ºå™¨</p></li><li><p><code>actualClass = (targetClass != null ? targetClass : method.getDeclaringClass())</code>ï¼šçœŸå®çš„ç›®æ ‡å¯¹è±¡ç±»å‹</p></li><li><p><code>Boolean hasIntroductions = null</code>ï¼šå¼•ä»‹å¢å¼ºï¼Œä¸å…³å¿ƒ</p></li><li><p><code>for (Advisor advisor : advisors)</code>ï¼š<strong>éå†æ‰€æœ‰çš„ advisor å¢å¼º</strong></p></li><li><p><code>if (advisor instanceof PointcutAdvisor)</code>ï¼šæ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ Advisor æ˜¯åŒ…å«åˆ‡ç‚¹ä¿¡æ¯çš„ï¼Œè¿›å…¥åŒ¹é…é€»è¾‘</p><p><code>pointcutAdvisor = (PointcutAdvisor) advisor</code>ï¼šè½¬æˆå¯ä»¥è·å–åˆ°åˆ‡ç‚¹ä¿¡æ¯çš„æ¥å£</p><p><code>if(config.isPreFiltered() || pointcutAdvisor.getPointcut().getClassFilter().matches(actualClass))</code>ï¼šå½“å‰ä»£ç†è¢«é¢„å¤„ç†ï¼Œæˆ–è€…å½“å‰è¢«ä»£ç†çš„ class å¯¹è±¡åŒ¹é…å½“å‰ Advisor æˆåŠŸï¼Œåªæ˜¯ class åŒ¹é…æˆåŠŸ</p><ul><li><p><code>mm = pointcutAdvisor.getPointcut().getMethodMatcher()</code>ï¼šè·å–åˆ‡ç‚¹çš„æ–¹æ³•åŒ¹é…å™¨ï¼Œä¸è€ƒè™‘å¼•ä»‹å¢å¼º</p></li><li><p><code>match = mm.matches(method, actualClass)</code>ï¼š<strong>é™æ€åŒ¹é…æˆåŠŸè¿”å› trueï¼Œåªå…³æ³¨äºå¤„ç†ç±»åŠå…¶æ–¹æ³•ï¼Œä¸è€ƒè™‘å‚æ•°</strong></p></li><li><p><code>if (match)</code>ï¼šå¦‚æœé™æ€åˆ‡ç‚¹æ£€æŸ¥æ˜¯åŒ¹é…çš„ï¼Œåœ¨è¿è¡Œçš„æ—¶å€™æ‰è¿›è¡Œ<strong>åŠ¨æ€åˆ‡ç‚¹æ£€æŸ¥ï¼Œä¼šè€ƒè™‘å‚æ•°åŒ¹é…</strong>ï¼ˆä»£è¡¨ä¼ å…¥äº†å‚æ•°ï¼‰ã€‚å¦‚æœé™æ€åŒ¹é…å¤±è´¥ï¼Œç›´æ¥ä¸éœ€è¦è¿›è¡Œå‚æ•°åŒ¹é…ï¼Œæé«˜äº†å·¥ä½œæ•ˆç‡</p><p><code>interceptors = registry.getInterceptors(advisor)</code>ï¼šæå–å‡ºå½“å‰ advisor å†…æŒæœ‰çš„ advice ä¿¡æ¯</p><ul><li><p><code>Advice advice = advisor.getAdvice()</code>ï¼šè·å–å¢å¼ºæ–¹æ³•</p></li><li><p><code>if (advice instanceof MethodInterceptor)</code>ï¼šå½“å‰ advice æ˜¯ MethodInterceptor ç›´æ¥åŠ å…¥é›†åˆ</p></li><li><p><code>for (AdvisorAdapter adapter : this.adapters)</code>ï¼š<strong>éå†ä¸‰ä¸ªé€‚é…å™¨è¿›è¡ŒåŒ¹é…</strong>ï¼ˆåˆå§‹åŒ–æ—¶åˆ›å»ºçš„ï¼‰ï¼ŒåŒ¹é…æˆåŠŸåˆ›å»ºå¯¹åº”çš„æ‹¦æˆªå™¨è¿”å›ï¼Œä»¥ MethodBeforeAdviceAdapter ä¸ºä¾‹</p><p><code>if (adapter.supportsAdvice(advice))</code>ï¼šåˆ¤æ–­å½“å‰ advice æ˜¯å¦æ˜¯å¯¹åº”çš„ MethodBeforeAdvice</p><p><code>interceptors.add(adapter.getInterceptor(advisor))</code>ï¼šæ¡ä»¶æˆç«‹å°±å¾€æ‹¦æˆªå™¨é“¾ä¸­æ·»åŠ  advisor</p><ul><li><code>advice = (MethodBeforeAdvice) advisor.getAdvice()</code>ï¼š<strong>è·å–å¢å¼ºæ–¹æ³•</strong></li><li><code>return new MethodBeforeAdviceInterceptor(advice)</code>ï¼š<strong>å°è£…æˆ MethodBeforeAdviceInterceptor è¿”å›</strong></li></ul></li></ul><p><code>interceptorList.add(new InterceptorAndDynamicMethodMatcher(interceptor, mm))</code>ï¼šå‘æ‹¦æˆªå™¨é“¾æ·»åŠ åŠ¨æ€åŒ¹é…å™¨</p><p><code>interceptorList.addAll(Arrays.asList(interceptors))</code>ï¼šå°†å½“å‰ advisor å†…éƒ¨çš„æ–¹æ³•æ‹¦æˆªå™¨è¿½åŠ åˆ° interceptorList</p></li></ul></li><li><p><code>interceptors = registry.getInterceptors(advisor)</code>ï¼šè¿›å…¥ else çš„é€»è¾‘ï¼Œè¯´æ˜å½“å‰ Advisor åŒ¹é…å…¨éƒ¨ class çš„å…¨éƒ¨ methodï¼Œå…¨éƒ¨åŠ å…¥åˆ° interceptorList</p></li><li><p><code>return interceptorList</code>ï¼šè¿”å› method æ–¹æ³•çš„æ‹¦æˆªå™¨é“¾</p></li></ul><p>retVal = invocation.proceed()ï¼š<strong>æ‹¦æˆªå™¨é“¾é©±åŠ¨æ–¹æ³•</strong></p><ul><li><p><code>if (this.currentInterceptorIndex == this.interceptorsAndDynamicMethodMatchers.size() - 1)</code>ï¼šæ¡ä»¶æˆç«‹è¯´æ˜æ–¹æ³•æ‹¦æˆªå™¨å…¨éƒ¨éƒ½å·²ç»è°ƒç”¨è¿‡äº†ï¼ˆindex ä» - 1 å¼€å§‹ç´¯åŠ ï¼‰ï¼Œæ¥ä¸‹æ¥éœ€è¦æ‰§è¡Œç›®æ ‡å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•</p><p><code>return invokeJoinpoint()</code>ï¼š<strong>è°ƒç”¨è¿æ¥ç‚¹ï¼ˆç›®æ ‡ï¼‰æ–¹æ³•</strong></p></li><li><p><code>this.interceptorsAndDynamicMethodMatchers.get(++this.currentInterceptorIndex)</code>ï¼š<strong>è·å–ä¸‹ä¸€ä¸ªæ–¹æ³•æ‹¦æˆªå™¨</strong></p></li><li><p><code>if (interceptorOrInterceptionAdvice instanceof InterceptorAndDynamicMethodMatcher)</code>ï¼šéœ€è¦è¿è¡Œæ—¶åŒ¹é…</p><p><code>if (dm.methodMatcher.matches(this.method, targetClass, this.arguments))</code>ï¼šåˆ¤æ–­æ˜¯å¦åŒ¹é…æˆåŠŸ</p><ul><li><code>return dm.interceptor.invoke(this)</code>ï¼šåŒ¹é…æˆåŠŸï¼Œæ‰§è¡Œæ–¹æ³•</li><li><code>return proceed()</code>ï¼šåŒ¹é…å¤±è´¥è·³è¿‡å½“å‰æ‹¦æˆªå™¨</li></ul></li><li><p><code>return ((MethodInterceptor) interceptorOrInterceptionAdvice).invoke(this)</code>ï¼š<strong>ä¸€èˆ¬æ–¹æ³•æ‹¦æˆªå™¨éƒ½ä¼šæ‰§è¡Œåˆ°è¯¥æ–¹æ³•ï¼Œæ­¤æ–¹æ³•å†…ç»§ç»­æ‰§è¡Œ proceed() å®Œæˆè´£ä»»é“¾çš„é©±åŠ¨ï¼Œç›´åˆ°æœ€åä¸€ä¸ª MethodBeforeAdviceInterceptor è°ƒç”¨å‰ç½®é€šçŸ¥ï¼Œç„¶åè°ƒç”¨ mi.proceed()ï¼Œå‘ç°æ˜¯æœ€åä¸€ä¸ªæ‹¦æˆªå™¨å°±ç›´æ¥æ‰§è¡Œè¿æ¥ç‚¹ï¼ˆç›®æ ‡æ–¹æ³•ï¼‰ï¼Œreturn åˆ°ä¸Šä¸€ä¸ªæ‹¦æˆªå™¨çš„ mi.proceed() å¤„ï¼Œä¾æ¬¡è¿”å›åˆ°è´£ä»»é“¾çš„ä¸Šä¸€ä¸ªæ‹¦æˆªå™¨æ‰§è¡Œé€šçŸ¥æ–¹æ³•</strong></p></li></ul><p>å›¾ç¤ºå…ˆä»ä¸Šå¾€ä¸‹å»ºç«‹é“¾ï¼Œç„¶åä»ä¸‹å¾€ä¸Šä¾æ¬¡æ‰§è¡Œï¼Œè´£ä»»é“¾æ¨¡å¼</p><ul><li><p>æ­£å¸¸æ‰§è¡Œï¼šï¼ˆç¯ç»•é€šçŸ¥ï¼‰â†’ å‰ç½®é€šçŸ¥ â†’ ç›®æ ‡æ–¹æ³• â†’ åç½®é€šçŸ¥ â†’ è¿”å›é€šçŸ¥</p></li><li><p>å‡ºç°å¼‚å¸¸ï¼šï¼ˆç¯ç»•é€šçŸ¥ï¼‰â†’ å‰ç½®é€šçŸ¥ â†’ ç›®æ ‡æ–¹æ³• â†’ åç½®é€šçŸ¥ â†’ å¼‚å¸¸é€šçŸ¥</p></li><li><p>MethodBeforeAdviceInterceptor æºç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MethodInvocation</span> mi<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token comment">// å…ˆæ‰§è¡Œé€šçŸ¥æ–¹æ³•ï¼Œå†é©±åŠ¨è´£ä»»é“¾</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>advice<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>mi<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mi<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mi<span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å¼€å§‹é©±åŠ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œï¼Œæ‰§è¡Œå®Œåè¿”å›åˆ°è¿™ï¼Œç„¶åç»§ç»­å‘ä¸Šå±‚è¿”å›</span>
    <span class="token keyword">return</span> mi<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AfterReturningAdviceInterceptor æºç ï¼šæ²¡æœ‰ä»»ä½•å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œç›´æ¥æŠ›ç»™ä¸Šå±‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MethodInvocation</span> mi<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token comment">// å…ˆé©±åŠ¨è´£ä»»é“¾ï¼Œå†æ‰§è¡Œé€šçŸ¥æ–¹æ³•</span>
    <span class="token class-name">Object</span> retVal <span class="token operator">=</span> mi<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>advice<span class="token punctuation">.</span><span class="token function">afterReturning</span><span class="token punctuation">(</span>retVal<span class="token punctuation">,</span> mi<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mi<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mi<span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AspectJAfterThrowingAdvice æ‰§è¡Œå¼‚å¸¸å¤„ç†ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MethodInvocation</span> mi<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// é»˜è®¤ç›´æ¥é©±åŠ¨è´£ä»»é“¾</span>
        <span class="token keyword">return</span> mi<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å‡ºç°é”™è¯¯æ‰æ‰§è¡Œè¯¥æ–¹æ³•</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldInvokeOnThrowing</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">invokeAdviceMethod</span><span class="token punctuation">(</span><span class="token function">getJoinPointMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Frame/Spring-AOPåŠ¨æ€ä»£ç†æ‰§è¡Œæ–¹æ³•.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>å‚è€ƒè§†é¢‘ï¼š<a href="https://www.bilibili.com/video/BV1gW411W7wy" target="_blank" rel="noopener noreferrer">https://www.bilibili.com/video/BV1gW411W7wy<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><hr><h3 id="äº‹åŠ¡-1" tabindex="-1"><a class="header-anchor" href="#äº‹åŠ¡-1" aria-hidden="true">#</a> äº‹åŠ¡</h3><h4 id="è§£ææ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#è§£ææ–¹æ³•" aria-hidden="true">#</a> è§£ææ–¹æ³•</h4><h5 id="æ ‡ç­¾è§£æ" tabindex="-1"><a class="header-anchor" href="#æ ‡ç­¾è§£æ" aria-hidden="true">#</a> æ ‡ç­¾è§£æ</h5><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>annotation-driven</span> <span class="token attr-name">transaction-manager</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>txManager<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å®¹å™¨å¯åŠ¨æ—¶ä¼šæ ¹æ®æ³¨è§£æ³¨å†Œå¯¹åº”çš„è§£æå™¨ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TxNamespaceHandler</span> <span class="token keyword">extends</span> <span class="token class-name">NamespaceHandlerSupport</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">&quot;advice&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TxAdviceBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ³¨å†Œè§£æå™¨</span>
		<span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">&quot;annotation-driven&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationDrivenBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">&quot;jta-transaction-manager&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">JtaTransactionManagerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token class-name">String</span> elementName<span class="token punctuation">,</span> <span class="token class-name">BeanDefinitionParser</span> parser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>parsers<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>elementName<span class="token punctuation">,</span> parser<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è·å–å¯¹åº”çš„è§£æå™¨ NamespaceHandlerSupport#findParserForElementï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">BeanDefinitionParser</span> <span class="token function">findParserForElement</span><span class="token punctuation">(</span><span class="token class-name">Element</span> element<span class="token punctuation">,</span> <span class="token class-name">ParserContext</span> parserContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> localName <span class="token operator">=</span> parserContext<span class="token punctuation">.</span><span class="token function">getDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLocalName</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–å¯¹åº”çš„è§£æå™¨</span>
    <span class="token class-name">BeanDefinitionParser</span> parser <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parsers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>localName<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ...</span>
    <span class="token keyword">return</span> parser<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è°ƒç”¨è§£æå™¨çš„æ–¹æ³•å¯¹ XML æ–‡ä»¶è¿›è¡Œè§£æï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">BeanDefinition</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">Element</span> element<span class="token punctuation">,</span> <span class="token class-name">ParserContext</span> parserContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// å‘Springå®¹å™¨æ³¨å†Œäº†ä¸€ä¸ª BD -&gt; TransactionalEventListenerFactory.class</span>
    <span class="token function">registerTransactionalEventListenerFactory</span><span class="token punctuation">(</span>parserContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> mode <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;mode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;aspectj&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// mode=&quot;aspectj&quot;</span>
        <span class="token function">registerTransactionAspect</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> parserContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ClassUtils</span><span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token string">&quot;javax.transaction.Transactional&quot;</span><span class="token punctuation">,</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">registerJtaTransactionAspect</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> parserContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// mode=&quot;proxy&quot;ï¼Œé»˜è®¤é€»è¾‘ï¼Œä¸é…ç½® mode æ—¶</span>
        <span class="token comment">// ç”¨æ¥å‘å®¹å™¨ä¸­æ³¨å…¥ä¸€äº› BeanDefinitionï¼ŒåŒ…æ‹¬äº‹åŠ¡å¢å¼ºå™¨ã€äº‹åŠ¡æ‹¦æˆªå™¨ã€æ³¨è§£è§£æå™¨</span>
        <span class="token class-name">AopAutoProxyConfigurer</span><span class="token punctuation">.</span><span class="token function">configureAutoProxyCreator</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> parserContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h5 id="æ³¨è§£è§£æ" tabindex="-1"><a class="header-anchor" href="#æ³¨è§£è§£æ" aria-hidden="true">#</a> æ³¨è§£è§£æ</h5><p>@EnableTransactionManagement å¯¼å…¥ TransactionManagementConfigurationSelectorï¼Œè¯¥ç±»ç»™ Spring å®¹å™¨ä¸­ä¸¤ä¸ªç»„ä»¶ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">selectImports</span><span class="token punctuation">(</span><span class="token class-name">AdviceMode</span> adviceMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>adviceMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¯¼å…¥ AutoProxyRegistrar å’Œ ProxyTransactionManagementConfigurationï¼ˆé»˜è®¤ï¼‰</span>
        <span class="token keyword">case</span> <span class="token constant">PROXY</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token class-name">AutoProxyRegistrar</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 <span class="token class-name">ProxyTransactionManagementConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// å¯¼å…¥ AspectJTransactionManagementConfigurationï¼ˆä¸å£°æ˜å¼äº‹åŠ¡æ— å…³ï¼‰</span>
        <span class="token keyword">case</span> <span class="token constant">ASPECTJ</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token function">determineTransactionAspectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AutoProxyRegistrarï¼šç»™å®¹å™¨ä¸­æ³¨å†Œ InfrastructureAdvisorAutoProxyCreatorï¼Œ<strong>åˆ©ç”¨åç½®å¤„ç†å™¨æœºåˆ¶æ‹¦æˆª bean ä»¥ååŒ…è£…å¹¶è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡</strong>ï¼Œä»£ç†å¯¹è±¡ä¸­ä¿å­˜æ‰€æœ‰çš„æ‹¦æˆªå™¨ï¼Œåˆ©ç”¨æ‹¦æˆªå™¨çš„é“¾å¼æœºåˆ¶ä¾æ¬¡è¿›å…¥æ¯ä¸€ä¸ªæ‹¦æˆªå™¨ä¸­è¿›è¡Œæ‹¦æˆªæ‰§è¡Œï¼ˆå°±æ˜¯ AOP åŸç†ï¼‰</p><p>ProxyTransactionManagementConfigurationï¼šæ˜¯ä¸€ä¸ª Spring çš„äº‹åŠ¡é…ç½®ç±»ï¼Œæ³¨å†Œäº†ä¸‰ä¸ª Beanï¼š</p><ul><li>BeanFactoryTransactionAttributeSourceAdvisorï¼šäº‹åŠ¡é©±åŠ¨ï¼Œåˆ©ç”¨æ³¨è§£ @Bean æŠŠè¯¥ç±»æ³¨å…¥åˆ°å®¹å™¨ä¸­ï¼Œè¯¥å¢å¼ºå™¨æœ‰ä¸¤ä¸ªå­—æ®µï¼š</li><li>TransactionAttributeSourceï¼šè§£æäº‹åŠ¡æ³¨è§£çš„ç›¸å…³ä¿¡æ¯ï¼ŒçœŸå®ç±»å‹æ˜¯ AnnotationTransactionAttributeSourceï¼Œæ„é€ æ–¹æ³•ä¸­æ³¨å†Œäº†ä¸‰ä¸ª<strong>æ³¨è§£è§£æå™¨</strong>ï¼Œè§£æ Springã€JTAã€Ejb3 ä¸‰ç§ç±»å‹çš„äº‹åŠ¡æ³¨è§£</li><li>TransactionInterceptorï¼š<strong>äº‹åŠ¡æ‹¦æˆªå™¨</strong>ï¼Œä»£ç†å¯¹è±¡æ‰§è¡Œæ‹¦æˆªå™¨æ–¹æ³•æ—¶ï¼Œè°ƒç”¨ TransactionInterceptor çš„ invoke æ–¹æ³•ï¼Œåº•å±‚è°ƒç”¨TransactionAspectSupport.invokeWithinTransaction()ï¼Œé€šè¿‡ PlatformTransactionManager æ§åˆ¶ç€äº‹åŠ¡çš„æäº¤å’Œå›æ»šï¼Œæ‰€ä»¥äº‹åŠ¡çš„åº•å±‚åŸç†å°±æ˜¯é€šè¿‡ AOP åŠ¨æ€ç»‡å…¥ï¼Œè¿›è¡Œäº‹åŠ¡å¼€å¯å’Œæäº¤</li></ul><p>æ³¨è§£è§£æå™¨ SpringTransactionAnnotationParser <strong>è§£æ @Transactional æ³¨è§£</strong>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">TransactionAttribute</span> <span class="token function">parseTransactionAnnotation</span><span class="token punctuation">(</span><span class="token class-name">AnnotationAttributes</span> attributes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RuleBasedTransactionAttribute</span> rbta <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuleBasedTransactionAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ä»æ³¨è§£ä¿¡æ¯ä¸­è·å–ä¼ æ’­è¡Œä¸º</span>
    <span class="token class-name">Propagation</span> propagation <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getEnum</span><span class="token punctuation">(</span><span class="token string">&quot;propagation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rbta<span class="token punctuation">.</span><span class="token function">setPropagationBehavior</span><span class="token punctuation">(</span>propagation<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å–éš”ç¦»ç•Œåˆ«</span>
    <span class="token class-name">Isolation</span> isolation <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getEnum</span><span class="token punctuation">(</span><span class="token string">&quot;isolation&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rbta<span class="token punctuation">.</span><span class="token function">setIsolationLevel</span><span class="token punctuation">(</span>isolation<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rbta<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>attributes<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token string">&quot;timeout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä»æ³¨è§£ä¿¡æ¯ä¸­è·å– readOnly å‚æ•°</span>
    rbta<span class="token punctuation">.</span><span class="token function">setReadOnly</span><span class="token punctuation">(</span>attributes<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">&quot;readOnly&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ä»æ³¨è§£ä¿¡æ¯ä¸­è·å– value ä¿¡æ¯å¹¶ä¸”è®¾ç½® qualifierï¼Œè¡¨ç¤ºå½“å‰äº‹åŠ¡æŒ‡å®šä½¿ç”¨çš„ã€äº‹åŠ¡ç®¡ç†å™¨ã€‘</span>
    rbta<span class="token punctuation">.</span><span class="token function">setQualifier</span><span class="token punctuation">(</span>attributes<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ã€å­˜æ”¾çš„æ˜¯ rollback æ¡ä»¶ã€‘ï¼Œå›æ»šè§„åˆ™æ”¾åœ¨è¿™ä¸ªé›†åˆ</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RollbackRuleAttribute</span><span class="token punctuation">&gt;</span></span> rollbackRules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¡¨ç¤ºäº‹åŠ¡ç¢°åˆ°å“ªäº›æŒ‡å®šçš„å¼‚å¸¸æ‰è¿›è¡Œå›æ»šï¼Œä¸æŒ‡å®šçš„è¯é»˜è®¤æ˜¯ RuntimeException/Error éæ£€æŸ¥å‹å¼‚å¸¸èœå›æ»š</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> rbRule <span class="token operator">:</span> attributes<span class="token punctuation">.</span><span class="token function">getClassArray</span><span class="token punctuation">(</span><span class="token string">&quot;rollbackFor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rollbackRules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RollbackRuleAttribute</span><span class="token punctuation">(</span>rbRule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ä¸ rollbackFor åŠŸèƒ½ç›¸åŒ</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> rbRule <span class="token operator">:</span> attributes<span class="token punctuation">.</span><span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token string">&quot;rollbackForClassName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rollbackRules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RollbackRuleAttribute</span><span class="token punctuation">(</span>rbRule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è¡¨ç¤ºäº‹åŠ¡ç¢°åˆ°æŒ‡å®šçš„ exception å®ç°å¯¹è±¡ä¸è¿›è¡Œå›æ»šï¼Œå¦åˆ™ç¢°åˆ°å…¶ä»–çš„classå°±è¿›è¡Œå›æ»š</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> rbRule <span class="token operator">:</span> attributes<span class="token punctuation">.</span><span class="token function">getClassArray</span><span class="token punctuation">(</span><span class="token string">&quot;noRollbackFor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rollbackRules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NoRollbackRuleAttribute</span><span class="token punctuation">(</span>rbRule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> rbRule <span class="token operator">:</span> attributes<span class="token punctuation">.</span><span class="token function">getStringArray</span><span class="token punctuation">(</span><span class="token string">&quot;noRollbackForClassName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rollbackRules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NoRollbackRuleAttribute</span><span class="token punctuation">(</span>rbRule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è®¾ç½®å›æ»šè§„åˆ™</span>
    rbta<span class="token punctuation">.</span><span class="token function">setRollbackRules</span><span class="token punctuation">(</span>rollbackRules<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> rbta<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="é©±åŠ¨æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#é©±åŠ¨æ–¹æ³•" aria-hidden="true">#</a> é©±åŠ¨æ–¹æ³•</h4><p>TransactionInterceptor äº‹åŠ¡æ‹¦æˆªå™¨çš„æ ¸å¿ƒé©±åŠ¨æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">MethodInvocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
    <span class="token comment">// targetClass æ˜¯éœ€è¦è¢«äº‹åŠ¡å¢å¼ºå™¨å¢å¼ºçš„ç›®æ ‡ç±»ï¼Œinvocation.getThis() â†’ ç›®æ ‡å¯¹è±¡ â†’ ç›®æ ‡ç±»</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass <span class="token operator">=</span> <span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">AopUtils</span><span class="token punctuation">.</span><span class="token function">getTargetClass</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// å‚æ•°ä¸€æ˜¯ç›®æ ‡æ–¹æ³•ï¼Œå‚æ•°äºŒæ˜¯ç›®æ ‡ç±»ï¼Œå‚æ•°ä¸‰æ˜¯æ–¹æ³•å¼•ç”¨ï¼Œç”¨æ¥è§¦å‘é©±åŠ¨æ–¹æ³•</span>
    <span class="token keyword">return</span> <span class="token function">invokeWithinTransaction</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> invocation<span class="token operator">::</span><span class="token function">proceed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">invokeWithinTransaction</span><span class="token punctuation">(</span><span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> targetClass<span class="token punctuation">,</span>
                                         <span class="token keyword">final</span> <span class="token class-name">InvocationCallback</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>

    <span class="token comment">// äº‹åŠ¡å±æ€§æºä¿¡æ¯</span>
    <span class="token class-name">TransactionAttributeSource</span> tas <span class="token operator">=</span> <span class="token function">getTransactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//  æå– @Transactional æ³¨è§£ä¿¡æ¯ï¼ŒtxAttr æ˜¯æ³¨è§£ä¿¡æ¯çš„æ‰¿è½½å¯¹è±¡</span>
    <span class="token keyword">final</span> <span class="token class-name">TransactionAttribute</span> txAttr <span class="token operator">=</span> <span class="token punctuation">(</span>tas <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> tas<span class="token punctuation">.</span><span class="token function">getTransactionAttribute</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è·å– Spring é…ç½®çš„äº‹åŠ¡ç®¡ç†å™¨</span>
    <span class="token comment">// é¦–å…ˆä¼šæ£€æŸ¥æ˜¯å¦é€šè¿‡XMLæˆ–æ³¨è§£é…ç½® qualifierï¼Œæ²¡æœ‰å°±å°è¯•å»å®¹å™¨è·å–ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸º DatasourceTransactionManager</span>
    <span class="token keyword">final</span> <span class="token class-name">PlatformTransactionManager</span> tm <span class="token operator">=</span> <span class="token function">determineTransactionManager</span><span class="token punctuation">(</span>txAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æƒé™å®šç±»å.æ–¹æ³•åï¼Œè¯¥å€¼ç”¨æ¥å½“åšäº‹åŠ¡åç§°ä½¿ç”¨</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> joinpointIdentification <span class="token operator">=</span> <span class="token function">methodIdentification</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> txAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
	<span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜æ˜¯ã€å£°æ˜å¼äº‹åŠ¡ã€‘</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>tm <span class="token keyword">instanceof</span> <span class="token class-name">CallbackPreferringPlatformTransactionManager</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token comment">// ç”¨æ¥ã€å¼€å¯äº‹åŠ¡ã€‘</span>
        <span class="token class-name">TransactionInfo</span> txInfo <span class="token operator">=</span> <span class="token function">createTransactionIfNecessary</span><span class="token punctuation">(</span>tm<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> joinpointIdentification<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Object</span> retVal<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// This is an ã€around adviceã€‘: Invoke the next interceptor in the chain.</span>
            <span class="token comment">// ç¯ç»•é€šçŸ¥ï¼Œæ‰§è¡Œç›®æ ‡æ–¹æ³•ï¼ˆæ–¹æ³•å¼•ç”¨æ–¹å¼ï¼Œinvocation::proceedï¼Œè¿˜æ˜¯è°ƒç”¨ proceedï¼‰</span>
            retVal <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">proceedWithInvocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//  æ‰§è¡Œä¸šåŠ¡ä»£ç æ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œæ‰§è¡Œå›æ»šé€»è¾‘</span>
            <span class="token function">completeTransactionAfterThrowing</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ¸…ç†äº‹åŠ¡çš„ä¿¡æ¯</span>
            <span class="token function">cleanupTransactionInfo</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// æäº¤äº‹åŠ¡çš„å…¥å£</span>
        <span class="token function">commitTransactionAfterReturning</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
       <span class="token comment">// ç¼–ç¨‹å¼äº‹åŠ¡ï¼Œçœç•¥</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="å¼€å¯äº‹åŠ¡" tabindex="-1"><a class="header-anchor" href="#å¼€å¯äº‹åŠ¡" aria-hidden="true">#</a> å¼€å¯äº‹åŠ¡</h4><h5 id="äº‹åŠ¡ç»‘å®š" tabindex="-1"><a class="header-anchor" href="#äº‹åŠ¡ç»‘å®š" aria-hidden="true">#</a> äº‹åŠ¡ç»‘å®š</h5><p>åˆ›å»ºäº‹åŠ¡çš„æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">TransactionInfo</span> <span class="token function">createTransactionIfNecessary</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">PlatformTransactionManager</span> tm<span class="token punctuation">,</span>
                                                       <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionAttribute</span> txAttr<span class="token punctuation">,</span> 
                                                       <span class="token keyword">final</span> <span class="token class-name">String</span> joinpointIdentification<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// If no name specified, apply method identification as transaction name.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> txAttr<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// äº‹åŠ¡çš„åç§°ï¼š ç±»çš„æƒé™å®šå.æ–¹æ³•å</span>
        txAttr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelegatingTransactionAttribute</span><span class="token punctuation">(</span>txAttr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> joinpointIdentification<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">TransactionStatus</span> status <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tm <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// é€šè¿‡äº‹åŠ¡ç®¡ç†å™¨æ ¹æ®äº‹åŠ¡å±æ€§åˆ›å»ºäº‹åŠ¡çŠ¶æ€å¯¹è±¡ï¼Œäº‹åŠ¡çŠ¶æ€å¯¹è±¡ä¸€èˆ¬æƒ…å†µä¸‹åŒ…è£…ç€ äº‹åŠ¡å¯¹è±¡ï¼Œå½“ç„¶ä¹Ÿæœ‰å¯èƒ½æ˜¯null</span>
            <span class="token comment">// æ–¹æ³•ä¸Šçš„æ³¨è§£ä¸º @Transactional(propagation = NOT_SUPPORTED || propagation = NEVER) æ—¶</span>
            <span class="token comment">// ã€ä¸‹ä¸€å°èŠ‚è¯¦è§£ã€‘</span>
            status <span class="token operator">=</span> tm<span class="token punctuation">.</span><span class="token function">getTransaction</span><span class="token punctuation">(</span>txAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Skipping transactional joinpoint [&quot;</span> <span class="token operator">+</span> joinpointIdentification <span class="token operator">+</span>
                             <span class="token string">&quot;] because no transaction manager has been configured&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// åŒ…è£…æˆä¸€ä¸ªä¸Šå±‚çš„äº‹åŠ¡ä¸Šä¸‹æ–‡å¯¹è±¡</span>
    <span class="token keyword">return</span> <span class="token function">prepareTransactionInfo</span><span class="token punctuation">(</span>tm<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> joinpointIdentification<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>TransactionAspectSupport#prepareTransactionInfoï¼šä¸ºäº‹åŠ¡çš„å±æ€§å’ŒçŠ¶æ€å‡†å¤‡ä¸€ä¸ªäº‹åŠ¡ä¿¡æ¯å¯¹è±¡</p><ul><li><code>TransactionInfo txInfo = new TransactionInfo(tm, txAttr, joinpointIdentification)</code>ï¼šåˆ›å»ºäº‹åŠ¡ä¿¡æ¯å¯¹è±¡</li><li><code>txInfo.newTransactionStatus(status)</code>ï¼šå¡«å……äº‹åŠ¡çš„çŠ¶æ€ä¿¡æ¯</li><li><code>txInfo.bindToThread()</code>ï¼šåˆ©ç”¨ ThreadLocal <strong>æŠŠå½“å‰äº‹åŠ¡ä¿¡æ¯ç»‘å®šåˆ°å½“å‰çº¿ç¨‹</strong>ï¼Œä¸åŒçš„äº‹åŠ¡ä¿¡æ¯ä¼šå½¢æˆä¸€ä¸ªæ ˆçš„ç»“æ„ <ul><li><code>this.oldTransactionInfo = transactionInfoHolder.get()</code>ï¼šè·å–å…¶ä»–äº‹åŠ¡çš„ä¿¡æ¯å­˜å…¥ oldTransactionInfo</li><li><code>transactionInfoHolder.set(this)</code>ï¼šå°†å½“å‰çš„äº‹åŠ¡ä¿¡æ¯è®¾ç½®åˆ° ThreadLocalMap ä¸­</li></ul></li></ul><hr><h5 id="äº‹åŠ¡åˆ›å»º" tabindex="-1"><a class="header-anchor" href="#äº‹åŠ¡åˆ›å»º" aria-hidden="true">#</a> äº‹åŠ¡åˆ›å»º</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">TransactionStatus</span> <span class="token function">getTransaction</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–äº‹åŠ¡çš„å¯¹è±¡</span>
    <span class="token class-name">Object</span> transaction <span class="token operator">=</span> <span class="token function">doGetTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> debugEnabled <span class="token operator">=</span> logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>definition <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Use defaults if no transaction definition given.</span>
        definition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultTransactionDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰æ˜¯äº‹åŠ¡é‡å…¥çš„æƒ…å†µï¼Œäº‹åŠ¡ä¸­æœ‰ ConnectionHolder å¯¹è±¡</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExistingTransaction</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// aæ–¹æ³•å¼€å¯äº‹åŠ¡ï¼Œaæ–¹æ³•å†…è°ƒç”¨bæ–¹æ³•ï¼Œbæ–¹æ³•ä»ç„¶åŠ äº† @Transactional æ³¨è§£ï¼Œéœ€è¦æ£€æŸ¥ä¼ æ’­è¡Œä¸º</span>
        <span class="token keyword">return</span> <span class="token function">handleExistingTransaction</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
	<span class="token comment">// é€»è¾‘åˆ°è¿™è¯´æ˜å½“å‰çº¿ç¨‹æ²¡æœ‰è¿æ¥èµ„æºï¼Œä¸€ä¸ªè¿æ¥å¯¹åº”ä¸€ä¸ªäº‹åŠ¡ï¼Œæ²¡æœ‰è¿æ¥å°±ç›¸å½“äºæ²¡æœ‰å¼€å¯äº‹åŠ¡</span>
    <span class="token comment">// æ£€æŸ¥äº‹åŠ¡çš„å»¶è¿Ÿå±æ€§</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">TIMEOUT_DEFAULT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidTimeoutException</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid transaction timeout&quot;</span><span class="token punctuation">,</span> definition<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ä¼ æ’­è¡Œä¸ºæ˜¯ MANDATORYï¼Œæ²¡æœ‰äº‹åŠ¡å°±æŠ›å‡ºå¼‚å¸¸</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PROPAGATION_MANDATORY</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalTransactionStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// éœ€è¦å¼€å¯äº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PROPAGATION_REQUIRED</span> <span class="token operator">||</span>
             definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PROPAGATION_REQUIRES_NEW</span> <span class="token operator">||</span>
             definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PROPAGATION_NESTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä»€ä¹ˆä¹Ÿæ²¡æŒ‚èµ·ï¼Œå› ä¸ºçº¿ç¨‹å¹¶æ²¡æœ‰ç»‘å®šäº‹åŠ¡</span>
        <span class="token class-name">SuspendedResourcesHolder</span> suspendedResources <span class="token operator">=</span> <span class="token function">suspend</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ˜¯å¦æ”¯æŒåŒæ­¥çº¿ç¨‹äº‹åŠ¡ï¼Œä¸€èˆ¬æ˜¯ true</span>
            <span class="token keyword">boolean</span> newSynchronization <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">getTransactionSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">SYNCHRONIZATION_NEVER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ–°å»ºä¸€ä¸ªäº‹åŠ¡çŠ¶æ€ä¿¡æ¯</span>
            <span class="token class-name">DefaultTransactionStatus</span> status <span class="token operator">=</span> <span class="token function">newTransactionStatus</span><span class="token punctuation">(</span>
                definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> newSynchronization<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ã€å¯åŠ¨äº‹åŠ¡ã€‘</span>
            <span class="token function">doBegin</span><span class="token punctuation">(</span>transaction<span class="token punctuation">,</span> definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è®¾ç½®çº¿ç¨‹ä¸Šä¸‹æ–‡å˜é‡ï¼Œæ–¹ä¾¿ç¨‹åºè¿è¡ŒæœŸé—´è·å–å½“å‰äº‹åŠ¡çš„ä¸€äº›æ ¸å¿ƒçš„å±æ€§ï¼ŒinitSynchronization() å¯åŠ¨åŒæ­¥</span>
            <span class="token function">prepareSynchronization</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> definition<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> status<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> <span class="token operator">|</span> <span class="token class-name">Error</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ¢å¤ç°åœº</span>
            <span class="token function">resume</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ä¸æ”¯æŒäº‹åŠ¡çš„ä¼ æ’­è¡Œä¸º</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// Create &quot;empty&quot; transaction: no actual transaction, but potentially synchronization.</span>
        <span class="token keyword">boolean</span> newSynchronization <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">getTransactionSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">SYNCHRONIZATION_ALWAYS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ›å»ºäº‹åŠ¡çŠ¶æ€å¯¹è±¡</span>
        <span class="token comment">// å‚æ•°2 transaction æ˜¯ null è¯´æ˜å½“å‰äº‹åŠ¡çŠ¶æ€æ˜¯æœªæ‰‹åŠ¨å¼€å¯äº‹ï¼Œçº¿ç¨‹ä¸Šæœªç»‘å®šä»»ä½•çš„è¿æ¥èµ„æºï¼Œä¸šåŠ¡ç¨‹åºæ‰§è¡Œæ—¶éœ€è¦å…ˆå» datasource è·å–çš„ connï¼Œæ˜¯è‡ªåŠ¨æäº¤äº‹åŠ¡çš„ï¼Œä¸éœ€è¦ Spring å†æäº¤äº‹åŠ¡</span>
        <span class="token comment">// å‚æ•°6 suspendedResources æ˜¯ null è¯´æ˜å½“å‰äº‹åŠ¡çŠ¶æ€æœªæŒ‚èµ·ä»»ä½•äº‹åŠ¡ï¼Œå½“å‰äº‹åŠ¡æ‰§è¡Œåˆ°åç½®å¤„ç†æ—¶ä¸éœ€è¦æ¢å¤ç°åœº</span>
        <span class="token keyword">return</span> <span class="token function">prepareTransactionStatus</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> newSynchronization<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>DataSourceTransactionManager#doGetTransactionï¼šçœŸæ­£è·å–äº‹åŠ¡çš„æ–¹æ³•</p><ul><li><p><code>DataSourceTransactionObject txObject = new DataSourceTransactionObject()</code>ï¼š<strong>åˆ›å»ºäº‹åŠ¡å¯¹è±¡</strong></p></li><li><p><code>txObject.setSavepointAllowed(isNestedAllowed())</code>ï¼šè®¾ç½®äº‹åŠ¡å¯¹è±¡æ˜¯å¦æ”¯æŒä¿å­˜ç‚¹ï¼Œç”±äº‹åŠ¡ç®¡ç†å™¨æ§åˆ¶ï¼ˆé»˜è®¤ä¸æ”¯æŒï¼‰</p></li><li><p><code>ConnectionHolder conHolder = TransactionSynchronizationManager.getResource(obtainDataSource())</code>ï¼š</p><ul><li><p>ä» ThreadLocal ä¸­è·å– conHolder èµ„æºï¼Œå¯èƒ½æ‹¿åˆ° null æˆ–è€…ä¸æ˜¯ null</p></li><li><p>æ˜¯ nullï¼šä¸¾ä¾‹</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Transaction</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>b<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>ä¸æ˜¯ nullï¼šæ‰§è¡Œ b æ–¹æ³•äº‹åŠ¡å¢å¼ºçš„å‰ç½®é€»è¾‘æ—¶ï¼Œå¯ä»¥æ‹¿åˆ° a æ”¾è¿›å»çš„ conHolder èµ„æº</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Transaction</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></li><li><p><code>txObject.setConnectionHolder(conHolder, false)</code>ï¼šå°† ConnectionHolder ä¿å­˜åˆ°äº‹åŠ¡å¯¹è±¡å†…ï¼Œå‚æ•°äºŒæ˜¯ false ä»£è¡¨è¿æ¥èµ„æºæ˜¯ä¸Šå±‚äº‹åŠ¡å…±äº«çš„ï¼Œä¸æ˜¯æ–°å»ºçš„è¿æ¥èµ„æº</p></li><li><p><code>return txObject</code>ï¼šè¿”å›äº‹åŠ¡çš„å¯¹è±¡</p></li></ul><p>DataSourceTransactionManager#doBeginï¼šäº‹åŠ¡å¼€å¯çš„é€»è¾‘</p><ul><li><p><code>txObject = (DataSourceTransactionObject) transaction</code>ï¼šå¼ºè½¬ä¸ºäº‹åŠ¡å¯¹è±¡</p></li><li><p>äº‹åŠ¡ä¸­æ²¡æœ‰æ•°æ®åº“è¿æ¥èµ„æºå°±è¦åˆ†é…ï¼š</p><p><code>Connection newCon = obtainDataSource().getConnection()</code>ï¼š<strong>è·å– JDBC åŸç”Ÿçš„æ•°æ®åº“è¿æ¥å¯¹è±¡</strong></p><p><code>txObject.setConnectionHolder(new ConnectionHolder(newCon), true)</code>ï¼šä»£è¡¨æ˜¯æ–°å¼€å¯çš„äº‹åŠ¡ï¼Œæ–°å»ºçš„è¿æ¥å¯¹è±¡</p></li><li><p><code>previousIsolationLevel = DataSourceUtils.prepareConnectionForTransaction(con, definition)</code>ï¼šä¿®æ”¹è¿æ¥å±æ€§</p><ul><li><p><code>if (definition != null &amp;&amp; definition.isReadOnly())</code>ï¼šæ³¨è§£ï¼ˆæˆ– XMLï¼‰é…ç½®äº†åªè¯»å±æ€§ï¼Œéœ€è¦è®¾ç½®</p></li><li><p><code>if (..definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT)</code>ï¼šæ³¨è§£é…ç½®äº†éš”ç¦»çº§åˆ«</p><p><code>int currentIsolation = con.getTransactionIsolation()</code>ï¼šè·å–è¿æ¥çš„éš”ç¦»ç•Œåˆ«</p><p><code>previousIsolationLevel = currentIsolation</code>ï¼šä¿å­˜ä¹‹å‰çš„éš”ç¦»ç•Œåˆ«ï¼Œè¿”å›è¯¥å€¼</p><p><code> con.setTransactionIsolation(definition.getIsolationLevel())</code>ï¼š<strong>å°†å½“å‰è¿æ¥è®¾ç½®ä¸ºé…ç½®çš„éš”ç¦»ç•Œåˆ«</strong></p></li></ul></li><li><p><code>txObject.setPreviousIsolationLevel(previousIsolationLevel)</code>ï¼šå°† Conn åŸæ¥çš„éš”ç¦»çº§åˆ«ä¿å­˜åˆ°äº‹åŠ¡å¯¹è±¡ï¼Œä¸ºäº†é‡Šæ”¾ Conn æ—¶é‡ç½®å›åŸçŠ¶æ€</p></li><li><p><code>if (con.getAutoCommit())</code>ï¼šé»˜è®¤ä¼šæˆç«‹ï¼Œè¯´æ˜è¿˜æ²¡å¼€å¯äº‹åŠ¡</p><p><code>txObject.setMustRestoreAutoCommit(true)</code>ï¼šä¿å­˜ Conn åŸæ¥çš„äº‹åŠ¡çŠ¶æ€</p><p><code>con.setAutoCommit(false)</code>ï¼š<strong>å¼€å¯äº‹åŠ¡ï¼ŒJDBC åŸç”Ÿçš„æ–¹å¼</strong></p></li><li><p><code>txObject.getConnectionHolder().setTransactionActive(true)</code>ï¼šè¡¨ç¤º Holder æŒæœ‰çš„ Conn å·²ç»æ‰‹åŠ¨å¼€å¯äº‹åŠ¡äº†</p></li><li><p><code>TransactionSynchronizationManager.bindResource(obtainDataSource(), txObject.getConnectionHolder())</code>ï¼šå°† ConnectionHolder å¯¹è±¡ç»‘å®šåˆ° ThreadLocal å†…ï¼Œæ•°æ®æºä¸º keyï¼Œä¸ºäº†æ–¹ä¾¿è·å–æ‰‹åŠ¨å¼€å¯äº‹åŠ¡çš„è¿æ¥å¯¹è±¡å»æ‰§è¡Œ SQL</p></li></ul><hr><h5 id="äº‹åŠ¡é‡å…¥" tabindex="-1"><a class="header-anchor" href="#äº‹åŠ¡é‡å…¥" aria-hidden="true">#</a> äº‹åŠ¡é‡å…¥</h5><p>äº‹åŠ¡é‡å…¥çš„æ ¸å¿ƒå¤„ç†é€»è¾‘ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">TransactionStatus</span> <span class="token function">handleExistingTransaction</span><span class="token punctuation">(</span> <span class="token class-name">TransactionDefinition</span> definition<span class="token punctuation">,</span> 
                                                    <span class="token class-name">Object</span> transaction<span class="token punctuation">,</span> <span class="token keyword">boolean</span> debugEnabled<span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token comment">// ä¼ æ’­è¡Œä¸ºæ˜¯ PROPAGATION_NEVERï¼Œéœ€è¦ä»¥éäº‹åŠ¡æ–¹å¼æ‰§è¡Œæ“ä½œï¼Œå¦‚æœå½“å‰äº‹åŠ¡å­˜åœ¨åˆ™ã€æŠ›å‡ºå¼‚å¸¸ã€‘</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PROPAGATION_NEVER</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalTransactionStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// ä¼ æ’­è¡Œä¸ºæ˜¯ PROPAGATION_NOT_SUPPORTEDï¼Œä»¥éäº‹åŠ¡æ–¹å¼è¿è¡Œï¼Œå¦‚æœå½“å‰å­˜åœ¨äº‹åŠ¡ï¼Œåˆ™ã€æŠŠå½“å‰äº‹åŠ¡æŒ‚èµ·ã€‘</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PROPAGATION_NOT_SUPPORTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æŒ‚èµ·äº‹åŠ¡</span>
        <span class="token class-name">Object</span> suspendedResources <span class="token operator">=</span> <span class="token function">suspend</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> newSynchronization <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">getTransactionSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">SYNCHRONIZATION_ALWAYS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ›å»ºä¸€ä¸ªéäº‹åŠ¡çš„äº‹åŠ¡çŠ¶æ€å¯¹è±¡è¿”å›</span>
        <span class="token keyword">return</span> <span class="token function">prepareTransactionStatus</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newSynchronization<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// å¼€å¯æ–°äº‹ç‰©çš„é€»è¾‘</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PROPAGATION_REQUIRES_NEW</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ã€æŒ‚èµ·å½“å‰äº‹åŠ¡ã€‘</span>
        <span class="token class-name">SuspendedResourcesHolder</span> suspendedResources <span class="token operator">=</span> <span class="token function">suspend</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
       	<span class="token comment">// ã€å¼€å¯æ–°äº‹ç‰©ã€‘</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// ä¼ æ’­è¡Œä¸ºæ˜¯ PROPAGATION_NESTEDï¼ŒåµŒå¥—äº‹åŠ¡</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>definition<span class="token punctuation">.</span><span class="token function">getPropagationBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">TransactionDefinition</span><span class="token punctuation">.</span><span class="token constant">PROPAGATION_NESTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Spring é»˜è®¤ä¸æ”¯æŒå†…åµŒäº‹åŠ¡</span>
        <span class="token comment">// ã€å¼€å¯æ–¹å¼ã€‘ï¼š&lt;property name=&quot;nestedTransactionAllowed&quot; value=&quot;true&quot;&gt;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNestedTransactionAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NestedTransactionNotSupportedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">useSavepointForNestedTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//  ä¸ºå½“å‰æ–¹æ³•åˆ›å»ºä¸€ä¸ª TransactionStatus å¯¹è±¡ï¼Œ</span>
            <span class="token class-name">DefaultTransactionStatus</span> status <span class="token operator">=</span>
                <span class="token function">prepareTransactionStatus</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// åˆ›å»ºä¸€ä¸ª JDBC çš„ä¿å­˜ç‚¹</span>
            status<span class="token punctuation">.</span><span class="token function">createAndHoldSavepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// ä¸éœ€è¦ä½¿ç”¨åŒæ­¥ï¼Œç›´æ¥è¿”å›</span>
            <span class="token keyword">return</span> status<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Usually only for JTA transactionï¼Œå¼€å¯ä¸€ä¸ªæ–°äº‹åŠ¡</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Assumably PROPAGATION_SUPPORTS or PROPAGATION_REQUIREDï¼Œã€ä½¿ç”¨å½“å‰çš„äº‹åŠ¡ã€‘</span>
    <span class="token keyword">boolean</span> newSynchronization <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">getTransactionSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">SYNCHRONIZATION_NEVER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">prepareTransactionStatus</span><span class="token punctuation">(</span>definition<span class="token punctuation">,</span> transaction<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newSynchronization<span class="token punctuation">,</span> debugEnabled<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h5 id="æŒ‚èµ·æ¢å¤" tabindex="-1"><a class="header-anchor" href="#æŒ‚èµ·æ¢å¤" aria-hidden="true">#</a> æŒ‚èµ·æ¢å¤</h5><p>AbstractPlatformTransactionManager#suspendï¼š<strong>æŒ‚èµ·äº‹åŠ¡</strong>ï¼Œå¹¶è·å¾—ä¸€ä¸ªä¸Šä¸‹æ–‡ä¿¡æ¯å¯¹è±¡</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">SuspendedResourcesHolder</span> <span class="token function">suspend</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// äº‹åŠ¡æ˜¯åŒæ­¥çŠ¶æ€çš„</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">isSynchronizationActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransactionSynchronization</span><span class="token punctuation">&gt;</span></span> suspendedSynchronizations <span class="token operator">=</span> <span class="token function">doSuspendSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> suspendedResources <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>transaction <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// do it</span>
                suspendedResources <span class="token operator">=</span> <span class="token function">doSuspend</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//å°†ä¸Šå±‚äº‹åŠ¡ç»‘å®šåœ¨çº¿ç¨‹ä¸Šä¸‹æ–‡çš„å˜é‡å…¨éƒ¨å–å‡ºæ¥</span>
            <span class="token comment">//...</span>
            <span class="token comment">// é€šè¿‡è¢«æŒ‚èµ·çš„èµ„æºå’Œä¸Šå±‚äº‹åŠ¡çš„ä¸Šä¸‹æ–‡å˜é‡ï¼Œåˆ›å»ºä¸€ä¸ªã€SuspendedResourcesHolderã€‘è¿”å›</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SuspendedResourcesHolder</span><span class="token punctuation">(</span>suspendedResources<span class="token punctuation">,</span> suspendedSynchronizations<span class="token punctuation">,</span> 
                                                name<span class="token punctuation">,</span> readOnly<span class="token punctuation">,</span> isolationLevel<span class="token punctuation">,</span> wasActive<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token comment">//...</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">doSuspend</span><span class="token punctuation">(</span><span class="token class-name">Object</span> transaction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DataSourceTransactionObject</span> txObject <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DataSourceTransactionObject</span><span class="token punctuation">)</span> transaction<span class="token punctuation">;</span>
    <span class="token comment">// å°†å½“å‰æ–¹æ³•çš„äº‹åŠ¡å¯¹è±¡ connectionHolder å±æ€§ç½®ä¸º nullï¼Œä¸å’Œä¸Šå±‚å…±äº«èµ„æº</span>
    <span class="token comment">// å½“å‰æ–¹æ³•æœ‰å¯èƒ½æ˜¯ä¸å¼€å¯äº‹åŠ¡æˆ–è€…è¦å¼€å¯ä¸€ä¸ªç‹¬ç«‹çš„äº‹åŠ¡</span>
    txObject<span class="token punctuation">.</span><span class="token function">setConnectionHolder</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ã€è§£ç»‘åœ¨çº¿ç¨‹ä¸Šçš„äº‹åŠ¡ã€‘</span>
    <span class="token keyword">return</span> <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">unbindResource</span><span class="token punctuation">(</span><span class="token function">obtainDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AbstractPlatformTransactionManager#resumeï¼š<strong>æ¢å¤ç°åœº</strong>ï¼Œæ ¹æ®æŒ‚èµ·èµ„æºå»æ¢å¤çº¿ç¨‹ä¸Šä¸‹æ–‡ä¿¡æ¯</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">resume</span><span class="token punctuation">(</span><span class="token class-name">Object</span> transaction<span class="token punctuation">,</span> <span class="token class-name">SuspendedResourcesHolder</span> resourcesHolder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>resourcesHolder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–è¢«æŒ‚èµ·çš„äº‹åŠ¡èµ„æº</span>
        <span class="token class-name">Object</span> suspendedResources <span class="token operator">=</span> resourcesHolder<span class="token punctuation">.</span>suspendedResources<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>suspendedResources <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//ç»‘å®šä¸Šä¸€ä¸ªäº‹åŠ¡çš„ ConnectionHolder åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡</span>
            <span class="token function">doResume</span><span class="token punctuation">(</span>transaction<span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TransactionSynchronization</span><span class="token punctuation">&gt;</span></span> suspendedSynchronizations <span class="token operator">=</span> resourcesHolder<span class="token punctuation">.</span>suspendedSynchronizations<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>suspendedSynchronizations <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//....</span>
            <span class="token comment">// å°†çº¿ç¨‹ä¸Šä¸‹æ–‡å˜é‡æ¢å¤ä¸ºä¸Šä¸€ä¸ªäº‹åŠ¡çš„æŒ‚èµ·ç°åœº</span>
            <span class="token function">doResumeSynchronization</span><span class="token punctuation">(</span>suspendedSynchronizations<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doResume</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> transaction<span class="token punctuation">,</span> <span class="token class-name">Object</span> suspendedResources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// doSuspend çš„é€†åŠ¨ä½œï¼Œã€ç»‘å®šèµ„æºã€‘</span>
    <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">bindResource</span><span class="token punctuation">(</span><span class="token function">obtainDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> suspendedResources<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="æäº¤å›æ»š" tabindex="-1"><a class="header-anchor" href="#æäº¤å›æ»š" aria-hidden="true">#</a> æäº¤å›æ»š</h4><h5 id="å›æ»šæ–¹å¼" tabindex="-1"><a class="header-anchor" href="#å›æ»šæ–¹å¼" aria-hidden="true">#</a> å›æ»šæ–¹å¼</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">completeTransactionAfterThrowing</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionInfo</span> txInfo<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// äº‹åŠ¡çŠ¶æ€ä¿¡æ¯ä¸ä¸ºç©ºè¿›å…¥é€»è¾‘</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>txInfo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> txInfo<span class="token punctuation">.</span><span class="token function">getTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ¡ä»¶äºŒæˆç«‹ è¯´æ˜ç›®æ ‡æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸éœ€è¦å›æ»šäº‹åŠ¡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>txInfo<span class="token punctuation">.</span>transactionAttribute <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> txInfo<span class="token punctuation">.</span>transactionAttribute<span class="token punctuation">.</span><span class="token function">rollbackOn</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// äº‹åŠ¡ç®¡ç†å™¨çš„å›æ»šæ–¹æ³•</span>
                txInfo<span class="token punctuation">.</span><span class="token function">getTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">.</span><span class="token function">getTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSystemException</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜å½“å‰äº‹åŠ¡è™½ç„¶æŠ›å‡ºäº†å¼‚å¸¸ï¼Œä½†æ˜¯è¯¥å¼‚å¸¸å¹¶ä¸ä¼šå¯¼è‡´æ•´ä¸ªäº‹åŠ¡å›æ»š</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// æäº¤äº‹åŠ¡</span>
                txInfo<span class="token punctuation">.</span><span class="token function">getTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">.</span><span class="token function">getTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TransactionSystemException</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">rollbackOn</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ç»§æ‰¿è‡ª RuntimeException æˆ– error çš„æ˜¯ã€éæ£€æŸ¥å‹å¼‚å¸¸ã€‘ï¼Œæ‰ä¼šå½’æ»šäº‹åŠ¡</span>
    <span class="token comment">// å¦‚æœé…ç½®äº†å…¶ä»–å›æ»šé”™è¯¯ï¼Œä¼šè·å–åˆ°å›æ»šè§„åˆ™ rollbackRules è¿›è¡Œåˆ¤æ–­</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">RuntimeException</span> <span class="token operator">||</span> ex <span class="token keyword">instanceof</span> <span class="token class-name">Error</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">rollback</span><span class="token punctuation">(</span><span class="token class-name">TransactionStatus</span> status<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span> <span class="token punctuation">{</span>
    <span class="token comment">// äº‹åŠ¡å·²ç»å®Œæˆä¸éœ€è¦å›æ»š</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalTransactionStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">DefaultTransactionStatus</span> defStatus <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DefaultTransactionStatus</span><span class="token punctuation">)</span> status<span class="token punctuation">;</span>
    <span class="token comment">// å¼€å§‹å›æ»šäº‹åŠ¡</span>
    <span class="token function">processRollback</span><span class="token punctuation">(</span>defStatus<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AbstractPlatformTransactionManager#processRollbackï¼šäº‹åŠ¡å›æ»š</p><ul><li><p><code>triggerBeforeCompletion(status)</code>ï¼šç”¨æ¥åšæ‰©å±•é€»è¾‘ï¼Œå›æ»šå‰çš„å‰ç½®å¤„ç†</p></li><li><p><code>if (status.hasSavepoint())</code>ï¼šæ¡ä»¶æˆç«‹è¯´æ˜å½“å‰äº‹åŠ¡æ˜¯ä¸€ä¸ª<strong>å†…åµŒäº‹åŠ¡</strong>ï¼Œå½“å‰æ–¹æ³•åªæ˜¯å¤ç”¨äº†ä¸Šå±‚äº‹åŠ¡çš„ä¸€ä¸ªå†…åµŒäº‹åŠ¡</p><p><code>status.rollbackToHeldSavepoint()</code>ï¼šå†…åµŒäº‹åŠ¡åŠ å…¥äº‹åŠ¡æ—¶ä¼šåˆ›å»ºä¸€ä¸ªä¿å­˜ç‚¹ï¼Œæ­¤æ—¶æ¢å¤è‡³ä¿å­˜ç‚¹</p></li><li><p><code>if (status.isNewTransaction())</code>ï¼šè¯´æ˜äº‹åŠ¡æ˜¯å½“å‰è¿æ¥å¼€å¯çš„ï¼Œéœ€è¦å»å›æ»šäº‹åŠ¡</p><p><code>doRollback(status)</code>ï¼šçœŸæ­£çš„çš„å›æ»šå‡½æ•°</p><ul><li><code>DataSourceTransactionObject txObject = status.getTransaction()</code>ï¼šè·å–äº‹åŠ¡å¯¹è±¡</li><li><code>Connection con = txObject.getConnectionHolder().getConnection()</code>ï¼šè·å–è¿æ¥å¯¹è±¡</li><li><code>con.rollback()</code>ï¼š<strong>JDBC çš„æ–¹å¼å›æ»šäº‹åŠ¡</strong></li></ul></li><li><p><code>else</code>ï¼šå½“å‰æ–¹æ³•æ˜¯å…±äº«çš„ä¸Šå±‚çš„äº‹åŠ¡ï¼Œå’Œä¸Šå±‚ä½¿ç”¨åŒä¸€ä¸ª Conn èµ„æºï¼Œ<strong>å…±äº«çš„äº‹åŠ¡ä¸èƒ½ç›´æ¥å›æ»šï¼Œåº”è¯¥äº¤ç»™ä¸Šå±‚å¤„ç†</strong></p><p><code>doSetRollbackOnly(status)</code>ï¼šè®¾ç½® con.rollbackOnly = trueï¼Œçº¿ç¨‹å›åˆ°ä¸Šå±‚äº‹åŠ¡ commit æ—¶ä¼šæ£€æŸ¥è¯¥å­—æ®µï¼Œç„¶åæ‰§è¡Œå›æ»šæ“ä½œ</p></li><li><p><code>triggerAfterCompletion(status, TransactionSynchronization.STATUS_ROLLED_BACK)</code>ï¼šå›æ»šçš„åç½®å¤„ç†</p></li><li><p><code>cleanupAfterCompletion(status)</code>ï¼šæ¸…ç†å’Œæ¢å¤ç°åœº</p></li></ul><hr><h5 id="æäº¤æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#æäº¤æ–¹å¼" aria-hidden="true">#</a> æäº¤æ–¹å¼</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">commitTransactionAfterReturning</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionInfo</span> txInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>txInfo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> txInfo<span class="token punctuation">.</span><span class="token function">getTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// äº‹åŠ¡ç®¡ç†å™¨çš„æäº¤æ–¹æ³•</span>
        txInfo<span class="token punctuation">.</span><span class="token function">getTransactionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">.</span><span class="token function">getTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token class-name">TransactionStatus</span> status<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionException</span> <span class="token punctuation">{</span>
    <span class="token comment">// å·²ç»å®Œæˆçš„äº‹åŠ¡ä¸éœ€è¦æäº¤äº†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalTransactionStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">DefaultTransactionStatus</span> defStatus <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DefaultTransactionStatus</span><span class="token punctuation">)</span> status<span class="token punctuation">;</span>
    <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜æ˜¯å½“å‰çš„ä¸šåŠ¡å¼ºåˆ¶å›æ»š</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>defStatus<span class="token punctuation">.</span><span class="token function">isLocalRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å›æ»šé€»è¾‘ï¼Œ</span>
        <span class="token function">processRollback</span><span class="token punctuation">(</span>defStatus<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// æˆç«‹è¯´æ˜å…±äº«å½“å‰äº‹åŠ¡çš„ã€ä¸‹å±‚äº‹åŠ¡é€»è¾‘å‡ºé”™ï¼Œéœ€è¦å›æ»šã€‘</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">shouldCommitOnGlobalRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> defStatus<span class="token punctuation">.</span><span class="token function">isGlobalRollbackOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœå½“å‰äº‹åŠ¡è¿˜æ˜¯äº‹åŠ¡é‡å…¥ï¼Œä¼šç»§ç»­æŠ›ç»™ä¸Šå±‚ï¼Œæœ€ä¸Šå±‚äº‹åŠ¡ä¼šè¿›è¡ŒçœŸå®çš„äº‹åŠ¡å›æ»šæ“ä½œ</span>
        <span class="token function">processRollback</span><span class="token punctuation">(</span>defStatus<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// æ‰§è¡Œæäº¤</span>
    <span class="token function">processCommit</span><span class="token punctuation">(</span>defStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>AbstractPlatformTransactionManager#processCommitï¼šäº‹åŠ¡æäº¤</p><ul><li><p><code>prepareForCommit(status)</code>ï¼šå‰ç½®å¤„ç†</p></li><li><p><code>if (status.hasSavepoint())</code>ï¼šæ¡ä»¶æˆç«‹è¯´æ˜å½“å‰äº‹åŠ¡æ˜¯ä¸€ä¸ª<strong>å†…åµŒäº‹åŠ¡</strong>ï¼Œåªæ˜¯å¤ç”¨äº†ä¸Šå±‚äº‹åŠ¡</p><p><code>status.releaseHeldSavepoint()</code>ï¼šæ¸…ç†ä¿å­˜ç‚¹ï¼Œå› ä¸ºæ²¡æœ‰å‘ç”Ÿä»»ä½•å¼‚å¸¸ï¼Œæ‰€ä»¥ä¿å­˜ç‚¹æ²¡æœ‰å­˜åœ¨çš„æ„ä¹‰äº†</p></li><li><p><code>if (status.isNewTransaction())</code>ï¼šè¯´æ˜äº‹åŠ¡æ˜¯å½’å±äºå½“å‰è¿æ¥çš„ï¼Œéœ€è¦å»æäº¤äº‹åŠ¡</p><p><code>doCommit(status)</code>ï¼šçœŸæ­£çš„æäº¤å‡½æ•°</p><ul><li><code>Connection con = txObject.getConnectionHolder().getConnection()</code>ï¼šè·å–è¿æ¥å¯¹è±¡</li><li><code>con.commit()</code>ï¼š<strong>JDBC çš„æ–¹å¼æäº¤äº‹åŠ¡</strong></li></ul></li><li><p><code>doRollbackOnCommitException(status, ex)</code>ï¼š<strong>æäº¤äº‹åŠ¡å‡ºé”™åè¿›è¡Œå›æ»š</strong></p></li><li><p><code> cleanupAfterCompletion(status)</code>ï¼šæ¸…ç†å’Œæ¢å¤ç°åœº</p></li></ul><hr><h5 id="æ¸…ç†ç°åœº" tabindex="-1"><a class="header-anchor" href="#æ¸…ç†ç°åœº" aria-hidden="true">#</a> æ¸…ç†ç°åœº</h5><p>æ¢å¤ä¸Šå±‚äº‹åŠ¡ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">cleanupTransactionInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">TransactionInfo</span> txInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>txInfo <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä»å½“å‰çº¿ç¨‹çš„ ThreadLocal è·å–ä¸Šå±‚çš„äº‹åŠ¡ä¿¡æ¯ï¼Œå°†å½“å‰äº‹åŠ¡å‡ºæ ˆï¼Œç»§ç»­æ‰§è¡Œä¸Šå±‚äº‹åŠ¡</span>
        txInfo<span class="token punctuation">.</span><span class="token function">restoreThreadLocalStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">restoreThreadLocalStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Use stack to restore old transaction TransactionInfo.</span>
    transactionInfoHolder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>oldTransactionInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å½“å‰å±‚çº§äº‹åŠ¡ç»“æŸæ—¶çš„æ¸…ç†ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">cleanupAfterCompletion</span><span class="token punctuation">(</span><span class="token class-name">DefaultTransactionStatus</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è®¾ç½®å½“å‰æ–¹æ³•çš„äº‹åŠ¡çŠ¶æ€ä¸ºå®ŒæˆçŠ¶æ€</span>
    status<span class="token punctuation">.</span><span class="token function">setCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isNewSynchronization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ¸…ç†çº¿ç¨‹ä¸Šä¸‹æ–‡å˜é‡ä»¥åŠæ‰©å±•ç‚¹æ³¨å†Œçš„ sync</span>
        <span class="token class-name">TransactionSynchronizationManager</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// äº‹åŠ¡æ˜¯å½“å‰çº¿ç¨‹å¼€å¯çš„</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isNewTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è§£ç»‘èµ„æº</span>
        <span class="token function">doCleanupAfterCompletion</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">getTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰äº‹åŠ¡æ‰§è¡Œçš„æ—¶å€™ï¼Œã€æŒ‚èµ·äº†ä¸€ä¸ªä¸Šå±‚çš„äº‹åŠ¡ã€‘</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">getSuspendedResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span> transaction <span class="token operator">=</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">hasTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> status<span class="token punctuation">.</span><span class="token function">getTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ¢å¤ä¸Šå±‚äº‹åŠ¡ç°åœº</span>
        <span class="token function">resume</span><span class="token punctuation">(</span>transaction<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">SuspendedResourcesHolder</span><span class="token punctuation">)</span> status<span class="token punctuation">.</span><span class="token function">getSuspendedResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>DataSourceTransactionManager#doCleanupAfterCompletionï¼šæ¸…ç†å·¥ä½œ</p><ul><li><p><code>TransactionSynchronizationManager.unbindResource(obtainDataSource())</code>ï¼šè§£ç»‘æ•°æ®åº“èµ„æº</p></li><li><p><code>if (txObject.isMustRestoreAutoCommit())</code>ï¼šæ˜¯å¦æ¢å¤è¿æ¥ï¼ŒConn å½’è¿˜åˆ° DataSource**ï¼Œå½’è¿˜å‰éœ€è¦æ¢å¤åˆ°ç”³è¯·æ—¶çš„çŠ¶æ€**</p><p><code>con.setAutoCommit(true)</code>ï¼šæ¢å¤è¿æ¥ä¸ºè‡ªåŠ¨æäº¤</p></li><li><p><code>DataSourceUtils.resetConnectionAfterTransaction(con, txObject.getPreviousIsolationLevel())</code>ï¼šæ¢å¤éš”ç¦»çº§åˆ«</p></li><li><p><code>DataSourceUtils.releaseConnection(con, this.dataSource)</code>ï¼š<strong>å°†è¿æ¥å½’è¿˜ç»™æ•°æ®åº“è¿æ¥æ± </strong></p></li><li><p><code>txObject.getConnectionHolder().clear()</code>ï¼šæ¸…ç† ConnectionHolder èµ„æº</p></li></ul><hr><h3 id="æ³¨è§£-1" tabindex="-1"><a class="header-anchor" href="#æ³¨è§£-1" aria-hidden="true">#</a> æ³¨è§£</h3><h4 id="component" tabindex="-1"><a class="header-anchor" href="#component" aria-hidden="true">#</a> Component</h4><p>@Component è§£ææµç¨‹ï¼š</p><ul><li><p>æ³¨è§£ç±»å¯åŠ¨å®¹å™¨çš„æ—¶ï¼Œæ³¨å†Œ ClassPathBeanDefinitionScanner åˆ°å®¹å™¨ï¼Œç”¨æ¥æ‰«æ Bean çš„ç›¸å…³ä¿¡æ¯</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> <span class="token function">doScan</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinitionHolder</span><span class="token punctuation">&gt;</span></span> beanDefinitions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// éå†æŒ‡å®šçš„æ‰€æœ‰çš„åŒ…ï¼Œã€è¿™å°±ç›¸å½“äºæ‰«æäº†ã€‘</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> basePackage <span class="token operator">:</span> basePackages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¯»å–å½“å‰åŒ…ä¸‹çš„èµ„æºè£…æ¢ä¸º BeanDefinitionï¼Œå­—èŠ‚æµçš„æ–¹å¼</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> candidates <span class="token operator">=</span> <span class="token function">findCandidateComponents</span><span class="token punctuation">(</span>basePackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinition</span> candidate <span class="token operator">:</span> candidates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// éå†ï¼Œå°è£…ï¼Œç±»ä¼¼äº XML çš„è§£ææ–¹å¼ï¼Œæ³¨å†Œåˆ°å®¹å™¨ä¸­</span>
            <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>definitionHolder<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>registry<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">return</span> beanDefinitions<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>ClassPathScanningCandidateComponentProvider.findCandidateComponents()</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> <span class="token function">findCandidateComponents</span><span class="token punctuation">(</span><span class="token class-name">String</span> basePackage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>componentsIndex <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">indexSupportsIncludeFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">addCandidateComponentsFromIndex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>componentsIndex<span class="token punctuation">,</span> basePackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">scanCandidateComponents</span><span class="token punctuation">(</span>basePackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BeanDefinition</span><span class="token punctuation">&gt;</span></span> <span class="token function">scanCandidateComponents</span><span class="token punctuation">(</span><span class="token class-name">String</span> basePackage<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li><p><code>String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX resolveBasePackage(basePackage) + &#39;/&#39; + this.resourcePattern</code> ï¼šå°† package è½¬åŒ–ä¸º ClassLoader ç±»èµ„æºæœç´¢è·¯å¾„ packageSearchPathï¼Œä¾‹å¦‚ï¼š<code>com.sea.spring.boot</code> è½¬åŒ–ä¸º <code>classpath*:com/sea/spring/boot/**/*.class</code></p></li><li><p><code>resources = getResourcePatternResolver().getResources(packageSearchPath)</code>ï¼šåŠ è½½è·¯å¾„ä¸‹çš„èµ„æº</p></li><li><p><code>for (Resource resource : resources) </code>ï¼šéå†æ‰€æœ‰çš„èµ„æº</p><p><code>metadataReader = getMetadataReaderFactory().getMetadataReader(resource)</code>ï¼šè·å–å…ƒæ•°æ®é˜…è¯»å™¨</p><p><code>if (isCandidateComponent(metadataReader))</code>ï¼š<strong>å½“å‰ç±»ä¸åŒ¹é…ä»»ä½•æ’é™¤è¿‡æ»¤å™¨ï¼Œå¹¶ä¸”åŒ¹é…ä¸€ä¸ªåŒ…å«è¿‡æ»¤å™¨</strong>ï¼Œè¿”å› true</p><ul><li><p>includeFilters ç”± <code>registerDefaultFilters()</code> è®¾ç½®åˆå§‹å€¼ï¼Œæ–¹æ³•æœ‰ @Componentï¼Œæ²¡æœ‰ @Serviceï¼Œå› ä¸º @Component æ˜¯ @Service çš„å…ƒæ³¨è§£ï¼ŒSpring åœ¨è¯»å– @Service æ—¶ä¹Ÿè¯»å–äº†å…ƒæ³¨è§£ï¼Œå¹¶å°† @Service ä½œä¸º @Component å¤„ç†</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">this</span><span class="token punctuation">.</span>includeFilters<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnnotationTypeFilter</span><span class="token punctuation">(</span><span class="token class-name">Component</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">TYPE</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Component</span>	<span class="token comment">// æ‹¥æœ‰äº† Component åŠŸèƒ½</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p><code>candidates.add(sbd)</code>ï¼šæ·»åŠ åˆ°è¿”å›ç»“æœçš„ list</p></li></ul></li></ul><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://my.oschina.net/floor/blog/4325651" target="_blank" rel="noopener noreferrer">https://my.oschina.net/floor/blog/4325651<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><hr><h4 id="autowired" tabindex="-1"><a class="header-anchor" href="#autowired" aria-hidden="true">#</a> Autowired</h4><p>æ‰“å¼€ @Autowired æºç ï¼Œæ³¨é‡Šä¸Šå†™ Please consult the javadoc for the AutowiredAnnotationBeanPostProcessor</p><p>AutowiredAnnotationBeanPostProcessor é—´æ¥å®ç° InstantiationAwareBeanPostProcessorï¼Œå°±å…·å¤‡äº†å®ä¾‹åŒ–å‰åï¼ˆè€Œä¸æ˜¯åˆå§‹åŒ–å‰åï¼‰ç®¡ç†å¯¹è±¡çš„èƒ½åŠ›ï¼Œå®ç°äº† BeanPostProcessorï¼Œå…·æœ‰åˆå§‹åŒ–å‰åç®¡ç†å¯¹è±¡çš„èƒ½åŠ›ï¼Œå®ç° BeanFactoryAwareï¼Œå…·å¤‡éšæ—¶æ‹¿åˆ° BeanFactory çš„èƒ½åŠ›ï¼Œæ‰€ä»¥è¿™ä¸ªç±»<strong>å…·å¤‡ä¸€åˆ‡åç½®å¤„ç†å™¨çš„èƒ½åŠ›</strong></p><p><strong>åœ¨å®¹å™¨å¯åŠ¨ï¼Œä¸ºå¯¹è±¡èµ‹å€¼çš„æ—¶å€™ï¼Œé‡åˆ° @Autowired æ³¨è§£ï¼Œä¼šç”¨åç½®å¤„ç†å™¨æœºåˆ¶ï¼Œæ¥åˆ›å»ºå±æ€§çš„å®ä¾‹ï¼Œç„¶åå†åˆ©ç”¨åå°„æœºåˆ¶ï¼Œå°†å®ä¾‹åŒ–å¥½çš„å±æ€§ï¼Œèµ‹å€¼ç»™å¯¹è±¡ä¸Šï¼Œè¿™å°±æ˜¯ Autowired çš„åŸç†</strong></p><p>ä½œç”¨æ—¶æœºï¼š</p><ul><li>Spring åœ¨æ¯ä¸ª Bean å®ä¾‹åŒ–ä¹‹åï¼Œè°ƒç”¨ AutowiredAnnotationBeanPostProcessor çš„ <code>postProcessMergedBeanDefinition()</code> æ–¹æ³•ï¼ŒæŸ¥æ‰¾è¯¥ Bean æ˜¯å¦æœ‰ @Autowired æ³¨è§£ï¼Œè¿›è¡Œç›¸å…³å…ƒæ•°æ®çš„è·å–</li><li>Spring åœ¨æ¯ä¸ª Bean è°ƒç”¨ <code>populateBean()</code> è¿›è¡Œå±æ€§æ³¨å…¥çš„æ—¶å€™ï¼Œå³è°ƒç”¨ <code>postProcessProperties()</code> æ–¹æ³•ï¼ŒæŸ¥æ‰¾è¯¥ Bean å±æ€§æ˜¯å¦æœ‰ @Autowired æ³¨è§£ï¼Œè¿›è¡Œç›¸å…³æ•°æ®çš„å¡«å……</li></ul><hr></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/rockbenben/LearnData/edit/main/docs/Springå…¨å®¶æ¡¶/Spring.md" rel="noopener noreferrer" target="_blank" aria-label="ç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->ç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><!----></div></footer><nav class="vp-page-nav"><a class="vp-link nav-link prev" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/MyBatis.html"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->MyBatis</div></a><a class="vp-link nav-link next" href="/learn_data/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/SpringBoot.html"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">SpringBoot<!----></div></a></nav><div id="comment" class="waline-wrapper" darkmode="false" style="display:block;"><div data-waline provider="Waline"><div class="wl-reaction"><div class="wl-reaction-title">å·²åˆ°è¾¾æ–‡ç« åº•éƒ¨ï¼Œæ¬¢è¿ç•™è¨€ã€è¡¨æƒ…äº’åŠ¨~</div><ul class="wl-reaction-list"><!--[--><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-y/twemoji/13.1.0/72x72/1f44d.png" alt="èµä¸€ä¸ª"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text">èµä¸€ä¸ª</div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-y/twemoji/13.1.0/72x72/1f44f.png" alt="æ”¯æŒä¸‹"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text">æ”¯æŒä¸‹</div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-y/twemoji/13.1.0/72x72/1f60e.png" alt="æœ‰ç‚¹é…·"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text">æœ‰ç‚¹é…·</div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-y/twemoji/13.1.0/72x72/1f602.png" alt="å•¥ç©æ„"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text">å•¥ç©æ„</div></li><li class="wl-reaction-item"><div class="wl-reaction-img"><img src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-y/twemoji/13.1.0/72x72/1f635-200d-1f4ab.png" alt="çœ‹ä¸æ‡‚"><div class="wl-reaction-votes">0</div></div><div class="wl-reaction-text">çœ‹ä¸æ‡‚</div></li><!--]--></ul></div><div class="wl-comment"><!--v-if--><div class="wl-panel"><div class="wl-header item3"><!--[--><div class="wl-header-item"><label for="wl-nick">æ˜µç§°</label><input id="wl-nick" class="wl-input wl-nick" name="nick" type="text" value></div><div class="wl-header-item"><label for="wl-mail">é‚®ç®±</label><input id="wl-mail" class="wl-input wl-mail" name="mail" type="email" value></div><div class="wl-header-item"><label for="wl-link">ç½‘å€</label><input id="wl-link" class="wl-input wl-link" name="link" type="text" value></div><!--]--></div><textarea id="wl-edit" class="wl-editor" placeholder="è¯·ç•™è¨€ã€‚(å¡«å†™é‚®ç®±å¯åœ¨è¢«å›å¤æ—¶æ”¶åˆ°é‚®ä»¶æé†’)"></textarea><div class="wl-preview" style="display:none;"><hr><h4>é¢„è§ˆ:</h4><div class="wl-content"></div></div><div class="wl-footer"><div class="wl-actions"><a href="https://guides.github.com/features/mastering-markdown/" title="Markdown Guide" aria-label="Markdown is supported" class="wl-action" target="_blank" rel="noopener noreferrer"><svg width="16" height="16" ariaHidden="true"><path d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z" fill="currentColor"></path></svg></a><button type="button" class="wl-action" title="è¡¨æƒ…" style="display:none;"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M563.2 463.3 677 540c1.7 1.2 3.7 1.8 5.8 1.8.7 0 1.4-.1 2-.2 2.7-.5 5.1-2.1 6.6-4.4l25.3-37.8c1.5-2.3 2.1-5.1 1.6-7.8s-2.1-5.1-4.4-6.6l-73.6-49.1 73.6-49.1c2.3-1.5 3.9-3.9 4.4-6.6.5-2.7 0-5.5-1.6-7.8l-25.3-37.8a10.1 10.1 0 0 0-6.6-4.4c-.7-.1-1.3-.2-2-.2-2.1 0-4.1.6-5.8 1.8l-113.8 76.6c-9.2 6.2-14.7 16.4-14.7 27.5.1 11 5.5 21.3 14.7 27.4zM387 348.8h-45.5c-5.7 0-10.4 4.7-10.4 10.4v153.3c0 5.7 4.7 10.4 10.4 10.4H387c5.7 0 10.4-4.7 10.4-10.4V359.2c0-5.7-4.7-10.4-10.4-10.4zm333.8 241.3-41-20a10.3 10.3 0 0 0-8.1-.5c-2.6.9-4.8 2.9-5.9 5.4-30.1 64.9-93.1 109.1-164.4 115.2-5.7.5-9.9 5.5-9.5 11.2l3.9 45.5c.5 5.3 5 9.5 10.3 9.5h.9c94.8-8 178.5-66.5 218.6-152.7 2.4-5 .3-11.2-4.8-13.6zm186-186.1c-11.9-42-30.5-81.4-55.2-117.1-24.1-34.9-53.5-65.6-87.5-91.2-33.9-25.6-71.5-45.5-111.6-59.2-41.2-14-84.1-21.1-127.8-21.1h-1.2c-75.4 0-148.8 21.4-212.5 61.7-63.7 40.3-114.3 97.6-146.5 165.8-32.2 68.1-44.3 143.6-35.1 218.4 9.3 74.8 39.4 145 87.3 203.3.1.2.3.3.4.5l36.2 38.4c1.1 1.2 2.5 2.1 3.9 2.6 73.3 66.7 168.2 103.5 267.5 103.5 73.3 0 145.2-20.3 207.7-58.7 37.3-22.9 70.3-51.5 98.1-85 27.1-32.7 48.7-69.5 64.2-109.1 15.5-39.7 24.4-81.3 26.6-123.8 2.4-43.6-2.5-87-14.5-129zm-60.5 181.1c-8.3 37-22.8 72-43 104-19.7 31.1-44.3 58.6-73.1 81.7-28.8 23.1-61 41-95.7 53.4-35.6 12.7-72.9 19.1-110.9 19.1-82.6 0-161.7-30.6-222.8-86.2l-34.1-35.8c-23.9-29.3-42.4-62.2-55.1-97.7-12.4-34.7-18.8-71-19.2-107.9-.4-36.9 5.4-73.3 17.1-108.2 12-35.8 30-69.2 53.4-99.1 31.7-40.4 71.1-72 117.2-94.1 44.5-21.3 94-32.6 143.4-32.6 49.3 0 97 10.8 141.8 32 34.3 16.3 65.3 38.1 92 64.8 26.1 26 47.5 56 63.6 89.2 16.2 33.2 26.6 68.5 31 105.1 4.6 37.5 2.7 75.3-5.6 112.3z" fill="currentColor"></path></svg></button><button type="button" class="wl-action" title="è¡¨æƒ…åŒ…"><svg width="24" height="24" fill="currentcolor" viewBox="0 0 24 24"><path style="transform: translateY(0.5px)" d="M18.968 10.5H15.968V11.484H17.984V12.984H15.968V15H14.468V9H18.968V10.5V10.5ZM8.984 9C9.26533 9 9.49967 9.09367 9.687 9.281C9.87433 9.46833 9.968 9.70267 9.968 9.984V10.5H6.499V13.5H8.468V12H9.968V14.016C9.968 14.2973 9.87433 14.5317 9.687 14.719C9.49967 14.9063 9.26533 15 8.984 15H5.984C5.70267 15 5.46833 14.9063 5.281 14.719C5.09367 14.5317 5 14.2973 5 14.016V9.985C5 9.70367 5.09367 9.46933 5.281 9.282C5.46833 9.09467 5.70267 9.001 5.984 9.001H8.984V9ZM11.468 9H12.968V15H11.468V9V9Z"></path><path d="M18.5 3H5.75C3.6875 3 2 4.6875 2 6.75V18C2 20.0625 3.6875 21.75 5.75 21.75H18.5C20.5625 21.75 22.25 20.0625 22.25 18V6.75C22.25 4.6875 20.5625 3 18.5 3ZM20.75 18C20.75 19.2375 19.7375 20.25 18.5 20.25H5.75C4.5125 20.25 3.5 19.2375 3.5 18V6.75C3.5 5.5125 4.5125 4.5 5.75 4.5H18.5C19.7375 4.5 20.75 5.5125 20.75 6.75V18Z"></path></svg></button><input id="wl-image-upload" class="upload" type="file" accept=".png,.jpg,.jpeg,.webp,.bmp,.gif"><label for="wl-image-upload" class="wl-action" title="ä¸Šä¼ å›¾ç‰‡"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M784 112H240c-88 0-160 72-160 160v480c0 88 72 160 160 160h544c88 0 160-72 160-160V272c0-88-72-160-160-160zm96 640c0 52.8-43.2 96-96 96H240c-52.8 0-96-43.2-96-96V272c0-52.8 43.2-96 96-96h544c52.8 0 96 43.2 96 96v480z" fill="currentColor"></path><path d="M352 480c52.8 0 96-43.2 96-96s-43.2-96-96-96-96 43.2-96 96 43.2 96 96 96zm0-128c17.6 0 32 14.4 32 32s-14.4 32-32 32-32-14.4-32-32 14.4-32 32-32zm462.4 379.2-3.2-3.2-177.6-177.6c-25.6-25.6-65.6-25.6-91.2 0l-80 80-36.8-36.8c-25.6-25.6-65.6-25.6-91.2 0L200 728c-4.8 6.4-8 14.4-8 24 0 17.6 14.4 32 32 32 9.6 0 16-3.2 22.4-9.6L380.8 640l134.4 134.4c6.4 6.4 14.4 9.6 24 9.6 17.6 0 32-14.4 32-32 0-9.6-4.8-17.6-9.6-24l-52.8-52.8 80-80L769.6 776c6.4 4.8 12.8 8 20.8 8 17.6 0 32-14.4 32-32 0-8-3.2-16-8-20.8z" fill="currentColor"></path></svg></label><button type="button" class="wl-action" title="é¢„è§ˆ"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M710.816 654.301c70.323-96.639 61.084-230.578-23.705-314.843-46.098-46.098-107.183-71.109-172.28-71.109-65.008 0-126.092 25.444-172.28 71.109-45.227 46.098-70.756 107.183-70.756 172.106 0 64.923 25.444 126.007 71.194 172.106 46.099 46.098 107.184 71.109 172.28 71.109 51.414 0 100.648-16.212 142.824-47.404l126.53 126.006c7.058 7.06 16.297 10.979 26.406 10.979 10.105 0 19.343-3.919 26.402-10.979 14.467-14.467 14.467-38.172 0-52.723L710.816 654.301zm-315.107-23.265c-65.88-65.88-65.88-172.54 0-238.42 32.069-32.07 74.245-49.149 119.471-49.149 45.227 0 87.407 17.603 119.472 49.149 65.88 65.879 65.88 172.539 0 238.42-63.612 63.178-175.242 63.178-238.943 0zm0 0" fill="currentColor"></path><path d="M703.319 121.603H321.03c-109.8 0-199.469 89.146-199.469 199.38v382.034c0 109.796 89.236 199.38 199.469 199.38h207.397c20.653 0 37.384-16.645 37.384-37.299 0-20.649-16.731-37.296-37.384-37.296H321.03c-68.582 0-124.352-55.77-124.352-124.267V321.421c0-68.496 55.77-124.267 124.352-124.267h382.289c68.582 0 124.352 55.771 124.352 124.267V524.72c0 20.654 16.736 37.299 37.385 37.299 20.654 0 37.384-16.645 37.384-37.299V320.549c-.085-109.8-89.321-198.946-199.121-198.946zm0 0" fill="currentColor"></path></svg></button></div><div class="wl-info"><div class="wl-captcha-container"></div><div class="wl-text-number">0 <!--v-if--> Â å­—</div><button type="button" class="wl-btn">ç™»å½•</button><button type="submit" class="primary wl-btn" title="Cmd|Ctrl + Enter"><!--[-->æäº¤<!--]--></button></div><div class="wl-gif-popup"><input type="text" placeholder="æœç´¢è¡¨æƒ…åŒ…"><!--v-if--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div></div><div class="wl-emoji-popup"><!--[--><!--]--><!--v-if--></div></div></div><!--v-if--></div><div class="wl-meta-head"><div class="wl-count"><!--v-if--> è¯„è®º</div><ul class="wl-sort"><!--[--><li class="active">æŒ‰æ­£åº</li><li class="">æŒ‰å€’åº</li><li class="">æŒ‰çƒ­åº¦</li><!--]--></ul></div><div class="wl-cards"><!--[--><!--]--></div><!--[--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div><!--]--><div class="wl-power"> Powered by <a href="https://github.com/walinejs/waline" target="_blank" rel="noopener noreferrer"> Waline </a> v2.15.5</div></div></div><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/learn_data/assets/app-109af9bf.js" defer></script>
    <!-- çœ‹æ¿å¨˜åŒºå— -->
    <script src="/live2d-widget/autoload.js"></script>
    <!-- End çœ‹æ¿å¨˜åŒºå— -->
    <script src="https://oss.newzone.top/instantpage.min.js" type="module"></script>
  </body>
</html>
